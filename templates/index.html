<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlipSide — The Other Side of Small Print</title>
    <meta name="description" content="Upload any contract and see what the other side intended. FlipSide flips the small print so you can read it from the drafter's perspective.">
    <meta property="og:title" content="FlipSide — The Other Side of Small Print">
    <meta property="og:description" content="Upload any contract and see what the other side intended. AI-powered clause analysis by Claude Opus 4.6.">
    <meta property="og:type" content="website">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23c44b28' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z'/><path d='M14 2v6h6'/></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;0,9..40,800;1,9..40,400&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked@15.0.7/marked.min.js" integrity="sha256-k04+Nuni2gr7Gm51B1uw8JrwUpOoROhKdHfvQJEcNJo=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.2.5/dist/purify.min.js" integrity="sha256-SCmGefnjCPBf3NW3QhwV/PtUWEWjqZu68xAziQYQ6ws=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.2/dist/html2pdf.bundle.min.js" crossorigin="anonymous"></script>
    <style>
        /* ══════════════════════════════════════════════════════
           RESET & DESIGN SYSTEM
           ══════════════════════════════════════════════════════ */
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0; }
        .hidden { display: none !important; }

        /* ── Screen transition: upload exit ── */
        @keyframes screenFadeOut {
            to { opacity: 0; transform: translateY(-24px) scale(0.97); }
        }
        #upload-screen.exiting {
            animation: screenFadeOut 0.35s cubic-bezier(0.22, 1, 0.36, 1) forwards;
            pointer-events: none;
        }

        :root {
            --bg-cream: #f7f5f0;
            --bg-warm: #f0ede6;
            --bg-card: #ffffff;
            --bg-surface: #faf8f4;
            --bg-thinking: #1e1d1a;
            --border: #e2ddd4;
            --border-light: #ece8e0;
            --border-focus: #c44b28;
            --text-primary: #1a1a18;
            --text-body: #3d3b36;
            --text-secondary: #6b6860;
            --text-muted: #9c9789;
            --text-dim: #bfb9ad;
            --accent: #c44b28;
            --accent-hover: #a83d20;
            --accent-light: rgba(196, 75, 40, 0.08);
            --accent-medium: rgba(196, 75, 40, 0.15);
            --green: #2d8a4e;
            --green-bg: rgba(45, 138, 78, 0.07);
            --green-border: rgba(45, 138, 78, 0.22);
            --green-text: #1e6b38;
            --yellow: #b8860b;
            --yellow-bg: rgba(184, 134, 11, 0.07);
            --yellow-border: rgba(184, 134, 11, 0.22);
            --yellow-text: #8a6508;
            --red: #c44b28;
            --red-bg: rgba(196, 75, 40, 0.07);
            --red-border: rgba(196, 75, 40, 0.22);
            --red-text: #a83d20;
            --radius: 12px;
            --radius-md: 8px;
            --radius-sm: 6px;
            --transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.04), 0 1px 2px rgba(0,0,0,0.03);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.06);
            --shadow-lg: 0 8px 32px rgba(0,0,0,0.08);
            --col-width: 720px;
            --ease-out-expo: cubic-bezier(0.22, 1, 0.36, 1);
            --ink: #1a1a18;
            --cream: #f7f5f0;
            --smoke: #6b6860;
            --ash: #9c9789;
            /* Aliases for consistency */
            --text: var(--text-primary);
            --card-bg: var(--bg-card);
            --yellow-dark: var(--yellow-text);
            --accent-burnt: var(--accent);
            --text-heading: var(--text-primary);
            --bg-main: var(--bg-cream);
            --font-mono: 'JetBrains Mono', monospace;
        }

        /* ── Dark mode ──────────────────────────────── */
        @media (prefers-color-scheme: dark) {
            :root:not(.light-override) {
                --bg-cream: #1a1917;
                --bg-warm: #222120;
                --bg-card: #2a2927;
                --bg-surface: #252422;
                --bg-thinking: #131210;
                --border: #3d3a35;
                --border-light: #333128;
                --text-primary: #e8e4dc;
                --text-body: #c8c3b8;
                --text-secondary: #a09a8e;
                --text-muted: #78736a;
                --text-dim: #585450;
                --shadow-sm: 0 1px 3px rgba(0,0,0,0.2);
                --shadow-md: 0 4px 12px rgba(0,0,0,0.3);
                --shadow-lg: 0 8px 32px rgba(0,0,0,0.4);
            }
        }
        .dark-mode {
            --bg-cream: #1a1917;
            --bg-warm: #222120;
            --bg-card: #2a2927;
            --bg-surface: #252422;
            --bg-thinking: #131210;
            --border: #3d3a35;
            --border-light: #333128;
            --text-primary: #e8e4dc;
            --text-body: #c8c3b8;
            --text-secondary: #a09a8e;
            --text-muted: #78736a;
            --text-dim: #585450;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.2);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.3);
            --shadow-lg: 0 8px 32px rgba(0,0,0,0.4);
        }

        body {
            font-family: 'DM Sans', system-ui, -apple-system, sans-serif;
            background: var(--bg-cream);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* ── Grain overlay ──────────────────────────── */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            z-index: 9999;
            pointer-events: none;
            opacity: 0.025;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
            background-repeat: repeat;
            background-size: 256px 256px;
        }
        @media print { body::before { display: none; } }

        ::selection { background: rgba(196, 75, 40, 0.25); }

        /* ══════════════════════════════════════════════════════
           ANIMATIONS
           ══════════════════════════════════════════════════════ */
        .fade-up {
            opacity: 0; transform: translateY(16px);
            animation: fadeUp 0.7s cubic-bezier(0.22, 1, 0.36, 1) forwards;
        }
        @keyframes fadeUp { to { opacity: 1; transform: translateY(0); } }
        .fade-up-d1 { animation-delay: 0.1s; }
        .fade-up-d2 { animation-delay: 0.2s; }
        .fade-up-d3 { animation-delay: 0.3s; }

        @keyframes clauseDropIn {
            0% { transform: translateY(20px); opacity: 0; }
            70% { transform: translateY(-3px); }
            100% { transform: translateY(0); opacity: 1; }
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }
        /* ══════════════════════════════════════════════════════
           SCREEN 1: UPLOAD
           ══════════════════════════════════════════════════════ */
        #upload-screen {
            min-height: 100vh;
            display: flex;
            padding: 0;
        }
        .upload-nav {
            display: none;
        }
        .upload-nav-brand, .upload-nav-label, .upload-nav a, .upload-nav a.nav-fair-clause {
            /* Legacy nav — hidden in favor of inline links */
        }
        .upload-main {
            flex: 1;
            display: flex; flex-direction: column; align-items: center;
            justify-content: center; padding: 2rem;
            min-height: 100vh;
        }
        .upload-main.has-faq {
            justify-content: flex-start; padding-top: 3rem;
        }
        .upload-container { max-width: 940px; width: 100%; }

        /* ── FAQ Sections ─────────────────────────── */
        .faq-wrapper {
            max-width: 560px; width: 100%; margin-top: 3rem;
            padding-bottom: 4rem;
        }
        .faq-wrapper.hidden { display: none; }
        .faq-back {
            display: inline-flex; align-items: center; gap: 0.4rem;
            font-size: 0.82rem; color: var(--text-muted); cursor: pointer;
            margin-bottom: 1rem; padding: 0.4rem 0;
            border: none; background: none; font-family: inherit;
            transition: color 0.15s ease;
        }
        .faq-back:hover { color: var(--accent); }
        .faq-back-arrow { font-size: 1rem; }
        .faq-title {
            font-size: 1.8rem; font-weight: 800; letter-spacing: -0.03em;
            color: var(--text-primary); margin-bottom: 0.3rem;
        }
        .faq-subtitle {
            font-size: 0.88rem; color: var(--text-secondary);
            margin-bottom: 2rem; font-style: italic;
        }
        .faq-section {
            margin-bottom: 2rem;
            scroll-margin-top: 2rem;
        }
        .faq-section h3 {
            font-size: 1rem; font-weight: 700; color: var(--text-primary);
            margin-bottom: 0.5rem; letter-spacing: -0.01em;
        }
        .faq-section p, .faq-section li {
            font-size: 0.85rem; color: var(--text-body); line-height: 1.7;
            margin-bottom: 0.6rem;
        }
        .faq-section ul {
            padding-left: 1.2rem; margin-bottom: 0.8rem;
        }
        .faq-section li { margin-bottom: 0.3rem; }
        .faq-section strong { color: var(--text-primary); }
        .faq-section code {
            font-family: 'JetBrains Mono', monospace; font-size: 0.78rem;
            background: var(--bg-warm); padding: 0.1rem 0.35rem;
            border-radius: 3px; color: var(--accent);
        }
        .faq-divider {
            border: none; border-top: 1px solid var(--border-light);
            margin: 2rem 0;
        }

        /* ── Fair Clause ──────────────────────────── */
        .fair-clause-card {
            background: var(--bg-card); border: 2px solid var(--green-border);
            border-radius: var(--radius); padding: 1.8rem;
            box-shadow: var(--shadow-md);
            scroll-margin-top: 2rem;
        }
        .fair-clause-card h3 {
            font-size: 1.15rem; font-weight: 800; color: var(--green-text);
            margin-bottom: 0.2rem;
        }
        .fair-clause-badge {
            display: inline-block; font-size: 0.65rem; font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
            background: var(--green-bg); color: var(--green-text);
            border: 1px solid var(--green-border);
            padding: 0.15rem 0.5rem; border-radius: 100px;
            margin-bottom: 1rem; letter-spacing: 0.02em;
        }
        .fair-clause-intro {
            font-size: 0.85rem; color: var(--text-secondary);
            font-style: italic; margin-bottom: 1.2rem; line-height: 1.6;
        }
        .fair-clause-section {
            margin-bottom: 1rem;
        }
        .fair-clause-section h4 {
            font-size: 0.82rem; font-weight: 700; color: var(--text-primary);
            margin-bottom: 0.25rem;
        }
        .fair-clause-section p {
            font-size: 0.82rem; color: var(--text-body); line-height: 1.65;
            margin: 0;
        }
        .fair-clause-reasoning {
            margin-top: 0.3rem; font-size: 0.72rem; color: var(--green-text);
            font-style: italic; line-height: 1.5;
            padding-left: 0.8rem; border-left: 2px solid var(--green-border);
        }
        .fair-clause-score {
            margin-top: 1.5rem; padding-top: 1rem;
            border-top: 1px solid var(--green-border);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem; color: var(--green-text);
            display: flex; align-items: center; gap: 0.5rem;
        }
        .fair-clause-score-ring {
            width: 32px; height: 32px;
        }
        .fair-clause-footer {
            margin-top: 1rem; font-size: 0.7rem;
            color: var(--text-dim); font-style: italic; line-height: 1.5;
        }

        @media (max-width: 800px) {
            .upload-main { padding: 2rem 1rem; }
            .upload-methods { grid-template-columns: 1fr; }
            .upload-actions { flex-direction: column; }
            .upload-actions .analyze-btn { width: 100%; }
        }

        .brand { text-align: center; margin-bottom: 1.5rem; }
        .brand h1 {
            font-size: 3.2rem; font-weight: 800;
            letter-spacing: -0.04em; color: var(--text-primary); line-height: 1.1;
        }
        .brand-hook {
            font-size: 1.15rem; color: var(--text-body);
            margin-top: 0.75rem; font-weight: 400; line-height: 1.6;
            letter-spacing: -0.01em;
        }
        .brand-shrug {
            font-size: 1rem; color: var(--text-body); margin-top: 0.9rem;
            line-height: 1.55; max-width: 560px; margin-left: auto; margin-right: auto;
            text-align: center; font-weight: 400;
        }
        .brand-explain {
            font-size: 0.88rem; color: var(--text-muted); margin-top: 0.5rem;
            line-height: 1.5; max-width: 560px; margin-left: auto; margin-right: auto;
            text-align: center;
        }

        /* ── Hero stacked: upload full-width, then demo card ──── */
        .hero-upload {
            max-width: 640px; margin: 0 auto; width: 100%;
        }
        .hero-demo {
            max-width: 480px; margin: 2rem auto 0; text-align: center;
        }
        .hero-demo-label {
            font-family: 'JetBrains Mono', monospace; font-size: 0.6rem;
            text-transform: uppercase; letter-spacing: 0.12em; font-weight: 600;
            color: var(--text-dim); margin-bottom: 0.5rem;
        }
        .hero-demo .hero-flip-card { text-align: left; }

        /* ── Hero flip card demo ────────────────────────── */
        .hero-flip {
            text-align: center;
        }
        .hero-flip-intro {
            font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.75rem;
            font-family: 'JetBrains Mono', monospace; letter-spacing: 0.02em;
            text-transform: uppercase; font-weight: 500;
        }
        .hero-flip-card {
            position: relative; cursor: pointer; border-radius: var(--radius);
            overflow: hidden; box-shadow: var(--shadow-md);
            border: 1px solid var(--border); text-align: left;
            transition: box-shadow 0.3s ease;
        }
        .hero-flip-card:hover { box-shadow: var(--shadow-lg); }
        .hero-flip-front, .hero-flip-back { transition: opacity 0.35s ease, transform 0.35s ease; }
        .hero-flip-back {
            display: none; opacity: 0;
        }
        .hero-flip-card.flipped .hero-flip-front { display: none; opacity: 0; }
        .hero-flip-card.flipped .hero-flip-back { display: block; opacity: 1; }
        .hero-demo:has(.hero-flip-card.flipped) .hero-demo-label { opacity: 0; transition: opacity 0.3s ease; }
        .hero-flip-header {
            padding: 0.75rem 1.25rem; display: flex; flex-direction: column; gap: 0.15rem;
        }
        .hero-flip-header-green {
            background: linear-gradient(135deg, rgba(45,138,78,0.06), rgba(45,138,78,0.10));
            border-bottom: 2px solid var(--green);
        }
        .hero-flip-header-red {
            background: linear-gradient(135deg, rgba(196,75,40,0.08), rgba(196,75,40,0.14));
            border-bottom: 2px solid var(--red);
        }
        .hero-flip-label {
            font-family: 'JetBrains Mono', monospace; font-size: 0.65rem;
            text-transform: uppercase; letter-spacing: 0.08em; font-weight: 600;
            color: var(--text-muted);
        }
        .hero-flip-header-green .hero-flip-label { color: var(--green-text); }
        .hero-flip-header-red .hero-flip-label { color: var(--accent); }
        .hero-flip-reassurance {
            font-size: 1rem; font-weight: 700; line-height: 1.3;
        }
        .hero-flip-header-green .hero-flip-reassurance { color: var(--green-text); }
        .hero-flip-header-red .hero-flip-reassurance { color: var(--accent); }
        .hero-flip-body { padding: 1rem 1.25rem; background: var(--bg-card); }
        .hero-flip-quote {
            font-size: 0.8rem; color: var(--text-secondary); font-style: italic;
            border-left: 2px solid var(--border); padding-left: 0.75rem; margin-bottom: 0.75rem;
            line-height: 1.5;
        }
        .hero-flip-reader {
            font-size: 0.82rem; color: var(--text-secondary); line-height: 1.5;
        }
        .hero-flip-figure {
            font-size: 1.35rem; font-weight: 800; color: var(--accent);
            line-height: 1.2; margin-bottom: 0.6rem;
        }
        .hero-flip-example {
            font-size: 0.8rem; color: var(--text-secondary); line-height: 1.55;
            background: rgba(196,75,40,0.04); border-left: 2px solid var(--accent);
            padding: 0.6rem 0.75rem; border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
            margin-bottom: 0.6rem;
        }
        .hero-flip-bottom {
            font-size: 0.82rem; font-style: italic; color: var(--text-secondary);
            line-height: 1.5;
        }
        .hero-flip-trigger {
            display: block; text-align: center; padding: 0.6rem 1rem;
            font-size: 0.78rem; font-weight: 600; color: var(--accent);
            border-top: 1px solid var(--border-light); background: var(--bg-card);
            transition: background 0.2s ease;
        }
        .hero-flip-trigger:hover { background: rgba(196,75,40,0.04); }
        .hero-flip-trigger-back { color: var(--text-muted); }
        .hero-flip-trigger-back:hover { background: var(--bg-warm); }
        .hero-flip-subline {
            font-size: 0.78rem; color: var(--text-secondary); margin-top: 1.25rem;
            line-height: 1.4; text-align: center;
        }

        .upload-card {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius); padding: 2rem; box-shadow: var(--shadow-md);
        }
        .upload-headline {
            font-size: 0.95rem; font-weight: 600; color: var(--text-primary);
            line-height: 1.5; text-align: center; margin: 0 0 1.25rem;
        }

        /* 3-column input methods */
        .upload-methods {
            display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.75rem;
        }
        .upload-method { display: flex; flex-direction: column; }
        .upload-method .drop-zone {
            flex: 1; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
        }
        .upload-method .drop-zone .dz-title { font-size: 0.9rem; }
        /* When paste/url is active, expand that column */
        .upload-method.active-input {
            grid-column: 1 / -1;
        }
        .upload-method.active-input .method-zone { display: none; }
        .upload-method.active-input .paste-area { display: block !important; }

        .drop-zone {
            border: 2px dashed var(--border); border-radius: var(--radius-md);
            padding: 1.75rem 1.5rem; text-align: center; cursor: pointer;
            transition: all var(--transition); background: var(--bg-surface);
        }
        .drop-zone:hover, .drop-zone.dragover {
            border-color: var(--accent); background: var(--accent-light);
            transform: scale(1.01); box-shadow: 0 0 0 4px rgba(196, 75, 40, 0.1);
        }
        .drop-zone .icon {
            width: 32px; height: 32px; margin: 0 auto 0.5rem; display: block;
            color: var(--text-muted); opacity: 0.55;
            perspective: 600px;
        }
        .drop-zone .icon svg {
            width: 100%; height: 100%;
            transform-style: preserve-3d;
        }
        .drop-zone .dz-title { font-size: 1.15rem; font-weight: 700; color: var(--text-primary); }
        .drop-zone .hint { font-size: 0.82rem; color: var(--text-muted); margin-top: 0.25rem; }
        .drop-zone { position: relative; }
        .drop-zone .filetypes {
            position: absolute; bottom: 0.6rem; left: 0; right: 0;
            font-size: 0.6rem; color: var(--text-muted);
            letter-spacing: 0.06em; text-transform: uppercase;
            font-family: 'JetBrains Mono', monospace;
            white-space: nowrap;
        }

        .file-selected {
            display: flex; align-items: center; justify-content: center;
            gap: 0.6rem; padding: 0.4rem 0; max-width: 100%; overflow: hidden;
        }
        .file-selected .file-name { font-weight: 600; font-size: 0.92rem; color: var(--text-primary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; min-width: 0; flex-shrink: 1; }
        .file-selected .file-size { font-size: 0.78rem; color: var(--text-muted); flex-shrink: 0; }
        .file-remove {
            color: var(--text-muted); font-size: 0.78rem; text-decoration: none;
            margin-left: 0.5rem; cursor: pointer; transition: color var(--transition); flex-shrink: 0;
        }
        .file-remove:hover { color: var(--red); }

        .paste-area {
            width: 100%; min-height: 120px; background: var(--bg-surface);
            border: 1px solid var(--border); border-radius: var(--radius-sm);
            color: var(--text-primary); font-family: 'JetBrains Mono', monospace;
            font-size: 0.82rem; padding: 1rem; resize: vertical; margin-top: 1rem;
            outline: none; transition: border-color var(--transition);
        }
        .paste-area:focus { border-color: var(--accent); }
        .paste-area::placeholder { color: var(--text-dim); }

        /* Depth selector */
        .depth-selector {
            display: flex; border-radius: var(--radius-sm);
            overflow: hidden; border: 1px solid var(--border); margin-top: 1.2rem;
        }
        .depth-btn {
            flex: 1; padding: 0.5rem 0.4rem; background: var(--bg-surface);
            color: var(--text-muted); border: none; font-family: inherit;
            font-size: 0.78rem; font-weight: 500; cursor: pointer;
            transition: all var(--transition); text-align: center;
        }
        .depth-btn + .depth-btn { border-left: 1px solid var(--border); }
        .depth-btn.active { background: var(--text-primary); color: var(--bg-cream); }
        .depth-btn:hover:not(.active) { background: var(--bg-warm); color: var(--text-secondary); }

        .analyze-btn {
            width: 100%; margin-top: 1.75rem; padding: 0.85rem; font-size: 0.95rem;
            font-weight: 600; font-family: inherit; background: var(--accent);
            color: white; border: none; border-radius: var(--radius-md); cursor: pointer;
            transition: all var(--transition); letter-spacing: -0.01em;
        }
        .analyze-btn:hover:not(:disabled) {
            background: var(--accent-hover); transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(196, 75, 40, 0.2);
        }
        .analyze-btn:disabled { opacity: 0.35; cursor: not-allowed; }

        .upload-links {
            text-align: center; margin-top: 1rem;
            display: flex; flex-wrap: wrap; justify-content: center; gap: 0.5rem 1.2rem;
            font-size: 0.82rem;
        }
        .upload-links a {
            color: var(--text-muted); text-decoration: none; cursor: pointer;
            border-bottom: 1px dotted var(--text-dim); transition: color var(--transition);
        }
        .upload-links a:hover { color: var(--accent); border-bottom-color: var(--accent); }
        .upload-actions {
            display: flex; align-items: center; gap: 1.25rem; margin-top: 1.25rem;
        }
        .upload-actions .upload-trust { margin-top: 0; flex-shrink: 0; }
        .upload-actions .analyze-btn { margin-top: 0; flex: 1; }
        .upload-trust {
            text-align: center; font-size: 0.72rem; color: var(--green);
            margin-top: 0.5rem; letter-spacing: 0.02em;
            font-family: 'JetBrains Mono', monospace;
        }
        .upload-card-divider {
            border: none; border-top: 1px solid var(--border);
            margin: 1.25rem -2rem; /* bleed to card edges */
        }
        /* Demo document grid */
        .demo-grid-section { margin-bottom: 0; margin-top: 2.5rem; }
        .demo-grid-title {
            font-size: 0.88rem; font-weight: 400; color: var(--text-secondary);
            text-align: center; margin: 1rem 0 0.9rem;
            font-family: 'DM Sans', sans-serif; letter-spacing: 0;
            text-transform: none; line-height: 1.5; font-style: italic;
        }
        .demo-grid-title .demo-grid-cta {
            font-style: normal; font-weight: 500; color: var(--accent);
        }
        .demo-grid-shrug {
            font-size: 0.92rem; color: var(--text-secondary); text-align: center;
            line-height: 1.55; margin: 0 0 1rem;
        }
        .demo-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;
        }
        .demo-grid:not(.expanded) .demo-tile:nth-child(n+5) {
            display: none;
        }
        .demo-grid-expand {
            display: block; margin: 0.8rem auto 0; padding: 0.35rem 1rem;
            background: none; border: 1px solid var(--border); border-radius: 100px;
            font-family: 'JetBrains Mono', monospace; font-size: 0.68rem;
            color: var(--text-muted); cursor: pointer;
            transition: all 0.2s ease; letter-spacing: 0.02em;
        }
        .demo-grid-expand:hover {
            border-color: var(--accent); color: var(--accent);
        }
        .demo-grid.expanded + .demo-grid-expand { display: none; }
        .demo-tile {
            background: var(--bg-surface); border: 1px solid var(--border);
            border-radius: var(--radius-sm); padding: 0.9rem 0.5rem 0.7rem;
            display: flex; flex-direction: column; align-items: center;
            text-align: center; cursor: pointer;
            transition: transform 0.25s var(--ease-out-expo), box-shadow 0.25s var(--ease-out-expo), border-color 0.25s ease;
        }
        .demo-tile:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(44, 40, 37, 0.08);
            border-color: var(--accent);
        }
        .demo-tile:hover .demo-tile-label { color: var(--accent); }
        .demo-tile:hover .demo-tile-icon { color: var(--accent); }
        .demo-tile-icon { width: 26px; height: 26px; margin-bottom: 0.5rem; color: var(--text-muted); transition: color 0.25s ease; }
        .demo-tile-icon svg { width: 100%; height: 100%; }
        .demo-tile-label {
            font-family: 'DM Sans', sans-serif; font-size: 0.88rem;
            font-weight: 600; color: var(--text-primary); margin-bottom: 0.15rem;
            line-height: 1.2; transition: color 0.25s ease;
        }
        .demo-tile-desc {
            font-size: 0.72rem; color: var(--text-secondary); line-height: 1.35;
        }

        .upload-error {
            margin-top: 1.2rem; padding: 1.4rem 1.5rem; background: var(--bg-surface);
            border: 1px solid var(--border); border-radius: 12px;
            color: var(--text-body); font-size: 0.88rem; line-height: 1.6;
            text-align: center;
        }
        .upload-error-icon {
            font-size: 1.6rem; margin-bottom: 0.6rem; opacity: 0.5;
        }
        .upload-error-headline {
            font-family: 'DM Sans', sans-serif; font-weight: 700;
            font-size: 1.1rem; color: var(--text-primary);
            margin-bottom: 0.4rem; letter-spacing: -0.02em;
        }
        .upload-error-detail {
            font-size: 0.82rem; color: var(--text-muted); margin-bottom: 1rem;
        }
        .upload-error-tryagain {
            display: inline-block; font-family: 'DM Sans', sans-serif;
            font-size: 0.78rem; font-weight: 600; color: var(--accent);
            cursor: pointer; border: none; background: none;
            text-decoration: underline; text-underline-offset: 2px;
        }

        .disclaimer {
            margin-top: 1.5rem; font-size: 0.76rem;
            color: var(--text-secondary); line-height: 1.6;
            padding: 0.85rem 1.1rem;
            background: var(--bg-surface);
            border: 1px solid var(--border-light);
            border-left: 3px solid var(--green);
            border-radius: var(--radius-sm);
        }
        .disclaimer strong {
            color: var(--text-primary); font-weight: 600;
        }

        /* ══════════════════════════════════════════════════════
           SCREEN 2/3: ANALYSIS
           ══════════════════════════════════════════════════════ */
        #analysis-screen { min-height: 100vh; display: flex; flex-direction: column; }

        /* ── Sticky header ───────────────────────────── */
        .analysis-header {
            padding: 0.5rem 1.5rem; border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
            background: var(--bg-cream); position: sticky; top: 0; z-index: 100;
            gap: 0.75rem; flex-wrap: wrap;
        }
        .header-left { display: flex; align-items: center; gap: 0.75rem; min-width: 0; }
        .header-brand {
            font-size: 1rem; font-weight: 700; letter-spacing: -0.02em;
            white-space: nowrap; cursor: pointer;
        }
        .status-pill {
            display: inline-flex; align-items: center; gap: 0.4rem;
            font-size: 0.76rem; color: var(--text-secondary); background: var(--bg-card);
            padding: 0.2rem 0.65rem; border-radius: 20px; border: 1px solid var(--border);
            white-space: nowrap;
        }
        .status-dot {
            width: 6px; height: 6px; border-radius: 50%;
            background: var(--accent); animation: pulse 1.5s infinite; flex-shrink: 0;
        }
        .status-pill.done .status-dot { background: var(--green); animation: none; }
        .elapsed-time { font-variant-numeric: tabular-nums; }

        .header-right { display: flex; align-items: center; gap: 0.5rem; }
        .header-btn {
            background: none; border: 1px solid var(--border); color: var(--text-secondary);
            padding: 0.25rem 0.7rem; border-radius: var(--radius-sm); font-family: inherit;
            font-size: 0.76rem; cursor: pointer; transition: all var(--transition);
            white-space: nowrap;
        }
        .header-btn.home-btn {
            display: inline-flex; align-items: center; justify-content: center;
            padding: 0.3rem; border-radius: 50%; min-width: unset;
        }
        .header-btn.home-btn svg { display: block; }
        /* Overflow menu button: hidden on desktop, shown at ≤ 900px via mobile block */
        .header-overflow-btn { display: none; }
        .header-overflow-menu { display: none; }
        /* Dot nav: hidden on desktop, shown at ≤ 900px via mobile block */
        .card-nav-dots { display: none; }
        .header-btn:hover {
            border-color: var(--text-secondary); color: var(--text-primary);
            background: var(--bg-warm);
        }
        .model-badge {
            display: inline-flex; align-items: center; gap: 0.3rem;
            font-family: 'JetBrains Mono', monospace; font-size: 0.6rem;
            color: var(--text-muted); letter-spacing: 0.05em;
            white-space: nowrap;
        }
        .model-badge::before {
            content: ''; width: 5px; height: 5px; border-radius: 50%;
            background: var(--accent); flex-shrink: 0;
        }
        /* ── Capability ticker ── */
        .capability-ticker {
            font-family: 'JetBrains Mono', monospace; font-size: 0.55rem;
            color: var(--text-dim); letter-spacing: 0.03em;
            white-space: nowrap; overflow: hidden;
            transition: opacity 0.4s ease;
        }
        .capability-ticker .cap-label {
            display: inline-block;
            text-transform: uppercase; letter-spacing: 0.08em;
            color: var(--accent); font-weight: 600; margin-right: 0.3rem;
        }
        .capability-ticker.fade-swap {
            opacity: 0;
        }
        .capability-stats {
            font-family: 'JetBrains Mono', monospace; font-size: 0.55rem;
            color: var(--text-muted); letter-spacing: 0.03em;
        }
        .capability-stats .stat-num {
            color: var(--accent); font-weight: 600;
        }

        /* ── Analysis three-column layout ────────────── */
        .analysis-layout {
            display: flex;
            flex: 0 0 auto; /* prevent stretching inside #analysis-screen flex column */
            padding: 1rem 1.5rem 0;
            align-items: flex-start;
            justify-content: center;
        }
        .analysis-sidebar {
            width: 0; opacity: 0; overflow: hidden;
            max-height: 0; /* prevent hidden sidebar text from inflating page height */
            flex-shrink: 0;
            position: sticky;
            top: 70px;
            margin-right: 0;
            transition: width 0.65s var(--ease-out-expo), opacity 0.5s ease, margin-right 0.65s var(--ease-out-expo), max-height 0.65s var(--ease-out-expo);
        }
        .analysis-layout.sidebar-visible .analysis-sidebar {
            width: 240px; opacity: 1; overflow: visible; margin-right: 1.5rem;
            max-height: none;
        }

        /* ── Sidebar profile: thumbnail banner + pills ─── */
        .sidebar-profile {
            display: none;  /* Doc info moved to verdict column */
        }
        .metadata-line {
            min-width: 0;
            display: flex; flex-direction: column; gap: 0.35rem;
            padding: 0.5rem 0 0;
            opacity: 0; transform: translateY(8px);
            transition: opacity 0.6s var(--ease-out-expo), transform 0.6s var(--ease-out-expo);
        }
        .metadata-line.visible {
            opacity: 1; transform: translateY(0);
        }
        .meta-pill {
            display: flex; flex-direction: column; gap: 0.05rem;
            padding: 0;
            font-size: 0.65rem; line-height: 1.35;
            color: var(--text-body);
            max-width: 100%;
        }
        .meta-pill .meta-pill-label {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.5rem; font-weight: 600;
            text-transform: uppercase; letter-spacing: 0.08em;
            color: var(--text-muted); white-space: nowrap;
        }
        .meta-pill .meta-pill-value {
            white-space: normal; word-break: break-word;
        }

        /* ── Content column (center) ──────────────── */
        .content-col {
            flex: 1;
            max-width: var(--col-width);
            padding: 0 0 4rem;
        }

        /* ── Verdict column (right side — live report progress) ── */
        .verdict-col {
            width: 0; opacity: 0; overflow: hidden;
            flex-shrink: 0;
            position: sticky;
            top: 70px;
            margin-left: 0;
            transition: width 0.65s var(--ease-out-expo), opacity 0.5s ease, margin-left 0.65s var(--ease-out-expo);
            max-height: calc(100vh - 90px);
            display: flex;
            flex-direction: column;
            background: var(--bg-card);
            border: 1px solid transparent;
            border-radius: var(--radius);
        }
        .verdict-col.visible {
            width: 300px; opacity: 1; overflow: hidden;
            margin-left: 1.5rem;
            border-color: var(--border);
            box-shadow: var(--shadow-md);
        }
        .verdict-col.collapsed .verdict-body {
            height: 0; padding: 0; overflow: hidden; flex: 0;
            transition: height 0.4s var(--ease-out-expo), padding 0.4s var(--ease-out-expo);
        }
        .verdict-col.collapsed .verdict-header {
            border-bottom: none;
        }
        .verdict-header {
            display: flex; align-items: center; gap: 0.5rem;
            padding: 0.55rem 0.85rem;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }
        .verdict-dot {
            width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0;
            transition: background 0.4s ease;
        }
        .verdict-col.standby .verdict-dot {
            background: var(--text-dim);
            animation: verdictPulse 3s ease-in-out infinite;
        }
        .verdict-col.thinking .verdict-dot {
            background: var(--yellow);
            animation: verdictPulse 2s ease-in-out infinite;
        }
        .verdict-col.writing .verdict-dot {
            background: var(--green);
            animation: verdictPulse 1.5s ease-in-out infinite;
        }
        .verdict-col.ready .verdict-dot {
            background: var(--green); animation: none;
        }
        @keyframes verdictPulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.4; transform: scale(0.7); }
        }
        .verdict-title {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.6rem; font-weight: 600;
            text-transform: uppercase; letter-spacing: 0.1em;
            color: var(--text-muted); flex: 1;
        }
        .verdict-expand-btn {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.55rem; color: var(--accent);
            background: none; border: 1px solid var(--accent);
            border-radius: var(--radius-sm);
            padding: 0.2rem 0.5rem; cursor: pointer;
            transition: all 0.2s ease; white-space: nowrap;
        }
        .verdict-expand-btn:hover {
            background: var(--accent); color: #fff;
        }
        .verdict-expand-btn.ready {
            animation: verdictFlip 3s ease-in-out infinite;
            background: var(--accent); color: #fff; border-color: var(--accent);
        }
        .verdict-expand-btn.ready.preview {
            animation: none;
            background: rgba(196,75,40,0.85); border-color: rgba(196,75,40,0.85);
        }
        .verdict-expand-btn.ready:hover { animation: none; }
        @keyframes verdictFlip {
            0%, 100% { transform: perspective(200px) rotateY(0deg); }
            45% { transform: perspective(200px) rotateY(180deg); }
            55% { transform: perspective(200px) rotateY(180deg); }
            100% { transform: perspective(200px) rotateY(360deg); }
        }
        .verdict-expand-spin {
            display: inline-block; margin-left: 0.25rem;
        }
        .verdict-summary {
            display: none; padding: 0.5rem 0.6rem; margin: 0.4rem 0;
            font-size: 0.76rem; line-height: 1.45; color: var(--text);
            background: var(--card-bg); border-radius: 6px;
            border-left: 3px solid var(--accent);
        }
        .verdict-summary.visible { display: block; }
        .verdict-summary strong { color: var(--accent); font-weight: 600; }
        .verdict-summary .verdict-summary-score {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.82rem; font-weight: 700;
        }
        .verdict-summary-rights {
            margin-top: 0.35rem; font-size: 0.68rem;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-secondary); line-height: 1.4;
        }
        .verdict-summary-ratio {
            margin-top: 0.2rem; font-size: 0.7rem;
            font-weight: 600; color: var(--text);
            font-style: italic;
        }
        .verdict-body {
            flex: 1; overflow-y: auto; overflow-x: hidden;
            padding: 0.4rem 0.75rem 0.75rem; min-height: 0;
        }
        .verdict-doc-profile {
            margin: 0 -0.75rem; padding: 0.5rem 0.75rem 0.6rem;
            border-bottom: 1px solid var(--border-light);
        }
        .verdict-doc-thumb {
            width: 100%; height: 56px; border-radius: var(--radius-sm);
            overflow: hidden; margin-bottom: 0.5rem; line-height: 0;
        }
        .verdict-doc-thumb img {
            width: 100%; height: 56px; display: block;
            object-fit: cover; object-position: top center;
            background: #fff; opacity: 0.85;
        }
        .verdict-doc-icon {
            display: flex; align-items: center; gap: 0.5rem;
            margin-bottom: 0.4rem;
        }
        .verdict-doc-icon svg {
            width: 22px; height: 22px; color: var(--accent); flex-shrink: 0;
        }
        .verdict-doc-icon-label {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.62rem; font-weight: 600;
            text-transform: uppercase; letter-spacing: 0.06em;
            color: var(--text-secondary);
        }
        .verdict-doc-meta {
            display: flex; flex-direction: column; gap: 0.2rem;
        }
        .verdict-doc-meta .meta-pill {
            font-size: 0.6rem; line-height: 1.3;
        }
        .verdict-doc-meta .meta-pill-label {
            font-size: 0.47rem;
        }
        /* Standby state: waiting for deep analysis */
        .verdict-col.standby .verdict-body {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.62rem; line-height: 1.5;
            color: var(--text-dim);
        }
        /* Thinking state: monospace, muted */
        .verdict-col.thinking .verdict-body {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.68rem; line-height: 1.6;
            color: #9a938b; white-space: pre-wrap; word-break: break-word;
        }
        /* Writing/ready state: body font, rendered markdown */
        .verdict-col.writing .verdict-body,
        .verdict-col.ready .verdict-body {
            font-family: 'DM Sans', sans-serif;
            font-size: 0.78rem; line-height: 1.55;
            color: var(--text-body);
        }
        /* Compact markdown inside verdict column */
        .verdict-body h2 { font-size: 0.88rem; margin: 1rem 0 0.4rem; font-weight: 700; }
        .verdict-body h3 { font-size: 0.82rem; margin: 0.75rem 0 0.3rem; font-weight: 600; }
        .verdict-body p { margin: 0.3rem 0; }
        .verdict-body ul, .verdict-body ol { padding-left: 1.2rem; margin: 0.3rem 0; }
        .verdict-body li { margin: 0.15rem 0; }
        .verdict-body blockquote {
            border-left: 2px solid var(--border); margin: 0.4rem 0;
            padding: 0.2rem 0.6rem; color: var(--text-secondary); font-size: 0.75rem;
        }
        /* Streaming cursor in verdict */
        .verdict-cursor {
            display: inline-block; width: 6px; height: 12px;
            background: var(--accent); margin-left: 2px;
            vertical-align: text-bottom;
            animation: blink 0.8s step-end infinite;
        }
        /* Opus status line */
        .verdict-status {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.62rem; color: var(--text-muted);
            padding: 0.4rem 0; margin-bottom: 0.3rem;
            text-transform: uppercase; letter-spacing: 0.05em;
        }
        .verdict-status.hidden { display: none; }
        .verdict-invitation {
            font-family: 'DM Sans', sans-serif;
            font-size: 0.82rem; color: var(--text-secondary);
            line-height: 1.5; padding: 0.6rem 0 0.8rem;
            border-bottom: 1px solid var(--border);
            margin-bottom: 0.6rem;
            transition: opacity 0.6s ease-out;
        }
        .verdict-invitation.hidden { display: none; }
        .verdict-invitation.fading { opacity: 0; }
        .verdict-time-pill {
            display: inline-block;
            background: var(--bg-warm); border: 1px solid var(--border);
            border-radius: 100px; padding: 0.1rem 0.5rem;
            font-size: 0.58rem; color: var(--text-secondary);
            margin-left: 0.3rem; vertical-align: middle;
        }
        /* Opus collapsible sections */
        .opus-section { border-bottom: 1px solid var(--border); }
        .opus-section:last-child { border-bottom: none; }
        .opus-section-header {
            display: flex; align-items: center; gap: 0.4rem;
            padding: 0.45rem 0; cursor: pointer;
            user-select: none;
            transition: opacity 0.3s ease;
        }
        .opus-section-header:hover { opacity: 0.8; }
        /* Locked state: pulsing sections not clickable */
        .opus-section.locked .opus-section-header {
            cursor: default; opacity: 0.45;
            pointer-events: none;
        }
        .opus-dot {
            width: 7px; height: 7px; border-radius: 50%;
            flex-shrink: 0; background: var(--text-dim);
            transition: background 0.4s ease;
        }
        .opus-dot.pulsing {
            background: var(--yellow);
            animation: verdictPulse 2s ease-in-out infinite;
        }
        .opus-dot.done {
            background: var(--green); animation: none;
        }
        /* Synthesis section removed — single verdict thread */
        .opus-section-title {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.6rem; font-weight: 600;
            text-transform: uppercase; letter-spacing: 0.08em;
            color: var(--text-secondary);
        }
        .opus-section-body {
            overflow: hidden;
            transition: max-height 0.4s var(--ease-out-expo), padding 0.3s ease;
            font-family: 'DM Sans', sans-serif;
            font-size: 0.76rem; line-height: 1.5;
            color: var(--text-body);
        }
        .opus-section-body.collapsed {
            max-height: 0; padding: 0;
        }
        /* ── Focused reading mode ─────────────────────────────── */
        .verdict-focused-panel { display: none; }
        .verdict-focused-panel.active {
            display: flex; flex-direction: column; height: 100%;
        }
        .verdict-focused-nav {
            display: flex; align-items: center; justify-content: space-between;
            padding: 0.4rem 0; border-bottom: 1px solid var(--border);
            margin-bottom: 0.5rem; flex-shrink: 0;
        }
        .verdict-focused-nav-btn {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.55rem; color: var(--accent);
            background: none; border: none; cursor: pointer;
            padding: 0.2rem 0.3rem;
            transition: opacity 0.2s ease;
        }
        .verdict-focused-nav-btn:hover { opacity: 0.7; }
        .verdict-focused-nav-btn:disabled { opacity: 0.25; cursor: default; }
        .verdict-focused-counter {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.52rem; color: var(--text-muted);
            text-transform: uppercase; letter-spacing: 0.05em;
            text-align: center; flex: 1;
        }
        .verdict-focused-counter .ready-link {
            color: var(--accent); cursor: pointer;
            text-decoration: none; font-weight: 600;
        }
        .verdict-focused-counter .ready-link:hover { text-decoration: underline; }
        .verdict-focused-title {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.62rem; font-weight: 600;
            text-transform: uppercase; letter-spacing: 0.08em;
            color: var(--text-secondary);
            padding: 0.3rem 0; flex-shrink: 0;
        }
        .verdict-focused-content {
            flex: 1; overflow-y: auto;
            font-family: 'DM Sans', sans-serif;
            font-size: 0.78rem; line-height: 1.55;
            color: var(--text-body);
        }
        .verdict-focused-content h2 { font-size: 0.88rem; margin: 1rem 0 0.4rem; font-weight: 700; }
        .verdict-focused-content h3 { font-size: 0.82rem; margin: 0.75rem 0 0.3rem; font-weight: 600; }
        .verdict-focused-content p { margin: 0.3rem 0; }
        .verdict-focused-content ul, .verdict-focused-content ol { padding-left: 1.2rem; margin: 0.3rem 0; }
        .verdict-focused-content li { margin: 0.15rem 0; }
        .verdict-focused-content blockquote {
            border-left: 2px solid var(--border); margin: 0.4rem 0;
            padding: 0.2rem 0.6rem; color: var(--text-secondary); font-size: 0.75rem;
        }
        /* ── Live tricks detected panel ─────────────────────── */
        .verdict-risk-summary {
            display: flex; justify-content: center; gap: 1.2rem;
            padding: 0.7rem 1rem; margin-bottom: 0.8rem;
            font-family: 'JetBrains Mono', monospace; font-size: 0.72rem;
            letter-spacing: 0.03em; color: var(--text-secondary);
        }
        .verdict-risk-summary .risk-count { display: inline-flex; align-items: center; gap: 0.3rem; }
        .verdict-risk-summary .risk-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
        .verdict-risk-summary .risk-dot-red { background: var(--red); }
        .verdict-risk-summary .risk-dot-yellow { background: var(--yellow); }
        .verdict-risk-summary .risk-dot-green { background: var(--green); }
        .verdict-tricks-summary {
            padding: 0.8rem 1rem;
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            margin-bottom: 1rem;
        }
        .verdict-tricks-summary .verdict-tricks-label {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.62rem; text-transform: uppercase; letter-spacing: 0.08em;
            color: var(--text-muted); margin-bottom: 0.5rem; font-weight: 600;
        }
        .verdict-tricks-summary .verdict-tricks-list { display: flex; flex-wrap: wrap; gap: 0.3rem; }
        .verdict-tricks { padding: 0.6rem 0 0.5rem; border-bottom: 1px solid var(--border); margin-bottom: 0.3rem; }
        .verdict-tricks.hidden { display: none; }
        .verdict-tricks-title {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.62rem; text-transform: uppercase; letter-spacing: 0.08em;
            color: var(--text-muted); margin-bottom: 0.5rem;
        }
        .verdict-tricks-list { display: flex; flex-wrap: wrap; gap: 0.3rem; }
        .verdict-trick-item {
            display: inline-flex; align-items: center; gap: 0.35rem;
            padding: 0.3rem 0.6rem;
            background: var(--bg-warm); border: 1px solid var(--border);
            border-radius: 100px; cursor: pointer;
            transition: border-color 0.2s ease, background 0.2s ease;
            position: relative;
        }
        .verdict-trick-item:hover { border-color: var(--accent); background: #fff; }
        .verdict-trick-icon {
            width: 16px; height: 16px; color: var(--text-muted);
            flex-shrink: 0; display: inline-flex; vertical-align: -2px;
        }
        .verdict-trick-icon svg { width: 100%; height: 100%; }
        .verdict-trick-item:hover .verdict-trick-icon { color: var(--accent); }
        .verdict-trick-name {
            font-family: 'DM Sans', sans-serif;
            font-size: 0.76rem; font-weight: 500; color: var(--text-secondary);
            white-space: nowrap;
        }
        .verdict-trick-count {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.65rem; color: var(--text-muted); font-weight: 600;
        }
        .verdict-trick-desc {
            display: none; position: absolute;
            top: calc(100% + 6px); left: 0;
            background: var(--text-primary); color: #fff;
            font-family: 'DM Sans', sans-serif; font-size: 0.72rem; line-height: 1.4;
            padding: 0.35rem 0.65rem; border-radius: 6px;
            white-space: nowrap; pointer-events: none;
            z-index: 100;
        }
        .verdict-trick-desc::before {
            content: ''; position: absolute; bottom: 100%; left: 1rem;
            border: 5px solid transparent;
            border-bottom-color: var(--text-primary);
        }
        .verdict-trick-item.show-desc .verdict-trick-desc {
            display: block;
        }
        /* Smaller icons in compact contexts */
        .trick-label .verdict-trick-icon,
        .trick-footnote .verdict-trick-icon,
        .filter-chip .verdict-trick-icon { width: 12px; height: 12px; vertical-align: -1px; }
        .playbook-trick-name .verdict-trick-icon { width: 14px; height: 14px; vertical-align: -2px; }

        /* Hide section list when focused panel is active */
        .verdict-body.in-focus .opus-section,
        .verdict-body.in-focus .verdict-status,
        .verdict-body.in-focus .verdict-invitation,
        .verdict-body.in-focus .verdict-tricks { display: none;
        }
        .opus-section-body:not(.collapsed) {
            max-height: 2000px;
            padding: 0 0 0.5rem 0;
        }
        .opus-section-body h2 { font-size: 0.82rem; margin: 0.6rem 0 0.3rem; font-weight: 700; }
        .opus-section-body h3 { font-size: 0.78rem; margin: 0.5rem 0 0.2rem; font-weight: 600; }
        .opus-section-body p { margin: 0.25rem 0; }
        .opus-section-body ul, .opus-section-body ol { padding-left: 1.1rem; margin: 0.2rem 0; }
        .opus-section-body li { margin: 0.1rem 0; }
        .opus-section-body blockquote {
            border-left: 2px solid var(--border); margin: 0.3rem 0;
            padding: 0.15rem 0.5rem; color: var(--text-secondary); font-size: 0.72rem;
        }

        /* Dim sidebar + verdict when card is flipped — focus on the reveal */
        .layout-flipped .analysis-sidebar,
        .layout-flipped .verdict-col {
            opacity: 0.35;
            transition: opacity 0.5s var(--ease-out-expo);
        }
        .layout-flipped .analysis-sidebar:hover,
        .layout-flipped .verdict-col:hover {
            opacity: 1;
        }
        /* Hide sticky nav buttons when card is flipped — bottom Next takes over */
        .layout-flipped .card-nav-sticky .card-nav-btn {
            opacity: 0; pointer-events: none;
            transition: opacity 0.3s ease;
        }

        /* verdict-col mobile handling moved to unified mobile block below */

        /* ── Document thumbnail (upper-left of profile) */
        .doc-thumbnail {
            width: 100%; height: 80px;
            border-radius: var(--radius-sm);
            overflow: hidden;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
            line-height: 0;
        }
        .doc-thumbnail img {
            width: 100%; height: 80px;
            display: block;
            object-fit: cover;
            object-position: top center;
            background: #fff;
            opacity: 0.85;
            transition: opacity 0.3s;
        }
        .doc-thumbnail img:hover { opacity: 1; }

        /* ── Editorial loading state ────────────────── */
        .editorial-loading {
            margin: 0; padding: 0;
            width: 100%;
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius); box-shadow: var(--shadow-md);
            overflow: hidden;
            display: flex; flex-direction: column;
        }
        .editorial-loading.woosh-in-sidebar {
            animation: wooshInSidebar 0.9s var(--ease-out-expo) both;
        }
        @keyframes wooshInSidebar {
            0% { opacity: 0; transform: translateX(200px) scale(0.85); }
            30% { opacity: 0.6; }
            100% { opacity: 1; transform: translateX(0) scale(1); }
        }

        @media (max-width: 1200px) {
            .analysis-layout.sidebar-visible .analysis-sidebar { width: 200px; }
        }
        @media (max-width: 900px) {
            .analysis-layout { flex-direction: column; padding: 0 1rem; gap: 1rem; justify-content: flex-start; }
            .analysis-sidebar,
            .analysis-layout.sidebar-visible .analysis-sidebar { width: 100%; position: static; opacity: 1; overflow: visible; margin-right: 0; }
        }
        .editorial-loading-label {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.55rem; font-weight: 600;
            text-transform: uppercase; letter-spacing: 0.15em;
            color: var(--text-muted);
            padding: 0.75rem 1rem 0.3rem;
        }
        .editorial-loading-text {
            font-size: 0.72rem; line-height: 1.6;
            color: var(--text-secondary);
            opacity: 0.12;
            padding: 0 1rem;
            flex: 1; min-height: 0; overflow-y: auto;
            border-left: 2px solid var(--border);
            margin-left: 1rem; margin-right: 1rem;
            padding-left: 0.75rem;
            scroll-behavior: smooth;
            text-align: justify;
            hyphens: auto;
            transition: opacity 0.4s ease;
        }
        .editorial-loading-text.has-active-highlight {
            opacity: 1;
        }
        .editorial-loading-text::-webkit-scrollbar { width: 3px; }
        .editorial-loading-text::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        .editorial-loading-text .doc-highlight {
            position: relative;
            border-radius: 2px;
            transition: background 0.4s var(--ease-out-expo);
        }
        .editorial-loading-text .doc-highlight-green { background: rgba(45, 138, 78, 0.06); }
        .editorial-loading-text .doc-highlight-yellow { background: rgba(184, 134, 11, 0.06); }
        .editorial-loading-text .doc-highlight-red { background: rgba(196, 75, 40, 0.06); }
        .editorial-loading-text .doc-highlight.active.doc-highlight-green { background: rgba(45, 138, 78, 0.15); }
        .editorial-loading-text .doc-highlight.active.doc-highlight-yellow { background: rgba(184, 134, 11, 0.15); }
        .editorial-loading-text .doc-highlight.active.doc-highlight-red { background: rgba(196, 75, 40, 0.18); }
        .doc-clause-marker {
            display: inline-block; font-family: 'JetBrains Mono', monospace;
            font-size: 0.55rem; font-weight: 700; line-height: 1;
            width: 15px; height: 15px; text-align: center; line-height: 15px;
            border-radius: 50%; margin-right: 3px;
            vertical-align: middle; color: #fff; cursor: pointer;
        }
        .doc-highlight { cursor: pointer; }
        .doc-clause-marker-green { background: var(--green); }
        .doc-clause-marker-yellow { background: var(--yellow); }
        .doc-clause-marker-red { background: var(--red); }
        .doc-highlight.whoosh-flash {
            animation: highlightFlash 1.2s ease-out;
        }
        @keyframes highlightFlash {
            0% { background: rgba(196, 75, 40, 0.55); box-shadow: 0 0 24px rgba(196, 75, 40, 0.45), inset 0 0 8px rgba(196, 75, 40, 0.2); }
            40% { background: rgba(196, 75, 40, 0.3); box-shadow: 0 0 12px rgba(196, 75, 40, 0.2); }
            100% { box-shadow: none; }
        }
        .clause-whoosh-ghost {
            position: fixed; z-index: 9999; pointer-events: none;
            display: flex; align-items: center; gap: 8px;
            padding: 8px 16px 8px 10px;
            border-radius: var(--radius-sm);
            font-family: 'DM Sans', sans-serif;
            font-size: 0.78rem; font-weight: 600;
            color: #fff; white-space: nowrap;
            max-width: 340px; overflow: hidden;
            will-change: transform, opacity;
            border: 1px solid rgba(255,255,255,0.25);
        }
        .clause-whoosh-ghost .ghost-num {
            display: inline-flex; align-items: center; justify-content: center;
            width: 22px; height: 22px; border-radius: 50%;
            background: rgba(255,255,255,0.3); font-size: 0.65rem;
            font-family: 'JetBrains Mono', monospace; font-weight: 700;
            flex-shrink: 0;
        }
        .clause-whoosh-ghost .ghost-text {
            overflow: hidden; text-overflow: ellipsis;
            font-weight: 500; font-style: italic; opacity: 0.95;
        }
        .clause-whoosh-ghost-green { background: var(--green); box-shadow: 0 6px 28px rgba(45, 138, 78, 0.5); }
        .clause-whoosh-ghost-yellow { background: var(--yellow); color: #1a1a1a; box-shadow: 0 6px 28px rgba(184, 134, 11, 0.5); }
        .clause-whoosh-ghost-yellow .ghost-num { background: rgba(0,0,0,0.15); }
        .clause-whoosh-ghost-red { background: var(--accent); box-shadow: 0 6px 28px rgba(196, 75, 40, 0.5); }

        .card-land-flash {
            animation: cardLandFlash 0.7s ease-out;
        }
        @keyframes cardLandFlash {
            0% { box-shadow: inset 0 0 0 2px var(--accent), 0 0 24px rgba(196, 75, 40, 0.3); }
            100% { box-shadow: none; }
        }
        .editorial-loading-indicator {
            display: flex; align-items: center; gap: 0.75rem;
            margin: 0 1.5rem; padding: 1rem 0 1.2rem;
            border-top: 1px solid transparent;
            border-image: linear-gradient(90deg, transparent, var(--border), transparent) 1;
        }
        .editorial-loading-status {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem; font-weight: 500;
            text-transform: uppercase; letter-spacing: 0.15em;
            color: var(--text-muted);
        }
        .pulsing-dots { display: inline-flex; gap: 3px; }
        .pulsing-dots span {
            width: 4px; height: 4px; border-radius: 50%;
            background: var(--accent); animation: pulse 1.5s infinite;
        }
        .pulsing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .pulsing-dots span:nth-child(3) { animation-delay: 0.4s; }

        .pulsing-dot {
            display: inline-block; width: 6px; height: 6px;
            border-radius: 50%; background: var(--accent);
            margin-left: 0.4rem; animation: pulse 1.5s infinite;
            vertical-align: middle;
        }

        /* ── Card viewport ──────────────────────────── */
        .card-viewport { margin: 0.5rem 0 1.5rem; }
        .card-nav-btn {
            display: inline-flex; align-items: center; gap: 0.35rem;
            background: none; border: 1px solid var(--border);
            padding: 0.55rem 1.2rem; border-radius: var(--radius-sm);
            font-family: inherit; font-size: 0.82rem; font-weight: 500;
            color: var(--text-secondary); cursor: pointer;
            transition: all var(--transition);
        }
        .card-nav-btn:hover:not(:disabled) {
            border-color: var(--text-muted); color: var(--text-primary);
            background: var(--bg-card);
        }
        .card-nav-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        .card-nav-counter {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.78rem; color: var(--text-muted); font-weight: 500;
            font-variant-numeric: tabular-nums;
        }
        .card-nav-counter strong { color: var(--text-primary); font-weight: 700; }

        /* ── Educational review pill (top of analysis) ── */
        .edu-review-pill {
            text-align: left; margin: 0 0 0.75rem;
            padding: 0.35rem 1rem;
            background: var(--bg-warm); border: 1px solid var(--border);
            border-radius: 100px; width: fit-content;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.58rem; font-weight: 500;
            letter-spacing: 0.04em;
            color: var(--text-muted); line-height: 1.4;
            opacity: 0; transform: translateY(8px);
            animation: fadeUp 0.5s var(--ease-out-expo) both;
        }
        .edu-review-pill.hidden { display: none; }


        /* ── Document title hero (analysis entry) ── */
        .doc-title-hero {
            text-align: center; margin-bottom: 1rem;
            font-family: 'DM Sans', sans-serif;
            font-size: 1.6rem; font-weight: 700;
            letter-spacing: -0.03em; color: var(--text-primary);
            line-height: 1.2;
            opacity: 0; transform: translateY(12px);
            animation: fadeUp 0.6s var(--ease-out-expo) 0.1s forwards;
        }
        .doc-title-hero.hidden { display: none; }
        .doc-title-flag {
            display: inline-block; margin-left: 0.4rem;
            font-size: 1.4rem; vertical-align: middle;
            opacity: 0; transition: opacity 0.4s ease;
        }
        .doc-title-flag:not(.hidden) { opacity: 1; }

        /* sample-badge: removed — replaced by edu-review-pill */

        /* ── Sticky card nav (top) ── */
        .card-nav-sticky {
            position: sticky; top: 58px; z-index: 40;
            display: none; /* shown after first flip */
            flex-wrap: wrap;
            align-items: center; justify-content: space-between;
            gap: 0.75rem; padding: 0.55rem 1rem;
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius); margin-bottom: 1rem;
            box-shadow: var(--shadow-sm);
        }
        .card-nav-sticky.visible { display: flex; }
        .card-nav-sticky .card-nav-btn {
            padding: 0.35rem 0.8rem; font-size: 0.76rem;
        }
        .card-nav-sticky .card-nav-counter {
            font-size: 0.72rem;
        }
        .card-nav-pips {
            display: flex; align-items: center; gap: 4px;
        }
        .card-nav-pip {
            width: 8px; height: 8px; border-radius: 50%;
            background: var(--border); transition: all 0.3s ease;
            cursor: pointer;
        }
        .card-nav-pip.active {
            transform: scale(1.3);
        }
        .card-nav-pip.pip-green { background: var(--green); }
        .card-nav-pip.pip-yellow { background: var(--yellow); }
        .card-nav-pip.pip-red { background: var(--accent); }

        /* ── Verdict progress strip ── */
        .verdict-progress-strip {
            display: none;
            width: 100%; align-items: center; justify-content: center;
            gap: 0.6rem; padding: 0.45rem 0.8rem 0.35rem;
            border-top: 1px solid var(--border);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.6rem; font-weight: 600;
            letter-spacing: 0.03em; color: var(--text-muted);
        }
        .verdict-progress-strip.visible { display: flex; }
        .verdict-strip-dots {
            display: inline-flex; align-items: center; gap: 4px;
        }
        .verdict-strip-dot {
            width: 6px; height: 6px; border-radius: 50%;
            border: 1.5px solid var(--text-muted);
            background: transparent; transition: all 0.4s var(--ease-out-expo);
        }
        .verdict-strip-dot.done {
            background: var(--accent); border-color: var(--accent);
        }
        .verdict-strip-dot:not(.done) {
            animation: verdictDotPulse 1.8s ease-in-out infinite;
        }
        .verdict-strip-dot:nth-child(2):not(.done) { animation-delay: 0.15s; }
        .verdict-strip-dot:nth-child(3):not(.done) { animation-delay: 0.3s; }
        .verdict-strip-dot:nth-child(4):not(.done) { animation-delay: 0.45s; }
        @keyframes verdictDotPulse {
            0%, 100% { opacity: 0.4; } 50% { opacity: 1; }
        }
        #verdictStripPeek {
            display: flex; align-items: center; gap: 0.6rem;
            color: var(--text-secondary); font-weight: 600;
            font-size: 0.68rem;
        }
        #verdictStripPeek .verdict-strip-peek {
            background: rgba(196,75,40,0.7); animation: none;
        }
        #verdictStripReady {
            display: flex; align-items: center; gap: 0.6rem;
            color: var(--accent); font-weight: 700;
        }
        #verdictStripReady .verdict-strip-cta,
        #verdictStripPeek .verdict-strip-cta {
            padding: 0.3rem 0.7rem; border-radius: 100px;
            background: var(--accent); color: #fff;
            border: none; cursor: pointer;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.6rem; font-weight: 700;
            letter-spacing: 0.03em;
            transition: box-shadow 0.3s ease;
        }
        #verdictStripReady .verdict-strip-cta:hover,
        #verdictStripPeek .verdict-strip-cta:hover {
            box-shadow: 0 0 0 4px rgba(196,75,40,0.15);
        }

        /* ── Thinking viewer (opt-in, inside verdict strip) ── */
        .thinking-toggle {
            display: none; /* shown when thinking starts */
            align-items: center; gap: 0.3rem;
            margin-left: 0.6rem;
            padding: 0.15rem 0.5rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.55rem; font-weight: 500;
            color: var(--text-muted); cursor: pointer;
            border: 1px solid var(--border-light); border-radius: 100px;
            background: rgba(0,0,0,0.02);
            letter-spacing: 0.03em;
            transition: color 0.2s, border-color 0.2s;
        }
        .thinking-toggle:hover { color: var(--accent); border-color: var(--accent); }
        .thinking-toggle.visible { display: inline-flex; }
        .thinking-toggle-icon {
            transition: transform 0.25s var(--ease-out-expo);
            font-size: 0.45rem;
        }
        .thinking-toggle.open .thinking-toggle-icon { transform: rotate(90deg); }
        .thinking-toggle.open { color: var(--accent); border-color: var(--accent); }
        .thinking-viewer {
            display: none;
            max-height: 200px; overflow-y: auto;
            margin: 0 0 0.75rem;
            padding: 0.6rem 0.8rem;
            background: rgba(0,0,0,0.03);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-sm);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.6rem; line-height: 1.65;
            color: var(--text-muted);
            white-space: pre-wrap; word-break: break-word;
        }
        .thinking-viewer.open { display: block; }

        /* ── Risk summary strip ── */
        .risk-summary-strip {
            display: none; /* shown after all cards built */
            align-items: center; justify-content: center;
            gap: 1.2rem; padding: 0.4rem 0;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.62rem; font-weight: 600;
            letter-spacing: 0.04em; color: var(--text-muted);
        }
        .risk-summary-strip.visible { display: flex; }
        .risk-summary-strip .risk-count { display: inline-flex; align-items: center; gap: 0.3rem; }
        .risk-summary-strip .risk-dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
        .risk-summary-strip .risk-dot-red { background: var(--red); }
        .risk-summary-strip .risk-dot-yellow { background: var(--yellow); }
        .risk-summary-strip .risk-dot-green { background: var(--green); }

        /* ── Tricks detected (collapsible, in card nav area) ── */
        .tricks-detected-bar {
            display: none; align-items: center; gap: 0.5rem;
            padding: 0.4rem 0.85rem; margin: 0 0 0.75rem;
            background: var(--bg-warm); border: 1px solid var(--border);
            border-radius: var(--radius); cursor: pointer;
            transition: all 0.2s ease;
        }
        .tricks-detected-bar.visible { display: flex; }
        .tricks-detected-bar:hover { border-color: var(--accent); }
        .tricks-detected-label {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.62rem; font-weight: 600;
            text-transform: uppercase; letter-spacing: 0.06em;
            color: var(--text-secondary); flex: 1;
        }
        .tricks-detected-chevron {
            font-size: 0.72rem; color: var(--text-muted);
            transition: transform 0.3s ease;
        }
        .tricks-detected-bar.expanded .tricks-detected-chevron { transform: rotate(180deg); }
        .tricks-detected-pills {
            display: none; flex-wrap: wrap; gap: 0.3rem;
            padding: 0 0 0.5rem;
        }
        .tricks-detected-bar.expanded + .tricks-detected-pills { display: flex; }

        /* ── Inline verdict section (after cards) ── */
        /* ── Inline verdict (5-layer report) ── */
        .inline-verdict {
            display: none; padding: 0; margin-top: 1rem;
            animation: fadeUp 0.5s var(--ease-out-expo) both;
        }
        .inline-verdict.visible { display: block; }
        .inline-verdict-divider {
            display: flex; align-items: center; gap: 1rem;
            margin: 1.5rem 0 1.5rem; color: var(--text-muted);
        }
        .inline-verdict-divider::before,
        .inline-verdict-divider::after {
            content: ''; flex: 1; height: 1px;
            background: linear-gradient(90deg, transparent, var(--border), transparent);
        }
        .inline-verdict-divider-text {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.65rem; font-weight: 600;
            text-transform: uppercase; letter-spacing: 0.12em;
            white-space: nowrap;
        }
        .inline-verdict-progress {
            display: flex; align-items: center; justify-content: center; gap: 0.6rem;
            padding: 1.5rem; margin: 1rem 0;
            font-family: 'JetBrains Mono', monospace; font-size: 0.72rem;
            color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.08em;
        }

        /* Layer 1 — Summary */
        .verdict-layer-summary {
            padding: 1.5rem; margin-bottom: 1.5rem;
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius); box-shadow: var(--shadow-sm);
        }
        .verdict-summary-text {
            font-size: 0.92rem; line-height: 1.7; color: var(--text-body);
        }
        .verdict-summary-text strong { color: var(--text-primary); }
        .verdict-tier-badge {
            display: inline-flex; align-items: center; gap: 0.4rem;
            padding: 0.3rem 0.8rem; margin-top: 0.75rem; border-radius: 100px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.62rem; font-weight: 700;
            letter-spacing: 0.04em; text-transform: uppercase;
        }
        .verdict-tier-badge.tier-green { background: rgba(45,138,78,0.1); color: var(--green); border: 1px solid var(--green-border); }
        .verdict-tier-badge.tier-yellow { background: rgba(176,128,0,0.1); color: var(--yellow-dark); border: 1px solid var(--yellow); }
        .verdict-tier-badge.tier-red { background: rgba(196,75,40,0.08); color: var(--accent); border: 1px solid var(--accent); }
        .verdict-power-ratio {
            display: inline-flex; align-items: center; gap: 0.4rem;
            padding: 0.2rem 0.6rem; margin-left: 0.5rem; border-radius: 100px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.6rem; font-weight: 600;
            color: var(--text-muted); background: var(--bg-surface);
            border: 1px solid var(--border);
        }

        /* Layer 2 — Findings */
        .verdict-layer-findings { margin-bottom: 1.5rem; }
        .verdict-layer-header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 0.6rem 0; margin-bottom: 0.75rem; cursor: pointer;
            border-bottom: 1px solid var(--border);
        }
        .verdict-layer-title {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.68rem; font-weight: 700;
            text-transform: uppercase; letter-spacing: 0.08em;
            color: var(--text-secondary);
        }
        .verdict-layer-chevron {
            font-size: 0.7rem; color: var(--text-muted);
            transition: transform 0.3s ease;
        }
        .verdict-layer.collapsed .verdict-layer-chevron { transform: rotate(-90deg); }
        .verdict-layer.collapsed .verdict-layer-body { display: none; }

        .verdict-finding {
            margin-bottom: 1.25rem; padding: 1.25rem;
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius); box-shadow: var(--shadow-sm);
        }
        .verdict-finding-title {
            font-size: 0.95rem; font-weight: 700; color: var(--text-primary);
            line-height: 1.35; margin-bottom: 0.75rem;
        }
        .verdict-finding-source {
            border-left: 3px solid var(--border); margin: 0.6rem 0;
            padding: 0.6rem 0.9rem; font-size: 0.82rem; line-height: 1.6;
            color: var(--text-secondary); background: var(--bg-surface);
            border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
        }
        .verdict-finding-source-label {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.58rem; font-weight: 600;
            text-transform: uppercase; letter-spacing: 0.06em;
            color: var(--text-muted); margin-bottom: 0.3rem;
        }
        .verdict-finding-explanation {
            font-size: 0.88rem; line-height: 1.65; color: var(--text-body);
            margin: 0.6rem 0;
        }
        .verdict-finding-meta {
            display: flex; align-items: center; flex-wrap: wrap;
            gap: 0.5rem; margin-top: 0.6rem;
        }
        .verdict-severity-badge {
            display: inline-flex; align-items: center; gap: 0.3rem;
            padding: 0.2rem 0.55rem; border-radius: 100px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.55rem; font-weight: 700;
            letter-spacing: 0.04em; text-transform: uppercase;
        }
        .verdict-severity-badge.severity-standard { background: rgba(45,138,78,0.08); color: var(--green); }
        .verdict-severity-badge.severity-aggressive { background: rgba(176,128,0,0.08); color: var(--yellow-dark); }
        .verdict-severity-badge.severity-unusual { background: rgba(196,75,40,0.08); color: var(--accent); }
        .verdict-finding-action {
            display: flex; align-items: flex-start; gap: 0.5rem;
            margin-top: 0.6rem; padding: 0.5rem 0.75rem;
            background: rgba(45,138,78,0.04); border-radius: var(--radius-sm);
            font-size: 0.82rem; line-height: 1.5; color: var(--text-body);
        }
        .verdict-finding-action::before {
            content: '\2192'; flex-shrink: 0; font-weight: 700;
            color: var(--green);
        }
        .verdict-show-all {
            display: block; text-align: center; padding: 0.5rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.62rem; font-weight: 600;
            color: var(--accent); cursor: pointer;
            letter-spacing: 0.04em;
        }
        .verdict-show-all:hover { text-decoration: underline; }

        /* Layer 3 — Checklist */
        .verdict-layer-checklist { margin-bottom: 1.5rem; }
        .verdict-checklist-section-title {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.62rem; font-weight: 700;
            text-transform: uppercase; letter-spacing: 0.06em;
            color: var(--text-muted); margin: 0.75rem 0 0.4rem;
        }
        .verdict-checklist-item {
            display: flex; align-items: flex-start; gap: 0.5rem;
            padding: 0.35rem 0; font-size: 0.85rem; line-height: 1.55;
            color: var(--text-body);
        }
        .verdict-checklist-item::before {
            content: '\25A1'; flex-shrink: 0; font-size: 0.9rem;
            color: var(--text-muted); margin-top: 0.05rem;
        }

        /* Layer 4 — Deep Read */
        .verdict-layer-deep { margin-bottom: 1.5rem; }
        .verdict-deep-body {
            padding: 1.25rem; background: var(--bg-card);
            border: 1px solid var(--border); border-radius: var(--radius);
            font-size: 0.88rem; line-height: 1.65; color: var(--text-body);
        }
        .verdict-deep-body h2 { font-size: 1rem; margin: 1.25rem 0 0.5rem; font-weight: 700; }
        .verdict-deep-body h3 { font-size: 0.92rem; margin: 1rem 0 0.4rem; font-weight: 600; }
        .verdict-deep-body p { margin: 0.4rem 0; }
        .verdict-deep-body ul, .verdict-deep-body ol { padding-left: 1.2rem; margin: 0.4rem 0; }
        .verdict-deep-body li { margin: 0.2rem 0; }
        .verdict-deep-body blockquote {
            border-left: 3px solid var(--border); margin: 0.6rem 0;
            padding: 0.4rem 0.8rem; color: var(--text-secondary); font-size: 0.85rem;
            background: var(--bg-surface); border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
        }

        /* Layer 5 — Colophon */
        .verdict-layer-colophon { margin-bottom: 1.5rem; }
        .verdict-colophon-body {
            padding: 1rem; font-size: 0.76rem; line-height: 1.6;
            color: var(--text-muted); background: var(--bg-surface);
            border: 1px solid var(--border-light); border-radius: var(--radius);
        }
        .verdict-colophon-body p { margin: 0.3rem 0; }

        /* Verdict skeleton placeholders (peek state) */
        .verdict-skeleton {
            padding: 0.7rem 1rem; margin-bottom: 0.75rem;
            background: var(--bg-surface); border-radius: var(--radius-sm);
            border: 1px dashed var(--border);
            display: flex; align-items: center; gap: 0.6rem;
            opacity: 0.6;
        }
        .verdict-skeleton-label {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.6rem; font-weight: 600;
            text-transform: uppercase; letter-spacing: 0.06em;
            color: var(--text-muted);
        }
        .verdict-skeleton .pulsing-dots span {
            background: var(--text-muted);
        }

        /* "Still building" footer — visible while Opus is streaming */
        .verdict-building-footer {
            display: flex; align-items: center; justify-content: center; gap: 0.6rem;
            padding: 1.2rem 1rem; margin: 1rem 0 2rem;
            border: 1px dashed var(--border);
            border-radius: var(--radius-sm);
            background: var(--bg-surface);
        }
        .verdict-building-footer-text {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.62rem; font-weight: 600;
            text-transform: uppercase; letter-spacing: 0.06em;
            color: var(--text-muted);
        }
        .verdict-building-footer .pulsing-dots span {
            background: var(--text-muted);
        }

        /* One-screen verdict card */
        .verdict-onescreen {
            padding: 1.75rem; margin-bottom: 1.5rem;
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius); box-shadow: var(--shadow-sm);
        }
        /* Flash verdict — bridge summary from card data */
        .flash-verdict {
            padding: 1.5rem 1.75rem; margin-bottom: 1.5rem;
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius); box-shadow: var(--shadow-sm);
        }
        .flash-verdict-label {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.58rem; font-weight: 700;
            text-transform: uppercase; letter-spacing: 0.08em;
            color: var(--text-muted); margin-bottom: 0.75rem;
        }
        .flash-verdict-risks {
            display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: center;
            margin-bottom: 0.6rem; font-size: 0.82rem; font-weight: 600;
        }
        .flash-risk { padding: 0.25rem 0.7rem; border-radius: 100px; }
        .flash-risk-red { background: rgba(196,75,40,0.1); color: var(--accent); }
        .flash-risk-yellow { background: rgba(176,128,0,0.1); color: var(--yellow-dark); }
        .flash-risk-green { background: rgba(45,138,78,0.1); color: var(--green); }
        .flash-risk-total { color: var(--text-muted); font-weight: 400; font-size: 0.75rem; }
        .flash-verdict-worst {
            font-size: 0.8rem; color: var(--text-secondary);
            margin-bottom: 0.4rem; line-height: 1.5;
        }
        .flash-verdict-worst strong { color: var(--accent); }
        .flash-verdict-tricks {
            font-size: 0.75rem; color: var(--text-muted);
            margin-bottom: 0.75rem; line-height: 1.5;
        }
        .flash-verdict-waiting {
            font-size: 0.72rem; color: var(--text-muted);
            padding-top: 0.5rem; border-top: 1px solid var(--border);
        }
        .verdict-onescreen .verdict-tier-badge {
            display: inline-flex; align-items: center; gap: 0.5rem;
            padding: 0.5rem 1.1rem; margin-bottom: 1rem; border-radius: 100px;
            font-size: 0.72rem; font-weight: 800;
        }
        .verdict-tier-badge.tier-orange {
            background: rgba(210,120,20,0.1); color: #b06800;
            border: 1px solid #d4a030;
        }
        .verdict-tier-icon { font-size: 0.9rem; }
        .verdict-enforcement-frame {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.58rem; font-weight: 500;
            letter-spacing: 0.03em; color: var(--text-muted);
            margin-bottom: 1.2rem;
        }
        .verdict-what-is-this {
            font-size: 1.05rem; line-height: 1.55; color: var(--text-primary);
            font-weight: 500; margin-bottom: 0.4rem;
        }
        .verdict-should-worry {
            font-size: 0.88rem; line-height: 1.55; color: var(--text-secondary);
            margin-bottom: 1.25rem;
        }
        .verdict-main-thing {
            padding: 1.1rem 1.25rem; margin-bottom: 1rem;
            background: var(--bg-surface); border-left: 3px solid var(--accent);
            border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
        }
        .verdict-main-thing-label {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.58rem; font-weight: 700;
            text-transform: uppercase; letter-spacing: 0.08em;
            color: var(--accent); margin-bottom: 0.4rem;
        }
        .verdict-main-thing-text {
            font-size: 0.92rem; line-height: 1.65; color: var(--text-primary);
        }
        .verdict-main-thing-text strong { font-weight: 700; }
        .verdict-main-thing-text p { margin: 0.3rem 0; }
        .verdict-one-action {
            padding: 0.9rem 1.1rem; margin-bottom: 1rem;
            background: rgba(75,100,130,0.05); border-left: 3px solid #4b6482;
            border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
        }
        .verdict-one-action-label {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.58rem; font-weight: 700;
            text-transform: uppercase; letter-spacing: 0.08em;
            color: #4b6482; margin-bottom: 0.4rem;
        }
        .verdict-one-action-text {
            font-size: 0.88rem; line-height: 1.55; color: var(--text-body);
        }
        .verdict-onescreen .verdict-power-ratio {
            display: inline-block; margin-bottom: 0.5rem;
            padding: 0.25rem 0.7rem; border-radius: 100px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.62rem; font-weight: 600;
            color: var(--text-muted); background: var(--bg-surface);
            border: 1px solid var(--border);
        }
        .verdict-jurisdiction {
            margin-top: 0.75rem; padding: 0.75rem 1rem;
            background: rgba(75,100,130,0.04);
            border: 1px solid rgba(75,100,130,0.2);
            border-radius: var(--radius-sm);
        }
        .verdict-jurisdiction.jurisdiction-warnings {
            background: rgba(196,75,40,0.04);
            border-color: var(--accent);
            border-width: 2px;
        }
        .verdict-jurisdiction-label {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.6rem; font-weight: 700;
            text-transform: uppercase; letter-spacing: 0.06em;
            color: var(--text-secondary); margin-bottom: 0.3rem;
            display: flex; align-items: center; gap: 0.4rem;
        }
        .jurisdiction-flag {
            font-size: 1.2rem; line-height: 1;
        }
        .verdict-jurisdiction-details {
            font-size: 0.82rem; line-height: 1.6; color: var(--text-body);
        }
        .verdict-jurisdiction-details p { margin: 0.3rem 0; }

        /* Section index — "keep reading" pills below verdict card */
        .verdict-sections-index {
            display: flex; flex-wrap: wrap; align-items: center;
            gap: 0.4rem; padding: 0.75rem 0; margin-bottom: 0.75rem;
            border-bottom: 1px solid var(--border);
        }
        .verdict-sections-label {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.55rem; font-weight: 700;
            text-transform: uppercase; letter-spacing: 0.06em;
            color: var(--text-muted); margin-right: 0.2rem;
        }
        .verdict-section-pill {
            padding: 0.2rem 0.55rem; border-radius: 100px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.55rem; font-weight: 600;
            color: var(--text-secondary); background: var(--bg-surface);
            border: 1px solid var(--border);
            cursor: pointer; transition: all 0.2s ease;
            white-space: nowrap;
        }
        .verdict-section-pill:hover {
            background: var(--bg-warm); border-color: var(--text-secondary);
            color: var(--text-primary);
        }
        .verdict-section-pill.pending {
            border-style: dashed; opacity: 0.5;
            cursor: default;
        }

        /* Additional risks layer */
        .verdict-layer-risks { margin-bottom: 1.5rem; }
        .verdict-risk-item {
            padding: 0.5rem 0; font-size: 0.88rem; line-height: 1.55;
            color: var(--text-body); border-bottom: 1px solid var(--border-light);
        }
        .verdict-risk-item:last-child { border-bottom: none; }
        .verdict-risk-item p { margin: 0; display: inline; }
        .verdict-risk-item strong { font-weight: 700; }

        /* Flagged claims section — open by default (no 'collapsed' class added) */
        .verdict-layer-claims { margin-bottom: 1.5rem; }
        .verdict-claim-item {
            padding: 0.6rem 0; font-size: 0.88rem; line-height: 1.55;
            color: var(--text-body); border-bottom: 1px solid var(--border-light);
        }
        .verdict-claim-item:last-child { border-bottom: none; }
        .verdict-claim-item p { margin: 0; display: inline; }
        .verdict-claim-item strong { font-weight: 700; color: var(--accent-burnt); }

        /* Depth buttons */
        .verdict-depth-buttons {
            margin-top: 2rem; padding-top: 1.5rem;
            border-top: 1px solid var(--border-light);
        }
        .verdict-depth-label {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.6rem; font-weight: 700;
            text-transform: uppercase; letter-spacing: 0.08em;
            color: var(--text-muted); margin-bottom: 0.75rem;
        }
        .verdict-depth-btn {
            display: flex; align-items: center; gap: 0.75rem;
            width: 100%; padding: 0.7rem 1rem; margin-bottom: 0.5rem;
            background: var(--bg-surface); border: 1px solid var(--border);
            border-radius: var(--radius-sm); cursor: pointer;
            text-align: left; transition: all 0.25s ease;
        }
        .verdict-depth-btn:hover:not(.locked) {
            background: var(--accent-light); border-color: var(--accent);
        }
        .verdict-depth-btn.locked {
            opacity: 0.45; cursor: not-allowed;
        }
        .verdict-depth-btn.building {
            border-color: var(--accent); opacity: 0.8;
        }
        .verdict-depth-btn.ready {
            border-color: var(--green);
        }
        .verdict-depth-btn.active {
            border-color: var(--accent); background: var(--accent-light);
        }
        .verdict-depth-btn-icon { flex-shrink: 0; color: var(--text-muted); display: flex; align-items: center; }
        .verdict-depth-btn-status {
            margin-left: auto; flex-shrink: 0;
            font-size: 0.65rem; color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
        }
        .verdict-depth-btn-status .pulsing-dots span {
            width: 3px; height: 3px;
        }
        .verdict-depth-btn-text { display: flex; flex-direction: column; gap: 0.1rem; }
        .verdict-depth-btn-title {
            font-size: 0.82rem; font-weight: 600; color: var(--text-primary);
        }
        .verdict-depth-btn-desc {
            font-size: 0.68rem; color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
        }
        /* Depth result panels */
        .depth-result-panel {
            display: none; margin-bottom: 1rem;
            padding: 1.25rem 1.5rem;
            background: var(--bg-surface); border: 1px solid var(--border);
            border-radius: var(--radius-md);
            animation: fadeUp 0.3s var(--ease-out-expo) both;
        }
        .depth-result-panel.visible { display: block; }
        .depth-result-panel .depth-result-loading {
            display: flex; align-items: center; gap: 0.6rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.72rem; color: var(--text-muted);
        }
        .depth-result-panel .depth-result-content {
            font-size: 0.85rem; line-height: 1.65; color: var(--text-body);
        }
        .depth-result-content h2 {
            font-size: 1rem; font-weight: 700; color: var(--text-primary);
            margin: 1.25rem 0 0.5rem;
        }
        .depth-result-content h3 {
            font-size: 0.9rem; font-weight: 600; color: var(--text-primary);
            margin: 1rem 0 0.4rem;
        }
        .depth-result-content blockquote {
            border-left: 3px solid var(--accent); margin: 0.5rem 0;
            padding: 0.4rem 0.8rem; background: var(--accent-light);
            font-size: 0.82rem; color: var(--text-secondary);
            border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
        }
        .depth-result-content hr {
            border: none; border-top: 1px solid var(--border-light);
            margin: 1rem 0;
        }
        .depth-result-content strong { color: var(--text-primary); }
        .depth-result-content ul, .depth-result-content ol {
            margin: 0.4rem 0; padding-left: 1.2rem;
        }
        .depth-result-content li { margin-bottom: 0.3rem; }
        /* ── Scenario timeline ── */
        .scenario-layout { padding: 0; }
        .scenario-title {
            font-size: 1.2rem; font-weight: 700; color: var(--text-primary);
            margin-bottom: 0.5rem;
        }
        .scenario-setup {
            font-size: 0.88rem; line-height: 1.6; color: var(--text-secondary);
            padding: 0.75rem 1rem; background: var(--bg-warm); border-radius: var(--radius-sm);
            margin-bottom: 1.25rem; border-left: 3px solid var(--text-muted);
        }
        .scenario-timeline {
            position: relative; padding-left: 1.5rem;
            border-left: 2px solid var(--border-light); margin-bottom: 1.25rem;
        }
        .scenario-step { position: relative; margin-bottom: 1.25rem; }
        .scenario-step-marker {
            position: absolute; left: -1.75rem; top: 0.35rem;
            width: 10px; height: 10px; border-radius: 50%;
            background: var(--accent); border: 2px solid var(--bg-surface);
        }
        .scenario-step-title {
            font-family: 'JetBrains Mono', monospace; font-size: 0.72rem;
            font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em;
            color: var(--accent); margin-bottom: 0.35rem;
        }
        .scenario-step-body { font-size: 0.85rem; line-height: 1.6; color: var(--text-primary); }
        .scenario-step-body p { margin: 0 0 0.4rem; }
        .scenario-total {
            font-size: 0.9rem; font-weight: 700; color: var(--text-primary);
            padding: 0.85rem 1rem; background: var(--bg-warm);
            border-radius: var(--radius-sm); border-left: 3px solid var(--accent);
            margin-bottom: 1.25rem;
        }
        .scenario-total table { width: 100%; border-collapse: collapse; margin-top: 0.5rem; font-weight: 400; font-size: 0.82rem; }
        .scenario-total th, .scenario-total td { padding: 0.3rem 0.5rem; text-align: left; border-bottom: 1px solid var(--border-light); }
        .scenario-total th { font-weight: 600; font-size: 0.72rem; text-transform: uppercase; letter-spacing: 0.06em; color: var(--text-muted); }
        .scenario-actions {
            margin-bottom: 1.25rem; padding: 0.85rem 1rem;
            background: var(--green-bg); border-radius: var(--radius-sm);
            border-left: 3px solid var(--green);
        }
        .scenario-actions-title {
            font-size: 0.78rem; font-weight: 700; text-transform: uppercase;
            letter-spacing: 0.08em; color: var(--green-text); margin-bottom: 0.5rem;
        }
        .scenario-actions ul { margin: 0; padding-left: 1.2rem; }
        .scenario-actions li { font-size: 0.85rem; line-height: 1.5; margin-bottom: 0.35rem; }
        .scenario-message {
            padding: 1rem; background: var(--bg-surface);
            border: 1px solid var(--border-light); border-radius: var(--radius-sm);
        }
        .scenario-message-title {
            font-size: 0.78rem; font-weight: 700; text-transform: uppercase;
            letter-spacing: 0.08em; color: var(--text-muted); margin-bottom: 0.6rem;
        }
        .scenario-message-body {
            font-size: 0.85rem; line-height: 1.6; color: var(--text-primary);
            padding: 0.75rem; background: #fff; border: 1px solid var(--border-light);
            border-radius: var(--radius-sm); margin-bottom: 0.6rem;
        }
        .scenario-message-actions { display: flex; gap: 0.5rem; }
        .scenario-message-actions button {
            padding: 0.4rem 0.9rem; font-size: 0.78rem; font-weight: 600;
            border-radius: var(--radius-sm); cursor: pointer; transition: all var(--transition);
        }
        .scenario-copy-btn {
            background: var(--bg-warm); border: 1px solid var(--border); color: var(--text-primary);
        }
        .scenario-copy-btn:hover { background: var(--border-light); }
        .scenario-email-btn {
            background: var(--accent); border: 1px solid var(--accent); color: #fff;
        }
        .scenario-email-btn:hover { opacity: 0.9; }
        /* ── Finding cards (archaeology, interactions, asymmetry) ── */
        .finding-summary {
            font-size: 0.9rem; line-height: 1.6; color: var(--text-primary);
            font-weight: 500; margin-bottom: 1rem;
            padding: 0.75rem 1rem; background: var(--bg-warm);
            border-radius: var(--radius-sm); border-left: 3px solid var(--text-muted);
        }
        .finding-card {
            margin-bottom: 1rem; padding: 0.85rem 1rem;
            border-radius: var(--radius-sm); border: 1px solid var(--border);
            background: var(--bg-card);
        }
        .finding-header {
            display: flex; align-items: flex-start; gap: 0.6rem; margin-bottom: 0.5rem;
        }
        .finding-number {
            display: inline-flex; align-items: center; justify-content: center;
            width: 1.4rem; height: 1.4rem; flex-shrink: 0; margin-top: 0.1rem;
            border-radius: 50%; font-size: 0.7rem; font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            background: var(--bg-warm); color: var(--text-secondary); border: 1px solid var(--border);
        }
        .finding-title {
            font-size: 0.88rem; font-weight: 600; color: var(--text-primary);
            margin: 0; line-height: 1.4; flex: 1;
        }
        .finding-severity {
            flex-shrink: 0; font-size: 0.65rem; font-weight: 700; text-transform: uppercase;
            font-family: 'JetBrains Mono', monospace; padding: 0.15rem 0.5rem;
            border-radius: 100px; white-space: nowrap;
        }
        .finding-severity-aggressive { background: var(--red-bg); color: var(--accent); border: 1px solid var(--accent); }
        .finding-severity-unusual { background: var(--yellow-bg); color: var(--yellow-dark); border: 1px solid var(--yellow); }
        .finding-severity-standard { background: var(--bg-warm); color: var(--text-muted); border: 1px solid var(--border); }
        .finding-card:has(.finding-severity-aggressive) { border-left: 3px solid var(--accent); }
        .finding-card:has(.finding-severity-unusual) { border-left: 3px solid var(--yellow); }
        .finding-source {
            border-left: 3px solid var(--border); margin: 0.5rem 0;
            padding: 0.4rem 0.8rem; background: var(--bg-warm);
            font-size: 0.8rem; color: var(--text-secondary); line-height: 1.5;
            border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
            font-style: italic;
        }
        .finding-explanation {
            font-size: 0.84rem; line-height: 1.6; color: var(--text-body);
            margin: 0.5rem 0;
        }
        .finding-severity-context {
            font-size: 0.78rem; color: var(--text-muted); font-style: italic;
            margin: 0.4rem 0;
        }
        .finding-action {
            font-size: 0.82rem; line-height: 1.5; color: var(--text-primary);
            margin-top: 0.5rem; padding: 0.5rem 0.75rem;
            background: rgba(75,100,130,0.05); border-left: 3px solid #4b6482;
            border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
        }
        .finding-deep-content {
            margin-top: 1.25rem; padding-top: 1rem;
            border-top: 1px solid var(--border-light);
            font-size: 0.85rem; line-height: 1.65; color: var(--text-body);
        }
        .finding-deep-content h2 { font-size: 1rem; font-weight: 700; color: var(--text-primary); margin: 1rem 0 0.5rem; }
        .finding-deep-content h3 { font-size: 0.9rem; font-weight: 600; color: var(--text-primary); margin: 0.75rem 0 0.3rem; }
        .finding-deep-content strong { color: var(--text-primary); }
        /* Walk-away number hero */
        .walkaway-hero {
            text-align: center; padding: 1.5rem 0 1rem;
        }
        .walkaway-number {
            font-size: 2.4rem; font-weight: 800; color: var(--accent);
            font-family: 'JetBrains Mono', monospace;
            letter-spacing: -0.02em;
        }
        .walkaway-context {
            font-size: 0.82rem; color: var(--text-secondary);
            margin-top: 0.4rem; max-width: 480px; margin-left: auto; margin-right: auto;
        }

        /* Ask FlipSide — follow-up questions with tool use */
        .ask-flipside-section {
            margin-top: 1.5rem; padding-top: 1.25rem;
            border-top: 1px solid var(--border-light);
        }
        .ask-flipside-label {
            font-size: 0.78rem; font-weight: 600; color: var(--text-secondary);
            text-transform: uppercase; letter-spacing: 0.06em;
            margin-bottom: 0.6rem;
            font-family: 'JetBrains Mono', monospace;
        }
        .ask-flipside-input-row {
            display: flex; gap: 0.5rem;
        }
        .ask-flipside-input {
            flex: 1; padding: 0.6rem 0.9rem;
            font-size: 0.88rem; font-family: 'DM Sans', sans-serif;
            border: 1px solid var(--border); border-radius: var(--radius-sm);
            background: var(--bg-surface); color: var(--text-primary);
            outline: none; transition: border-color 0.2s;
        }
        .ask-flipside-input:focus {
            border-color: var(--accent);
        }
        .ask-flipside-input::placeholder {
            color: var(--text-muted); font-style: italic;
        }
        .ask-flipside-btn {
            padding: 0.6rem 1rem; font-size: 1rem;
            background: var(--accent); color: white; border: none;
            border-radius: var(--radius-sm); cursor: pointer;
            font-weight: 600; transition: opacity 0.2s;
        }
        .ask-flipside-btn:hover { opacity: 0.85; }
        .ask-flipside-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .ask-flipside-result {
            margin-top: 0.75rem;
        }
        .ask-flipside-result:empty { display: none; }
        .ask-tool-call {
            display: flex; align-items: center; gap: 0.5rem;
            padding: 0.4rem 0.75rem; margin-bottom: 0.35rem;
            background: var(--bg-warm); border-radius: var(--radius-sm);
            font-size: 0.75rem; color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
        }
        .ask-tool-call-icon { font-size: 0.85rem; }
        .ask-answer {
            padding: 1rem 1.25rem;
            background: var(--bg-surface); border: 1px solid var(--border);
            border-radius: var(--radius-md);
            font-size: 0.88rem; line-height: 1.65;
            color: var(--text-primary);
        }
        .ask-answer p { margin: 0.5rem 0; }
        .ask-answer strong { color: var(--text-primary); }

        /* Legacy support: keep old classes for export/tools */
        .inline-verdict-section {
            margin-bottom: 2rem; padding: 1.5rem;
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius); box-shadow: var(--shadow-sm);
        }
        .inline-verdict-section-header {
            display: flex; align-items: flex-start; gap: 0.75rem;
            margin-bottom: 1rem; padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-light);
        }
        .inline-verdict-section-icon {
            width: 28px; height: 28px; flex-shrink: 0;
            color: var(--accent); margin-top: 2px;
        }
        .inline-verdict-section-icon svg { width: 100%; height: 100%; }
        .inline-verdict-section-title {
            font-size: 1.05rem; font-weight: 700; color: var(--text-primary);
            line-height: 1.3;
        }
        .inline-verdict-section-subtitle {
            font-size: 0.78rem; color: var(--text-secondary);
            margin-top: 0.15rem; line-height: 1.4;
        }
        .inline-verdict-section-body {
            font-family: 'DM Sans', sans-serif;
            font-size: 0.88rem; line-height: 1.65; color: var(--text-body);
        }
        .inline-verdict-section.loading {
            opacity: 0.5; min-height: 80px;
        }
        .inline-verdict-section.loading .inline-verdict-section-body {
            display: flex; align-items: center; gap: 0.5rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.72rem; color: var(--text-muted);
            text-transform: uppercase; letter-spacing: 0.06em;
        }

        /* ── Sidebar document icon ── */
        .sidebar-doc-icon {
            display: flex; align-items: center; justify-content: center;
            padding: 0.6rem 0 0.4rem;
        }
        .sidebar-doc-icon svg { color: var(--text-dim); }

        /* ── Clause marker glow ── */
        .doc-clause-marker {
            box-shadow: 0 0 0 3px rgba(196, 75, 40, 0.08);
        }

        /* ── Section label ──────────────────────────── */
        .section-label {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem; font-weight: 500;
            text-transform: uppercase; letter-spacing: 0.15em;
            color: var(--text-muted);
        }
        .editorial-divider {
            border: none; height: 1px;
            background: linear-gradient(90deg, transparent, var(--border), transparent);
            margin: 1.5rem 0;
        }


        /* ── Results area ────────────────────────────── */
        .results-area { margin-top: 1.5rem; }

        /* Summary card — shown after done */
        .summary-card {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius); padding: 1.5rem; margin-bottom: 1.5rem;
            box-shadow: var(--shadow-md); animation: fadeUp 0.5s ease forwards;
        }
        .summary-top { display: flex; flex-direction: column; gap: 0.75rem; }
        .verdict-tier {
            font-family: 'JetBrains Mono', monospace; font-size: 1.15rem; font-weight: 800;
            letter-spacing: 0.04em; text-transform: uppercase; padding: 0.6rem 1rem;
            border-left: 4px solid var(--border); background: var(--bg-warm);
            line-height: 1.3;
        }
        .verdict-tier[data-tier="sign"]      { border-left-color: var(--green); color: var(--green); }
        .verdict-tier[data-tier="read"]      { border-left-color: #b8960c; color: #8a7200; }
        .verdict-tier[data-tier="negotiate"] { border-left-color: var(--yellow); color: #9a6c00; }
        .verdict-tier[data-tier="legal"]     { border-left-color: var(--red); color: var(--red); }
        .verdict-tier[data-tier="dontsign"]  { border-left-color: #7a1a1a; color: #7a1a1a; background: #fdf0f0; }
        .clause-strip { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 0.5rem; }
        .clause-dot {
            width: 10px; height: 10px; border-radius: 50%; border: none; padding: 0;
            cursor: pointer; transition: transform 0.15s ease, box-shadow 0.15s ease;
            flex-shrink: 0;
        }
        .clause-dot:hover { transform: scale(1.5); box-shadow: 0 0 0 2px rgba(0,0,0,0.15); }
        .clause-dot.dot-red    { background: var(--red); }
        .clause-dot.dot-yellow { background: var(--yellow); }
        .clause-dot.dot-green  { background: var(--green); }
        .clause-strip-counts {
            font-size: 0.72rem; color: var(--text-secondary); margin-top: 0.25rem;
            font-family: 'JetBrains Mono', monospace;
        }
        .summary-meta { flex: 1; min-width: 0; }
        .summary-concerns {
            list-style: none; margin-top: 0.8rem; padding: 0;
            font-size: 0.82rem; color: var(--text-body);
        }
        .summary-concerns li {
            padding: 0.3rem 0; border-bottom: 1px solid var(--border-light);
        }
        .summary-concerns li:last-child { border-bottom: none; }

        /* ── Filter chips (removed) ──────────────────── */
        .filter-chips { display: none; }

        /* ── Clause cards ────────────────────────────── */
        .clause-card, .cross-clause-card, .playbook-card, .assessment-card {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius); padding: 1.25rem 1.5rem;
            margin-bottom: 1rem; box-shadow: var(--shadow-sm);
            position: relative; opacity: 1;
        }
        .clause-card.new-card, .cross-clause-card.new-card,
        .playbook-card.new-card, .assessment-card.new-card,
        .flip-card.new-card {
            animation: clauseDropIn 0.4s var(--ease-out-expo) forwards; opacity: 0;
        }
        .clause-card h3, .cross-clause-card h3, .playbook-card h3 {
            font-size: 0.95rem; font-weight: 700; margin-bottom: 0.6rem;
            color: var(--text-primary); line-height: 1.3;
        }
        .clause-card p, .cross-clause-card p, .playbook-card p, .assessment-card p {
            font-size: 0.88rem; color: var(--text-body); margin-bottom: 0.5rem;
        }
        .clause-card blockquote {
            border-left: 3px solid var(--accent); padding: 0.5rem 1rem;
            margin: 0.6rem 0; background: var(--accent-light);
            font-style: italic; font-size: 0.85rem; color: var(--text-body);
            border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
        }
        .clause-card hr { border: none; border-top: 1px solid var(--border-light); margin: 1rem 0; }

        /* Risk badges — primary definitions in card-back section */
        .risk-green { background: var(--green-bg); color: var(--green-text); border: 1px solid var(--green-border); }
        .risk-yellow { background: var(--yellow-bg); color: var(--yellow-text); border: 1px solid var(--yellow-border); }
        .risk-red { background: var(--red-bg); color: var(--red-text); border: 1px solid var(--red-border); }

        /* "What the small print says" / "What you should read" juxtaposition */
        .clause-split-header {
            display: flex; gap: 1rem; margin-top: 0.8rem;
        }
        .clause-split-label {
            flex: 1; font-family: 'JetBrains Mono', monospace;
            font-size: 0.62rem; font-weight: 500; text-transform: uppercase;
            letter-spacing: 0.12em; padding-bottom: 0.3rem;
        }
        .clause-split-label-left { color: var(--text-muted); }
        .clause-split-label-right { color: var(--accent); }
        .clause-split {
            display: flex; gap: 1rem; margin-bottom: 0.8rem;
        }
        .clause-split > div {
            flex: 1; padding: 0.8rem; border-radius: var(--radius-sm);
            font-size: 0.85rem; line-height: 1.6;
        }
        .clause-split-left {
            background: var(--bg-surface); color: var(--text-body);
            border: 1px solid var(--border-light);
        }
        .clause-split-right {
            background: var(--accent-light); color: var(--text-primary);
            border: 1px solid var(--accent-medium);
            font-weight: 500;
        }
        @media (max-width: 600px) {
            .clause-split-header, .clause-split { flex-direction: column; gap: 0.25rem; }
        }

        /* Cross-clause cards */
        .cross-clause-card { border-left: 3px solid var(--accent); }
        .assessment-card {
            border-left: 3px solid var(--red);
            background: linear-gradient(135deg, var(--bg-card), rgba(196, 75, 40, 0.03));
        }
        .assessment-card h3 {
            font-size: 1rem;
        }

        /* ── Message the Company ────────────────────── */
        .message-company-section {
            margin: 1.2rem 0;
        }
        .message-company-btn {
            width: 100%; padding: 0.85rem 1.2rem;
            background: var(--bg-card); border: 1.5px solid var(--accent);
            border-radius: var(--radius); color: var(--accent);
            font-family: var(--font-mono); font-size: 0.78rem;
            letter-spacing: 0.04em; text-transform: uppercase;
            cursor: pointer; transition: all 0.2s ease;
            display: flex; align-items: center; justify-content: center; gap: 0.5rem;
        }
        .message-company-btn:hover {
            background: var(--accent); color: white;
        }
        .message-company-btn.generating {
            background: var(--bg-warm); border-color: var(--border);
            color: var(--text-secondary); cursor: wait;
        }
        .message-company-icon { font-size: 1rem; }
        .message-company-output {
            margin-top: 1rem; padding: 1.2rem 1.5rem;
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius); font-size: 0.88rem;
            line-height: 1.65; color: var(--text-primary);
            box-shadow: var(--shadow-sm);
        }
        .message-company-output p { margin: 0.6rem 0; }
        .message-actions {
            display: flex; gap: 0.6rem; margin-top: 1rem;
            padding-top: 0.8rem; border-top: 1px solid var(--border);
        }
        .message-action-btn {
            flex: 1; padding: 0.55rem 0.8rem;
            background: var(--bg-warm); border: 1px solid var(--border);
            border-radius: var(--radius-sm); color: var(--text-primary);
            font-family: var(--font-mono); font-size: 0.72rem;
            letter-spacing: 0.03em; text-transform: uppercase;
            cursor: pointer; transition: all 0.15s ease;
        }
        .message-action-btn:hover {
            background: var(--accent); color: white; border-color: var(--accent);
        }

        /* ── Flip cards (3D) ─────────────────────────── */
        @keyframes cardWoosh {
            0% { transform: translateY(80px) scale(0.96); opacity: 0; filter: blur(6px); }
            55% { transform: translateY(-6px) scale(1.005); opacity: 1; filter: blur(0); }
            75% { transform: translateY(2px) scale(0.999); }
            100% { transform: translateY(0) scale(1); }
        }
        .flip-card {
            perspective: 1200px;
            margin-bottom: 1.5rem;
        }
        /* Use visibility instead of display:none for 3D cards — prevents WebKit compositing layer loss */
        .flip-card.hidden {
            display: block !important;
            visibility: hidden;
            height: 0 !important;
            margin: 0 !important;
            padding: 0 !important;
            overflow: hidden;
        }
        .flip-card.woosh-in {
            animation: cardWoosh 0.65s cubic-bezier(0.22, 1, 0.36, 1) both;
        }
        .flip-card-inner {
            display: grid; /* grid overlap: both sides in same cell → height = max(front,back) */
            transition: transform 0.7s var(--ease-out-expo);
            transform-style: preserve-3d;
        }
        .flip-card.flipped .flip-card-inner {
            transform: rotateY(180deg);
        }
        .flip-card-front, .flip-card-back {
            grid-row: 1; grid-column: 1; /* same cell = overlapping, both contribute to height */
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            border-radius: var(--radius);
        }
        .flip-card-front {
            display: flex; flex-direction: column; /* vertical centering when back is taller */
            background: var(--bg-card);
            border: 1px solid var(--border);
            box-shadow: var(--shadow-md);
            transition: opacity 0.25s ease-out;
        }
        .flip-card.flipped .flip-card-front {
            opacity: 0;
        }
        .flip-card-back {
            transform: rotateY(180deg);
            background: var(--bg-card);
            border: 1px solid var(--border);
            box-shadow: var(--shadow-md);
        }

        /* Front content — flex:1 fills the grid-matched height; centers reader voice */
        .front-content { padding: 2rem 2rem 1.25rem; flex: 1; display: flex; flex-direction: column; justify-content: center; }
        .flip-trigger { margin-top: auto; } /* pin "Flip it" button to bottom edge */
        .clause-reassurance {
            font-size: 1.3rem; font-weight: 700; color: var(--green-text);
            line-height: 1.25; margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-light);
        }
        .clause-section-ref {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem; font-weight: 500; color: var(--text-dim);
            text-transform: uppercase; letter-spacing: 0.15em; margin-bottom: 0.35rem;
        }
        .front-quote-pill {
            display: flex; align-items: center; gap: 8px;
            padding: 7px 12px; margin-bottom: 0.9rem;
            border-radius: var(--radius-sm);
            background: var(--bg-surface); border: 1px solid var(--border-light);
            font-size: 0.75rem; line-height: 1.45; color: var(--text-secondary);
            font-style: italic; overflow: hidden;
        }
        .front-quote-pill.whoosh-pending {
            opacity: 0; transform: scale(0.95);
            transition: opacity 0.35s ease-out, transform 0.35s ease-out;
        }
        .front-quote-pill.revealed {
            opacity: 1; transform: scale(1);
        }
        .front-quote-pill .pill-num {
            display: inline-flex; align-items: center; justify-content: center;
            width: 20px; height: 20px; min-width: 20px; border-radius: 50%;
            font-family: 'JetBrains Mono', monospace; font-size: 0.6rem; font-weight: 700;
            color: #fff; flex-shrink: 0;
        }
        .front-quote-pill .pill-num-green { background: var(--green); }
        .front-quote-pill .pill-num-yellow { background: var(--yellow); color: #1a1a1a; }
        .front-quote-pill .pill-num-red { background: var(--accent); }
        .flip-card .clause-title {
            font-size: 1.15rem; font-weight: 700; color: var(--text-primary);
            line-height: 1.3; margin-bottom: 1rem;
        }
        .flip-card .clause-quote {
            position: relative; padding: 0.9rem 1.1rem; margin-bottom: 1.25rem;
            background: var(--bg-surface); border-radius: var(--radius-sm);
            border-left: 3px solid var(--border); font-size: 0.84rem;
            line-height: 1.65; color: var(--text-secondary); font-style: italic;
        }
        .back-quote-label {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.58rem; font-weight: 600;
            text-transform: uppercase; letter-spacing: 0.12em;
            color: var(--text-dim); margin-bottom: 0.3rem;
        }
        .find-in-doc {
            display: inline-block;
            font-size: 0.72rem; font-weight: 500;
            color: var(--text-dim); cursor: pointer;
            margin-bottom: 1rem; padding: 0.2rem 0;
            transition: color var(--transition);
            text-decoration: underline;
            text-decoration-color: rgba(0,0,0,0.15);
            text-underline-offset: 2px;
        }
        .find-in-doc:hover { color: var(--accent); }
        .reader-voice {
            padding: 1rem 1.1rem; border-radius: var(--radius-sm);
            background: linear-gradient(135deg, rgba(45, 138, 78, 0.04), rgba(45, 138, 78, 0.08));
            border-left: 3px solid var(--green);
        }
        .reader-voice-label {
            display: block; font-family: 'DM Sans', sans-serif;
            font-size: 0.88rem; font-weight: 700;
            text-transform: uppercase; letter-spacing: 0.04em;
            color: var(--green-text); margin-bottom: 0.5rem;
        }
        .reader-voice-text {
            font-size: 0.95rem; line-height: 1.6; color: var(--text-body);
        }
        /* ── Investigation loading screen ── */
        .skeleton-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1.5rem 0 1rem;
            transition: none;
        }
        /* Woosh: investigation doc flies into sidebar */
        .investigation-doc.woosh-to-sidebar {
            animation: wooshDocToSidebar 0.7s var(--ease-out-expo) forwards;
            pointer-events: none;
        }
        @keyframes wooshDocToSidebar {
            0% {
                transform: scale(1) translateX(0);
                opacity: 1;
                border-radius: var(--radius);
            }
            100% {
                transform: scale(0.3) translateX(-140%);
                opacity: 0;
                border-radius: 12px;
            }
        }
        /* Phases + status + briefing fade out during woosh */
        .skeleton-card.wooshing .skeleton-status,
        .skeleton-card.wooshing .investigation-phases,
        .skeleton-card.wooshing .expert-briefing {
            animation: fadeOutQuick 0.3s ease-out forwards;
        }
        @keyframes fadeOutQuick {
            to { opacity: 0; transform: translateY(8px); }
        }

        /* Document being scanned — real text with loupe */
        .investigation-doc {
            position: relative;
            width: 100%;
            height: 280px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow-md);
            overflow: hidden;
        }

        /* Real document text — auto-scrolls to simulate reading */
        .investigation-text {
            padding: 1.2rem 1.5rem;
            font-family: 'DM Sans', sans-serif;
            font-size: 0.68rem;
            line-height: 1.65;
            color: var(--text-muted);
            white-space: pre-wrap;
            word-break: break-word;
        }

        /* Top/bottom fade masks */
        .investigation-doc::before,
        .investigation-doc::after {
            content: '';
            position: absolute;
            left: 0; right: 0;
            height: 2.5rem;
            z-index: 1;
            pointer-events: none;
        }
        .investigation-doc::before {
            top: 0;
            background: linear-gradient(to bottom, var(--bg-card), transparent);
        }
        .investigation-doc::after {
            bottom: 0;
            background: linear-gradient(to top, var(--bg-card), transparent);
        }

        /* The scanning loupe — stays fixed while text scrolls beneath */
        @keyframes loupe-breathe {
            0%, 100% { transform: translateX(-50%) scale(1); }
            50%      { transform: translateX(-50%) scale(1.08); }
        }
        .investigation-loupe {
            position: absolute;
            top: 32%;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2;
            pointer-events: none;
            filter: drop-shadow(0 4px 16px rgba(196,75,40,0.15));
            animation: loupe-breathe 3s ease-in-out infinite;
        }

        /* Status below the document */
        .skeleton-status {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            margin-top: 1.25rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.72rem;
            font-weight: 600;
            letter-spacing: 0.06em;
            color: var(--text-secondary);
        }

        /* Three investigation phases */
        .investigation-phases {
            display: none; /* removed — Opus thinking process replaces this */
            flex-direction: column;
            width: 100%;
            margin-top: 1rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
        }

        .investigation-phase {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.55rem 1rem;
            border-bottom: 1px solid var(--border-light);
            opacity: 0.35;
            transition: opacity 0.4s ease, background 0.4s ease;
        }
        .investigation-phase:last-child { border-bottom: none; }
        .investigation-phase.active {
            opacity: 1;
            background: rgba(196, 75, 40, 0.04);
        }
        .investigation-phase.done {
            opacity: 0.7;
            background: transparent;
        }

        .phase-icon {
            width: 22px;
            height: 22px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-dim);
            transition: color 0.3s ease;
        }
        .investigation-phase.active .phase-icon { color: var(--accent); }
        .investigation-phase.done .phase-icon { color: var(--green-text); }

        .phase-info { flex: 1; min-width: 0; }
        .phase-title {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.62rem;
            font-weight: 600;
            color: var(--text-heading);
            letter-spacing: 0.03em;
        }
        .phase-status {
            font-family: 'DM Sans', sans-serif;
            font-size: 0.58rem;
            color: var(--text-muted);
            margin-top: 0.1rem;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            transition: color 0.3s ease;
        }
        .investigation-phase.active .phase-status { color: var(--accent); }
        .investigation-phase.done .phase-status { color: var(--green-text); }

        /* ── Expert Briefing: narrated AI progress ── */
        .expert-briefing {
            width: 100%;
            margin-top: 1rem;
            opacity: 0;
            transform: translateY(8px);
            transition: opacity 0.5s ease, transform 0.5s var(--ease-out-expo);
        }
        .expert-briefing.visible {
            opacity: 1;
            transform: translateY(0);
        }
        /* Narration: one sentence at a time */
        .briefing-narration {
            min-height: 3.2rem;
            display: flex;
            align-items: center;
            padding: 0.8rem 1rem;
            border: 1px solid var(--border);
            border-left: 3px solid var(--accent);
            border-radius: var(--radius);
            background: var(--bg-card);
            box-shadow: var(--shadow-sm);
            position: relative;
            overflow: hidden;
        }
        .briefing-sentence {
            font-family: 'DM Sans', sans-serif;
            font-size: 0.82rem;
            line-height: 1.55;
            color: var(--text-body);
            opacity: 0;
            transform: translateY(6px);
            transition: opacity 0.4s ease, transform 0.4s var(--ease-out-expo);
        }
        .briefing-sentence.visible {
            opacity: 1;
            transform: translateY(0);
        }
        .briefing-sentence.fading {
            opacity: 0.3;
            transform: translateY(-4px);
        }
        /* Two-track indicators */
        .briefing-tracks {
            display: flex;
            gap: 1rem;
            margin-top: 0.75rem;
        }
        .briefing-track {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 0.6rem;
            padding: 0.55rem 0.75rem;
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            background: var(--bg-surface);
        }
        .track-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .track-indicator.readers {
            background: var(--accent);
            animation: trackPulse 1.5s ease infinite;
        }
        .track-indicator.readers.done {
            background: var(--green);
            animation: none;
        }
        .track-indicator.expert {
            background: var(--accent);
            animation: trackPulse 0.9s ease infinite;
        }
        .track-indicator.expert.done {
            background: var(--green);
            animation: none;
        }
        @keyframes trackPulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.35; transform: scale(0.85); }
        }
        .track-info {
            flex: 1;
            min-width: 0;
        }
        .track-label {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.55rem;
            font-weight: 600;
            color: var(--text-heading);
            letter-spacing: 0.04em;
        }
        .track-detail {
            font-family: 'DM Sans', sans-serif;
            font-size: 0.6rem;
            color: var(--text-muted);
            margin-top: 0.1rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .track-detail .accent { color: var(--accent); font-weight: 500; }
        /* Depth counter */
        .briefing-depth {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.52rem;
            color: var(--text-dim);
            letter-spacing: 0.04em;
        }
        .briefing-depth .depth-count {
            color: var(--accent);
            font-weight: 600;
        }
        /* Document context card — under title */
        .doc-context {
            margin: 0 0 1.2rem;
            padding: 0.65rem 0.9rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            background: var(--bg-card);
            box-shadow: var(--shadow-sm);
            opacity: 0;
            transform: translateY(8px);
            transition: opacity 0.5s ease, transform 0.5s var(--ease-out-expo);
        }
        .doc-context.visible {
            opacity: 1;
            transform: translateY(0);
        }
        .doc-context-label {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.48rem;
            font-weight: 600;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: var(--text-dim);
            margin-bottom: 0.4rem;
        }
        .doc-context-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.25rem 1.2rem;
        }
        .doc-context-item {
            display: flex;
            align-items: baseline;
            gap: 0.35rem;
        }
        .doc-context-key {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.52rem;
            font-weight: 600;
            color: var(--text-muted);
            letter-spacing: 0.03em;
            white-space: nowrap;
            flex-shrink: 0;
        }
        .doc-context-val {
            font-family: 'DM Sans', sans-serif;
            font-size: 0.72rem;
            color: var(--text-body);
            line-height: 1.4;
        }
        .doc-context-flag {
            font-size: 1rem;
            line-height: 1;
        }
        /* Compress investigation phases when briefing is showing */
        .skeleton-card .investigation-phases.compressed {
            margin-top: 0.5rem;
            opacity: 0;
            max-height: 0;
            overflow: hidden;
            transition: opacity 0.3s ease, max-height 0.3s ease, margin 0.3s ease;
        }

        /* Verdict teaser strip — live Opus findings as they arrive */
        .verdict-teaser {
            display: none;
            width: 100%;
            margin-top: 0.75rem;
            border: 1px solid var(--border);
            border-left: 3px solid var(--accent);
            border-radius: var(--radius);
            background: var(--bg-card);
            overflow: hidden;
        }
        .verdict-teaser.visible { display: block; }
        .verdict-teaser-header {
            padding: 0.55rem 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.55rem;
            font-weight: 700;
            letter-spacing: 0.06em;
            text-transform: uppercase;
            color: var(--accent);
            border-bottom: 1px solid var(--border-light);
        }
        .verdict-teaser-body {
            padding: 0.5rem 0.85rem;
        }
        .verdict-teaser-item {
            padding: 0.35rem 0;
            font-size: 0.75rem;
            line-height: 1.5;
            color: var(--text-body);
            border-bottom: 1px solid var(--border-light);
            display: flex;
            align-items: baseline;
            gap: 0.5rem;
        }
        .verdict-teaser-item:last-child { border-bottom: none; }
        .verdict-teaser-item .teaser-label {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.5rem;
            font-weight: 700;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            color: var(--text-dim);
            white-space: nowrap;
            flex-shrink: 0;
        }
        .verdict-teaser-item .teaser-text {
            font-style: italic;
            color: var(--text-secondary);
        }
        .verdict-teaser-item.locked .teaser-text {
            color: var(--text-dim);
        }

        .skeleton-waiting {
            display: flex; align-items: center; justify-content: center; gap: 0.6rem;
            padding: 0.9rem 2rem;
            font-family: 'JetBrains Mono', monospace; font-size: 0.75rem;
            font-weight: 500; color: var(--text-muted);
            letter-spacing: 0.02em;
        }
        .ocr-banner {
            margin: 0.5rem 1.5rem;
            padding: 0.5rem 1rem;
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 6px;
            font-size: 0.72rem;
            color: #664d03;
            text-align: center;
            font-weight: 500;
        }

        /* ── Cards ready pill (auto-reveal → cards arrived notification) ── */
        .cards-ready-pill {
            position: sticky;
            top: 80px;
            z-index: 50;
            display: flex;
            align-items: center;
            gap: 0.4rem;
            margin: 0.75rem auto;
            padding: 0.5rem 1.2rem;
            width: fit-content;
            background: var(--accent);
            color: #fff;
            border-radius: 100px;
            font-size: 0.82rem;
            font-weight: 600;
            font-family: 'DM Sans', sans-serif;
            cursor: pointer;
            box-shadow: 0 2px 12px rgba(196,75,40,0.25);
            animation: pill-pop-in 0.4s cubic-bezier(0.34,1.56,0.64,1) both;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
        }
        .cards-ready-pill:hover {
            transform: scale(1.04);
            box-shadow: 0 4px 16px rgba(196,75,40,0.35);
        }
        .cards-ready-pill.hidden { display: none; }
        .cards-ready-icon { font-size: 1rem; }
        .cards-ready-arrow { font-size: 0.9rem; opacity: 0.8; }
        @keyframes pill-pop-in {
            0% { transform: scale(0.8) translateY(8px); opacity: 0; }
            100% { transform: scale(1) translateY(0); opacity: 1; }
        }

        /* ── Rejection screen (document not applicable) ── */
        .rejection-screen {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; max-width: 520px; margin: 3rem auto 2rem;
            padding: 0 1.5rem;
        }
        .rejection-icon {
            width: 64px; height: 64px; margin-bottom: 1.5rem;
            color: var(--text-muted); opacity: 0.5;
        }
        .rejection-headline {
            font-family: 'DM Sans', sans-serif;
            font-size: 1.75rem; font-weight: 700; line-height: 1.2;
            letter-spacing: -0.03em; color: var(--text-primary);
            margin-bottom: 0.75rem;
        }
        .rejection-uploaded {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.68rem; font-weight: 500;
            color: var(--text-muted); letter-spacing: 0.04em;
            text-transform: uppercase; margin-bottom: 1.25rem;
        }
        .rejection-explanation {
            font-size: 0.92rem; line-height: 1.65; color: var(--text-body);
            margin-bottom: 1.5rem;
        }
        .rejection-scope {
            background: var(--bg-warm); border: 1px solid var(--border);
            border-radius: 10px; padding: 1rem 1.25rem;
            font-size: 0.82rem; line-height: 1.6; color: var(--text-muted);
            margin-bottom: 2rem;
        }
        .rejection-scope strong { color: var(--text-body); font-weight: 600; }
        .rejection-back-btn {
            font-family: 'DM Sans', sans-serif;
            font-size: 0.85rem; font-weight: 600;
            color: var(--bg-cream); background: var(--text-primary);
            border: none; border-radius: 100px;
            padding: 0.65rem 1.8rem; cursor: pointer;
            transition: opacity 0.2s ease, transform 0.15s ease;
        }
        .rejection-back-btn:hover { opacity: 0.85; transform: translateY(-1px); }


        /* Flip trigger — quiet invitation */
        @keyframes flipHint {
            0%, 100% { transform: translateY(0); }
            20% { transform: translateY(-4px); }
            40% { transform: translateY(0); }
            60% { transform: translateY(-2px); }
            80% { transform: translateY(0); }
        }
        .flip-trigger {
            display: flex; align-items: center; justify-content: center; gap: 0.5rem;
            width: 100%; margin: 0; padding: 0.9rem 2rem;
            background: none; border: none; border-top: 1px solid var(--border-light);
            cursor: pointer; font-family: 'JetBrains Mono', monospace; font-size: 0.8rem;
            font-weight: 600; color: var(--accent); letter-spacing: 0.04em;
            transition: color 0.25s var(--ease-out-expo), background 0.25s var(--ease-out-expo);
        }
        .flip-trigger:hover {
            color: var(--accent-hover);
            background: var(--accent-light);
        }
        .flip-trigger-cta {
            font-weight: 800; text-transform: uppercase; letter-spacing: 0.06em;
        }
        .flip-trigger.hint-pulse {
            animation: flipHint 1.8s ease-in-out infinite;
            background: rgba(196, 75, 40, 0.06);
            border-top-color: var(--accent);
            position: relative;
        }
        .flip-hint-tooltip {
            display: inline-block; margin-left: 0.5rem;
            background: var(--text-primary); color: var(--bg-main);
            font-family: 'DM Sans', sans-serif; font-size: 0.72rem;
            font-weight: 600; padding: 0.35rem 0.75rem;
            border-radius: 100px; pointer-events: none;
            opacity: 0; animation: tooltipFadeIn 0.4s ease 1.5s forwards;
        }
        @keyframes tooltipFadeIn {
            to { opacity: 1; }
        }
        .flip-trigger-arrow {
            display: inline-block; font-size: 0.85rem;
            transition: transform 0.4s var(--ease-out-expo);
        }
        .flip-trigger:hover .flip-trigger-arrow {
            transform: translateX(4px);
        }
        .flip-trigger-spin {
            display: inline-block; font-size: 1.1rem; margin-left: 0.3rem;
            animation: spinHint 2.5s ease-in-out infinite;
            vertical-align: -1px;
        }
        .flipped .flip-trigger-spin { animation: none; }
        @keyframes spinHint {
            0%, 70%, 100% { transform: rotate(0deg); }
            80% { transform: rotate(360deg); }
        }

        /* Card watermark — giant clause number */
        .card-watermark {
            position: absolute; top: -0.15rem; right: 1.2rem;
            font-family: 'DM Sans', sans-serif; font-size: 7rem; font-weight: 800;
            line-height: 1; color: var(--text-primary); opacity: 0.04;
            pointer-events: none; z-index: 0; user-select: none;
        }
        .flip-card-front { position: relative; overflow: hidden; }

        /* Card teaser — now the opening line on the back */
        .back-teaser {
            font-family: 'DM Sans', sans-serif; font-size: 0.95rem;
            font-weight: 600; line-height: 1.5;
            color: var(--text-primary);
            margin-bottom: 1rem;
        }

        /* Chapter title — editorial voice below cards (anchors the card) */
        .chapter-title { display: none; }
        .chapter-title-text {
            font-family: 'DM Sans', sans-serif; font-size: 1.15rem;
            font-weight: 500; font-style: italic;
            color: var(--text-secondary); line-height: 1.3;
        }
        .chapter-title-counter {
            display: none; font-family: 'JetBrains Mono', monospace;
            font-size: 0.62rem; font-weight: 600; font-style: normal;
            text-transform: uppercase; letter-spacing: 0.18em;
            color: var(--text-dim); margin-bottom: 0.3rem;
        }

        /* Back content */
        .back-content { padding: 0; }

        /* Utility row: "The lure" + "Find in document" on one line */
        .back-utility-row {
            display: flex; align-items: center; gap: 1.2rem;
            margin-top: 0.3rem; padding-top: 0.3rem;
            border-top: 1px solid var(--border-light);
        }
        .back-honey-toggle {
            display: inline-flex; align-items: center; gap: 0.35rem;
            cursor: pointer; padding: 0.2rem 0;
        }
        .back-honey-label {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.62rem; font-weight: 600;
            text-transform: uppercase; letter-spacing: 0.04em;
            color: var(--text-muted);
        }
        .back-honey-toggle:hover .back-honey-label { color: var(--text-secondary); }
        .back-honey-chevron {
            font-size: 0.5rem; color: var(--text-muted);
            transition: transform 0.25s ease;
        }
        .back-honey-toggle.expanded .back-honey-chevron {
            transform: rotate(90deg);
        }
        .back-honey-body {
            display: none; margin: 0.2rem 0 0;
            padding: 0.35rem 0.6rem;
            background: rgba(196,75,40,0.06);
            border-left: 2px solid var(--accent);
            font-size: 0.72rem; line-height: 1.45;
            color: var(--text-secondary);
            border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
        }
        .back-honey-body.visible {
            display: block;
        }
        .risk-header {
            padding: 1.25rem 2rem; display: flex; align-items: center;
            justify-content: space-between; gap: 0.75rem; flex-wrap: wrap;
        }
        .risk-header-red {
            background: linear-gradient(135deg, rgba(196,75,40,0.08), rgba(196,75,40,0.14));
            border-bottom: 2px solid var(--red);
        }
        .risk-header-yellow {
            background: linear-gradient(135deg, rgba(184,134,11,0.06), rgba(184,134,11,0.12));
            border-bottom: 2px solid var(--yellow);
        }
        .risk-header-green {
            background: linear-gradient(135deg, rgba(45,138,78,0.06), rgba(45,138,78,0.10));
            border-bottom: 2px solid var(--green);
        }
        .risk-header .clause-title { margin-bottom: 0; font-size: 1.05rem; }
        .risk-header-label {
            display: block; width: 100%;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.58rem; font-weight: 600;
            text-transform: uppercase; letter-spacing: 0.12em;
            margin-bottom: 0.25rem; opacity: 0.6;
        }
        .risk-badge-group {
            display: flex; align-items: center; gap: 0.5rem; flex-shrink: 0;
        }
        .risk-badge {
            display: inline-flex; align-items: center; gap: 0.3rem;
            padding: 0.2rem 0.6rem; border-radius: 4px;
            font-size: 0.72rem; font-weight: 700; letter-spacing: 0.04em;
        }
        .risk-badge-red { background: var(--red-bg); color: var(--red-text); border: 1px solid var(--red-border); }
        .risk-badge-yellow { background: var(--yellow-bg); color: var(--yellow-text); border: 1px solid var(--yellow-border); }
        .risk-badge-green { background: var(--green-bg); color: var(--green-text); border: 1px solid var(--green-border); }
        .risk-score-val { font-size: 0.82rem; font-weight: 700; font-variant-numeric: tabular-nums; }
        .risk-score-red { color: var(--red-text); }
        .risk-score-yellow { color: var(--yellow-text); }
        .risk-score-green { color: var(--green-text); }
        .trick-label {
            padding: 0.15rem 0.5rem; background: var(--bg-warm);
            border: 1px solid var(--border); border-radius: var(--radius-sm);
            font-size: 0.7rem; font-weight: 500; color: var(--text-secondary);
        }
        .confidence-badge {
            display: inline-flex; align-items: center; gap: 0.25rem;
            padding: 0.15rem 0.5rem; border-radius: var(--radius-sm);
            font-size: 0.62rem; font-weight: 600; letter-spacing: 0.03em;
            text-transform: uppercase; cursor: default;
        }
        .confidence-high { background: var(--green-bg); color: var(--green-text); border: 1px solid var(--green-border); }
        .confidence-medium { background: var(--yellow-bg); color: var(--yellow-text); border: 1px solid var(--yellow-border); }
        .confidence-low { background: var(--red-bg); color: var(--red-text); border: 1px solid var(--red-border); font-style: italic; }
        .confidence-reason {
            font-weight: 400; font-style: italic; font-size: 0.58rem;
            text-transform: none; letter-spacing: 0; max-width: 0;
            overflow: hidden; white-space: nowrap;
            transition: max-width 0.3s var(--ease-out-expo), padding-left 0.3s ease;
        }
        .confidence-badge:hover .confidence-reason,
        .confidence-badge.touch-open .confidence-reason { max-width: 220px; padding-left: 0.3rem; }

        .back-body { padding: 1.25rem 1.75rem 0.5rem; }
        .back-footer {
            display: flex; align-items: center;
            border-top: 1px solid var(--border-light);
            position: relative;
        }
        .back-footer .flip-back-trigger { border-top: none; flex: 1; }
        .trick-footnote {
            position: absolute; right: 1.5rem; top: 50%; transform: translateY(-50%);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.58rem; letter-spacing: 0.06em; text-transform: uppercase;
            color: var(--text-muted); opacity: 0.55;
            pointer-events: none;
        }

        /* Drafter's voice — risk-colored */
        .drafter-voice {
            padding: 1rem 1.1rem; border-radius: var(--radius-sm); margin-bottom: 1.25rem;
            background: var(--bg-warm);
            border-left: 3px solid var(--text-muted);
            font-style: italic;
            color: var(--text-body);
            font-size: 0.9rem;
            line-height: 1.65;
        }
        .drafter-voice-red {
            background: linear-gradient(135deg, rgba(196,75,40,0.06), rgba(196,75,40,0.10));
            border-left: 3px solid var(--red);
        }
        .drafter-voice-yellow {
            background: linear-gradient(135deg, rgba(184,134,11,0.05), rgba(184,134,11,0.09));
            border-left: 3px solid var(--yellow);
        }
        .drafter-voice-green {
            background: linear-gradient(135deg, rgba(45,138,78,0.04), rgba(45,138,78,0.08));
            border-left: 3px solid var(--green);
        }
        .drafter-voice-label {
            display: block; font-family: 'JetBrains Mono', monospace;
            font-size: 0.65rem; font-weight: 500;
            text-transform: uppercase; letter-spacing: 0.12em; margin-bottom: 0.4rem;
            color: var(--ash);
        }
        .drafter-voice-label-red { color: var(--red-text); }
        .drafter-voice-label-yellow { color: var(--yellow-text); }
        .drafter-voice-label-green { color: var(--green-text); }
        .drafter-voice-text {
            font-size: 0.9rem; line-height: 1.65; color: var(--text-body); font-style: italic;
        }

        /* ── Your Move action block ── */
        .your-move {
            padding: 0.8rem 1.1rem; border-radius: var(--radius-sm); margin-bottom: 1.25rem;
            background: linear-gradient(135deg, rgba(45, 138, 78, 0.05), rgba(45, 138, 78, 0.10));
            border-left: 3px solid var(--green);
            font-size: 0.88rem; line-height: 1.6; color: var(--text-primary);
            font-weight: 500;
        }
        .your-move-label {
            display: block; font-family: 'JetBrains Mono', monospace;
            font-size: 0.65rem; font-weight: 700;
            text-transform: uppercase; letter-spacing: 0.12em;
            color: var(--green-text); margin-bottom: 0.3rem;
        }

        /* Green verdict — no hidden intent */
        .green-verdict {
            padding: 1.25rem 1.1rem; border-radius: var(--radius-sm);
            background: linear-gradient(135deg, rgba(45,138,78,0.06), rgba(45,138,78,0.10));
            border: 1px solid var(--green-border); margin-bottom: 1.25rem; text-align: center;
        }
        .green-verdict-title {
            font-size: 0.88rem; font-weight: 700; color: var(--green-text); margin-bottom: 0.25rem;
        }
        .green-verdict-text {
            font-size: 0.84rem; color: var(--text-secondary); line-height: 1.5;
        }

        /* Flip-back trigger */
        .flip-back-trigger {
            display: flex; align-items: center; justify-content: center; gap: 0.5rem;
            width: 100%; padding: 0.9rem 1rem; background: none; border: none;
            border-top: 1px solid var(--border-light); cursor: pointer;
            font-family: inherit; font-size: 0.8rem; font-weight: 600;
            color: var(--text-muted); transition: all var(--transition);
            position: relative; white-space: nowrap;
        }
        .flip-back-trigger::before {
            content: ''; position: absolute; inset: 0;
            background: var(--bg-surface); opacity: 0; transition: opacity var(--transition);
        }
        .flip-back-trigger:hover::before { opacity: 1; }
        .flip-back-trigger:hover { color: var(--text-secondary); }
        .flip-back-arrow {
            display: inline-block; font-size: 0.9rem;
            transition: transform 0.4s var(--ease-out-expo);
        }
        .flip-back-trigger:hover .flip-back-arrow { transform: translateX(-4px); }

        /* Bottom Next button (inside card back footer) */
        .card-bottom-next {
            display: flex; align-items: center; justify-content: center; gap: 0.4rem;
            padding: 0.9rem 1.5rem; background: none; border: none;
            border-left: 1px solid var(--border-light);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.68rem; font-weight: 700; letter-spacing: 0.04em;
            text-transform: uppercase; color: var(--accent);
            cursor: pointer; transition: all var(--transition);
            position: relative; overflow: hidden; white-space: nowrap;
        }
        .card-bottom-next::before {
            content: ''; position: absolute; inset: 0;
            background: rgba(196,75,40,0.05); opacity: 0; transition: opacity var(--transition);
        }
        .card-bottom-next:hover::before { opacity: 1; }
        .card-bottom-next:hover { color: var(--text-primary); }
        .card-bottom-next-arrow {
            display: inline-block; font-size: 0.9rem;
            transition: transform 0.4s var(--ease-out-expo);
        }
        .card-bottom-next:hover .card-bottom-next-arrow { transform: translateX(4px); }

        /* ── Back score bar ─────────────────────────── */
        .back-score-bar {
            display: flex; align-items: center; gap: 0.75rem;
            padding: 0 0 1.25rem;
        }
        .back-score-bar-track {
            flex: 1; height: 6px; background: var(--border-light);
            border-radius: 3px; overflow: hidden;
        }
        .back-score-bar-fill {
            height: 100%; border-radius: 3px; width: 0;
            transition: width 0.8s var(--ease-out-expo);
        }
        .back-score-bar-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.72rem; font-weight: 600;
            color: var(--text-secondary); white-space: nowrap;
        }

        /* ── "What does this mean for you" on card back ── */
        .back-meaning-label {
            font-size: 0.7rem; font-weight: 500;
            color: var(--text-dim);
            margin-bottom: 0.5rem;
        }
        .back-figure {
            font-size: 1.4rem; font-weight: 800;
            line-height: 1.3; margin-bottom: 1rem;
            padding: 0.75rem 0 0.5rem;
        }
        .back-figure-red { color: var(--red-text); }
        .back-figure-yellow { color: var(--yellow-text); }
        .back-figure-green { color: var(--green-text); }
        .back-example {
            font-size: 0.84rem; line-height: 1.65;
            color: var(--text-body);
            padding: 0.75rem 1rem;
            background: var(--bg-surface);
            border-radius: var(--radius-sm);
            border-left: 3px solid var(--border);
        }
        .back-example-red { border-left-color: var(--red); background: var(--red-bg); }
        .back-example-yellow { border-left-color: var(--yellow); background: var(--yellow-bg); }
        .back-example-green { border-left-color: var(--green); background: var(--green-bg); }
        .back-example .hl-number {
            font-weight: 700;
        }
        .back-example-red .hl-number { color: var(--red-text); }
        .back-example-yellow .hl-number { color: var(--yellow-text); }
        .back-example-green .hl-number { color: var(--green-text); }
        .back-bottom-line {
            font-size: 0.78rem; font-weight: 600;
            line-height: 1.4;
            color: var(--text-secondary);
            margin-top: 0.75rem;
            font-style: italic;
        }

        /* ── Verdict link (CTA on card back → deep analysis) ── */
        .verdict-link {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            width: 100%;
            padding: 0.65rem 0.85rem;
            margin-top: 0.25rem;
            background: var(--accent-light);
            border: 1px solid var(--accent-medium);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-family: 'DM Sans', sans-serif;
            transition: all 0.2s var(--ease-out-expo);
        }
        .verdict-link:hover {
            background: var(--accent-medium);
            border-color: var(--accent);
        }
        .verdict-link-label {
            font-size: 0.82rem;
            font-weight: 600;
            color: var(--accent);
        }
        .verdict-link-meta {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-muted);
            flex: 1;
        }
        .verdict-link .flip-trigger-arrow {
            color: var(--accent);
            font-size: 0.9rem;
        }
        .verdict-link.verdict-loading {
            border-color: var(--yellow-border);
            background: var(--yellow-bg);
        }
        .verdict-link.verdict-loading .verdict-link-meta {
            color: var(--yellow-text);
        }

        /* ── Back to cards button ── */
        .back-to-cards-btn {
            display: inline-flex; align-items: center; gap: 0.4rem;
            padding: 0.5rem 1rem; margin-bottom: 1rem;
            background: var(--bg-surface); border: 1px solid var(--border);
            border-radius: var(--radius-sm); cursor: pointer;
            font-family: 'DM Sans', sans-serif; font-size: 0.82rem;
            font-weight: 500; color: var(--text-secondary);
            transition: all 0.2s var(--ease-out-expo);
        }
        .back-to-cards-btn:hover {
            background: var(--bg-warm); color: var(--text-primary);
            border-color: var(--border-focus);
        }

        /* ── Opus branding on deep analysis ── */
        .deep-analysis-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem 0;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }
        .deep-analysis-header .section-label {
            flex: 1;
        }
        .opus-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.25rem 0.6rem;
            background: var(--bg-thinking);
            color: #e8e4dc;
            border-radius: var(--radius-sm);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.62rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }
        .opus-badge::before {
            content: '';
            width: 6px; height: 6px;
            border-radius: 50%;
            background: #c44b28;
            animation: opusPulse 2s ease-in-out infinite;
        }
        @keyframes opusPulse {
            0%, 100% { opacity: 0.4; }
            50% { opacity: 1; }
        }

        /* ── How Opus Analyzed This — promoted callout ── */
        .opus-method-callout {
            background: var(--bg-thinking); color: #e8e4dc;
            border-radius: var(--radius-md); padding: 1.2rem 1.5rem;
            margin-bottom: 1.5rem; position: relative;
            border-left: 3px solid var(--accent);
        }
        .opus-method-callout .callout-label {
            font-family: 'JetBrains Mono', monospace; font-size: 0.65rem;
            text-transform: uppercase; letter-spacing: 0.1em;
            color: var(--accent); margin-bottom: 0.6rem; display: flex;
            align-items: center; gap: 0.4rem;
        }
        .opus-method-callout .callout-label::before {
            content: ''; width: 6px; height: 6px; border-radius: 50%;
            background: var(--accent);
        }
        .opus-method-callout p { font-size: 0.82rem; line-height: 1.55; margin: 0.4rem 0; color: #d4d0c8; }
        .opus-method-callout ul, .opus-method-callout ol { font-size: 0.82rem; color: #d4d0c8; padding-left: 1.2rem; }
        .opus-method-callout li { margin: 0.2rem 0; }
        .opus-method-callout strong { color: #f0ece4; }

        /* ── Counter-draft UI ── */
        .counter-draft-section { margin-top: 2.5rem; }
        .counter-draft-btn {
            display: inline-flex; align-items: center; gap: 0.5rem;
            padding: 0.7rem 1.4rem; font-family: 'JetBrains Mono', monospace;
            font-size: 0.78rem; font-weight: 500; letter-spacing: 0.03em;
            color: var(--accent); background: transparent;
            border: 1.5px solid var(--accent); border-radius: var(--radius-md);
            cursor: pointer; transition: all 0.25s ease;
        }
        .counter-draft-btn:hover { background: var(--accent); color: #fff; }
        .counter-draft-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .counter-draft-btn:disabled:hover { background: transparent; color: var(--accent); }
        .counter-draft-content {
            margin-top: 1.5rem; padding: 1.5rem;
            background: var(--bg-surface); border: 1px solid var(--border);
            border-radius: var(--radius-md);
        }

        /* ── Follow-up question UI ── */
        .followup-section { margin-top: 2.5rem; }
        .followup-input-row { display: flex; gap: 0.5rem; align-items: flex-start; }
        .followup-input {
            flex: 1; padding: 0.7rem 1rem;
            font-family: 'DM Sans', sans-serif; font-size: 0.88rem;
            color: var(--text-primary); background: var(--bg-surface);
            border: 1px solid var(--border); border-radius: var(--radius-md);
            outline: none; resize: none; min-height: 44px; max-height: 120px;
            transition: border-color var(--transition);
        }
        .followup-input:focus { border-color: var(--accent); }
        .followup-input::placeholder { color: var(--text-dim); }
        .followup-send {
            padding: 0.7rem 1.2rem; font-family: 'DM Sans', sans-serif;
            font-size: 0.85rem; font-weight: 600; color: white;
            background: var(--text-primary); border: none;
            border-radius: var(--radius-md); cursor: pointer;
            transition: all var(--transition); white-space: nowrap;
        }
        .followup-send:hover:not(:disabled) { background: var(--accent); }
        .followup-send:disabled { opacity: 0.35; cursor: not-allowed; }
        .followup-answer {
            margin-top: 1.5rem; padding: 1.2rem 1.5rem;
            background: var(--bg-surface); border-radius: var(--radius);
            border: 1px solid var(--border-light);
        }
        .followup-q { font-size: 0.82rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 0.75rem; }
        .followup-a { font-size: 0.9rem; color: var(--text-body); line-height: 1.65; }
        .followup-a p { margin-bottom: 0.6rem; }

        /* Reduced motion */
        @media (prefers-reduced-motion: reduce) {
            .flip-card.woosh-in { animation: none; }
            .flip-card-inner { transition: none; }
            .flip-card.flipped .flip-card-back { position: static; transform: none; }
            .flip-card.flipped .flip-card-front { display: none; }
        }

        /* Section headers (H2 in results) */
        .results-area h2 {
            font-size: 1.1rem; font-weight: 700; color: var(--text-primary);
            margin: 2rem 0 1rem; padding-bottom: 0.4rem;
            border-bottom: 2px solid var(--accent);
        }

        /* ── Error display ───────────────────────────── */
        .error-msg {
            background: var(--red-bg); border: 1px solid var(--red-border);
            border-radius: var(--radius); padding: 1.5rem; text-align: center;
            color: var(--red-text); font-weight: 600;
        }
        .retry-btn {
            margin-top: 0.8rem; padding: 0.5rem 1.5rem; background: var(--accent);
            color: white; border: none; border-radius: var(--radius-sm);
            cursor: pointer; font-family: inherit; font-weight: 600;
        }

        /* ══════════════════════════════════════════════════════
           RESPONSIVE
           ══════════════════════════════════════════════════════ */

        /* Tablet: sidebar stacks above content (handled at 900px above) */

        /* ── Mobile: ≤ 900px unified block ──────────────── */
        @media (max-width: 900px) {
            /* Phase 1: 2D slide-up flip (replaces broken 3D rotateY on mobile Safari) */
            .flip-card { perspective: none; }
            .flip-card-inner {
                display: block; /* override grid — mobile uses 2D slide-up, not 3D flip */
                transform-style: flat;
                transition: none;
            }
            .flip-card-front,
            .flip-card-back {
                backface-visibility: visible;
                -webkit-backface-visibility: visible;
                transform: none;
            }
            .flip-card-front {
                display: block; /* override flex column centering — mobile uses natural flow */
                position: relative;
                transition: transform 0.55s cubic-bezier(0.22, 1, 0.36, 1), opacity 0.4s ease;
            }
            .flip-card.flipped .flip-card-front {
                transform: translateY(-30px);
                opacity: 0;
                position: absolute;
                top: 0; left: 0; width: 100%;
                pointer-events: none;
                visibility: hidden;
            }
            .front-content { display: block; } /* override flex centering for mobile */
            .flip-card-back {
                position: relative;
                opacity: 0;
                max-height: 0;
                overflow: hidden;
                transition: max-height 0.5s cubic-bezier(0.22, 1, 0.36, 1), opacity 0.35s ease 0.1s;
            }
            .flip-card.flipped .flip-card-back {
                position: relative;
                opacity: 1;
                max-height: 3000px;
                overflow: visible;
            }
            .flip-card.flipped .flip-card-inner {
                transform: none;
            }
            /* Larger tap target for flip trigger on mobile */
            .flip-trigger {
                min-height: 48px;
                padding: 1rem 1.25rem;
            }
            /* Replace spin hint with upward bounce on mobile */
            .flip-trigger-spin {
                animation: mobileFlipHint 2s ease-in-out infinite;
            }
            @keyframes mobileFlipHint {
                0%, 100% { transform: translateY(0); }
                50% { transform: translateY(-3px); }
            }
            /* Flip-back trigger: same tap target */
            .flip-back-trigger {
                min-height: 48px;
            }
            /* Don't dim sidebar on mobile when flipped — it's above content */
            .layout-flipped .analysis-sidebar {
                opacity: 1;
            }
            /* New elements: mobile adjustments */
            .card-nav-sticky {
                position: sticky; top: 50px;
                border-radius: var(--radius-sm);
                padding: 0.35rem 0.5rem;
                gap: 0.4rem;
            }
            .card-nav-sticky .card-nav-btn {
                padding: 0.25rem 0.4rem;
                min-width: 40px; min-height: 40px;
            }
            /* sample-badge removed */
            .inline-verdict-section { padding: 1rem; }
            .inline-verdict-section-header { gap: 0.5rem; }
            .inline-verdict-section-icon { width: 24px; height: 24px; }

            /* Phase 2: Bottom sheet for verdict */
            .verdict-col {
                position: fixed !important;
                bottom: 0; left: 0; right: 0;
                width: 100% !important;
                max-height: 90vh;
                z-index: 200;
                border-radius: 16px 16px 0 0 !important;
                border-bottom: none !important;
                box-shadow: 0 -4px 24px rgba(0,0,0,0.12) !important;
                transform: translateY(calc(100% - 52px));
                transition: transform 0.4s cubic-bezier(0.22, 1, 0.36, 1) !important;
                margin-left: 0 !important;
                overflow: hidden;
                padding-bottom: env(safe-area-inset-bottom);
            }
            .verdict-col.visible {
                width: 100% !important;
                margin-left: 0 !important;
                display: flex !important;
                opacity: 1;
            }
            .verdict-col.sheet-half {
                transform: translateY(60%);
            }
            .verdict-col.sheet-full {
                transform: translateY(10%);
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }
            /* Drag handle */
            .verdict-header::before {
                content: '';
                position: absolute;
                top: 8px;
                left: 50%;
                transform: translateX(-50%);
                width: 36px;
                height: 4px;
                border-radius: 2px;
                background: var(--text-dim);
            }
            .verdict-header {
                position: relative;
                padding-top: 1.2rem;
                cursor: grab;
            }
            .verdict-body {
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }
            body.sheet-open {
                overflow: hidden;
            }
            /* Add padding to content so bottom sheet peek doesn't cover cards */
            .content-col {
                padding-bottom: 64px !important;
            }

            /* Phase 3: Mobile card navigation — compact arrows + dots */
            .card-nav-btn {
                min-width: 44px; min-height: 44px;
                padding: 0.3rem 0.5rem;
                font-size: 0.82rem;
                border-radius: 8px;
            }
            /* Hide "Prev" text, show only ← arrow */
            .card-nav-prev span:last-child { display: none; }
            /* Next button: shorter labels on mobile */
            .card-nav-counter {
                font-size: 0.62rem;
            }
            /* Hide desktop pips on mobile (dots below replace them) */
            .card-nav-pips { display: none; }
            .card-nav-dots {
                display: flex;
                justify-content: center;
                align-items: center;
                gap: 0;
                padding: 0.4rem 0;
            }
            .card-nav-dot {
                width: 8px;
                height: 8px;
                border-radius: 4px;
                background: var(--border);
                transition: all 0.3s ease;
                cursor: pointer;
                padding: 0;
                margin: 0 -1px;
                /* Expand touch target to 44px without changing visual size */
                box-sizing: content-box;
                border: 18px solid transparent;
            }
            .card-nav-dot.active {
                width: 20px;
                background: var(--text-muted);
            }
            .card-nav-dot.risk-red { background: var(--red); }
            .card-nav-dot.risk-yellow { background: var(--yellow); }
            .card-nav-dot.risk-green { background: var(--green); }
            .card-nav-dot.risk-red.active { background: var(--red); }
            .card-nav-dot.risk-yellow.active { background: var(--yellow); }
            .card-nav-dot.risk-green.active { background: var(--green); }

            /* Phase 4: Compact sidebar strip — scrolls away on mobile so card nav can stick */
            .analysis-sidebar {
                position: relative !important;
                z-index: 10;
                border-bottom: 1px solid var(--border);
                background: var(--bg-cream);
                padding: 0;
                overflow: hidden !important;
            }
            .sidebar-profile {
                flex-direction: row !important;
                align-items: center;
                gap: 0.6rem;
                padding: 0.5rem 0.75rem;
                cursor: pointer;
                min-height: 48px;
            }
            .doc-thumbnail {
                width: 32px !important;
                height: 32px !important;
                flex-shrink: 0;
                border-radius: 4px !important;
            }
            .doc-thumbnail img {
                width: 32px !important;
                height: 32px !important;
            }
            .metadata-line {
                flex: 1;
                min-width: 0;
                overflow: hidden;
                flex-wrap: nowrap !important;
            }
            .meta-pill {
                white-space: nowrap;
            }
            .editorial-loading {
                max-height: 0;
                overflow: hidden !important;
                transition: max-height 0.4s cubic-bezier(0.22, 1, 0.36, 1);
                margin: 0 !important;
                border: none !important;
                box-shadow: none !important;
                border-radius: 0 !important;
            }
            .analysis-sidebar.expanded .editorial-loading {
                max-height: 50vh;
                overflow-y: auto !important;
                border-top: 1px solid var(--border) !important;
            }
            /* Chevron indicator for expand/collapse */
            .sidebar-profile::after {
                content: '\25BE';
                font-size: 0.7rem;
                color: var(--text-muted);
                transition: transform 0.3s ease;
                flex-shrink: 0;
            }
            .analysis-sidebar.expanded .sidebar-profile::after {
                transform: rotate(180deg);
            }

            /* Phase 5: Compact header */
            .analysis-header {
                padding: 0.4rem 0.75rem;
                padding-top: calc(0.4rem + env(safe-area-inset-top));
            }
            #copyAllBtn, #emailLawyerBtn, #exportBtn, #exportLangBtn,
            .model-badge, .capability-ticker {
                display: none !important;
            }
            .header-overflow-btn {
                display: inline-flex;
                align-items: center;
                justify-content: center;
                background: none;
                border: 1px solid var(--border);
                color: var(--text-secondary);
                width: 32px;
                height: 32px;
                border-radius: 50%;
                cursor: pointer;
                font-size: 1.1rem;
                line-height: 1;
                padding: 0;
            }
            .header-overflow-btn:hover {
                background: var(--bg-warm);
                border-color: var(--text-secondary);
            }
            .header-overflow-menu {
                position: absolute;
                top: 100%;
                right: 0.75rem;
                background: var(--bg-card);
                border: 1px solid var(--border);
                border-radius: var(--radius-sm);
                box-shadow: var(--shadow-lg);
                z-index: 110;
                min-width: 160px;
                padding: 0.25rem 0;
            }
            .header-overflow-menu.hidden { display: none; }
            .header-overflow-menu button {
                display: block;
                width: 100%;
                text-align: left;
                padding: 0.5rem 0.85rem;
                font-family: inherit;
                font-size: 0.78rem;
                color: var(--text-secondary);
                background: none;
                border: none;
                cursor: pointer;
            }
            .header-overflow-menu button:hover {
                background: var(--bg-warm);
                color: var(--text-primary);
            }
            .header-overflow-menu button.hidden { display: none; }

            /* Phase 6: Mobile usability */
            /* Verdict strip CTAs: bigger touch targets */
            .verdict-strip-cta {
                min-height: 36px !important;
                padding: 0.4rem 0.9rem !important;
                font-size: 0.65rem !important;
            }
            .verdict-progress-strip {
                padding: 0.5rem 0.6rem 0.4rem;
            }
            /* Inline verdict: tighter on mobile */
            .verdict-onescreen { padding: 1.25rem; }
            .verdict-tier-badge { font-size: 0.68rem; }
            .verdict-what-is-this { font-size: 0.95rem; }
            .verdict-should-worry { font-size: 0.82rem; }
            .verdict-main-thing { padding: 0.9rem 1rem; }
            .verdict-main-thing-text { font-size: 0.85rem; }
            .verdict-one-action { padding: 0.75rem 0.9rem; }
            .verdict-one-action-text { font-size: 0.82rem; }
            .verdict-depth-btn { min-height: 48px; }
            /* Ask FlipSide: bigger input on mobile */
            .ask-flipside-input { font-size: 0.9rem; min-height: 44px; }
            .ask-flipside-btn { min-width: 44px; min-height: 44px; }
            /* Skeleton placeholders: tighter */
            .verdict-skeleton { padding: 0.5rem 0.75rem; }
        }

        /* Bottom sheet dark mode audit */
        .dark-mode .verdict-col.sheet-half,
        .dark-mode .verdict-col.sheet-full {
            box-shadow: 0 -4px 24px rgba(0,0,0,0.4) !important;
        }
        .dark-mode .verdict-header::before {
            background: var(--text-muted);
        }
        .dark-mode .header-overflow-menu {
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
        }
        .dark-mode .card-nav-dot {
            background: var(--border);
        }
        .dark-mode .card-nav-dot.active {
            background: var(--text-muted);
        }

        /* Mobile reduced motion */
        @media (max-width: 900px) and (prefers-reduced-motion: reduce) {
            .flip-card-front { transition: none !important; }
            .flip-card-back { transition: none !important; }
            .flip-card.flipped .flip-card-front { transform: none; display: none; }
            .flip-card.flipped .flip-card-back { max-height: none; opacity: 1; }
            .verdict-col { transition: none !important; }
        }

        @media (max-width: 600px) {
            /* Sample docs: 2 columns on small screens */
            .demo-grid { grid-template-columns: repeat(2, 1fr); }
            /* Investigation loading */
            .skeleton-card { padding: 1rem 0.5rem 0.75rem; }
            .investigation-doc { height: 180px; }
            .investigation-text { font-size: 0.6rem; padding: 0.8rem 1rem; }
            .verdict-teaser-item { flex-direction: column; gap: 0.2rem; }

            /* Upload screen */
            .brand h1 { font-size: 2.4rem; }
            .upload-card { padding: 1.25rem; }

            /* Layout */
            .analysis-layout { padding: 0 0.5rem; }
            .content-col { padding: 0 0 3rem; }
            .analysis-header { padding: 0.5rem 0.75rem; }

            /* Sidebar profile: stack thumbnail above pills on small screens */
            .sidebar-profile { flex-direction: column; gap: 0.4rem; }
            .doc-thumbnail { width: 100%; height: 80px; }
            .doc-thumbnail img { height: 80px; object-fit: cover; object-position: top center; }
            .metadata-line { gap: 0.2rem; }
            .meta-pill { font-size: 0.6rem; padding: 0; }
            .meta-pill .meta-pill-label { font-size: 0.4rem; }

            /* Editorial loading / document preview */
            .editorial-loading-text {
                max-height: 30vh; font-size: 0.72rem;
                margin-left: 0.75rem; margin-right: 0.75rem;
                padding-left: 0.75rem;
            }

            /* Flip cards */
            .flip-card { margin-bottom: 1rem; }
            .front-content { padding: 1.25rem 1.25rem 0; }
            .clause-reassurance { font-size: 1.05rem; }
            .flip-card .clause-title { font-size: 1rem; }
            .flip-card .clause-quote { padding: 0.7rem 0.9rem; font-size: 0.78rem; }
            .reader-voice { padding: 0.75rem 0.9rem; }
            .reader-voice-text { font-size: 0.84rem; }
            .flip-trigger { padding: 0.75rem 1.25rem; font-size: 0.68rem; }
            .card-watermark { font-size: 5rem; right: 0.8rem; }
            .back-teaser { font-size: 0.88rem; }
            .chapter-title-text { font-size: 1rem; }

            /* Card back */
            .risk-header { padding: 1rem 1.25rem; flex-direction: column; align-items: flex-start; gap: 0.5rem; }
            .back-body { padding: 1.25rem; }
            .drafter-voice { padding: 0.75rem 0.9rem; font-size: 0.82rem; }
            .back-bottom-line { padding: 0.7rem 0.9rem; font-size: 0.78rem; }
            .flip-back-trigger { padding: 0.7rem 1.25rem; font-size: 0.75rem; }
            .card-bottom-next { padding: 0.7rem 1rem; font-size: 0.68rem; min-height: 44px; }

            /* Card navigation */
            .card-nav-btn { padding: 0.25rem 0.4rem; font-size: 0.72rem; min-width: 38px; min-height: 38px; }
            .card-nav-counter { font-size: 0.6rem; }

            /* Deep analysis cards */
            .clause-card, .cross-clause-card, .playbook-card, .assessment-card {
                padding: 1rem 1.1rem;
            }

            /* Summary */
            .verdict-tier { font-size: 1rem; }
            .clause-dot { width: 8px; height: 8px; border: 14px solid transparent; box-sizing: content-box; margin: -2px; }
            .clause-strip { gap: 0; }

            /* Follow-up */
            .followup-input { font-size: 0.85rem; }


            /* Deep analysis header */
            .deep-analysis-header { padding: 0 0.5rem; }

            .insight-example-label { font-size: 0.55rem; }
            .insight-label { font-size: 0.55rem; margin-bottom: 0.5rem; }
        }

        /* Very small screens (iPhone SE, etc.) */
        @media (max-width: 380px) {
            .brand h1 { font-size: 2rem; }
            .front-content { padding: 1rem 1rem 0; }
            .risk-header { padding: 0.75rem 1rem; }
            .card-nav-btn { padding: 0.2rem 0.35rem; font-size: 0.68rem; min-width: 36px; min-height: 36px; }
            .card-nav-sticky { padding: 0.25rem 0.35rem; gap: 0.3rem; }
            .card-nav-counter { font-size: 0.55rem; }
            .clause-reassurance { font-size: 0.95rem; }
        }

        /* ── Drafter's Playbook ────────────────────────────── */
        .playbook-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-left: 3px solid var(--yellow);
            border-radius: 12px;
            padding: 1.25rem;
            margin-top: 1rem;
        }
        .playbook-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 0.75rem;
        }
        .playbook-title {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-muted);
        }
        .playbook-subtitle {
            font-size: 0.65rem;
            color: var(--text-muted);
        }
        .playbook-bars { display: flex; flex-direction: column; gap: 0.35rem; }
        .playbook-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            padding: 0.15rem 0;
            border-radius: 4px;
            transition: background 0.15s;
        }
        .playbook-row:hover { background: var(--bg-warm); }
        .playbook-row-green {
            margin-top: 0.4rem; padding-top: 0.4rem;
            border-top: 1px solid var(--border); opacity: 0.7;
            cursor: default;
        }
        .playbook-trick-name {
            font-size: 0.7rem;
            min-width: 120px;
            white-space: nowrap;
        }
        .playbook-bar-track {
            flex: 1;
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            overflow: hidden;
        }
        .playbook-bar-fill {
            height: 100%;
            background: var(--accent);
            border-radius: 3px;
            transition: width 0.6s var(--ease-out-expo);
        }
        .playbook-count {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.65rem;
            color: var(--text-muted);
            min-width: 24px;
            text-align: right;
        }

        /* ── Trick filter chips ────────────────────────────── */
        .trick-chip-row {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
            margin-top: 0.25rem;
        }
        .chip-trick {
            background: var(--bg-card);
            border: 1px solid var(--border);
            font-size: 0.65rem;
            padding: 0.25rem 0.5rem;
            border-radius: 100px;
            cursor: pointer;
            transition: all 0.15s;
        }
        .chip-trick:hover { border-color: var(--accent); }
        .chip-trick.active {
            border-color: var(--accent);
            background: var(--accent);
            color: white;
        }
        .chip-count {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.55rem;
            opacity: 0.7;
        }

        /* ── Mobile warning overlay ─────────────────────── */
        .mobile-warning {
            display: none;
            position: fixed; inset: 0; z-index: 99999;
            background: var(--bg);
            flex-direction: column;
            align-items: center; justify-content: center;
            padding: 2rem;
            text-align: center;
        }
        .mobile-warning-icon {
            width: 56px; height: 56px; margin-bottom: 1.5rem;
            color: var(--accent);
        }
        .mobile-warning h2 {
            font-family: 'DM Sans', sans-serif;
            font-size: 1.4rem; font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }
        .mobile-warning p {
            font-family: 'DM Sans', sans-serif;
            font-size: 0.95rem; color: var(--text-secondary);
            line-height: 1.6; max-width: 320px;
        }
        .mobile-warning .mobile-warning-label {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.6rem; letter-spacing: 0.08em;
            text-transform: uppercase;
            color: var(--text-dim);
            margin-top: 2rem;
        }
        @media (max-width: 768px) {
            .mobile-warning { display: flex; }
            #upload-screen,
            #analysisScreen { display: none !important; }
        }
    </style>
</head>
<body>

<!-- Mobile warning -->
<div class="mobile-warning">
    <svg class="mobile-warning-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
        <rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/>
    </svg>
    <h2>You'll need a bigger screen</h2>
    <p>FlipSide crunches a lot of fine print — we need the space to show you what's hiding in it. Open this on a desktop or laptop for the full experience.</p>
    <div class="mobile-warning-label">FlipSide</div>
</div>

<!-- ═══════════════════════════════════════════════════════
     SCREEN 1: UPLOAD
     ═══════════════════════════════════════════════════════ -->
<section id="upload-screen" aria-label="Document upload">
    <nav class="upload-nav" id="uploadNav">
        <div class="upload-nav-brand">FlipSide</div>
        <div class="upload-nav-label">Get started</div>
        <a href="#" data-nav="top">Upload a document</a>
        <a href="#faq-what" data-nav="faq">FAQ</a>
    </nav>
    <div class="upload-main" id="uploadMain">
    <div class="upload-container">
        <div class="brand fade-up">
            <h1>FlipSide</h1>
            <p class="brand-hook">You sign so many things with a shrug.<br>They weren&rsquo;t written with one.</p>
        </div>

        <!-- Upload card: full width -->
        <div class="hero-upload fade-up fade-up-d1">
        <div class="upload-card">
            <p class="upload-headline">Drop any contract, terms, or policy you didn&rsquo;t write.<br>See what the other side intended you to miss &mdash; and how to push back.</p>

            <!-- Single document upload: 3-column input methods -->
            <div id="singleUpload">
                <div class="upload-methods" id="uploadMethods">
                    <div class="upload-method" id="methodDrop">
                        <div class="drop-zone" id="dropZone">
                            <input type="file" id="fileInput" accept=".pdf,.docx,.txt,.text,.md,image/*" capture="environment" class="sr-only">
                            <div id="uploadPrompt">
                                <span class="icon" aria-hidden="true"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><path d="M16 13H8"/><path d="M16 17H8"/><path d="M10 9H8"/></svg></span>
                                <div class="dz-title">Drop file</div>
                                <div class="filetypes">PDF &middot; DOCX &middot; TXT &middot; Photo</div>
                            </div>
                            <div id="fileInfo" class="file-selected hidden">
                                <span class="file-name" id="fileName"></span>
                                <span class="file-size" id="fileSize"></span>
                                <a class="file-remove" id="fileRemove">remove</a>
                            </div>
                        </div>
                    </div>
                    <div class="upload-method" id="methodPaste">
                        <div class="drop-zone method-zone" id="pasteZone">
                            <span class="icon" aria-hidden="true"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/></svg></span>
                            <div class="dz-title">Paste text</div>
                        </div>
                        <textarea id="pasteArea" class="paste-area hidden" placeholder="Paste contract text here..."></textarea>
                    </div>
                    <div class="upload-method" id="methodDemo">
                        <div class="drop-zone method-zone" id="demoZone">
                            <span class="icon" aria-hidden="true"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16v16H4z"/><path d="M9 9h6v6H9z"/><circle cx="7.5" cy="7.5" r=".5" fill="currentColor"/><circle cx="16.5" cy="7.5" r=".5" fill="currentColor"/><circle cx="7.5" cy="16.5" r=".5" fill="currentColor"/><circle cx="16.5" cy="16.5" r=".5" fill="currentColor"/></svg></span>
                            <div class="dz-title">Try a demo</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="upload-actions">
                <div class="upload-trust">Analyzed privately. Never stored.</div>
                <div class="depth-selector hidden" id="depthSelector">
                    <button class="depth-btn" data-depth="quick">Quick</button>
                    <button class="depth-btn active" data-depth="standard">Standard</button>
                    <button class="depth-btn" data-depth="deep">Deep</button>
                </div>
                <button class="analyze-btn" id="analyzeBtn" disabled aria-label="Start document analysis">Flip it</button>
            </div>
            <div id="uploadError" class="upload-error hidden"></div>

            <div class="upload-links hidden">
            </div>

        </div><!-- .upload-card -->
        </div><!-- .hero-upload -->

        <!-- Demo flip card: centered below upload -->
        <div class="hero-demo fade-up fade-up-d2">
            <div class="hero-demo-label">EXAMPLE</div>
            <div class="hero-flip-card" id="heroFlipCard" tabindex="0" role="button" aria-label="Flip this example card to see the hidden side">
                <div class="hero-flip-front">
                    <div class="hero-flip-header hero-flip-header-green">
                        <span class="hero-flip-label">YOU THINK THAT</span>
                        <span class="hero-flip-reassurance">You can cancel your gym membership anytime</span>
                    </div>
                    <div class="hero-flip-body">
                        <div class="hero-flip-quote">"Member may cancel by providing written notice. A processing period of 30 business days applies."</div>
                        <div class="hero-flip-reader">Sounds simple enough — just send a letter and you're out. A month's notice? That's pretty normal.</div>
                    </div>
                    <div class="hero-flip-trigger">See what this really means. Flip it!</div>
                </div>
                <div class="hero-flip-back">
                    <div class="hero-flip-header hero-flip-header-red">
                        <span class="hero-flip-label">BUT IN REALITY</span>
                        <span class="hero-flip-reassurance">They keep charging while you wait</span>
                    </div>
                    <div class="hero-flip-body">
                        <div class="hero-flip-figure">$133 to leave a $29/month gym</div>
                        <div class="hero-flip-example">"30 business days" is 6 weeks. Two more payments plus a $75 "processing fee."</div>
                    </div>
                    <div class="hero-flip-trigger hero-flip-trigger-back">&larr; Flip back</div>
                </div>
            </div>
        </div>

            <div class="demo-grid-section" id="demoGridSection">
                <div class="demo-grid-shrug">Real documents. Real fine print. Pick one and see what&rsquo;s hiding.</div>
                <div class="demo-grid">
                    <div class="demo-tile" data-sample="tos"><div class="demo-tile-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><path d="M16 13H8"/><path d="M16 17H8"/><path d="M10 9H8"/></svg></div><div class="demo-tile-label">Staying Connected</div><div class="demo-tile-desc">You agreed to more than you think</div></div>
                    <div class="demo-tile" data-sample="insurance"><div class="demo-tile-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg></div><div class="demo-tile-label">Peace of Mind</div><div class="demo-tile-desc">What&rsquo;s not covered?</div></div>
                    <div class="demo-tile" data-sample="loan"><div class="demo-tile-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 22h18"/><path d="M6 18V11"/><path d="M10 18V11"/><path d="M14 18V11"/><path d="M18 18V11"/><path d="M4 7h16l-8-5z"/></svg></div><div class="demo-tile-label">Future Fund</div><div class="demo-tile-desc">The rate isn&rsquo;t the whole story</div></div>
                    <div class="demo-tile" data-sample="lease"><div class="demo-tile-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="8" cy="15" r="5.5"/><path d="M12 11l9-9"/><path d="M17 6l4-4"/><path d="M18.5 7.5L22 7l-3-3"/></svg></div><div class="demo-tile-label">My New Place</div><div class="demo-tile-desc">Your landlord&rsquo;s favorite clause</div></div>
                    <div class="demo-tile" data-sample="gym"><div class="demo-tile-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="17 1 21 5 17 9"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><polyline points="7 23 3 19 7 15"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/></svg></div><div class="demo-tile-label">Morning Workout</div><div class="demo-tile-desc">Good luck canceling</div></div>
                    <div class="demo-tile" data-sample="pet"><div class="demo-tile-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="4" r="2"/><circle cx="4.5" cy="9" r="2"/><circle cx="17.5" cy="9" r="2"/><circle cx="8" cy="14" r="2"/><circle cx="16" cy="14" r="2"/><path d="M12 18c-2.5 2-6 2-6-.5C6 15 9 14 12 17c3-3 6-2 6 .5 0 2.5-3.5 2.5-6 .5z"/></svg></div><div class="demo-tile-label">Furry Friend</div><div class="demo-tile-desc">More than a promise</div></div>
                    <div class="demo-tile" data-sample="coupon"><div class="demo-tile-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><circle cx="7" cy="7" r="1.5"/></svg></div><div class="demo-tile-label">Weekend Savings</div><div class="demo-tile-desc">The savings aren&rsquo;t free</div></div>
                    <div class="demo-tile" data-sample="wedding"><div class="demo-tile-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M8 21h8"/><path d="M12 17v4"/><path d="M7 4V2"/><path d="M17 4V2"/><path d="M5 4h14a2 2 0 0 1 2 2v4a7 7 0 0 1-14 0V6a2 2 0 0 1 2-2z"/></svg></div><div class="demo-tile-label">Celebration!</div><div class="demo-tile-desc">Who pays when it rains?</div></div>
                    <div class="demo-tile" data-sample="hackathon"><div class="demo-tile-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L9 9l-7 1 5 5-1.5 7L12 18l6.5 4L17 15l5-5-7-1z"/></svg></div><div class="demo-tile-label">The Hackathon</div><div class="demo-tile-desc">What did we all agree to?</div></div>
                    <div class="demo-tile" data-sample="employment"><div class="demo-tile-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg></div><div class="demo-tile-label">First Day of Work</div><div class="demo-tile-desc">Read this before you start</div></div>
                    <div class="demo-tile" data-sample="sweepstakes"><div class="demo-tile-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M2 12h20"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg></div><div class="demo-tile-label">Trip of a Lifetime</div><div class="demo-tile-desc">Can they really keep the prize?</div></div>
                    <div class="demo-tile" data-sample="medical"><div class="demo-tile-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1"/></svg></div><div class="demo-tile-label">Check-up Time</div><div class="demo-tile-desc">What you&rsquo;re really signing</div></div>
                    <div class="demo-tile" data-sample="hoa"><div class="demo-tile-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg></div><div class="demo-tile-label">Dream Home</div><div class="demo-tile-desc">Your house, their rules</div></div>
                    <div class="demo-tile" data-sample="timeshare"><div class="demo-tile-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg></div><div class="demo-tile-label">Dream Getaway</div><div class="demo-tile-desc">Check-out is forever</div></div>
                </div>
                <button class="demo-grid-expand" id="demoGridExpand">See all 14 samples &#8250;</button>
            </div>

        </div>

        <div class="disclaimer fade-up fade-up-d2">
            <strong>Your document is analyzed by Claude and never stored.</strong> No data leaves the Anthropic API.<br>
            AI analysis — not legal advice. Always consult an attorney for important decisions.
        </div>
    </div>

    <!-- ── FAQ Sections ─────────────────────────────────── -->
    <div class="faq-wrapper hidden" id="faqWrapper">
        <button class="faq-back" id="faqBack"><span class="faq-back-arrow">&larr;</span> Back to upload</button>
        <h2 class="faq-title">Frequently Asked Questions</h2>
        <p class="faq-subtitle">Everything you need to know before uploading a document.</p>

        <div class="faq-section" id="faq-what">
            <h3>What is FlipSide?</h3>
            <p>FlipSide shows you what the other side intended when they wrote your document. Upload any contract, agreement, or policy you didn't draft — a lease, insurance policy, gym membership, Terms of Service — and FlipSide reads it from <strong>the drafter's perspective</strong>, not yours.</p>
            <p>Each clause gets a flip card. The front shows what a trusting reader sees: the reassuring headline, the comforting language. Flip it, and the back reveals what an expert catches: the trick, the risk score, the figure that matters, and what you should actually read.</p>
            <p>It's based on a methodology called <strong>"Think Like a Document"</strong> — instead of reading from your perspective, read from the perspective of the party who wrote it. FlipSide applies that principle at scale using AI.</p>
            <p>FlipSide treats a $2 coupon with the same seriousness as a $500,000 corporate lease. Because the tricks are the same — only the stakes change.</p>
        </div>

        <hr class="faq-divider">

        <div class="faq-section" id="faq-how">
            <h3>How does it work?</h3>
            <p>FlipSide runs <strong>two AI models in parallel</strong> the moment you upload:</p>
            <ul>
                <li><strong>Flip Cards</strong> (Claude Haiku 4.5): Pre-scans your document, then launches parallel workers that generate full flip cards &mdash; front and back &mdash; in ~8 seconds.</li>
                <li><strong>Expert Verdict</strong> (Claude Opus 4.6): Builds a one-screen verdict from t=0 &mdash; verdict tier, main risk, power ratio, jurisdiction detection, risks, and a self-reviewed checklist.</li>
            </ul>
            <p>Cards appear in seconds. Six expert analyses build in parallel: a verdict, document archaeology, worst-case scenario, walk-away number, hidden combinations, and negotiation playbook. You can start flipping cards while Opus 4.6 is still thinking. Expert reports appear as each one finishes.</p>
            <p>After the analysis, you can <strong>ask follow-up questions</strong> ("What happens if I'm 3 months late on rent?"), <strong>message the company</strong> with a professional letter citing specific clauses, or request a <strong>counter-draft</strong> that rewrites unfair clauses with negotiable alternatives.</p>
        </div>

        <hr class="faq-divider">

        <div class="faq-section" id="faq-privacy">
            <h3>Your data &amp; privacy</h3>
            <p><strong>FlipSide stores nothing.</strong> Your document is not saved anywhere — not to disk, not to a database, not to a temporary file. It exists only in your browser session's memory and is gone when you close the tab or analyze a new document.</p>
            <ul>
                <li><strong>No disk writes.</strong> The server has no file system storage, no database, no logging of document content.</li>
                <li><strong>No external services.</strong> Your document is never sent to any third party. The only external call is to the Anthropic API (Claude) for analysis.</li>
                <li><strong>No analytics or tracking.</strong> No cookies, no user accounts, no telemetry. FlipSide doesn't know who you are.</li>
                <li><strong>Memory only.</strong> Documents exist in server memory during your active session and are released when the session ends. Nothing survives a server restart.</li>
            </ul>
            <p>The 14 sample documents on this page are embedded directly in the application code — they are not fetched from any external source.</p>
        </div>

        <hr class="faq-divider">

        <div class="faq-section" id="faq-claude">
            <h3>What does Claude keep?</h3>
            <p>When you upload a document, it is sent to the <strong>Anthropic API</strong> for analysis by Claude Haiku 4.5 (fast card scan) and Claude Opus 4.6 (expert verdict). Here is what Anthropic does and does not do with your data:</p>
            <ul>
                <li><strong>Not used for training.</strong> Anthropic does not use API inputs to train its models. Your document will not become part of Claude's training data.</li>
                <li><strong>Safety monitoring.</strong> Anthropic may retain API inputs for up to 30 days for trust and safety purposes (detecting abuse, complying with legal obligations). After that, it is deleted.</li>
                <li><strong>No sharing.</strong> Anthropic does not share your API data with third parties except as required by law.</li>
                <li><strong>Prompt caching.</strong> FlipSide uses Anthropic's prompt caching feature, which caches the <em>system instructions</em> (not your document) for performance. This reduces cost and latency but does not affect your document's privacy.</li>
            </ul>
            <p>In short: Anthropic processes your document to generate the analysis, may retain it briefly for safety, and then deletes it. FlipSide itself keeps nothing at all.</p>
            <p style="font-size:0.78rem;color:var(--text-muted)">For full details, see <a href="https://www.anthropic.com/policies/privacy" target="_blank" rel="noopener" style="color:var(--accent)">Anthropic's Privacy Policy</a> and <a href="https://www.anthropic.com/policies/usage" target="_blank" rel="noopener" style="color:var(--accent)">Usage Policy</a>.</p>
        </div>

        <hr class="faq-divider">

        <div class="faq-section" id="faq-free">
            <h3>Why is it free?</h3>
            <p>FlipSide was built during the <strong>Built with Claude Hackathon</strong> (February 2026) to prove a point: legal document analysis shouldn't be locked behind <a href="https://www.redlinedcs.com/post/big-law-attorneys" target="_blank" rel="noopener" style="color:var(--accent)">$2,500/hour BigLaw fees</a>. Everyone signs contracts. Not everyone can afford to understand them.</p>
            <p>The entire codebase is <strong>open source under the MIT License</strong> — free for anyone to use, modify, and distribute. There are no paid tiers, no premium features, no subscriptions, and no plans to add any.</p>
            <p>The only operational cost is the Anthropic API, which processes each document. During the hackathon, there are no cost constraints. The vision: making document literacy accessible to everyone, not just people who can afford a lawyer.</p>
        </div>

        <hr class="faq-divider">

        <div class="faq-section" id="faq-legal">
            <h3>Is this legal advice?</h3>
            <p><strong>No.</strong> FlipSide is an analysis tool, not a law firm. It helps you understand what a document says and what the drafter may have intended — but it is not a substitute for professional legal advice.</p>
            <ul>
                <li>FlipSide does not provide legal opinions or recommendations.</li>
                <li>FlipSide is not your attorney and no attorney-client relationship is created.</li>
                <li>For important decisions — signing a lease, accepting employment terms, buying insurance — always consult a qualified attorney.</li>
            </ul>
            <p>Think of FlipSide as a flashlight: it shows you what's there. What you do with that knowledge is up to you and your lawyer.</p>
        </div>

        <hr class="faq-divider">

        <div class="faq-section" id="faq-who">
            <h3>Who built this?</h3>
            <p><strong>Henk van Ess</strong> finds the story in public data. An internationally recognized expert in AI-powered digital research and open-source intelligence (OSINT), his methods are sought after by Pulitzer winners, NGOs, research firms, and law enforcement. Assessor for the International Fact-Checking Network (IFCN) and its European counterpart EFCSN. Early Bellingcat contributor. Author of multiple books on internet research. 10,000+ newsletter subscribers from BBC, NYT, Reuters, Europol, Harvard, MIT.</p>
            <p><strong>He does not write code.</strong> Every line of FlipSide &mdash; 3,861 lines of Python backend and 10,748 lines of frontend &mdash; was built through conversation with Claude Opus 4.6 in 5 days. The prompts were the product. The AI was the builder.</p>
            <p>Previous open-source tools: <a href="https://imagewhisperer.online" target="_blank" rel="noopener" style="color:var(--accent)">ImageWhisperer</a>, SearchWhisperer, AI Whisperer. Newsletter: <a href="https://digitaldigging.substack.com" target="_blank" rel="noopener" style="color:var(--accent)">Digital Digging</a>.</p>
        </div>

        <hr class="faq-divider">

        <!-- ── The Fair Clause ── -->
        <div class="faq-section" id="faq-fair-clause">
            <div class="fair-clause-card">
                <h3>The FlipSide Fair Clause</h3>
                <span class="fair-clause-badge">SCORE 0/100 &middot; NO TRICKS DETECTED &middot; WRITTEN BY OPUS 4.6</span>
                <p class="fair-clause-intro">We asked Claude Opus 4.6 with extended thinking: "Write the fairest possible service agreement clause. Every provision must be symmetrical — what applies to the customer must equally apply to the company. Show your reasoning for each section." This is what it wrote.</p>

                <div class="fair-clause-section">
                    <h4>1. What we promise each other.</h4>
                    <p>We will provide the service as described at the time you signed up. If we need to change what's included, we will notify you 30 days in advance, and you may cancel without penalty if you disagree. You agree to use the service in good faith and pay the agreed amount on time. If your payment fails, we will notify you and give you 14 days to resolve it. No late fees. No penalties. No collection agencies.</p>
                    <div class="fair-clause-reasoning">Opus reasoning: Most service agreements give the provider unlimited discretion to change terms while locking the customer into the original price. Symmetry means both parties get the same notice period and the same exit rights when terms change.</div>
                </div>

                <div class="fair-clause-section">
                    <h4>2. Either of us can leave.</h4>
                    <p>You may cancel at any time. We may cancel with 30 days' written notice. If you have paid in advance, you will receive a prorated refund for the unused period. No cancellation fees. No early termination penalties. No "retention department" calls.</p>
                    <div class="fair-clause-reasoning">Opus reasoning: The most common trick in consumer contracts is asymmetric exit — the company can terminate immediately "for any reason" while the customer faces penalties, lockout periods, or forfeiture of prepaid amounts. Fair means equal exits.</div>
                </div>

                <div class="fair-clause-section">
                    <h4>3. If something goes wrong.</h4>
                    <p>If the service fails, we will work to restore it within 48 hours and credit you for the downtime. If we cause you measurable financial harm through negligence, our liability is capped at 12 months of fees you have paid — and the same cap applies to your liability to us. Neither party is liable for circumstances beyond their control.</p>
                    <div class="fair-clause-reasoning">Opus reasoning: Typical agreements cap the company's liability at "fees paid in the last month" while leaving the customer's liability unlimited. A fair cap is symmetrical and substantial enough to be meaningful — 12 months, not 1.</div>
                </div>

                <div class="fair-clause-section">
                    <h4>4. Disagreements.</h4>
                    <p>We will first attempt to resolve any dispute through direct conversation. If that fails, we will use mediation with a mutually agreed mediator, splitting the cost equally. If mediation fails, either party may pursue resolution in the courts of their own jurisdiction. No forced arbitration. No class action waivers. No "prevailing party pays attorneys' fees" clauses that discourage small claims.</p>
                    <div class="fair-clause-reasoning">Opus reasoning: Forced arbitration with a company-selected arbitrator in a company-chosen jurisdiction is the single most powerful trick in consumer contracts. It eliminates your practical ability to dispute anything. Fair means you choose your own forum.</div>
                </div>

                <div class="fair-clause-section">
                    <h4>5. Your content stays yours.</h4>
                    <p>Anything you create, upload, or store using the service belongs to you. We may use it only to provide you the service. We will not sell it, license it, or use it for training, advertising, or any purpose beyond delivering what you asked for. When you leave, you may export your data at any time, and we will delete our copies within 30 days.</p>
                    <div class="fair-clause-reasoning">Opus reasoning: "Content Grab" is the second most common trick — buried in ToS, you grant a "worldwide, irrevocable, perpetual license" to everything you upload. Fair means your data is yours, period. The company is a custodian, not an owner.</div>
                </div>

                <div class="fair-clause-section">
                    <h4>6. Changes to this agreement.</h4>
                    <p>We may update these terms. For minor clarifications, we will post the update and notify you. For material changes — anything affecting price, service scope, your rights, or dispute resolution — we will notify you 30 days in advance and require your explicit consent. If you do not consent, you may leave with a full refund of any prepaid amounts. We will never interpret continued use as acceptance of material changes.</p>
                    <div class="fair-clause-reasoning">Opus reasoning: "Continued use constitutes acceptance" is how companies unilaterally rewrite the deal after you've signed. Fair means material changes require your actual agreement — not your silence.</div>
                </div>

                <div class="fair-clause-section">
                    <h4>7. Plain language guarantee.</h4>
                    <p>This agreement is written in plain language because we believe you should understand what you're agreeing to. If any provision is ambiguous, it will be interpreted in favor of the party who did not draft it — which, in this case, is you.</p>
                    <div class="fair-clause-reasoning">Opus reasoning: The legal doctrine of contra proferentem (interpret against the drafter) exists precisely because the drafter chose the words. Making this explicit signals good faith and removes the incentive to write deliberately vague provisions.</div>
                </div>

                <div class="fair-clause-score">
                    <svg class="fair-clause-score-ring" viewBox="0 0 36 36">
                        <circle cx="18" cy="18" r="15.9" fill="none" stroke="var(--green-border)" stroke-width="2"/>
                        <circle cx="18" cy="18" r="15.9" fill="none" stroke="var(--green)" stroke-width="2.5" stroke-dasharray="100, 100" stroke-dashoffset="100" stroke-linecap="round" transform="rotate(-90 18 18)"/>
                        <text x="18" y="19.5" text-anchor="middle" font-size="9" font-weight="700" font-family="JetBrains Mono, monospace" fill="var(--green-text)">0</text>
                    </svg>
                    FlipSide Risk Score: 0/100 &middot; Power Ratio: 1:1 &middot; Tricks detected: none
                </div>
                <div class="fair-clause-footer">
                    This clause was generated by Claude Opus 4.6 with extended thinking (adaptive mode). It is not legal advice — it is what a fair agreement looks like when both sides can see. Use it as a benchmark: the further a real contract deviates from these principles, the more questions you should ask.
                </div>
            </div>
        </div>

    </div>
    <!-- end faq-wrapper -->

    </div>
    <!-- end upload-main -->
</section>

<!-- ═══════════════════════════════════════════════════════
     SCREEN 2/3: ANALYSIS
     ═══════════════════════════════════════════════════════ -->
<section id="analysis-screen" class="hidden" aria-label="Document analysis">
    <header class="analysis-header">
        <div class="header-left">
            <span class="header-brand" id="headerBrand">FlipSide</span>
            <button class="header-btn hidden" id="copyAllBtn" aria-label="Copy all analysis to clipboard">Copy all</button>
            <button class="header-btn hidden" id="emailLawyerBtn" aria-label="Email analysis to your lawyer">All flags via mail</button>
            <button class="header-btn hidden" id="exportBtn" aria-label="Download report as PDF">Download PDF</button>
            <button class="header-btn hidden" id="exportLangBtn" title="Download report in document language" aria-label="Download report in document language"></button>
            <button class="header-btn" id="darkModeBtn" title="Toggle dark mode" aria-label="Toggle dark mode">&#9790;</button>
            <button class="header-btn home-btn" id="backBtn" title="Back to home" aria-label="Return to upload screen"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg></button>
        </div>
        <div class="header-right">
            <span class="capability-ticker hidden" id="capabilityTicker"></span>
            <div class="status-pill" id="statusPill" role="status" aria-live="polite">
                <span class="status-dot"></span>
                <span id="statusText">Starting analysis...</span>
                <span class="elapsed-time" id="elapsedTime"></span>
            </div>
            <span class="model-badge">Opus 4.6 + Haiku 4.5</span>
            <button class="header-overflow-btn" id="headerOverflowBtn" title="More actions" aria-label="More actions" aria-expanded="false">&#8943;</button>
            <div class="header-overflow-menu hidden" id="headerOverflowMenu">
                <button data-action="copy" class="hidden">Copy all</button>
                <button data-action="email" class="hidden">All flags via mail</button>
                <button data-action="export" class="hidden">Download PDF</button>
                <button data-action="exportLang" class="hidden"></button>
                <button data-action="faq">FAQ</button>
            </div>
        </div>
    </header>

    <div class="analysis-layout">
    <!-- Left sidebar: document profile + preview (stays on screen) -->
    <aside class="analysis-sidebar hidden" id="analysisSidebar">
        <div class="sidebar-profile" id="sidebarProfile">
            <div class="doc-thumbnail hidden" id="docThumbnail">
                <img id="docThumbnailImg" alt="Document page 1">
            </div>
            <div class="metadata-line hidden" id="metadataLine"></div>
        </div>
        <div class="editorial-loading hidden" id="editorialLoading">
            <div class="sidebar-doc-icon"><svg viewBox="0 0 32 32" width="32" height="32" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="6" y="3" width="20" height="26" rx="2"/><path d="M10 9h12M10 13h12M10 17h8"/><circle cx="21" cy="22" r="5" stroke-width="1.5"/><path d="M24.5 25.5l2.5 2.5"/></svg></div>
            <div class="editorial-loading-label">What the small print says</div>
            <div class="editorial-loading-text" id="editorialLoadingText"></div>
            <div class="editorial-loading-indicator">
                <span class="pulsing-dots"><span></span><span></span><span></span></span>
                <span class="editorial-loading-status" id="editorialLoadingStatus">FlipSide is reading between the lines...</span>
            </div>
        </div>
    </aside>

    <!-- Main content: cards + analysis -->
    <div class="content-col">

        <!-- Card viewport: one card at a time -->
        <div class="card-viewport hidden" id="cardViewport">
            <!-- Context banner — emotional safety framing -->
            <!-- Educational review pill (above title) -->
            <div class="edu-review-pill hidden" id="eduReviewPill">FlipSide shows what this document allows if enforced to the letter. Educational review &mdash; not legal advice.</div>
            <!-- Document title hero (bridges visual weight from upload screen) -->
            <div class="doc-title-hero hidden" id="docTitleHero"><span id="docTitleText"></span><span class="doc-title-flag hidden" id="docTitleFlag"></span></div>
            <!-- Sticky card navigation (top) -->
            <nav class="card-nav-sticky" id="cardNavSticky" aria-label="Clause card navigation">
                <button class="card-nav-btn card-nav-prev" disabled aria-label="Previous clause">
                    <span>&larr;</span> <span>Prev</span>
                </button>
                <div style="display:flex;flex-direction:column;align-items:center;gap:4px">
                    <span class="card-nav-counter" id="stickyCardCounter">Clause <strong>1</strong> of <strong>1</strong></span>
                    <div class="card-nav-pips" id="cardNavPips"></div>
                </div>
                <button class="card-nav-btn card-nav-next" aria-label="Next clause">
                    <span class="card-nav-next-label">Next &rarr;</span>
                </button>
                <div class="verdict-progress-strip" id="verdictProgressStrip">
                    <div id="verdictStripBuilding">
                        <span class="pulsing-dots" style="margin-right:8px"><span></span><span></span><span></span></span>
                        <span id="verdictStripText">Expert analyzing&hellip;</span>
                    </div>
                    <div id="verdictStripPeek" class="hidden">
                        <span>Verdict forming&hellip;</span>
                        <button class="verdict-strip-cta verdict-strip-peek" id="verdictStripPeekCta">Peek &rarr;</button>
                    </div>
                    <div id="verdictStripReady" class="hidden">
                        <span>Expert verdict ready</span>
                        <button class="verdict-strip-cta" id="verdictStripCta">Read it &rarr;</button>
                    </div>
                </div>
            </nav>
            <!-- Document profile: who/what/where/when (appears ~2s from Haiku) -->
            <div class="doc-context hidden" id="docContext"></div>
            <!-- Risk summary strip — removed from card nav, lives in verdict -->
            <!-- Investigation loading screen — loupe scanning document -->
            <div class="skeleton-card hidden" id="skeletonCard">
                <!-- Document with real text + scanning loupe -->
                <div class="investigation-doc">
                    <div class="investigation-text" id="investigationText"></div>
                    <!-- Animated loupe -->
                    <div class="investigation-loupe">
                        <svg viewBox="0 0 56 56" width="88" height="88" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="22" cy="22" r="15" stroke="#c44b28" stroke-width="2.5" fill="rgba(196,75,40,0.05)"/>
                            <circle cx="22" cy="22" r="10" stroke="rgba(196,75,40,0.12)" stroke-width="0.5" fill="none"/>
                            <line x1="33" y1="33" x2="48" y2="48" stroke="#c44b28" stroke-width="3.5" stroke-linecap="round"/>
                        </svg>
                    </div>
                </div>

                <!-- Status -->
                <div class="skeleton-status">
                    <span class="pulsing-dots"><span></span><span></span><span></span></span>
                    <span id="skeletonStatusText">Reading the fine print</span>
                </div>

                <!-- Three investigation phases -->
                <div class="investigation-phases" id="skeletonActs">
                    <div class="investigation-phase active" id="investPhase1">
                        <div class="phase-icon">
                            <svg viewBox="0 0 20 20" width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M1 10s3.5-6 9-6 9 6 9 6-3.5 6-9 6-9-6-9-6z"/>
                                <circle cx="10" cy="10" r="3"/>
                            </svg>
                        </div>
                        <div class="phase-info">
                            <div class="phase-title">Reading the fine print</div>
                            <div class="phase-status" id="investPhase1Status"><span class="pulsing-dots" style="transform:scale(0.6)"><span></span><span></span><span></span></span> Scanning...</div>
                        </div>
                    </div>
                    <div class="investigation-phase active" id="investPhase2">
                        <div class="phase-icon">
                            <svg viewBox="0 0 20 20" width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="2" y="4" width="9" height="13" rx="1.5"/>
                                <rect x="9" y="3" width="9" height="13" rx="1.5"/>
                            </svg>
                        </div>
                        <div class="phase-info">
                            <div class="phase-title">Flipping to the dark side</div>
                            <div class="phase-status" id="investPhase2Status"><span class="pulsing-dots" style="transform:scale(0.6)"><span></span><span></span><span></span></span> Scanning...</div>
                        </div>
                    </div>
                    <div class="investigation-phase active" id="investPhase3">
                        <div class="phase-icon">
                            <svg viewBox="0 0 20 20" width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M10 2L3 5.5v4.5c0 4.5 3 7.5 7 9 4-1.5 7-4.5 7-9V5.5L10 2z"/>
                            </svg>
                        </div>
                        <div class="phase-info">
                            <div class="phase-title">Expert panel convening</div>
                            <div class="phase-status" id="investPhase3Status"><span class="pulsing-dots" style="transform:scale(0.6)"><span></span><span></span><span></span></span> ~2 min</div>
                        </div>
                    </div>
                </div>

                <!-- Expert Briefing: narrated AI progress during loading -->
                <div class="expert-briefing" id="expertBriefing">
                    <div class="briefing-narration">
                        <span class="briefing-sentence visible" id="briefingSentence">Reading your document from start to finish</span>
                    </div>
                    <div class="briefing-tracks">
                        <div class="briefing-track">
                            <span class="track-indicator readers" id="trackReaders"></span>
                            <div class="track-info">
                                <div class="track-label">Clause readers</div>
                                <div class="track-detail" id="trackReadersDetail">Scanning for key clauses</div>
                            </div>
                        </div>
                        <div class="briefing-track">
                            <span class="track-indicator expert" id="trackExpert"></span>
                            <div class="track-info">
                                <div class="track-label">Expert verdict</div>
                                <div class="track-detail" id="trackExpertDetail">Starting deep analysis</div>
                            </div>
                        </div>
                    </div>
                    <div class="briefing-depth" id="briefingDepth"></div>
                </div>

                <div class="skeleton-waiting hidden" id="skeletonMessage"></div>
                <div class="ocr-banner hidden" id="ocrBanner">Scanned document detected &mdash; OCR extraction used, may take a bit longer</div>
            </div>
            <!-- Thinking viewer lives in the card nav sticky strip -->
            <!-- Cards ready pill: appears when cards arrive after verdict was auto-revealed -->
            <div class="cards-ready-pill hidden" id="cardsReadyPill">
                <span class="cards-ready-icon">&#x2728;</span>
                <span id="cardsReadyText">Cards ready</span>
                <span class="cards-ready-arrow">&rarr;</span>
            </div>
            <div id="flipCardContainer" aria-live="polite" aria-relevant="additions"></div>
            <nav class="card-navigation hidden" id="cardNavigation" aria-label="Clause card navigation">
                <button class="card-nav-btn card-nav-prev" disabled aria-label="Previous clause">
                    <span>&larr;</span> <span>Previous</span>
                </button>
                <span class="card-nav-counter">Clause <strong>1</strong> of <strong>1</strong></span>
                <button class="card-nav-btn card-nav-next" aria-label="Next clause">
                    <span class="card-nav-next-label">Next clause &rarr;</span>
                </button>
            </nav>
            <div class="card-nav-dots" id="cardNavDots" role="navigation" aria-label="Clause indicators"></div>
            <div class="chapter-title" id="chapterTitle">
                <span class="chapter-title-counter" id="chapterCounter"></span>
                <span class="chapter-title-text" id="chapterText"></span>
            </div>
            <!-- Inline verdict section (below cards — revealed when verdict is ready) -->
            <div class="inline-verdict" id="inlineVerdict">
                <div class="inline-verdict-divider">
                    <span class="inline-verdict-divider-text" id="verdictDividerText"></span>
                </div>
                <div id="inlineVerdictContent"></div>
                <div class="inline-verdict-progress hidden" id="inlineVerdictProgress">
                    <span class="pulsing-dots"><span></span><span></span><span></span></span>
                    <span id="inlineVerdictProgressText">Expert analysis in progress...</span>
                </div>
            </div>
        </div>

        <!-- Results: summary + deep analysis -->
        <div class="results-area hidden" id="resultsArea">
            <div id="resultsContent"></div>
            <div id="deepAnalysisSection" class="hidden">
                <button class="back-to-cards-btn" id="backToCardsBtn" aria-label="Return to clause cards">&larr; Back to clauses</button>
                <div id="summaryContainer"></div>
                <div id="filterChips" class="filter-chips hidden"></div>
                <div id="deepAnalysisContent" aria-live="polite"></div>
                <div class="counter-draft-section hidden" id="counterDraftSection">
                    <hr class="editorial-divider">
                    <div class="section-label" style="margin-bottom:1rem">Go deeper</div>
                    <div style="display:flex;gap:0.7rem;flex-wrap:wrap">
                        <button class="counter-draft-btn" id="timelineBtn">Worst-Case Timeline</button>
                        <button class="counter-draft-btn" id="counterDraftBtn">Generate Counter-Draft</button>
                    </div>
                    <div id="timelineContent"></div>
                    <div id="counterDraftContent"></div>
                </div>
                <div class="followup-section hidden" id="followupSection">
                    <hr class="editorial-divider">
                    <div class="section-label" style="margin-bottom:1rem">Ask about this document</div>
                    <div class="followup-input-row">
                        <textarea class="followup-input" id="followupInput" placeholder="What happens if I'm 3 days late on rent?" rows="1"></textarea>
                        <button class="followup-send" id="followupSend">Ask</button>
                    </div>
                    <div id="followupAnswers"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Right column: live Opus expert report -->
    <aside class="verdict-col" id="verdictCol">
        <div class="verdict-header">
            <span class="verdict-dot"></span>
            <span class="verdict-title" id="verdictTitle">Expert report</span>
            <button class="verdict-expand-btn" id="verdictExpandBtn" style="opacity:0.4;pointer-events:none;">Verdict building&hellip;</button>
        </div>
        <div class="verdict-body" id="verdictBody">
            <div class="verdict-doc-profile hidden" id="verdictDocProfile">
                <div class="verdict-doc-thumb hidden" id="verdictDocThumb">
                    <img id="verdictDocThumbImg" alt="Document">
                </div>
                <div class="verdict-doc-meta" id="verdictDocMeta"></div>
            </div>
            <div class="verdict-invitation" id="verdictInvitation">You're invited to look over our expert's shoulder while they check claims one by one. Flip the card to find the dark side of the small print.</div>
            <div class="verdict-status" id="verdictStatus">Our expert is reading the small print <span class="verdict-time-pill" id="verdictCountdown">2:00</span></div>
            <div class="verdict-tricks hidden" id="verdictTricks">
                <div class="verdict-tricks-title">Tricks detected</div>
                <div class="verdict-tricks-list" id="verdictTricksList"></div>
            </div>
            <div class="verdict-summary" id="verdictSummary"></div>
            <div class="opus-section locked" id="opusSection_overall" data-source="overall">
                <div class="opus-section-header" data-toggle="overall">
                    <span class="opus-dot pulsing"></span>
                    <span class="opus-section-title">Expert Verdict</span>
                </div>
                <div class="opus-section-body collapsed" id="opusBody_overall"></div>
            </div>
            <!-- Focused reading panel (replaces section list when user clicks a completed section) -->
            <div class="verdict-focused-panel" id="verdictFocusedPanel">
                <div class="verdict-focused-nav">
                    <button class="verdict-focused-nav-btn" id="focusedClose" title="Back to overview">&larr; Back</button>
                    <span class="verdict-focused-counter" id="focusedCounter"></span>
                    <button class="verdict-focused-nav-btn" id="focusedPrev">&uarr;</button>
                    <button class="verdict-focused-nav-btn" id="focusedNext">&darr;</button>
                </div>
                <div class="verdict-focused-title" id="focusedTitle"></div>
                <div class="verdict-focused-content" id="focusedContent"></div>
            </div>
        </div>
    </aside>

    </div><!-- /analysis-layout -->
</section>

<script>
// ═══════════════════════════════════════════════════════════════
// FlipSide Frontend — Thinking is the product
// ═══════════════════════════════════════════════════════════════

(function () {
    'use strict';

    // ── Constants ──────────────────────────────────────────────
    var TRICK_ICONS = {
        'Silent Waiver': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6L6 18"/><path d="M6 6l12 12"/></svg>',
        'Burden Shift': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3v18"/><path d="M5 8l7-5 7 5"/><path d="M5 16h14"/></svg>',
        'Time Trap': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>',
        'Escape Hatch': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>',
        'Moving Target': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>',
        'Forced Arena': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 22h18"/><path d="M6 18V11"/><path d="M10 18V11"/><path d="M14 18V11"/><path d="M18 18V11"/><path d="M4 7h16l-8-5z"/></svg>',
        'Phantom Protection': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="M9 12l2 2 4-4" stroke-dasharray="2 2"/></svg>',
        'Cascade Clause': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v6"/><path d="M8 10h8"/><path d="M6 14l6-4 6 4"/><path d="M4 18l8-4 8 4"/><path d="M2 22l10-4 10 4"/></svg>',
        'Sole Discretion': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L9 9H2l6 4.5L5.5 21 12 16.5 18.5 21 16 13.5 22 9h-7z"/></svg>',
        'Liability Cap': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="M8 12h8"/></svg>',
        'Reverse Shield': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>',
        'Auto-Lock': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>',
        'Content Grab': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.83 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5z"/></svg>',
        'Data Drain': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>',
        'Penalty Disguise': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 8c-2.2 0-4 1.3-4 3 0 2.5 4 3.5 4 6"/><circle cx="12" cy="20" r="0.5" fill="currentColor"/><circle cx="12" cy="12" r="10"/></svg>',
        'Gag Clause': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9 9h.01"/><path d="M15 9h.01"/><path d="M8 15h8"/><circle cx="12" cy="12" r="10"/></svg>',
        'Scope Creep': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="2"/><path d="M12 2a10 10 0 0 1 7.07 2.93"/><path d="M12 2a10 10 0 0 0-7.07 2.93"/><path d="M2 12a10 10 0 0 1 2.93-7.07"/><path d="M22 12a10 10 0 0 0-2.93-7.07"/></svg>',
        'Ghost Standard': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><path d="M9 15h.01"/><path d="M12 15h.01"/><path d="M15 15h.01"/></svg>'
    };
    // Backward compat — emoji fallback

    // ── Document type category icons (from demo tiles) ───
    var DOC_TYPE_ICONS = [
        { keys: ['lease', 'rental', 'tenant', 'landlord', 'residential lease'], label: 'Lease',
          svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="8" cy="15" r="5.5"/><path d="M12 11l9-9"/><path d="M17 6l4-4"/><path d="M18.5 7.5L22 7l-3-3"/></svg>' },
        { keys: ['insurance', 'coverage', 'policy', 'policyholder', 'underwriting'], label: 'Insurance',
          svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>' },
        { keys: ['terms of service', 'terms of use', 'user agreement', 'privacy policy', 'tos', 'eula'], label: 'Terms of Service',
          svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><path d="M16 13H8"/><path d="M16 17H8"/><path d="M10 9H8"/></svg>' },
        { keys: ['employment', 'offer letter', 'job', 'non-compete', 'noncompete', 'severance', 'work contract'], label: 'Employment',
          svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>' },
        { keys: ['loan', 'mortgage', 'credit', 'lending', 'promissory', 'financing'], label: 'Loan',
          svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 22h18"/><path d="M6 18V11"/><path d="M10 18V11"/><path d="M14 18V11"/><path d="M18 18V11"/><path d="M4 7h16l-8-5z"/></svg>' },
        { keys: ['gym', 'fitness', 'membership', 'health club', 'workout'], label: 'Gym',
          svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="17 1 21 5 17 9"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><polyline points="7 23 3 19 7 15"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/></svg>' },
        { keys: ['court', 'plea', 'criminal', 'civil', 'judicial', 'lawsuit', 'litigation', 'arbitration', 'settlement', 'judgment', 'indictment', 'prosecution', 'defendant'], label: 'Court',
          svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L4 7h16z"/><rect x="4" y="7" width="16" height="2"/><path d="M6 9v9"/><path d="M10 9v9"/><path d="M14 9v9"/><path d="M18 9v9"/><rect x="3" y="18" width="18" height="2" rx="0.5"/></svg>' },
        { keys: ['medical', 'patient', 'hipaa', 'treatment', 'procedure', 'healthcare', 'hospital', 'medical consent'], label: 'Medical',
          svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1"/></svg>' },
        { keys: ['hoa', 'homeowner association', 'bylaws', 'covenants', 'cc&r', 'community rules'], label: 'HOA',
          svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>' },
        { keys: ['wedding', 'venue', 'event', 'catering', 'reception'], label: 'Event Venue',
          svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M8 21h8"/><path d="M12 17v4"/><path d="M7 4V2"/><path d="M17 4V2"/><path d="M5 4h14a2 2 0 0 1 2 2v4a7 7 0 0 1-14 0V6a2 2 0 0 1 2-2z"/></svg>' },
        { keys: ['coupon', 'discount', 'reward', 'loyalty', 'voucher', 'promo'], label: 'Coupon',
          svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><circle cx="7" cy="7" r="1.5"/></svg>' },
        { keys: ['sweepstakes', 'contest', 'giveaway', 'raffle', 'lottery', 'prize', 'official rules'], label: 'Sweepstakes',
          svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M2 12h20"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>' },
        { keys: ['pet', 'adoption', 'animal', 'shelter', 'veterinary'], label: 'Pet Adoption',
          svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="4" r="2"/><circle cx="4.5" cy="9" r="2"/><circle cx="17.5" cy="9" r="2"/><circle cx="8" cy="14" r="2"/><circle cx="16" cy="14" r="2"/><path d="M12 18c-2.5 2-6 2-6-.5C6 15 9 14 12 17c3-3 6-2 6 .5 0 2.5-3.5 2.5-6 .5z"/></svg>' },
        { keys: ['timeshare', 'vacation', 'resort', 'fractional ownership'], label: 'Timeshare',
          svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>' },
        { keys: ['hackathon', 'waiver', 'liability waiver', 'participation', 'indemnity'], label: 'Waiver',
          svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L9 9l-7 1 5 5-1.5 7L12 18l6.5 4L17 15l5-5-7-1z"/></svg>' }
    ];

    function detectDocIcon(typeStr) {
        if (!typeStr) return null;
        var lower = typeStr.toLowerCase();
        for (var i = 0; i < DOC_TYPE_ICONS.length; i++) {
            var cat = DOC_TYPE_ICONS[i];
            for (var j = 0; j < cat.keys.length; j++) {
                if (lower.indexOf(cat.keys[j]) >= 0) return cat;
            }
        }
        return null;
    }

    var TRICK_DESCRIPTIONS = {
        'Silent Waiver': 'Quietly surrenders your legal rights',
        'Burden Shift': 'Moves proof/action duty onto you',
        'Time Trap': 'Tight deadlines that forfeit your rights',
        'Escape Hatch': 'Drafter can exit, you cannot',
        'Moving Target': 'Terms can change after you agree',
        'Forced Arena': 'Disputes in drafter\'s chosen forum',
        'Phantom Protection': 'Broad coverage eaten by exceptions',
        'Cascade Clause': 'One trigger activates multiple penalties',
        'Sole Discretion': 'Drafter decides everything, no appeal',
        'Liability Cap': 'Limits payout regardless of harm',
        'Reverse Shield': 'You cover their costs, not vice versa',
        'Auto-Lock': 'Auto-renewal with hard cancellation',
        'Content Grab': 'Claims rights over your content/work',
        'Data Drain': 'Expansive hidden data permissions',
        'Penalty Disguise': 'Punitive charges disguised as fees',
        'Gag Clause': 'Prohibits negative reviews or discussion',
        'Scope Creep': 'Vague terms stretch beyond expectations',
        'Ghost Standard': 'References external docs not included'
    };

    var STATUS_MESSAGES = {
        thinking: [
            "Adopting the drafter's perspective...",
            "Reading between the lines...",
            "Tracing cross-references...",
            "Mapping strategic architecture...",
            "Identifying asymmetric language..."
        ],
        clauses: [
            "Analyzing clause by clause...",
            "Flagging strategic language...",
            "Scoring risk levels..."
        ],
        deep: [
            "Analyzing cross-clause interactions...",
            "Revealing the drafter's playbook...",
            "Measuring power imbalance...",
            "Full Verdict coming soon..."
        ]
    };

    // ── Base URL (supports reverse proxy prefix like /flipside) ──
    var BASE_URL = {{ request.script_root | tojson }};

    // ── State ─────────────────────────────────────────────────
    var selectedFile = null;
    var analysisDepth = 'standard';
    var eventSource = null;
    var responseContent = '';
    var renderTimeout = null;
    var quickDone = false;
    var analysisStartTime = 0;
    var elapsedInterval = null;
    var statusRotateInterval = null;
    var currentStatusIdx = 0;
    var isDoneRendering = false;
    var deepTextComplete = false;  // Set when all Opus threads complete
    var _renderedVerdictTags = {};  // Track which verdict tags have been progressively rendered
    var _coreVerdictReady = false;  // Whether core verdict tags (TIER + MAIN_THING) have arrived
    var animatedCardTitles = new Set();
    var activeFilters = new Set(); // 'red', 'yellow', 'green'
    var activeTrickFilters = new Set(); // trick type names
    var documentFullText = '';
    var documentThumbnail = null;
    var documentOcrUsed = false;
    var currentDocId = '';
    var currentFilename = '';  // Module-level filename for rejection screen
    var flipCardsBuilt = false;
    var parsedClauseCount = 0;   // How many --- segments we've already parsed
    var currentCardIndex = 0;    // Which card is currently shown
    var hasFlippedOnce = false;  // Force first flip before allowing navigation
    var cardViewTransitioned = false; // Whether we've transitioned from loading to cards
    var _detectedTricks = {};  // Live trick accumulator: { trickName: count }
    var _quickDoneSafetyTimer = null;  // Safety net: treat cards as built if quick_done is delayed
    var _verdictStripRead = false;  // Whether user has clicked through to verdict (hides strip)
    var _autoRevealTimer = null;   // 10s timer: auto-show verdict if no cards yet
    var _verdictAutoRevealed = false; // Whether verdict was auto-revealed (cards hadn't arrived)
    var _opusThinkingText = '';      // Accumulated Opus thinking content
    var _thinkingViewerOpen = false; // Whether user toggled thinking panel open

    // ── Elements ──────────────────────────────────────────────
    var $ = function(id) { return document.getElementById(id); };
    // Safe event binding — silently skips if element missing
    function on(id, evt, fn) { var el = $(id); if (el) el.addEventListener(evt, fn); }

    // Screens
    var uploadScreen   = $('upload-screen');
    var analysisScreen = $('analysis-screen');

    // Upload elements
    var dropZone       = $('dropZone');
    var fileInput      = $('fileInput');
    var uploadPrompt   = $('uploadPrompt');
    var fileInfo       = $('fileInfo');
    var fileNameEl     = $('fileName');
    var fileSizeEl     = $('fileSize');
    var fileRemove     = $('fileRemove');
    var pasteArea      = $('pasteArea');
    var analyzeBtn     = $('analyzeBtn');
    var uploadError    = $('uploadError');
    var demoGridSection = $('demoGridSection');
    // Shuffle demo tiles so order varies each visit
    (function() {
        var grid = demoGridSection.querySelector('.demo-grid');
        if (!grid) return;
        var tiles = Array.from(grid.children);
        for (var i = tiles.length - 1; i > 0; i--) {
            var j = Math.floor(Math.random() * (i + 1));
            grid.appendChild(tiles[j]);
            tiles[j] = tiles[i];
        }
    })();
    var depthSelector  = $('depthSelector');

    // Analysis elements
    var statusPill     = $('statusPill');
    var statusText     = $('statusText');
    var elapsedEl      = $('elapsedTime');
    var backBtn        = $('backBtn');
    var metadataLine   = $('metadataLine');
    var editorialLoading = $('editorialLoading');
    var capTicker      = $('capabilityTicker');

    // ── Capability ticker: shows what Opus is doing live ──
    var capTickerInterval = null;
    var capTickerIndex = 0;
    var thinkingCharCount = 0;
    var outputCharCount = 0;
    var HAIKU_MESSAGES = [
        { label: 'QUICK SCAN', text: 'Haiku 4.5 reading every clause for trick patterns' },
        { label: 'PATTERN MATCH', text: 'Comparing against 18-type trick taxonomy' },
        { label: 'CLAUSE ISOLATION', text: 'Splitting document into individual obligations' },
        { label: 'RISK RATING', text: 'Scoring severity per clause on 5-point scale' },
    ];
    var OPUS_MESSAGES = [
        { label: 'ADAPTIVE THINKING', text: 'Opus decides reasoning depth per clause' },
        { label: 'LONG-CONTEXT', text: 'Tracing cross-clause interactions across full document' },
        { label: 'PERSPECTIVE SHIFT', text: 'Adopting drafter\u2019s viewpoint to find hidden intent' },
        { label: 'SELF-REVIEW', text: 'Checking own findings for false positives' },
        { label: 'BAD INTENTIONS', text: 'Low over-refusal \u2014 Opus sustains adversarial framing' },
        { label: 'POWER ASYMMETRY', text: 'Counting rights and obligations per party' },
        { label: 'ARCHAEOLOGY', text: 'Separating boilerplate from custom-drafted clauses' },
    ];
    var CAPABILITY_MESSAGES = HAIKU_MESSAGES;
    function startCapTicker(messages) {
        if (messages) CAPABILITY_MESSAGES = messages;
        capTicker.classList.remove('hidden');
        capTickerIndex = 0;
        showCapMessage();
        stopCapTicker();
        capTickerInterval = setInterval(function() {
            capTicker.classList.add('fade-swap');
            setTimeout(function() {
                capTickerIndex = (capTickerIndex + 1) % CAPABILITY_MESSAGES.length;
                showCapMessage();
                capTicker.classList.remove('fade-swap');
            }, 300);
        }, 3500);
    }
    function showCapMessage() {
        var m = CAPABILITY_MESSAGES[capTickerIndex];
        capTicker.innerHTML = '<span class="cap-label">' + m.label + '</span> ' + m.text;
    }
    function stopCapTicker() {
        if (capTickerInterval) { clearInterval(capTickerInterval); capTickerInterval = null; }
    }
    function showCapStats() {
        stopCapTicker();
        // Approximate tokens (~4 chars per token)
        var thinkTokens = Math.round(thinkingCharCount / 4);
        var outTokens = Math.round(outputCharCount / 4);
        var ratio = outTokens > 0 ? (thinkTokens / outTokens).toFixed(1) : '?';
        capTicker.classList.remove('fade-swap');
        capTicker.innerHTML = '<span class="stat-num">~' + thinkTokens.toLocaleString() + '</span> reasoning tokens \u00B7 <span class="stat-num">' + ratio + '\u00d7</span> more thinking than output';
        capTicker.className = 'capability-stats';
    }
    var resultsArea    = $('resultsArea');
    var summaryContainer = $('summaryContainer');
    var filterChips    = $('filterChips');
    var resultsContent = $('resultsContent');
    var flipCardContainer = $('flipCardContainer');
    var deepAnalysisEl = $('deepAnalysisContent');
    var counterDraftSection = $('counterDraftSection');
    var counterDraftBtn = $('counterDraftBtn');
    var counterDraftContent = $('counterDraftContent');
    var timelineBtn = $('timelineBtn');
    var timelineContent = $('timelineContent');
    var followupSection = $('followupSection');
    var followupInput = $('followupInput');
    var followupSend = $('followupSend');
    var followupAnswers = $('followupAnswers');

    // Verdict column (right side panel)
    var verdictCol       = $('verdictCol');
    var verdictTitle     = $('verdictTitle');
    var verdictBody      = $('verdictBody');
    var verdictExpandBtn = $('verdictExpandBtn');
    var _verdictCountdownInterval = null;
    var _verdictCountdownSec = 120;

    function startVerdictCountdown() {
        stopVerdictCountdown();
        _verdictCountdownSec = 120;
        var el = $('verdictCountdown');
        if (el) el.textContent = '2:00';
        _verdictCountdownInterval = setInterval(function() {
            _verdictCountdownSec--;
            if (_verdictCountdownSec <= 0) {
                stopVerdictCountdown();
                if (el) el.textContent = 'almost done';
                return;
            }
            var m = Math.floor(_verdictCountdownSec / 60);
            var s = _verdictCountdownSec % 60;
            if (el) el.textContent = m + ':' + (s < 10 ? '0' : '') + s;
        }, 1000);
    }

    function stopVerdictCountdown() {
        if (_verdictCountdownInterval) {
            clearInterval(_verdictCountdownInterval);
            _verdictCountdownInterval = null;
        }
    }
    // Opus verdict + 5 deep dives stream in parallel from t=0
    var opusSections = {
        overall: { text: '', done: false }
    };
    var DEEP_DIVE_SOURCES = ['archaeology', 'scenario', 'walkaway', 'combinations', 'playbook'];
    // Deep dive state — all 5 stream from the main SSE connection (parallel with verdict)
    var deepDiveResults = {};
    DEEP_DIVE_SOURCES.forEach(function(s) { deepDiveResults[s] = { text: '', done: false }; });


    // Configure marked + DOMPurify for safe LLM output rendering
    marked.setOptions({ breaks: true, gfm: true });
    function safeMd2Html(md) {
        return DOMPurify.sanitize(marked.parse(md));
    }
    function safeHtml(html) {
        // Re-sanitize after post-DOMPurify regex transforms (style functions)
        return DOMPurify.sanitize(html);
    }

    // ── Event delegation for flip cards + card navigation ──
    document.querySelector('.content-col').addEventListener('click', function(e) {
        // Confidence badge: toggle reason text on tap (mobile touch equivalent of hover)
        var badge = e.target.closest('.confidence-badge');
        if (badge) {
            badge.classList.toggle('touch-open');
            return;
        }
        var flipTrigger = e.target.closest('.flip-trigger');
        if (flipTrigger) {
            var card = flipTrigger.closest('.flip-card');
            if (card) {
                // Back is already built by Haiku — just flip
                requestAnimationFrame(function() {
                    card.classList.add('flipped');
                    // Dim side columns to focus on the reveal
                    var layout = card.closest('.analysis-layout');
                    if (layout) layout.classList.add('layout-flipped');
                    // Animate score bar fill on flip
                    var fill = card.querySelector('.back-score-bar-fill');
                    if (fill && !fill.style.width) {
                        var w = fill.getAttribute('data-width');
                        setTimeout(function() { fill.style.width = w + '%'; }, 300);
                    }
                });
                // First flip unlocks navigation (immediate, no need to defer)
                if (!hasFlippedOnce) {
                    hasFlippedOnce = true;
                    updateCardNavigation();
                    document.querySelectorAll('.flip-trigger.hint-pulse').forEach(function(el) {
                        el.classList.remove('hint-pulse');
                    });
                    document.querySelectorAll('.flip-hint-tooltip').forEach(function(el) {
                        el.remove();
                    });
                    // Verdict column stays hidden — inline verdict below cards (Problem 3)
                    // Data continues streaming into opusSections for inline rendering
                    updateVerdictStrip();
                }
            }
            return;
        }
        var flipBack = e.target.closest('.flip-back-trigger');
        if (flipBack) {
            var card = flipBack.closest('.flip-card');
            if (card) {
                card.classList.remove('flipped');
                // Restore side columns
                var layout = card.closest('.analysis-layout');
                if (layout) layout.classList.remove('layout-flipped');
            }
            return;
        }
        var bottomNext = e.target.closest('.card-bottom-next');
        if (bottomNext) {
            var cards = flipCardContainer.querySelectorAll('.flip-card');
            if (currentCardIndex >= cards.length - 1) {
                // Last card — go to verdict
                revealDeepAnalysis(true);
                dismissVerdictStrip();
                exitFocusedMode();
            } else {
                showCardAtIndex(currentCardIndex + 1);
            }
            return;
        }
        var findInDoc = e.target.closest('.find-in-doc');
        if (findInDoc) {
            var cardIdx = parseInt(findInDoc.getAttribute('data-card-index'));
            if (!isNaN(cardIdx)) {
                scrollPreviewToCard(cardIdx);
                // On mobile (sidebar stacked above), scroll page to the preview
                var previewEl = $('editorialLoadingText');
                if (previewEl && window.innerWidth <= 900) {
                    previewEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
            return;
        }
        var navPrev = e.target.closest('.card-nav-prev');
        if (navPrev && !navPrev.disabled) {
            showCardAtIndex(currentCardIndex - 1);
            return;
        }
        var navNext = e.target.closest('.card-nav-next');
        if (navNext && !navNext.disabled) {
            if (navNext.getAttribute('data-action') === 'assessment') {
                revealDeepAnalysis(true);
            } else {
                showCardAtIndex(currentCardIndex + 1);
            }
            return;
        }
        // verdict-link buttons removed — verdict now triggered via card navigation only
    });

    // ── Click clause marker in preview → navigate to that card ──
    on('editorialLoadingText', 'click', function(e) {
        var highlight = e.target.closest('.doc-highlight');
        if (highlight) {
            var idx = parseInt(highlight.getAttribute('data-card-index'));
            if (!isNaN(idx) && flipCardContainer.querySelectorAll('.flip-card').length > idx) {
                showCardAtIndex(idx);
                // Auto-flip to back if user has already discovered the flip mechanic (Problem 4)
                if (hasFlippedOnce) {
                    var cards = flipCardContainer.querySelectorAll('.flip-card');
                    if (cards[idx]) {
                        setTimeout(function() {
                            cards[idx].classList.add('flipped');
                            var layout = cards[idx].closest('.analysis-layout');
                            if (layout) layout.classList.add('layout-flipped');
                        }, 400);
                    }
                }
            }
        }
    });

    // ── Tricks detected bar: removed from card nav (lives in verdict now) ──

    // ── Keyboard navigation ──
    document.addEventListener('keydown', function(e) {
        if (analysisScreen.classList.contains('hidden')) return;
        // Don't capture keys when user is typing in an input/textarea
        var ae = document.activeElement;
        if (ae && (ae.tagName === 'INPUT' || ae.tagName === 'TEXTAREA' || ae.isContentEditable)) return;
        var viewport = $('cardViewport');
        if (!viewport || viewport.classList.contains('hidden')) return;
        var cards = flipCardContainer.querySelectorAll('.flip-card');
        if (cards.length === 0) return;

        switch(e.key) {
            case 'ArrowLeft':
                if (currentCardIndex > 0) {
                    e.preventDefault();
                    showCardAtIndex(currentCardIndex - 1);
                }
                break;
            case 'ArrowRight':
                if (currentCardIndex < cards.length - 1) {
                    e.preventDefault();
                    showCardAtIndex(currentCardIndex + 1);
                }
                break;
            case ' ':
            case 'Enter':
                e.preventDefault();
                if (cards[currentCardIndex]) {
                    cards[currentCardIndex].classList.toggle('flipped');
                    var kbLayout = flipCardContainer.closest('.analysis-layout');
                    if (cards[currentCardIndex].classList.contains('flipped')) {
                        if (kbLayout) kbLayout.classList.add('layout-flipped');
                        // Animate score bar on flip
                        var fill = cards[currentCardIndex].querySelector('.back-score-bar-fill');
                        if (fill && !fill.style.width) {
                            var w = fill.getAttribute('data-width');
                            setTimeout(function() { fill.style.width = w + '%'; }, 300);
                        }
                        if (!hasFlippedOnce) {
                            hasFlippedOnce = true;
                            updateCardNavigation();
                            // Verdict column stays hidden — inline verdict below cards (Problem 3)
                            updateVerdictStrip();
                        }
                    } else {
                        if (kbLayout) kbLayout.classList.remove('layout-flipped');
                    }
                }
                break;
            default:
                // Number keys 1-9 → jump to that card
                var num = parseInt(e.key);
                if (num >= 1 && num <= 9 && num <= cards.length) {
                    e.preventDefault();
                    showCardAtIndex(num - 1);
                }
                break;
        }
    });

    // ── Mobile: Bottom sheet for verdict (Phase 2) ──────────────
    (function() {
        var vc = $('verdictCol');
        if (!vc) return;
        var sheetState = 'peek'; // peek | half | full
        var startY = 0, startTime = 0, currentY = 0, isDragging = false;

        function setSheetState(state) {
            sheetState = state;
            vc.classList.remove('sheet-half', 'sheet-full');
            if (state === 'half') vc.classList.add('sheet-half');
            else if (state === 'full') vc.classList.add('sheet-full');
            if (state === 'full') {
                document.body.classList.add('sheet-open');
            } else {
                document.body.classList.remove('sheet-open');
            }
        }
        var header = vc.querySelector('.verdict-header');
        if (header) {
            header.addEventListener('touchstart', function(e) {
                startY = e.touches[0].clientY;
                startTime = Date.now();
                isDragging = true;
                vc.style.transition = 'none';
            }, {passive: true});

            header.addEventListener('touchmove', function(e) {
                if (!isDragging) return;
                currentY = e.touches[0].clientY;
                var dy = currentY - startY;
                // Apply drag transform as offset from current state
                var baseTranslate;
                if (sheetState === 'peek') baseTranslate = 'calc(100% - 52px)';
                else if (sheetState === 'half') baseTranslate = '60%';
                else baseTranslate = '10%';
                // Use a simple pixel offset from current position
                if (dy !== 0) {
                    vc.style.transform = 'translateY(calc(' + baseTranslate + ' + ' + dy + 'px))';
                }
            }, {passive: true});

            header.addEventListener('touchend', function() {
                if (!isDragging) return;
                isDragging = false;
                vc.style.transition = '';
                vc.style.transform = '';
                var dy = currentY - startY;
                var threshold = 80;
                if (dy < -threshold) {
                    // Swipe up → advance state
                    if (sheetState === 'peek') setSheetState('half');
                    else if (sheetState === 'half') setSheetState('full');
                } else if (dy > threshold) {
                    // Swipe down → regress state
                    if (sheetState === 'full') setSheetState('half');
                    else if (sheetState === 'half') setSheetState('peek');
                }
            }, {passive: true});

            // Tap header → toggle peek/half
            header.addEventListener('click', function() {
                if (sheetState === 'peek') setSheetState('half');
                else setSheetState('peek');
            });
        }
    })();

    // ── Mobile: Swipe card navigation (Phase 3) ──────────────
    (function() {
        var viewport = $('cardViewport');
        if (!viewport) return;
        var swipeStartX = 0, swipeStartY = 0, swipeStartTime = 0;

        viewport.addEventListener('touchstart', function(e) {
            swipeStartX = e.touches[0].clientX;
            swipeStartY = e.touches[0].clientY;
            swipeStartTime = Date.now();
        }, {passive: true});

        viewport.addEventListener('touchend', function(e) {
            if (window.innerWidth > 900) return;
            if (!hasFlippedOnce) return;
            var dx = e.changedTouches[0].clientX - swipeStartX;
            var dy = e.changedTouches[0].clientY - swipeStartY;
            var dt = Date.now() - swipeStartTime;
            // Must be horizontal swipe: >50px, <80px vertical drift, <400ms
            if (Math.abs(dx) > 50 && Math.abs(dy) < 80 && dt < 400) {
                var cards = flipCardContainer.querySelectorAll('.flip-card');
                if (dx < 0 && currentCardIndex < cards.length - 1) {
                    showCardAtIndex(currentCardIndex + 1);
                } else if (dx > 0 && currentCardIndex > 0) {
                    showCardAtIndex(currentCardIndex - 1);
                }
            }
        }, {passive: true});
    })();

    // ── Mobile: Sidebar expand/collapse (Phase 4) ─────────────
    (function() {
        var sidebar = $('analysisSidebar');
        var profile = $('sidebarProfile');
        if (!sidebar || !profile) return;
        profile.addEventListener('click', function() {
            if (window.innerWidth > 900) return;
            sidebar.classList.toggle('expanded');
        });
    })();

    // ── Mobile: Header overflow menu (Phase 5) ────────────────
    var _faqCameFromAnalysis = false;
    (function() {
        var btn = $('headerOverflowBtn');
        var menu = $('headerOverflowMenu');
        if (!btn || !menu) return;
        btn.addEventListener('click', function(e) {
            e.stopPropagation();
            menu.classList.toggle('hidden');
            btn.setAttribute('aria-expanded', !menu.classList.contains('hidden'));
        });
        document.addEventListener('click', function() {
            menu.classList.add('hidden');
            btn.setAttribute('aria-expanded', 'false');
        });
        // Wire overflow menu buttons to their real counterparts
        menu.querySelectorAll('button').forEach(function(item) {
            item.addEventListener('click', function() {
                var action = item.getAttribute('data-action');
                var target;
                if (action === 'faq') {
                    // Show FAQ on upload screen, remember we came from analysis
                    _faqCameFromAnalysis = true;
                    var us = $('upload-screen');
                    var as = $('analysis-screen');
                    if (us) us.classList.remove('hidden');
                    if (as) as.classList.add('hidden');
                    var fw = $('faqWrapper');
                    var um = $('uploadMain');
                    if (fw) fw.classList.remove('hidden');
                    if (um) um.classList.add('has-faq');
                    var faqTarget = document.querySelector('#faq-what');
                    if (faqTarget) setTimeout(function() { faqTarget.scrollIntoView({ behavior: 'smooth', block: 'start' }); }, 100);
                    menu.classList.add('hidden');
                    return;
                }
                if (action === 'copy') target = $('copyAllBtn');
                else if (action === 'email') target = $('emailLawyerBtn');
                else if (action === 'export') target = $('exportBtn');
                else if (action === 'exportLang') target = $('exportLangBtn');
                if (target) target.click();
                menu.classList.add('hidden');
            });
        });
    })();

    // ── Sync overflow menu items with real header buttons ────
    function syncOverflowMenu() {
        var menu = $('headerOverflowMenu');
        if (!menu) return;
        var map = {copy: 'copyAllBtn', email: 'emailLawyerBtn', export: 'exportBtn', exportLang: 'exportLangBtn'};
        menu.querySelectorAll('button').forEach(function(item) {
            var real = $(map[item.getAttribute('data-action')]);
            if (real && !real.classList.contains('hidden')) {
                item.classList.remove('hidden');
                if (item.getAttribute('data-action') === 'exportLang') {
                    item.textContent = real.textContent;
                }
            }
        });
    }

    // ── Helpers ───────────────────────────────────────────────
    function formatSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    function escapeHtml(str) {
        var div = document.createElement('div');
        div.appendChild(document.createTextNode(str));
        return div.innerHTML;
    }

    function showError(msg) {
        var headline = 'This document couldn\u2019t be processed';
        if (/unsupported/i.test(msg)) headline = 'Unsupported file type';
        else if (/no file|no text/i.test(msg)) headline = 'Nothing to analyze';
        else if (/could not extract/i.test(msg)) headline = 'No readable text found';
        else if (/internal error/i.test(msg)) headline = 'Something went wrong';
        uploadError.innerHTML =
            '<div class="upload-error-icon">\uD83D\uDCC4</div>' +
            '<div class="upload-error-headline">' + escapeHtml(headline) + '</div>' +
            '<div class="upload-error-detail">' + escapeHtml(msg) + '</div>' +
            '<button class="upload-error-tryagain" onclick="this.closest(\'.upload-error\').classList.add(\'hidden\')">Dismiss</button>';
        uploadError.classList.remove('hidden');
    }

    function updateAnalyzeBtn() {
        var hasFile = selectedFile !== null;
        var hasText = pasteArea.value.trim().length > 0;
        var ready = hasFile || hasText;
        analyzeBtn.disabled = !ready;
        // Show/hide depth selector; toggle demo grid; button always visible
        if (ready) {
            depthSelector.classList.remove('hidden');
            demoGridSection.classList.add('hidden');
        } else {
            depthSelector.classList.add('hidden');
            demoGridSection.classList.remove('hidden');
        }
    }

    // ── Hero flip card demo ──────────────────────────────────
    var heroFlipCard = $('heroFlipCard');
    var heroFlipNudge = $('heroFlipNudge');
    var _heroAutoFlipTimer = null;
    var _heroUserFlipped = false;
    function stopHeroAutoFlip() {
        _heroUserFlipped = true;
        if (_heroAutoFlipTimer) { clearTimeout(_heroAutoFlipTimer); _heroAutoFlipTimer = null; }
    }
    function startHeroAutoFlip() {
        if (!heroFlipCard || _heroUserFlipped) return;
        // Auto-flip cycle: show front 4s → flip to back 3s → flip to front → repeat
        _heroAutoFlipTimer = setTimeout(function autoFlip() {
            if (_heroUserFlipped) return;
            heroFlipCard.classList.add('flipped');
            _heroAutoFlipTimer = setTimeout(function() {
                if (_heroUserFlipped) return;
                heroFlipCard.classList.remove('flipped');
                _heroAutoFlipTimer = setTimeout(autoFlip, 4000);
            }, 3000);
        }, 4000);
    }
    if (heroFlipCard) {
        heroFlipCard.addEventListener('click', function() {
            stopHeroAutoFlip();
            heroFlipCard.classList.toggle('flipped');
            if (heroFlipNudge) heroFlipNudge.classList.add('hidden');
        });
        heroFlipCard.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                stopHeroAutoFlip();
                heroFlipCard.classList.toggle('flipped');
                if (heroFlipNudge) heroFlipNudge.classList.add('hidden');
            }
        });
        startHeroAutoFlip();
    }

    // ── Drag-and-drop (single) ────────────────────────────────
    dropZone.addEventListener('click', function() { fileInput.click(); });
    dropZone.addEventListener('dragover', function(e) { e.preventDefault(); dropZone.classList.add('dragover'); });
    dropZone.addEventListener('dragleave', function() { dropZone.classList.remove('dragover'); });
    dropZone.addEventListener('drop', function(e) {
        e.preventDefault(); dropZone.classList.remove('dragover');
        if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
    });
    fileInput.addEventListener('change', function() {
        if (fileInput.files.length) handleFile(fileInput.files[0]);
    });

    function handleFile(file) {
        var ext = file.name.split('.').pop().toLowerCase();
        var isImage = file.type && file.type.startsWith('image/');
        if (['pdf', 'docx', 'txt', 'text', 'md', 'jpg', 'jpeg', 'png', 'webp'].indexOf(ext) === -1 && !isImage) {
            showError('Unsupported file type. Please use PDF, DOCX, TXT, or a photo.');
            return;
        }
        selectedFile = file;
        uploadError.classList.add('hidden'); // Clear any previous error
        fileNameEl.textContent = file.name;
        fileSizeEl.textContent = formatSize(file.size);
        uploadPrompt.classList.add('hidden');
        fileInfo.classList.remove('hidden');
        // Show image thumbnail preview
        if (isImage || ['jpg','jpeg','png','webp'].indexOf(ext) !== -1) {
            var reader = new FileReader();
            reader.onload = function(e) {
                var preview = document.getElementById('imagePreview');
                if (!preview) {
                    preview = document.createElement('img');
                    preview.id = 'imagePreview';
                    preview.style.cssText = 'max-width:120px;max-height:160px;border-radius:8px;margin-top:8px;object-fit:cover;border:1px solid var(--border);';
                    fileInfo.appendChild(preview);
                }
                preview.src = e.target.result;
                preview.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        } else {
            var preview = document.getElementById('imagePreview');
            if (preview) preview.classList.add('hidden');
        }
        pasteArea.classList.add('hidden');
        pasteArea.value = '';
        // Expand drop zone full-width, hide other methods
        var md = $('methodDrop');
        if (md) md.classList.add('active-input');
        var mp = $('methodPaste');
        if (mp) mp.classList.add('hidden');
        var mde = $('methodDemo');
        if (mde) mde.classList.add('hidden');
        updateAnalyzeBtn();
    }

    fileRemove.addEventListener('click', function(e) {
        e.preventDefault(); e.stopPropagation();
        selectedFile = null; fileInput.value = '';
        fileInfo.classList.add('hidden');
        var preview = document.getElementById('imagePreview');
        if (preview) preview.classList.add('hidden');
        uploadPrompt.classList.remove('hidden');
        // Reset grid back to 3 columns
        resetUploadMethods();
        updateAnalyzeBtn();
    });

    // ── 3-column input method toggles ─────────────────────────────────
    var methodPaste = $('methodPaste');
    var uploadMethods = $('uploadMethods');

    function resetUploadMethods() {
        // Collapse all methods back to 3-column grid
        var methods = uploadMethods.querySelectorAll('.upload-method');
        for (var i = 0; i < methods.length; i++) {
            methods[i].classList.remove('active-input', 'hidden');
        }
        pasteArea.classList.add('hidden');
        pasteArea.value = '';
    }

    // Click on "Paste text" zone → expand to full-width textarea
    if (methodPaste) {
        var pasteZone = $('pasteZone');
        if (pasteZone) pasteZone.addEventListener('click', function() {
            resetUploadMethods();
            methodPaste.classList.add('active-input');
            $('methodDrop').classList.add('hidden');
            var methodDemo = $('methodDemo');
            if (methodDemo) methodDemo.classList.add('hidden');
            pasteArea.classList.remove('hidden');
            pasteArea.focus();
            if (selectedFile) { selectedFile = null; fileInput.value = ''; fileInfo.classList.add('hidden'); uploadPrompt.classList.remove('hidden'); }
            updateAnalyzeBtn();
        });
    }

    // Click on "Try a demo" zone → pick random sample and launch
    var demoZone = $('demoZone');
    if (demoZone) {
        var SAMPLE_KEYS = ['lease','insurance','tos','employment','loan','gym','medical','hoa','coupon','wedding','pet','sweepstakes','timeshare','hackathon'];
        demoZone.addEventListener('click', function() {
            var pick = SAMPLE_KEYS[Math.floor(Math.random() * SAMPLE_KEYS.length)];
            startSampleAnalysis(pick);
        });
    }

    // Escape or empty → reset to 3-column grid
    pasteArea.addEventListener('input', updateAnalyzeBtn);
    pasteArea.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') { resetUploadMethods(); updateAnalyzeBtn(); }
    });
    // ── Depth selector ────────────────────────────────────────
    depthSelector.addEventListener('click', function(e) {
        var btn = e.target.closest('.depth-btn');
        if (!btn) return;
        depthSelector.querySelectorAll('.depth-btn').forEach(function(b) { b.classList.remove('active'); });
        btn.classList.add('active');
        analysisDepth = btn.getAttribute('data-depth');
    });

    // ── Demo grid tile clicks ───────────────────────────────────
    demoGridSection.addEventListener('click', function(e) {
        // Expand button
        if (e.target.id === 'demoGridExpand') {
            var grid = demoGridSection.querySelector('.demo-grid');
            if (grid) grid.classList.add('expanded');
            e.target.style.display = 'none';
            return;
        }
        var tile = e.target.closest('.demo-tile');
        if (!tile) return;
        startSampleAnalysis(tile.getAttribute('data-sample') || 'lease');
    });

    function startSampleAnalysis(sampleType) {
        analyzeBtn.disabled = true;
        analyzeBtn.textContent = 'Loading...';

        fetch(BASE_URL + '/sample', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ depth: analysisDepth, type: sampleType || 'lease' })
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.error) { showError(data.error); analyzeBtn.disabled = false; analyzeBtn.textContent = 'Flip it'; return; }
            documentFullText = (data.full_text || '').replace(/\n*— Page \d+ —\n*/g, '\n\n');
            documentThumbnail = data.thumbnail || null;
            documentOcrUsed = false;
            switchToAnalysis(data.doc_id, data.filename);
        })
        .catch(function(err) {
            showError('Failed to load sample: ' + err.message);
            analyzeBtn.disabled = false;
            analyzeBtn.textContent = 'Flip it';
        });
    }

    // ── Upload & analyze ──────────────────────────────────────
    analyzeBtn.addEventListener('click', function() {
        startAnalysis();
    });

    function startAnalysis() {
        var formData = new FormData();
        if (selectedFile) {
            formData.append('file', selectedFile);
        } else if (pasteArea.value.trim()) {
            formData.append('text', pasteArea.value.trim());
        } else {
            showError('Please select a file or paste text.');
            return;
        }
        formData.append('depth', analysisDepth);

        analyzeBtn.disabled = true;
        analyzeBtn.textContent = 'Uploading...';

        fetch(BASE_URL + '/upload', { method: 'POST', body: formData })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.error) { showError(data.error); analyzeBtn.disabled = false; analyzeBtn.textContent = 'Flip it'; return; }
                documentFullText = (data.full_text || '').replace(/\n*— Page \d+ —\n*/g, '\n\n');
                documentThumbnail = data.thumbnail || null;
                documentOcrUsed = !!data.ocr_used;
                switchToAnalysis(data.doc_id, data.filename);
            })
            .catch(function(err) {
                showError('Upload failed: ' + err.message);
                analyzeBtn.disabled = false;
                analyzeBtn.textContent = 'Flip it';
            });
    }

    // ── Switch to analysis screen ─────────────────────────────
    function switchToAnalysis(docId, filename) {
        // Clean up timers from any previous analysis

        // Reset state
        responseContent = '';
        quickDone = false;
        isDoneRendering = false;
        deepTextComplete = false;
        _verdictStripRead = false;
        _currentStripState = 'building';
        _pendingStripState = null;
        _renderedVerdictTags = {};
        _coreVerdictReady = false;
        resetThinkingViewer();
        animatedCardTitles = new Set();
        activeFilters = new Set();
        flipCardsBuilt = false;
        parsedClauseCount = 0;
        currentCardIndex = 0;
        _sseRetryCount = 0;
        hasFlippedOnce = false;
        cardViewTransitioned = false;
        clauseHighlightData = [];
        _highlightsRenderedUpTo = -1;
        documentNotApplicable = '';
        detectedDocLanguage = '';
        $('exportLangBtn').classList.add('hidden');
        currentDocId = docId;
        currentFilename = filename || '';
        thinkingCharCount = 0;
        outputCharCount = 0;
        stopCapTicker();
        capTicker.className = 'capability-ticker hidden';
        capTicker.innerHTML = '';

        // Reset deep dive state (all 5 stream inline now)
        DEEP_DIVE_SOURCES.forEach(function(s) {
            deepDiveResults[s] = { text: '', done: false };
        });
        opusSections.overall = { text: '', done: false };

        // Verdict column: hidden until verdict is ready — cards are the focus
        resetVerdictCol();

        // Reset verdict progress strip
        var vStrip = $('verdictProgressStrip');
        if (vStrip) {
            vStrip.classList.remove('visible');
            vStrip.querySelectorAll('.verdict-strip-dot').forEach(function(d) { d.classList.remove('done'); });
            $('verdictStripBuilding').classList.remove('hidden');
            $('verdictStripPeek').classList.add('hidden');
            $('verdictStripReady').classList.add('hidden');
            $('verdictStripText').textContent = 'Expert analyzing\u2026';
        }

        // Reset UI
        var rejScreen = $('rejectionScreen');
        if (rejScreen) rejScreen.remove();
        resultsContent.innerHTML = '';
        flipCardContainer.innerHTML = '';
        $('skeletonCard').classList.add('hidden');
        var ct = $('chapterTitle');
        if (ct) ct.classList.remove('visible');
        deepAnalysisEl.innerHTML = '';
        // Remove the deep analysis header (sibling) if it exists
        var oldHeader = deepAnalysisEl.previousElementSibling;
        if (oldHeader && oldHeader.classList.contains('deep-analysis-header')) {
            oldHeader.remove();
        }
        summaryContainer.innerHTML = '';
        filterChips.innerHTML = '';
        filterChips.classList.add('hidden');
        activeFilters.clear();
        activeTrickFilters.clear();
        followupSection.classList.add('hidden');
        followupAnswers.innerHTML = '';
        followupInput.value = '';
        counterDraftSection.classList.add('hidden');
        counterDraftContent.innerHTML = '';
        counterDraftBtn.disabled = false;
        counterDraftBtn.textContent = 'Generate Counter-Draft';
        timelineContent.innerHTML = '';
        timelineBtn.disabled = false;
        timelineBtn.textContent = 'Worst-Case Timeline';
        $('deepAnalysisSection').classList.add('hidden');
        metadataLine.classList.add('hidden');
        metadataLine.classList.remove('visible');
        metadataLine.innerHTML = '';
        statusPill.classList.remove('done');
        statusText.textContent = 'Starting analysis...';
        // Hide model badge during analysis to reduce visual noise
        var modelBadge = document.querySelector('.model-badge');
        if (modelBadge) modelBadge.classList.add('hidden');
        resultsArea.classList.add('hidden');
        $('cardViewport').classList.add('hidden');
        $('cardNavigation').classList.add('hidden');
        $('copyAllBtn').classList.add('hidden');
        $('exportBtn').classList.add('hidden');
        $('emailLawyerBtn').classList.add('hidden');
        backBtn.classList.remove('hidden');
        // Reset new UI elements
        $('eduReviewPill').classList.add('hidden');
        $('cardNavSticky').classList.remove('visible');
        // riskSummaryStrip removed from DOM — lives in verdict only
        // tricksDetectedBar removed from DOM — lives in verdict only
        $('cardNavPips').innerHTML = '';
        $('inlineVerdict').classList.remove('visible');
        $('inlineVerdictContent').innerHTML = '';
        $('inlineVerdictProgress').classList.add('hidden');
        $('cardsReadyPill').classList.add('hidden');
        _detectedTricks = {};
        if (_quickDoneSafetyTimer) { clearTimeout(_quickDoneSafetyTimer); _quickDoneSafetyTimer = null; }
        if (_autoRevealTimer) { clearTimeout(_autoRevealTimer); _autoRevealTimer = null; }
        _verdictAutoRevealed = false;
        document.title = _originalTitle;

        // Document title hero — bridges visual weight from upload screen
        var heroEl = $('docTitleHero');
        if (heroEl) {
            var displayName = (currentFilename || 'Document').replace(/\.[^.]+$/, '').replace(/[_-]/g, ' ');
            $('docTitleText').textContent = displayName;
            $('docTitleFlag').classList.add('hidden');
            $('docTitleFlag').textContent = '';
            heroEl.classList.remove('hidden');
        }

        // Show investigation loading screen while waiting for first clause
        var skeleton = $('skeletonCard');
        skeleton.classList.remove('hidden');
        // Restore elements (may have been hidden by "no cards" fallback or woosh)
        skeleton.classList.remove('wooshing');
        var investigationDoc = skeleton.querySelector('.investigation-doc');
        if (investigationDoc) {
            investigationDoc.style.display = '';
            investigationDoc.classList.remove('woosh-to-sidebar');
        }
        var phasesEl = skeleton.querySelector('.investigation-phases');
        if (phasesEl) phasesEl.style.display = '';
        var statusElSk = skeleton.querySelector('.skeleton-status');
        if (statusElSk) statusElSk.style.display = '';
        var skMsg = $('skeletonMessage');
        if (skMsg) { skMsg.classList.add('hidden'); skMsg.innerHTML = ''; }
        // Reset investigation phases
        var phase1 = $('investPhase1'), phase2 = $('investPhase2'), phase3 = $('investPhase3');
        if (phase1) { phase1.className = 'investigation-phase active'; }
        if (phase2) { phase2.className = 'investigation-phase active'; }
        if (phase3) { phase3.className = 'investigation-phase active'; }
        var _pulsingSmall = '<span class="pulsing-dots" style="transform:scale(0.6)"><span></span><span></span><span></span></span> ';
        var p1s = $('investPhase1Status'), p2s = $('investPhase2Status'), p3s = $('investPhase3Status');
        if (p1s) p1s.innerHTML = _pulsingSmall + 'Scanning...';
        if (p2s) p2s.innerHTML = _pulsingSmall + 'Scanning...';
        if (p3s) p3s.innerHTML = _pulsingSmall + '~2 min';
        var skStatusTxt = $('skeletonStatusText');
        if (skStatusTxt) skStatusTxt.textContent = 'Reading the fine print';
        // Reset expert mind panel
        resetExpertMind();
        // Populate investigation document text with real content
        var investTextEl = $('investigationText');
        if (investTextEl) {
            investTextEl.textContent = documentFullText || '';
            investTextEl.style.transform = 'translateY(0)';
        }
        var ocrBanner = $('ocrBanner');
        if (ocrBanner) ocrBanner.classList.toggle('hidden', !documentOcrUsed);
        $('cardViewport').classList.remove('hidden');
        resultsArea.classList.remove('hidden');

        // Sidebar: prepare content (collapsed — expands after screen switch)
        var sidebar = $('analysisSidebar');
        var thumbEl = $('docThumbnail');
        var thumbImg = $('docThumbnailImg');
        var layoutEl = document.querySelector('.analysis-layout');
        var hasSidebar = !!documentFullText;
        layoutEl.classList.remove('sidebar-visible');
        if (hasSidebar) {
            sidebar.classList.remove('hidden');
            if (documentThumbnail) {
                thumbImg.src = 'data:image/jpeg;base64,' + documentThumbnail;
                thumbEl.classList.remove('hidden');
                // Also set verdict column thumbnail
                var vThumb = $('verdictDocThumb');
                var vThumbImg = $('verdictDocThumbImg');
                if (vThumbImg) {
                    vThumbImg.src = thumbImg.src;
                    vThumb.classList.remove('hidden');
                }
            } else {
                thumbEl.classList.add('hidden');
            }
            // Text preview — show immediately so user sees the full layout
            var loadingEl = $('editorialLoading');
            var loadingText = $('editorialLoadingText');
            loadingText.innerHTML = escapeHtml(documentFullText);
            loadingEl.classList.remove('hidden');
            loadingEl.classList.remove('woosh-in-sidebar');
        } else {
            sidebar.classList.add('hidden');
            thumbEl.classList.add('hidden');
            $('editorialLoading').classList.add('hidden');
        }

        // ── Animated screen transition: fade out upload, then expand ──
        uploadScreen.classList.add('exiting');
        setTimeout(function() {
            uploadScreen.classList.add('hidden');
            uploadScreen.classList.remove('exiting');
            analysisScreen.classList.remove('hidden');
            window.scrollTo({ top: 0 });
            // Start scroll AFTER analysis screen is visible (scrollHeight needs layout)
            startInvestigationScroll();
            // Sidebar stays hidden during investigation loading screen
            // — revealed in transitionToCardView() when first card arrives
        }, 350);

        // Start elapsed timer
        analysisStartTime = Date.now();
        if (elapsedInterval) clearInterval(elapsedInterval);
        elapsedInterval = setInterval(function() {
            var secs = Math.floor((Date.now() - analysisStartTime) / 1000);
            var min = Math.floor(secs / 60);
            var sec = secs % 60;
            elapsedEl.textContent = (min > 0 ? min + 'm ' : '') + sec + 's';
        }, 1000);

        connectStream(docId);
    }

    // ── SSE streaming ─────────────────────────────────────────
    var _sseRetryCount = 0;
    var _sseMaxRetries = 2;
    function connectStream(docId) {
        eventSource = new EventSource(BASE_URL + '/analyze/' + docId);

        // ── Auto-reveal: if no cards after 10s, show verdict early ──
        if (_autoRevealTimer) clearTimeout(_autoRevealTimer);
        _autoRevealTimer = setTimeout(function() {
            _autoRevealTimer = null;
            // Only trigger if cards haven't arrived yet and Opus has content
            if (!cardViewTransitioned && !flipCardsBuilt && opusSections.overall.text.length > 50) {
                console.log('[FlipSide] Auto-reveal: no cards after 10s, showing verdict');
                _verdictAutoRevealed = true;
                var skStatusTxt = $('skeletonStatusText');
                if (skStatusTxt) skStatusTxt.textContent = 'Cards building \u2014 showing verdict';
                revealDeepAnalysis(true);
            }
        }, 10000);

        eventSource.onmessage = function(e) {
            var msg;
            try { msg = JSON.parse(e.data); } catch(err) { return; }

            switch (msg.type) {
                case 'phase':
                    handlePhase(msg.content);
                    break;

                case 'clause_preview':
                    var cp = {};
                    try { cp = JSON.parse(msg.content); } catch(_) {}
                    if (cp.title) {
                        var cpCount = (cp.index || 0) + 1;
                        var cpLabel = cp.title;
                        if (cp.section) cpLabel += ' (' + cp.section + ')';
                        setInvestPhase(1, 'active', cpCount + ' found: ' + cpLabel);
                        showBriefingSentence('Found: ' + cp.title);
                    }
                    break;

                case 'doc_context':
                    var dc = {};
                    try { dc = JSON.parse(msg.content); } catch(_) {}
                    renderDocContext(dc);
                    break;

                case 'thinking_start':
                    if (!quickDone) {
                        startStatusRotation('thinking');
                        startCapTicker(HAIKU_MESSAGES);
                    }
                    break;

                case 'thinking':
                    thinkingCharCount += msg.content.length;
                    break;

                case 'thinking_done':
                    break;

                case 'text_start':
                    resultsArea.classList.remove('hidden');
                    break;

                case 'text':
                    if (resultsArea.classList.contains('hidden')) {
                        resultsArea.classList.remove('hidden');
                    }
                    responseContent += msg.content;
                    outputCharCount += msg.content.length;
                    renderResults();
                    break;

                case 'text_done':
                    renderResultsFinal();
                    break;

                case 'tool_start':
                    break;

                case 'tool_result':
                    break;

                case 'handoff':
                    var hoData = {};
                    try { hoData = JSON.parse(msg.content); } catch(_) {}
                    if (hoData.not_applicable) {
                        statusText.textContent = 'Document scanned — no terms to analyze';
                        statusPill.classList.add('done');
                        stopStatusRotation();
                
                        stopCapTicker();
                        capTicker.classList.add('hidden');
                    } else {
                        statusText.textContent = 'Cards ready — Opus expert report building...';
                        startStatusRotation('deep');
                        startCapTicker(OPUS_MESSAGES);
                        // Phase 1 done once Haiku hands off to card extraction
                        setInvestPhase(1, 'done', '\u2713 Done');
                        setInvestPhase(2, 'active', '<span class="pulsing-dots" style="transform:scale(0.6)"><span></span><span></span><span></span></span> Building cards...');
                    }
                    break;

                case 'quick_done':
                    quickDone = true; window._quickDone = true;
                    if (_quickDoneSafetyTimer) { clearTimeout(_quickDoneSafetyTimer); _quickDoneSafetyTimer = null; }
                    if (_autoRevealTimer) { clearTimeout(_autoRevealTimer); _autoRevealTimer = null; }
                    var qdData = {};
                    try { qdData = JSON.parse(msg.content); } catch(_) {}

                    // Parse all remaining cards before deciding path
                    var rejected = finalClauseSweep();
                    if (rejected) {
                        // ── Document not applicable — rejection screen already shown ──
                        // Finalize status (handoff/done events won't arrive — EventSource closed)
                        statusText.textContent = 'Document scanned \u2014 not a contract';
                        statusPill.classList.add('done');
                        stopCapTicker();
                        capTicker.classList.add('hidden');
                        console.log('[FlipSide] Not applicable \u2014 rejection screen shown');
                        break;
                    }

                    // ── Normal path: cards found ──
                    var qdSec = qdData.seconds ? qdData.seconds.toFixed(1) + 's' : '';
                    statusText.textContent = 'Cards ready' + (qdSec ? ' (' + qdSec + ')' : '') + ' \u2014 Expert report building...';
                    startStatusRotation('deep');
            
                    buildFilterChips();
                    buildPlaybookCard();
                    // Always update nav — ensures Next button exits "Analyzing" state
                    updateCardNavigation();
                    // Flash verdict from card data — bridge while Opus runs
                    if (!_coreVerdictReady) buildFlashVerdict();
                    // Update investigation phases: cards done, expert working
                    var qdCardCount = flipCardContainer.querySelectorAll('.flip-card').length;
                    setInvestPhase(1, 'done', '\u2713 Done');
                    setInvestPhase(2, 'done', '\u2713 ' + qdCardCount + ' clause' + (qdCardCount !== 1 ? 's' : '') + ' found');
                    setInvestPhase(3, 'active', '<span class="pulsing-dots" style="transform:scale(0.6)"><span></span><span></span><span></span></span> Working...');
                    // Mark readers track as done
                    var readersInd = $('trackReaders');
                    if (readersInd) readersInd.classList.add('done');
                    var readersDetail = $('trackReadersDetail');
                    if (readersDetail) readersDetail.textContent = qdCardCount + ' clauses analyzed';
                    showBriefingSentence('All clauses scanned \u2014 expert is finalizing the verdict');
                    // Show "cards ready" pill if verdict was auto-revealed
                    if (_verdictAutoRevealed) {
                        var crCardCount = flipCardContainer.querySelectorAll('.flip-card').length;
                        if (crCardCount > 0) {
                            $('cardsReadyText').textContent = crCardCount + ' card' + (crCardCount !== 1 ? 's' : '') + ' ready';
                            $('cardsReadyPill').classList.remove('hidden');
                        }
                    }
                    break;

                // ── Single Opus verdict thread events ──
                case 'overall_text':
                    opusSections.overall.text += msg.content;
                    updateVerdictStrip();
                    tryProgressiveVerdictRender();
                    break;

                case 'overall_thinking':
                    thinkingCharCount += msg.content.length;
                    appendOpusThinking(msg.content);
                    break;

                case 'overall_done':
                    opusSections.overall.done = true;
                    deepTextComplete = true;
                    stopVerdictCountdown();
                    if (thinkingCharCount > 0) showCapStats();
                    // Check if deep dives are still building
                    var ddPending = DEEP_DIVE_SOURCES.filter(function(s) { return !deepDiveResults[s].done; }).length;
                    if (ddPending > 0) {
                        statusText.textContent = 'Verdict ready \u2014 ' + ddPending + ' expert report' + (ddPending !== 1 ? 's' : '') + ' building';
                    } else {
                        statusText.textContent = 'Analysis complete';
                        stopStatusRotation();
                    }
                    var verdictStatusEl = $('verdictStatus');
                    if (verdictStatusEl) verdictStatusEl.classList.add('hidden');
                    verdictTitle.textContent = 'Your verdict is ready';
                    updateVerdictButton();
                    if (flipCardsBuilt) updateCardNavigation();
                    onVerdictReady();
                    // Unlock depth buttons — they now have streaming content
                    document.querySelectorAll('.verdict-depth-btn.locked').forEach(function(b) { b.classList.remove('locked'); });
                    var askSec = document.querySelector('.ask-flipside-section.hidden'); if (askSec) askSec.classList.remove('hidden');
                    // Update thinking label to final state
                    var thinkLabel = $('thinkingToggleLabel');
                    if (thinkLabel && _opusThinkingText) {
                        var finalTokens = Math.round(_opusThinkingText.length / 4);
                        thinkLabel.textContent = 'Expert thinking (' + finalTokens.toLocaleString() + ' tokens) \u2713';
                    }
                    // Expert briefing: mark verdict complete
                    var expertInd = $('trackExpert');
                    if (expertInd) expertInd.classList.add('done');
                    var expertDetail = $('trackExpertDetail');
                    if (expertDetail) expertDetail.textContent = 'Verdict ready';
                    showBriefingSentence('Expert verdict is ready \u2014 expert reports building');
                    // Don't stop briefing timer — deep dives still coming
                    break;

                // ── Deep dive streams (5 parallel Opus threads) ──
                case 'archaeology_text':
                case 'scenario_text':
                case 'walkaway_text':
                case 'combinations_text':
                case 'playbook_text':
                    var ddSource = msg.type.replace('_text', '');
                    deepDiveResults[ddSource].text += msg.content;
                    updateDeepDivePanel(ddSource);
                    updateDeepDiveProgress();
                    break;

                case 'archaeology_thinking':
                case 'scenario_thinking':
                case 'walkaway_thinking':
                case 'combinations_thinking':
                case 'playbook_thinking':
                    // Deep dive thinking — count but don't display
                    thinkingCharCount += msg.content.length;
                    break;

                case 'archaeology_done':
                case 'scenario_done':
                case 'walkaway_done':
                case 'combinations_done':
                case 'playbook_done':
                    var ddDoneSource = msg.type.replace('_done', '');
                    deepDiveResults[ddDoneSource].done = true;
                    updateDeepDivePanel(ddDoneSource);
                    updateDeepDiveProgress();
                    updateDepthButtonState(ddDoneSource);
                    break;

                case 'done':
                    isDoneRendering = true;
                    stopVerdictCountdown();
                    statusPill.classList.add('done');
                    if (elapsedInterval) { clearInterval(elapsedInterval); elapsedInterval = null; }
                    stopStatusRotation();
            
                    if (thinkingCharCount > 0) showCapStats();
                    // Mark all deep dives as done (safety — they should already be)
                    DEEP_DIVE_SOURCES.forEach(function(s) {
                        deepDiveResults[s].done = true;
                        updateDepthButtonState(s);
                    });
                    var ddLabel = $('deepDiveProgressLabel');
                    if (ddLabel) ddLabel.innerHTML = 'All ' + DEEP_DIVE_SOURCES.length + ' expert reports ready \u2713';
                    // Re-show model badge now that analysis is complete
                    var doneBadge = document.querySelector('.model-badge');
                    if (doneBadge) doneBadge.classList.remove('hidden');

                    var doneData = {};
                    try { doneData = JSON.parse(msg.content); } catch(_) {}
                    var quickSec = doneData.quick_seconds ? doneData.quick_seconds.toFixed(1) : null;
                    var deepSec = doneData.deep_seconds ? doneData.deep_seconds.toFixed(1) : null;
                    var synthSec = doneData.synthesis_seconds ? doneData.synthesis_seconds.toFixed(1) : null;
                    var timingStr = 'Analysis complete';
                    if (quickSec && deepSec) {
                        timingStr = 'Complete \u2014 Cards: ' + quickSec + 's \u00B7 Expert: ' + deepSec + 's';
                        if (synthSec && parseFloat(synthSec) > 0) timingStr += ' \u00B7 Synthesis: ' + synthSec + 's';
                    }
                    statusText.textContent = timingStr;

                    var sidebarIndicator = $('editorialLoading') ? $('editorialLoading').querySelector('.editorial-loading-indicator') : null;
                    if (sidebarIndicator) sidebarIndicator.style.display = 'none';

                    $('copyAllBtn').classList.remove('hidden');
                    $('exportBtn').classList.remove('hidden');
                    $('emailLawyerBtn').classList.remove('hidden');
                    syncOverflowMenu();
                    // Show "Download in [language]" button if document is not in English
                    if (detectedDocLanguage && detectedDocLanguage.toLowerCase() !== 'english') {
                        var langBtn = $('exportLangBtn');
                        langBtn.textContent = 'Report in ' + detectedDocLanguage;
                        langBtn.classList.remove('hidden');
                    }

                    if (flipCardsBuilt) updateCardNavigation();

                    // Mark all Opus sections done (safety net)
                    Object.keys(opusSections).forEach(function(k) {
                        if (!opusSections[k].done) {
                            opusSections[k].done = true;
                            markOpusSectionDone(k);
                        }
                    });
                    deepTextComplete = true;
                    document.querySelectorAll('.verdict-depth-btn.locked').forEach(function(b) { b.classList.remove('locked'); });
                    var askSec2 = document.querySelector('.ask-flipside-section.hidden'); if (askSec2) askSec2.classList.remove('hidden');
                    verdictTitle.textContent = 'Your verdict is ready';
                    updateVerdictButton();
                    // Update all depth button states (safety net)
                    DEEP_DIVE_SOURCES.forEach(function(s) {
                        updateDepthButtonState(s);
                        renderDepthResult(s);
                    });

                    if (!hasTaggedContent(opusSections.overall.text || '')) followupSection.classList.remove('hidden');
                    if (eventSource) { eventSource.close(); eventSource = null; }
                    break;

                case 'error':
                    statusText.textContent = 'Error';
                    statusPill.classList.add('done');
                    if (elapsedInterval) { clearInterval(elapsedInterval); elapsedInterval = null; }
                    stopStatusRotation();

                    resultsArea.classList.remove('hidden');
                    var errMsg = msg.content || 'Unknown error';
                    var advice = '';
                    if (errMsg.indexOf('API key') >= 0) advice = 'Check your .env file has a valid ANTHROPIC_API_KEY.';
                    else if (errMsg.indexOf('rate') >= 0 || errMsg.indexOf('429') >= 0) advice = 'Rate limit reached. Wait a minute and try again.';
                    else if (errMsg.indexOf('timeout') >= 0 || errMsg.indexOf('overloaded') >= 0) advice = 'The API is busy. Try again in a few minutes.';
                    else advice = 'Try again or use a different analysis depth.';
                    resultsContent.innerHTML = '<div class="error-msg">' + escapeHtml(errMsg) +
                        '<br><span style="font-size:0.82rem;color:var(--text-secondary);font-weight:400">' + advice + '</span>' +
                        '<br><button class="retry-btn" onclick="location.reload()">Try Again</button></div>';

                    if (eventSource) { eventSource.close(); eventSource = null; }
                    break;
            }
        };

        eventSource.onerror = function() {
            if (eventSource) { eventSource.close(); eventSource = null; }
            if (statusPill.classList.contains('done')) return;
            // Retry on transient failures if analysis is still in progress
            if (_sseRetryCount < _sseMaxRetries && responseContent.length > 0) {
                _sseRetryCount++;
                statusText.textContent = 'Reconnecting (' + _sseRetryCount + '/' + _sseMaxRetries + ')...';
                setTimeout(function() {
                    if (statusPill.classList.contains('done')) return;
                    // Reset card state to prevent duplicates on reconnect
                    responseContent = '';
                    parsedClauseCount = 0;
                    flipCardContainer.innerHTML = '';
                    connectStream(docId);
                }, 2000 * _sseRetryCount);
                return;
            }
            statusText.textContent = 'Connection lost';
            statusPill.classList.add('done');
            stopStatusRotation();
            if (elapsedInterval) { clearInterval(elapsedInterval); elapsedInterval = null; }
            if (responseContent.length < 50) {
                resultsArea.classList.remove('hidden');
                resultsContent.innerHTML = '<div class="error-msg">Connection lost during analysis.' +
                    '<br><button class="retry-btn" onclick="location.reload()">Retry</button></div>';
            }
        };
    }

    // ── Phase handling ────────────────────────────────────────
    function handlePhase(phase) {
        var labels = {
            thinking: "Reading as the drafter's attorney...",
            profile: 'Identifying document structure...',
            clauses: 'Analyzing clauses...',
            interactions: 'Cross-clause interactions...',
            playbook: "Revealing the drafter's playbook...",
            summary: 'Generating risk assessment...'
        };
        if (labels[phase]) {
            statusText.textContent = labels[phase];
        }
        // Extract metadata from profile phase
        if (phase === 'profile') {
            setTimeout(extractMetadata, 2000);
        }
        // Start relevant status rotation
        if (phase === 'clauses' || phase === 'profile') startStatusRotation('clauses');
        else if (phase === 'interactions' || phase === 'playbook' || phase === 'summary') startStatusRotation('deep');
    }

    // ── Metadata extraction from streamed text ────────────────
    var documentNotApplicable = ''; // Set when Haiku determines doc has no terms to analyze
    var detectedDocLanguage = ''; // Detected from document text (e.g. "Dutch", "German")

    function extractMetadata() {
        var patterns = [
            { re: /\*\*Document Type\*\*[:\s]*([^\n*]+)/i, label: 'Type' },
            { re: /\*\*Drafted By\*\*[:\s]*([^\n*]+)/i, label: 'Drafted By' },
            { re: /\*\*Your Role\*\*[:\s]*([^\n*]+)/i, label: 'Your Role' },
            { re: /\*\*Jurisdiction\*\*[:\s]*([^\n*]+)/i, label: 'Jurisdiction' },
            { re: /\*\*Language\*\*[:\s]*([^\n*]+)/i, label: 'Language' },
        ];
        var parts = [];
        patterns.forEach(function(p) {
            var m = responseContent.match(p.re);
            if (m) {
                var val = m[1].trim();
                // Capture language but don't show as pill (used for download button)
                if (p.label === 'Language') {
                    detectedDocLanguage = val;
                    return;
                }
                // Show flag in doc title hero when jurisdiction is found
                if (p.label === 'Jurisdiction') {
                    var flag = jurisdictionFlag(val);
                    var flagEl = $('docTitleFlag');
                    if (flag && flagEl) {
                        flagEl.textContent = flag;
                        flagEl.classList.remove('hidden');
                    }
                }
                parts.push(
                    '<span class="meta-pill">' +
                    '<span class="meta-pill-label">' + escapeHtml(p.label) + '</span> ' +
                    '<span class="meta-pill-value">' + escapeHtml(val) + '</span>' +
                    '</span>'
                );
            }
        });
        // Detect "Not Applicable" signal from Haiku
        var naMatch = responseContent.match(/\*\*Not Applicable\*\*[:\s]*([^\n*]+)/i);
        if (naMatch) {
            documentNotApplicable = naMatch[1].trim();
        }
        if (parts.length > 0) {
            metadataLine.innerHTML = parts.join('');
            metadataLine.classList.remove('hidden');
            // Trigger fly-in animation after a frame
            requestAnimationFrame(function() {
                requestAnimationFrame(function() {
                    metadataLine.classList.add('visible');
                });
            });
            // Also populate verdict column doc profile
            var vMeta = $('verdictDocMeta');
            var vProfile = $('verdictDocProfile');
            if (vMeta && vProfile) {
                // Detect document category icon from type
                var typeMatch = responseContent.match(/\*\*Document Type\*\*[:\s]*([^\n*]+)/i);
                var docCat = typeMatch ? detectDocIcon(typeMatch[1]) : null;
                var iconHtml = docCat
                    ? '<div class="verdict-doc-icon"><span class="verdict-doc-icon-svg">' + docCat.svg + '</span><span class="verdict-doc-icon-label">' + escapeHtml(docCat.label) + '</span></div>'
                    : '';
                vMeta.innerHTML = iconHtml + parts.join('');
                vProfile.classList.remove('hidden');
            }
            // Skeleton message intentionally kept empty — cards arrive fast enough
        }
    }

    // ── Status rotation ───────────────────────────────────────
    function startStatusRotation(group) {
        stopStatusRotation();
        currentStatusIdx = 0;
        var messages = STATUS_MESSAGES[group];
        if (!messages || messages.length === 0) return;
        statusRotateInterval = setInterval(function() {
            currentStatusIdx = (currentStatusIdx + 1) % messages.length;
            statusText.textContent = messages[currentStatusIdx];
            // Mirror deep status text
            if (group === 'deep') {
            }
        }, 4000);
    }

    function stopStatusRotation() {
        if (statusRotateInterval) { clearInterval(statusRotateInterval); statusRotateInterval = null; }
    }


    // ── Results rendering ─────────────────────────────────────
    function renderResults() {
        if (renderTimeout) return;
        renderTimeout = setTimeout(function() {
            renderTimeout = null;
            doRenderResults();
        }, 300);
    }

    function renderResultsFinal() {
        if (renderTimeout) { clearTimeout(renderTimeout); renderTimeout = null; }
        doRenderResults();
    }

    function doRenderResults() {
        // ── Guard: once flip cards are built, DON'T render deep analysis during streaming ──
        // Deep analysis will be rendered on-demand when user clicks "Our Verdict" or "View assessment"
        if (flipCardsBuilt) {
            return;
        }

        // ── Incremental clause detection ──
        tryExtractNewClauses();
    }

    // ── Risk badge styling ────────────────────────────────────
    function styleRiskBadges(html) {
        // Match: LEVEL · Score: NN/100 · Trick: NAME (or Score: NN without /100)
        html = html.replace(
            /\[?(?:<strong>)?(GREEN|YELLOW|RED)(?:<\/strong>)?\]?\s*(?:·|&#xB7;|&middot;)\s*Score:\s*\d+(?:\/100)?\s*(?:·|&#xB7;|&middot;)\s*Trick:\s*([^<\n]+)/gi,
            function(_, level, trick) {
                return buildBadgeHtml(level.toLowerCase(), level.toUpperCase(), trick.trim());
            }
        );
        // Match: LEVEL · Trick: NAME (no score — cross-clause format)
        html = html.replace(
            /\[?(?:<strong>)?(GREEN|YELLOW|RED)(?:<\/strong>)?\]?\s*(?:·|&#xB7;|&middot;)\s*Trick:\s*([^<\n]+)/gi,
            function(_, level, trick) {
                return buildBadgeHtml(level.toLowerCase(), level.toUpperCase(), trick.trim());
            }
        );
        // Fallback: LEVEL · Score: NN/100 (no trick)
        html = html.replace(
            /\[?(?:<strong>)?(GREEN|YELLOW|RED)(?:<\/strong>)?\]?\s*(?:·|&#xB7;|&middot;)\s*Score:\s*\d+(?:\/100)?/gi,
            function(_, level) {
                return buildBadgeHtml(level.toLowerCase(), level.toUpperCase(), '');
            }
        );
        return html;
    }

    // styleRiskDistribution removed — risk distribution dots no longer shown

    function buildBadgeHtml(level, label, trick) {
        var h = '<span class="risk-badge risk-' + level + '">' + label + '</span>';
        if (trick) {
            var desc = TRICK_DESCRIPTIONS[trick] || '';
            var icon = TRICK_ICONS[trick] ? '<span class="verdict-trick-icon">' + TRICK_ICONS[trick] + '</span> ' : '';
            h += '<span class="trick-label" title="' + escapeHtml(desc) + '">' + icon + escapeHtml(trick) + '</span>';
        }
        return h;
    }

    // ── "Why this clause exists" — hidden from display ────────
    function styleWhyClauses(html) {
        return html.replace(
            /<p><strong>Why this clause exists:<\/strong>\s*([\s\S]*?)<\/p>/gi,
            ''
        );
    }

    // ── Split clause styling (juxtaposition) ──────────────────
    function styleSplitClauses(html) {
        // Card-level juxtapose (from Haiku quick scan)
        html = html.replace(
            /<p><strong>What the small print says:?<\/strong>:?\s*([\s\S]*?)<\/p>\s*<p><strong>What you should read:?<\/strong>:?\s*([\s\S]*?)<\/p>/gi,
            function(_, left, right) {
                return '<div class="clause-split-header">' +
                    '<div class="clause-split-label clause-split-label-left">What the small print says</div>' +
                    '<div class="clause-split-label clause-split-label-right">What you should read</div>' +
                    '</div>' +
                    '<div class="clause-split">' +
                    '<div class="clause-split-left">' + left.trim() + '</div>' +
                    '<div class="clause-split-right">' + right.trim() + '</div>' +
                    '</div>';
            }
        );
        // Cross-clause juxtapose (from Opus deep analysis — different labels)
        html = html.replace(
            /<p><strong>Read separately, you(?:&#x2019;|'|')d see:<\/strong>\s*([\s\S]*?)<\/p>\s*<p><strong>Read together, you(?:&#x2019;|'|')d realize:<\/strong>\s*([\s\S]*?)<\/p>/gi,
            function(_, left, right) {
                return '<div class="clause-split-header">' +
                    '<div class="clause-split-label clause-split-label-left">Read separately</div>' +
                    '<div class="clause-split-label clause-split-label-right">Read together</div>' +
                    '</div>' +
                    '<div class="clause-split">' +
                    '<div class="clause-split-left">' + left.trim() + '</div>' +
                    '<div class="clause-split-right">' + right.trim() + '</div>' +
                    '</div>';
            }
        );
        return html;
    }

    // ── [READER] block styling ────────────────────────────────
    function styleReaderBlocks(html) {
        // Match FLIPSIDE_READER: text (pre-processed from [READER]:)
        return html.replace(
            /<p>FLIPSIDE_READER:\s*([\s\S]*?)<\/p>/gi,
            function(_, text) {
                return '<div class="reader-voice" data-reader="true">' + text.trim() + '</div>';
            }
        );
    }

    // ── Drafter voice styling ───────────────────────────────
    function styleDrafterBlocks(html) {
        // Primary format: **If the drafter would have bad intentions:** text
        html = html.replace(
            /<p><strong>If the drafter (?:would have bad intentions|could speak as a villain):<\/strong>\s*([\s\S]*?)<\/p>/gi,
            function(_, text) {
                return '<div class="drafter-voice"><span class="drafter-voice-label">If the drafter would have bad intentions</span>' + text.trim() + '</div>';
            }
        );
        // Fallback: old "speak freely" format
        html = html.replace(
            /<p><strong>If the drafter could speak freely:<\/strong>\s*([\s\S]*?)<\/p>/gi,
            function(_, text) {
                return '<div class="drafter-voice"><span class="drafter-voice-label">If the drafter would have bad intentions</span>' + text.trim() + '</div>';
            }
        );
        // Legacy format: FLIPSIDE_DRAFTER: text (pre-processed from [DRAFTER]:)
        html = html.replace(
            /<p>FLIPSIDE_DRAFTER:\s*([\s\S]*?)<\/p>/gi,
            function(_, text) {
                return '<div class="drafter-voice"><span class="drafter-voice-label">If the drafter would have bad intentions</span>' + text.trim() + '</div>';
            }
        );
        // Style "→ YOUR MOVE:" action lines
        html = html.replace(
            /<p>→ YOUR MOVE:\s*([\s\S]*?)<\/p>/gi,
            function(_, text) {
                return '<div class="your-move"><span class="your-move-label">→ Your move</span>' + text.trim() + '</div>';
            }
        );
        return html;
    }

    // ── Incremental clause detection via --- separators ─────
    function tryExtractNewClauses() {
        // Split on --- separator (flexible: handles \n---\n, \n\n---\n, \n\n---\n\n)
        var segments = responseContent.split(/\n+---\n+/);
        if (segments.length > 1 && parsedClauseCount === 0) {
            console.log('[FlipSide] First segment (should be doc profile):', segments[0].substring(0, 200));
            console.log('[FlipSide] Total segments so far:', segments.length);
            console.log('[FlipSide] Second segment preview:', segments[1] ? segments[1].substring(0, 200) : '(empty)');
        }

        // All segments except the last are complete (last may be mid-stream)
        for (var i = parsedClauseCount; i < segments.length - 1; i++) {
            var clause = extractSingleClause(segments[i]);
            if (!clause && segments[i].trim().length > 50) {
                console.log('[FlipSide] Failed to parse segment ' + i + ' (' + segments[i].length + ' chars)');
            }
            if (clause) {
                buildSingleFlipCard(clause, flipCardContainer.querySelectorAll('.flip-card').length);
                trackTrick(clause.trick);
                markWorkerDone();
                if (!cardViewTransitioned) {
                    transitionToCardView();
                } else {
                    updateCardNavigation();
                }
                // Live clause counter — no total until all cards built
                statusText.textContent = 'Scanning clauses\u2026';
                var sidebarStatus = $('editorialLoadingStatus');
                if (sidebarStatus) sidebarStatus.textContent = 'Scanning clauses\u2026';
                // Update investigation phase 2 with live count
                var liveCount = flipCardContainer.querySelectorAll('.flip-card').length;
                setInvestPhase(2, 'active', liveCount + ' clause' + (liveCount !== 1 ? 's' : '') + ' found...');
            }
        }
        parsedClauseCount = Math.max(parsedClauseCount, segments.length - 1);

        // Extract metadata if not yet populated
        if (metadataLine.classList.contains('hidden') && responseContent.length > 200) {
            extractMetadata();
        }
    }

    // ── Final sweep on quick_done — parse last segment too ──
    // Returns true if rejection screen was shown (0 cards = not applicable)
    function finalClauseSweep() {
        var segments = responseContent.split(/\n+---\n+/);
        console.log('[FlipSide] finalClauseSweep: ' + segments.length + ' segments, parsedClauseCount=' + parsedClauseCount);
        for (var i = parsedClauseCount; i < segments.length; i++) {
            var clause = extractSingleClause(segments[i]);
            if (clause) {
                buildSingleFlipCard(clause, flipCardContainer.querySelectorAll('.flip-card').length);
                trackTrick(clause.trick);
                markWorkerDone();
                if (!cardViewTransitioned) {
                    transitionToCardView();
                }
            }
        }
        parsedClauseCount = segments.length;
        flipCardsBuilt = true;
        updateCardNavigation();
        buildFilterChips();
        // Final sidebar count
        var finalCount = flipCardContainer.querySelectorAll('.flip-card').length;
        var sidebarStatus = $('editorialLoadingStatus');
        if (sidebarStatus && finalCount > 0) sidebarStatus.textContent = finalCount + ' clause' + (finalCount !== 1 ? 's' : '') + ' flagged';
        // buildPlaybookCard() called after quick_done — Haiku now provides trick data

        // Ensure metadata (including Not Applicable signal) is extracted
        if (!documentNotApplicable && responseContent.length > 50) {
            var naMatch = responseContent.match(/\*\*Not Applicable\*\*[:\s]*([^\n*]+)/i);
            if (naMatch) documentNotApplicable = naMatch[1].trim();
        }

        // If no cards were found, show an explanation
        var totalCards = flipCardContainer.querySelectorAll('.flip-card').length;
        if (totalCards === 0) {
            // ── Purpose-built rejection screen (0 cards = nothing to show) ──
            // Stop all background processing — Opus verdict is pointless
            if (eventSource) { eventSource.close(); eventSource = null; }
            stopInvestigationScroll();
            isDoneRendering = true;
            if (elapsedInterval) { clearInterval(elapsedInterval); elapsedInterval = null; }
            stopStatusRotation();
    
            statusPill.classList.add('done');
            // Hide ALL analysis chrome
            $('cardViewport').classList.remove('hidden');
            $('skeletonCard').classList.add('hidden');
            $('eduReviewPill').classList.add('hidden');
            var ocrEl = $('ocrBanner');
            if (ocrEl) ocrEl.classList.add('hidden');
            hideVerdictCol();
            stopVerdictCountdown();
            var heroEl2 = $('docTitleHero');
            if (heroEl2) heroEl2.classList.add('hidden');
            var dcEl2 = $('docContext');
            if (dcEl2) { dcEl2.classList.remove('visible'); dcEl2.classList.add('hidden'); }
            // Hide sidebar
            var sidebar2 = $('analysisSidebar');
            if (sidebar2) sidebar2.classList.add('hidden');
            var layoutEl2 = document.querySelector('.analysis-layout');
            if (layoutEl2) layoutEl2.classList.remove('sidebar-visible');
            // Hide card nav elements
            var cardNavSticky = $('cardNavSticky');
            if (cardNavSticky) cardNavSticky.classList.add('hidden');

            // Build explanation text
            var typeMatch = responseContent.match(/\*\*Document Type\*\*[:\s]*([^\n*]+)/i);
            var docType = typeMatch ? typeMatch[1].trim() : '';
            var explanationText = documentNotApplicable
                ? documentNotApplicable
                : (docType
                    ? 'This appears to be ' + (/^[aeiou]/i.test(docType) ? 'an ' : 'a ') + docType.toLowerCase() + '. FlipSide didn\u2019t find any terms, obligations, or clauses that need your attention.'
                    : 'FlipSide scanned this document but didn\u2019t find any terms, obligations, or clauses that need your attention.');

            // Build the rejection card
            var displayName = (currentFilename || 'Document').replace(/\.[^.]+$/, '').replace(/[_-]/g, ' ');
            var rejectionHtml = '<div class="rejection-screen">' +
                '<svg class="rejection-icon" viewBox="0 0 64 64" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">' +
                    '<rect x="12" y="6" width="40" height="52" rx="4"/>' +
                    '<line x1="22" y1="20" x2="42" y2="20"/>' +
                    '<line x1="22" y1="28" x2="38" y2="28"/>' +
                    '<line x1="22" y1="36" x2="34" y2="36"/>' +
                    '<circle cx="44" cy="46" r="12" fill="var(--bg-cream)" stroke-width="2"/>' +
                    '<line x1="39" y1="41" x2="49" y2="51" stroke-width="2"/>' +
                    '<line x1="49" y1="41" x2="39" y2="51" stroke-width="2"/>' +
                '</svg>' +
                '<div class="rejection-uploaded">You uploaded: ' + escapeHtml(displayName) + '</div>' +
                '<div class="rejection-headline">Not everything is a contract in life.</div>' +
                '<div class="rejection-explanation">' + escapeHtml(explanationText) + '</div>' +
                '<div class="rejection-scope">' +
                    '<strong>FlipSide analyzes documents where one party sets terms that bind another</strong> \u2014 ' +
                    'contracts, leases, terms of service, insurance policies, coupons with conditions, and similar.' +
                '</div>' +
                '<button class="rejection-back-btn" onclick="document.getElementById(\'backBtn\').click()">Try another document</button>' +
            '</div>';
            // Insert rejection screen into the card viewport
            var rejEl = document.createElement('div');
            rejEl.id = 'rejectionScreen';
            rejEl.innerHTML = rejectionHtml;
            // Start invisible, then fade in (rAF ensures browser paints before transition)
            var rejInner = rejEl.querySelector('.rejection-screen');
            rejInner.style.opacity = '0';
            rejInner.style.transform = 'translateY(16px)';
            $('cardViewport').appendChild(rejEl);
            requestAnimationFrame(function() {
                rejInner.style.transition = 'opacity 0.5s ease, transform 0.5s var(--ease-out-expo)';
                rejInner.style.opacity = '1';
                rejInner.style.transform = 'translateY(0)';
            });
            return true; // rejection screen shown
        }
        return false; // normal cards found
    }

    // ── Opus card backs: incremental parsing ──────────────────

    // ── Parse one clause from a raw markdown segment ─────────
    function extractSingleClause(segment) {
        if (!segment.match(/^### /m)) return null;

        // Risk flag: must be on its own line with Score (avoids matching "green" in reassurance text)
        var riskMatch = segment.match(/^\s*\[?(GREEN|YELLOW|RED)\]?\s*[·•\u00B7\u2022\-–—|,]\s*Score:\s*(\d+)(?:\/100)?(?:\s*[·•\u00B7\u2022\-–—|,]\s*Trick:\s*([^\n]+))?/im);
        // Fallback: standalone risk word on its own line (no Score)
        if (!riskMatch) riskMatch = segment.match(/^\s*\[?(GREEN|YELLOW|RED)\]?\s*$/im);
        if (!riskMatch) return null;

        var headerMatch = segment.match(/^### \s*(.+)\s+\(([^)]+)\)\s*$/m);
        var title, sectionRef;
        if (headerMatch) {
            title = headerMatch[1].trim();
            sectionRef = headerMatch[2].trim();
        } else {
            var simpleHeader = segment.match(/^### \s*(.+?)\s*$/m);
            if (!simpleHeader) return null;
            title = simpleHeader[1].trim();
            sectionRef = '';
        }

        var quoteLines = [];
        var lines = segment.split('\n');
        for (var j = 0; j < lines.length; j++) {
            if (lines[j].match(/^>\s*/)) {
                quoteLines.push(lines[j].replace(/^>\s*/, ''));
            } else if (quoteLines.length > 0) {
                break;
            }
        }
        var quote = quoteLines.join(' ').replace(/^["\u201C]|["\u201D]$/g, '').trim();

        var reassuranceMatch = segment.match(/\[REASSURANCE\]\s*:\s*(.+)/i);
        var reassurance = reassuranceMatch ? reassuranceMatch[1].trim().replace(/^["\u201C]|["\u201D]$/g, '') : '';

        var honeyMatch = segment.match(/\[HONEY\]\s*:\s*([\s\S]*?)(?=\n\n|\n\[|\n(?:GREEN|YELLOW|RED))/i);
        var honey = honeyMatch ? honeyMatch[1].trim() : '';

        var teaserMatch = segment.match(/\[TEASER\]\s*:\s*(.+)/i);
        var teaser = teaserMatch ? teaserMatch[1].trim().replace(/^["\u201C]|["\u201D]$/g, '') : '';

        var revealMatch = segment.match(/\[REVEAL\]\s*:\s*(.+)/i);
        var reveal = revealMatch ? revealMatch[1].trim().replace(/^["\u201C]|["\u201D]$/g, '') : '';

        var readerMatch = segment.match(/\[READER\]\s*:\s*([\s\S]*?)(?=\n\n|\n\[|\n(?:GREEN|YELLOW|RED))/i);
        var reader = readerMatch ? readerMatch[1].trim() : '';

        var risk = riskMatch[1].toLowerCase();
        var score = riskMatch[2] ? parseInt(riskMatch[2]) : 0;
        var trick = riskMatch[3] ? riskMatch[3].trim() : '';
        // Fallback: try standalone Trick: line if combined regex missed it
        if (!trick || trick.toLowerCase() === 'none') {
            var trickFallback = segment.match(/Trick:\s*([^\n]+)/i);
            if (trickFallback) {
                var fb = trickFallback[1].trim();
                if (fb && fb.toLowerCase() !== 'none') trick = fb;
            }
        }

        var confidenceMatch = segment.match(/Confidence:\s*(HIGH|MEDIUM|LOW)\s*[\u2014\-\u2013\u2015]\s*(.+)/i);
        var confidence = confidenceMatch ? confidenceMatch[1].toLowerCase() : '';
        var confidenceReason = confidenceMatch ? confidenceMatch[2].trim() : '';

        var bottomLineMatch = segment.match(/\*{1,2}Bottom line:?\*{0,2}:?\s*([\s\S]*?)(?=\n\n|\*{1,2}What the small print says|$)/i);
        var bottomLine = bottomLineMatch ? bottomLineMatch[1].trim() : '';

        var smallPrintMatch = segment.match(/\*{1,2}What the small print says:?\*{0,2}:?\s*([\s\S]*?)(?=\*{1,2}What you should read|\n\n###|\n\n##|$)/i);
        var shouldReadMatch = segment.match(/\*{1,2}What you should read:?\*{0,2}:?\s*([\s\S]*?)(?=\*{1,2}What does this mean|\n\n###|\n\n##|$)/i);
        var smallPrint = smallPrintMatch ? smallPrintMatch[1].trim() : '';
        var shouldRead = shouldReadMatch ? shouldReadMatch[1].trim() : '';
        if (!smallPrint && quote) smallPrint = quote;

        var figureMatch = segment.match(/\[FIGURE\]\s*:\s*(.+)/i);
        var figure = figureMatch ? figureMatch[1].trim() : '';
        var exampleNarrativeMatch = segment.match(/\[EXAMPLE\]\s*:\s*([\s\S]*?)(?=\n\[READER\]|\n\n###|\n\n##|\n\n---|\*{1,2}\[EN\]|\[EN-FIGURE\]|\[EN-EXAMPLE\]|$)/i);
        var exampleNarrative = exampleNarrativeMatch ? exampleNarrativeMatch[1].trim() : '';
        if (!figure && !exampleNarrative) {
            var exampleMatch = segment.match(/\*{1,2}What does this mean for you:?\*{0,2}:?\s*([\s\S]*?)(?=\n\[READER\]|\n\n###|\n\n##|\n\n---|\*{1,2}\[EN\]|$)/i);
            if (exampleMatch) exampleNarrative = exampleMatch[1].trim();
        }

        // Track whether back data has been filled
        var hasBack = !!(reveal || score > 0 || bottomLine || figure);

        return {
            title: title, section: sectionRef, reassurance: reassurance, honey: honey,
            teaser: teaser, quote: quote, reader: reader, reveal: reveal,
            risk: risk, score: score, trick: trick, hasBack: hasBack,
            confidence: confidence, confidenceReason: confidenceReason,
            bottomLine: bottomLine, smallPrint: smallPrint, shouldRead: shouldRead,
            figure: figure, exampleNarrative: exampleNarrative
        };
    }

    // ── Build and append one flip card ───────────────────────
    function buildSingleFlipCard(clause, index) {
        var risk = clause.risk;
        // Individual cards must be RED or YELLOW — only the Fair Clauses Summary is GREEN
        var isGreenSummaryTitle = clause.title === 'Fair Clauses Summary' || (clause.title && clause.title.indexOf('Fair Clauses') >= 0);
        if (risk === 'green' && !isGreenSummaryTitle) {
            risk = 'yellow';
            clause.risk = 'yellow';
        }
        var trickDesc = TRICK_DESCRIPTIONS[clause.trick] || '';
        var borderColor = risk === 'red' ? 'var(--red)' : risk === 'yellow' ? 'var(--yellow)' : 'var(--green-border)';

        // ── Front: watermark number, reassurance headline, section ref, reader voice, teaser ──
        var displayNum = (index + 1 < 10 ? '0' : '') + (index + 1);
        var frontHtml = '<div class="flip-card-front">' +
            '<span class="card-watermark">' + displayNum + '</span>' +
            '<div class="risk-header risk-header-green">' +
            (clause.reassurance ? '<span class="risk-header-label" style="color:var(--green-text)">You think that</span><h3 class="clause-title" style="color:var(--green-text)">' + escapeHtml(clause.reassurance) + '</h3>' : '') +
            '</div>' +
            '<div class="front-content">' +
            (clause.section ? '<div class="clause-section-ref">' + escapeHtml(clause.section) + '</div>' : '') +
            (clause.quote ? '<div class="front-quote-pill" data-card-pill="' + index + '">' +
                '<span class="pill-num pill-num-' + risk + '">' + (index + 1) + '</span>' +
                '<span class="pill-text">\u201c' + escapeHtml(clause.quote) + '\u201d</span>' +
                '</div>' : '') +
            '<div class="reader-voice">' +
            '<span class="reader-voice-label">At first glance</span>' +
            '<div class="reader-voice-text">' + escapeHtml(clause.reader) + '</div>' +
            '</div>' +
            '</div>' +
            '<button class="flip-trigger" aria-label="Flip card to reveal hidden clause details"><span class="flip-trigger-cta">Flip it!</span> <span>' + (risk === 'green' ? 'Verify what\u2019s behind this' : 'See what this really means') + '</span><span class="flip-trigger-arrow" style="margin-left:0.4rem">&rsaquo;</span></button>' +
            '</div>';

        // ── Back body: full reveal — teaser headline, figure, example, bottom line ──
        var backBodyHtml = '';

        var isGreenSummary = clause.title === 'Fair Clauses Summary' || (risk === 'green' && clause.title && clause.title.indexOf('Fair Clauses') >= 0);
        var backHtml;

        // Haiku delivers full card data — back is always ready
        if (isGreenSummary) {
            backBodyHtml = '<div class="green-verdict">' +
                '<div class="green-verdict-title">Confirmed: Fair as written</div>' +
                '<div class="green-verdict-text">' +
                escapeHtml(clause.bottomLine || 'These clauses do what they say.') +
                '</div></div>';
        } else if (clause.figure || clause.exampleNarrative) {
            if (clause.figure) {
                backBodyHtml += '<div class="back-figure back-figure-' + risk + '">' +
                    escapeHtml(clause.figure) + '</div>';
            }
            if (clause.exampleNarrative) {
                var exHtml = escapeHtml(clause.exampleNarrative).replace(
                    /(\$[\d,]+(?:\.\d{2})?|\d+%|\d+\s*(?:days?|months?|years?|hours?))/gi,
                    '<span class="hl-number">$1</span>'
                );
                backBodyHtml += '<div class="back-example back-example-' + risk + '">' + exHtml + '</div>';
            }
        }

        if (!isGreenSummary) {
            // Bottom line comes right after figure + example (punchline position)
            if (clause.bottomLine) {
                backBodyHtml += '<div class="back-bottom-line">' +
                    escapeHtml(clause.bottomLine) + '</div>';
            }

            // Utility row: "The lure" toggle + "Find in document" on one line
            var hasHoney = !!clause.honey;
            var hasQuote = !!clause.quote;
            if (hasHoney || hasQuote) {
                backBodyHtml += '<div class="back-utility-row">';
                if (hasHoney) {
                    backBodyHtml += '<span class="back-honey-toggle" onclick="this.classList.toggle(\'expanded\');this.parentElement.nextElementSibling.classList.toggle(\'visible\')">' +
                        '<span class="back-honey-label">The lure</span>' +
                        '<span class="back-honey-chevron">\u25B6</span>' +
                        '</span>';
                }
                if (hasQuote) {
                    backBodyHtml += '<span class="find-in-doc" data-card-index="' + index + '">Find in document</span>';
                }
                backBodyHtml += '</div>';
                if (hasHoney) {
                    backBodyHtml += '<div class="back-honey-body">' +
                        escapeHtml(clause.honey) + '</div>';
                }
            }
        }

        var backTitle = clause.teaser || clause.reveal || clause.title;
        var backLabel = (risk === 'green') ? 'And that\u2019s correct' : 'What this actually allows';
        // Risk header → straight to analysis (no section ref, no quote — user can flip back or use Find in Document)
        var backInnerHtml = '';
        backInnerHtml += '<div class="risk-header risk-header-' + risk + '">' +
            '<span class="risk-header-label">' + backLabel + '</span>' +
            '<h3 class="clause-title">' + escapeHtml(backTitle) + '</h3>' +
            '</div>';
        backInnerHtml += '<div class="back-body">' + backBodyHtml + '</div>';
        // Trick chip + flip back
        backInnerHtml += '<div class="back-footer">';
        if (clause.trick) {
            backInnerHtml += '<span class="trick-footnote" style="position:relative;right:auto;top:auto;transform:none;display:inline-flex;align-items:center;gap:0.3rem;padding:0.2rem 0.55rem;background:var(--bg-warm);border:1px solid var(--border);border-radius:100px;opacity:1;pointer-events:auto;margin-left:1rem" title="' + escapeHtml(trickDesc) + '">' +
                (TRICK_ICONS[clause.trick] ? '<span class="verdict-trick-icon">' + TRICK_ICONS[clause.trick] + '</span> ' : '') + escapeHtml(clause.trick) + '</span>';
        }
        backInnerHtml += '<button class="flip-back-trigger" aria-label="Flip card back to front"><span class="flip-back-arrow">&larr;</span><span>Flip back</span></button>';
        backInnerHtml += '<button class="card-bottom-next" aria-label="Next clause"><span>Next</span> <span class="card-bottom-next-arrow">&rarr;</span></button>';
        backInnerHtml += '</div>';
        backHtml = '<div class="flip-card-back"><div class="back-content">' + backInnerHtml + '</div></div>';

        var cardEl = document.createElement('div');
        cardEl.className = 'flip-card hidden';
        cardEl.setAttribute('role', 'article');
        cardEl.setAttribute('aria-label', 'Clause ' + (index + 1) + ': ' + (clause.title || 'Untitled'));
        cardEl.setAttribute('data-clause-index', index);
        cardEl.setAttribute('data-risk-level', risk);
        if (clause.trick) cardEl.setAttribute('data-trick', clause.trick);
        if (clause.score) cardEl.setAttribute('data-score', clause.score);
        cardEl.setAttribute('data-clause-title', clause.title);
        cardEl.setAttribute('data-section-ref', clause.section || '');
        if (clause.reassurance) cardEl.setAttribute('data-reassurance', clause.reassurance);
        if (clause.quote) cardEl.setAttribute('data-quote', clause.quote);
        if (clause.honey) cardEl.setAttribute('data-honey', clause.honey);
        if (clause.shouldRead) cardEl.setAttribute('data-should-read', clause.shouldRead);
        if (clause.figure) cardEl.setAttribute('data-figure', clause.figure);
        if (clause.exampleNarrative) cardEl.setAttribute('data-example', clause.exampleNarrative);
        cardEl.innerHTML = '<div class="flip-card-inner">' + frontHtml + backHtml + '</div>';
        flipCardContainer.appendChild(cardEl);

        // Highlight this clause's quote in the document preview
        highlightClauseInPreview(clause, index);
    }

    // ── Document preview: highlight clause quotes ─────────────
    // Stores all clause highlight data; rebuilds from clean source each time
    var clauseHighlightData = [];

    var _highlightsRenderedUpTo = -1;  // tracks which card index highlights are shown up to

    function highlightClauseInPreview(clause, cardIndex) {
        if (!clause.quote || clause.quote.length < 10) return;
        clauseHighlightData.push({ quote: clause.quote, cardIndex: cardIndex, risk: clause.risk || 'green' });
        // Render all markers immediately as clauses arrive
        rebuildPreviewHighlights();
    }

    function rebuildPreviewHighlights() {
        var totalHighlights = clauseHighlightData.length;
        if (totalHighlights === _highlightsRenderedUpTo) return;  // no change needed
        _highlightsRenderedUpTo = totalHighlights;
        var previewEl = $('editorialLoadingText');
        if (!previewEl || !documentFullText) return;

        // Always start from the clean escaped source
        var text = escapeHtml(documentFullText);

        // Build normalized version with position map for fuzzy matching
        // posMap[i] = index in 'text' that normalized[i] originated from
        var normalized = '';
        var posMap = [];
        for (var c = 0; c < text.length; c++) {
            if (/\s/.test(text[c])) {
                if (normalized.length > 0 && normalized[normalized.length - 1] !== ' ') {
                    normalized += ' ';
                    posMap.push(c);
                }
            } else {
                normalized += text[c].toLowerCase();
                posMap.push(c);
            }
        }

        function normalizeStr(s) {
            return s.replace(/\s+/g, ' ').replace(/[\u201c\u201d\u201e]/g, '"').replace(/[\u2018\u2019\u201a]/g, "'").replace(/[\u2013\u2014]/g, '-').trim().toLowerCase();
        }

        // Map a range in normalized space back to original space
        function normRangeToOrig(normStart, normLen) {
            var origStart = posMap[normStart] || 0;
            var lastNorm = Math.min(normStart + normLen - 1, posMap.length - 1);
            var origEnd = (posMap[lastNorm] || 0) + 1;
            return { start: origStart, end: origEnd };
        }

        // Find match positions for all known clauses
        var matches = [];
        for (var i = 0; i < clauseHighlightData.length; i++) {
            var d = clauseHighlightData[i];
            var searchText = escapeHtml(d.quote.substring(0, 60).trim());
            var idx = -1;
            var end;

            // ── Start match: try exact, then case-insensitive, then normalized ──
            idx = text.indexOf(searchText);
            if (idx === -1) idx = text.toLowerCase().indexOf(searchText.toLowerCase());

            if (idx >= 0) {
                // Found via exact/case-insensitive — find end the original way
                var endSearch = d.quote.length > 80 ? escapeHtml(d.quote.substring(d.quote.length - 30)) : '';
                var endIdx = endSearch ? text.indexOf(endSearch, idx) : -1;
                if (endIdx === -1 && endSearch) endIdx = text.toLowerCase().indexOf(endSearch.toLowerCase(), idx);
                // Normalized fallback for end match
                if (endIdx === -1 && endSearch) {
                    var endNorm = normalizeStr(endSearch);
                    var startNormSearch = 0;
                    for (var si = 0; si < posMap.length; si++) {
                        if (posMap[si] >= idx) { startNormSearch = si; break; }
                    }
                    var endNormIdx = normalized.indexOf(endNorm, startNormSearch);
                    if (endNormIdx >= 0) {
                        var endRange = normRangeToOrig(endNormIdx, endNorm.length);
                        end = endRange.end;
                    } else {
                        end = idx + searchText.length;
                    }
                } else {
                    end = endIdx > idx ? endIdx + endSearch.length : idx + searchText.length;
                }
            } else {
                // Try normalized whitespace match
                var searchNorm = normalizeStr(searchText);
                var normIdx = normalized.indexOf(searchNorm);
                if (normIdx >= 0) {
                    var startRange = normRangeToOrig(normIdx, searchNorm.length);
                    idx = startRange.start;
                    end = startRange.end;
                    // Try to extend to full quote end
                    if (d.quote.length > 80) {
                        var endNorm2 = normalizeStr(escapeHtml(d.quote.substring(d.quote.length - 30)));
                        var endNormIdx2 = normalized.indexOf(endNorm2, normIdx);
                        if (endNormIdx2 >= 0) {
                            end = normRangeToOrig(endNormIdx2, endNorm2.length).end;
                        }
                    }
                }

                // Try first significant words as anchor
                if (idx === -1) {
                    var rawQuote = escapeHtml(d.quote.trim());
                    var words = rawQuote.replace(/\s+/g, ' ').trim().split(' ').filter(function(w) { return w.length > 3; });
                    if (words.length >= 3) {
                        var anchor = normalizeStr(words.slice(0, 4).join(' '));
                        var anchorIdx = normalized.indexOf(anchor);
                        if (anchorIdx >= 0) {
                            var anchorRange = normRangeToOrig(anchorIdx, anchor.length);
                            idx = anchorRange.start;
                            end = anchorRange.end;
                        }
                    }
                }
            }

            if (idx === -1) continue;
            matches.push({ start: idx, end: end, cardIndex: d.cardIndex, risk: d.risk });
        }

        // Sort by position, remove overlaps
        matches.sort(function(a, b) { return a.start - b.start; });
        var filtered = [];
        var lastEnd = -1;
        for (var i = 0; i < matches.length; i++) {
            if (matches[i].start >= lastEnd) {
                filtered.push(matches[i]);
                lastEnd = matches[i].end;
            }
        }

        // Build HTML in one pass
        var html = '';
        var pos = 0;
        for (var i = 0; i < filtered.length; i++) {
            var m = filtered[i];
            html += text.substring(pos, m.start);
            var num = m.cardIndex + 1;
            html += '<span class="doc-highlight doc-highlight-' + m.risk + '" data-card-index="' + m.cardIndex + '">' +
                '<span class="doc-clause-marker doc-clause-marker-' + m.risk + '">' + num + '</span>' +
                text.substring(m.start, m.end) + '</span>';
            pos = m.end;
        }
        html += text.substring(pos);

        previewEl.innerHTML = html;
    }

    function syncSidebarHeight(cardEl) {
        var editLoading = document.querySelector('.editorial-loading');
        if (!editLoading || window.innerWidth <= 900) return;
        requestAnimationFrame(function() {
            var cardH = cardEl.getBoundingClientRect().height;
            editLoading.style.height = Math.max(250, cardH) + 'px';
        });
    }

    function scrollPreviewToCard(cardIndex) {
        var previewEl = $('editorialLoadingText');
        if (!previewEl) return;

        // Remove active from all highlights
        var highlights = previewEl.querySelectorAll('.doc-highlight');
        for (var i = 0; i < highlights.length; i++) {
            highlights[i].classList.remove('active');
        }

        // Activate the matching highlight and reveal the text
        var target = previewEl.querySelector('.doc-highlight[data-card-index="' + cardIndex + '"]');
        if (target) {
            target.classList.add('active');
            previewEl.classList.add('has-active-highlight');
            // Reliable scroll: use scrollIntoView with block:center within the scroll container
            // Calculate relative position and scroll manually for container-scoped scrolling
            var containerRect = previewEl.getBoundingClientRect();
            var targetRect = target.getBoundingClientRect();
            var relativeTop = targetRect.top - containerRect.top + previewEl.scrollTop;
            var centerOffset = previewEl.clientHeight / 2 - target.clientHeight / 2;
            previewEl.scrollTo({
                top: Math.max(0, relativeTop - centerOffset),
                behavior: 'smooth'
            });
        } else if (cardIndex === 0) {
            // First card: always scroll sidebar to top so user sees the beginning
            previewEl.scrollTo({ top: 0, behavior: 'smooth' });
        }
    }

    // ── Investigation phase updater ────────────────────────────
    function setInvestPhase(num, state, statusHtml) {
        var el = $('investPhase' + num);
        if (!el) return;
        el.className = 'investigation-phase' + (state ? ' ' + state : '');
        var statusEl = $('investPhase' + num + 'Status');
        if (statusEl && statusHtml) statusEl.innerHTML = statusHtml;
    }

    // ── Investigation text auto-scroll ──────────────────────
    var _investScrollTimer = null;
    var _investScrollY = 0;
    function startInvestigationScroll() {
        stopInvestigationScroll();
        var el = $('investigationText');
        if (!el || !el.textContent.trim()) return;
        _investScrollY = 0;
        el.style.transform = 'translateY(0)';
        // Loupe stays fixed — JS only scrolls the text beneath it
        _investScrollTimer = setInterval(function() {
            _investScrollY -= 1;
            el.style.transform = 'translateY(' + _investScrollY + 'px)';
            if (Math.abs(_investScrollY) > el.scrollHeight) {
                clearInterval(_investScrollTimer);
                _investScrollTimer = null;
            }
        }, 50);
    }
    function stopInvestigationScroll() {
        if (_investScrollTimer) { clearInterval(_investScrollTimer); _investScrollTimer = null; }
    }

    // ── Transition from editorial loading to card view ────────
    function transitionToCardView() {
        cardViewTransitioned = true;
        if (_autoRevealTimer) { clearTimeout(_autoRevealTimer); _autoRevealTimer = null; }

        var statusEl = $('editorialLoadingStatus');
        if (statusEl) statusEl.textContent = 'Analysis in progress...';

        // Live narration continues naturally from thinking stream — no timer to clear
        // Show contextual message only if no narration has been shown yet
        if (!opusSections.overall.done && !_lastNarrationTime) {
            showBriefingSentence('Expert verdict in progress');
        }

        // If verdict was auto-revealed, don't rip user away from it.
        // Show "cards ready" pill instead — user clicks when ready.
        if (_verdictAutoRevealed) {
            var crCount = flipCardContainer.querySelectorAll('.flip-card').length;
            if (crCount > 0) {
                $('cardsReadyText').textContent = crCount + ' card' + (crCount !== 1 ? 's' : '') + ' ready';
                $('cardsReadyPill').classList.remove('hidden');
            }
            return;
        }

        var skeleton = $('skeletonCard');
        var viewport = $('cardViewport');

        // Show context banner (Problem 1: emotional safety)
        $('eduReviewPill').classList.remove('hidden');



        // Update investigation phases
        var skStatusTxt = $('skeletonStatusText');
        if (skStatusTxt) skStatusTxt.textContent = 'Clause found';
        setInvestPhase(1, 'done', '\u2713 Done');
        setInvestPhase(2, 'done', '\u2713 Cards ready');

        // Stop investigation text scroll
        stopInvestigationScroll();

        // ── Transition: skeleton hides, cards + sidebar appear ──
        var investigationDoc = skeleton.querySelector('.investigation-doc');
        var hasSidebar = !!documentFullText;
        if (investigationDoc && hasSidebar) {
            swooshBriefingToCardNav(skeleton, viewport, investigationDoc);
        } else {
            // No sidebar — instant transition
            skeleton.classList.add('hidden');
            viewport.classList.remove('hidden');
            resultsArea.classList.remove('hidden');
            showCardAtIndex(0);
        }

        // Safety net: if quick_done doesn't arrive within 60s of first card,
        // treat cards as built so user can navigate to verdict
        if (_quickDoneSafetyTimer) clearTimeout(_quickDoneSafetyTimer);
        _quickDoneSafetyTimer = setTimeout(function() {
            if (!quickDone && !flipCardsBuilt) {
                console.log('[FlipSide] Safety net: quick_done not received after 60s, treating cards as built');
                quickDone = true;
                flipCardsBuilt = true;
                updateCardNavigation();
            }
        }, 60000);

        // Pulse the first flip trigger to draw attention
        var firstTrigger = viewport.querySelector('.flip-trigger');
        if (firstTrigger) {
            firstTrigger.classList.add('hint-pulse');
            var tooltip = document.createElement('span');
            tooltip.className = 'flip-hint-tooltip';
            tooltip.textContent = 'Tap to see what they\u2019re not telling you';
            firstTrigger.appendChild(tooltip);
        }
    }

    // ── Skeleton-to-card transition with sidebar woosh ──
    // Briefing panel stays in skeleton and gets hidden with it.
    // Live narration feeds into the verdict progress strip instead.
    function swooshBriefingToCardNav(skeleton, viewport, investigationDoc) {
        skeleton.classList.add('wooshing');
        investigationDoc.classList.add('woosh-to-sidebar');

        setTimeout(function() {
            skeleton.classList.add('hidden');
            skeleton.classList.remove('wooshing');
            investigationDoc.classList.remove('woosh-to-sidebar');
            viewport.classList.remove('hidden');
            resultsArea.classList.remove('hidden');
            showCardAtIndex(0);

            var layoutEl = document.querySelector('.analysis-layout');
            if (layoutEl) {
                layoutEl.classList.add('sidebar-visible');
                var loadingEl = $('editorialLoading');
                if (loadingEl) loadingEl.classList.add('woosh-in-sidebar');
                var visCard = flipCardContainer.querySelector('.flip-card');
                if (visCard) syncSidebarHeight(visCard);
            }
        }, 350);
    }

    // ── Tab title + notification when verdict is ready ──
    var _originalTitle = document.title;

    function onVerdictReady() {
        // Tab title change
        document.title = '\u2705 Your verdict is ready \u2014 FlipSide';

        // Restore title when user returns to tab
        function restoreTitle() {
            document.title = _originalTitle;
            document.removeEventListener('visibilitychange', onVisible);
            window.removeEventListener('focus', restoreTitle);
        }
        function onVisible() {
            if (!document.hidden) restoreTitle();
        }
        document.addEventListener('visibilitychange', onVisible);
        window.addEventListener('focus', restoreTitle);

        // Browser notification (if permitted)
        if ('Notification' in window && Notification.permission === 'granted') {
            try {
                var cardCount = flipCardContainer.querySelectorAll('.flip-card').length;
                new Notification('FlipSide \u2014 Verdict Ready', {
                    body: cardCount + ' clauses analyzed. Your expert verdict is ready to read.',
                    icon: '/favicon.ico'
                });
            } catch(e) { /* notification failed, no big deal */ }
        }

        // Update investigation phase 3 — expert is done
        setInvestPhase(3, 'done', '\u2713 Ready');
    }



    // ── Verdict column helpers (4-section live report) ─────────────────
    function hideVerdictCol() {
        verdictCol.classList.remove('visible');
        // On mobile, close bottom sheet
        if (window.innerWidth <= 900) {
            document.body.classList.remove('sheet-open');
        }
    }
    function markOpusSectionDone(source) {
        // Single thread — no gating needed
        _revealOpusSection(source);
    }
    function _revealOpusSection(source) {
        var sectionEl = $('opusSection_' + source);
        if (!sectionEl) return;
        // Unlock section: remove locked, mark dot as done
        sectionEl.classList.remove('locked');
        var dot = sectionEl.querySelector('.opus-dot');
        if (dot) { dot.classList.remove('pulsing'); dot.classList.add('done'); }
        // Fade out invitation on first section reveal
        var invEl = $('verdictInvitation');
        if (invEl && !invEl.classList.contains('fading')) {
            invEl.classList.add('fading');
            setTimeout(function() { invEl.classList.add('hidden'); }, 600);
        }
        // Don't auto-expand — user clicks to enter focused mode instead
        // Just do final render into the hidden body (ready when user clicks)
        var bodyEl = $('opusBody_' + source);
        if (bodyEl) {
            var text = opusSections[source].text;
            if (text.trim()) {
                var html = safeMd2Html(text);
                html = styleRiskBadges(html);
                html = styleWhyClauses(html);
                html = styleReaderBlocks(html);
                html = styleDrafterBlocks(html);
                html = styleSplitClauses(html);
                bodyEl.innerHTML = safeHtml(html);
            }
        }
        // If user is in focused mode, update the counter (new section available)
        if (_focusedSource) renderFocusedSection();
        // Update "Read full verdict" button visibility
        updateVerdictButton();
    }

    function updateVerdictButton() {
        if (opusSections.overall.done) {
            // Full verdict ready
            verdictExpandBtn.innerHTML = 'Read full verdict <span class="verdict-expand-spin">\u27F3</span>';
            verdictExpandBtn.classList.add('ready');
            verdictExpandBtn.classList.remove('preview');
            verdictExpandBtn.style.opacity = '1';
            verdictExpandBtn.style.pointerEvents = 'auto';
            buildVerdictSummary();
        } else if (_coreVerdictReady) {
            // Core tags arrived — allow early access
            verdictExpandBtn.innerHTML = 'Preview verdict <span style="opacity:0.5;font-size:0.65rem">(building\u2026)</span>';
            verdictExpandBtn.classList.add('ready', 'preview');
            verdictExpandBtn.style.opacity = '1';
            verdictExpandBtn.style.pointerEvents = 'auto';
        } else {
            verdictExpandBtn.textContent = 'Verdict building\u2026';
            verdictExpandBtn.classList.remove('ready', 'preview');
            verdictExpandBtn.style.opacity = '0.4';
            verdictExpandBtn.style.pointerEvents = 'none';
        }
        updateVerdictStrip();
    }

    // ── Verdict progress strip (below card nav) ──────────────
    var _currentStripState = 'building';
    var _pendingStripState = null;

    function updateVerdictStrip() {
        var strip = $('verdictProgressStrip');
        if (!strip) return;
        // Hide if user hasn't flipped yet or already clicked through
        if (!hasFlippedOnce || _verdictStripRead) {
            strip.classList.remove('visible');
            return;
        }

        // Determine target state
        var targetState = 'building';
        if (deepTextComplete || isDoneRendering) targetState = 'ready';
        else if (_coreVerdictReady) targetState = 'peek';

        // Defer upgrades when user is reading a flipped card (mid-flip)
        var layout = document.querySelector('.analysis-layout');
        var isFlipped = layout && layout.classList.contains('layout-flipped');
        if (isFlipped && targetState !== _currentStripState && targetState !== 'building') {
            _pendingStripState = targetState;
            strip.classList.add('visible');
            return;
        }

        _applyStripState(targetState);
        strip.classList.add('visible');
    }

    function _applyStripState(state) {
        var building = $('verdictStripBuilding');
        var peek = $('verdictStripPeek');
        var ready = $('verdictStripReady');
        var textEl = $('verdictStripText');

        if (state === 'ready') {
            if (building) building.classList.add('hidden');
            if (peek) peek.classList.add('hidden');
            if (ready) ready.classList.remove('hidden');
        } else if (state === 'peek') {
            if (building) building.classList.add('hidden');
            if (peek) peek.classList.remove('hidden');
            if (ready) ready.classList.add('hidden');
        } else {
            if (building) building.classList.remove('hidden');
            if (peek) peek.classList.add('hidden');
            if (ready) ready.classList.add('hidden');
            if (textEl) textEl.textContent = 'Expert analyzing\u2026';
        }
        _currentStripState = state;
        _pendingStripState = null;
    }

    function dismissVerdictStrip() {
        _verdictStripRead = true;
        var strip = $('verdictProgressStrip');
        if (strip) strip.classList.remove('visible');
    }

    // ── Thinking viewer (opt-in) ─────────────────────────────
    function toggleThinkingViewer() {
        _thinkingViewerOpen = !_thinkingViewerOpen;
        var viewer = $('thinkingViewer');
        var toggle = $('thinkingToggle');
        if (!viewer || !toggle) return;
        if (_thinkingViewerOpen) {
            viewer.classList.add('open');
            toggle.classList.add('open');
            viewer.textContent = _opusThinkingText || 'Waiting for expert to start thinking\u2026';
            viewer.scrollTop = viewer.scrollHeight;
        } else {
            viewer.classList.remove('open');
            toggle.classList.remove('open');
        }
    }

    function appendOpusThinking(text) {
        _opusThinkingText += text;
        // Show toggle pill on first thinking content
        var toggle = $('thinkingToggle');
        if (toggle && !toggle.classList.contains('visible')) {
            toggle.classList.add('visible');
        }
        // Update token count in label
        var tokens = Math.round(_opusThinkingText.length / 4);
        var label = $('thinkingToggleLabel');
        if (label) {
            label.textContent = tokens.toLocaleString() + ' tokens thinking';
        }
        // If viewer is open, append live
        if (_thinkingViewerOpen) {
            var viewer = $('thinkingViewer');
            if (viewer) {
                viewer.textContent = _opusThinkingText;
                // Auto-scroll if near bottom
                var nearBottom = viewer.scrollHeight - viewer.scrollTop - viewer.clientHeight < 60;
                if (nearBottom) viewer.scrollTop = viewer.scrollHeight;
            }
        }
        // ── Expert Mind: stream thinking into loading screen ──
        // narrateFromThinking() is called inside updateExpertMind — not here too
        updateExpertMind(text, tokens);
    }

    // ── Expert Briefing: narrated AI progress ──
    var _briefingRevealed = false;
    var _narrateBuffer = '';          // accumulates thinking text until sentence boundary
    var _lastNarrationTime = 0;       // rate-limit: don't update faster than every 3.5s
    var _shownNarrations = {};        // dedup: don't repeat the same narration
    var _narrateMinInterval = 3000;    // ms between narration updates
    var _workerDotsReady = 0;

    // ── Live narration: show real sentences from Opus thinking stream ──

    function scoreNarration(s) {
        var score = 0;
        // Boost: specific numbers (dollar, percent, duration)
        if (/\$[\d,]+|\d+\s*%|\d+\s*(month|year|day|week|hour)/i.test(s)) score += 3;
        // Boost: document structure references
        if (/section|clause|article|paragraph|page/i.test(s)) score += 2;
        // Boost: names a party or role
        if (/employer|employee|tenant|landlord|company|customer|organizer|participant|borrower|lender|insurer|policyholder|licensor|licensee|vendor|buyer|seller/i.test(s)) score += 2;
        // Boost: identifies a finding or risk
        if (/restrict|limit|prohibit|require|waive|forfeit|penalty|fee|terminate|liable|risk|broad|unusual|significant|hidden|buried|one-sided|uncapped|compound/i.test(s)) score += 2;
        // Boost: concrete legal concept
        if (/non-?compete|indemnif|arbitrat|auto-?renew|confidential|intellectual property|force majeure|governing law|liability cap|severab|sublicens|perpetual|irrevocab/i.test(s)) score += 2;
        // Penalize: meta-reasoning / self-talk that survived cleanup
        if (/^(This is|There is|It is|That's|These are) /i.test(s)) score -= 1;
        if (/^(The document|The contract|The agreement|According to) /i.test(s)) score -= 1;
        return score;
    }

    function cleanNarrationSentence(s) {
        // Strip bullets, dashes, numbering, markdown bold/headers
        s = s.replace(/^[-*•]\s*/, '').replace(/^\d+[.)]\s*/, '').replace(/\*+/g, '').replace(/^#+\s*/, '').trim();
        if (s.length < 20 || s.length > 220) return null;
        // Skip ALL-CAPS headers
        if (/^[A-Z\s]{8,}$/.test(s)) return null;
        // Strip label prefixes (RED FLAG:, NOTE:, etc)
        if (/^(RED FLAG|GREEN FLAG|YELLOW FLAG|NOTE|WARNING|SUMMARY):/i.test(s)) {
            s = s.replace(/^[^:]+:\s*/, '');
            if (s.length < 15) return null;
        }
        // Strip LLM self-talk prefixes
        s = s.replace(/^(Hmm,?\s*|OK,?\s*|Well,?\s*|So,?\s*|Now,?\s*|Right,?\s*|Let me\s+\w+\s*[,.]?\s*|I need to\s+|I should\s+|I think\s+|I notice\s+|I see\s+|I'm \w+ing\s+|Actually,?\s*|Wait,?\s*|About\s+what's\s+)/i, '');
        // Strip reasoning connectors
        s = s.replace(/^(This means that|This indicates that|This suggests that|This is because|It's worth noting that|Importantly,|Notably,|Interestingly,)\s*/i, '');
        if (s.length < 15) return null;
        // Capitalize first letter
        s = s.charAt(0).toUpperCase() + s.slice(1);
        // Trim trailing period
        s = s.replace(/\.\s*$/, '');
        // Truncate if still long
        if (s.length > 120) s = s.substring(0, 118) + '\u2026';
        return s;
    }

    function narrateFromThinking(chunk) {
        _narrateBuffer += chunk;

        // Rate limit — don't update faster than every 3s
        if (Date.now() - _lastNarrationTime < _narrateMinInterval) return;

        // Split on sentence boundaries
        var parts = _narrateBuffer.split(/(?<=[.!?])\s+|\n+/);
        if (parts.length < 2) return; // no complete sentence yet

        // Keep the incomplete tail for next time
        var tail = parts.pop();
        _narrateBuffer = tail;

        // Score all recent candidates, pick the best
        var best = null, bestScore = -Infinity;
        for (var i = parts.length - 1; i >= Math.max(0, parts.length - 5); i--) {
            var s = cleanNarrationSentence(parts[i].trim());
            if (!s) continue;
            // Dedup check
            var key = s.substring(0, 40);
            if (_shownNarrations[key]) continue;
            var sc = scoreNarration(s);
            if (sc > bestScore) { best = s; bestScore = sc; }
        }

        if (!best || bestScore < 1) return; // nothing specific enough

        _shownNarrations[best.substring(0, 40)] = true;
        showBriefingSentence(best);
        showCapTickerNarration(best);
        _lastNarrationTime = Date.now();
    }

    function updateExpertMind(newText, tokenCount) {
        var panel = $('expertBriefing');
        var skeleton = $('skeletonCard');
        if (!panel || !skeleton || skeleton.classList.contains('hidden')) return;

        // Reveal briefing on first thinking content
        if (!_briefingRevealed) {
            _briefingRevealed = true;
            panel.classList.add('visible');
            // Compress investigation phases (hide them)
            var phases = $('skeletonActs');
            if (phases) phases.classList.add('compressed');
        }

        // Extract live narration from the thinking stream
        narrateFromThinking(newText);

        // Update depth counter
        var angles = Math.round(tokenCount / 90);
        var depthEl = $('briefingDepth');
        if (depthEl && angles > 0) {
            depthEl.innerHTML = '<span class="depth-count">' + angles + '</span> angles considered';
        }

        // Update expert track detail
        var expertDetail = $('trackExpertDetail');
        if (expertDetail) {
            if (tokenCount > 800) {
                expertDetail.innerHTML = '<span class="accent">' + tokenCount.toLocaleString() + '</span> tokens of reasoning';
            } else {
                expertDetail.textContent = 'Deep analysis in progress';
            }
        }
    }

    function showBriefingSentence(text) {
        var el = $('briefingSentence');
        if (!el) return;
        // Fade out current
        el.classList.remove('visible');
        el.classList.add('fading');
        setTimeout(function() {
            el.textContent = text;
            el.classList.remove('fading');
            el.classList.add('visible');
        }, 300);
    }

    // ── Document context card on loading screen ──
    function flagForJurisdiction(j) {
        if (!j) return '';
        var flag = jurisdictionFlag(j);
        return flag || '\ud83c\udf10'; // globe fallback
    }

    function renderDocContext(data) {
        var el = $('docContext');
        if (!el || !data || Object.keys(data).length === 0) return;

        var flag = flagForJurisdiction(data.JURISDICTION || '');
        var items = [];

        var fields = [
            ['TYPE', 'Document'],
            ['DRAFTER', 'Drafted by'],
            ['OTHER_PARTY', 'Signed by'],
            ['JURISDICTION', 'Jurisdiction'],
            ['DURATION', 'Duration'],
            ['KEY_AMOUNT', 'Key amount'],
            ['DATE', 'Date'],
        ];
        for (var i = 0; i < fields.length; i++) {
            var val = data[fields[i][0]];
            if (val) {
                var display = escapeHtml(val);
                if (fields[i][0] === 'JURISDICTION' && flag) {
                    display = '<span class="doc-context-flag">' + flag + '</span> ' + display;
                }
                items.push(
                    '<div class="doc-context-item">' +
                    '<span class="doc-context-key">' + fields[i][1] + '</span>' +
                    '<span class="doc-context-val">' + display + '</span>' +
                    '</div>'
                );
            }
        }

        if (items.length === 0) return;

        el.innerHTML =
            '<div class="doc-context-label">Document profile</div>' +
            '<div class="doc-context-grid">' + items.join('') + '</div>';
        el.classList.remove('hidden');
        el.classList.add('visible');
    }

    function resetDocContext() {
        var el = $('docContext');
        if (el) {
            el.innerHTML = '';
            el.classList.add('hidden');
            el.classList.remove('visible');
        }
    }

    function showCapTickerNarration(text) {
        // Replace canned capability messages with real thinking
        if (!capTicker) return;
        stopCapTicker(); // stop canned rotation on first real sentence
        capTicker.classList.remove('hidden');
        // Fade transition
        capTicker.classList.add('fade-swap');
        setTimeout(function() {
            var short = text.length > 90 ? text.substring(0, 88) + '\u2026' : text;
            capTicker.innerHTML = '<span class="cap-label">THINKING</span> ' + escapeHtml(short);
            capTicker.classList.remove('fade-swap');
        }, 300);
    }

    function resetExpertMind() {
        _briefingRevealed = false;
        _narrateBuffer = '';
        _shownNarrations = {};
        _lastNarrationTime = 0;
        _workerDotsReady = 0;
        resetDocContext();
        var panel = $('expertBriefing');
        if (panel) panel.classList.remove('visible');
        var sentence = $('briefingSentence');
        if (sentence) {
            sentence.textContent = 'Reading your document from start to finish';
            sentence.classList.add('visible');
            sentence.classList.remove('fading');
        }
        var phases = $('skeletonActs');
        if (phases) phases.classList.remove('compressed');
        var depthEl = $('briefingDepth');
        if (depthEl) depthEl.innerHTML = '';
        var readersDetail = $('trackReadersDetail');
        if (readersDetail) readersDetail.textContent = 'Scanning for key clauses';
        var expertDetail = $('trackExpertDetail');
        if (expertDetail) expertDetail.textContent = 'Starting deep analysis';
        var readersInd = $('trackReaders');
        if (readersInd) readersInd.classList.remove('done');
        var expertInd = $('trackExpert');
        if (expertInd) expertInd.classList.remove('done');
    }

    function markWorkerDone() {
        _workerDotsReady++;
        var detail = $('trackReadersDetail');
        if (detail) {
            detail.textContent = _workerDotsReady + ' clause' + (_workerDotsReady !== 1 ? 's' : '') + ' analyzed';
        }
    }

    function resetThinkingViewer() {
        _opusThinkingText = '';
        _thinkingViewerOpen = false;
        var viewer = $('thinkingViewer');
        var toggle = $('thinkingToggle');
        if (viewer) { viewer.classList.remove('open'); viewer.textContent = ''; }
        if (toggle) { toggle.classList.remove('visible', 'open'); }
        resetExpertMind();
    }

    function buildVerdictSummary() {
        var el = $('verdictSummary');
        if (!el || el.classList.contains('visible')) return;
        var overall = opusSections.overall.text || '';

        // Extract summary from tagged format
        var lines = overall.split('\n');
        var conclusion = '';
        for (var i = 0; i < lines.length; i++) {
            var l = lines[i].trim().replace(/\*\*/g, '').replace(/\*/g, '');
            // Skip headings, scores, labels, numbered lists, empty lines
            if (!l || l.startsWith('#') || l.startsWith('---') || /^Overall Risk/i.test(l) || /^Power Imbalance/i.test(l) || /^Verdict:/i.test(l) || /^\d+\/100/.test(l) || /^SEVERITY/i.test(l) || /^\d+\.\s/.test(l) || /^\d+:\d+/.test(l) || l.length < 20) continue;
            conclusion = l;
            break;
        }

        if (!conclusion) return;
        if (conclusion.length > 200) conclusion = conclusion.substring(0, 198).replace(/\s+\S*$/, '') + '…';
        el.innerHTML = '<div style="font-size:0.72rem;color:var(--text-secondary);line-height:1.5">' + escapeHtml(conclusion) + '</div>';
        el.classList.add('visible');
    }
    function resetVerdictCol() {
        hideVerdictCol();
        exitFocusedMode();
        verdictCol.classList.remove('standby', 'thinking', 'writing', 'ready', 'collapsed');
        // Reset doc profile in verdict
        var vProfile = $('verdictDocProfile');
        if (vProfile) vProfile.classList.add('hidden');
        var vMeta = $('verdictDocMeta');
        if (vMeta) vMeta.innerHTML = '';
        var vThumb = $('verdictDocThumb');
        if (vThumb) vThumb.classList.add('hidden');
        verdictTitle.textContent = 'Expert report';
        verdictExpandBtn.textContent = 'Verdict building\u2026';
        verdictExpandBtn.classList.remove('ready');
        verdictExpandBtn.style.opacity = '0.4';
        verdictExpandBtn.style.pointerEvents = 'none';
        var summaryEl = $('verdictSummary');
        if (summaryEl) { summaryEl.innerHTML = ''; summaryEl.classList.remove('visible'); }
        // Reset accumulators and section UI — lock all sections
        Object.keys(opusSections).forEach(function(k) {
            opusSections[k] = { text: '', done: false };
            var bodyEl = $('opusBody_' + k);
            if (bodyEl) { bodyEl.innerHTML = ''; bodyEl.classList.add('collapsed'); }
            var sectionEl = $('opusSection_' + k);
            if (sectionEl) sectionEl.classList.add('locked');
            var dot = document.querySelector('#opusSection_' + k + ' .opus-dot');
            if (dot) { dot.classList.remove('done'); dot.classList.add('pulsing'); }
        });
        // Reset verdict strip state
        _verdictStripRead = false;
        var verdictStatusEl = $('verdictStatus');
        if (verdictStatusEl) {
            verdictStatusEl.innerHTML = 'Our expert is reading the small print <span class="verdict-time-pill" id="verdictCountdown">2:00</span>';
            verdictStatusEl.classList.remove('hidden');
        }
        var invEl = $('verdictInvitation');
        if (invEl) { invEl.classList.remove('hidden', 'fading'); }
        // Reset live tricks panel
        _detectedTricks = {};
        var tricksPanel = $('verdictTricks');
        if (tricksPanel) tricksPanel.classList.add('hidden');
        var tricksList = $('verdictTricksList');
        if (tricksList) tricksList.innerHTML = '';
        startVerdictCountdown();
    }

    // ── Live tricks panel ──────────────────────────────────
    function trackTrick(trick) {
        if (!trick || trick.toLowerCase() === 'none') return;
        _detectedTricks[trick] = (_detectedTricks[trick] || 0) + 1;
        renderVerdictTricks();
    }

    function renderVerdictTricks() {
        var panel = $('verdictTricks');
        var list = $('verdictTricksList');
        if (!panel || !list) return;

        var sorted = Object.keys(_detectedTricks).sort(function(a, b) {
            return _detectedTricks[b] - _detectedTricks[a];
        });
        if (sorted.length === 0) { panel.classList.add('hidden'); return; }

        // Top 10
        var top = sorted.slice(0, 10);
        var html = '';
        top.forEach(function(trick) {
            var icon = TRICK_ICONS[trick] || '';
            var desc = TRICK_DESCRIPTIONS[trick] || '';
            var count = _detectedTricks[trick];
            html += '<span class="verdict-trick-item">';
            if (icon) html += '<span class="verdict-trick-icon">' + icon + '</span>';
            html += '<span class="verdict-trick-name">' + escapeHtml(trick) + '</span>';
            if (count > 1) html += '<span class="verdict-trick-count">\u00d7' + count + '</span>';
            if (desc) html += '<span class="verdict-trick-desc">' + escapeHtml(desc) + '</span>';
            html += '</span>';
        });
        list.innerHTML = html;
        panel.classList.remove('hidden');
    }

    // ── Focused reading mode state ──────────────────────────
    var _focusedSource = null; // currently focused section key or null
    var _sectionOrder = ['overall'];
    var _sectionLabels = {
        overall: 'Expert Verdict'
    };

    function getCompletedSections() {
        return _sectionOrder.filter(function(k) {
            return opusSections[k] && opusSections[k].done;
        });
    }

    function enterFocusedMode(source) {
        _focusedSource = source;
        verdictBody.classList.add('in-focus');
        var panel = $('verdictFocusedPanel');
        if (panel) panel.classList.add('active');
        renderFocusedSection();
    }

    function exitFocusedMode() {
        _focusedSource = null;
        verdictBody.classList.remove('in-focus');
        var panel = $('verdictFocusedPanel');
        if (panel) panel.classList.remove('active');
    }

    function renderFocusedSection() {
        if (!_focusedSource) return;
        var completed = getCompletedSections();
        var idx = completed.indexOf(_focusedSource);
        var total = completed.length;
        var allDone = opusSections.overall.done;

        // Title
        var titleEl = $('focusedTitle');
        if (titleEl) titleEl.textContent = _sectionLabels[_focusedSource] || _focusedSource;

        // Content
        var contentEl = $('focusedContent');
        if (contentEl) {
            var text = opusSections[_focusedSource].text;
            if (text.trim()) {
                var html = safeMd2Html(text);
                html = styleRiskBadges(html);
                html = styleWhyClauses(html);
                html = styleReaderBlocks(html);
                html = styleDrafterBlocks(html);
                html = styleSplitClauses(html);
                contentEl.innerHTML = safeHtml(html);
            } else {
                contentEl.innerHTML = '<p style="color:var(--text-muted);font-style:italic;">Content loading...</p>';
            }
            contentEl.scrollTop = 0;
        }

        // Nav arrows
        var prevEl = $('focusedPrev');
        var nextEl = $('focusedNext');
        if (prevEl) prevEl.disabled = (idx <= 0);
        if (nextEl) nextEl.disabled = (idx >= total - 1);

        // Counter: "Section 1 · 2 of 4 ready" or "Section 1 · Full report ready →"
        var counterEl = $('focusedCounter');
        if (counterEl) {
            if (allDone) {
                counterEl.innerHTML = 'Section ' + (idx + 1) + ' of ' + total + ' · <a class="ready-link" id="focusedReadAll">Full report ready \u2192</a>';
                var readAllLink = $('focusedReadAll');
                if (readAllLink) {
                    readAllLink.addEventListener('click', function() {
                        exitFocusedMode();
                        revealDeepAnalysis(true);
                    });
                }
            } else {
                counterEl.textContent = 'Section ' + (idx + 1) + ' \u00b7 Verdict building\u2026';
            }
        }
    }

    function navigateFocused(dir) {
        if (!_focusedSource) return;
        var completed = getCompletedSections();
        var idx = completed.indexOf(_focusedSource);
        var next = idx + dir;
        if (next >= 0 && next < completed.length) {
            _focusedSource = completed[next];
            renderFocusedSection();
        }
    }

    // Click handler: open focused mode on completed sections, block pulsing ones
    verdictBody.addEventListener('click', function(e) {
        var header = e.target.closest('.opus-section-header');
        if (!header) return;
        var source = header.getAttribute('data-toggle');
        if (!source) return;
        // Block click on locked/pulsing sections
        var sectionEl = $('opusSection_' + source);
        if (sectionEl && sectionEl.classList.contains('locked')) return;
        if (!opusSections[source].done) return;
        // Enter focused reading mode
        enterFocusedMode(source);
    });

    // Focused panel navigation
    var _fcClose = $('focusedClose'), _fcPrev = $('focusedPrev'), _fcNext = $('focusedNext');
    if (_fcClose) _fcClose.addEventListener('click', function() { exitFocusedMode(); });
    if (_fcPrev) _fcPrev.addEventListener('click', function() { navigateFocused(-1); });
    if (_fcNext) _fcNext.addEventListener('click', function() { navigateFocused(1); });

    // ── Reveal full verdict (progressive — streams as it builds) ──────
    var _verdictPollTimer = null;
    // _verdictScrolled removed — scroll is now intent-driven via userInitiated param

    function assembleDeepText() {
        return opusSections.overall.text || '';
    }

    // ── Progressive verdict: render tags as they close during streaming ──
    var _VERDICT_CORE_TAGS = ['VERDICT_TIER', 'WHAT_IS_THIS', 'SHOULD_YOU_WORRY', 'THE_MAIN_THING', 'ONE_ACTION'];
    var _VERDICT_ALL_TAGS = ['VERDICT_TIER', 'WHAT_IS_THIS', 'SHOULD_YOU_WORRY', 'THE_MAIN_THING', 'ONE_ACTION', 'POWER_RATIO', 'JURISDICTION', 'RISKS', 'CHECKLIST', 'FLAGGED_CLAIMS', 'COLOPHON'];

    function tryProgressiveVerdictRender() {
        var text = opusSections.overall.text || '';
        var newTags = false;
        for (var i = 0; i < _VERDICT_ALL_TAGS.length; i++) {
            var tag = _VERDICT_ALL_TAGS[i];
            if (_renderedVerdictTags[tag]) continue;
            var closeTag = '[/' + tag + ']';
            if (text.indexOf(closeTag) !== -1) {
                _renderedVerdictTags[tag] = true;
                newTags = true;
            }
        }
        if (!newTags) return;
        // Core verdict ready when VERDICT_TIER + THE_MAIN_THING have closed
        if (_renderedVerdictTags['VERDICT_TIER'] && _renderedVerdictTags['THE_MAIN_THING'] && !_coreVerdictReady) {
            _coreVerdictReady = true;
            updateVerdictButton();
            // If inline verdict is visible (flash verdict showing), upgrade it
            var inlineVerdict = $('inlineVerdict');
            if (inlineVerdict && inlineVerdict.classList.contains('visible')) {
                revealDeepAnalysis();
            }
        }
        // If user is already viewing the verdict, live-update it (preserving expanded sections)
        var inlineContent = $('inlineVerdictContent');
        if (inlineContent && $('inlineVerdict').classList.contains('visible') && _coreVerdictReady) {
            _saveVerdictLayerState();
            inlineContent.innerHTML = renderOneScreenVerdict(text);
            _restoreVerdictLayerState();
            // Ensure divider reflects real verdict, not flash scan
            var dt = $('verdictDividerText');
            var isDone = opusSections.overall.done || deepTextComplete || isDoneRendering;
            if (dt) dt.textContent = isDone ? 'Full Expert Verdict' : 'Expert Verdict (building\u2026)';
        }
    }

    // ── Flash verdict: quick summary from card data while Opus runs ──
    function buildFlashVerdict() {
        var cards = flipCardContainer.querySelectorAll('.flip-card');
        if (cards.length === 0) return;
        var counts = { red: 0, yellow: 0, green: 0 };
        var worstCard = null;
        var worstScore = 0;
        var tricks = {};
        for (var i = 0; i < cards.length; i++) {
            var r = cards[i].getAttribute('data-risk-level') || 'green';
            if (counts[r] !== undefined) counts[r]++;
            var shouldRead = cards[i].getAttribute('data-should-read') || '';
            var clauseTitle = cards[i].getAttribute('data-clause-title') || '';
            var score = parseInt(cards[i].getAttribute('data-score') || '0');
            var trickName = cards[i].getAttribute('data-trick') || '';
            if (score > worstScore && shouldRead) {
                worstScore = score;
                worstCard = shouldRead;
            }
            if (trickName) tricks[trickName] = (tricks[trickName] || 0) + 1;
        }
        var total = cards.length;
        var html = '<div class="flash-verdict">';
        html += '<div class="flash-verdict-label">Quick scan results</div>';
        // Risk breakdown
        html += '<div class="flash-verdict-risks">';
        if (counts.red > 0) html += '<span class="flash-risk flash-risk-red">' + counts.red + ' concern' + (counts.red !== 1 ? 's' : '') + '</span>';
        if (counts.yellow > 0) html += '<span class="flash-risk flash-risk-yellow">' + counts.yellow + ' caution' + (counts.yellow !== 1 ? 's' : '') + '</span>';
        if (counts.green > 0) html += '<span class="flash-risk flash-risk-green">' + counts.green + ' fair</span>';
        html += ' <span class="flash-risk-total">in ' + total + ' clauses</span>';
        html += '</div>';
        // Worst clause
        if (worstCard && worstScore > 50) {
            html += '<div class="flash-verdict-worst">Highest risk: <strong>' + escapeHtml(worstCard) + '</strong> (score ' + worstScore + ')</div>';
        }
        // Top tricks
        var trickNames = Object.keys(tricks).sort(function(a, b) { return tricks[b] - tricks[a]; }).slice(0, 3);
        if (trickNames.length > 0) {
            html += '<div class="flash-verdict-tricks">Tricks found: ' + trickNames.map(function(t) { return escapeHtml(t); }).join(', ') + '</div>';
        }
        html += '<div class="flash-verdict-waiting"><span class="pulsing-dots"><span></span><span></span><span></span></span> Expert verdict building\u2026</div>';
        html += '</div>';
        // Show in inline verdict area
        var inlineVerdict = $('inlineVerdict');
        var inlineContent = $('inlineVerdictContent');
        if (inlineVerdict && inlineContent) {
            inlineContent.innerHTML = html;
            inlineVerdict.classList.add('visible');
            // Label the divider as quick scan — not the full verdict yet
            var dividerText = $('verdictDividerText');
            if (dividerText) dividerText.textContent = 'Quick Scan Results';
        }
    }

    // ── Tagged output parser for one-screen verdict ──────────────
    function parseTag(text, tagName) {
        var re = new RegExp('\\[' + tagName + '\\]([\\s\\S]*?)\\[\\/' + tagName + '\\]');
        var m = re.exec(text);
        return m ? m[1].trim() : '';
    }

    function hasTaggedContent(text) {
        return /\[VERDICT_TIER\]/.test(text) || /\[WHAT_IS_THIS\]/.test(text) || /\[THE_MAIN_THING\]/.test(text);
    }

    var TIER_CONFIG = {
        'SIGN WITH CONFIDENCE':     { color: 'green',  icon: '\u2705', label: 'Sign with confidence' },
        'READ THE FLAGGED CLAUSES': { color: 'yellow', icon: '\u26A0\uFE0F', label: 'Read the flagged clauses' },
        'NEGOTIATE BEFORE SIGNING': { color: 'orange', icon: '\uD83E\uDD1D', label: 'Negotiate before signing' },
        'SEEK LEGAL REVIEW':        { color: 'red',    icon: '\u2696\uFE0F', label: 'Seek legal review' },
        'DO NOT SIGN':              { color: 'red',    icon: '\uD83D\uDED1', label: 'Do not sign' }
    };

    // ── Country flag from jurisdiction text ─────────────────
    var JURISDICTION_FLAGS = {
        // Countries
        'usa': 'US', 'united states': 'US', 'u.s.': 'US', 'u.s.a.': 'US', 'america': 'US',
        'uk': 'GB', 'united kingdom': 'GB', 'england': 'GB', 'scotland': 'GB', 'wales': 'GB', 'great britain': 'GB',
        'canada': 'CA', 'australia': 'AU', 'new zealand': 'NZ',
        'germany': 'DE', 'deutschland': 'DE', 'france': 'FR', 'italy': 'IT', 'italia': 'IT',
        'spain': 'ES', 'espa\u00f1a': 'ES', 'portugal': 'PT', 'netherlands': 'NL', 'holland': 'NL',
        'belgium': 'BE', 'austria': 'AT', 'switzerland': 'CH', 'sweden': 'SE', 'norway': 'NO',
        'denmark': 'DK', 'finland': 'FI', 'ireland': 'IE', 'poland': 'PL', 'czech': 'CZ',
        'greece': 'GR', 'hungary': 'HU', 'romania': 'RO', 'bulgaria': 'BG', 'croatia': 'HR',
        'luxembourg': 'LU', 'estonia': 'EE', 'latvia': 'LV', 'lithuania': 'LT', 'slovakia': 'SK', 'slovenia': 'SI',
        'japan': 'JP', 'china': 'CN', 'south korea': 'KR', 'korea': 'KR', 'india': 'IN',
        'brazil': 'BR', 'mexico': 'MX', 'argentina': 'AR', 'colombia': 'CO', 'chile': 'CL',
        'singapore': 'SG', 'hong kong': 'HK', 'taiwan': 'TW', 'israel': 'IL',
        'south africa': 'ZA', 'nigeria': 'NG', 'kenya': 'KE', 'egypt': 'EG',
        'uae': 'AE', 'united arab emirates': 'AE', 'saudi arabia': 'SA', 'turkey': 'TR',
        'russia': 'RU', 'ukraine': 'UA', 'indonesia': 'ID', 'thailand': 'TH',
        'malaysia': 'MY', 'philippines': 'PH', 'vietnam': 'VN', 'pakistan': 'PK',
        // US states → US flag
        'california': 'US', 'new york': 'US', 'texas': 'US', 'florida': 'US', 'illinois': 'US',
        'delaware': 'US', 'washington': 'US', 'massachusetts': 'US', 'georgia': 'US',
        'pennsylvania': 'US', 'ohio': 'US', 'virginia': 'US', 'colorado': 'US',
        'michigan': 'US', 'arizona': 'US', 'nevada': 'US', 'oregon': 'US', 'maryland': 'US',
        'new jersey': 'US', 'north carolina': 'US', 'minnesota': 'US', 'connecticut': 'US',
        // EU → EU flag
        'eu': 'EU', 'european union': 'EU',
        // Canadian provinces → CA flag
        'ontario': 'CA', 'quebec': 'CA', 'british columbia': 'CA', 'alberta': 'CA',
        // Australian states → AU flag
        'new south wales': 'AU', 'victoria': 'AU', 'queensland': 'AU',
    };
    function jurisdictionFlag(locText) {
        if (!locText) return '';
        var lower = locText.toLowerCase().trim();
        // Try exact country/region matches (longest first to match "south korea" before "korea")
        var keys = Object.keys(JURISDICTION_FLAGS).sort(function(a, b) { return b.length - a.length; });
        for (var i = 0; i < keys.length; i++) {
            if (lower.indexOf(keys[i]) !== -1) {
                var code = JURISDICTION_FLAGS[keys[i]];
                if (code === 'EU') return '\uD83C\uDDEA\uD83C\uDDFA'; // EU flag
                // Convert ISO 3166-1 alpha-2 to regional indicator symbols
                return String.fromCodePoint(0x1F1E6 + code.charCodeAt(0) - 65) +
                       String.fromCodePoint(0x1F1E6 + code.charCodeAt(1) - 65);
            }
        }
        return '';
    }

    // Track which verdict layers the user has expanded (persists across re-renders)
    var _expandedVerdictLayers = {};

    function _saveVerdictLayerState() {
        var layers = document.querySelectorAll('.verdict-layer');
        for (var i = 0; i < layers.length; i++) {
            var id = layers[i].id;
            if (id) _expandedVerdictLayers[id] = !layers[i].classList.contains('collapsed');
        }
        // Save which deep dive panel is open (survives verdict re-renders)
        _expandedVerdictLayers._openDeepDive = null;
        DEEP_DIVE_SOURCES.forEach(function(s) {
            var panel = $('depthPanel_' + s);
            if (panel && panel.classList.contains('visible')) {
                _expandedVerdictLayers._openDeepDive = s;
            }
        });
    }

    function _restoreVerdictLayerState() {
        for (var id in _expandedVerdictLayers) {
            if (id.charAt(0) === '_') continue;
            var el = document.getElementById(id);
            if (el && _expandedVerdictLayers[id]) {
                el.classList.remove('collapsed');
            }
        }
        // Restore open deep dive panel + re-render its content
        var openDD = _expandedVerdictLayers._openDeepDive;
        if (openDD) {
            var panel = $('depthPanel_' + openDD);
            var btn = document.querySelector('.verdict-depth-btn[data-depth="' + openDD + '"]');
            if (panel) {
                panel.classList.add('visible');
                updateDeepDivePanel(openDD);
            }
            if (btn) btn.classList.add('active');
        }
    }

    function renderOneScreenVerdict(text) {
        var tier = parseTag(text, 'VERDICT_TIER').toUpperCase().trim();
        var whatIsThis = parseTag(text, 'WHAT_IS_THIS');
        var shouldYouWorry = parseTag(text, 'SHOULD_YOU_WORRY');
        var theMainThing = parseTag(text, 'THE_MAIN_THING');
        var oneAction = parseTag(text, 'ONE_ACTION');
        var powerRatio = parseTag(text, 'POWER_RATIO');
        var risks = parseTag(text, 'RISKS');
        var flaggedClaims = parseTag(text, 'FLAGGED_CLAIMS');
        var checklist = parseTag(text, 'CHECKLIST');
        var colophon = parseTag(text, 'COLOPHON');
        var jurisdiction = parseTag(text, 'JURISDICTION');

        var tc = TIER_CONFIG[tier] || TIER_CONFIG['READ THE FLAGGED CLAUSES'];

        // Skeleton placeholders for sections not yet arrived during streaming
        var isStreaming = !opusSections.overall.done && !deepTextComplete && !isDoneRendering;
        function skeleton(label) {
            return '<div class="verdict-skeleton"><span class="verdict-skeleton-label">' + label + '</span><span class="pulsing-dots"><span></span><span></span><span></span></span></div>';
        }

        // Pre-build jurisdiction HTML — render early if it contains warnings
        var jurisdictionHtml = '';
        var jurisdictionHasWarnings = false;
        if (jurisdiction && !/unknown/i.test(jurisdiction.split('\n')[0]) && !/could not be determined/i.test(jurisdiction)) {
            var jLines = jurisdiction.split('\n');
            var jLoc = jLines[0];
            var jDetails = jLines.slice(1).join('\n').trim();
            var jFlag = jurisdictionFlag(jLoc);
            jurisdictionHasWarnings = /ILLEGAL|UNENFORCEABLE|MISSING|VIOLAT/i.test(jDetails);
            jurisdictionHtml += '<div class="verdict-jurisdiction' + (jurisdictionHasWarnings ? ' jurisdiction-warnings' : '') + '">';
            jurisdictionHtml += '<div class="verdict-jurisdiction-label">' + (jFlag ? '<span class="jurisdiction-flag">' + jFlag + '</span> ' : '\u2696\uFE0F ') + 'Jurisdiction: ' + escapeHtml(jLoc) + '</div>';
            if (jDetails) {
                jurisdictionHtml += '<div class="verdict-jurisdiction-details">' + safeMd2Html(jDetails) + '</div>';
            }
            jurisdictionHtml += '</div>';
        }

        var html = '<div class="verdict-onescreen">';

        // ── Risk summary (concerns / watch items / fair) ──
        var riskCards = document.querySelectorAll('.flip-card[data-risk-level]');
        var riskCts = { red: 0, yellow: 0, green: 0 };
        for (var ri = 0; ri < riskCards.length; ri++) {
            var rl = riskCards[ri].getAttribute('data-risk-level') || 'green';
            if (riskCts[rl] !== undefined) riskCts[rl]++;
        }
        if (riskCts.red + riskCts.yellow + riskCts.green > 0) {
            html += '<div class="verdict-risk-summary">';
            if (riskCts.red > 0) html += '<span class="risk-count"><span class="risk-dot risk-dot-red"></span>' + riskCts.red + ' concern' + (riskCts.red !== 1 ? 's' : '') + '</span>';
            if (riskCts.yellow > 0) html += '<span class="risk-count"><span class="risk-dot risk-dot-yellow"></span>' + riskCts.yellow + ' watch item' + (riskCts.yellow !== 1 ? 's' : '') + '</span>';
            if (riskCts.green > 0) html += '<span class="risk-count"><span class="risk-dot risk-dot-green"></span>' + riskCts.green + ' fair</span>';
            html += '</div>';
        }

        // ── Tricks detected (moved to top of verdict) ──
        var trickNames = Object.keys(_detectedTricks);
        if (trickNames.length > 0) {
            var sorted = trickNames.sort(function(a, b) { return _detectedTricks[b] - _detectedTricks[a]; }).slice(0, 12);
            html += '<div class="verdict-tricks-summary">';
            html += '<div class="verdict-tricks-label">' + trickNames.length + ' trick' + (trickNames.length !== 1 ? 's' : '') + ' detected</div>';
            html += '<div class="verdict-tricks-list">';
            sorted.forEach(function(name) {
                html += '<span class="verdict-trick-item">';
                if (TRICK_ICONS[name]) html += '<span class="verdict-trick-icon">' + TRICK_ICONS[name] + '</span>';
                html += '<span class="verdict-trick-name">' + escapeHtml(name) + '</span>';
                if (_detectedTricks[name] > 1) html += '<span class="verdict-trick-count">\u00d7' + _detectedTricks[name] + '</span>';
                var tDesc = TRICK_DESCRIPTIONS[name] || '';
                if (tDesc) html += '<span class="verdict-trick-desc">' + escapeHtml(tDesc) + '</span>';
                html += '</span>';
            });
            html += '</div></div>';
        }

        // ── Tier badge ──
        html += '<div class="verdict-tier-badge tier-' + tc.color + '">';
        html += '<span class="verdict-tier-icon">' + tc.icon + '</span> ';
        html += escapeHtml(tc.label);
        html += '</div>';

        // ── Enforcement framing ──
        html += '<div class="verdict-enforcement-frame">Assumes every clause is enforced as written \u2014 the worst case, not a prediction.</div>';

        // ── Jurisdiction elevated: render right after tier if it has warnings ──
        if (jurisdictionHasWarnings) {
            html += jurisdictionHtml;
        }

        // ── What is this ──
        if (whatIsThis) {
            html += '<div class="verdict-what-is-this">' + safeMd2Html(whatIsThis) + '</div>';
        } else if (isStreaming) {
            html += skeleton('Summary');
        }

        // ── Should you worry ──
        if (shouldYouWorry) {
            html += '<div class="verdict-should-worry">' + safeMd2Html(shouldYouWorry) + '</div>';
        } else if (isStreaming) {
            html += skeleton('Assessment');
        }

        // ── The main thing ──
        if (theMainThing) {
            html += '<div class="verdict-main-thing">';
            html += '<div class="verdict-main-thing-label">The main thing</div>';
            html += '<div class="verdict-main-thing-text">' + safeMd2Html(theMainThing) + '</div>';
            html += '</div>';
        } else if (isStreaming) {
            html += skeleton('The main thing');
        }

        // ── One action ──
        if (oneAction) {
            html += '<div class="verdict-one-action">';
            html += '<div class="verdict-one-action-label">What to do</div>';
            html += '<div class="verdict-one-action-text">' + safeMd2Html(oneAction) + '</div>';
            html += '</div>';
        } else if (isStreaming) {
            html += skeleton('What to do');
        }

        // ── Power ratio ──
        if (powerRatio) {
            html += '<div class="verdict-power-ratio">' + escapeHtml(powerRatio) + '</div>';
        } else if (isStreaming) {
            html += skeleton('Power ratio');
        }

        // ── Jurisdiction normal position (when no warnings) ──
        if (!jurisdictionHasWarnings && jurisdictionHtml) {
            html += jurisdictionHtml;
        } else if (isStreaming && !jurisdictionHasWarnings && !jurisdictionHtml) {
            html += skeleton('Jurisdiction');
        }

        html += '</div>'; // .verdict-onescreen

        // ── "Still building" bar — right after verdict card so user sees it immediately ──
        if (isStreaming) {
            html += '<div class="verdict-building-footer">';
            html += '<span class="pulsing-dots"><span></span><span></span><span></span></span>';
            html += '<span class="verdict-building-footer-text">Verdict still building — more sections arriving</span>';
            html += '</div>';
        }

        // ── Section index: preview what's below ──
        var sectionPills = [];
        if (risks) sectionPills.push({ label: 'Risks', id: 'verdictLayerRisks' });
        else if (isStreaming) sectionPills.push({ label: 'Risks', id: '', pending: true });
        if (flaggedClaims && !/no clauses were flagged/i.test(flaggedClaims)) {
            var fc = flaggedClaims.split('\n').filter(function(l) { return /^[-*\d]/.test(l.trim()); }).length;
            sectionPills.push({ label: fc + ' flagged', id: 'verdictLayerClaims' });
        }
        if (checklist) {
            var cc = (checklist.match(/^[-*] /gm) || []).length;
            sectionPills.push({ label: 'Checklist (' + cc + ')', id: 'verdictLayerChecklist' });
        } else if (isStreaming) {
            sectionPills.push({ label: 'Checklist', id: '', pending: true });
        }
        if (colophon) sectionPills.push({ label: 'About', id: 'verdictLayerColophon' });
        if (deepTextComplete || isDoneRendering) sectionPills.push({ label: 'Ask a question', id: 'askFlipsideSection' });
        sectionPills.push({ label: 'Go deeper', id: 'verdictDepthButtons' });

        if (sectionPills.length > 0) {
            html += '<div class="verdict-sections-index">';
            html += '<span class="verdict-sections-label">Below</span>';
            sectionPills.forEach(function(p) {
                if (p.pending) {
                    html += '<span class="verdict-section-pill pending">' + p.label + '\u2026</span>';
                } else {
                    html += '<span class="verdict-section-pill" data-scroll-to="' + p.id + '">' + p.label + '</span>';
                }
            });
            html += '</div>';
        }

        // ── Collapsible: Additional risks ──
        if (risks) {
            html += '<div class="verdict-layer verdict-layer-risks collapsed" id="verdictLayerRisks">';
            html += '<div class="verdict-layer-header" onclick="this.parentElement.classList.toggle(\'collapsed\')">';
            html += '<span class="verdict-layer-title">Additional risks</span>';
            html += '<span class="verdict-layer-chevron">\u25BC</span></div>';
            html += '<div class="verdict-layer-body">';
            var riskLines = risks.split('\n').filter(function(l) { return l.trim(); });
            riskLines.forEach(function(line) {
                var cleaned = line.replace(/^[-•*]\s*/, '').trim();
                if (cleaned) {
                    html += '<div class="verdict-risk-item">' + safeMd2Html(cleaned) + '</div>';
                }
            });
            html += '</div></div>';
        }

        // ── Collapsible: Flagged claims ──
        if (flaggedClaims && !/no clauses were flagged/i.test(flaggedClaims)) {
            var claimLines = flaggedClaims.split('\n').filter(function(l) { return l.trim(); });
            var claimCount = claimLines.filter(function(l) { return /^[-*\d]/.test(l.trim()); }).length;
            html += '<div class="verdict-layer verdict-layer-claims collapsed" id="verdictLayerClaims">';
            html += '<div class="verdict-layer-header" onclick="this.parentElement.classList.toggle(\'collapsed\')">';
            html += '<span class="verdict-layer-title">All flagged clauses (' + claimCount + ')</span>';
            html += '<span class="verdict-layer-chevron">\u25BC</span></div>';
            html += '<div class="verdict-layer-body">';
            claimLines.forEach(function(line) {
                var cleaned = line.replace(/^[-•*\d]+[.)]\s*/, '').trim();
                if (cleaned) {
                    html += '<div class="verdict-claim-item">' + safeMd2Html(cleaned) + '</div>';
                }
            });
            html += '</div></div>';
        }

        // ── Collapsible: Checklist ──
        if (checklist) {
            html += '<div class="verdict-layer verdict-layer-checklist collapsed" id="verdictLayerChecklist">';
            html += '<div class="verdict-layer-header" onclick="this.parentElement.classList.toggle(\'collapsed\')">';
            var itemCount = (checklist.match(/^[-*] /gm) || []).length;
            html += '<span class="verdict-layer-title">Your checklist (' + itemCount + ' items)</span>';
            html += '<span class="verdict-layer-chevron">\u25BC</span></div>';
            html += '<div class="verdict-layer-body">';
            checklist.split('\n').forEach(function(line) {
                var trimmed = line.trim();
                if (!trimmed) return;
                if (!trimmed.startsWith('-') && !trimmed.startsWith('*') && trimmed.endsWith(':')) {
                    html += '<div class="verdict-checklist-section-title">' + escapeHtml(trimmed) + '</div>';
                } else if (trimmed.startsWith('- ') || trimmed.startsWith('* ')) {
                    html += '<div class="verdict-checklist-item">' + escapeHtml(trimmed.substring(2)) + '</div>';
                }
            });
            html += '</div></div>';
        }

        // ── Collapsible: About this analysis ──
        if (colophon) {
            html += '<div class="verdict-layer verdict-layer-colophon collapsed" id="verdictLayerColophon">';
            html += '<div class="verdict-layer-header" onclick="this.parentElement.classList.toggle(\'collapsed\')">';
            html += '<span class="verdict-layer-title">About this analysis</span>';
            html += '<span class="verdict-layer-chevron">\u25BC</span></div>';
            html += '<div class="verdict-layer-body">';
            html += '<div class="verdict-colophon-body">' + safeMd2Html(colophon) + '</div>';
            html += '</div></div>';
        }

        // ── Ask FlipSide: follow-up question (hidden until verdict ready) ──
        html += '<div class="ask-flipside-section' + (deepTextComplete || isDoneRendering ? '' : ' hidden') + '" id="askFlipsideSection">';
        html += '<div class="ask-flipside-label">Ask a follow-up question</div>';
        html += '<div class="ask-flipside-input-row">';
        html += '<input type="text" class="ask-flipside-input" id="askFlipsideInput" placeholder="What happens if I\u2019m 3 months late on rent?" />';
        html += '<button class="ask-flipside-btn" id="askFlipsideBtn">\u2192</button>';
        html += '</div>';
        html += '<div class="ask-flipside-result" id="askFlipsideResult"></div>';
        html += '</div>';

        // ── 5 Expert Reports (parallel Opus 4.6 — auto-streaming) ──
        html += '<div class="verdict-depth-buttons" id="verdictDepthButtons">';
        html += '<div class="verdict-depth-label" id="deepDiveProgressLabel">Expert reports building<span class="pulsing-dots"><span></span><span></span><span></span></span></div>';
        var _depthSvg = {
            archaeology: '<svg width="18" height="18" viewBox="0 0 18 18" fill="none" stroke="currentColor" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="2" width="12" height="14" rx="1.5"/><line x1="6" y1="6" x2="12" y2="6"/><line x1="6" y1="9" x2="10" y2="9"/><line x1="6" y1="12" x2="8" y2="12"/></svg>',
            scenario: '<svg width="18" height="18" viewBox="0 0 18 18" fill="none" stroke="currentColor" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round"><polyline points="3,14 6,8 9,11 12,5 15,3"/><circle cx="15" cy="3" r="1.2"/><line x1="3" y1="15" x2="15" y2="15"/></svg>',
            walkaway: '<svg width="18" height="18" viewBox="0 0 18 18" fill="none" stroke="currentColor" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round"><line x1="9" y1="2" x2="9" y2="13"/><line x1="6" y1="5" x2="9" y2="2"/><line x1="12" y1="5" x2="9" y2="2"/><line x1="4" y1="16" x2="14" y2="16"/></svg>',
            combinations: '<svg width="18" height="18" viewBox="0 0 18 18" fill="none" stroke="currentColor" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round"><circle cx="5" cy="5" r="2.5"/><circle cx="13" cy="5" r="2.5"/><circle cx="9" cy="13" r="2.5"/><line x1="7" y1="6" x2="11" y2="6"/><line x1="6.5" y1="7" x2="8" y2="11"/><line x1="11.5" y1="7" x2="10" y2="11"/></svg>',
            playbook: '<svg width="18" height="18" viewBox="0 0 18 18" fill="none" stroke="currentColor" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round"><path d="M3,3 L9,6 L15,3 L15,13 L9,16 L3,13 Z"/><line x1="9" y1="6" x2="9" y2="16"/></svg>'
        };
        var depthOptions = [
            { key: 'archaeology', icon: _depthSvg.archaeology, title: 'Document Archaeology', desc: 'Boilerplate vs. custom-drafted clauses' },
            { key: 'scenario', icon: _depthSvg.scenario, title: 'What Could Happen', desc: 'Worst-case scenario simulation' },
            { key: 'walkaway', icon: _depthSvg.walkaway, title: 'Walk-Away Number', desc: 'Your maximum financial exposure' },
            { key: 'combinations', icon: _depthSvg.combinations, title: 'Hidden Combinations', desc: 'Cross-clause compound effects' },
            { key: 'playbook', icon: _depthSvg.playbook, title: 'Negotiation Playbook', desc: 'What to push on, what to skip' }
        ];
        depthOptions.forEach(function(opt) {
            var dd = deepDiveResults[opt.key];
            var isReady = dd && dd.done;
            var hasContent = dd && dd.text.length > 0;
            html += '<button class="verdict-depth-btn' + (isReady ? ' ready' : '') + (hasContent && !isReady ? ' building' : '') + '" data-depth="' + opt.key + '">';
            html += '<span class="verdict-depth-btn-icon">' + opt.icon + '</span>';
            html += '<span class="verdict-depth-btn-text">';
            html += '<span class="verdict-depth-btn-title">' + opt.title + '</span>';
            html += '<span class="verdict-depth-btn-desc">' + opt.desc + '</span>';
            html += '</span>';
            html += '<span class="verdict-depth-btn-status" id="depthStatus_' + opt.key + '">';
            html += isReady ? '\u2713' : (hasContent ? '<span class="pulsing-dots"><span></span><span></span><span></span></span>' : '\u2022');
            html += '</span>';
            html += '</button>';
            html += '<div class="depth-result-panel" id="depthPanel_' + opt.key + '"></div>';
        });
        html += '</div>';

        return html;
    }

    // ── Deep Dive: update button state ──
    function updateDepthButtonState(source) {
        var btn = document.querySelector('.verdict-depth-btn[data-depth="' + source + '"]');
        if (!btn) return;
        var statusEl = $('depthStatus_' + source);
        var dd = deepDiveResults[source];
        if (dd && dd.done) {
            btn.classList.add('ready');
            if (statusEl) statusEl.innerHTML = '\u2713';
        }
    }

    // ── Deep Dive: render scenario with timeline layout ──
    function hasScenarioTags(text) {
        return /\[SCENARIO_TITLE\]/.test(text) || /\[TIMELINE_STEP/.test(text);
    }
    function renderScenarioResult(text) {
        var html = '';
        // Title
        var titleM = text.match(/\[SCENARIO_TITLE\]([\s\S]*?)\[\/SCENARIO_TITLE\]/);
        var title = titleM ? titleM[1].trim() : 'What Could Happen';
        html += '<div class="scenario-title">' + escapeHtml(title) + '</div>';

        // Setup
        var setupM = text.match(/\[SCENARIO_SETUP\]([\s\S]*?)\[\/SCENARIO_SETUP\]/);
        if (setupM) html += '<div class="scenario-setup">' + safeMd2Html(setupM[1].trim()) + '</div>';

        // Timeline steps
        var stepRe = /\[TIMELINE_STEP\s+title="([^"]*?)"\]([\s\S]*?)\[\/TIMELINE_STEP\]/g;
        var stepMatch;
        var hasSteps = false;
        html += '<div class="scenario-timeline">';
        while ((stepMatch = stepRe.exec(text)) !== null) {
            hasSteps = true;
            html += '<div class="scenario-step">';
            html += '<div class="scenario-step-marker"></div>';
            html += '<div class="scenario-step-content">';
            html += '<div class="scenario-step-title">' + escapeHtml(stepMatch[1]) + '</div>';
            html += '<div class="scenario-step-body">' + safeMd2Html(stepMatch[2].trim()) + '</div>';
            html += '</div></div>';
        }
        html += '</div>';

        // Total
        var totalM = text.match(/\[SCENARIO_TOTAL\]([\s\S]*?)\[\/SCENARIO_TOTAL\]/);
        if (totalM) html += '<div class="scenario-total">' + safeMd2Html(totalM[1].trim()) + '</div>';

        // Actions
        var actionsM = text.match(/\[SCENARIO_ACTIONS\]([\s\S]*?)\[\/SCENARIO_ACTIONS\]/);
        if (actionsM) {
            html += '<div class="scenario-actions">';
            html += '<div class="scenario-actions-title">What You Could Do Before Signing</div>';
            html += safeMd2Html(actionsM[1].trim());
            html += '</div>';
        }

        // Ready-to-send message
        var messageM = text.match(/\[SCENARIO_MESSAGE\]([\s\S]*?)\[\/SCENARIO_MESSAGE\]/);
        if (messageM) {
            var msgText = messageM[1].trim();
            html += '<div class="scenario-message">';
            html += '<div class="scenario-message-title">Ready-to-Send Message</div>';
            html += '<div class="scenario-message-body">' + safeMd2Html(msgText) + '</div>';
            html += '<div class="scenario-message-actions">';
            html += '<button class="scenario-copy-btn" onclick="navigator.clipboard.writeText(this.closest(\'.scenario-message\').querySelector(\'.scenario-message-body\').innerText);this.textContent=\'Copied\';var b=this;setTimeout(function(){b.textContent=\'Copy text\'},1500)">Copy text</button>';
            html += '<button class="scenario-email-btn" onclick="var t=this.closest(\'.scenario-message\').querySelector(\'.scenario-message-body\').innerText;window.location.href=\'mailto:?subject=\'+encodeURIComponent(\'Contract Review — Requested Changes\')+\'&body=\'+encodeURIComponent(t)">Open in email</button>';
            html += '</div></div>';
        }

        // Fallback
        if (!hasSteps && !totalM) {
            return '<div class="depth-result-content">' + safeMd2Html(text) + '</div>';
        }
        return '<div class="depth-result-content scenario-layout">' + html + '</div>';
    }

    // ── Deep Dive: render walk-away number with hero treatment ──
    function renderWalkawayResult(text) {
        var number = '';
        var context = '';
        var m = text.match(/\[WALKAWAY_NUMBER\]([\s\S]*?)\[\/WALKAWAY_NUMBER\]/);
        if (m) number = m[1].trim();
        m = text.match(/\[WALKAWAY_CONTEXT\]([\s\S]*?)\[\/WALKAWAY_CONTEXT\]/);
        if (m) context = m[1].trim();
        var breakdown = '';
        m = text.match(/\[WALKAWAY_BREAKDOWN\]([\s\S]*?)\[\/WALKAWAY_BREAKDOWN\]/);
        if (m) breakdown = m[1].trim();
        var comparison = '';
        m = text.match(/\[WALKAWAY_COMPARISON\]([\s\S]*?)\[\/WALKAWAY_COMPARISON\]/);
        if (m) comparison = m[1].trim();
        var assumptions = '';
        m = text.match(/\[WALKAWAY_ASSUMPTIONS\]([\s\S]*?)\[\/WALKAWAY_ASSUMPTIONS\]/);
        if (m) assumptions = m[1].trim();

        var html = '<div class="walkaway-hero">';
        html += '<div class="walkaway-number">' + escapeHtml(number || 'Calculating...') + '</div>';
        if (context) html += '<div class="walkaway-context">' + escapeHtml(context) + '</div>';
        html += '</div>';
        if (breakdown) html += '<div class="depth-result-content">' + safeMd2Html(breakdown) + '</div>';
        if (comparison) html += '<div class="depth-result-content" style="margin-top:1rem;padding-top:0.75rem;border-top:1px solid var(--border-light)">' + safeMd2Html(comparison) + '</div>';
        if (assumptions) html += '<div class="depth-result-content" style="margin-top:0.75rem;font-size:0.75rem;color:var(--text-muted)">' + safeMd2Html(assumptions) + '</div>';

        // Fallback: if tags not found, render as plain markdown
        if (!number && !breakdown) {
            html = '<div class="depth-result-content">' + safeMd2Html(text) + '</div>';
        }
        return html;
    }

    // ── Deep Dive: detect and render [FINDING] tagged content ──
    function hasFindingTags(text) {
        return /\[FINDING[\s\]]/i.test(text) || /\[SUMMARY_CONTRIBUTION\]/i.test(text);
    }

    function renderFindingsResult(text) {
        var html = '';

        // Summary contribution
        var summary = parseTag(text, 'SUMMARY_CONTRIBUTION');
        if (summary) {
            html += '<div class="finding-summary">' + safeMd2Html(summary) + '</div>';
        }

        // Parse all [FINDING]...[/FINDING] blocks
        var findingRegex = /\[FINDING[^\]]*\]([\s\S]*?)\[\/FINDING\]/g;
        var match;
        var idx = 0;
        while ((match = findingRegex.exec(text)) !== null) {
            idx++;
            var block = match[1];
            var title = parseTag(block, 'FINDING_TITLE');
            var src = parseTag(block, 'FINDING_SOURCE');
            var explanation = parseTag(block, 'FINDING_EXPLANATION');
            var severity = parseTag(block, 'FINDING_SEVERITY').toLowerCase().trim();
            var sevContext = parseTag(block, 'FINDING_SEVERITY_CONTEXT');
            var action = parseTag(block, 'FINDING_ACTION');

            html += '<div class="finding-card">';
            html += '<div class="finding-header">';
            html += '<span class="finding-number">' + idx + '</span>';
            if (title) html += '<h4 class="finding-title">' + escapeHtml(title) + '</h4>';
            if (severity) html += '<span class="finding-severity finding-severity-' + escapeHtml(severity) + '">' + escapeHtml(severity) + '</span>';
            html += '</div>';
            if (src) html += '<blockquote class="finding-source">' + escapeHtml(src) + '</blockquote>';
            if (explanation) html += '<div class="finding-explanation">' + safeMd2Html(explanation) + '</div>';
            if (sevContext) html += '<div class="finding-severity-context">' + escapeHtml(sevContext) + '</div>';
            if (action) html += '<div class="finding-action"><strong>What to do:</strong> ' + escapeHtml(action) + '</div>';
            html += '</div>';
        }

        // Deep content (narrative section)
        var deep = parseTag(text, 'DEEP_CONTENT');
        if (deep) {
            html += '<div class="finding-deep-content">' + safeMd2Html(deep) + '</div>';
        }

        // Fallback: if no tags found, render as markdown
        if (!html) {
            return '<div class="depth-result-content">' + safeMd2Html(text) + '</div>';
        }
        return '<div class="depth-result-content">' + html + '</div>';
    }

    // ── Deep Dive: render result content into panel ──
    function renderDepthResult(source) {
        var panel = $('depthPanel_' + source);
        if (!panel || !panel.classList.contains('visible')) return;
        var dd = deepDiveResults[source];
        if (!dd || !dd.done) return;
        var text = dd.text;
        if (!text.trim()) {
            panel.innerHTML = '<div class="depth-result-content" style="color:var(--text-muted)">No analysis available for this document.</div>';
            return;
        }
        if (source === 'walkaway') {
            panel.innerHTML = renderWalkawayResult(text);
        } else if (source === 'scenario' && hasScenarioTags(text)) {
            panel.innerHTML = renderScenarioResult(text);
        } else if (hasFindingTags(text)) {
            panel.innerHTML = renderFindingsResult(text);
        } else {
            panel.innerHTML = '<div class="depth-result-content">' + safeMd2Html(text) + '</div>';
        }
    }

    // ── Deep Dive: update streaming panel content ──
    function updateDeepDivePanel(source) {
        var panel = $('depthPanel_' + source);
        if (!panel || !panel.classList.contains('visible')) return;
        var dd = deepDiveResults[source];
        if (!dd || !dd.text) return;
        var buildingFooter = dd.done ? '' : '<div class="depth-result-loading" style="margin-top:0.75rem"><span class="pulsing-dots"><span></span><span></span><span></span></span> Still building\u2026</div>';
        if (source === 'walkaway') {
            panel.innerHTML = renderWalkawayResult(dd.text) + buildingFooter;
        } else if (source === 'scenario' && hasScenarioTags(dd.text)) {
            panel.innerHTML = renderScenarioResult(dd.text) + buildingFooter;
        } else if (hasFindingTags(dd.text)) {
            panel.innerHTML = renderFindingsResult(dd.text) + buildingFooter;
        } else {
            panel.innerHTML = '<div class="depth-result-content">' + safeMd2Html(dd.text) + '</div>' + buildingFooter;
        }
    }

    // ── Deep Dive: update progress label and status text ──
    function updateDeepDiveProgress() {
        var doneCount = DEEP_DIVE_SOURCES.filter(function(s) { return deepDiveResults[s].done; }).length;
        var total = DEEP_DIVE_SOURCES.length;
        var label = $('deepDiveProgressLabel');
        if (label) {
            if (doneCount >= total) {
                label.innerHTML = 'All ' + total + ' expert reports ready \u2713';
                // Now update main status to fully complete
                statusText.textContent = 'Analysis complete';
                stopStatusRotation();
                showBriefingSentence('All expert reports are ready');
            } else {
                label.innerHTML = doneCount + ' of ' + total + ' expert reports ready<span class="pulsing-dots"><span></span><span></span><span></span></span>';
            }
        }
        // Update button states for any newly done
        DEEP_DIVE_SOURCES.forEach(function(s) {
            var btn = document.querySelector('.verdict-depth-btn[data-depth="' + s + '"]');
            var statusEl = $('depthStatus_' + s);
            var dd = deepDiveResults[s];
            if (!btn || !statusEl) return;
            if (dd.done) {
                btn.classList.remove('building');
                btn.classList.add('ready');
                statusEl.innerHTML = '\u2713';
            } else if (dd.text.length > 0) {
                btn.classList.add('building');
                statusEl.innerHTML = '<span class="pulsing-dots"><span></span><span></span><span></span></span>';
            }
        });
    }

    document.addEventListener('click', function(e) {
        var btn = e.target.closest('.verdict-depth-btn');
        if (!btn) return;
        var key = btn.getAttribute('data-depth');
        if (!key) return;
        var panel = $('depthPanel_' + key);
        if (!panel) return;
        var dd = deepDiveResults[key];

        // Toggle: if already visible, collapse
        if (panel.classList.contains('visible')) {
            panel.classList.remove('visible');
            btn.classList.remove('active');
            return;
        }

        // Collapse other panels
        DEEP_DIVE_SOURCES.forEach(function(s) {
            var otherPanel = $('depthPanel_' + s);
            var otherBtn = document.querySelector('.verdict-depth-btn[data-depth="' + s + '"]');
            if (otherPanel) otherPanel.classList.remove('visible');
            if (otherBtn) otherBtn.classList.remove('active');
        });

        // Expand this panel
        panel.classList.add('visible');
        btn.classList.add('active');

        // Render whatever content we have (streaming or complete)
        if (dd.done) {
            renderDepthResult(key);
        } else if (dd.text.length > 0) {
            // Streaming — show partial content
            updateDeepDivePanel(key);
        } else {
            // Not started yet or no content — show waiting state
            panel.innerHTML = '<div class="depth-result-loading"><span class="pulsing-dots"><span></span><span></span><span></span></span> Opus 4.6 is analyzing...</div>';
        }

        // Scroll panel into view
        setTimeout(function() {
            panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }, 100);
    });

    // ── Ask FlipSide: follow-up question with tool use ──
    var TOOL_LABELS = {
        search_document: { icon: '\uD83D\uDD0D', label: 'Searching document' },
        get_clause_analysis: { icon: '\uD83D\uDCC4', label: 'Reading clause analysis' },
        get_verdict_summary: { icon: '\uD83D\uDCCB', label: 'Checking verdict' }
    };

    function askFlipside(question) {
        var resultEl = $('askFlipsideResult');
        var btnEl = $('askFlipsideBtn');
        var inputEl = $('askFlipsideInput');
        if (!resultEl || !btnEl || !inputEl || !question.trim()) return;

        btnEl.disabled = true;
        inputEl.disabled = true;
        resultEl.innerHTML = '<div class="ask-tool-call"><span class="ask-tool-call-icon">\uD83E\uDDE0</span> Thinking...</div>';

        var answerText = '';

        // POST via fetch with streaming reader
        fetch(BASE_URL + '/ask/' + currentDocId, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ question: question })
        }).then(function(response) {
            var reader = response.body.getReader();
            var decoder = new TextDecoder();
            var buffer = '';

            function processChunk() {
                return reader.read().then(function(result) {
                    if (result.done) {
                        btnEl.disabled = false;
                        inputEl.disabled = false;
                        return;
                    }
                    buffer += decoder.decode(result.value, { stream: true });
                    var lines = buffer.split('\n');
                    buffer = lines.pop(); // Keep incomplete line

                    lines.forEach(function(line) {
                        if (!line.startsWith('data: ')) return;
                        var msg;
                        try { msg = JSON.parse(line.slice(6)); } catch(e) { return; }

                        if (msg.type === 'tool_call') {
                            var tc; try { tc = JSON.parse(msg.content); } catch(e) { return; }
                            var info = TOOL_LABELS[tc.tool] || { icon: '\uD83D\uDD27', label: tc.tool };
                            var detail = '';
                            if (tc.input && tc.input.query) detail = ' for "' + tc.input.query + '"';
                            if (tc.input && tc.input.clause_number) detail = ' #' + tc.input.clause_number;
                            resultEl.innerHTML += '<div class="ask-tool-call"><span class="ask-tool-call-icon">' + info.icon + '</span> ' + escapeHtml(info.label + detail) + '</div>';
                        } else if (msg.type === 'tool_result') {
                            // Tool result received — model will continue reasoning
                        } else if (msg.type === 'text') {
                            answerText += msg.content;
                            // Remove the "Thinking..." indicator on first text
                            var thinkingEls = resultEl.querySelectorAll('.ask-tool-call');
                            var answerEl = resultEl.querySelector('.ask-answer');
                            if (!answerEl) {
                                answerEl = document.createElement('div');
                                answerEl.className = 'ask-answer';
                                resultEl.appendChild(answerEl);
                            }
                            answerEl.innerHTML = safeMd2Html(answerText);
                        } else if (msg.type === 'thinking') {
                            // Thinking tokens — keep indicator visible
                        } else if (msg.type === 'done') {
                            btnEl.disabled = false;
                            inputEl.disabled = false;
                        } else if (msg.type === 'error') {
                            resultEl.innerHTML += '<div style="color:var(--accent);margin-top:0.5rem">' + escapeHtml(msg.content) + '</div>';
                            btnEl.disabled = false;
                            inputEl.disabled = false;
                        }
                    });

                    return processChunk();
                });
            }

            return processChunk();
        }).catch(function(err) {
            resultEl.innerHTML = '<div style="color:var(--accent)">Connection error. Please try again.</div>';
            btnEl.disabled = false;
            inputEl.disabled = false;
        });
    }

    // Wire up Ask FlipSide button + Enter key
    document.addEventListener('click', function(e) {
        if (e.target.id === 'askFlipsideBtn' || e.target.closest('#askFlipsideBtn')) {
            var input = $('askFlipsideInput');
            if (input && input.value.trim()) askFlipside(input.value.trim());
        }
    });
    document.addEventListener('keydown', function(e) {
        if (e.target.id === 'askFlipsideInput' && e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            var val = e.target.value.trim();
            if (val) askFlipside(val);
        }
    });

    function revealDeepAnalysis(userInitiated) {
        var inlineVerdict = $('inlineVerdict');
        var inlineContent = $('inlineVerdictContent');
        var inlineProgress = $('inlineVerdictProgress');
        var isComplete = deepTextComplete || isDoneRendering;

        if (_verdictPollTimer) { clearTimeout(_verdictPollTimer); _verdictPollTimer = null; }

        inlineVerdict.classList.add('visible');
        hideVerdictCol();

        // Update divider label based on completion state
        var dividerText = $('verdictDividerText');
        if (dividerText) {
            dividerText.textContent = isComplete ? 'Full Expert Verdict' : 'Expert Verdict (building\u2026)';
        }

        var text = opusSections.overall.text || '';
        var section = $('deepAnalysisSection');

        if (hasTaggedContent(text)) {
            // Nuclear cleanup: hide and clear ALL legacy deep analysis elements
            section.classList.add('hidden');
            summaryContainer.innerHTML = '';
            deepAnalysisEl.innerHTML = '';
            counterDraftSection.classList.add('hidden');
            followupSection.classList.add('hidden');
            // Remove stale deep-analysis-header if it exists
            var staleHeader = deepAnalysisEl.previousElementSibling;
            if (staleHeader && staleHeader.classList.contains('deep-analysis-header')) staleHeader.remove();
            // One-screen verdict from single Opus thread (preserve expanded sections)
            _saveVerdictLayerState();
            inlineContent.innerHTML = renderOneScreenVerdict(text);
            _restoreVerdictLayerState();
        } else if (text.trim()) {
            // Legacy fallback: raw markdown — show deep analysis section
            section.classList.remove('hidden');
            var safeMd = text
                .replace(/^# .+$/gm, '')
                .replace(/\[READER\]\s*:/g, 'FLIPSIDE_READER:')
                .replace(/\[DRAFTER\]\s*:/g, 'FLIPSIDE_DRAFTER:')
                .replace(/^READER\s*:/gm, 'FLIPSIDE_READER:')
                .replace(/^DRAFTER\s*:/gm, 'FLIPSIDE_DRAFTER:');
            var rendered = safeMd2Html(safeMd);
            rendered = styleRiskBadges(rendered);
            rendered = styleReaderBlocks(rendered);
            rendered = styleDrafterBlocks(rendered);
            rendered = safeHtml(rendered);
            inlineContent.innerHTML = '<div class="inline-verdict-section"><div class="inline-verdict-section-body">' + rendered + '</div></div>';
        } else {
            inlineContent.innerHTML = '<div style="text-align:center;padding:2rem;color:var(--text-secondary)"><span class="pulsing-dots"><span></span><span></span><span></span></span> Building your verdict\u2026</div>';
        }

        if (isComplete) {
            inlineProgress.classList.add('hidden');
            var isTagged = hasTaggedContent(text);
            if (!isTagged) {
                // Legacy format: render raw deep analysis + summary + playbook
                renderDeepAnalysisContent();
                buildSummaryCard();
                buildPlaybookCard();
                counterDraftSection.classList.remove('hidden');
            }
            if (userInitiated) {
                setTimeout(function() { inlineVerdict.scrollIntoView({ behavior: 'smooth', block: 'start' }); }, 50);
            }
            return;
        }

        inlineProgress.classList.remove('hidden');
        if (_coreVerdictReady) {
            $('inlineVerdictProgressText').textContent = 'Adding details\u2026';
        } else {
            $('inlineVerdictProgressText').textContent = 'Expert verdict building\u2026';
        }

        if (userInitiated) {
            setTimeout(function() { inlineVerdict.scrollIntoView({ behavior: 'smooth', block: 'start' }); }, 50);
        }

        _verdictPollTimer = setTimeout(function() { revealDeepAnalysis(false); }, 800);
    }

    // ── Show one card, hide rest, update nav ─────────────────
    // ── Insight column: "What you should read" + "What does this mean for you" ──
    // Highlight dollar amounts, percentages, and day counts in text
    function highlightNumbers(text) {
        return escapeHtml(text).replace(
            /(\$[\d,]+(?:\.\d{2})?|\d+%|\d+\s*(?:days?|months?|years?|hours?))/gi,
            '<span class="insight-num">$1</span>'
        );
    }

    // ── Clause whoosh: ghost pill flies from sidebar highlight → pill on card ──
    function whooshClauseToCard(cardIndex, cardEl) {
        // Target: the quote pill on the card front
        var pill = cardEl.querySelector('.front-quote-pill[data-card-pill="' + cardIndex + '"]');
        if (!pill) return;

        // Helper: ensure pill is always visible (safety net)
        function revealPill() { pill.classList.remove('whoosh-pending'); pill.classList.add('revealed'); }

        if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
            revealPill();
            return;
        }
        var previewEl = $('editorialLoadingText');
        if (!previewEl) { revealPill(); return; }
        var highlight = previewEl.querySelector('.doc-highlight[data-card-index="' + cardIndex + '"]');

        // If no sidebar highlight found, just reveal the pill directly
        if (!highlight) {
            revealPill();
            return;
        }

        // Flash the sidebar highlight
        highlight.classList.remove('whoosh-flash');
        void highlight.offsetWidth;
        highlight.classList.add('whoosh-flash');

        var risk = (cardEl.getAttribute('data-risk-level') || 'green');
        var sourceRect = highlight.getBoundingClientRect();
        var pillRect = pill.getBoundingClientRect();

        // Build ghost — matches pill styling
        var ghost = document.createElement('div');
        ghost.className = 'clause-whoosh-ghost clause-whoosh-ghost-' + risk;
        var num = cardIndex + 1;
        var quote = (cardEl.getAttribute('data-quote') || '').substring(0, 50);
        if (quote.length >= 49) quote += '\u2026';
        ghost.innerHTML = '<span class="ghost-num">' + num + '</span><span class="ghost-text">\u201c' + escapeHtml(quote) + '\u201d</span>';
        document.body.appendChild(ghost);

        // Position at sidebar highlight center
        var gw = ghost.offsetWidth;
        var gh = ghost.offsetHeight;
        var srcX = sourceRect.left + sourceRect.width / 2 - gw / 2;
        var srcY = sourceRect.top + sourceRect.height / 2 - gh / 2;
        ghost.style.left = srcX + 'px';
        ghost.style.top = srcY + 'px';

        // Fly to the pill
        var dx = pillRect.left + pillRect.width / 2 - gw / 2 - srcX;
        var dy = pillRect.top + pillRect.height / 2 - gh / 2 - srcY;
        var midX = dx * 0.5;
        var midY = Math.min(dy * 0.3, dy - 40);  // arc upward

        ghost.animate([
            { transform: 'translate(0, 0) scale(0.9)', opacity: 0.6 },
            { transform: 'translate(0, 0) scale(1.08)', opacity: 1, offset: 0.08 },
            { transform: 'translate(' + midX + 'px, ' + midY + 'px) scale(1.12)', opacity: 1, offset: 0.45 },
            { transform: 'translate(' + dx + 'px, ' + dy + 'px) scale(1)', opacity: 1, offset: 0.82 },
            { transform: 'translate(' + dx + 'px, ' + dy + 'px) scale(0.97)', opacity: 0 }
        ], { duration: 900, easing: 'ease-in-out', fill: 'forwards' })
        .onfinish = function() {
            ghost.remove();
            revealPill();
        };
        // Safety: if animation somehow doesn't finish, reveal after timeout
        setTimeout(revealPill, 1200);
    }

    function showCardAtIndex(index) {
        var cards = flipCardContainer.querySelectorAll('.flip-card');
        if (index < 0 || index >= cards.length) return;

        currentCardIndex = index;
        // Restore side columns when navigating (un-flips the card)
        var layout = flipCardContainer.closest('.analysis-layout');
        if (layout) layout.classList.remove('layout-flipped');
        // Flush deferred verdict strip state (user is between cards — safe to update)
        if (_pendingStripState) {
            _applyStripState(_pendingStripState);
        }
        var isFirstAppearance = false;
        for (var i = 0; i < cards.length; i++) {
            if (i === index) {
                cards[i].classList.remove('hidden');
                cards[i].classList.remove('flipped'); // un-flip on navigate
                if (!cards[i].classList.contains('woosh-done')) {
                    cards[i].classList.add('woosh-in', 'woosh-done');
                    isFirstAppearance = true;
                }
            } else {
                cards[i].classList.add('hidden');
            }
        }

        // Animate score bar on visible card
        var visibleCard = cards[index];
        var scoreBarFill = visibleCard.querySelector('.back-score-bar-fill');
        if (scoreBarFill && !scoreBarFill.style.width) {
            var targetWidth = scoreBarFill.getAttribute('data-width');
            setTimeout(function() { scoreBarFill.style.width = targetWidth + '%'; }, 100);
        }

        // Refresh highlights and scroll to current card
        rebuildPreviewHighlights();
        scrollPreviewToCard(index);

        // Whoosh ghost from sidebar to card on first appearance (desktop)
        if (isFirstAppearance && window.innerWidth > 900) {
            // Hide pill for whoosh entrance, then animate it in
            var whooshPill = visibleCard.querySelector('.front-quote-pill');
            if (whooshPill) whooshPill.classList.add('whoosh-pending');
            // Small delay so card is visible and positioned before we read rects
            setTimeout(function() { whooshClauseToCard(index, visibleCard); }, 150);
        }

        // Update bottom-next button label on current card
        var bottomNextBtn = visibleCard.querySelector('.card-bottom-next');
        if (bottomNextBtn) {
            var isLast = index >= cards.length - 1 && flipCardsBuilt;
            if (isLast) {
                bottomNextBtn.innerHTML = '<span>Full Verdict</span> <span class="card-bottom-next-arrow">&rarr;</span>';
            } else {
                bottomNextBtn.innerHTML = '<span>Next</span> <span class="card-bottom-next-arrow">&rarr;</span>';
            }
        }

        // Update chapter title — persistent editorial voice
        updateChapterTitle(index, cards.length, visibleCard);

        updateCardNavigation();

        // Sync sidebar height to match the visible card
        syncSidebarHeight(visibleCard);
    }

    var chapterPhrases = [
        'Everything looks standard\u2026 until you flip it.',
        'The fine print gets finer.',
        'Another clause, another assumption.',
        'This one reads quickly. That\u2019s the point.',
        'Standard language. Unusual implications.',
        'The drafter wrote this one carefully.',
        'Almost done. The pattern is forming.',
        'One more look before the verdict.',
        'What you skip is what they keep.',
        'Familiar words. Unfamiliar consequences.',
        'They buried the important part.',
        'Read this one slowly.',
    ];

    function updateChapterTitle(index, total, cardEl) {
        var ct = $('chapterTitle');
        var counter = $('chapterCounter');
        var text = $('chapterText');
        if (!ct || !counter || !text) return;

        counter.textContent = '';

        // Pick phrase: first card gets the hook, last card gets the closer
        var phrase;
        if (index === 0) {
            phrase = chapterPhrases[0];
        } else if (flipCardsBuilt && index === total - 1) {
            phrase = chapterPhrases[7]; // "One more look before the verdict."
        } else {
            // Rotate through middle phrases based on card index
            phrase = chapterPhrases[((index - 1) % (chapterPhrases.length - 2)) + 1];
        }
        text.textContent = phrase;
        ct.classList.add('visible');
    }

    // ── Update card navigation state ─────────────────────────
    function updateCardNavigation() {
        var cards = flipCardContainer.querySelectorAll('.flip-card');
        var total = cards.length;
        var nav = $('cardNavigation');
        var stickyNav = $('cardNavSticky');
        if (!nav) return;

        if (total === 0) {
            nav.classList.add('hidden');
            if (stickyNav) stickyNav.classList.remove('visible');
            return;
        }

        nav.classList.remove('hidden');
        if (stickyNav) stickyNav.classList.add('visible');

        // Update both bottom nav and sticky top nav
        var navElements = [nav];
        if (stickyNav) navElements.push(stickyNav);
        navElements.forEach(function(n) {
            var counter = n.querySelector('.card-nav-counter');
            var prevBtn = n.querySelector('.card-nav-prev');
            var nextBtn = n.querySelector('.card-nav-next');
            var nextLabel = nextBtn ? nextBtn.querySelector('.card-nav-next-label') : null;

            if (counter) {
                if (flipCardsBuilt) {
                    counter.innerHTML = 'Clause <strong>' + (currentCardIndex + 1) + '</strong> of <strong>' + total + '</strong>';
                } else {
                    counter.innerHTML = 'Clause <strong>' + (currentCardIndex + 1) + '</strong>';
                }
            }
            if (prevBtn) prevBtn.disabled = currentCardIndex === 0;

            if (currentCardIndex >= total - 1 && !quickDone) {
                if (nextLabel) nextLabel.innerHTML = 'Analyzing<span class="pulsing-dot"></span>';
                if (nextBtn) { nextBtn.disabled = true; nextBtn.removeAttribute('data-action'); }
            } else if (currentCardIndex >= total - 1 && flipCardsBuilt) {
                var opusDone = deepTextComplete || isDoneRendering;
                if (nextLabel) {
                    if (opusDone) {
                        nextLabel.textContent = 'Full Verdict \u2192';
                    } else {
                        nextLabel.innerHTML = 'Full Verdict <span class="pulsing-dot" style="margin-left:0.3rem"></span>';
                    }
                }
                if (nextBtn) { nextBtn.disabled = false; nextBtn.setAttribute('data-action', 'assessment'); }
            } else {
                if (nextLabel) nextLabel.textContent = 'Next \u2192';
                if (nextBtn) { nextBtn.disabled = false; nextBtn.removeAttribute('data-action'); }
            }
        });

        // Update pips in sticky nav
        updateCardPips(cards, total);
        // Mobile dot indicator
        updateCardDots(cards, total);
        // Update risk summary strip when all cards built
        if (flipCardsBuilt) updateRiskSummary(cards);
    }

    // ── Card pips in sticky nav ─────────────────────────────
    function updateCardPips(cards, total) {
        var pipsEl = $('cardNavPips');
        if (!pipsEl) return;
        // Rebuild pips if count changed
        if (pipsEl.children.length !== total) {
            pipsEl.innerHTML = '';
            for (var p = 0; p < total; p++) {
                var pip = document.createElement('span');
                pip.className = 'card-nav-pip';
                pip.setAttribute('data-index', p);
                pip.setAttribute('tabindex', '0');
                pip.setAttribute('aria-label', 'Go to clause ' + (p + 1));
                pip.addEventListener('click', (function(idx) {
                    return function() { showCardAtIndex(idx); };
                })(p));
                var risk = cards[p] ? cards[p].getAttribute('data-risk-level') : 'green';
                if (risk) pip.classList.add('pip-' + risk);
                pipsEl.appendChild(pip);
            }
        }
        // Update active state
        for (var p = 0; p < pipsEl.children.length; p++) {
            pipsEl.children[p].classList.toggle('active', p === currentCardIndex);
        }
    }

    // ── Risk summary strip (accurate counts from parsed cards) ──
    function updateRiskSummary(cards) {
        var strip = $('riskSummaryStrip');
        if (!strip) return;
        var counts = { red: 0, yellow: 0, green: 0 };
        for (var i = 0; i < cards.length; i++) {
            var r = cards[i].getAttribute('data-risk-level') || 'green';
            if (counts[r] !== undefined) counts[r]++;
        }
        var html = '';
        if (counts.red > 0) html += '<span class="risk-count"><span class="risk-dot risk-dot-red"></span>' + counts.red + ' concern' + (counts.red !== 1 ? 's' : '') + '</span>';
        if (counts.yellow > 0) html += '<span class="risk-count"><span class="risk-dot risk-dot-yellow"></span>' + counts.yellow + ' watch item' + (counts.yellow !== 1 ? 's' : '') + '</span>';
        if (counts.green > 0) html += '<span class="risk-count"><span class="risk-dot risk-dot-green"></span>' + counts.green + ' fair</span>';
        strip.innerHTML = html;
        strip.classList.add('visible');
    }

    function updateCardDots(cards, total) {
        var dotsEl = $('cardNavDots');
        if (!dotsEl) return;
        if (window.innerWidth > 900) { dotsEl.innerHTML = ''; return; }
        // Rebuild dots if count changed
        if (dotsEl.children.length !== total) {
            dotsEl.innerHTML = '';
            for (var d = 0; d < total; d++) {
                var dot = document.createElement('span');
                dot.className = 'card-nav-dot';
                dot.setAttribute('data-index', d);
                dot.addEventListener('click', (function(idx) {
                    return function() { showCardAtIndex(idx); };
                })(d));
                dotsEl.appendChild(dot);
            }
        }
        // Update active + risk colors
        for (var d = 0; d < dotsEl.children.length; d++) {
            var dot = dotsEl.children[d];
            dot.classList.remove('active', 'risk-red', 'risk-yellow', 'risk-green');
            if (d === currentCardIndex) dot.classList.add('active');
            // Color by risk level if card has been flipped
            if (cards[d]) {
                var risk = cards[d].getAttribute('data-risk-level');
                if (risk && cards[d].classList.contains('woosh-done')) {
                    dot.classList.add('risk-' + risk);
                }
            }
        }
    }

    // ── Phase 3: Render deep analysis into separate container ──
    function renderDeepAnalysisContent() {
        // Skip entirely when using tagged one-screen verdict
        if (hasTaggedContent(opusSections.overall.text || '')) return;
        var deepText = assembleDeepText();
        if (!deepText.trim()) return;

        // Add Opus header once
        if (!deepAnalysisEl.previousElementSibling || !deepAnalysisEl.previousElementSibling.classList.contains('deep-analysis-header')) {
            var header = document.createElement('div');
            header.className = 'deep-analysis-header';
            header.innerHTML = '<span class="section-label">Full Verdict</span>' +
                '<span class="opus-badge">Opus 4.6 Reasoning</span>';
            deepAnalysisEl.parentNode.insertBefore(header, deepAnalysisEl);
        }

        var safeMd = deepText
            // Strip Opus-generated H1 titles (redundant with our H2 section labels)
            .replace(/^# .+$/gm, '')
            .replace(/\[READER\]\s*:/g, 'FLIPSIDE_READER:')
            .replace(/\[DRAFTER\]\s*:/g, 'FLIPSIDE_DRAFTER:')
            .replace(/^READER\s*:/gm, 'FLIPSIDE_READER:')
            .replace(/^DRAFTER\s*:/gm, 'FLIPSIDE_DRAFTER:');
        var html = safeMd2Html(safeMd);
        html = styleRiskBadges(html);
        html = styleWhyClauses(html);
        html = styleReaderBlocks(html);
        html = styleDrafterBlocks(html);
        html = styleSplitClauses(html);
        deepAnalysisEl.innerHTML = safeHtml(html);

        wrapClauseSections(deepAnalysisEl);

        // Promote "How Opus 4.6 Analyzed This" to a callout near the top
        promoteOpusMethodSection(deepAnalysisEl);

        // Animate new deep analysis cards
        deepAnalysisEl.querySelectorAll('.cross-clause-card, .playbook-card, .assessment-card').forEach(function(card) {
            var title = card.getAttribute('data-clause-title');
            if (title && !animatedCardTitles.has(title)) {
                animatedCardTitles.add(title);
                card.classList.add('new-card');
                setTimeout(function() { card.classList.remove('new-card'); }, 500);
            }
        });

        // Try to update drafter voice on flip cards from deep analysis [DRAFTER] blocks
        updateDrafterVoices(deepText);
    }

    // ── Update drafter voice text on flip cards from deep analysis ──
    function updateDrafterVoices(deepText) {
        var drafterParts = deepText.split(/(?=^### )/m);
        for (var i = 0; i < drafterParts.length; i++) {
            var part = drafterParts[i];
            var headerMatch = part.match(/^### \s*(.+?)\s*(?:\(|$)/m);
            if (!headerMatch) continue;

            var drafterMatch = part.match(/\[DRAFTER\]\s*:\s*([\s\S]*?)(?=\n\n|\n###|$)/i);
            if (!drafterMatch) continue;

            var clauseTitle = headerMatch[1].trim();
            var drafterText = drafterMatch[1].trim();
            if (!drafterText) continue;

            // Find matching flip card and update its drafter-voice-text
            var cards = flipCardContainer.querySelectorAll('.flip-card');
            for (var j = 0; j < cards.length; j++) {
                var cardTitle = cards[j].getAttribute('data-clause-title');
                if (cardTitle && (cardTitle === clauseTitle || cardTitle === escapeHtml(clauseTitle))) {
                    var voiceEl = cards[j].querySelector('.drafter-voice-text');
                    if (voiceEl && voiceEl.textContent.indexOf('Deep analysis in progress') >= 0) {
                        voiceEl.textContent = drafterText;
                    }
                    break;
                }
            }
        }
    }


    // ── Clause card wrapping ──────────────────────────────────
    function wrapClauseSections(container) {
        container = container || resultsContent;

        // Remove any Opus-generated H1 titles (redundant with our section labels)
        container.querySelectorAll('h1').forEach(function(h1) { h1.remove(); });

        // Add editorial dividers before H2 section headings (Cross-Clause, Playbook, Assessment)
        container.querySelectorAll('h2').forEach(function(h2) {
            if (h2.previousElementSibling && !h2.previousElementSibling.classList.contains('editorial-divider')) {
                var divider = document.createElement('hr');
                divider.className = 'editorial-divider';
                h2.parentNode.insertBefore(divider, h2);
            }
            // Style H2 as section-label
            h2.classList.add('section-label');
            h2.style.fontSize = '0.75rem';
            h2.style.marginBottom = '1rem';
            h2.style.marginTop = '0.5rem';
        });

        var headings = container.querySelectorAll('h3');

        headings.forEach(function(h3) {
            if (h3.parentElement.classList.contains('clause-card') ||
                h3.parentElement.classList.contains('cross-clause-card') ||
                h3.parentElement.classList.contains('playbook-card') ||
                h3.parentElement.classList.contains('assessment-card')) return;

            var sectionType = getSectionType(h3);
            var cardClass = sectionType === 'cross' ? 'cross-clause-card' :
                            sectionType === 'playbook' ? 'playbook-card' :
                            sectionType === 'assessment' ? 'assessment-card' : 'clause-card';
            var card = document.createElement('div');
            card.className = cardClass;

            var siblings = [h3];
            var next = h3.nextElementSibling;
            while (next && next.tagName !== 'H3' && next.tagName !== 'H2' && next.tagName !== 'HR') {
                siblings.push(next);
                next = next.nextElementSibling;
            }

            // Detect risk level for clause cards
            if (sectionType === 'clause' || sectionType === 'cross') {
                var text = siblings.map(function(el) { return el.innerHTML || el.textContent; }).join(' ');
                var level = '';
                if (text.match(/risk-red|RED/)) level = 'red';
                else if (text.match(/risk-yellow|YELLOW/)) level = 'yellow';
                else if (text.match(/risk-green|GREEN/)) level = 'green';
                if (level) card.classList.add('level-' + level);
                card.setAttribute('data-risk-level', level);
            }

            card.setAttribute('data-clause-title', h3.textContent.trim());
            h3.parentNode.insertBefore(card, h3);
            siblings.forEach(function(el) { card.appendChild(el); });

            // Move split section to lead the card
            if (sectionType === 'clause') {
                var splitHeader = card.querySelector('.clause-split-header');
                var splitBody = card.querySelector('.clause-split');
                if (splitHeader && splitBody) {
                    var afterH3 = card.querySelector('h3').nextSibling;
                    card.insertBefore(splitHeader, afterH3);
                    card.insertBefore(splitBody, splitHeader.nextSibling);
                }
            }
        });
    }

    function getSectionType(el) {
        var prev = el.previousElementSibling;
        while (prev) {
            if (prev.tagName === 'H2') {
                var text = prev.textContent.toLowerCase();
                if (text.indexOf('cross-clause') >= 0) return 'cross';
                if (text.indexOf('playbook') >= 0 || text.indexOf('who drafted') >= 0) return 'playbook';
                if (text.indexOf('fair standard') >= 0 || text.indexOf('benchmark') >= 0) return 'cross';
                if (text.indexOf('how opus') >= 0 || text.indexOf('analyzed this') >= 0) return 'playbook';
                if (text.indexOf('quality check') >= 0 || text.indexOf('calibration') >= 0) return 'assessment';
                if (text.indexOf('assessment') >= 0) return 'assessment';
                return 'clause';
            }
            prev = prev.previousElementSibling;
        }
        return 'clause';
    }

    // ── Promote "How Opus 4.6 Analyzed This" to top callout ──
    function promoteOpusMethodSection(container) {
        var opusH2 = null;
        container.querySelectorAll('h2').forEach(function(h2) {
            var t = h2.textContent.toLowerCase();
            if (t.indexOf('how opus') >= 0 || t.indexOf('analyzed this') >= 0) opusH2 = h2;
        });
        if (!opusH2) return;

        // Gather content between this H2 and the next H2/HR
        var content = [];
        var sibling = opusH2.nextElementSibling;
        while (sibling && sibling.tagName !== 'H2' && !(sibling.tagName === 'HR' && sibling.classList.contains('editorial-divider'))) {
            content.push(sibling);
            sibling = sibling.nextElementSibling;
        }
        if (content.length === 0) return;

        // Build callout
        var callout = document.createElement('div');
        callout.className = 'opus-method-callout';
        callout.innerHTML = '<div class="callout-label">How Opus 4.6 Analyzed This Document</div>';
        content.forEach(function(el) { callout.appendChild(el.cloneNode(true)); });

        // Remove original section (H2 + content + preceding divider)
        var prevDivider = opusH2.previousElementSibling;
        if (prevDivider && prevDivider.classList && prevDivider.classList.contains('editorial-divider')) {
            prevDivider.remove();
        }
        content.forEach(function(el) { el.remove(); });
        opusH2.remove();

        // Insert at top of deep analysis
        container.insertBefore(callout, container.firstChild);
    }

    // ── Clause data extraction ────────────────────────────────
    function extractClausesFromResponse() {
        // DOM-based: reads from card elements (works for both front-only and full data)
        var cards = flipCardContainer.querySelectorAll('.flip-card');
        var clauses = [];
        cards.forEach(function(card) {
            var blEl = card.querySelector('.back-bottom-line');
            clauses.push({
                title: card.getAttribute('data-clause-title') || '',
                section: card.getAttribute('data-section-ref') || '',
                level: card.getAttribute('data-risk-level') || '',
                score: parseInt(card.getAttribute('data-score') || '0'),
                trick: card.getAttribute('data-trick') || '',
                bottomLine: blEl ? blEl.textContent.trim() : '',
                shouldRead: card.getAttribute('data-should-read') || '',
                figure: card.getAttribute('data-figure') || '',
                quote: card.getAttribute('data-quote') || ''
            });
        });
        return clauses;
    }

    // ── Filter chips ──────────────────────────────────────────
    function buildFilterChips() {
        var clauses = extractClausesFromResponse();
        if (clauses.length === 0) return;

        var counts = { red: 0, yellow: 0, green: 0 };
        clauses.forEach(function(c) { if (counts[c.level] !== undefined) counts[c.level]++; });

        var html = '';
        if (counts.red > 0)    html += '<button class="filter-chip chip-red" data-filter="red">' + counts.red + ' Red</button>';
        if (counts.yellow > 0) html += '<button class="filter-chip chip-yellow" data-filter="yellow">' + counts.yellow + ' Yellow</button>';
        if (counts.green > 0)  html += '<button class="filter-chip chip-green" data-filter="green">' + counts.green + ' Green</button>';

        // Trick type chips (only for tricks appearing 2+ times)
        var trickCounts = {};
        clauses.forEach(function(c) {
            if (c.trick) trickCounts[c.trick] = (trickCounts[c.trick] || 0) + 1;
        });

        var trickHtml = '';
        var sortedTricks = Object.keys(trickCounts)
            .filter(function(t) { return trickCounts[t] >= 2; })
            .sort(function(a, b) { return trickCounts[b] - trickCounts[a]; });

        sortedTricks.forEach(function(trick) {
            var icon = TRICK_ICONS[trick] ? '<span class="verdict-trick-icon">' + TRICK_ICONS[trick] + '</span> ' : '';
            trickHtml += '<button class="filter-chip chip-trick" data-filter-trick="' +
                escapeHtml(trick) + '">' + icon + escapeHtml(trick) +
                ' <span class="chip-count">' + trickCounts[trick] + '</span></button>';
        });

        if (trickHtml) {
            html += '<div class="trick-chip-row">' + trickHtml + '</div>';
        }

        if (html) {
            filterChips.innerHTML = html;
            filterChips.classList.remove('hidden');

            // Risk level chip handlers
            filterChips.querySelectorAll('.filter-chip[data-filter]').forEach(function(chip) {
                chip.addEventListener('click', function() {
                    var level = chip.getAttribute('data-filter');
                    if (activeFilters.has(level)) {
                        activeFilters.delete(level);
                        chip.classList.remove('active');
                    } else {
                        activeFilters.add(level);
                        chip.classList.add('active');
                    }
                    applyFilters();
                });
            });

            // Trick type chip handlers
            filterChips.querySelectorAll('.chip-trick').forEach(function(chip) {
                chip.addEventListener('click', function() {
                    var trick = chip.getAttribute('data-filter-trick');
                    if (activeTrickFilters.has(trick)) {
                        activeTrickFilters.delete(trick);
                        chip.classList.remove('active');
                    } else {
                        activeTrickFilters.add(trick);
                        chip.classList.add('active');
                    }
                    applyFilters();
                });
            });
        }
    }

    function activateTrickFilter(trickName) {
        // Activate a trick filter from playbook click
        var chip = filterChips.querySelector('.chip-trick[data-filter-trick="' + CSS.escape(trickName) + '"]');
        if (chip && !activeTrickFilters.has(trickName)) {
            activeTrickFilters.add(trickName);
            chip.classList.add('active');
        }
        applyFilters();
        // Scroll to cards
        var viewport = $('cardViewport');
        if (viewport && !viewport.classList.contains('hidden')) {
            viewport.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    }

    function applyFilters() {
        var container = flipCardsBuilt ? flipCardContainer : resultsContent;
        var selector = '.clause-card, .flip-card';
        var noFilters = activeFilters.size === 0 && activeTrickFilters.size === 0;

        if (noFilters) {
            container.querySelectorAll(selector).forEach(function(card) {
                card.style.display = '';
            });
            if (flipCardsBuilt) showCardAtIndex(0);
            return;
        }

        var visibleCards = [];
        container.querySelectorAll(selector).forEach(function(card) {
            var level = card.getAttribute('data-risk-level');
            var trick = card.getAttribute('data-trick') || '';

            var riskMatch = activeFilters.size === 0 || (level && activeFilters.has(level));
            var trickMatch = activeTrickFilters.size === 0 || activeTrickFilters.has(trick);

            if (riskMatch && trickMatch) {
                card.style.display = '';
                visibleCards.push(card);
            } else {
                card.style.display = 'none';
            }
        });

        // Show first visible card in card viewport mode
        if (flipCardsBuilt && visibleCards.length > 0) {
            var idx = parseInt(visibleCards[0].getAttribute('data-clause-index')) || 0;
            showCardAtIndex(idx);
        }
    }

    // ── Summary card builder ──────────────────────────────────
    function buildSummaryCard() {
        // Skip entirely when using tagged one-screen verdict
        if (hasTaggedContent(opusSections.overall.text || '')) return;
        var text = assembleDeepText() || responseContent;

        // ── Parse verdict tier from Opus output ──
        var VERDICT_TIERS = {
            'SIGN WITH CONFIDENCE':      { tier: 'sign',      label: 'Sign with Confidence' },
            'READ THE FLAGGED CLAUSES':   { tier: 'read',      label: 'Read the Flagged Clauses' },
            'NEGOTIATE BEFORE SIGNING':   { tier: 'negotiate', label: 'Negotiate Before Signing' },
            'SEEK LEGAL REVIEW':          { tier: 'legal',     label: 'Seek Legal Review' },
            'DO NOT SIGN':                { tier: 'dontsign',  label: 'Do Not Sign' }
        };

        var verdictMatch = text.match(/Verdict:\s*([A-Z][A-Z\s]+)/i);
        var verdictRaw = verdictMatch ? verdictMatch[1].trim().toUpperCase() : '';
        var verdict = null;

        // Try exact match first, then prefix match
        Object.keys(VERDICT_TIERS).forEach(function(key) {
            if (!verdict && verdictRaw.indexOf(key) === 0) verdict = VERDICT_TIERS[key];
        });

        // ── Fallback: derive from clause distribution ──
        var clauses = extractClausesFromResponse();
        var counts = { red: 0, yellow: 0, green: 0 };
        clauses.forEach(function(c) { if (counts[c.level] !== undefined) counts[c.level]++; });
        var total = counts.red + counts.yellow + counts.green;

        if (!verdict && total > 0) {
            var redPct = counts.red / total;
            var yellowPct = counts.yellow / total;
            if (redPct >= 0.5) verdict = VERDICT_TIERS['SEEK LEGAL REVIEW'];
            else if (redPct >= 0.3 || yellowPct >= 0.5) verdict = VERDICT_TIERS['NEGOTIATE BEFORE SIGNING'];
            else if (counts.red > 0) verdict = VERDICT_TIERS['READ THE FLAGGED CLAUSES'];
            else verdict = VERDICT_TIERS['SIGN WITH CONFIDENCE'];
        }

        if (!verdict) return;

        // ── Parse top concerns ──
        var concerns = [];
        var assessmentStart = text.indexOf('Overall Assessment');
        var assessmentText = assessmentStart >= 0 ? text.substring(assessmentStart) : text;
        var concernLines = assessmentText.match(/\d+\.\s*\*\*.+?\*\*\s*(?:—|[-–]).+/g);
        if (concernLines) {
            concernLines.slice(0, 3).forEach(function(line) {
                var m = line.match(/\d+\.\s*\*\*(.+?)\*\*\s*(?:—|[-–])\s*(.+)/);
                if (m) concerns.push({ title: m[1], desc: m[2].trim() });
            });
        }

        // ── Render verdict card ──
        var h = '<div class="summary-card"><div class="summary-top">';
        h += '<div class="verdict-tier" data-tier="' + verdict.tier + '">' + escapeHtml(verdict.label) + '</div>';

        // Clause dot strip — sorted: red first, then yellow, then green
        if (total > 0) {
            var sortedClauses = clauses.slice().sort(function(a, b) {
                var order = { red: 0, yellow: 1, green: 2 };
                return (order[a.level] || 2) - (order[b.level] || 2);
            });
            h += '<div class="clause-strip">';
            sortedClauses.forEach(function(c, i) {
                var dotClass = 'dot-' + (c.level || 'green');
                var title = c.title || ('Clause ' + (i + 1));
                h += '<button class="clause-dot ' + dotClass + '" data-clause-index="' + i + '" title="' + escapeHtml(title) + '"></button>';
            });
            h += '</div>';
            // Counts label
            var parts = [];
            if (counts.red > 0)    parts.push(counts.red + ' concern' + (counts.red > 1 ? 's' : ''));
            if (counts.yellow > 0) parts.push(counts.yellow + ' watch');
            if (counts.green > 0)  parts.push(counts.green + ' fair');
            h += '<div class="clause-strip-counts">' + parts.join(' · ') + '</div>';
        }

        // Top concerns
        if (concerns.length) {
            h += '<div class="summary-meta"><ul class="summary-concerns">';
            concerns.forEach(function(c, i) {
                h += '<li><strong>' + (i + 1) + '. ' + escapeHtml(c.title) + '</strong> — ' + escapeHtml(c.desc) + '</li>';
            });
            h += '</ul></div>';
        }
        h += '</div></div>';

        summaryContainer.innerHTML = h;

        // Clause dot click → navigate to that card
        summaryContainer.querySelectorAll('.clause-dot').forEach(function(dot) {
            dot.addEventListener('click', function() {
                var idx = parseInt(dot.getAttribute('data-clause-index'));
                // Dots are sorted red→yellow→green, map back to original card order
                var sorted = clauses.slice().sort(function(a, b) {
                    var order = { red: 0, yellow: 1, green: 2 };
                    return (order[a.level] || 2) - (order[b.level] || 2);
                });
                var targetTitle = sorted[idx] ? sorted[idx].title : '';
                // Find the original card index by title match
                var allCards = flipCardContainer.querySelectorAll('.flip-card');
                for (var ci = 0; ci < allCards.length; ci++) {
                    if (allCards[ci].getAttribute('data-clause-title') === targetTitle) {
                        showCardAtIndex(ci);
                        return;
                    }
                }
                // Fallback: navigate to the nth card
                if (idx < allCards.length) showCardAtIndex(idx);
            });
        });

        // "Message the Company" button — between summary and playbook
        var drafterMatch = responseContent.match(/\*\*Drafted By\*\*[:\s]*([^\n*]+)/i);
        var companyName = drafterMatch ? drafterMatch[1].trim() : null;
        if (companyName) {
            var msgBtn = '<div class="message-company-section">';
            msgBtn += '<button class="message-company-btn" id="messageCompanyBtn">';
            msgBtn += '<span class="message-company-icon">\u2709</span> ';
            msgBtn += 'Draft a message to ' + escapeHtml(companyName);
            msgBtn += '</button>';
            msgBtn += '<div class="message-company-output hidden" id="messageCompanyOutput"></div>';
            msgBtn += '</div>';
            summaryContainer.insertAdjacentHTML('beforeend', msgBtn);

            $('messageCompanyBtn').addEventListener('click', function() {
                var btn = this;
                if (btn.classList.contains('generating')) return;
                btn.classList.add('generating');
                btn.innerHTML = '<span class="pulsing-dots"><span></span><span></span><span></span></span> Drafting your message...';

                var msgClauses = extractClausesFromResponse();
                var topConcerns = msgClauses
                    .filter(function(c) { return c.level === 'red' || c.level === 'yellow'; })
                    .sort(function(a, b) { var o = { red: 0, yellow: 1 }; return (o[a.level] || 2) - (o[b.level] || 2); })
                    .slice(0, 5);

                var concernsList = topConcerns.map(function(c) {
                    return '- ' + c.title + ' (Trick: ' + (c.trick || 'unknown') + '): ' + (c.bottomLine || c.figure || '');
                }).join('\n');

                var roleMatch = responseContent.match(/\*\*Your Role\*\*[:\s]*([^\n*]+)/i);
                var typeMatch = responseContent.match(/\*\*Document Type\*\*[:\s]*([^\n*]+)/i);
                var userRole = roleMatch ? roleMatch[1].trim() : 'the other party';
                var docType = typeMatch ? typeMatch[1].trim() : 'document';

                var prompt = 'Write a professional, firm but polite message from ' + userRole +
                    ' to ' + companyName + ' about their ' + docType + '.\n\n' +
                    'Verdict: ' + verdict.label + '. Clause breakdown: ' + counts.red + ' concerns, ' + counts.yellow + ' watch, ' + counts.green + ' fair.\n\n' +
                    'Top concerns found by analysis:\n' + concernsList + '\n\n' +
                    'The message should:\n' +
                    '1. State that the sender has had the ' + docType + ' independently analyzed\n' +
                    '2. Name the specific clauses of concern (use the real section titles/numbers)\n' +
                    '3. Ask for written clarification or revision on each point\n' +
                    '4. Be professional — not threatening, not apologetic\n' +
                    '5. End with a clear request for a response within a reasonable timeframe\n' +
                    '6. Be 200-300 words, ready to send as-is\n\n' +
                    'Write ONLY the message body. No subject line, no explanation.';

                var outputEl = $('messageCompanyOutput');
                outputEl.classList.remove('hidden');
                outputEl.innerHTML = '<span class="pulsing-dots"><span></span><span></span><span></span></span>';

                // Use the follow-up /ask endpoint with the complaint prompt
                var url = BASE_URL + '/ask/' + currentDocId;
                fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question: prompt })
                }).then(function(resp) {
                    if (!resp.ok) throw new Error('Request failed');
                    var reader = resp.body.getReader();
                    var decoder = new TextDecoder();
                    var fullText = '';
                    var buffer = '';

                    function readChunk() {
                        return reader.read().then(function(result) {
                            if (result.done) {
                                btn.classList.remove('generating');
                                btn.innerHTML = '<span class="message-company-icon">\u2709</span> Regenerate message';
                                // Add copy + mailto buttons
                                var actions = '<div class="message-actions">';
                                actions += '<button class="message-action-btn" id="copyMessageBtn">Copy to clipboard</button>';
                                actions += '<button class="message-action-btn" id="mailtoMessageBtn">Open in email</button>';
                                actions += '</div>';
                                outputEl.insertAdjacentHTML('beforeend', actions);
                                $('copyMessageBtn').addEventListener('click', function() {
                                    navigator.clipboard.writeText(fullText).then(function() {
                                        $('copyMessageBtn').textContent = 'Copied!';
                                        setTimeout(function() { $('copyMessageBtn').textContent = 'Copy to clipboard'; }, 2000);
                                    });
                                });
                                $('mailtoMessageBtn').addEventListener('click', function() {
                                    var subj = 'Regarding your ' + docType + ' — Request for Clarification';
                                    window.location.href = 'mailto:?subject=' + encodeURIComponent(subj) + '&body=' + encodeURIComponent(fullText);
                                });
                                return;
                            }
                            buffer += decoder.decode(result.value, { stream: true });
                            var lines = buffer.split('\n');
                            buffer = lines.pop();
                            lines.forEach(function(line) {
                                if (line.startsWith('data: ')) {
                                    try {
                                        var evt = JSON.parse(line.substring(6));
                                        if (evt.type === 'text' || evt.type === 'answer_text') {
                                            fullText += evt.content;
                                            outputEl.innerHTML = safeMd2Html(fullText);
                                        }
                                    } catch(e) {}
                                }
                            });
                            return readChunk();
                        });
                    }
                    return readChunk();
                }).catch(function(err) {
                    btn.classList.remove('generating');
                    btn.innerHTML = '<span class="message-company-icon">\u2709</span> Draft a message to ' + escapeHtml(companyName);
                    outputEl.innerHTML = '<p style="color:var(--red)">Failed to generate message. Please try again.</p>';
                });
            });
        }
    }

    // ── Drafter's Playbook — trick frequency visualization ───
    function buildPlaybookCard() {
        // Skip entirely when using tagged one-screen verdict
        if (hasTaggedContent(opusSections.overall.text || '')) return;
        var clauses = extractClausesFromResponse();
        var trickCounts = {};
        var totalClauses = 0;
        var classifiedCount = 0;
        var greenCount = 0;
        clauses.forEach(function(c) {
            if (c.level === 'green') { greenCount++; return; }
            totalClauses++;
            if (c.trick && c.trick.toLowerCase() !== 'none') {
                trickCounts[c.trick] = (trickCounts[c.trick] || 0) + 1;
                classifiedCount++;
            }
        });

        var sorted = Object.keys(trickCounts).sort(function(a, b) {
            return trickCounts[b] - trickCounts[a];
        });

        if (sorted.length === 0) return;

        var maxCount = trickCounts[sorted[0]];
        var uniqueCount = sorted.length;

        var h = '<div class="playbook-card">';
        h += '<div class="playbook-header">';
        h += '<span class="playbook-title">The Drafter\'s Playbook</span>';
        h += '<span class="playbook-subtitle">' + classifiedCount + ' of ' + totalClauses + ' clauses categorized \u00B7 ' + uniqueCount + ' trick types</span>';
        h += '</div>';

        h += '<div class="playbook-bars">';
        sorted.forEach(function(trick) {
            var count = trickCounts[trick];
            var pct = Math.round((count / maxCount) * 100);
            var icon = TRICK_ICONS[trick] ? '<span class="verdict-trick-icon">' + TRICK_ICONS[trick] + '</span> ' : '';
            var desc = TRICK_DESCRIPTIONS[trick] || '';
            h += '<div class="playbook-row" data-trick="' + escapeHtml(trick) + '" title="' + escapeHtml(desc) + '">';
            h += '<span class="playbook-trick-name">' + icon + escapeHtml(trick) + '</span>';
            h += '<div class="playbook-bar-track"><div class="playbook-bar-fill" style="width:' + pct + '%"></div></div>';
            h += '<span class="playbook-count">' + count + '\u00d7</span>';
            h += '</div>';
        });
        // Green clauses row at the bottom — shows what's fair
        if (greenCount > 0) {
            h += '<div class="playbook-row playbook-row-green" title="Clauses that are straightforward and fair as written">';
            h += '<span class="playbook-trick-name">\u2705 Fair Clauses</span>';
            var greenPct = Math.round((greenCount / maxCount) * 100);
            h += '<div class="playbook-bar-track"><div class="playbook-bar-fill" style="width:' + Math.min(greenPct, 100) + '%;background:var(--green)"></div></div>';
            h += '<span class="playbook-count">' + greenCount + '\u00d7</span>';
            h += '</div>';
        }

        h += '</div></div>';

        // Remove existing playbook before inserting (prevents duplicates on re-render)
        summaryContainer.querySelectorAll('.playbook-card').forEach(function(el) { el.remove(); });
        summaryContainer.insertAdjacentHTML('beforeend', h);

        // Click handler: playbook row → activate trick filter
        summaryContainer.querySelectorAll('.playbook-row').forEach(function(row) {
            row.addEventListener('click', function() {
                var trick = row.getAttribute('data-trick');
                if (trick) activateTrickFilter(trick);
            });
        });
    }

    // ── Trick pill click: toggle description tooltip ────────
    document.addEventListener('click', function(e) {
        var trickItem = e.target.closest('.verdict-trick-item');
        // Close all other open tooltips
        document.querySelectorAll('.verdict-trick-item.show-desc').forEach(function(el) {
            if (el !== trickItem) el.classList.remove('show-desc');
        });
        if (trickItem && trickItem.querySelector('.verdict-trick-desc')) {
            trickItem.classList.toggle('show-desc');
            e.stopPropagation();
        }
    });

    // ── Verdict column expand button ─────────────────────────
    verdictExpandBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        if (!opusSections.overall.done && !deepTextComplete && !isDoneRendering && !_coreVerdictReady) return;
        dismissVerdictStrip();
        exitFocusedMode();
        revealDeepAnalysis(true);
    });

    // ── Thinking viewer toggle ─────────────────────────────
    var _thinkToggleEl = $('thinkingToggle');
    if (_thinkToggleEl) _thinkToggleEl.addEventListener('click', toggleThinkingViewer);

    // ── Verdict progress strip CTAs ──────────────────────────
    var _vsCta = $('verdictStripCta'), _vsPeekCta = $('verdictStripPeekCta');
    if (_vsCta) _vsCta.addEventListener('click', function(e) {
        e.stopPropagation();
        dismissVerdictStrip();
        exitFocusedMode();
        revealDeepAnalysis(true);
    });
    if (_vsPeekCta) _vsPeekCta.addEventListener('click', function(e) {
        e.stopPropagation();
        dismissVerdictStrip();
        exitFocusedMode();
        revealDeepAnalysis(true);
    });

    // ── Section index pills: scroll to target section ──────────
    document.addEventListener('click', function(e) {
        var pill = e.target.closest('.verdict-section-pill');
        if (!pill) return;
        var targetId = pill.getAttribute('data-scroll-to');
        if (!targetId) return;
        var target = document.getElementById(targetId);
        if (target) {
            target.scrollIntoView({ behavior: 'smooth', block: 'start' });
            // Auto-expand if it's a collapsed section
            if (target.classList.contains('collapsed')) {
                target.classList.remove('collapsed');
            }
        }
    });

    // ── Back to cards button (from verdict view) ──────────────
    on('backToCardsBtn', 'click', function() {
        if (_verdictPollTimer) { clearTimeout(_verdictPollTimer); _verdictPollTimer = null; }
        $('deepAnalysisSection').classList.add('hidden');
        $('cardViewport').classList.remove('hidden');
        exitFocusedMode();
        // Inline verdict stays visible below cards (no verdict column re-show needed)
        setTimeout(function() {
            $('cardViewport').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 50);
    });

    // ── Cards ready pill click → jump to first card ──────────
    on('cardsReadyPill', 'click', function() {
        $('cardsReadyPill').classList.add('hidden');
        _verdictAutoRevealed = false;
        // Hide inline verdict, show card viewport
        $('inlineVerdict').classList.remove('visible');
        if (_verdictPollTimer) { clearTimeout(_verdictPollTimer); _verdictPollTimer = null; }
        var skeleton = $('skeletonCard');
        if (skeleton) skeleton.classList.add('hidden');
        $('cardViewport').classList.remove('hidden');
        $('eduReviewPill').classList.remove('hidden');
        showCardAtIndex(0);
        setTimeout(function() {
            $('cardViewport').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 50);
    });

    // ── Back button ───────────────────────────────────────────
    backBtn.addEventListener('click', function() {
        if (!isDoneRendering && eventSource) {
            if (!confirm('Analysis is still running. Going back will discard all results.')) return;
        }
        if (eventSource) { eventSource.close(); eventSource = null; }
        if (elapsedInterval) { clearInterval(elapsedInterval); elapsedInterval = null; }
        if (_verdictPollTimer) { clearTimeout(_verdictPollTimer); _verdictPollTimer = null; }
        stopStatusRotation();

        stopInvestigationScroll();
        resetVerdictCol();
        stopVerdictCountdown();

        analysisScreen.classList.add('hidden');
        uploadScreen.classList.remove('hidden');
        // Hide doc title hero
        var heroEl = $('docTitleHero');
        if (heroEl) { heroEl.classList.add('hidden'); }
        $('docTitleText').textContent = '';
        $('docTitleFlag').classList.add('hidden');
        $('docTitleFlag').textContent = '';
        // Clean up rejection screen if it exists
        var rejScreen = $('rejectionScreen');
        if (rejScreen) rejScreen.remove();
        // Reset layout expand state
        var layoutEl = document.querySelector('.analysis-layout');
        layoutEl.classList.remove('sidebar-visible');

        // Reset upload UI
        analyzeBtn.textContent = 'Flip it';
        updateAnalyzeBtn();
    });

    // ── Header brand = back ───────────────────────────────────
    on('headerBrand', 'click', function() { backBtn.click(); });

    // ── Copy all ──────────────────────────────────────────────
    on('copyAllBtn', 'click', function() {
        var text = flipCardsBuilt
            ? (flipCardContainer.innerText + '\n\n' + deepAnalysisEl.innerText)
            : resultsContent.innerText;
        navigator.clipboard.writeText(text).then(function() {
            var btn = $('copyAllBtn');
            btn.textContent = 'Copied!';
            setTimeout(function() { btn.textContent = 'Copy all'; }, 2000);
        });
    });

    // ── Export PDF Report (Problem 7) ───────────────────────────
    on('exportBtn', 'click', function() {
        var btn = this;
        if (btn.classList.contains('generating')) return;
        btn.classList.add('generating');
        var origText = btn.textContent;
        btn.textContent = 'Generating PDF...';

        var docName = 'FlipSide Analysis';
        var meta = metadataLine.textContent;
        if (meta) docName = meta.split('Type:')[1] ? meta.split('Type:')[1].split('Drafted')[0].trim() : docName;

        var cards = flipCardContainer.querySelectorAll('.flip-card');
        var body = '';

        // Metadata
        var metaPills = metadataLine.querySelectorAll('.meta-pill');
        if (metaPills.length) {
            body += '<div class="meta">';
            metaPills.forEach(function(p) {
                var label = p.querySelector('.meta-pill-label');
                var value = p.querySelector('.meta-pill-value');
                if (label && value) body += '<span class="meta-item"><strong>' + label.textContent + '</strong> ' + escapeHtml(value.textContent) + '</span>';
            });
            body += '</div>';
        }

        // Risk summary
        var riskCounts = { red: 0, yellow: 0, green: 0 };
        cards.forEach(function(card) {
            var r = card.getAttribute('data-risk-level') || 'green';
            if (riskCounts[r] !== undefined) riskCounts[r]++;
        });
        body += '<div class="summary">';
        if (riskCounts.red > 0) body += '<span class="risk-badge risk-red">' + riskCounts.red + ' concern' + (riskCounts.red !== 1 ? 's' : '') + '</span> ';
        if (riskCounts.yellow > 0) body += '<span class="risk-badge risk-yellow">' + riskCounts.yellow + ' watch item' + (riskCounts.yellow !== 1 ? 's' : '') + '</span> ';
        if (riskCounts.green > 0) body += '<span class="risk-badge risk-green">' + riskCounts.green + ' fair</span>';
        body += '</div>';

        // Tricks Detected
        var trickKeys = Object.keys(_detectedTricks);
        if (trickKeys.length > 0) {
            var sortedTricks = trickKeys.sort(function(a, b) { return _detectedTricks[b] - _detectedTricks[a]; });
            body += '<h2>' + sortedTricks.length + ' Tricks Detected</h2>';
            body += '<div class="tricks-grid">';
            sortedTricks.forEach(function(trick) {
                var desc = TRICK_DESCRIPTIONS[trick] || '';
                var count = _detectedTricks[trick];
                var icon = TRICK_ICONS[trick] || '';
                body += '<div class="trick-card">';
                if (icon) body += '<span class="trick-card-icon">' + icon + '</span>';
                body += '<span class="trick-card-name">' + escapeHtml(trick);
                if (count > 1) body += ' <span class="trick-card-count">\u00d7' + count + '</span>';
                body += '</span>';
                if (desc) body += '<span class="trick-card-desc">' + escapeHtml(desc) + '</span>';
                body += '</div>';
            });
            body += '</div>';
        }

        // Findings
        if (cards.length) {
            body += '<h2>Findings</h2>';
            cards.forEach(function(card, i) {
                var title = card.getAttribute('data-clause-title') || 'Clause ' + (i + 1);
                var risk = card.getAttribute('data-risk-level') || '';
                var score = card.getAttribute('data-score') || '';
                var trick = card.getAttribute('data-trick') || '';
                var section = card.getAttribute('data-section-ref') || '';

                body += '<div class="clause"><div class="clause-header">';
                body += '<span class="risk-badge risk-' + risk + '">' + risk.toUpperCase() + '</span>';
                if (score) body += ' <span class="clause-score">' + score + '/100</span>';
                if (trick) body += ' <span class="clause-trick">' + escapeHtml(trick) + '</span>';
                body += '</div>';
                body += '<h3>' + escapeHtml(title) + '</h3>';
                if (section) body += '<div class="clause-ref">Source: ' + escapeHtml(section) + '</div>';

                // Bottom line
                var bottomLine = card.querySelector('.back-bottom-line') || card.querySelector('.back-bottom-line-lead');
                if (bottomLine) body += '<p class="bottom-line"><strong>Bottom line:</strong> ' + escapeHtml(bottomLine.textContent.trim()) + '</p>';

                // Figure
                var figure = card.querySelector('.back-figure');
                if (figure) body += '<div class="figure">' + escapeHtml(figure.textContent.trim()) + '</div>';

                // Example
                var example = card.querySelector('.back-example');
                if (example) body += '<p class="example">' + escapeHtml(example.textContent.trim()) + '</p>';

                body += '</div>';
            });
        }

        // Expert Verdict
        var verdictText = (opusSections.overall.text || '').trim();
        if (verdictText) {
            body += '<hr><h2>Expert Verdict</h2>';
            var html = safeMd2Html(verdictText.replace(/^# .+$/gm, '').replace(/\[\/?[A-Z_]+\]/g, ''));
            body += '<div class="verdict">' + html + '</div>';
        }

        // Deep Dive Reports
        var deepDiveLabels = {
            archaeology: 'Document Archaeology',
            scenario: 'What Could Happen',
            walkaway: 'Walk-Away Number',
            combinations: 'Hidden Combinations',
            playbook: 'Negotiation Playbook'
        };
        DEEP_DIVE_SOURCES.forEach(function(source) {
            var dd = deepDiveResults[source];
            if (!dd || !dd.text || !dd.text.trim()) return;
            var label = deepDiveLabels[source] || source;
            body += '<hr><h2>' + escapeHtml(label) + '</h2>';
            // Strip tags like [SCENARIO_TITLE], [TIMELINE_STEP], etc.
            var cleaned = dd.text.replace(/\[\/?[A-Z_]+(?:\s+[^\]]+)?\]/g, '').trim();
            body += '<div class="verdict">' + safeMd2Html(cleaned) + '</div>';
        });

        // Source Text (with page numbers)
        if (documentFullText) {
            body += '<hr><h2>Source Text</h2>';
            body += '<p style="color:#9c9789;font-size:0.78rem">The analysis above is based on the following extracted document text.</p>';
            var sourceLines = escapeHtml(documentFullText).split('\n');
            var sourceHtml = '<div class="source-text">';
            sourceLines.forEach(function(line) {
                var pageMatch = line.match(/^—\s*Page\s+(\d+)\s*—$/);
                if (pageMatch) {
                    sourceHtml += '<div class="page-marker">— Page ' + pageMatch[1] + ' —</div>';
                } else {
                    sourceHtml += line + '\n';
                }
            });
            sourceHtml += '</div>';
            body += sourceHtml;
        }

        var exportHtml = '<!DOCTYPE html><html><head><meta charset="UTF-8">' +
            '<title>' + escapeHtml(docName) + ' \u2014 FlipSide Analysis</title>' +
            '<style>' +
            'body{font-family:"DM Sans",system-ui,sans-serif;max-width:800px;margin:2rem auto;padding:0 1.5rem;color:#1a1a18;line-height:1.65;font-size:11px}' +
            'h1{font-size:1.4rem;border-bottom:2px solid #c44b28;padding-bottom:0.5rem;margin-bottom:0.5rem}' +
            'h2{margin-top:2rem;font-size:1.15rem;color:#3d3b36;border-bottom:1px solid #e2ddd4;padding-bottom:0.3rem}' +
            'h3{margin-top:0.5rem;margin-bottom:0.3rem;font-size:1rem}' +
            '.meta{margin-bottom:1rem;font-size:0.85rem;color:#6b6860}' +
            '.meta-item{display:inline-block;margin-right:1.5rem}' +
            '.summary{margin:0.8rem 0 1rem;display:flex;gap:0.5rem;flex-wrap:wrap}' +
            '.clause{margin:1rem 0;padding:0.8rem;background:#faf8f4;border-radius:6px;border:1px solid #e2ddd4;page-break-inside:avoid}' +
            '.clause-header{margin-bottom:0.3rem;font-size:0.82rem}' +
            '.clause-score{font-weight:700}.clause-trick{color:#6b6860;font-style:italic}' +
            '.clause-ref{font-size:0.78rem;color:#9c9789;margin-bottom:0.5rem}' +
            '.risk-badge{display:inline-block;padding:2px 8px;border-radius:3px;font-size:0.72rem;font-weight:700;text-transform:uppercase}' +
            '.risk-red{background:#fce4ec;color:#a83d20}.risk-yellow{background:#fff8e1;color:#8a6508}.risk-green{background:#e8f5e9;color:#1e6b38}' +
            'blockquote{border-left:3px solid #c44b28;padding:0.5rem 1rem;margin:0.8rem 0;background:#fff;font-style:italic;border-radius:0 4px 4px 0}' +
            '.figure{font-size:1.1rem;font-weight:700;color:#a83d20;margin:0.5rem 0}' +
            '.example{color:#3d3b36;margin:0.3rem 0}.bottom-line{margin:0.5rem 0}' +
            '.verdict{margin-top:0.5rem}.verdict h3{margin-top:1.2rem}' +
            '.verdict blockquote{border-left-color:#9c9789}' +
            'hr{border:none;border-top:1px solid #e2ddd4;margin:1.5rem 0}' +
            '.source-text{white-space:pre-wrap;font-family:monospace;font-size:0.78rem;line-height:1.5;color:#3d3b36;padding:0.8rem;background:#faf8f4;border:1px solid #e2ddd4;border-radius:6px}' +
            '.page-marker{text-align:center;color:#9c9789;font-weight:600;margin:1rem 0;border-top:1px solid #e2ddd4;padding-top:0.5rem}' +
            '.tricks-grid{display:flex;flex-wrap:wrap;gap:0.5rem;margin:0.5rem 0 1rem}' +
            '.trick-card{display:flex;align-items:center;gap:0.4rem;padding:0.35rem 0.65rem;background:#faf8f4;border:1px solid #e2ddd4;border-radius:100px;font-size:0.78rem;page-break-inside:avoid}' +
            '.trick-card-icon{width:14px;height:14px;flex-shrink:0;color:#6b6860;display:inline-flex}' +
            '.trick-card-icon svg{width:100%;height:100%}' +
            '.trick-card-name{font-weight:600;color:#3d3b36;white-space:nowrap}' +
            '.trick-card-count{font-size:0.68rem;color:#9c9789}' +
            '.trick-card-desc{color:#6b6860;font-size:0.72rem;border-left:1px solid #e2ddd4;padding-left:0.5rem;margin-left:0.2rem}' +
            '.footer{margin-top:2rem;padding-top:1rem;border-top:1px solid #e2ddd4;font-size:0.72rem;color:#9c9789}' +
            '</style></head><body>' +
            '<h1>FlipSide Analysis Report</h1>' +
            '<p style="font-size:1rem;color:#3d3b36;margin-top:-0.3rem">' + escapeHtml(docName) + '</p>' +
            '<p style="font-size:0.78rem;color:#9c9789">Analyzed: ' + new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) + '</p>' +
            body +
            '<div class="footer">Generated by FlipSide \u2014 The Other Side of Small Print.<br>Powered by Claude Opus 4.6. This is an AI-generated educational review, not legal advice.<br>Henk van Ess \u2014 www.digitaldigging.org</div>' +
            '</body></html>';

        // Use html2pdf.js if available, otherwise fall back to HTML download
        if (typeof html2pdf !== 'undefined') {
            // Parse the full HTML doc properly (innerHTML on a div strips <html>/<body> tags)
            var parsed = new DOMParser().parseFromString(exportHtml, 'text/html');
            var wrapper = document.createElement('div');
            var styleEl = parsed.querySelector('style');
            if (styleEl) wrapper.appendChild(styleEl.cloneNode(true));
            wrapper.innerHTML += parsed.body.innerHTML;

            html2pdf().set({
                margin: [10, 10, 15, 10],
                filename: docName.replace(/[^a-z0-9]/gi, '_') + '_FlipSide.pdf',
                image: { type: 'jpeg', quality: 0.95 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
                pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
            }).from(wrapper).save().then(function() {
                btn.textContent = origText;
                btn.classList.remove('generating');
            }).catch(function() {
                btn.textContent = origText;
                btn.classList.remove('generating');
            });
        } else {
            // Fallback: HTML download
            var blob = new Blob([exportHtml], { type: 'text/html' });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = docName.replace(/[^a-z0-9]/gi, '_') + '_FlipSide.html';
            a.click();
            URL.revokeObjectURL(url);
            btn.textContent = origText;
            btn.classList.remove('generating');
        }
    });

    // ── All flags via mail ─────────────────────────────────────────
    on('emailLawyerBtn', 'click', function() {
        var docName = 'FlipSide Analysis';
        var meta = metadataLine.textContent;
        if (meta) docName = meta.split('Type:')[1] ? meta.split('Type:')[1].split('Drafted')[0].trim() : docName;

        // Extract verdict tier from Opus output
        var verdictText = (opusSections.overall && opusSections.overall.text) || '';
        var tierMatch = verdictText.match(/\[VERDICT_TIER\]([\s\S]*?)\[\/VERDICT_TIER\]/);
        var verdictTier = tierMatch ? tierMatch[1].trim() : 'Analysis Complete';

        // Extract flagged claims from cards
        var clauses = extractClausesFromResponse();
        var flagged = clauses.filter(function(c) { return c.level === 'red' || c.level === 'yellow'; });

        // Use FLAGGED_CLAIMS from verdict if available (richer context)
        var claimsMatch = verdictText.match(/\[FLAGGED_CLAIMS\]([\s\S]*?)\[\/FLAGGED_CLAIMS\]/);
        var claimsList = [];
        if (claimsMatch) {
            claimsList = claimsMatch[1].trim().split('\n')
                .filter(function(l) { return l.trim() && !/no clauses were flagged/i.test(l); })
                .map(function(l) { return l.replace(/^[-•*\d]+[.)]\s*/, '').trim(); })
                .filter(function(l) { return l; });
        }
        // Fallback: build from card data
        if (!claimsList.length && flagged.length) {
            flagged.forEach(function(c) {
                claimsList.push(c.title + (c.section ? ' (' + c.section + ')' : '') +
                    ' [' + c.level.toUpperCase() + '] Score: ' + c.score + '/100' +
                    (c.trick ? ' — ' + c.trick : ''));
            });
        }

        var subject = 'FlipSide Analysis — ' + docName + ' (' + verdictTier + ')';
        var body = 'Hi,\n\n' +
            'I ran an AI analysis on a document I received and wanted to share the key findings with you.\n\n' +
            'Document: ' + docName + '\n' +
            'Verdict: ' + verdictTier + '\n' +
            'Flagged clauses: ' + flagged.length + '\n\n';
        if (claimsList.length) {
            body += 'Flagged clauses:\n';
            claimsList.forEach(function(c, i) { body += (i + 1) + '. ' + c + '\n'; });
            body += '\n';
        }
        body += 'I have the full analysis saved as an HTML report (use "Save Report" in FlipSide to download).\n\n' +
            'Could you review this and let me know which clauses I should push back on?\n\n' +
            'Generated by FlipSide — The dark side of very small print.\n' +
            'Powered by Claude Opus 4.6 extended thinking.';

        window.location.href = 'mailto:?subject=' + encodeURIComponent(subject) + '&body=' + encodeURIComponent(body);
    });

    // ── Download report in document language ────────────────────
    on('exportLangBtn', 'click', function() {
        var btn = this;
        if (btn.classList.contains('generating')) return;
        btn.classList.add('generating');
        var origText = btn.textContent;
        btn.textContent = 'Translating...';

        // Build the full English report text
        var reportParts = [];
        // Summary from cards
        var clauses = extractClausesFromResponse();
        clauses.forEach(function(c) {
            reportParts.push('### ' + c.title + (c.section ? ' (' + c.section + ')' : ''));
            if (c.figure) reportParts.push(c.figure);
            if (c.bottomLine) reportParts.push('**Bottom line:** ' + c.bottomLine);
            if (c.shouldRead) reportParts.push('**What you should read:** ' + c.shouldRead);
            if (c.quote) reportParts.push('> ' + c.quote);
            reportParts.push('');
        });
        // Opus verdict sections
        var deepText = assembleDeepText();
        if (deepText) reportParts.push(deepText);

        var fullReport = reportParts.join('\n');

        var prompt = 'Translate this ENTIRE analysis report into ' + detectedDocLanguage + '. ' +
            'Keep all formatting (markdown headers, bold, bullet points). ' +
            'Keep quoted document text in the original ' + detectedDocLanguage + ' — do NOT back-translate quotes. ' +
            'Translate all analysis, explanations, labels, and headings into ' + detectedDocLanguage + '.\n\n' +
            '---\n\n' + fullReport;

        var url = BASE_URL + '/ask/' + currentDocId;
        var translatedText = '';

        fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ question: prompt })
        }).then(function(resp) {
            if (!resp.ok) throw new Error('Translation request failed');
            var reader = resp.body.getReader();
            var decoder = new TextDecoder();
            var buffer = '';

            function readChunk() {
                return reader.read().then(function(result) {
                    if (result.done) {
                        // Download as HTML
                        var docName = 'FlipSide Analysis';
                        var meta = metadataLine.textContent;
                        if (meta) docName = meta.split('Type:')[1] ? meta.split('Type:')[1].split('Drafted')[0].trim() : docName;

                        var exportHtml = '<!DOCTYPE html><html><head><meta charset="UTF-8">' +
                            '<title>' + escapeHtml(docName) + ' — FlipSide (' + detectedDocLanguage + ')</title>' +
                            '<style>body{font-family:system-ui,sans-serif;max-width:800px;margin:2rem auto;padding:0 1rem;color:#1a1a18;line-height:1.6}' +
                            'h1{font-size:1.5rem;border-bottom:2px solid #c44b28;padding-bottom:0.5rem}' +
                            'h2{margin-top:2rem;color:#3d3b36}h3{margin-top:1.5rem}' +
                            'blockquote{border-left:3px solid #c44b28;padding:0.5rem 1rem;margin:0.5rem 0;background:#faf8f4;font-style:italic}' +
                            'hr{border:none;border-top:1px solid #e2ddd4;margin:1.5rem 0}' +
                            '.footer{margin-top:3rem;padding-top:1rem;border-top:1px solid #e2ddd4;font-size:0.8rem;color:#9c9789}' +
                            '</style></head><body>' +
                            '<h1>' + escapeHtml(docName) + '</h1>' +
                            safeMd2Html(translatedText) +
                            '<div class="footer">Generated by FlipSide — The dark side of very small print.<br>Powered by Claude Opus 4.6.</div>' +
                            '</body></html>';
                        var blob = new Blob([exportHtml], { type: 'text/html' });
                        var blobUrl = URL.createObjectURL(blob);
                        var a = document.createElement('a');
                        a.href = blobUrl;
                        a.download = docName.replace(/[^a-z0-9]/gi, '_') + '_' + detectedDocLanguage + '_FlipSide.html';
                        a.click();
                        URL.revokeObjectURL(blobUrl);
                        btn.classList.remove('generating');
                        btn.textContent = origText;
                        return;
                    }
                    buffer += decoder.decode(result.value, { stream: true });
                    var lines = buffer.split('\n');
                    buffer = lines.pop();
                    lines.forEach(function(line) {
                        if (line.startsWith('data: ')) {
                            try {
                                var evt = JSON.parse(line.substring(6));
                                if (evt.type === 'text' || evt.type === 'answer_text') {
                                    translatedText += evt.content;
                                }
                            } catch(e) {}
                        }
                    });
                    return readChunk();
                });
            }
            return readChunk();
        }).catch(function(err) {
            btn.classList.remove('generating');
            btn.textContent = origText;
            console.error('Translation failed:', err);
        });
    });

    // ── Dark mode ─────────────────────────────────────────────
    on('darkModeBtn', 'click', function() {
        document.body.classList.toggle('dark-mode');
        var isDark = document.body.classList.contains('dark-mode');
        this.innerHTML = isDark ? '&#9788;' : '&#9790;';
        this.title = isDark ? 'Switch to light mode' : 'Switch to dark mode';
        try { localStorage.setItem('flipside-dark', isDark ? '1' : '0'); } catch(e) {}
    });

    // Restore dark mode preference
    try {
        var savedDark = localStorage.getItem('flipside-dark');
        if (savedDark === '1') {
            document.body.classList.add('dark-mode');
            $('darkModeBtn').innerHTML = '&#9788;';
        } else if (savedDark === null && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            // Auto-detect system preference on first visit
            document.body.classList.add('dark-mode');
            $('darkModeBtn').innerHTML = '&#9788;';
        }
    } catch(e) {}

    // ── Follow-up questions ──────────────────────────────────
    function sendFollowup() {
        var question = followupInput.value.trim();
        if (!question || !currentDocId) return;

        // Immediate visual feedback
        followupInput.value = '';
        followupInput.style.height = 'auto';
        followupSend.disabled = true;
        followupSend.textContent = 'Thinking...';
        followupInput.disabled = true;
        followupInput.placeholder = 'Opus 4.6 is thinking...';

        var answerDiv = document.createElement('div');
        answerDiv.className = 'followup-answer';
        answerDiv.innerHTML = '<div class="followup-q">' + escapeHtml(question) + '</div>' +
            '<div class="followup-a" style="color:var(--text-muted)">' +
            '<span class="pulsing-dots" style="display:inline-flex;vertical-align:middle;margin-right:0.4rem"><span></span><span></span><span></span></span>' +
            'Opus 4.6 is reasoning about your question...</div>';
        followupAnswers.appendChild(answerDiv);
        var answerContent = answerDiv.querySelector('.followup-a');

        setTimeout(function() { answerDiv.scrollIntoView({ behavior: 'smooth', block: 'start' }); }, 50);

        var responseText = '';
        fetch(BASE_URL + '/ask/' + currentDocId, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ question: question }),
        }).then(function(response) {
            if (!response.ok) return response.json().then(function(err) { throw new Error(err.error || 'Request failed'); });
            var reader = response.body.getReader();
            var decoder = new TextDecoder();
            var buffer = '';
            var thinkingDone = false;

            function processChunk(result) {
                if (result.done) { resetFollowupUI(); return; }
                buffer += decoder.decode(result.value, { stream: true });
                var lines = buffer.split('\n');
                buffer = lines.pop();
                for (var i = 0; i < lines.length; i++) {
                    var line = lines[i].trim();
                    if (!line.startsWith('data: ')) continue;
                    var msg;
                    try { msg = JSON.parse(line.substring(6)); } catch(e) { continue; }
                    if (msg.type === 'text') {
                        if (!thinkingDone) { thinkingDone = true; answerContent.innerHTML = ''; }
                        responseText += msg.content;
                        answerContent.innerHTML = safeMd2Html(responseText);
                    } else if (msg.type === 'done') {
                        if (responseText) answerContent.innerHTML = safeMd2Html(responseText);
                        resetFollowupUI();
                        return;
                    } else if (msg.type === 'error') {
                        answerContent.innerHTML = '<span style="color:var(--red)">' + escapeHtml(msg.content) + '</span>';
                        resetFollowupUI();
                        return;
                    }
                }
                return reader.read().then(processChunk);
            }
            return reader.read().then(processChunk);
        }).catch(function(err) {
            answerContent.innerHTML = '<span style="color:var(--red)">' + escapeHtml(err.message) + '</span>';
            resetFollowupUI();
        });
    }

    function resetFollowupUI() {
        followupSend.disabled = false;
        followupSend.textContent = 'Ask';
        followupInput.disabled = false;
        followupInput.placeholder = 'Ask another question...';
        followupInput.focus();
    }

    followupSend.addEventListener('click', sendFollowup);
    followupInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendFollowup(); }
    });
    followupInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    });

    // ── Worst-Case Timeline ──────────────────────────────────
    timelineBtn.addEventListener('click', function() {
        if (!currentDocId || timelineBtn.disabled) return;
        timelineBtn.disabled = true;
        timelineBtn.textContent = 'Building timeline…';
        timelineContent.innerHTML = '<div style="text-align:center;padding:2rem;color:var(--text-muted)">' +
            '<div class="pulsing-dots"><span></span><span></span><span></span></div>' +
            '<div style="margin-top:0.8rem;font-size:0.85rem">Our expert is simulating what could go wrong — about 30 seconds</div></div>';

        var responseText = '';
        fetch(BASE_URL + '/timeline/' + currentDocId, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text: documentFullText })
        }).then(function(response) {
            if (!response.ok) return response.json().then(function(err) { throw new Error(err.error || 'Request failed'); });
            var reader = response.body.getReader();
            var decoder = new TextDecoder();
            var buffer = '';
            var thinkingDone = false;

            function processChunk(result) {
                if (result.done) { timelineBtn.textContent = 'Timeline generated'; return; }
                buffer += decoder.decode(result.value, { stream: true });
                var lines = buffer.split('\n');
                buffer = lines.pop();
                for (var i = 0; i < lines.length; i++) {
                    var line = lines[i].trim();
                    if (!line.startsWith('data: ')) continue;
                    var msg;
                    try { msg = JSON.parse(line.substring(6)); } catch(e) { continue; }
                    if (msg.type === 'text') {
                        if (!thinkingDone) { thinkingDone = true; timelineContent.innerHTML = ''; }
                        responseText += msg.content;
                        timelineContent.innerHTML = '<div class="counter-draft-content">' + safeMd2Html(responseText) + '</div>';
                    } else if (msg.type === 'done') {
                        if (responseText) timelineContent.innerHTML = '<div class="counter-draft-content">' + safeMd2Html(responseText) + '</div>';
                        timelineBtn.textContent = 'Timeline generated';
                        return;
                    } else if (msg.type === 'error') {
                        timelineContent.innerHTML = '<span style="color:var(--red)">' + escapeHtml(msg.content) + '</span>';
                        timelineBtn.textContent = 'Worst-Case Timeline';
                        timelineBtn.disabled = false;
                        return;
                    }
                }
                return reader.read().then(processChunk);
            }
            return reader.read().then(processChunk);
        }).catch(function(err) {
            timelineContent.innerHTML = '<span style="color:var(--red)">' + escapeHtml(err.message) + '</span>';
            timelineBtn.textContent = 'Worst-Case Timeline';
            timelineBtn.disabled = false;
        });
    });

    // ── Counter-Draft ─────────────────────────────────────────
    counterDraftBtn.addEventListener('click', function() {
        if (!currentDocId || counterDraftBtn.disabled) return;
        counterDraftBtn.disabled = true;
        counterDraftBtn.textContent = 'Generating counter-draft…';
        counterDraftContent.innerHTML = '<div style="text-align:center;padding:2rem;color:var(--text-muted)">' +
            '<div class="pulsing-dots"><span></span><span></span><span></span></div>' +
            '<div style="margin-top:0.8rem;font-size:0.85rem">Our expert is drafting fair alternatives — about 30 seconds</div></div>';

        var responseText = '';
        fetch(BASE_URL + '/counter-draft/' + currentDocId, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text: documentFullText })
        }).then(function(response) {
            if (!response.ok) return response.json().then(function(err) { throw new Error(err.error || 'Request failed'); });
            var reader = response.body.getReader();
            var decoder = new TextDecoder();
            var buffer = '';
            var thinkingDone = false;

            function processChunk(result) {
                if (result.done) { finishCounterDraft(); return; }
                buffer += decoder.decode(result.value, { stream: true });
                var lines = buffer.split('\n');
                buffer = lines.pop();
                for (var i = 0; i < lines.length; i++) {
                    var line = lines[i].trim();
                    if (!line.startsWith('data: ')) continue;
                    var msg;
                    try { msg = JSON.parse(line.substring(6)); } catch(e) { continue; }
                    if (msg.type === 'text') {
                        if (!thinkingDone) { thinkingDone = true; counterDraftContent.innerHTML = ''; }
                        responseText += msg.content;
                        counterDraftContent.innerHTML = '<div class="counter-draft-content">' + safeMd2Html(responseText) + '</div>';
                    } else if (msg.type === 'done') {
                        if (responseText) counterDraftContent.innerHTML = '<div class="counter-draft-content">' + safeMd2Html(responseText) + '</div>';
                        finishCounterDraft();
                        return;
                    } else if (msg.type === 'error') {
                        counterDraftContent.innerHTML = '<span style="color:var(--red)">' + escapeHtml(msg.content) + '</span>';
                        finishCounterDraft();
                        return;
                    }
                }
                return reader.read().then(processChunk);
            }
            return reader.read().then(processChunk);
        }).catch(function(err) {
            counterDraftContent.innerHTML = '<span style="color:var(--red)">' + escapeHtml(err.message) + '</span>';
            finishCounterDraft();
        });

        function finishCounterDraft() {
            counterDraftBtn.textContent = 'Counter-draft generated';
        }
    });

    // ── FAQ Navigation ─────────────────────────────────────
    var uploadNav = $('uploadNav');
    var uploadMain = $('uploadMain');
    var faqWrapper = $('faqWrapper');
    if (uploadNav) {
        uploadNav.addEventListener('click', function(e) {
            var link = e.target.closest('a');
            if (!link) return;
            e.preventDefault();
            var href = link.getAttribute('href');
            if (href === '#' && link.dataset.nav === 'top') {
                // Scroll to top / hide FAQ
                faqWrapper.classList.add('hidden');
                uploadMain.classList.remove('has-faq');
                uploadNav.querySelectorAll('a').forEach(function(a) { a.classList.remove('active'); });
                link.classList.add('active');
                uploadMain.scrollTo({ top: 0, behavior: 'smooth' });
                return;
            }
            // Show FAQ and scroll to section
            faqWrapper.classList.remove('hidden');
            uploadMain.classList.add('has-faq');
            uploadNav.querySelectorAll('a').forEach(function(a) { a.classList.remove('active'); });
            link.classList.add('active');
            var target = document.querySelector(href);
            if (target) {
                setTimeout(function() {
                    target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 50);
            }
        });

        // Highlight active nav link on scroll
        var faqSections = document.querySelectorAll('.faq-section[id]');
        var navLinks = uploadNav.querySelectorAll('a[href^="#faq-"]');
        if (faqSections.length && navLinks.length) {
            var onScroll = function() {
                if (faqWrapper.classList.contains('hidden')) return;
                var current = '';
                faqSections.forEach(function(section) {
                    var rect = section.getBoundingClientRect();
                    if (rect.top < 200) current = section.id;
                });
                if (current) {
                    navLinks.forEach(function(a) {
                        a.classList.toggle('active', a.getAttribute('href') === '#' + current);
                    });
                }
            };
            window.addEventListener('scroll', onScroll, { passive: true });
        }
    }


    // FAQ back button — returns to analysis if that's where user came from
    // _faqCameFromAnalysis declared at window scope for cross-IIFE access
    var faqBackBtn = $('faqBack');
    if (faqBackBtn) {
        faqBackBtn.addEventListener('click', function() {
            faqWrapper.classList.add('hidden');
            uploadMain.classList.remove('has-faq');
            if (_faqCameFromAnalysis) {
                _faqCameFromAnalysis = false;
                var us = $('upload-screen');
                var as = $('analysis-screen');
                if (us) us.classList.add('hidden');
                if (as) as.classList.remove('hidden');
            } else {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        });
    }

})();
</script>
</body>
</html>
