<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlipSide — The Other Side of Small Print</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;0,9..40,800;1,9..40,400&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked@15.0.7/marked.min.js" integrity="sha256-k04+Nuni2gr7Gm51B1uw8JrwUpOoROhKdHfvQJEcNJo=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.2.5/dist/purify.min.js" integrity="sha256-SCmGefnjCPBf3NW3QhwV/PtUWEWjqZu68xAziQYQ6ws=" crossorigin="anonymous"></script>
    <style>
        /* ══════════════════════════════════════════════════════
           RESET & DESIGN SYSTEM
           ══════════════════════════════════════════════════════ */
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0; }
        .hidden { display: none !important; }

        /* ── Screen transition: upload exit ── */
        @keyframes screenFadeOut {
            to { opacity: 0; transform: translateY(-24px) scale(0.97); }
        }
        #upload-screen.exiting {
            animation: screenFadeOut 0.35s cubic-bezier(0.22, 1, 0.36, 1) forwards;
            pointer-events: none;
        }

        :root {
            --bg-cream: #f7f5f0;
            --bg-warm: #f0ede6;
            --bg-card: #ffffff;
            --bg-surface: #faf8f4;
            --bg-thinking: #1e1d1a;
            --border: #e2ddd4;
            --border-light: #ece8e0;
            --border-focus: #c44b28;
            --text-primary: #1a1a18;
            --text-body: #3d3b36;
            --text-secondary: #6b6860;
            --text-muted: #9c9789;
            --text-dim: #bfb9ad;
            --accent: #c44b28;
            --accent-hover: #a83d20;
            --accent-light: rgba(196, 75, 40, 0.08);
            --accent-medium: rgba(196, 75, 40, 0.15);
            --green: #2d8a4e;
            --green-bg: rgba(45, 138, 78, 0.07);
            --green-border: rgba(45, 138, 78, 0.22);
            --green-text: #1e6b38;
            --yellow: #b8860b;
            --yellow-bg: rgba(184, 134, 11, 0.07);
            --yellow-border: rgba(184, 134, 11, 0.22);
            --yellow-text: #8a6508;
            --red: #c44b28;
            --red-bg: rgba(196, 75, 40, 0.07);
            --red-border: rgba(196, 75, 40, 0.22);
            --red-text: #a83d20;
            --radius: 12px;
            --radius-md: 8px;
            --radius-sm: 6px;
            --transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.04), 0 1px 2px rgba(0,0,0,0.03);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.06);
            --shadow-lg: 0 8px 32px rgba(0,0,0,0.08);
            --col-width: 720px;
            --ease-out-expo: cubic-bezier(0.22, 1, 0.36, 1);
            --ink: #1a1a18;
            --cream: #f7f5f0;
            --smoke: #6b6860;
            --ash: #9c9789;
        }

        /* ── Dark mode ──────────────────────────────── */
        @media (prefers-color-scheme: dark) {
            :root:not(.light-override) {
                --bg-cream: #1a1917;
                --bg-warm: #222120;
                --bg-card: #2a2927;
                --bg-surface: #252422;
                --bg-thinking: #131210;
                --border: #3d3a35;
                --border-light: #333128;
                --text-primary: #e8e4dc;
                --text-body: #c8c3b8;
                --text-secondary: #a09a8e;
                --text-muted: #78736a;
                --text-dim: #585450;
                --shadow-sm: 0 1px 3px rgba(0,0,0,0.2);
                --shadow-md: 0 4px 12px rgba(0,0,0,0.3);
                --shadow-lg: 0 8px 32px rgba(0,0,0,0.4);
            }
        }
        .dark-mode {
            --bg-cream: #1a1917;
            --bg-warm: #222120;
            --bg-card: #2a2927;
            --bg-surface: #252422;
            --bg-thinking: #131210;
            --border: #3d3a35;
            --border-light: #333128;
            --text-primary: #e8e4dc;
            --text-body: #c8c3b8;
            --text-secondary: #a09a8e;
            --text-muted: #78736a;
            --text-dim: #585450;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.2);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.3);
            --shadow-lg: 0 8px 32px rgba(0,0,0,0.4);
        }

        body {
            font-family: 'DM Sans', system-ui, -apple-system, sans-serif;
            background: var(--bg-cream);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* ── Grain overlay ──────────────────────────── */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            z-index: 9999;
            pointer-events: none;
            opacity: 0.025;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
            background-repeat: repeat;
            background-size: 256px 256px;
        }
        @media print { body::before { display: none; } }

        ::selection { background: rgba(196, 75, 40, 0.25); }

        /* ══════════════════════════════════════════════════════
           ANIMATIONS
           ══════════════════════════════════════════════════════ */
        .fade-up {
            opacity: 0; transform: translateY(16px);
            animation: fadeUp 0.7s cubic-bezier(0.22, 1, 0.36, 1) forwards;
        }
        @keyframes fadeUp { to { opacity: 1; transform: translateY(0); } }
        .fade-up-d1 { animation-delay: 0.1s; }
        .fade-up-d2 { animation-delay: 0.2s; }
        .fade-up-d3 { animation-delay: 0.3s; }

        @keyframes clauseDropIn {
            0% { transform: translateY(20px); opacity: 0; }
            70% { transform: translateY(-3px); }
            100% { transform: translateY(0); opacity: 1; }
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }
        @keyframes scoreBarFill {
            from { width: 0; }
        }

        /* ══════════════════════════════════════════════════════
           SCREEN 1: UPLOAD
           ══════════════════════════════════════════════════════ */
        #upload-screen {
            min-height: 100vh;
            display: flex;
            padding: 0;
        }
        .upload-nav {
            width: 200px; flex-shrink: 0;
            padding: 2.5rem 1.2rem 2rem 1.5rem;
            position: sticky; top: 0; height: 100vh; overflow-y: auto;
            border-right: 1px solid var(--border-light);
            display: flex; flex-direction: column; gap: 0.15rem;
        }
        .upload-nav-brand {
            font-size: 1.1rem; font-weight: 800; letter-spacing: -0.04em;
            color: var(--text-primary); margin-bottom: 1.5rem; cursor: default;
        }
        .upload-nav-label {
            font-size: 0.62rem; font-weight: 600; letter-spacing: 0.1em;
            text-transform: uppercase; color: var(--text-dim);
            margin-top: 1rem; margin-bottom: 0.3rem;
            font-family: 'JetBrains Mono', monospace;
        }
        .upload-nav a {
            font-size: 0.78rem; color: var(--text-secondary); text-decoration: none;
            padding: 0.25rem 0.5rem; border-radius: var(--radius-sm);
            transition: all 0.2s ease; display: block; line-height: 1.35;
        }
        .upload-nav a:hover { color: var(--accent); background: var(--accent-light); }
        .upload-nav a.active { color: var(--accent); font-weight: 600; background: var(--accent-light); }
        .upload-nav a.nav-fair-clause {
            margin-top: 0.5rem; padding-top: 0.5rem;
            border-top: 1px solid var(--border-light);
            font-weight: 600; color: var(--text-primary);
        }
        .upload-nav a.nav-fair-clause:hover { color: var(--accent); }
        .upload-main {
            flex: 1;
            display: flex; flex-direction: column; align-items: center;
            justify-content: center; padding: 2rem;
            min-height: 100vh;
        }
        .upload-main.has-faq {
            justify-content: flex-start; padding-top: 3rem;
        }
        .upload-container { max-width: 560px; width: 100%; }

        /* ── FAQ Sections ─────────────────────────── */
        .faq-wrapper {
            max-width: 560px; width: 100%; margin-top: 3rem;
            padding-bottom: 4rem;
        }
        .faq-wrapper.hidden { display: none; }
        .faq-title {
            font-size: 1.8rem; font-weight: 800; letter-spacing: -0.03em;
            color: var(--text-primary); margin-bottom: 0.3rem;
        }
        .faq-subtitle {
            font-size: 0.88rem; color: var(--text-secondary);
            margin-bottom: 2rem; font-style: italic;
        }
        .faq-section {
            margin-bottom: 2rem;
            scroll-margin-top: 2rem;
        }
        .faq-section h3 {
            font-size: 1rem; font-weight: 700; color: var(--text-primary);
            margin-bottom: 0.5rem; letter-spacing: -0.01em;
        }
        .faq-section p, .faq-section li {
            font-size: 0.85rem; color: var(--text-body); line-height: 1.7;
            margin-bottom: 0.6rem;
        }
        .faq-section ul {
            padding-left: 1.2rem; margin-bottom: 0.8rem;
        }
        .faq-section li { margin-bottom: 0.3rem; }
        .faq-section strong { color: var(--text-primary); }
        .faq-section code {
            font-family: 'JetBrains Mono', monospace; font-size: 0.78rem;
            background: var(--bg-warm); padding: 0.1rem 0.35rem;
            border-radius: 3px; color: var(--accent);
        }
        .faq-divider {
            border: none; border-top: 1px solid var(--border-light);
            margin: 2rem 0;
        }

        /* ── Fair Clause ──────────────────────────── */
        .fair-clause-card {
            background: var(--bg-card); border: 2px solid var(--green-border);
            border-radius: var(--radius); padding: 1.8rem;
            box-shadow: var(--shadow-md);
            scroll-margin-top: 2rem;
        }
        .fair-clause-card h3 {
            font-size: 1.15rem; font-weight: 800; color: var(--green-text);
            margin-bottom: 0.2rem;
        }
        .fair-clause-badge {
            display: inline-block; font-size: 0.65rem; font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
            background: var(--green-bg); color: var(--green-text);
            border: 1px solid var(--green-border);
            padding: 0.15rem 0.5rem; border-radius: 100px;
            margin-bottom: 1rem; letter-spacing: 0.02em;
        }
        .fair-clause-intro {
            font-size: 0.85rem; color: var(--text-secondary);
            font-style: italic; margin-bottom: 1.2rem; line-height: 1.6;
        }
        .fair-clause-section {
            margin-bottom: 1rem;
        }
        .fair-clause-section h4 {
            font-size: 0.82rem; font-weight: 700; color: var(--text-primary);
            margin-bottom: 0.25rem;
        }
        .fair-clause-section p {
            font-size: 0.82rem; color: var(--text-body); line-height: 1.65;
            margin: 0;
        }
        .fair-clause-reasoning {
            margin-top: 0.3rem; font-size: 0.72rem; color: var(--green-text);
            font-style: italic; line-height: 1.5;
            padding-left: 0.8rem; border-left: 2px solid var(--green-border);
        }
        .fair-clause-score {
            margin-top: 1.5rem; padding-top: 1rem;
            border-top: 1px solid var(--green-border);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem; color: var(--green-text);
            display: flex; align-items: center; gap: 0.5rem;
        }
        .fair-clause-score-ring {
            width: 32px; height: 32px;
        }
        .fair-clause-footer {
            margin-top: 1rem; font-size: 0.7rem;
            color: var(--text-dim); font-style: italic; line-height: 1.5;
        }

        @media (max-width: 800px) {
            .upload-nav { display: none; }
            .upload-main { padding: 2rem 1rem; }
        }

        .brand { text-align: center; margin-bottom: 2.5rem; }
        .brand h1 {
            font-size: 3.2rem; font-weight: 800;
            letter-spacing: -0.04em; color: var(--text-primary); line-height: 1.1;
        }
        .brand .tagline {
            font-size: 1.05rem; color: var(--text-secondary);
            margin-top: 0.5rem; font-weight: 400; font-style: italic;
        }

        .upload-card {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius); padding: 2rem; box-shadow: var(--shadow-md);
        }

        .drop-zone {
            border: 2px dashed var(--border); border-radius: var(--radius-md);
            padding: 2.5rem 2rem; text-align: center; cursor: pointer;
            transition: all var(--transition); background: var(--bg-surface);
        }
        .drop-zone:hover, .drop-zone.dragover {
            border-color: var(--accent); background: var(--accent-light);
            transform: scale(1.01); box-shadow: 0 0 0 4px rgba(196, 75, 40, 0.1);
        }
        .drop-zone .icon {
            width: 44px; height: 44px; margin: 0 auto 0.6rem; display: block;
            color: var(--text-muted); opacity: 0.55;
            perspective: 600px;
        }
        .drop-zone .icon svg {
            width: 100%; height: 100%;
            animation: idle-flip 6s ease-in-out infinite;
            transform-style: preserve-3d;
        }
        @keyframes idle-flip {
            0%, 100% { transform: rotateY(0deg); }
            50% { transform: rotateY(180deg); }
        }
        .drop-zone .dz-title { font-size: 0.95rem; font-weight: 600; color: var(--text-primary); }
        .drop-zone .hint { font-size: 0.85rem; color: var(--text-muted); margin-top: 0.15rem; }
        .drop-zone .filetypes {
            font-size: 0.72rem; color: var(--text-dim); margin-top: 0.6rem;
            letter-spacing: 0.12em; text-transform: uppercase;
        }

        .file-selected {
            display: flex; align-items: center; justify-content: center;
            gap: 0.6rem; padding: 0.4rem 0; max-width: 100%; overflow: hidden;
        }
        .file-selected .file-name { font-weight: 600; font-size: 0.92rem; color: var(--text-primary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; min-width: 0; flex-shrink: 1; }
        .file-selected .file-size { font-size: 0.78rem; color: var(--text-muted); flex-shrink: 0; }
        .file-remove {
            color: var(--text-muted); font-size: 0.78rem; text-decoration: none;
            margin-left: 0.5rem; cursor: pointer; transition: color var(--transition); flex-shrink: 0;
        }
        .file-remove:hover { color: var(--red); }

        .paste-area {
            width: 100%; min-height: 120px; background: var(--bg-surface);
            border: 1px solid var(--border); border-radius: var(--radius-sm);
            color: var(--text-primary); font-family: 'JetBrains Mono', monospace;
            font-size: 0.82rem; padding: 1rem; resize: vertical; margin-top: 1rem;
            outline: none; transition: border-color var(--transition);
        }
        .paste-area:focus { border-color: var(--accent); }
        .paste-area::placeholder { color: var(--text-dim); }

        /* Depth selector */
        .depth-selector {
            display: flex; border-radius: var(--radius-sm);
            overflow: hidden; border: 1px solid var(--border); margin-top: 1.2rem;
        }
        .depth-btn {
            flex: 1; padding: 0.5rem 0.4rem; background: var(--bg-surface);
            color: var(--text-muted); border: none; font-family: inherit;
            font-size: 0.78rem; font-weight: 500; cursor: pointer;
            transition: all var(--transition); text-align: center;
        }
        .depth-btn + .depth-btn { border-left: 1px solid var(--border); }
        .depth-btn.active { background: var(--text-primary); color: var(--bg-cream); }
        .depth-btn:hover:not(.active) { background: var(--bg-warm); color: var(--text-secondary); }

        .analyze-btn {
            width: 100%; margin-top: 1.5rem; padding: 0.85rem; font-size: 0.95rem;
            font-weight: 600; font-family: inherit; background: var(--accent);
            color: white; border: none; border-radius: var(--radius-md); cursor: pointer;
            transition: all var(--transition); letter-spacing: -0.01em;
        }
        .analyze-btn:hover:not(:disabled) {
            background: var(--accent-hover); transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(196, 75, 40, 0.2);
        }
        .analyze-btn:disabled { opacity: 0.35; cursor: not-allowed; }

        .upload-links {
            text-align: center; margin-top: 1rem;
            display: flex; flex-wrap: wrap; justify-content: center; gap: 0.5rem 1.2rem;
            font-size: 0.82rem;
        }
        .upload-links a {
            color: var(--text-muted); text-decoration: none; cursor: pointer;
            border-bottom: 1px dotted var(--text-dim); transition: color var(--transition);
        }
        .upload-links a:hover { color: var(--accent); border-bottom-color: var(--accent); }
        /* Demo document grid */
        .demo-grid-title {
            font-size: 0.82rem; font-weight: 500; color: var(--text-muted);
            text-align: center; margin: 1.5rem 0 0.8rem;
            font-family: 'JetBrains Mono', monospace; letter-spacing: 0.04em;
            text-transform: uppercase;
        }
        .demo-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;
        }
        .demo-tile {
            background: var(--bg-surface); border: 1px solid var(--border);
            border-radius: var(--radius-sm); padding: 0.9rem 0.5rem 0.7rem;
            display: flex; flex-direction: column; align-items: center;
            text-align: center; cursor: pointer;
            transition: transform 0.25s var(--ease-out-expo), box-shadow 0.25s var(--ease-out-expo), border-color 0.25s ease;
        }
        .demo-tile:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(44, 40, 37, 0.08);
            border-color: var(--accent);
        }
        .demo-tile:hover .demo-tile-label { color: var(--accent); }
        .demo-tile:hover .demo-tile-icon { color: var(--accent); }
        .demo-tile-icon { width: 26px; height: 26px; margin-bottom: 0.5rem; color: var(--text-muted); transition: color 0.25s ease; }
        .demo-tile-icon svg { width: 100%; height: 100%; }
        .demo-tile-label {
            font-family: 'DM Sans', sans-serif; font-size: 0.88rem;
            font-weight: 600; color: var(--text-primary); margin-bottom: 0.15rem;
            line-height: 1.2; transition: color 0.25s ease;
        }
        .demo-tile-desc {
            font-size: 0.6rem; color: var(--text-muted); line-height: 1.3;
        }

        .upload-error {
            margin-top: 0.8rem; padding: 0.6rem 0.8rem; background: var(--red-bg);
            border: 1px solid var(--red-border); border-radius: var(--radius-sm);
            color: var(--red-text); font-size: 0.82rem;
        }

        /* Compare mode */
        .compare-row { display: flex; gap: 0.75rem; }
        .compare-col { flex: 1; }
        @media (max-width: 500px) { .compare-row { flex-direction: column; } }

        .disclaimer {
            text-align: center; margin-top: 1.25rem; font-size: 0.7rem;
            color: var(--text-dim); line-height: 1.7;
        }

        /* ══════════════════════════════════════════════════════
           SCREEN 2/3: ANALYSIS
           ══════════════════════════════════════════════════════ */
        #analysis-screen { min-height: 100vh; display: flex; flex-direction: column; }

        /* ── Sticky header ───────────────────────────── */
        .analysis-header {
            padding: 0.5rem 1.5rem; border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
            background: var(--bg-cream); position: sticky; top: 0; z-index: 100;
            gap: 0.75rem; flex-wrap: wrap;
        }
        .header-left { display: flex; align-items: center; gap: 0.75rem; min-width: 0; }
        .header-brand {
            font-size: 1rem; font-weight: 700; letter-spacing: -0.02em;
            white-space: nowrap; cursor: pointer;
        }
        .status-pill {
            display: inline-flex; align-items: center; gap: 0.4rem;
            font-size: 0.76rem; color: var(--text-secondary); background: var(--bg-card);
            padding: 0.2rem 0.65rem; border-radius: 20px; border: 1px solid var(--border);
            white-space: nowrap;
        }
        .status-dot {
            width: 6px; height: 6px; border-radius: 50%;
            background: var(--accent); animation: pulse 1.5s infinite; flex-shrink: 0;
        }
        .status-pill.done .status-dot { background: var(--green); animation: none; }
        .elapsed-time { font-variant-numeric: tabular-nums; }

        .header-right { display: flex; align-items: center; gap: 0.5rem; }
        .header-btn {
            background: none; border: 1px solid var(--border); color: var(--text-secondary);
            padding: 0.25rem 0.7rem; border-radius: var(--radius-sm); font-family: inherit;
            font-size: 0.76rem; cursor: pointer; transition: all var(--transition);
            white-space: nowrap;
        }
        .header-btn.home-btn {
            display: inline-flex; align-items: center; justify-content: center;
            padding: 0.3rem; border-radius: 50%; min-width: unset;
        }
        .header-btn.home-btn svg { display: block; }
        /* Overflow menu button: hidden on desktop, shown at ≤ 900px via mobile block */
        .header-overflow-btn { display: none; }
        .header-overflow-menu { display: none; }
        /* Dot nav: hidden on desktop, shown at ≤ 900px via mobile block */
        .card-nav-dots { display: none; }
        .header-btn:hover {
            border-color: var(--text-secondary); color: var(--text-primary);
            background: var(--bg-warm);
        }
        .model-badge {
            display: inline-flex; align-items: center; gap: 0.3rem;
            font-family: 'JetBrains Mono', monospace; font-size: 0.6rem;
            color: var(--text-muted); letter-spacing: 0.05em;
            white-space: nowrap;
        }
        .model-badge::before {
            content: ''; width: 5px; height: 5px; border-radius: 50%;
            background: var(--accent); flex-shrink: 0;
        }
        /* ── Capability ticker ── */
        .capability-ticker {
            font-family: 'JetBrains Mono', monospace; font-size: 0.55rem;
            color: var(--text-dim); letter-spacing: 0.03em;
            white-space: nowrap; overflow: hidden;
            transition: opacity 0.4s ease;
        }
        .capability-ticker .cap-label {
            display: inline-block;
            text-transform: uppercase; letter-spacing: 0.08em;
            color: var(--accent); font-weight: 600; margin-right: 0.3rem;
        }
        .capability-ticker.fade-swap {
            opacity: 0;
        }
        .capability-stats {
            font-family: 'JetBrains Mono', monospace; font-size: 0.55rem;
            color: var(--text-muted); letter-spacing: 0.03em;
        }
        .capability-stats .stat-num {
            color: var(--accent); font-weight: 600;
        }

        /* ── Analysis three-column layout ────────────── */
        .analysis-layout {
            display: flex;
            padding: 1rem 1.5rem 0;
            align-items: flex-start;
            justify-content: center;
        }
        .analysis-sidebar {
            width: 0; opacity: 0; overflow: hidden;
            flex-shrink: 0;
            position: sticky;
            top: 70px;
            margin-right: 0;
            transition: width 0.65s var(--ease-out-expo), opacity 0.5s ease, margin-right 0.65s var(--ease-out-expo);
        }
        .analysis-layout.sidebar-visible .analysis-sidebar {
            width: 240px; opacity: 1; overflow: visible; margin-right: 1.5rem;
        }

        /* ── Sidebar profile: thumbnail banner + pills ─── */
        .sidebar-profile {
            display: none;  /* Doc info moved to verdict column */
        }
        .metadata-line {
            min-width: 0;
            display: flex; flex-direction: column; gap: 0.35rem;
            padding: 0.5rem 0 0;
            opacity: 0; transform: translateY(8px);
            transition: opacity 0.6s var(--ease-out-expo), transform 0.6s var(--ease-out-expo);
        }
        .metadata-line.visible {
            opacity: 1; transform: translateY(0);
        }
        .meta-pill {
            display: flex; flex-direction: column; gap: 0.05rem;
            padding: 0;
            font-size: 0.65rem; line-height: 1.35;
            color: var(--text-body);
            max-width: 100%;
        }
        .meta-pill .meta-pill-label {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.5rem; font-weight: 600;
            text-transform: uppercase; letter-spacing: 0.08em;
            color: var(--text-muted); white-space: nowrap;
        }
        .meta-pill .meta-pill-value {
            white-space: normal; word-break: break-word;
        }

        /* ── Content column (center) ──────────────── */
        .content-col {
            flex: 1;
            max-width: var(--col-width);
            padding: 0 0 4rem;
        }

        /* ── Verdict column (right side — live report progress) ── */
        .verdict-col {
            width: 0; opacity: 0; overflow: hidden;
            flex-shrink: 0;
            position: sticky;
            top: 70px;
            margin-left: 0;
            transition: width 0.65s var(--ease-out-expo), opacity 0.5s ease, margin-left 0.65s var(--ease-out-expo);
            max-height: calc(100vh - 90px);
            display: flex;
            flex-direction: column;
            background: var(--bg-card);
            border: 1px solid transparent;
            border-radius: var(--radius);
        }
        .verdict-col.visible {
            width: 300px; opacity: 1; overflow: hidden;
            margin-left: 1.5rem;
            border-color: var(--border);
            box-shadow: var(--shadow-md);
        }
        .verdict-col.collapsed .verdict-body {
            height: 0; padding: 0; overflow: hidden; flex: 0;
            transition: height 0.4s var(--ease-out-expo), padding 0.4s var(--ease-out-expo);
        }
        .verdict-col.collapsed .verdict-header {
            border-bottom: none;
        }
        .verdict-header {
            display: flex; align-items: center; gap: 0.5rem;
            padding: 0.55rem 0.85rem;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }
        .verdict-dot {
            width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0;
            transition: background 0.4s ease;
        }
        .verdict-col.standby .verdict-dot {
            background: #bbb;
            animation: verdictPulse 3s ease-in-out infinite;
        }
        .verdict-col.thinking .verdict-dot {
            background: #d4a036;
            animation: verdictPulse 2s ease-in-out infinite;
        }
        .verdict-col.writing .verdict-dot {
            background: #4caf50;
            animation: verdictPulse 1.5s ease-in-out infinite;
        }
        .verdict-col.ready .verdict-dot {
            background: #4caf50; animation: none;
        }
        @keyframes verdictPulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.4; transform: scale(0.7); }
        }
        .verdict-title {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.6rem; font-weight: 600;
            text-transform: uppercase; letter-spacing: 0.1em;
            color: var(--text-muted); flex: 1;
        }
        .verdict-expand-btn {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.55rem; color: var(--accent);
            background: none; border: 1px solid var(--accent);
            border-radius: var(--radius-sm);
            padding: 0.2rem 0.5rem; cursor: pointer;
            transition: all 0.2s ease; white-space: nowrap;
        }
        .verdict-expand-btn:hover {
            background: var(--accent); color: #fff;
        }
        .verdict-expand-btn.ready {
            animation: verdictFlip 3s ease-in-out infinite;
            background: var(--accent); color: #fff; border-color: var(--accent);
        }
        .verdict-expand-btn.ready:hover { animation: none; }
        @keyframes verdictFlip {
            0%, 100% { transform: perspective(200px) rotateY(0deg); }
            45% { transform: perspective(200px) rotateY(180deg); }
            55% { transform: perspective(200px) rotateY(180deg); }
            100% { transform: perspective(200px) rotateY(360deg); }
        }
        .verdict-expand-spin {
            display: inline-block; margin-left: 0.25rem;
        }
        .verdict-summary {
            display: none; padding: 0.5rem 0.6rem; margin: 0.4rem 0;
            font-size: 0.76rem; line-height: 1.45; color: var(--text);
            background: var(--card-bg); border-radius: 6px;
            border-left: 3px solid var(--accent);
        }
        .verdict-summary.visible { display: block; }
        .verdict-summary strong { color: var(--accent); font-weight: 600; }
        .verdict-summary .verdict-summary-score {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.82rem; font-weight: 700;
        }
        .verdict-summary-rights {
            margin-top: 0.35rem; font-size: 0.68rem;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-secondary); line-height: 1.4;
        }
        .verdict-summary-ratio {
            margin-top: 0.2rem; font-size: 0.7rem;
            font-weight: 600; color: var(--text);
            font-style: italic;
        }
        .verdict-body {
            flex: 1; overflow-y: auto; overflow-x: hidden;
            padding: 0.4rem 0.75rem 0.75rem; min-height: 0;
        }
        .verdict-doc-profile {
            margin: 0 -0.75rem; padding: 0.5rem 0.75rem 0.6rem;
            border-bottom: 1px solid var(--border-light);
        }
        .verdict-doc-thumb {
            width: 100%; height: 56px; border-radius: var(--radius-sm);
            overflow: hidden; margin-bottom: 0.5rem; line-height: 0;
        }
        .verdict-doc-thumb img {
            width: 100%; height: 56px; display: block;
            object-fit: cover; object-position: top center;
            background: #fff; opacity: 0.85;
        }
        .verdict-doc-icon {
            display: flex; align-items: center; gap: 0.5rem;
            margin-bottom: 0.4rem;
        }
        .verdict-doc-icon svg {
            width: 22px; height: 22px; color: var(--accent); flex-shrink: 0;
        }
        .verdict-doc-icon-label {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.62rem; font-weight: 600;
            text-transform: uppercase; letter-spacing: 0.06em;
            color: var(--text-secondary);
        }
        .verdict-doc-meta {
            display: flex; flex-direction: column; gap: 0.2rem;
        }
        .verdict-doc-meta .meta-pill {
            font-size: 0.6rem; line-height: 1.3;
        }
        .verdict-doc-meta .meta-pill-label {
            font-size: 0.47rem;
        }
        /* Standby state: waiting for deep analysis */
        .verdict-col.standby .verdict-body {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.62rem; line-height: 1.5;
            color: #bbb;
        }
        /* Thinking state: monospace, muted */
        .verdict-col.thinking .verdict-body {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.68rem; line-height: 1.6;
            color: #9a938b; white-space: pre-wrap; word-break: break-word;
        }
        /* Writing/ready state: body font, rendered markdown */
        .verdict-col.writing .verdict-body,
        .verdict-col.ready .verdict-body {
            font-family: 'DM Sans', sans-serif;
            font-size: 0.78rem; line-height: 1.55;
            color: var(--text-body);
        }
        /* Compact markdown inside verdict column */
        .verdict-body h2 { font-size: 0.88rem; margin: 1rem 0 0.4rem; font-weight: 700; }
        .verdict-body h3 { font-size: 0.82rem; margin: 0.75rem 0 0.3rem; font-weight: 600; }
        .verdict-body p { margin: 0.3rem 0; }
        .verdict-body ul, .verdict-body ol { padding-left: 1.2rem; margin: 0.3rem 0; }
        .verdict-body li { margin: 0.15rem 0; }
        .verdict-body blockquote {
            border-left: 2px solid var(--border); margin: 0.4rem 0;
            padding: 0.2rem 0.6rem; color: var(--text-secondary); font-size: 0.75rem;
        }
        /* Streaming cursor in verdict */
        .verdict-cursor {
            display: inline-block; width: 6px; height: 12px;
            background: var(--accent); margin-left: 2px;
            vertical-align: text-bottom;
            animation: blink 0.8s step-end infinite;
        }
        /* Opus status line */
        .verdict-status {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.62rem; color: var(--text-muted);
            padding: 0.4rem 0; margin-bottom: 0.3rem;
            text-transform: uppercase; letter-spacing: 0.05em;
        }
        .verdict-status.hidden { display: none; }
        .verdict-invitation {
            font-family: 'DM Sans', sans-serif;
            font-size: 0.82rem; color: var(--text-secondary);
            line-height: 1.5; padding: 0.6rem 0 0.8rem;
            border-bottom: 1px solid var(--border);
            margin-bottom: 0.6rem;
            transition: opacity 0.6s ease-out;
        }
        .verdict-invitation.hidden { display: none; }
        .verdict-invitation.fading { opacity: 0; }
        .verdict-time-pill {
            display: inline-block;
            background: var(--bg-warm); border: 1px solid var(--border);
            border-radius: 100px; padding: 0.1rem 0.5rem;
            font-size: 0.58rem; color: var(--text-secondary);
            margin-left: 0.3rem; vertical-align: middle;
        }
        /* Opus collapsible sections */
        .opus-section { border-bottom: 1px solid var(--border); }
        .opus-section:last-child { border-bottom: none; }
        .opus-section-header {
            display: flex; align-items: center; gap: 0.4rem;
            padding: 0.45rem 0; cursor: pointer;
            user-select: none;
            transition: opacity 0.3s ease;
        }
        .opus-section-header:hover { opacity: 0.8; }
        /* Locked state: pulsing sections not clickable */
        .opus-section.locked .opus-section-header {
            cursor: default; opacity: 0.45;
            pointer-events: none;
        }
        .opus-dot {
            width: 7px; height: 7px; border-radius: 50%;
            flex-shrink: 0; background: #bbb;
            transition: background 0.4s ease;
        }
        .opus-dot.pulsing {
            background: #d4a036;
            animation: verdictPulse 2s ease-in-out infinite;
        }
        .opus-dot.done {
            background: #4caf50; animation: none;
        }
        .opus-section-title {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.6rem; font-weight: 600;
            text-transform: uppercase; letter-spacing: 0.08em;
            color: var(--text-secondary);
        }
        .opus-section-body {
            overflow: hidden;
            transition: max-height 0.4s var(--ease-out-expo), padding 0.3s ease;
            font-family: 'DM Sans', sans-serif;
            font-size: 0.76rem; line-height: 1.5;
            color: var(--text-body);
        }
        .opus-section-body.collapsed {
            max-height: 0; padding: 0;
        }
        /* ── Focused reading mode ─────────────────────────────── */
        .verdict-focused-panel { display: none; }
        .verdict-focused-panel.active {
            display: flex; flex-direction: column; height: 100%;
        }
        .verdict-focused-nav {
            display: flex; align-items: center; justify-content: space-between;
            padding: 0.4rem 0; border-bottom: 1px solid var(--border);
            margin-bottom: 0.5rem; flex-shrink: 0;
        }
        .verdict-focused-nav-btn {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.55rem; color: var(--accent);
            background: none; border: none; cursor: pointer;
            padding: 0.2rem 0.3rem;
            transition: opacity 0.2s ease;
        }
        .verdict-focused-nav-btn:hover { opacity: 0.7; }
        .verdict-focused-nav-btn:disabled { opacity: 0.25; cursor: default; }
        .verdict-focused-counter {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.52rem; color: var(--text-muted);
            text-transform: uppercase; letter-spacing: 0.05em;
            text-align: center; flex: 1;
        }
        .verdict-focused-counter .ready-link {
            color: var(--accent); cursor: pointer;
            text-decoration: none; font-weight: 600;
        }
        .verdict-focused-counter .ready-link:hover { text-decoration: underline; }
        .verdict-focused-title {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.62rem; font-weight: 600;
            text-transform: uppercase; letter-spacing: 0.08em;
            color: var(--text-secondary);
            padding: 0.3rem 0; flex-shrink: 0;
        }
        .verdict-focused-content {
            flex: 1; overflow-y: auto;
            font-family: 'DM Sans', sans-serif;
            font-size: 0.78rem; line-height: 1.55;
            color: var(--text-body);
        }
        .verdict-focused-content h2 { font-size: 0.88rem; margin: 1rem 0 0.4rem; font-weight: 700; }
        .verdict-focused-content h3 { font-size: 0.82rem; margin: 0.75rem 0 0.3rem; font-weight: 600; }
        .verdict-focused-content p { margin: 0.3rem 0; }
        .verdict-focused-content ul, .verdict-focused-content ol { padding-left: 1.2rem; margin: 0.3rem 0; }
        .verdict-focused-content li { margin: 0.15rem 0; }
        .verdict-focused-content blockquote {
            border-left: 2px solid var(--border); margin: 0.4rem 0;
            padding: 0.2rem 0.6rem; color: var(--text-secondary); font-size: 0.75rem;
        }
        /* ── Live tricks detected panel ─────────────────────── */
        .verdict-tricks { padding: 0.6rem 0 0.5rem; border-bottom: 1px solid var(--border); margin-bottom: 0.3rem; }
        .verdict-tricks.hidden { display: none; }
        .verdict-tricks-title {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.62rem; text-transform: uppercase; letter-spacing: 0.08em;
            color: var(--text-muted); margin-bottom: 0.5rem;
        }
        .verdict-tricks-list { display: flex; flex-wrap: wrap; gap: 0.3rem; }
        .verdict-trick-item {
            display: inline-flex; align-items: center; gap: 0.35rem;
            padding: 0.3rem 0.6rem;
            background: var(--bg-warm); border: 1px solid var(--border);
            border-radius: 100px; cursor: default;
            transition: border-color 0.2s ease, background 0.2s ease;
            position: relative;
        }
        .verdict-trick-item:hover { border-color: var(--accent); background: #fff; }
        .verdict-trick-icon {
            width: 16px; height: 16px; color: var(--text-muted);
            flex-shrink: 0; display: inline-flex; vertical-align: -2px;
        }
        .verdict-trick-icon svg { width: 100%; height: 100%; }
        .verdict-trick-item:hover .verdict-trick-icon { color: var(--accent); }
        .verdict-trick-name {
            font-family: 'DM Sans', sans-serif;
            font-size: 0.76rem; font-weight: 500; color: var(--text-secondary);
            white-space: nowrap;
        }
        .verdict-trick-count {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.65rem; color: var(--text-muted); font-weight: 600;
        }
        .verdict-trick-tooltip {
            display: none; position: absolute; bottom: calc(100% + 8px); left: 0;
            background: var(--text-primary); color: #fff;
            font-family: 'DM Sans', sans-serif; font-size: 0.75rem; line-height: 1.4;
            padding: 0.4rem 0.7rem; border-radius: 6px;
            white-space: normal; width: max-content; max-width: 220px;
            pointer-events: none; z-index: 100;
        }
        .verdict-trick-tooltip::after {
            content: ''; position: absolute; top: 100%; left: 1rem;
            border: 5px solid transparent;
            border-top-color: var(--text-primary);
        }
        .verdict-trick-item:hover .verdict-trick-tooltip { display: block; }
        /* Smaller icons in compact contexts */
        .trick-label .verdict-trick-icon,
        .trick-footnote .verdict-trick-icon,
        .filter-chip .verdict-trick-icon { width: 12px; height: 12px; vertical-align: -1px; }
        .playbook-trick-name .verdict-trick-icon { width: 14px; height: 14px; vertical-align: -2px; }

        /* Hide section list when focused panel is active */
        .verdict-body.in-focus .opus-section,
        .verdict-body.in-focus .verdict-status,
        .verdict-body.in-focus .verdict-invitation,
        .verdict-body.in-focus .verdict-tricks { display: none;
        }
        .opus-section-body:not(.collapsed) {
            max-height: 2000px;
            padding: 0 0 0.5rem 0;
        }
        .opus-section-body h2 { font-size: 0.82rem; margin: 0.6rem 0 0.3rem; font-weight: 700; }
        .opus-section-body h3 { font-size: 0.78rem; margin: 0.5rem 0 0.2rem; font-weight: 600; }
        .opus-section-body p { margin: 0.25rem 0; }
        .opus-section-body ul, .opus-section-body ol { padding-left: 1.1rem; margin: 0.2rem 0; }
        .opus-section-body li { margin: 0.1rem 0; }
        .opus-section-body blockquote {
            border-left: 2px solid var(--border); margin: 0.3rem 0;
            padding: 0.15rem 0.5rem; color: var(--text-secondary); font-size: 0.72rem;
        }

        /* Dim sidebar + verdict when card is flipped — focus on the reveal */
        .layout-flipped .analysis-sidebar,
        .layout-flipped .verdict-col {
            opacity: 0.35;
            transition: opacity 0.5s var(--ease-out-expo);
        }
        .layout-flipped .analysis-sidebar:hover,
        .layout-flipped .verdict-col:hover {
            opacity: 1;
        }

        /* verdict-col mobile handling moved to unified mobile block below */

        /* ── Document thumbnail (upper-left of profile) */
        .doc-thumbnail {
            width: 100%; height: 80px;
            border-radius: var(--radius-sm);
            overflow: hidden;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
            line-height: 0;
        }
        .doc-thumbnail img {
            width: 100%; height: 80px;
            display: block;
            object-fit: cover;
            object-position: top center;
            background: #fff;
            opacity: 0.85;
            transition: opacity 0.3s;
        }
        .doc-thumbnail img:hover { opacity: 1; }

        /* ── Editorial loading state ────────────────── */
        .editorial-loading {
            margin: 0; padding: 0;
            width: 100%;
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius); box-shadow: var(--shadow-md);
            overflow: hidden;
            display: flex; flex-direction: column;
        }
        .editorial-loading.woosh-in-sidebar {
            animation: wooshInSidebar 0.9s var(--ease-out-expo) both;
        }
        @keyframes wooshInSidebar {
            0% { opacity: 0; transform: translateX(200px) scale(0.85); }
            30% { opacity: 0.6; }
            100% { opacity: 1; transform: translateX(0) scale(1); }
        }

        @media (max-width: 1200px) {
            .analysis-sidebar { width: 200px; }
        }
        @media (max-width: 900px) {
            .analysis-layout { flex-direction: column; padding: 0 1rem; gap: 1rem; justify-content: flex-start; }
            .analysis-sidebar,
            .analysis-layout.sidebar-visible .analysis-sidebar { width: 100%; position: static; opacity: 1; overflow: visible; margin-right: 0; }
        }
        .editorial-loading-label {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.55rem; font-weight: 600;
            text-transform: uppercase; letter-spacing: 0.15em;
            color: var(--text-muted);
            padding: 0.75rem 1rem 0.3rem;
        }
        .editorial-loading-text {
            font-size: 0.72rem; line-height: 1.6;
            color: var(--text-secondary);
            padding: 0 1rem;
            flex: 1; min-height: 0; overflow-y: auto;
            border-left: 2px solid var(--border);
            margin-left: 1rem; margin-right: 1rem;
            padding-left: 0.75rem;
            scroll-behavior: smooth;
        }
        .editorial-loading-text::-webkit-scrollbar { width: 3px; }
        .editorial-loading-text::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        .editorial-loading-text .doc-highlight {
            position: relative;
            border-radius: 2px;
            transition: background 0.4s var(--ease-out-expo);
        }
        .editorial-loading-text .doc-highlight-green { background: rgba(45, 138, 78, 0.06); }
        .editorial-loading-text .doc-highlight-yellow { background: rgba(184, 134, 11, 0.06); }
        .editorial-loading-text .doc-highlight-red { background: rgba(196, 75, 40, 0.06); }
        .editorial-loading-text .doc-highlight.active.doc-highlight-green { background: rgba(45, 138, 78, 0.15); }
        .editorial-loading-text .doc-highlight.active.doc-highlight-yellow { background: rgba(184, 134, 11, 0.15); }
        .editorial-loading-text .doc-highlight.active.doc-highlight-red { background: rgba(196, 75, 40, 0.18); }
        .doc-clause-marker {
            display: inline-block; font-family: 'JetBrains Mono', monospace;
            font-size: 0.55rem; font-weight: 700; line-height: 1;
            width: 15px; height: 15px; text-align: center; line-height: 15px;
            border-radius: 50%; margin-right: 3px;
            vertical-align: middle; color: #fff; cursor: pointer;
        }
        .doc-highlight { cursor: pointer; }
        .doc-clause-marker-green { background: var(--green); }
        .doc-clause-marker-yellow { background: var(--yellow); }
        .doc-clause-marker-red { background: var(--red); }
        .doc-highlight.whoosh-flash {
            animation: highlightFlash 1.2s ease-out;
        }
        @keyframes highlightFlash {
            0% { background: rgba(196, 75, 40, 0.55); box-shadow: 0 0 24px rgba(196, 75, 40, 0.45), inset 0 0 8px rgba(196, 75, 40, 0.2); }
            40% { background: rgba(196, 75, 40, 0.3); box-shadow: 0 0 12px rgba(196, 75, 40, 0.2); }
            100% { box-shadow: none; }
        }
        .clause-whoosh-ghost {
            position: fixed; z-index: 9999; pointer-events: none;
            display: flex; align-items: center; gap: 8px;
            padding: 8px 16px 8px 10px;
            border-radius: var(--radius-sm);
            font-family: 'DM Sans', sans-serif;
            font-size: 0.78rem; font-weight: 600;
            color: #fff; white-space: nowrap;
            max-width: 340px; overflow: hidden;
            will-change: transform, opacity;
            border: 1px solid rgba(255,255,255,0.25);
        }
        .clause-whoosh-ghost .ghost-num {
            display: inline-flex; align-items: center; justify-content: center;
            width: 22px; height: 22px; border-radius: 50%;
            background: rgba(255,255,255,0.3); font-size: 0.65rem;
            font-family: 'JetBrains Mono', monospace; font-weight: 700;
            flex-shrink: 0;
        }
        .clause-whoosh-ghost .ghost-text {
            overflow: hidden; text-overflow: ellipsis;
            font-weight: 500; font-style: italic; opacity: 0.95;
        }
        .clause-whoosh-ghost-green { background: var(--green); box-shadow: 0 6px 28px rgba(45, 138, 78, 0.5); }
        .clause-whoosh-ghost-yellow { background: var(--yellow); color: #1a1a1a; box-shadow: 0 6px 28px rgba(184, 134, 11, 0.5); }
        .clause-whoosh-ghost-yellow .ghost-num { background: rgba(0,0,0,0.15); }
        .clause-whoosh-ghost-red { background: var(--accent); box-shadow: 0 6px 28px rgba(196, 75, 40, 0.5); }
        .card-land-flash {
            animation: cardLandFlash 0.7s ease-out;
        }
        @keyframes cardLandFlash {
            0% { box-shadow: inset 0 0 0 2px var(--accent), 0 0 24px rgba(196, 75, 40, 0.3); }
            100% { box-shadow: none; }
        }
        .editorial-loading-indicator {
            display: flex; align-items: center; gap: 0.75rem;
            margin: 0 1.5rem; padding: 1rem 0 1.2rem;
            border-top: 1px solid transparent;
            border-image: linear-gradient(90deg, transparent, var(--border), transparent) 1;
        }
        .editorial-loading-status {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem; font-weight: 500;
            text-transform: uppercase; letter-spacing: 0.15em;
            color: var(--text-muted);
        }
        .pulsing-dots { display: inline-flex; gap: 3px; }
        .pulsing-dots span {
            width: 4px; height: 4px; border-radius: 50%;
            background: var(--accent); animation: pulse 1.5s infinite;
        }
        .pulsing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .pulsing-dots span:nth-child(3) { animation-delay: 0.4s; }

        .verdict-streaming {
            text-align: center;
            padding: 2rem 1rem 2.5rem;
            color: #9a938b;
        }
        .verdict-streaming-label {
            font-size: 0.82rem;
            margin-top: 0.75rem;
            font-family: 'JetBrains Mono', monospace;
            letter-spacing: 0.3px;
        }
        .pulsing-dot {
            display: inline-block; width: 6px; height: 6px;
            border-radius: 50%; background: var(--accent);
            margin-left: 0.4rem; animation: pulse 1.5s infinite;
            vertical-align: middle;
        }

        /* ── Deep analysis status ─────────────────── */
        .deep-status {
            display: flex; align-items: center; justify-content: center; gap: 0.6rem;
            padding: 0.6rem 1rem; margin-top: 0.5rem;
            font-family: 'JetBrains Mono', monospace; font-size: 0.65rem;
            text-transform: uppercase; letter-spacing: 0.1em;
            color: var(--text-muted);
        }

        /* ── Card viewport ──────────────────────────── */
        .card-viewport { margin: 0.5rem 0 1.5rem; }
        .card-navigation {
            display: flex; align-items: center; justify-content: center;
            gap: 1.5rem; padding: 0.75rem 0 0.5rem;
        }
        .card-nav-btn {
            display: inline-flex; align-items: center; gap: 0.35rem;
            background: none; border: 1px solid var(--border);
            padding: 0.55rem 1.2rem; border-radius: var(--radius-sm);
            font-family: inherit; font-size: 0.82rem; font-weight: 500;
            color: var(--text-secondary); cursor: pointer;
            transition: all var(--transition);
        }
        .card-nav-btn:hover:not(:disabled) {
            border-color: var(--text-muted); color: var(--text-primary);
            background: var(--bg-card);
        }
        .card-nav-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        .card-nav-counter {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.78rem; color: var(--text-muted); font-weight: 500;
            font-variant-numeric: tabular-nums;
        }
        .card-nav-counter strong { color: var(--text-primary); font-weight: 700; }

        /* ── Section label ──────────────────────────── */
        .section-label {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem; font-weight: 500;
            text-transform: uppercase; letter-spacing: 0.15em;
            color: var(--text-muted);
        }
        .editorial-divider {
            border: none; height: 1px;
            background: linear-gradient(90deg, transparent, var(--border), transparent);
            margin: 1.5rem 0;
        }


        /* ── Results area ────────────────────────────── */
        .results-area { margin-top: 1.5rem; }

        /* Summary card — shown after done */
        .summary-card {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius); padding: 1.5rem; margin-bottom: 1.5rem;
            box-shadow: var(--shadow-md); animation: fadeUp 0.5s ease forwards;
        }
        .summary-top { display: flex; flex-direction: column; gap: 0.75rem; }
        .verdict-tier {
            font-family: 'JetBrains Mono', monospace; font-size: 1.15rem; font-weight: 800;
            letter-spacing: 0.04em; text-transform: uppercase; padding: 0.6rem 1rem;
            border-left: 4px solid var(--border); background: var(--bg-warm);
            line-height: 1.3;
        }
        .verdict-tier[data-tier="sign"]      { border-left-color: var(--green); color: var(--green); }
        .verdict-tier[data-tier="read"]      { border-left-color: #b8960c; color: #8a7200; }
        .verdict-tier[data-tier="negotiate"] { border-left-color: var(--yellow); color: #9a6c00; }
        .verdict-tier[data-tier="legal"]     { border-left-color: var(--red); color: var(--red); }
        .verdict-tier[data-tier="dontsign"]  { border-left-color: #7a1a1a; color: #7a1a1a; background: #fdf0f0; }
        .clause-strip { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 0.5rem; }
        .clause-dot {
            width: 10px; height: 10px; border-radius: 50%; border: none; padding: 0;
            cursor: pointer; transition: transform 0.15s ease, box-shadow 0.15s ease;
            flex-shrink: 0;
        }
        .clause-dot:hover { transform: scale(1.5); box-shadow: 0 0 0 2px rgba(0,0,0,0.15); }
        .clause-dot.dot-red    { background: var(--red); }
        .clause-dot.dot-yellow { background: var(--yellow); }
        .clause-dot.dot-green  { background: var(--green); }
        .clause-strip-counts {
            font-size: 0.72rem; color: var(--text-secondary); margin-top: 0.25rem;
            font-family: 'JetBrains Mono', monospace;
        }
        .summary-meta { flex: 1; min-width: 0; }
        .summary-concerns {
            list-style: none; margin-top: 0.8rem; padding: 0;
            font-size: 0.82rem; color: var(--text-body);
        }
        .summary-concerns li {
            padding: 0.3rem 0; border-bottom: 1px solid var(--border-light);
        }
        .summary-concerns li:last-child { border-bottom: none; }

        /* ── Filter chips (removed) ──────────────────── */
        .filter-chips { display: none; }

        /* ── Clause cards ────────────────────────────── */
        .clause-card, .cross-clause-card, .playbook-card, .assessment-card {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius); padding: 1.25rem 1.5rem;
            margin-bottom: 1rem; box-shadow: var(--shadow-sm);
            position: relative; opacity: 1;
        }
        .clause-card.new-card, .cross-clause-card.new-card,
        .playbook-card.new-card, .assessment-card.new-card,
        .flip-card.new-card {
            animation: clauseDropIn 0.4s var(--ease-out-expo) forwards; opacity: 0;
        }
        .clause-card h3, .cross-clause-card h3, .playbook-card h3 {
            font-size: 0.95rem; font-weight: 700; margin-bottom: 0.6rem;
            color: var(--text-primary); line-height: 1.3;
        }
        .clause-card p, .cross-clause-card p, .playbook-card p, .assessment-card p {
            font-size: 0.88rem; color: var(--text-body); margin-bottom: 0.5rem;
        }
        .clause-card blockquote {
            border-left: 3px solid var(--accent); padding: 0.5rem 1rem;
            margin: 0.6rem 0; background: var(--accent-light);
            font-style: italic; font-size: 0.85rem; color: var(--text-body);
            border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
        }
        .clause-card hr { border: none; border-top: 1px solid var(--border-light); margin: 1rem 0; }

        /* Risk level card borders */
        .level-red { border-left: 3px solid var(--red); }
        .level-yellow { border-left: 3px solid var(--yellow); }
        .level-green { border-left: 3px solid var(--green); }

        /* Risk badges */
        .risk-badge {
            display: inline-block; padding: 2px 8px; border-radius: 4px;
            font-size: 0.7rem; font-weight: 700; letter-spacing: 0.04em;
            vertical-align: middle;
        }
        .risk-green { background: var(--green-bg); color: var(--green-text); border: 1px solid var(--green-border); }
        .risk-yellow { background: var(--yellow-bg); color: var(--yellow-text); border: 1px solid var(--yellow-border); }
        .risk-red { background: var(--red-bg); color: var(--red-text); border: 1px solid var(--red-border); }

        .risk-score {
            font-size: 0.78rem; color: var(--text-secondary); margin-left: 0.5rem;
            display: inline-flex; align-items: center; gap: 0.4rem;
        }
        .score-bar { display: inline-block; width: 60px; height: 4px; background: var(--border-light); border-radius: 2px; vertical-align: middle; }
        .score-fill { display: block; height: 100%; border-radius: 2px; transition: width 0.6s ease; }
        .trick-label {
            display: inline-block; margin-left: 0.5rem; padding: 1px 6px;
            background: var(--bg-warm); border: 1px solid var(--border);
            border-radius: var(--radius-sm); font-size: 0.72rem; color: var(--text-secondary);
        }

        /* "What the small print says" / "What you should read" juxtaposition */
        .clause-split-header {
            display: flex; gap: 1rem; margin-top: 0.8rem;
        }
        .clause-split-label {
            flex: 1; font-family: 'JetBrains Mono', monospace;
            font-size: 0.62rem; font-weight: 500; text-transform: uppercase;
            letter-spacing: 0.12em; padding-bottom: 0.3rem;
        }
        .clause-split-label-left { color: var(--text-muted); }
        .clause-split-label-right { color: var(--accent); }
        .clause-split {
            display: flex; gap: 1rem; margin-bottom: 0.8rem;
        }
        .clause-split > div {
            flex: 1; padding: 0.8rem; border-radius: var(--radius-sm);
            font-size: 0.85rem; line-height: 1.6;
        }
        .clause-split-left {
            background: var(--bg-surface); color: var(--text-body);
            border: 1px solid var(--border-light);
        }
        .clause-split-right {
            background: var(--accent-light); color: var(--text-primary);
            border: 1px solid var(--accent-medium);
            font-weight: 500;
        }
        @media (max-width: 600px) {
            .clause-split-header, .clause-split { flex-direction: column; gap: 0.25rem; }
        }

        /* Cross-clause cards */
        .cross-clause-card { border-left: 3px solid var(--accent); }
        .playbook-card { border-left: 3px solid var(--yellow); }
        .assessment-card {
            border-left: 3px solid var(--red);
            background: linear-gradient(135deg, var(--bg-card), rgba(196, 75, 40, 0.03));
        }
        .assessment-card h3 {
            font-size: 1rem;
        }

        /* ── Message the Company ────────────────────── */
        .message-company-section {
            margin: 1.2rem 0;
        }
        .message-company-btn {
            width: 100%; padding: 0.85rem 1.2rem;
            background: var(--bg-card); border: 1.5px solid var(--accent);
            border-radius: var(--radius); color: var(--accent);
            font-family: var(--font-mono); font-size: 0.78rem;
            letter-spacing: 0.04em; text-transform: uppercase;
            cursor: pointer; transition: all 0.2s ease;
            display: flex; align-items: center; justify-content: center; gap: 0.5rem;
        }
        .message-company-btn:hover {
            background: var(--accent); color: white;
        }
        .message-company-btn.generating {
            background: var(--bg-warm); border-color: var(--border);
            color: var(--text-secondary); cursor: wait;
        }
        .message-company-icon { font-size: 1rem; }
        .message-company-output {
            margin-top: 1rem; padding: 1.2rem 1.5rem;
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius); font-size: 0.88rem;
            line-height: 1.65; color: var(--text-primary);
            box-shadow: var(--shadow-sm);
        }
        .message-company-output p { margin: 0.6rem 0; }
        .message-actions {
            display: flex; gap: 0.6rem; margin-top: 1rem;
            padding-top: 0.8rem; border-top: 1px solid var(--border);
        }
        .message-action-btn {
            flex: 1; padding: 0.55rem 0.8rem;
            background: var(--bg-warm); border: 1px solid var(--border);
            border-radius: var(--radius-sm); color: var(--text-primary);
            font-family: var(--font-mono); font-size: 0.72rem;
            letter-spacing: 0.03em; text-transform: uppercase;
            cursor: pointer; transition: all 0.15s ease;
        }
        .message-action-btn:hover {
            background: var(--accent); color: white; border-color: var(--accent);
        }

        /* ── Flip cards (3D) ─────────────────────────── */
        @keyframes cardWoosh {
            0% { transform: translateY(80px) scale(0.96); opacity: 0; filter: blur(6px); }
            55% { transform: translateY(-6px) scale(1.005); opacity: 1; filter: blur(0); }
            75% { transform: translateY(2px) scale(0.999); }
            100% { transform: translateY(0) scale(1); }
        }
        .flip-card {
            perspective: 1200px;
            margin-bottom: 1.5rem;
        }
        /* Use visibility instead of display:none for 3D cards — prevents WebKit compositing layer loss */
        .flip-card.hidden {
            display: block !important;
            visibility: hidden;
            height: 0 !important;
            margin: 0 !important;
            padding: 0 !important;
            overflow: hidden;
        }
        .flip-card.woosh-in {
            animation: cardWoosh 0.65s cubic-bezier(0.22, 1, 0.36, 1) both;
        }
        .flip-card-inner {
            position: relative;
            transition: transform 0.7s var(--ease-out-expo);
            transform-style: preserve-3d;
        }
        .flip-card.flipped .flip-card-inner {
            transform: rotateY(180deg);
        }
        .flip-card-front, .flip-card-back {
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            border-radius: var(--radius);
        }
        .flip-card-front {
            background: var(--bg-card);
            border: 1px solid var(--border);
            box-shadow: var(--shadow-md);
            transition: opacity 0.25s ease-out;
        }
        .flip-card.flipped .flip-card-front {
            opacity: 0;
        }
        .flip-card-back {
            transform: rotateY(180deg);
            position: absolute;
            top: 0; left: 0; width: 100%;
            background: var(--bg-card);
            border: 1px solid var(--border);
            box-shadow: var(--shadow-md);
        }
        .flip-card.flipped .flip-card-front {
            visibility: hidden;
            position: absolute;
            top: 0; left: 0; width: 100%;
        }
        .flip-card.flipped .flip-card-back {
            position: relative;
        }

        /* Front content */
        .front-content { padding: 2rem 2rem 1.25rem; }
        .clause-reassurance {
            font-size: 1.3rem; font-weight: 700; color: var(--green-text);
            line-height: 1.25; margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-light);
        }
        .clause-section-ref {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem; font-weight: 500; color: var(--text-dim);
            text-transform: uppercase; letter-spacing: 0.15em; margin-bottom: 0.35rem;
        }
        .front-quote-pill {
            display: flex; align-items: center; gap: 8px;
            padding: 7px 12px; margin-bottom: 0.9rem;
            border-radius: var(--radius-sm);
            background: var(--bg-surface); border: 1px solid var(--border-light);
            font-size: 0.75rem; line-height: 1.45; color: var(--text-secondary);
            font-style: italic; overflow: hidden;
            opacity: 0; transform: scale(0.95);
            transition: opacity 0.35s ease-out, transform 0.35s ease-out;
        }
        .front-quote-pill.revealed {
            opacity: 1; transform: scale(1);
        }
        .front-quote-pill .pill-num {
            display: inline-flex; align-items: center; justify-content: center;
            width: 20px; height: 20px; min-width: 20px; border-radius: 50%;
            font-family: 'JetBrains Mono', monospace; font-size: 0.6rem; font-weight: 700;
            color: #fff; flex-shrink: 0;
        }
        .front-quote-pill .pill-num-green { background: var(--green); }
        .front-quote-pill .pill-num-yellow { background: var(--yellow); color: #1a1a1a; }
        .front-quote-pill .pill-num-red { background: var(--accent); }
        .front-quote-pill .pill-text {
            overflow: hidden; text-overflow: ellipsis;
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
        }
        .flip-card .clause-title {
            font-size: 1.15rem; font-weight: 700; color: var(--text-primary);
            line-height: 1.3; margin-bottom: 1rem;
        }
        .flip-card .clause-quote {
            position: relative; padding: 0.9rem 1.1rem; margin-bottom: 1.25rem;
            background: var(--bg-surface); border-radius: var(--radius-sm);
            border-left: 3px solid var(--border); font-size: 0.84rem;
            line-height: 1.65; color: var(--text-secondary); font-style: italic;
        }
        .back-quote-label {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.58rem; font-weight: 600;
            text-transform: uppercase; letter-spacing: 0.12em;
            color: var(--text-dim); margin-bottom: 0.3rem;
        }
        .find-in-doc {
            display: inline-block;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.6rem; font-weight: 500;
            text-transform: uppercase; letter-spacing: 0.1em;
            color: var(--text-dim); cursor: pointer;
            margin-bottom: 1rem; padding: 0.2rem 0;
            transition: color var(--transition);
            text-decoration: none;
        }
        .find-in-doc:hover { color: var(--accent); }
        .reader-voice {
            padding: 1rem 1.1rem; border-radius: var(--radius-sm);
            background: linear-gradient(135deg, rgba(45, 138, 78, 0.04), rgba(45, 138, 78, 0.08));
            border-left: 3px solid var(--green);
        }
        .reader-voice-label {
            display: block; font-family: 'DM Sans', sans-serif;
            font-size: 0.88rem; font-weight: 700;
            text-transform: uppercase; letter-spacing: 0.04em;
            color: var(--green-text); margin-bottom: 0.5rem;
        }
        .reader-voice-text {
            font-size: 0.95rem; line-height: 1.6; color: var(--text-body);
        }
        .reader-voice-en {
            font-size: 0.78rem; line-height: 1.5; color: var(--text-muted);
            font-style: italic; margin-top: 0.4rem;
            padding-top: 0.4rem; border-top: 1px dashed var(--border-light);
        }
        .reader-voice-en::before {
            content: 'EN'; display: inline-block;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.5rem; font-weight: 700; font-style: normal;
            text-transform: uppercase; letter-spacing: 0.08em;
            background: var(--bg-surface); border: 1px solid var(--border);
            border-radius: 3px; padding: 0.1rem 0.3rem;
            margin-right: 0.4rem; vertical-align: middle;
            color: var(--text-muted);
        }

        /* Skeleton card — loading placeholder */
        .skeleton-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 0;
            box-shadow: var(--shadow-md);
            transition: none;
        }
        .skeleton-card.fly-to-sidebar {
            animation: flyToSidebar 0.7s var(--ease-out-expo) both;
            pointer-events: none;
        }
        @keyframes flyToSidebar {
            0% { opacity: 1; transform: translateX(0) scale(1); }
            100% { opacity: 0; transform: translateX(-40%) scale(0.6); }
        }
        .skeleton-pulse {
            background: linear-gradient(90deg, var(--bg-surface) 25%, var(--border-light) 50%, var(--bg-surface) 75%);
            background-size: 200% 100%;
            animation: skeletonShimmer 1.8s ease-in-out infinite;
            border-radius: 6px;
        }
        @keyframes skeletonShimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        .skeleton-reassurance {
            height: 1.6rem; width: 75%; margin-bottom: 1rem;
        }
        .skeleton-section {
            height: 0.7rem; width: 40%; margin-bottom: 1.5rem;
        }
        .skeleton-reader {
            height: 0.85rem; width: 90%; margin-bottom: 0.6rem;
        }
        .skeleton-reader-short {
            height: 0.85rem; width: 60%; margin-bottom: 1.5rem;
        }
        .skeleton-waiting {
            display: flex; align-items: center; justify-content: center; gap: 0.6rem;
            padding: 0.9rem 2rem;
            border-top: 1px solid var(--border-light);
            font-family: 'JetBrains Mono', monospace; font-size: 0.75rem;
            font-weight: 500; color: var(--text-muted);
            letter-spacing: 0.02em;
        }
        .skeleton-pulses {
            padding: 2rem 2rem 0;
        }


        /* Flip trigger — quiet invitation */
        @keyframes flipHint {
            0%, 100% { transform: translateY(0); }
            20% { transform: translateY(-4px); }
            40% { transform: translateY(0); }
            60% { transform: translateY(-2px); }
            80% { transform: translateY(0); }
        }
        .flip-trigger {
            display: flex; align-items: center; justify-content: center; gap: 0.5rem;
            width: 100%; margin: 0; padding: 0.9rem 2rem;
            background: none; border: none; border-top: 1px solid var(--border-light);
            cursor: pointer; font-family: 'JetBrains Mono', monospace; font-size: 0.8rem;
            font-weight: 600; color: var(--accent); letter-spacing: 0.04em;
            transition: color 0.25s var(--ease-out-expo), background 0.25s var(--ease-out-expo);
        }
        .flip-trigger:hover {
            color: var(--accent-hover);
            background: var(--accent-light);
        }
        .flip-trigger.hint-pulse {
            animation: flipHint 1.8s ease-in-out infinite;
            background: rgba(196, 75, 40, 0.06);
            border-top-color: var(--accent);
            position: relative;
        }
        .flip-hint-tooltip {
            position: absolute; bottom: calc(100% + 8px); left: 50%;
            transform: translateX(-50%); white-space: nowrap;
            background: var(--text-primary); color: var(--bg-main);
            font-family: 'DM Sans', sans-serif; font-size: 0.72rem;
            font-weight: 600; padding: 0.35rem 0.75rem;
            border-radius: 100px; pointer-events: none;
            opacity: 0; animation: tooltipFadeIn 0.4s ease 1.5s forwards;
        }
        .flip-hint-tooltip::after {
            content: ''; position: absolute; top: 100%; left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent; border-top-color: var(--text-primary);
        }
        @keyframes tooltipFadeIn {
            to { opacity: 1; }
        }
        .flip-trigger-arrow {
            display: inline-block; font-size: 0.85rem;
            transition: transform 0.4s var(--ease-out-expo);
        }
        .flip-trigger:hover .flip-trigger-arrow {
            transform: translateX(4px);
        }
        .flip-trigger-spin {
            display: inline-block; font-size: 1.1rem; margin-left: 0.3rem;
            animation: spinHint 2.5s ease-in-out infinite;
            vertical-align: -1px;
        }
        .flipped .flip-trigger-spin { animation: none; }
        @keyframes spinHint {
            0%, 70%, 100% { transform: rotate(0deg); }
            80% { transform: rotate(360deg); }
        }

        /* Card watermark — giant clause number */
        .card-watermark {
            position: absolute; top: -0.15rem; right: 1.2rem;
            font-family: 'DM Sans', sans-serif; font-size: 7rem; font-weight: 800;
            line-height: 1; color: var(--text-primary); opacity: 0.04;
            pointer-events: none; z-index: 0; user-select: none;
        }
        .flip-card-front { position: relative; overflow: hidden; }

        /* Card teaser — tension line above flip trigger */
        .card-teaser {
            padding: 0.5rem 2rem 0;
            font-family: 'DM Sans', sans-serif; font-size: 0.82rem;
            font-style: italic; color: var(--text-muted);
            text-align: center; line-height: 1.4;
        }

        /* Chapter title — editorial voice below cards (anchors the card) */
        .chapter-title {
            text-align: center; padding: 0 1rem;
            max-height: 0; opacity: 0; overflow: hidden;
            transition: opacity 0.5s var(--ease-out-expo), max-height 0.4s var(--ease-out-expo), padding 0.4s ease;
        }
        .chapter-title.visible { opacity: 1; max-height: 4rem; padding: 0.3rem 1rem 0.4rem; }
        .chapter-title-text {
            font-family: 'DM Sans', sans-serif; font-size: 1.15rem;
            font-weight: 500; font-style: italic;
            color: var(--text-secondary); line-height: 1.3;
        }
        .chapter-title-counter {
            display: none; font-family: 'JetBrains Mono', monospace;
            font-size: 0.62rem; font-weight: 600; font-style: normal;
            text-transform: uppercase; letter-spacing: 0.18em;
            color: var(--text-dim); margin-bottom: 0.3rem;
        }

        /* Back content */
        .back-content { padding: 0; }
        .risk-header {
            padding: 1.25rem 2rem; display: flex; align-items: center;
            justify-content: space-between; gap: 0.75rem; flex-wrap: wrap;
        }
        .risk-header-red {
            background: linear-gradient(135deg, rgba(196,75,40,0.08), rgba(196,75,40,0.14));
            border-bottom: 2px solid var(--red);
        }
        .risk-header-yellow {
            background: linear-gradient(135deg, rgba(184,134,11,0.06), rgba(184,134,11,0.12));
            border-bottom: 2px solid var(--yellow);
        }
        .risk-header-green {
            background: linear-gradient(135deg, rgba(45,138,78,0.06), rgba(45,138,78,0.10));
            border-bottom: 2px solid var(--green);
        }
        .risk-header .clause-title { margin-bottom: 0; font-size: 1.05rem; }
        .risk-header-label {
            display: block; width: 100%;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.58rem; font-weight: 600;
            text-transform: uppercase; letter-spacing: 0.12em;
            margin-bottom: 0.25rem; opacity: 0.6;
        }
        .risk-badge-group {
            display: flex; align-items: center; gap: 0.5rem; flex-shrink: 0;
        }
        .risk-badge {
            display: inline-flex; align-items: center; gap: 0.3rem;
            padding: 0.2rem 0.6rem; border-radius: 4px;
            font-size: 0.72rem; font-weight: 700; letter-spacing: 0.04em;
        }
        .risk-badge-red { background: var(--red-bg); color: var(--red-text); border: 1px solid var(--red-border); }
        .risk-badge-yellow { background: var(--yellow-bg); color: var(--yellow-text); border: 1px solid var(--yellow-border); }
        .risk-badge-green { background: var(--green-bg); color: var(--green-text); border: 1px solid var(--green-border); }
        .risk-score-val { font-size: 0.82rem; font-weight: 700; font-variant-numeric: tabular-nums; }
        .risk-score-red { color: var(--red-text); }
        .risk-score-yellow { color: var(--yellow-text); }
        .risk-score-green { color: var(--green-text); }
        .trick-label {
            padding: 0.15rem 0.5rem; background: var(--bg-warm);
            border: 1px solid var(--border); border-radius: var(--radius-sm);
            font-size: 0.7rem; font-weight: 500; color: var(--text-secondary);
        }
        .confidence-badge {
            display: inline-flex; align-items: center; gap: 0.25rem;
            padding: 0.15rem 0.5rem; border-radius: var(--radius-sm);
            font-size: 0.62rem; font-weight: 600; letter-spacing: 0.03em;
            text-transform: uppercase; cursor: default;
        }
        .confidence-high { background: var(--green-bg); color: var(--green-text); border: 1px solid var(--green-border); }
        .confidence-medium { background: var(--yellow-bg); color: var(--yellow-text); border: 1px solid var(--yellow-border); }
        .confidence-low { background: var(--red-bg); color: var(--red-text); border: 1px solid var(--red-border); font-style: italic; }
        .confidence-reason {
            font-weight: 400; font-style: italic; font-size: 0.58rem;
            text-transform: none; letter-spacing: 0; max-width: 0;
            overflow: hidden; white-space: nowrap;
            transition: max-width 0.3s var(--ease-out-expo), padding-left 0.3s ease;
        }
        .confidence-badge:hover .confidence-reason { max-width: 220px; padding-left: 0.3rem; }

        .back-body { padding: 1.25rem 1.75rem 0.5rem; }
        .back-footer {
            display: flex; align-items: center;
            border-top: 1px solid var(--border-light);
            position: relative;
        }
        .back-footer .flip-back-trigger { border-top: none; flex: 1; }
        .trick-footnote {
            position: absolute; right: 1.5rem; top: 50%; transform: translateY(-50%);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.58rem; letter-spacing: 0.06em; text-transform: uppercase;
            color: var(--text-muted); opacity: 0.55;
            pointer-events: none;
        }

        /* Drafter's voice — risk-colored */
        .drafter-voice {
            padding: 1rem 1.1rem; border-radius: var(--radius-sm); margin-bottom: 1.25rem;
            background: var(--bg-warm);
            border-left: 3px solid var(--text-muted);
            font-style: italic;
            color: var(--text-body);
            font-size: 0.9rem;
            line-height: 1.65;
        }
        .drafter-voice-red {
            background: linear-gradient(135deg, rgba(196,75,40,0.06), rgba(196,75,40,0.10));
            border-left: 3px solid var(--red);
        }
        .drafter-voice-yellow {
            background: linear-gradient(135deg, rgba(184,134,11,0.05), rgba(184,134,11,0.09));
            border-left: 3px solid var(--yellow);
        }
        .drafter-voice-green {
            background: linear-gradient(135deg, rgba(45,138,78,0.04), rgba(45,138,78,0.08));
            border-left: 3px solid var(--green);
        }
        .drafter-voice-label {
            display: block; font-family: 'JetBrains Mono', monospace;
            font-size: 0.65rem; font-weight: 500;
            text-transform: uppercase; letter-spacing: 0.12em; margin-bottom: 0.4rem;
            color: var(--ash);
        }
        .drafter-voice-label-red { color: var(--red-text); }
        .drafter-voice-label-yellow { color: var(--yellow-text); }
        .drafter-voice-label-green { color: var(--green-text); }
        .drafter-voice-text {
            font-size: 0.9rem; line-height: 1.65; color: var(--text-body); font-style: italic;
        }

        /* ── Your Move action block ── */
        .your-move {
            padding: 0.8rem 1.1rem; border-radius: var(--radius-sm); margin-bottom: 1.25rem;
            background: linear-gradient(135deg, rgba(45, 138, 78, 0.05), rgba(45, 138, 78, 0.10));
            border-left: 3px solid var(--green);
            font-size: 0.88rem; line-height: 1.6; color: var(--text-primary);
            font-weight: 500;
        }
        .your-move-label {
            display: block; font-family: 'JetBrains Mono', monospace;
            font-size: 0.65rem; font-weight: 700;
            text-transform: uppercase; letter-spacing: 0.12em;
            color: var(--green-text); margin-bottom: 0.3rem;
        }

        /* Green verdict — no hidden intent */
        .green-verdict {
            padding: 1.25rem 1.1rem; border-radius: var(--radius-sm);
            background: linear-gradient(135deg, rgba(45,138,78,0.06), rgba(45,138,78,0.10));
            border: 1px solid var(--green-border); margin-bottom: 1.25rem; text-align: center;
        }
        .green-verdict-title {
            font-size: 0.88rem; font-weight: 700; color: var(--green-text); margin-bottom: 0.25rem;
        }
        .green-verdict-text {
            font-size: 0.84rem; color: var(--text-secondary); line-height: 1.5;
        }

        /* Juxtaposition columns */
        .clause-juxtapose {
            display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 1.25rem;
        }
        @media (max-width: 560px) { .clause-juxtapose { grid-template-columns: 1fr; } }
        .juxtapose-col {
            padding: 0.9rem 1rem; border-radius: var(--radius-sm);
            font-size: 0.84rem; line-height: 1.6;
        }
        .juxtapose-label {
            display: block; font-family: 'JetBrains Mono', monospace;
            font-size: 0.62rem; font-weight: 500;
            text-transform: uppercase; letter-spacing: 0.12em; margin-bottom: 0.4rem;
        }
        .juxtapose-says {
            background: var(--bg-surface); border: 1px solid var(--border-light); color: var(--text-body);
        }
        .juxtapose-says .juxtapose-label { color: var(--text-muted); }
        .juxtapose-read {
            background: var(--accent-light); border: 1px solid var(--accent-medium);
            color: var(--text-primary); font-weight: 500;
        }
        .juxtapose-read .juxtapose-label { color: var(--accent); }

        /* Small print block (card back, full-width) */
        .smallprint-block {
            padding: 0.9rem 1rem; border-radius: var(--radius-sm);
            background: var(--bg-surface); border: 1px solid var(--border-light);
            font-size: 0.84rem; line-height: 1.6; color: var(--text-body);
            margin-bottom: 1rem;
        }

        /* English translation toggle (bilingual cards) */
        .en-translation {
            margin-top: 1rem; border-top: 1px dashed var(--border-light);
            padding-top: 0.5rem;
        }
        .en-translation-toggle {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.65rem; font-weight: 600;
            text-transform: uppercase; letter-spacing: 0.1em;
            color: var(--text-muted); cursor: pointer;
            padding: 0.4rem 0; list-style: none;
            transition: color var(--transition);
        }
        .en-translation-toggle:hover { color: var(--accent); }
        .en-translation-toggle::-webkit-details-marker { display: none; }
        .en-translation-toggle::before {
            content: '▸ '; font-size: 0.7rem;
            transition: transform 0.2s ease;
            display: inline-block;
        }
        .en-translation[open] > .en-translation-toggle::before {
            content: '▾ ';
        }
        .en-juxtapose {
            margin-top: 0.6rem; opacity: 0.85;
        }
        .en-juxtapose .juxtapose-col {
            font-size: 0.78rem;
        }
        .en-juxtapose .juxtapose-label::after {
            content: ' (EN)'; font-weight: 400;
        }

        /* English report summary (bilingual deep analysis) */
        .en-report-summary {
            margin-top: 2rem; border: 1px dashed var(--border);
            border-radius: var(--radius); padding: 0;
            background: var(--bg-surface);
        }
        .en-report-toggle {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.72rem; font-weight: 600;
            text-transform: uppercase; letter-spacing: 0.1em;
            color: var(--text-muted); cursor: pointer;
            padding: 1rem 1.5rem; list-style: none;
            transition: color var(--transition);
        }
        .en-report-toggle:hover { color: var(--accent); }
        .en-report-toggle::-webkit-details-marker { display: none; }
        .en-report-toggle::before {
            content: '▸ '; font-size: 0.75rem;
            display: inline-block;
        }
        .en-report-summary[open] > .en-report-toggle::before {
            content: '▾ ';
        }
        .en-report-toggle::after {
            content: 'EN'; display: inline-block;
            font-size: 0.5rem; font-weight: 700;
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 3px; padding: 0.1rem 0.35rem;
            margin-left: 0.5rem; vertical-align: middle;
        }
        .en-report-content {
            padding: 0 1.5rem 1.5rem;
        }
        .en-report-content h3 {
            font-size: 0.95rem; margin-top: 1.25rem;
        }

        /* Flip-back trigger */
        .flip-back-trigger {
            display: flex; align-items: center; justify-content: center; gap: 0.5rem;
            width: 100%; padding: 0.9rem 2rem; background: none; border: none;
            border-top: 1px solid var(--border-light); cursor: pointer;
            font-family: inherit; font-size: 0.8rem; font-weight: 600;
            color: var(--text-muted); transition: all var(--transition);
            position: relative; overflow: hidden;
        }
        .flip-back-trigger::before {
            content: ''; position: absolute; inset: 0;
            background: var(--bg-surface); opacity: 0; transition: opacity var(--transition);
        }
        .flip-back-trigger:hover::before { opacity: 1; }
        .flip-back-trigger:hover { color: var(--text-secondary); }
        .flip-back-arrow {
            display: inline-block; font-size: 0.9rem;
            transition: transform 0.4s var(--ease-out-expo);
        }
        .flip-back-trigger:hover .flip-back-arrow { transform: translateX(-4px); }

        /* (clause-nav removed — replaced by .card-navigation) */

        /* ── Back score bar ─────────────────────────── */
        .back-score-bar {
            display: flex; align-items: center; gap: 0.75rem;
            padding: 0 0 1.25rem;
        }
        .back-score-bar-track {
            flex: 1; height: 6px; background: var(--border-light);
            border-radius: 3px; overflow: hidden;
        }
        .back-score-bar-fill {
            height: 100%; border-radius: 3px; width: 0;
            transition: width 0.8s var(--ease-out-expo);
        }
        .back-score-bar-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.72rem; font-weight: 600;
            color: var(--text-secondary); white-space: nowrap;
        }

        /* ── "What does this mean for you" on card back ── */
        .back-meaning-label {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.6rem; font-weight: 600;
            text-transform: uppercase; letter-spacing: 0.12em;
            color: var(--text-muted);
            margin-bottom: 0.6rem;
        }
        .back-figure {
            font-size: 1.4rem; font-weight: 800;
            line-height: 1.3; margin-bottom: 1rem;
            padding: 0.75rem 0 0.5rem;
        }
        .back-figure-red { color: var(--red-text); }
        .back-figure-yellow { color: var(--yellow-text); }
        .back-figure-green { color: var(--green-text); }
        .back-example {
            font-size: 0.84rem; line-height: 1.65;
            color: var(--text-body);
            padding: 0.75rem 1rem;
            background: var(--bg-surface);
            border-radius: var(--radius-sm);
            border-left: 3px solid var(--border);
        }
        .back-example-red { border-left-color: var(--red); background: var(--red-bg); }
        .back-example-yellow { border-left-color: var(--yellow); background: var(--yellow-bg); }
        .back-example-green { border-left-color: var(--green); background: var(--green-bg); }
        .back-example .hl-number {
            font-weight: 700;
        }
        .back-example-red .hl-number { color: var(--red-text); }
        .back-example-yellow .hl-number { color: var(--yellow-text); }
        .back-example-green .hl-number { color: var(--green-text); }
        .back-bottom-line {
            font-size: 0.78rem; font-weight: 600;
            line-height: 1.4;
            color: var(--text-secondary);
            margin-top: 0.75rem;
            font-style: italic;
        }

        /* ── Verdict link (CTA on card back → deep analysis) ── */
        .verdict-link {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            width: 100%;
            padding: 0.65rem 0.85rem;
            margin-top: 0.25rem;
            background: var(--accent-light);
            border: 1px solid var(--accent-medium);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-family: 'DM Sans', sans-serif;
            transition: all 0.2s var(--ease-out-expo);
        }
        .verdict-link:hover {
            background: var(--accent-medium);
            border-color: var(--accent);
        }
        .verdict-link-label {
            font-size: 0.82rem;
            font-weight: 600;
            color: var(--accent);
        }
        .verdict-link-meta {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-muted);
            flex: 1;
        }
        .verdict-link .flip-trigger-arrow {
            color: var(--accent);
            font-size: 0.9rem;
        }
        .verdict-link.verdict-loading {
            border-color: var(--yellow-border);
            background: var(--yellow-bg);
        }
        .verdict-link.verdict-loading .verdict-link-meta {
            color: var(--yellow-text);
        }

        /* ── Back to cards button ── */
        .back-to-cards-btn {
            display: inline-flex; align-items: center; gap: 0.4rem;
            padding: 0.5rem 1rem; margin-bottom: 1rem;
            background: var(--bg-surface); border: 1px solid var(--border);
            border-radius: var(--radius-sm); cursor: pointer;
            font-family: 'DM Sans', sans-serif; font-size: 0.82rem;
            font-weight: 500; color: var(--text-secondary);
            transition: all 0.2s var(--ease-out-expo);
        }
        .back-to-cards-btn:hover {
            background: var(--bg-warm); color: var(--text-primary);
            border-color: var(--border-focus);
        }

        /* ── Opus branding on deep analysis ── */
        .deep-analysis-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem 0;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }
        .deep-analysis-header .section-label {
            flex: 1;
        }
        .opus-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.25rem 0.6rem;
            background: var(--bg-thinking);
            color: #e8e4dc;
            border-radius: var(--radius-sm);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.62rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }
        .opus-badge::before {
            content: '';
            width: 6px; height: 6px;
            border-radius: 50%;
            background: #c44b28;
            animation: opusPulse 2s ease-in-out infinite;
        }
        @keyframes opusPulse {
            0%, 100% { opacity: 0.4; }
            50% { opacity: 1; }
        }

        /* ── How Opus Analyzed This — promoted callout ── */
        .opus-method-callout {
            background: var(--bg-thinking); color: #e8e4dc;
            border-radius: var(--radius-md); padding: 1.2rem 1.5rem;
            margin-bottom: 1.5rem; position: relative;
            border-left: 3px solid var(--accent);
        }
        .opus-method-callout .callout-label {
            font-family: 'JetBrains Mono', monospace; font-size: 0.65rem;
            text-transform: uppercase; letter-spacing: 0.1em;
            color: var(--accent); margin-bottom: 0.6rem; display: flex;
            align-items: center; gap: 0.4rem;
        }
        .opus-method-callout .callout-label::before {
            content: ''; width: 6px; height: 6px; border-radius: 50%;
            background: var(--accent);
        }
        .opus-method-callout p { font-size: 0.82rem; line-height: 1.55; margin: 0.4rem 0; color: #d4d0c8; }
        .opus-method-callout ul, .opus-method-callout ol { font-size: 0.82rem; color: #d4d0c8; padding-left: 1.2rem; }
        .opus-method-callout li { margin: 0.2rem 0; }
        .opus-method-callout strong { color: #f0ece4; }

        /* ── Counter-draft UI ── */
        .counter-draft-section { margin-top: 2.5rem; }
        .counter-draft-btn {
            display: inline-flex; align-items: center; gap: 0.5rem;
            padding: 0.7rem 1.4rem; font-family: 'JetBrains Mono', monospace;
            font-size: 0.78rem; font-weight: 500; letter-spacing: 0.03em;
            color: var(--accent); background: transparent;
            border: 1.5px solid var(--accent); border-radius: var(--radius-md);
            cursor: pointer; transition: all 0.25s ease;
        }
        .counter-draft-btn:hover { background: var(--accent); color: #fff; }
        .counter-draft-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .counter-draft-btn:disabled:hover { background: transparent; color: var(--accent); }
        .counter-draft-content {
            margin-top: 1.5rem; padding: 1.5rem;
            background: var(--bg-surface); border: 1px solid var(--border);
            border-radius: var(--radius-md);
        }

        /* ── Follow-up question UI ── */
        .followup-section { margin-top: 2.5rem; }
        .followup-input-row { display: flex; gap: 0.5rem; align-items: flex-start; }
        .followup-input {
            flex: 1; padding: 0.7rem 1rem;
            font-family: 'DM Sans', sans-serif; font-size: 0.88rem;
            color: var(--text-primary); background: var(--bg-surface);
            border: 1px solid var(--border); border-radius: var(--radius-md);
            outline: none; resize: none; min-height: 44px; max-height: 120px;
            transition: border-color var(--transition);
        }
        .followup-input:focus { border-color: var(--accent); }
        .followup-input::placeholder { color: var(--text-dim); }
        .followup-send {
            padding: 0.7rem 1.2rem; font-family: 'DM Sans', sans-serif;
            font-size: 0.85rem; font-weight: 600; color: white;
            background: var(--text-primary); border: none;
            border-radius: var(--radius-md); cursor: pointer;
            transition: all var(--transition); white-space: nowrap;
        }
        .followup-send:hover:not(:disabled) { background: var(--accent); }
        .followup-send:disabled { opacity: 0.35; cursor: not-allowed; }
        .followup-answer {
            margin-top: 1.5rem; padding: 1.2rem 1.5rem;
            background: var(--bg-surface); border-radius: var(--radius);
            border: 1px solid var(--border-light);
        }
        .followup-q { font-size: 0.82rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 0.75rem; }
        .followup-a { font-size: 0.9rem; color: var(--text-body); line-height: 1.65; }
        .followup-a p { margin-bottom: 0.6rem; }

        /* Reduced motion */
        @media (prefers-reduced-motion: reduce) {
            .flip-card.woosh-in { animation: none; }
            .flip-card-inner { transition: none; }
            .flip-card.flipped .flip-card-back { position: static; transform: none; }
            .flip-card.flipped .flip-card-front { display: none; }
        }

        /* Section headers (H2 in results) */
        .results-area h2 {
            font-size: 1.1rem; font-weight: 700; color: var(--text-primary);
            margin: 2rem 0 1rem; padding-bottom: 0.4rem;
            border-bottom: 2px solid var(--accent);
        }

        /* ── Error display ───────────────────────────── */
        .error-msg {
            background: var(--red-bg); border: 1px solid var(--red-border);
            border-radius: var(--radius); padding: 1.5rem; text-align: center;
            color: var(--red-text); font-weight: 600;
        }
        .retry-btn {
            margin-top: 0.8rem; padding: 0.5rem 1.5rem; background: var(--accent);
            color: white; border: none; border-radius: var(--radius-sm);
            cursor: pointer; font-family: inherit; font-weight: 600;
        }

        /* ══════════════════════════════════════════════════════
           RESPONSIVE
           ══════════════════════════════════════════════════════ */

        /* Tablet: sidebar stacks above content (handled at 900px above) */

        /* ── Mobile: ≤ 900px unified block ──────────────── */
        @media (max-width: 900px) {
            /* Phase 1: 2D slide-up flip (replaces broken 3D rotateY on mobile Safari) */
            .flip-card { perspective: none; }
            .flip-card-inner {
                transform-style: flat;
                transition: none;
            }
            .flip-card-front,
            .flip-card-back {
                backface-visibility: visible;
                -webkit-backface-visibility: visible;
                transform: none;
            }
            .flip-card-front {
                position: relative;
                transition: transform 0.55s cubic-bezier(0.22, 1, 0.36, 1), opacity 0.4s ease;
            }
            .flip-card.flipped .flip-card-front {
                transform: translateY(-30px);
                opacity: 0;
                position: absolute;
                top: 0; left: 0; width: 100%;
                pointer-events: none;
                visibility: hidden;
            }
            .flip-card-back {
                position: relative;
                opacity: 0;
                max-height: 0;
                overflow: hidden;
                transition: max-height 0.5s cubic-bezier(0.22, 1, 0.36, 1), opacity 0.35s ease 0.1s;
            }
            .flip-card.flipped .flip-card-back {
                position: relative;
                opacity: 1;
                max-height: 3000px;
                overflow: visible;
            }
            .flip-card.flipped .flip-card-inner {
                transform: none;
            }
            /* Larger tap target for flip trigger on mobile */
            .flip-trigger {
                min-height: 48px;
                padding: 1rem 1.25rem;
            }
            /* Replace spin hint with upward bounce on mobile */
            .flip-trigger-spin {
                animation: mobileFlipHint 2s ease-in-out infinite;
            }
            @keyframes mobileFlipHint {
                0%, 100% { transform: translateY(0); }
                50% { transform: translateY(-3px); }
            }
            /* Flip-back trigger: same tap target */
            .flip-back-trigger {
                min-height: 48px;
            }
            /* Don't dim sidebar on mobile when flipped — it's above content */
            .layout-flipped .analysis-sidebar {
                opacity: 1;
            }

            /* Phase 2: Bottom sheet for verdict */
            .verdict-col {
                position: fixed !important;
                bottom: 0; left: 0; right: 0;
                width: 100% !important;
                max-height: 90vh;
                z-index: 200;
                border-radius: 16px 16px 0 0 !important;
                border-bottom: none !important;
                box-shadow: 0 -4px 24px rgba(0,0,0,0.12) !important;
                transform: translateY(calc(100% - 52px));
                transition: transform 0.4s cubic-bezier(0.22, 1, 0.36, 1) !important;
                margin-left: 0 !important;
                overflow: hidden;
                padding-bottom: env(safe-area-inset-bottom);
            }
            .verdict-col.visible {
                width: 100% !important;
                margin-left: 0 !important;
                display: flex !important;
                opacity: 1;
            }
            .verdict-col.sheet-half {
                transform: translateY(60%);
            }
            .verdict-col.sheet-full {
                transform: translateY(10%);
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }
            /* Drag handle */
            .verdict-header::before {
                content: '';
                position: absolute;
                top: 8px;
                left: 50%;
                transform: translateX(-50%);
                width: 36px;
                height: 4px;
                border-radius: 2px;
                background: var(--text-dim);
            }
            .verdict-header {
                position: relative;
                padding-top: 1.2rem;
                cursor: grab;
            }
            .verdict-body {
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }
            body.sheet-open {
                overflow: hidden;
            }
            /* Add padding to content so bottom sheet peek doesn't cover cards */
            .content-col {
                padding-bottom: 64px !important;
            }

            /* Phase 3: Dot indicator for card navigation */
            .card-nav-btn { display: none; }
            .card-nav-counter { display: none; }
            .card-nav-dots {
                display: flex;
                justify-content: center;
                align-items: center;
                gap: 6px;
                padding: 0.75rem 0;
            }
            .card-nav-dot {
                width: 8px;
                height: 8px;
                border-radius: 4px;
                background: var(--border);
                transition: all 0.3s ease;
                cursor: pointer;
            }
            .card-nav-dot.active {
                width: 20px;
                background: var(--text-muted);
            }
            .card-nav-dot.risk-red { background: var(--red); }
            .card-nav-dot.risk-yellow { background: var(--yellow); }
            .card-nav-dot.risk-green { background: var(--green); }
            .card-nav-dot.risk-red.active { background: var(--red); }
            .card-nav-dot.risk-yellow.active { background: var(--yellow); }
            .card-nav-dot.risk-green.active { background: var(--green); }
            .card-navigation {
                flex-direction: column;
                gap: 0.25rem;
            }

            /* Phase 4: Compact sidebar strip */
            .analysis-sidebar {
                position: sticky !important;
                top: 50px;
                z-index: 50;
                border-bottom: 1px solid var(--border);
                background: var(--bg-cream);
                padding: 0;
                overflow: hidden !important;
            }
            .sidebar-profile {
                flex-direction: row !important;
                align-items: center;
                gap: 0.6rem;
                padding: 0.5rem 0.75rem;
                cursor: pointer;
                min-height: 48px;
            }
            .doc-thumbnail {
                width: 32px !important;
                height: 32px !important;
                flex-shrink: 0;
                border-radius: 4px !important;
            }
            .doc-thumbnail img {
                width: 32px !important;
                height: 32px !important;
            }
            .metadata-line {
                flex: 1;
                min-width: 0;
                overflow: hidden;
                flex-wrap: nowrap !important;
            }
            .meta-pill {
                white-space: nowrap;
            }
            .editorial-loading {
                max-height: 0;
                overflow: hidden !important;
                transition: max-height 0.4s cubic-bezier(0.22, 1, 0.36, 1);
                margin: 0 !important;
                border: none !important;
                box-shadow: none !important;
                border-radius: 0 !important;
            }
            .analysis-sidebar.expanded .editorial-loading {
                max-height: 50vh;
                overflow-y: auto !important;
                border-top: 1px solid var(--border) !important;
            }
            /* Chevron indicator for expand/collapse */
            .sidebar-profile::after {
                content: '\25BE';
                font-size: 0.7rem;
                color: var(--text-muted);
                transition: transform 0.3s ease;
                flex-shrink: 0;
            }
            .analysis-sidebar.expanded .sidebar-profile::after {
                transform: rotate(180deg);
            }

            /* Phase 5: Compact header */
            .analysis-header {
                padding: 0.4rem 0.75rem;
                padding-top: calc(0.4rem + env(safe-area-inset-top));
            }
            #copyAllBtn, #emailLawyerBtn, #exportBtn, #exportLangBtn,
            .model-badge, .capability-ticker {
                display: none !important;
            }
            .header-overflow-btn {
                display: inline-flex;
                align-items: center;
                justify-content: center;
                background: none;
                border: 1px solid var(--border);
                color: var(--text-secondary);
                width: 32px;
                height: 32px;
                border-radius: 50%;
                cursor: pointer;
                font-size: 1.1rem;
                line-height: 1;
                padding: 0;
            }
            .header-overflow-btn:hover {
                background: var(--bg-warm);
                border-color: var(--text-secondary);
            }
            .header-overflow-menu {
                position: absolute;
                top: 100%;
                right: 0.75rem;
                background: var(--bg-card);
                border: 1px solid var(--border);
                border-radius: var(--radius-sm);
                box-shadow: var(--shadow-lg);
                z-index: 110;
                min-width: 160px;
                padding: 0.25rem 0;
            }
            .header-overflow-menu.hidden { display: none; }
            .header-overflow-menu button {
                display: block;
                width: 100%;
                text-align: left;
                padding: 0.5rem 0.85rem;
                font-family: inherit;
                font-size: 0.78rem;
                color: var(--text-secondary);
                background: none;
                border: none;
                cursor: pointer;
            }
            .header-overflow-menu button:hover {
                background: var(--bg-warm);
                color: var(--text-primary);
            }
            .header-overflow-menu button.hidden { display: none; }
        }

        /* Bottom sheet dark mode audit */
        .dark-mode .verdict-col.sheet-half,
        .dark-mode .verdict-col.sheet-full {
            box-shadow: 0 -4px 24px rgba(0,0,0,0.4) !important;
        }
        .dark-mode .verdict-header::before {
            background: var(--text-muted);
        }
        .dark-mode .header-overflow-menu {
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
        }
        .dark-mode .card-nav-dot {
            background: var(--border);
        }
        .dark-mode .card-nav-dot.active {
            background: var(--text-muted);
        }

        /* Mobile reduced motion */
        @media (max-width: 900px) and (prefers-reduced-motion: reduce) {
            .flip-card-front { transition: none !important; }
            .flip-card-back { transition: none !important; }
            .flip-card.flipped .flip-card-front { transform: none; display: none; }
            .flip-card.flipped .flip-card-back { max-height: none; opacity: 1; }
            .verdict-col { transition: none !important; }
        }

        @media (max-width: 600px) {
            /* Sample docs: 2 columns on small screens */
            .demo-grid { grid-template-columns: repeat(2, 1fr); }
            /* Skeleton card */
            .skeleton-pulses { padding: 1.5rem 1.25rem 0; }
            .skeleton-waiting { font-size: 0.68rem; }

            /* Upload screen */
            .brand h1 { font-size: 2.4rem; }
            .upload-card { padding: 1.25rem; }

            /* Layout */
            .analysis-layout { padding: 0 0.5rem; }
            .content-col { padding: 0 0 3rem; }
            .analysis-header { padding: 0.5rem 0.75rem; }

            /* Sidebar profile: stack thumbnail above pills on small screens */
            .sidebar-profile { flex-direction: column; gap: 0.4rem; }
            .doc-thumbnail { width: 100%; height: 80px; }
            .doc-thumbnail img { height: 80px; object-fit: cover; object-position: top center; }
            .metadata-line { gap: 0.2rem; }
            .meta-pill { font-size: 0.6rem; padding: 0; }
            .meta-pill .meta-pill-label { font-size: 0.4rem; }

            /* Editorial loading / document preview */
            .editorial-loading-text {
                max-height: 30vh; font-size: 0.72rem;
                margin-left: 0.75rem; margin-right: 0.75rem;
                padding-left: 0.75rem;
            }

            /* Flip cards */
            .flip-card { margin-bottom: 1rem; }
            .front-content { padding: 1.25rem 1.25rem 0; }
            .clause-reassurance { font-size: 1.05rem; }
            .flip-card .clause-title { font-size: 1rem; }
            .flip-card .clause-quote { padding: 0.7rem 0.9rem; font-size: 0.78rem; }
            .reader-voice { padding: 0.75rem 0.9rem; }
            .reader-voice-text { font-size: 0.84rem; }
            .flip-trigger { padding: 0.75rem 1.25rem; font-size: 0.68rem; }
            .card-watermark { font-size: 5rem; right: 0.8rem; }
            .card-teaser { padding: 0.4rem 1.25rem 0; font-size: 0.78rem; }
            .chapter-title-text { font-size: 1rem; }

            /* Card back */
            .risk-header { padding: 1rem 1.25rem; flex-direction: column; align-items: flex-start; gap: 0.5rem; }
            .back-body { padding: 1.25rem; }
            .clause-juxtapose { grid-template-columns: 1fr; gap: 0.5rem; }
            .juxtapose-col { padding: 0.7rem 0.85rem; font-size: 0.78rem; }
            .drafter-voice { padding: 0.75rem 0.9rem; font-size: 0.82rem; }
            .bottom-line { padding: 0.7rem 0.9rem; font-size: 0.78rem; }
            .flip-back-trigger { padding: 0.7rem 1.25rem; font-size: 0.75rem; }

            /* Card navigation */
            .card-navigation { gap: 0.75rem; padding: 1rem 0; }
            .card-nav-btn { padding: 0.45rem 0.8rem; font-size: 0.75rem; }
            .card-nav-counter { font-size: 0.7rem; }

            /* Deep analysis cards */
            .clause-card, .cross-clause-card, .playbook-card, .assessment-card {
                padding: 1rem 1.1rem;
            }

            /* Summary */
            .verdict-tier { font-size: 1rem; }
            .clause-dot { width: 8px; height: 8px; }
            .clause-strip { gap: 4px; }

            /* Follow-up */
            .followup-input { font-size: 0.85rem; }

            /* Bilingual */
            .en-translation-toggle { font-size: 0.6rem; padding: 0.3rem 0; }
            .en-juxtapose .juxtapose-col { font-size: 0.72rem; }
            .en-report-toggle { font-size: 0.65rem; padding: 0.75rem 1rem; }
            .en-report-content { padding: 0 1rem 1rem; }

            /* Deep analysis header */
            .deep-analysis-header { padding: 0 0.5rem; }

            .insight-narrative { font-size: 0.78rem; }
            .insight-example-label { font-size: 0.55rem; }
            .insight-label { font-size: 0.55rem; margin-bottom: 0.5rem; }
        }

        /* Very small screens (iPhone SE, etc.) */
        @media (max-width: 380px) {
            .brand h1 { font-size: 2rem; }
            .front-content { padding: 1rem 1rem 0; }
            .risk-header { padding: 0.75rem 1rem; }
            .card-navigation { gap: 0.5rem; flex-wrap: wrap; justify-content: center; }
            .card-nav-btn { padding: 0.4rem 0.6rem; font-size: 0.7rem; }
            .clause-reassurance { font-size: 0.95rem; }
        }

        /* ── Drafter's Playbook ────────────────────────────── */
        .playbook-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.25rem;
            margin-top: 1rem;
        }
        .playbook-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 0.75rem;
        }
        .playbook-title {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-muted);
        }
        .playbook-subtitle {
            font-size: 0.65rem;
            color: var(--text-muted);
        }
        .playbook-bars { display: flex; flex-direction: column; gap: 0.35rem; }
        .playbook-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            padding: 0.15rem 0;
            border-radius: 4px;
            transition: background 0.15s;
        }
        .playbook-row:hover { background: var(--bg-warm); }
        .playbook-row-green {
            margin-top: 0.4rem; padding-top: 0.4rem;
            border-top: 1px solid var(--border); opacity: 0.7;
            cursor: default;
        }
        .playbook-trick-name {
            font-size: 0.7rem;
            min-width: 120px;
            white-space: nowrap;
        }
        .playbook-bar-track {
            flex: 1;
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            overflow: hidden;
        }
        .playbook-bar-fill {
            height: 100%;
            background: var(--accent);
            border-radius: 3px;
            transition: width 0.6s var(--ease-out-expo);
        }
        .playbook-count {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.65rem;
            color: var(--text-muted);
            min-width: 24px;
            text-align: right;
        }

        /* ── Trick filter chips ────────────────────────────── */
        .trick-chip-row {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
            margin-top: 0.25rem;
        }
        .chip-trick {
            background: var(--bg-card);
            border: 1px solid var(--border);
            font-size: 0.65rem;
            padding: 0.25rem 0.5rem;
            border-radius: 100px;
            cursor: pointer;
            transition: all 0.15s;
        }
        .chip-trick:hover { border-color: var(--accent); }
        .chip-trick.active {
            border-color: var(--accent);
            background: var(--accent);
            color: white;
        }
        .chip-count {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.55rem;
            opacity: 0.7;
        }
    </style>
</head>
<body>

<!-- ═══════════════════════════════════════════════════════
     SCREEN 1: UPLOAD
     ═══════════════════════════════════════════════════════ -->
<section id="upload-screen">
    <nav class="upload-nav" id="uploadNav">
        <div class="upload-nav-brand">FlipSide</div>
        <div class="upload-nav-label">Get started</div>
        <a href="#" data-nav="top">Upload a document</a>
        <div class="upload-nav-label">FAQ</div>
        <a href="#faq-what" data-nav="faq">What is FlipSide?</a>
        <a href="#faq-how" data-nav="faq">How does it work?</a>
        <a href="#faq-privacy" data-nav="faq">Your data &amp; privacy</a>
        <a href="#faq-claude" data-nav="faq">What Claude keeps</a>
        <a href="#faq-free" data-nav="faq">Why is it free?</a>
        <a href="#faq-legal" data-nav="faq">Is this legal advice?</a>
        <a href="#faq-who" data-nav="faq">Who built this?</a>
        <a href="#faq-fair-clause" data-nav="faq" class="nav-fair-clause">The Fair Clause</a>
    </nav>
    <div class="upload-main" id="uploadMain">
    <div class="upload-container">
        <div class="brand fade-up">
            <h1>FlipSide</h1>
            <div class="tagline">The dark side of small print.</div>
            <div class="tagline" style="font-style: normal; font-weight: 400; margin-top: 0.3rem; font-size: 0.88rem; color: var(--text-muted);">What did you agree to?</div>
            <div style="margin-top: 0.6rem; font-size: 0.75rem; color: var(--text-dim); letter-spacing: 0.02em;">We show you what a trusting reader sees &mdash; then flip the card to reveal what an expert catches.</div>
        </div>

        <div class="upload-card fade-up fade-up-d1">
            <!-- Single document upload -->
            <div id="singleUpload">
                <div class="drop-zone" id="dropZone">
                    <input type="file" id="fileInput" accept=".pdf,.docx,.txt,.text,.md" class="sr-only">
                    <div id="uploadPrompt">
                        <span class="icon" aria-hidden="true"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><path d="M16 13H8"/><path d="M16 17H8"/><path d="M10 9H8"/></svg></span>
                        <div class="dz-title">Drop a document here</div>
                        <div class="hint">or click to browse</div>
                        <div class="filetypes">PDF &middot; DOCX &middot; TXT</div>
                    </div>
                    <div id="fileInfo" class="file-selected hidden">
                        <span class="file-name" id="fileName"></span>
                        <span class="file-size" id="fileSize"></span>
                        <a class="file-remove" id="fileRemove">remove</a>
                    </div>
                </div>
                <textarea id="pasteArea" class="paste-area hidden" placeholder="Paste contract text here..."></textarea>
            </div>

            <!-- Compare mode (two documents) -->
            <div id="compareUpload" class="hidden">
                <div class="compare-row">
                    <div class="compare-col">
                        <div class="drop-zone compare-drop" id="dropZone1">
                            <input type="file" id="fileInput1" accept=".pdf,.docx,.txt,.text,.md" class="sr-only">
                            <div id="uploadPrompt1">
                                <span class="icon" aria-hidden="true">&#65313;</span>
                                <div class="dz-title">Document A</div>
                                <div class="hint">drop or click</div>
                            </div>
                            <div id="fileInfo1" class="file-selected hidden">
                                <span class="file-name" id="fileName1"></span>
                                <a class="file-remove" id="fileRemove1">remove</a>
                            </div>
                        </div>
                        <textarea id="pasteArea1" class="paste-area hidden" placeholder="Paste Document A text..." style="min-height:80px;margin-top:0.5rem"></textarea>
                    </div>
                    <div class="compare-col">
                        <div class="drop-zone compare-drop" id="dropZone2">
                            <input type="file" id="fileInput2" accept=".pdf,.docx,.txt,.text,.md" class="sr-only">
                            <div id="uploadPrompt2">
                                <span class="icon" aria-hidden="true">&#65314;</span>
                                <div class="dz-title">Document B</div>
                                <div class="hint">drop or click</div>
                            </div>
                            <div id="fileInfo2" class="file-selected hidden">
                                <span class="file-name" id="fileName2"></span>
                                <a class="file-remove" id="fileRemove2">remove</a>
                            </div>
                        </div>
                        <textarea id="pasteArea2" class="paste-area hidden" placeholder="Paste Document B text..." style="min-height:80px;margin-top:0.5rem"></textarea>
                    </div>
                </div>
            </div>

            <div class="depth-selector hidden" id="depthSelector">
                <button class="depth-btn" data-depth="quick">Quick</button>
                <button class="depth-btn active" data-depth="standard">Standard</button>
                <button class="depth-btn" data-depth="deep">Deep</button>
            </div>

            <button class="analyze-btn hidden" id="analyzeBtn" disabled>Show me the dark side of small print</button>
            <div id="uploadError" class="upload-error hidden"></div>

            <div class="upload-links">
                <a id="pasteToggle">Paste text instead</a>
                <a id="compareToggle">Compare two documents</a>
            </div>

        </div>

        <div class="demo-grid-section fade-up fade-up-d1" id="demoGridSection">
            <div class="demo-grid-title">Or try a sample</div>
            <div class="demo-grid">
                <div class="demo-tile" data-sample="hackathon"><div class="demo-tile-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L9 9l-7 1 5 5-1.5 7L12 18l6.5 4L17 15l5-5-7-1z"/></svg></div><div class="demo-tile-label">The Hackathon</div><div class="demo-tile-desc">Event waiver we all signed</div></div>
                <div class="demo-tile" data-sample="sweepstakes"><div class="demo-tile-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M2 12h20"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg></div><div class="demo-tile-label">Trip of a Lifetime</div><div class="demo-tile-desc">Sweepstakes official rules</div></div>
                <div class="demo-tile" data-sample="coupon"><div class="demo-tile-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><circle cx="7" cy="7" r="1.5"/></svg></div><div class="demo-tile-label">Weekend Savings</div><div class="demo-tile-desc">Local store rewards program</div></div>
                <div class="demo-tile" data-sample="insurance"><div class="demo-tile-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg></div><div class="demo-tile-label">Peace of Mind</div><div class="demo-tile-desc">Homeowner's coverage plan</div></div>
                <div class="demo-tile" data-sample="tos"><div class="demo-tile-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><path d="M16 13H8"/><path d="M16 17H8"/><path d="M10 9H8"/></svg></div><div class="demo-tile-label">Staying Connected</div><div class="demo-tile-desc">Social media platform terms</div></div>
                <div class="demo-tile" data-sample="employment"><div class="demo-tile-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg></div><div class="demo-tile-label">First Day of Work</div><div class="demo-tile-desc">Tech company offer letter</div></div>
                <div class="demo-tile" data-sample="loan"><div class="demo-tile-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 22h18"/><path d="M6 18V11"/><path d="M10 18V11"/><path d="M14 18V11"/><path d="M18 18V11"/><path d="M4 7h16l-8-5z"/></svg></div><div class="demo-tile-label">Future Fund</div><div class="demo-tile-desc">Personal auto loan terms</div></div>
                <div class="demo-tile" data-sample="gym"><div class="demo-tile-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="17 1 21 5 17 9"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><polyline points="7 23 3 19 7 15"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/></svg></div><div class="demo-tile-label">Morning Workout</div><div class="demo-tile-desc">24-month fitness membership</div></div>
                <div class="demo-tile" data-sample="medical"><div class="demo-tile-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1"/></svg></div><div class="demo-tile-label">Check-up Time</div><div class="demo-tile-desc">Outpatient procedure consent</div></div>
                <div class="demo-tile" data-sample="hoa"><div class="demo-tile-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg></div><div class="demo-tile-label">Dream Home</div><div class="demo-tile-desc">Suburban community bylaws</div></div>
                <div class="demo-tile" data-sample="wedding"><div class="demo-tile-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M8 21h8"/><path d="M12 17v4"/><path d="M7 4V2"/><path d="M17 4V2"/><path d="M5 4h14a2 2 0 0 1 2 2v4a7 7 0 0 1-14 0V6a2 2 0 0 1 2-2z"/></svg></div><div class="demo-tile-label">Celebration!</div><div class="demo-tile-desc">Event venue rental agreement</div></div>
                <div class="demo-tile" data-sample="lease"><div class="demo-tile-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="8" cy="15" r="5.5"/><path d="M12 11l9-9"/><path d="M17 6l4-4"/><path d="M18.5 7.5L22 7l-3-3"/></svg></div><div class="demo-tile-label">My New Place</div><div class="demo-tile-desc">12-month residential lease</div></div>
                <div class="demo-tile" data-sample="pet"><div class="demo-tile-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="4" r="2"/><circle cx="4.5" cy="9" r="2"/><circle cx="17.5" cy="9" r="2"/><circle cx="8" cy="14" r="2"/><circle cx="16" cy="14" r="2"/><path d="M12 18c-2.5 2-6 2-6-.5C6 15 9 14 12 17c3-3 6-2 6 .5 0 2.5-3.5 2.5-6 .5z"/></svg></div><div class="demo-tile-label">Furry Friend</div><div class="demo-tile-desc">Shelter adoption contract</div></div>
                <div class="demo-tile" data-sample="timeshare"><div class="demo-tile-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg></div><div class="demo-tile-label">Dream Getaway</div><div class="demo-tile-desc">Timeshare vacation package</div></div>
            </div>
        </div>

        <div class="disclaimer fade-up fade-up-d2">
            Your document is analyzed by Claude and never stored. No data leaves the Anthropic API.<br>
            AI analysis — not legal advice. Always consult an attorney for important decisions.
        </div>
    </div>

    <!-- ── FAQ Sections ─────────────────────────────────── -->
    <div class="faq-wrapper hidden" id="faqWrapper">
        <h2 class="faq-title">Frequently Asked Questions</h2>
        <p class="faq-subtitle">Everything you need to know before uploading a document.</p>

        <div class="faq-section" id="faq-what">
            <h3>What is FlipSide?</h3>
            <p>FlipSide shows you what the other side intended when they wrote your document. Upload any contract, agreement, or policy you didn't draft — a lease, insurance policy, gym membership, Terms of Service — and FlipSide reads it from <strong>the drafter's perspective</strong>, not yours.</p>
            <p>Each clause gets a flip card. The front shows what a trusting reader sees: the reassuring headline, the comforting language. Flip it, and the back reveals what an expert catches: the trick, the risk score, the figure that matters, and what you should actually read.</p>
            <p>It's based on a peer-reviewed methodology called <strong>"Think Like a Document"</strong> — instead of reading from your perspective, read from the perspective of the party who wrote it. FlipSide applies that principle at scale using AI.</p>
        </div>

        <hr class="faq-divider">

        <div class="faq-section" id="faq-how">
            <h3>How does it work?</h3>
            <p>FlipSide runs <strong>five AI threads in parallel</strong> the moment you upload:</p>
            <ul>
                <li><strong>Thread 1 — Card Scan</strong> (Claude Haiku 4.5): Reads every clause and generates flip cards with front and back in ~12 seconds. This is what appears first.</li>
                <li><strong>Thread 2 — Cross-Clause Interactions</strong> (Claude Opus 4.6): Finds risks you can't see reading one clause at a time — where clauses combine to create compound effects.</li>
                <li><strong>Thread 3 — Power Asymmetry</strong> (Claude Opus 4.6): Counts who holds the rights, who carries the obligations, and calculates the power ratio.</li>
                <li><strong>Thread 4 — Document Archaeology</strong> (Claude Opus 4.6): Identifies which clauses are standard boilerplate and which were custom-drafted for strategic advantage.</li>
                <li><strong>Thread 5 — Overall Assessment</strong> (Claude Opus 4.6): Synthesizes everything into a verdict, profiles the drafter, and reviews its own analysis for blind spots.</li>
            </ul>
            <p>Cards appear fast. The expert verdict builds in the background. You can start flipping cards while Opus is still thinking.</p>
        </div>

        <hr class="faq-divider">

        <div class="faq-section" id="faq-privacy">
            <h3>Your data &amp; privacy</h3>
            <p><strong>FlipSide stores nothing.</strong> Your document is not saved anywhere — not to disk, not to a database, not to a temporary file. It exists only in your browser session's memory and is gone when you close the tab or analyze a new document.</p>
            <ul>
                <li><strong>No disk writes.</strong> The server has no file system storage, no database, no logging of document content.</li>
                <li><strong>No external services.</strong> Your document is never sent to any third party. The only external call is to the Anthropic API (Claude) for analysis.</li>
                <li><strong>No analytics or tracking.</strong> No cookies, no user accounts, no telemetry. FlipSide doesn't know who you are.</li>
                <li><strong>Memory only.</strong> Documents exist in server memory during your active session and are released when the session ends. Nothing survives a server restart.</li>
            </ul>
            <p>The 14 sample documents on this page are embedded directly in the application code — they are not fetched from any external source.</p>
        </div>

        <hr class="faq-divider">

        <div class="faq-section" id="faq-claude">
            <h3>What does Claude keep?</h3>
            <p>When you upload a document, it is sent to the <strong>Anthropic API</strong> for analysis by Claude Haiku 4.5 (fast card scan) and Claude Opus 4.6 (expert verdict). Here is what Anthropic does and does not do with your data:</p>
            <ul>
                <li><strong>Not used for training.</strong> Anthropic does not use API inputs to train its models. Your document will not become part of Claude's training data.</li>
                <li><strong>Safety monitoring.</strong> Anthropic may retain API inputs for up to 30 days for trust and safety purposes (detecting abuse, complying with legal obligations). After that, it is deleted.</li>
                <li><strong>No sharing.</strong> Anthropic does not share your API data with third parties except as required by law.</li>
                <li><strong>Prompt caching.</strong> FlipSide uses Anthropic's prompt caching feature, which caches the <em>system instructions</em> (not your document) for performance. This reduces cost and latency but does not affect your document's privacy.</li>
            </ul>
            <p>In short: Anthropic processes your document to generate the analysis, may retain it briefly for safety, and then deletes it. FlipSide itself keeps nothing at all.</p>
            <p style="font-size:0.78rem;color:var(--text-muted)">For full details, see <a href="https://www.anthropic.com/policies/privacy" target="_blank" rel="noopener" style="color:var(--accent)">Anthropic's Privacy Policy</a> and <a href="https://www.anthropic.com/policies/usage" target="_blank" rel="noopener" style="color:var(--accent)">Usage Policy</a>.</p>
        </div>

        <hr class="faq-divider">

        <div class="faq-section" id="faq-free">
            <h3>Why is it free?</h3>
            <p>FlipSide was built during the <strong>Built with Claude Hackathon</strong> (February 2026) to prove a point: legal document analysis shouldn't be locked behind $300–500/hour attorney fees. Everyone signs contracts. Not everyone can afford to understand them.</p>
            <p>The entire codebase is <strong>open source under the MIT License</strong> — free for anyone to use, modify, and distribute. There are no paid tiers, no premium features, no subscriptions, and no plans to add any.</p>
            <p>The only operational cost is the Anthropic API, which processes each document. During the hackathon, there are no cost constraints. The vision: making document literacy accessible to everyone, not just people who can afford a lawyer.</p>
        </div>

        <hr class="faq-divider">

        <div class="faq-section" id="faq-legal">
            <h3>Is this legal advice?</h3>
            <p><strong>No.</strong> FlipSide is an analysis tool, not a law firm. It helps you understand what a document says and what the drafter may have intended — but it is not a substitute for professional legal advice.</p>
            <ul>
                <li>FlipSide does not provide legal opinions or recommendations.</li>
                <li>FlipSide is not your attorney and no attorney-client relationship is created.</li>
                <li>For important decisions — signing a lease, accepting employment terms, buying insurance — always consult a qualified attorney.</li>
            </ul>
            <p>Think of FlipSide as a flashlight: it shows you what's there. What you do with that knowledge is up to you and your lawyer.</p>
        </div>

        <hr class="faq-divider">

        <div class="faq-section" id="faq-who">
            <h3>Who built this?</h3>
            <p><strong>Henk van Ess</strong> — an internationally recognized OSINT (Open Source Intelligence) expert, journalist trainer, and tool builder based in the Netherlands. Assessor for the International Fact-Checking Network (IFCN) and European Fact-Checking Standards Network (EFCSN). Early Bellingcat contributor. Author of a CHI 2026 peer-reviewed paper on the "Think Like a Document" methodology.</p>
            <p><strong>He does not write code.</strong> Every line of FlipSide — 2,615 lines of Python backend and 6,145 lines of frontend — was built through conversation with Claude Opus 4.6 in one weekend. The prompts were the product. The AI was the builder.</p>
            <p>Previous open-source tools: <a href="https://imagewhisperer.online" target="_blank" rel="noopener" style="color:var(--accent)">ImageWhisperer</a>, SearchWhisperer, AI Whisperer.</p>
        </div>

        <hr class="faq-divider">

        <!-- ── The Fair Clause ── -->
        <div class="faq-section" id="faq-fair-clause">
            <div class="fair-clause-card">
                <h3>The FlipSide Fair Clause</h3>
                <span class="fair-clause-badge">SCORE 0/100 &middot; NO TRICKS DETECTED &middot; WRITTEN BY OPUS 4.6</span>
                <p class="fair-clause-intro">We asked Claude Opus 4.6 with extended thinking: "Write the fairest possible service agreement clause. Every provision must be symmetrical — what applies to the customer must equally apply to the company. Show your reasoning for each section." This is what it wrote.</p>

                <div class="fair-clause-section">
                    <h4>1. What we promise each other.</h4>
                    <p>We will provide the service as described at the time you signed up. If we need to change what's included, we will notify you 30 days in advance, and you may cancel without penalty if you disagree. You agree to use the service in good faith and pay the agreed amount on time. If your payment fails, we will notify you and give you 14 days to resolve it. No late fees. No penalties. No collection agencies.</p>
                    <div class="fair-clause-reasoning">Opus reasoning: Most service agreements give the provider unlimited discretion to change terms while locking the customer into the original price. Symmetry means both parties get the same notice period and the same exit rights when terms change.</div>
                </div>

                <div class="fair-clause-section">
                    <h4>2. Either of us can leave.</h4>
                    <p>You may cancel at any time. We may cancel with 30 days' written notice. If you have paid in advance, you will receive a prorated refund for the unused period. No cancellation fees. No early termination penalties. No "retention department" calls.</p>
                    <div class="fair-clause-reasoning">Opus reasoning: The most common trick in consumer contracts is asymmetric exit — the company can terminate immediately "for any reason" while the customer faces penalties, lockout periods, or forfeiture of prepaid amounts. Fair means equal exits.</div>
                </div>

                <div class="fair-clause-section">
                    <h4>3. If something goes wrong.</h4>
                    <p>If the service fails, we will work to restore it within 48 hours and credit you for the downtime. If we cause you measurable financial harm through negligence, our liability is capped at 12 months of fees you have paid — and the same cap applies to your liability to us. Neither party is liable for circumstances beyond their control.</p>
                    <div class="fair-clause-reasoning">Opus reasoning: Typical agreements cap the company's liability at "fees paid in the last month" while leaving the customer's liability unlimited. A fair cap is symmetrical and substantial enough to be meaningful — 12 months, not 1.</div>
                </div>

                <div class="fair-clause-section">
                    <h4>4. Disagreements.</h4>
                    <p>We will first attempt to resolve any dispute through direct conversation. If that fails, we will use mediation with a mutually agreed mediator, splitting the cost equally. If mediation fails, either party may pursue resolution in the courts of their own jurisdiction. No forced arbitration. No class action waivers. No "prevailing party pays attorneys' fees" clauses that discourage small claims.</p>
                    <div class="fair-clause-reasoning">Opus reasoning: Forced arbitration with a company-selected arbitrator in a company-chosen jurisdiction is the single most powerful trick in consumer contracts. It eliminates your practical ability to dispute anything. Fair means you choose your own forum.</div>
                </div>

                <div class="fair-clause-section">
                    <h4>5. Your content stays yours.</h4>
                    <p>Anything you create, upload, or store using the service belongs to you. We may use it only to provide you the service. We will not sell it, license it, or use it for training, advertising, or any purpose beyond delivering what you asked for. When you leave, you may export your data at any time, and we will delete our copies within 30 days.</p>
                    <div class="fair-clause-reasoning">Opus reasoning: "Content Grab" is the second most common trick — buried in ToS, you grant a "worldwide, irrevocable, perpetual license" to everything you upload. Fair means your data is yours, period. The company is a custodian, not an owner.</div>
                </div>

                <div class="fair-clause-section">
                    <h4>6. Changes to this agreement.</h4>
                    <p>We may update these terms. For minor clarifications, we will post the update and notify you. For material changes — anything affecting price, service scope, your rights, or dispute resolution — we will notify you 30 days in advance and require your explicit consent. If you do not consent, you may leave with a full refund of any prepaid amounts. We will never interpret continued use as acceptance of material changes.</p>
                    <div class="fair-clause-reasoning">Opus reasoning: "Continued use constitutes acceptance" is how companies unilaterally rewrite the deal after you've signed. Fair means material changes require your actual agreement — not your silence.</div>
                </div>

                <div class="fair-clause-section">
                    <h4>7. Plain language guarantee.</h4>
                    <p>This agreement is written in plain language because we believe you should understand what you're agreeing to. If any provision is ambiguous, it will be interpreted in favor of the party who did not draft it — which, in this case, is you.</p>
                    <div class="fair-clause-reasoning">Opus reasoning: The legal doctrine of contra proferentem (interpret against the drafter) exists precisely because the drafter chose the words. Making this explicit signals good faith and removes the incentive to write deliberately vague provisions.</div>
                </div>

                <div class="fair-clause-score">
                    <svg class="fair-clause-score-ring" viewBox="0 0 36 36">
                        <circle cx="18" cy="18" r="15.9" fill="none" stroke="var(--green-border)" stroke-width="2"/>
                        <circle cx="18" cy="18" r="15.9" fill="none" stroke="var(--green)" stroke-width="2.5" stroke-dasharray="100, 100" stroke-dashoffset="100" stroke-linecap="round" transform="rotate(-90 18 18)"/>
                        <text x="18" y="19.5" text-anchor="middle" font-size="9" font-weight="700" font-family="JetBrains Mono, monospace" fill="var(--green-text)">0</text>
                    </svg>
                    FlipSide Risk Score: 0/100 &middot; Power Ratio: 1:1 &middot; Tricks detected: none
                </div>
                <div class="fair-clause-footer">
                    This clause was generated by Claude Opus 4.6 with extended thinking (adaptive mode). It is not legal advice — it is what a fair agreement looks like when both sides can see. Use it as a benchmark: the further a real contract deviates from these principles, the more questions you should ask.
                </div>
            </div>
        </div>

    </div>
    <!-- end faq-wrapper -->

    </div>
    <!-- end upload-main -->
</section>

<!-- ═══════════════════════════════════════════════════════
     SCREEN 2/3: ANALYSIS
     ═══════════════════════════════════════════════════════ -->
<section id="analysis-screen" class="hidden">
    <header class="analysis-header">
        <div class="header-left">
            <span class="header-brand" id="headerBrand">FlipSide</span>
            <button class="header-btn hidden" id="copyAllBtn">Copy all</button>
            <button class="header-btn hidden" id="emailLawyerBtn">Email to Lawyer</button>
            <button class="header-btn hidden" id="exportBtn">Save Report</button>
            <button class="header-btn hidden" id="exportLangBtn" title="Download report in document language"></button>
            <button class="header-btn" id="darkModeBtn" title="Toggle dark mode">&#9790;</button>
            <button class="header-btn home-btn" id="backBtn" title="Back to home"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg></button>
        </div>
        <div class="header-right">
            <span class="capability-ticker hidden" id="capabilityTicker"></span>
            <div class="status-pill" id="statusPill">
                <span class="status-dot"></span>
                <span id="statusText">Starting analysis...</span>
                <span class="elapsed-time" id="elapsedTime"></span>
            </div>
            <span class="model-badge">Opus 4.6 + Haiku 4.5</span>
            <button class="header-overflow-btn" id="headerOverflowBtn" title="More actions">&#8943;</button>
            <div class="header-overflow-menu hidden" id="headerOverflowMenu">
                <button data-action="copy" class="hidden">Copy all</button>
                <button data-action="email" class="hidden">Email to Lawyer</button>
                <button data-action="export" class="hidden">Save Report</button>
                <button data-action="exportLang" class="hidden"></button>
            </div>
        </div>
    </header>

    <div class="analysis-layout">
    <!-- Left sidebar: document profile + preview (stays on screen) -->
    <aside class="analysis-sidebar hidden" id="analysisSidebar">
        <div class="sidebar-profile" id="sidebarProfile">
            <div class="doc-thumbnail hidden" id="docThumbnail">
                <img id="docThumbnailImg" alt="Document page 1">
            </div>
            <div class="metadata-line hidden" id="metadataLine"></div>
        </div>
        <div class="editorial-loading hidden" id="editorialLoading">
            <div class="editorial-loading-label">What the small print says</div>
            <div class="editorial-loading-text" id="editorialLoadingText"></div>
            <div class="editorial-loading-indicator">
                <span class="pulsing-dots"><span></span><span></span><span></span></span>
                <span class="editorial-loading-status" id="editorialLoadingStatus">FlipSide is reading between the lines...</span>
            </div>
        </div>
    </aside>

    <!-- Main content: cards + analysis -->
    <div class="content-col">

        <!-- Card viewport: one card at a time -->
        <div class="card-viewport hidden" id="cardViewport">
            <!-- Skeleton card: mimics a real flip card while waiting for first clause -->
            <div class="skeleton-card hidden" id="skeletonCard">
                <div class="risk-header risk-header-green" style="opacity:0.5">
                    <span class="risk-header-label" style="color:var(--green-text)">You think that</span>
                    <div class="skeleton-pulse" style="height:1.2rem;width:70%;border-radius:6px"></div>
                </div>
                <div class="skeleton-pulses">
                    <div class="skeleton-pulse skeleton-section"></div>
                    <div class="skeleton-pulse skeleton-reader"></div>
                    <div class="skeleton-pulse skeleton-reader-short"></div>
                    <div class="skeleton-pulse skeleton-reader" style="width:70%"></div>
                </div>
                <div class="skeleton-waiting" id="skeletonMessage">
                    <span class="pulsing-dots"><span></span><span></span><span></span></span>
                    Waiting for first clause to be flipped
                </div>
            </div>
            <div id="flipCardContainer"></div>
            <nav class="card-navigation hidden" id="cardNavigation">
                <button class="card-nav-btn card-nav-prev" disabled>
                    <span>&larr;</span> <span>Previous</span>
                </button>
                <span class="card-nav-counter">Clause <strong>1</strong> of <strong>1</strong></span>
                <button class="card-nav-btn card-nav-next">
                    <span class="card-nav-next-label">Next clause &rarr;</span>
                </button>
            </nav>
            <div class="card-nav-dots" id="cardNavDots"></div>
            <div class="chapter-title" id="chapterTitle">
                <span class="chapter-title-counter" id="chapterCounter"></span>
                <span class="chapter-title-text" id="chapterText"></span>
            </div>
            <div class="deep-status hidden" id="deepStatus">
                <span class="pulsing-dots"><span></span><span></span><span></span></span>
                <span id="deepStatusText">Opus 4.6 is building your Full Verdict...</span>
            </div>
        </div>

        <!-- Results: summary + deep analysis (compare mode uses resultsContent) -->
        <div class="results-area hidden" id="resultsArea">
            <div id="resultsContent"></div>
            <div id="deepAnalysisSection" class="hidden">
                <button class="back-to-cards-btn" id="backToCardsBtn">&larr; Back to clauses</button>
                <div id="summaryContainer"></div>
                <div id="filterChips" class="filter-chips hidden"></div>
                <div id="deepAnalysisContent"></div>
                <div class="counter-draft-section hidden" id="counterDraftSection">
                    <hr class="editorial-divider">
                    <div class="section-label" style="margin-bottom:1rem">Go deeper</div>
                    <div style="display:flex;gap:0.7rem;flex-wrap:wrap">
                        <button class="counter-draft-btn" id="timelineBtn">Worst-Case Timeline</button>
                        <button class="counter-draft-btn" id="counterDraftBtn">Generate Counter-Draft</button>
                    </div>
                    <div id="timelineContent"></div>
                    <div id="counterDraftContent"></div>
                </div>
                <div class="followup-section hidden" id="followupSection">
                    <hr class="editorial-divider">
                    <div class="section-label" style="margin-bottom:1rem">Ask about this document</div>
                    <div class="followup-input-row">
                        <textarea class="followup-input" id="followupInput" placeholder="What happens if I'm 3 days late on rent?" rows="1"></textarea>
                        <button class="followup-send" id="followupSend">Ask</button>
                    </div>
                    <div id="followupAnswers"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Right column: live Opus expert report -->
    <aside class="verdict-col" id="verdictCol">
        <div class="verdict-header">
            <span class="verdict-dot"></span>
            <span class="verdict-title" id="verdictTitle">Expert report</span>
            <button class="verdict-expand-btn" id="verdictExpandBtn" style="opacity:0.4;pointer-events:none;">0 of 4 ready</button>
        </div>
        <div class="verdict-body" id="verdictBody">
            <div class="verdict-doc-profile hidden" id="verdictDocProfile">
                <div class="verdict-doc-thumb hidden" id="verdictDocThumb">
                    <img id="verdictDocThumbImg" alt="Document">
                </div>
                <div class="verdict-doc-meta" id="verdictDocMeta"></div>
            </div>
            <div class="verdict-invitation" id="verdictInvitation">You're invited to look over our expert's shoulder while they check claims one by one. Flip the card to find the dark side of the small print.</div>
            <div class="verdict-status" id="verdictStatus">Our expert is reading the small print <span class="verdict-time-pill" id="verdictCountdown">2:00</span></div>
            <div class="verdict-tricks hidden" id="verdictTricks">
                <div class="verdict-tricks-title">Tricks detected</div>
                <div class="verdict-tricks-list" id="verdictTricksList"></div>
            </div>
            <div class="verdict-summary" id="verdictSummary"></div>
            <div class="opus-section locked" id="opusSection_interactions" data-source="interactions">
                <div class="opus-section-header" data-toggle="interactions">
                    <span class="opus-dot pulsing"></span>
                    <span class="opus-section-title">Cross-Clause Interactions</span>
                </div>
                <div class="opus-section-body collapsed" id="opusBody_interactions"></div>
            </div>
            <div class="opus-section locked" id="opusSection_asymmetry" data-source="asymmetry">
                <div class="opus-section-header" data-toggle="asymmetry">
                    <span class="opus-dot pulsing"></span>
                    <span class="opus-section-title">Power Asymmetry &amp; Fair Standard</span>
                </div>
                <div class="opus-section-body collapsed" id="opusBody_asymmetry"></div>
            </div>
            <div class="opus-section locked" id="opusSection_archaeology" data-source="archaeology">
                <div class="opus-section-header" data-toggle="archaeology">
                    <span class="opus-dot pulsing"></span>
                    <span class="opus-section-title">Document Archaeology &amp; Drafter</span>
                </div>
                <div class="opus-section-body collapsed" id="opusBody_archaeology"></div>
            </div>
            <div class="opus-section locked" id="opusSection_overall" data-source="overall">
                <div class="opus-section-header" data-toggle="overall">
                    <span class="opus-dot pulsing"></span>
                    <span class="opus-section-title">Overall Assessment</span>
                </div>
                <div class="opus-section-body collapsed" id="opusBody_overall"></div>
            </div>
            <!-- Focused reading panel (replaces section list when user clicks a completed section) -->
            <div class="verdict-focused-panel" id="verdictFocusedPanel">
                <div class="verdict-focused-nav">
                    <button class="verdict-focused-nav-btn" id="focusedClose" title="Back to overview">&larr; Back</button>
                    <span class="verdict-focused-counter" id="focusedCounter"></span>
                    <button class="verdict-focused-nav-btn" id="focusedPrev">&uarr;</button>
                    <button class="verdict-focused-nav-btn" id="focusedNext">&darr;</button>
                </div>
                <div class="verdict-focused-title" id="focusedTitle"></div>
                <div class="verdict-focused-content" id="focusedContent"></div>
            </div>
        </div>
    </aside>

    </div><!-- /analysis-layout -->
</section>

<script>
// ═══════════════════════════════════════════════════════════════
// FlipSide Frontend — Thinking is the product
// ═══════════════════════════════════════════════════════════════

(function () {
    'use strict';

    // ── Constants ──────────────────────────────────────────────
    var TRICK_ICONS = {
        'Silent Waiver': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6L6 18"/><path d="M6 6l12 12"/></svg>',
        'Burden Shift': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3v18"/><path d="M5 8l7-5 7 5"/><path d="M5 16h14"/></svg>',
        'Time Trap': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>',
        'Escape Hatch': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>',
        'Moving Target': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>',
        'Forced Arena': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 22h18"/><path d="M6 18V11"/><path d="M10 18V11"/><path d="M14 18V11"/><path d="M18 18V11"/><path d="M4 7h16l-8-5z"/></svg>',
        'Phantom Protection': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="M9 12l2 2 4-4" stroke-dasharray="2 2"/></svg>',
        'Cascade Clause': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v6"/><path d="M8 10h8"/><path d="M6 14l6-4 6 4"/><path d="M4 18l8-4 8 4"/><path d="M2 22l10-4 10 4"/></svg>',
        'Sole Discretion': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L9 9H2l6 4.5L5.5 21 12 16.5 18.5 21 16 13.5 22 9h-7z"/></svg>',
        'Liability Cap': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="M8 12h8"/></svg>',
        'Reverse Shield': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>',
        'Auto-Lock': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>',
        'Content Grab': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.83 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5z"/></svg>',
        'Data Drain': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>',
        'Penalty Disguise': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 8c-2.2 0-4 1.3-4 3 0 2.5 4 3.5 4 6"/><circle cx="12" cy="20" r="0.5" fill="currentColor"/><circle cx="12" cy="12" r="10"/></svg>',
        'Gag Clause': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9 9h.01"/><path d="M15 9h.01"/><path d="M8 15h8"/><circle cx="12" cy="12" r="10"/></svg>',
        'Scope Creep': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="2"/><path d="M12 2a10 10 0 0 1 7.07 2.93"/><path d="M12 2a10 10 0 0 0-7.07 2.93"/><path d="M2 12a10 10 0 0 1 2.93-7.07"/><path d="M22 12a10 10 0 0 0-2.93-7.07"/></svg>',
        'Ghost Standard': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><path d="M9 15h.01"/><path d="M12 15h.01"/><path d="M15 15h.01"/></svg>'
    };
    // Backward compat — emoji fallback

    // ── Document type category icons (from demo tiles) ───
    var DOC_TYPE_ICONS = [
        { keys: ['lease', 'rental', 'tenant', 'landlord', 'residential lease'], label: 'Lease',
          svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="8" cy="15" r="5.5"/><path d="M12 11l9-9"/><path d="M17 6l4-4"/><path d="M18.5 7.5L22 7l-3-3"/></svg>' },
        { keys: ['insurance', 'coverage', 'policy', 'policyholder', 'underwriting'], label: 'Insurance',
          svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>' },
        { keys: ['terms of service', 'terms of use', 'user agreement', 'privacy policy', 'tos', 'eula'], label: 'Terms of Service',
          svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><path d="M16 13H8"/><path d="M16 17H8"/><path d="M10 9H8"/></svg>' },
        { keys: ['employment', 'offer letter', 'job', 'non-compete', 'noncompete', 'severance', 'work contract'], label: 'Employment',
          svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>' },
        { keys: ['loan', 'mortgage', 'credit', 'lending', 'promissory', 'financing'], label: 'Loan',
          svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 22h18"/><path d="M6 18V11"/><path d="M10 18V11"/><path d="M14 18V11"/><path d="M18 18V11"/><path d="M4 7h16l-8-5z"/></svg>' },
        { keys: ['gym', 'fitness', 'membership', 'health club', 'workout'], label: 'Gym',
          svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="17 1 21 5 17 9"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><polyline points="7 23 3 19 7 15"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/></svg>' },
        { keys: ['medical', 'patient', 'consent', 'hipaa', 'treatment', 'procedure', 'healthcare', 'hospital'], label: 'Medical',
          svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1"/></svg>' },
        { keys: ['hoa', 'homeowner association', 'bylaws', 'covenants', 'cc&r', 'community rules'], label: 'HOA',
          svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>' },
        { keys: ['wedding', 'venue', 'event', 'catering', 'reception'], label: 'Event Venue',
          svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M8 21h8"/><path d="M12 17v4"/><path d="M7 4V2"/><path d="M17 4V2"/><path d="M5 4h14a2 2 0 0 1 2 2v4a7 7 0 0 1-14 0V6a2 2 0 0 1 2-2z"/></svg>' },
        { keys: ['coupon', 'discount', 'reward', 'loyalty', 'voucher', 'promo'], label: 'Coupon',
          svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><circle cx="7" cy="7" r="1.5"/></svg>' },
        { keys: ['sweepstakes', 'contest', 'giveaway', 'raffle', 'lottery', 'prize', 'official rules'], label: 'Sweepstakes',
          svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M2 12h20"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>' },
        { keys: ['pet', 'adoption', 'animal', 'shelter', 'veterinary'], label: 'Pet Adoption',
          svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="4" r="2"/><circle cx="4.5" cy="9" r="2"/><circle cx="17.5" cy="9" r="2"/><circle cx="8" cy="14" r="2"/><circle cx="16" cy="14" r="2"/><path d="M12 18c-2.5 2-6 2-6-.5C6 15 9 14 12 17c3-3 6-2 6 .5 0 2.5-3.5 2.5-6 .5z"/></svg>' },
        { keys: ['timeshare', 'vacation', 'resort', 'fractional ownership'], label: 'Timeshare',
          svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>' },
        { keys: ['hackathon', 'waiver', 'liability waiver', 'participation', 'indemnity'], label: 'Waiver',
          svg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L9 9l-7 1 5 5-1.5 7L12 18l6.5 4L17 15l5-5-7-1z"/></svg>' }
    ];

    function detectDocIcon(typeStr) {
        if (!typeStr) return null;
        var lower = typeStr.toLowerCase();
        for (var i = 0; i < DOC_TYPE_ICONS.length; i++) {
            var cat = DOC_TYPE_ICONS[i];
            for (var j = 0; j < cat.keys.length; j++) {
                if (lower.indexOf(cat.keys[j]) >= 0) return cat;
            }
        }
        return null;
    }

    var TRICK_DESCRIPTIONS = {
        'Silent Waiver': 'Quietly surrenders your legal rights',
        'Burden Shift': 'Moves proof/action duty onto you',
        'Time Trap': 'Tight deadlines that forfeit your rights',
        'Escape Hatch': 'Drafter can exit, you cannot',
        'Moving Target': 'Terms can change after you agree',
        'Forced Arena': 'Disputes in drafter\'s chosen forum',
        'Phantom Protection': 'Broad coverage eaten by exceptions',
        'Cascade Clause': 'One trigger activates multiple penalties',
        'Sole Discretion': 'Drafter decides everything, no appeal',
        'Liability Cap': 'Limits payout regardless of harm',
        'Reverse Shield': 'You cover their costs, not vice versa',
        'Auto-Lock': 'Auto-renewal with hard cancellation',
        'Content Grab': 'Claims rights over your content/work',
        'Data Drain': 'Expansive hidden data permissions',
        'Penalty Disguise': 'Punitive charges disguised as fees',
        'Gag Clause': 'Prohibits negative reviews or discussion',
        'Scope Creep': 'Vague terms stretch beyond expectations',
        'Ghost Standard': 'References external docs not included'
    };

    var STATUS_MESSAGES = {
        thinking: [
            "Adopting the drafter's perspective...",
            "Reading between the lines...",
            "Tracing cross-references...",
            "Mapping strategic architecture...",
            "Identifying asymmetric language..."
        ],
        clauses: [
            "Analyzing clause by clause...",
            "Flagging strategic language...",
            "Scoring risk levels..."
        ],
        deep: [
            "Analyzing cross-clause interactions...",
            "Revealing the drafter's playbook...",
            "Measuring power imbalance...",
            "Full Verdict coming soon..."
        ]
    };

    // ── Base URL (supports reverse proxy prefix like /flipside) ──
    var BASE_URL = {{ request.script_root | tojson }};

    // ── State ─────────────────────────────────────────────────
    var selectedFile = null;
    var compareFile1 = null, compareFile2 = null;
    var analysisDepth = 'standard';
    var isCompareMode = false;
    var eventSource = null;
    var thinkingContent = '';
    var responseContent = '';
    var renderTimeout = null;
    var thinkingPhaseCount = 0;
    var quickDone = false;
    var analysisStartTime = 0;
    var elapsedInterval = null;
    var statusRotateInterval = null;
    var currentStatusIdx = 0;
    var isDoneRendering = false;
    var deepTextComplete = false;  // Set when all Opus threads complete
    var animatedCardTitles = new Set();
    var activeFilters = new Set(); // 'red', 'yellow', 'green'
    var activeTrickFilters = new Set(); // trick type names
    var documentFullText = '';
    var documentThumbnail = null;
    var currentDocId = '';
    var userHasScrolled = false;
    var lastAutoScrollY = 0;
    var flipCardsBuilt = false;
    var parsedClauseCount = 0;   // How many --- segments we've already parsed
    var currentCardIndex = 0;    // Which card is currently shown
    var hasFlippedOnce = false;  // Force first flip before allowing navigation
    var cardViewTransitioned = false; // Whether we've transitioned from loading to cards
    var editorialStatusInterval = null;
    var editorialStatusIdx = 0;
    var _detectedTricks = {};  // Live trick accumulator: { trickName: count }

    // ── Elements ──────────────────────────────────────────────
    var $ = function(id) { return document.getElementById(id); };

    // Screens
    var uploadScreen   = $('upload-screen');
    var analysisScreen = $('analysis-screen');

    // Upload elements
    var dropZone       = $('dropZone');
    var fileInput      = $('fileInput');
    var uploadPrompt   = $('uploadPrompt');
    var fileInfo       = $('fileInfo');
    var fileNameEl     = $('fileName');
    var fileSizeEl     = $('fileSize');
    var fileRemove     = $('fileRemove');
    var pasteArea      = $('pasteArea');
    var pasteToggle    = $('pasteToggle');
    var analyzeBtn     = $('analyzeBtn');
    var uploadError    = $('uploadError');
    var demoGridSection = $('demoGridSection');
    var compareToggle  = $('compareToggle');
    var depthSelector  = $('depthSelector');

    // Analysis elements
    var statusPill     = $('statusPill');
    var statusText     = $('statusText');
    var elapsedEl      = $('elapsedTime');
    var backBtn        = $('backBtn');
    var metadataLine   = $('metadataLine');
    var editorialLoading = $('editorialLoading');
    var capTicker      = $('capabilityTicker');

    // ── Capability ticker: shows what Opus is doing live ──
    var capTickerInterval = null;
    var capTickerIndex = 0;
    var thinkingCharCount = 0;
    var outputCharCount = 0;
    var HAIKU_MESSAGES = [
        { label: 'QUICK SCAN', text: 'Haiku 4.5 reading every clause for trick patterns' },
        { label: 'PATTERN MATCH', text: 'Comparing against 18-type trick taxonomy' },
        { label: 'CLAUSE ISOLATION', text: 'Splitting document into individual obligations' },
        { label: 'RISK RATING', text: 'Scoring severity per clause on 5-point scale' },
    ];
    var OPUS_MESSAGES = [
        { label: 'ADAPTIVE THINKING', text: 'Opus decides reasoning depth per clause' },
        { label: 'LONG-CONTEXT', text: 'Tracing cross-clause interactions across full document' },
        { label: 'PERSPECTIVE SHIFT', text: 'Adopting drafter\u2019s viewpoint to find hidden intent' },
        { label: 'SELF-REVIEW', text: 'Checking own findings for false positives' },
        { label: 'BAD INTENTIONS', text: 'Low over-refusal \u2014 Opus sustains adversarial framing' },
        { label: 'POWER ASYMMETRY', text: 'Counting rights and obligations per party' },
        { label: 'ARCHAEOLOGY', text: 'Separating boilerplate from custom-drafted clauses' },
    ];
    var CAPABILITY_MESSAGES = HAIKU_MESSAGES;
    function startCapTicker(messages) {
        if (messages) CAPABILITY_MESSAGES = messages;
        capTicker.classList.remove('hidden');
        capTickerIndex = 0;
        showCapMessage();
        stopCapTicker();
        capTickerInterval = setInterval(function() {
            capTicker.classList.add('fade-swap');
            setTimeout(function() {
                capTickerIndex = (capTickerIndex + 1) % CAPABILITY_MESSAGES.length;
                showCapMessage();
                capTicker.classList.remove('fade-swap');
            }, 300);
        }, 3500);
    }
    function showCapMessage() {
        var m = CAPABILITY_MESSAGES[capTickerIndex];
        capTicker.innerHTML = '<span class="cap-label">' + m.label + '</span> ' + m.text;
    }
    function stopCapTicker() {
        if (capTickerInterval) { clearInterval(capTickerInterval); capTickerInterval = null; }
    }
    function showCapStats() {
        stopCapTicker();
        // Approximate tokens (~4 chars per token)
        var thinkTokens = Math.round(thinkingCharCount / 4);
        var outTokens = Math.round(outputCharCount / 4);
        var ratio = outTokens > 0 ? (thinkTokens / outTokens).toFixed(1) : '?';
        capTicker.classList.remove('fade-swap');
        capTicker.innerHTML = '<span class="stat-num">~' + thinkTokens.toLocaleString() + '</span> reasoning tokens \u00B7 <span class="stat-num">' + ratio + '\u00d7</span> more thinking than output';
        capTicker.className = 'capability-stats';
    }
    var resultsArea    = $('resultsArea');
    var summaryContainer = $('summaryContainer');
    var filterChips    = $('filterChips');
    var resultsContent = $('resultsContent');
    var flipCardContainer = $('flipCardContainer');
    var deepAnalysisEl = $('deepAnalysisContent');
    var counterDraftSection = $('counterDraftSection');
    var counterDraftBtn = $('counterDraftBtn');
    var counterDraftContent = $('counterDraftContent');
    var timelineBtn = $('timelineBtn');
    var timelineContent = $('timelineContent');
    var followupSection = $('followupSection');
    var followupInput = $('followupInput');
    var followupSend = $('followupSend');
    var followupAnswers = $('followupAnswers');

    // Verdict column (right side panel)
    var verdictCol       = $('verdictCol');
    var verdictTitle     = $('verdictTitle');
    var verdictBody      = $('verdictBody');
    var verdictExpandBtn = $('verdictExpandBtn');
    var _verdictRenderTimers = {};
    var _verdictAutoScroll = true;
    var _verdictCountdownInterval = null;
    var _verdictCountdownSec = 120;

    function startVerdictCountdown() {
        stopVerdictCountdown();
        _verdictCountdownSec = 120;
        var el = $('verdictCountdown');
        if (el) el.textContent = '2:00';
        _verdictCountdownInterval = setInterval(function() {
            _verdictCountdownSec--;
            if (_verdictCountdownSec <= 0) {
                stopVerdictCountdown();
                if (el) el.textContent = 'almost done';
                return;
            }
            var m = Math.floor(_verdictCountdownSec / 60);
            var s = _verdictCountdownSec % 60;
            if (el) el.textContent = m + ':' + (s < 10 ? '0' : '') + s;
        }, 1000);
    }

    function stopVerdictCountdown() {
        if (_verdictCountdownInterval) {
            clearInterval(_verdictCountdownInterval);
            _verdictCountdownInterval = null;
        }
    }
    // 4 Opus section accumulators
    var opusSections = {
        interactions: { text: '', done: false },
        asymmetry: { text: '', done: false },
        archaeology: { text: '', done: false },
        overall: { text: '', done: false }
    };


    // Configure marked + DOMPurify for safe LLM output rendering
    marked.setOptions({ breaks: true, gfm: true });
    function safeMd2Html(md) {
        return DOMPurify.sanitize(marked.parse(md));
    }
    function safeHtml(html) {
        // Re-sanitize after post-DOMPurify regex transforms (style functions)
        return DOMPurify.sanitize(html);
    }

    // ── Event delegation for flip cards + card navigation ──
    document.querySelector('.content-col').addEventListener('click', function(e) {
        var flipTrigger = e.target.closest('.flip-trigger');
        if (flipTrigger) {
            var card = flipTrigger.closest('.flip-card');
            if (card) {
                // Back is already built by Haiku — just flip
                requestAnimationFrame(function() {
                    card.classList.add('flipped');
                    // Dim side columns to focus on the reveal
                    var layout = card.closest('.analysis-layout');
                    if (layout) layout.classList.add('layout-flipped');
                    // Animate score bar fill on flip
                    var fill = card.querySelector('.back-score-bar-fill');
                    if (fill && !fill.style.width) {
                        var w = fill.getAttribute('data-width');
                        setTimeout(function() { fill.style.width = w + '%'; }, 300);
                    }
                });
                // First flip unlocks navigation (immediate, no need to defer)
                if (!hasFlippedOnce) {
                    hasFlippedOnce = true;
                    updateCardNavigation();
                    document.querySelectorAll('.flip-trigger.hint-pulse').forEach(function(el) {
                        el.classList.remove('hint-pulse');
                    });
                    document.querySelectorAll('.flip-hint-tooltip').forEach(function(el) {
                        el.remove();
                    });
                    // Show verdict column now that user has discovered the flip
                    if (!verdictCol.classList.contains('visible') && !isCompareMode && !documentNotApplicable) {
                        showVerdictCol();
                    }
                }
            }
            return;
        }
        var flipBack = e.target.closest('.flip-back-trigger');
        if (flipBack) {
            var card = flipBack.closest('.flip-card');
            if (card) {
                card.classList.remove('flipped');
                // Restore side columns
                var layout = card.closest('.analysis-layout');
                if (layout) layout.classList.remove('layout-flipped');
            }
            return;
        }
        var findInDoc = e.target.closest('.find-in-doc');
        if (findInDoc) {
            var cardIdx = parseInt(findInDoc.getAttribute('data-card-index'));
            if (!isNaN(cardIdx)) {
                scrollPreviewToCard(cardIdx);
                // On mobile (sidebar stacked above), scroll page to the preview
                var previewEl = $('editorialLoadingText');
                if (previewEl && window.innerWidth <= 900) {
                    previewEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
            return;
        }
        var navPrev = e.target.closest('.card-nav-prev');
        if (navPrev && !navPrev.disabled) {
            showCardAtIndex(currentCardIndex - 1);
            return;
        }
        var navNext = e.target.closest('.card-nav-next');
        if (navNext && !navNext.disabled) {
            if (navNext.getAttribute('data-action') === 'assessment') {
                revealDeepAnalysis();
            } else {
                showCardAtIndex(currentCardIndex + 1);
            }
            return;
        }
        // verdict-link buttons removed — verdict now triggered via card navigation only
    });

    // ── Click clause marker in preview → navigate to that card ──
    $('editorialLoadingText').addEventListener('click', function(e) {
        var highlight = e.target.closest('.doc-highlight');
        if (highlight) {
            var idx = parseInt(highlight.getAttribute('data-card-index'));
            if (!isNaN(idx) && flipCardContainer.querySelectorAll('.flip-card').length > idx) {
                showCardAtIndex(idx);
            }
        }
    });

    // ── Keyboard navigation ──
    document.addEventListener('keydown', function(e) {
        if (analysisScreen.classList.contains('hidden')) return;
        // Don't capture keys when user is typing in an input/textarea
        var ae = document.activeElement;
        if (ae && (ae.tagName === 'INPUT' || ae.tagName === 'TEXTAREA' || ae.isContentEditable)) return;
        var viewport = $('cardViewport');
        if (!viewport || viewport.classList.contains('hidden')) return;
        var cards = flipCardContainer.querySelectorAll('.flip-card');
        if (cards.length === 0) return;

        switch(e.key) {
            case 'ArrowLeft':
                if (currentCardIndex > 0) {
                    e.preventDefault();
                    showCardAtIndex(currentCardIndex - 1);
                }
                break;
            case 'ArrowRight':
                if (currentCardIndex < cards.length - 1) {
                    e.preventDefault();
                    showCardAtIndex(currentCardIndex + 1);
                }
                break;
            case ' ':
            case 'Enter':
                e.preventDefault();
                if (cards[currentCardIndex]) {
                    cards[currentCardIndex].classList.toggle('flipped');
                    var kbLayout = flipCardContainer.closest('.analysis-layout');
                    if (cards[currentCardIndex].classList.contains('flipped')) {
                        if (kbLayout) kbLayout.classList.add('layout-flipped');
                        // Animate score bar on flip
                        var fill = cards[currentCardIndex].querySelector('.back-score-bar-fill');
                        if (fill && !fill.style.width) {
                            var w = fill.getAttribute('data-width');
                            setTimeout(function() { fill.style.width = w + '%'; }, 300);
                        }
                        if (!hasFlippedOnce) {
                            hasFlippedOnce = true;
                            updateCardNavigation();
                            // Show verdict column on keyboard flip too
                            if (!verdictCol.classList.contains('visible') && !isCompareMode && !documentNotApplicable) {
                                showVerdictCol();
                            }
                        }
                    } else {
                        if (kbLayout) kbLayout.classList.remove('layout-flipped');
                    }
                }
                break;
            default:
                // Number keys 1-9 → jump to that card
                var num = parseInt(e.key);
                if (num >= 1 && num <= 9 && num <= cards.length) {
                    e.preventDefault();
                    showCardAtIndex(num - 1);
                }
                break;
        }
    });

    // ── Mobile: Bottom sheet for verdict (Phase 2) ──────────────
    (function() {
        var vc = $('verdictCol');
        if (!vc) return;
        var sheetState = 'peek'; // peek | half | full
        var startY = 0, startTime = 0, currentY = 0, isDragging = false;

        function setSheetState(state) {
            sheetState = state;
            vc.classList.remove('sheet-half', 'sheet-full');
            if (state === 'half') vc.classList.add('sheet-half');
            else if (state === 'full') vc.classList.add('sheet-full');
            if (state === 'full') {
                document.body.classList.add('sheet-open');
            } else {
                document.body.classList.remove('sheet-open');
            }
        }
        // Make setSheetState available globally for showVerdictCol
        window._setSheetState = setSheetState;
        window._getSheetState = function() { return sheetState; };

        var header = vc.querySelector('.verdict-header');
        if (header) {
            header.addEventListener('touchstart', function(e) {
                startY = e.touches[0].clientY;
                startTime = Date.now();
                isDragging = true;
                vc.style.transition = 'none';
            }, {passive: true});

            header.addEventListener('touchmove', function(e) {
                if (!isDragging) return;
                currentY = e.touches[0].clientY;
                var dy = currentY - startY;
                // Apply drag transform as offset from current state
                var baseTranslate;
                if (sheetState === 'peek') baseTranslate = 'calc(100% - 52px)';
                else if (sheetState === 'half') baseTranslate = '60%';
                else baseTranslate = '10%';
                // Use a simple pixel offset from current position
                if (dy !== 0) {
                    vc.style.transform = 'translateY(calc(' + baseTranslate + ' + ' + dy + 'px))';
                }
            }, {passive: true});

            header.addEventListener('touchend', function() {
                if (!isDragging) return;
                isDragging = false;
                vc.style.transition = '';
                vc.style.transform = '';
                var dy = currentY - startY;
                var threshold = 80;
                if (dy < -threshold) {
                    // Swipe up → advance state
                    if (sheetState === 'peek') setSheetState('half');
                    else if (sheetState === 'half') setSheetState('full');
                } else if (dy > threshold) {
                    // Swipe down → regress state
                    if (sheetState === 'full') setSheetState('half');
                    else if (sheetState === 'half') setSheetState('peek');
                }
            }, {passive: true});

            // Tap header → toggle peek/half
            header.addEventListener('click', function() {
                if (sheetState === 'peek') setSheetState('half');
                else setSheetState('peek');
            });
        }
    })();

    // ── Mobile: Swipe card navigation (Phase 3) ──────────────
    (function() {
        var viewport = $('cardViewport');
        if (!viewport) return;
        var swipeStartX = 0, swipeStartY = 0, swipeStartTime = 0;

        viewport.addEventListener('touchstart', function(e) {
            swipeStartX = e.touches[0].clientX;
            swipeStartY = e.touches[0].clientY;
            swipeStartTime = Date.now();
        }, {passive: true});

        viewport.addEventListener('touchend', function(e) {
            if (window.innerWidth > 900) return;
            if (!hasFlippedOnce) return;
            var dx = e.changedTouches[0].clientX - swipeStartX;
            var dy = e.changedTouches[0].clientY - swipeStartY;
            var dt = Date.now() - swipeStartTime;
            // Must be horizontal swipe: >50px, <80px vertical drift, <400ms
            if (Math.abs(dx) > 50 && Math.abs(dy) < 80 && dt < 400) {
                var cards = flipCardContainer.querySelectorAll('.flip-card');
                if (dx < 0 && currentCardIndex < cards.length - 1) {
                    showCardAtIndex(currentCardIndex + 1);
                } else if (dx > 0 && currentCardIndex > 0) {
                    showCardAtIndex(currentCardIndex - 1);
                }
            }
        }, {passive: true});
    })();

    // ── Mobile: Sidebar expand/collapse (Phase 4) ─────────────
    (function() {
        var sidebar = $('analysisSidebar');
        var profile = $('sidebarProfile');
        if (!sidebar || !profile) return;
        profile.addEventListener('click', function() {
            if (window.innerWidth > 900) return;
            sidebar.classList.toggle('expanded');
        });
    })();

    // ── Mobile: Header overflow menu (Phase 5) ────────────────
    (function() {
        var btn = $('headerOverflowBtn');
        var menu = $('headerOverflowMenu');
        if (!btn || !menu) return;
        btn.addEventListener('click', function(e) {
            e.stopPropagation();
            menu.classList.toggle('hidden');
        });
        document.addEventListener('click', function() {
            menu.classList.add('hidden');
        });
        // Wire overflow menu buttons to their real counterparts
        menu.querySelectorAll('button').forEach(function(item) {
            item.addEventListener('click', function() {
                var action = item.getAttribute('data-action');
                var target;
                if (action === 'copy') target = $('copyAllBtn');
                else if (action === 'email') target = $('emailLawyerBtn');
                else if (action === 'export') target = $('exportBtn');
                else if (action === 'exportLang') target = $('exportLangBtn');
                if (target) target.click();
                menu.classList.add('hidden');
            });
        });
    })();

    // ── Sync overflow menu items with real header buttons ────
    function syncOverflowMenu() {
        var menu = $('headerOverflowMenu');
        if (!menu) return;
        var map = {copy: 'copyAllBtn', email: 'emailLawyerBtn', export: 'exportBtn', exportLang: 'exportLangBtn'};
        menu.querySelectorAll('button').forEach(function(item) {
            var real = $(map[item.getAttribute('data-action')]);
            if (real && !real.classList.contains('hidden')) {
                item.classList.remove('hidden');
                if (item.getAttribute('data-action') === 'exportLang') {
                    item.textContent = real.textContent;
                }
            }
        });
    }

    // ── Helpers ───────────────────────────────────────────────
    function formatSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    function escapeHtml(str) {
        var div = document.createElement('div');
        div.appendChild(document.createTextNode(str));
        return div.innerHTML;
    }

    function showError(msg) {
        uploadError.textContent = msg;
        uploadError.classList.remove('hidden');
        setTimeout(function() { uploadError.classList.add('hidden'); }, 8000);
    }

    function updateAnalyzeBtn() {
        var ready;
        if (isCompareMode) {
            var hasA = compareFile1 !== null || $('pasteArea1').value.trim().length > 0;
            var hasB = compareFile2 !== null || $('pasteArea2').value.trim().length > 0;
            ready = hasA && hasB;
        } else {
            var hasFile = selectedFile !== null;
            var hasText = pasteArea.value.trim().length > 0;
            ready = hasFile || hasText;
        }
        analyzeBtn.disabled = !ready;
        // Show/hide depth selector + analyze button; toggle demo grid
        if (ready) {
            depthSelector.classList.remove('hidden');
            analyzeBtn.classList.remove('hidden');
            demoGridSection.classList.add('hidden');
        } else {
            depthSelector.classList.add('hidden');
            analyzeBtn.classList.add('hidden');
            demoGridSection.classList.remove('hidden');
        }
    }

    // ── Drag-and-drop (single) ────────────────────────────────
    dropZone.addEventListener('click', function() { fileInput.click(); });
    dropZone.addEventListener('dragover', function(e) { e.preventDefault(); dropZone.classList.add('dragover'); });
    dropZone.addEventListener('dragleave', function() { dropZone.classList.remove('dragover'); });
    dropZone.addEventListener('drop', function(e) {
        e.preventDefault(); dropZone.classList.remove('dragover');
        if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
    });
    fileInput.addEventListener('change', function() {
        if (fileInput.files.length) handleFile(fileInput.files[0]);
    });

    function handleFile(file) {
        var ext = file.name.split('.').pop().toLowerCase();
        if (['pdf', 'docx', 'txt', 'text', 'md'].indexOf(ext) === -1) {
            showError('Unsupported file type. Please use PDF, DOCX, or TXT.');
            return;
        }
        selectedFile = file;
        fileNameEl.textContent = file.name;
        fileSizeEl.textContent = formatSize(file.size);
        uploadPrompt.classList.add('hidden');
        fileInfo.classList.remove('hidden');
        pasteArea.classList.add('hidden');
        pasteArea.value = '';
        updateAnalyzeBtn();
    }

    fileRemove.addEventListener('click', function(e) {
        e.preventDefault(); e.stopPropagation();
        selectedFile = null; fileInput.value = '';
        fileInfo.classList.add('hidden');
        uploadPrompt.classList.remove('hidden');
        updateAnalyzeBtn();
    });

    // ── Paste text toggle ─────────────────────────────────────
    pasteToggle.addEventListener('click', function(e) {
        e.preventDefault();
        if (isCompareMode) return;
        var isHidden = pasteArea.classList.contains('hidden');
        if (isHidden) {
            pasteArea.classList.remove('hidden');
            pasteArea.focus();
            pasteToggle.textContent = 'Upload file instead';
            // Clear file if selected
            if (selectedFile) { selectedFile = null; fileInput.value = ''; fileInfo.classList.add('hidden'); uploadPrompt.classList.remove('hidden'); }
        } else {
            pasteArea.classList.add('hidden');
            pasteArea.value = '';
            pasteToggle.textContent = 'Paste text instead';
        }
        updateAnalyzeBtn();
    });
    pasteArea.addEventListener('input', updateAnalyzeBtn);

    // ── Compare mode toggle ───────────────────────────────────
    compareToggle.addEventListener('click', function(e) {
        e.preventDefault();
        isCompareMode = !isCompareMode;
        $('singleUpload').classList.toggle('hidden', isCompareMode);
        $('compareUpload').classList.toggle('hidden', !isCompareMode);
        compareToggle.textContent = isCompareMode ? 'Single document analysis' : 'Compare two documents';
        analyzeBtn.textContent = isCompareMode ? 'Compare documents' : 'Show me the dark side of small print';
        // Reset state
        selectedFile = null; compareFile1 = null; compareFile2 = null;
        updateAnalyzeBtn();
    });

    // ── Compare drop zones ────────────────────────────────────
    function setupCompareZone(num) {
        var dz = $('dropZone' + num);
        var fi = $('fileInput' + num);
        var prompt = $('uploadPrompt' + num);
        var info = $('fileInfo' + num);
        var name = $('fileName' + num);
        var remove = $('fileRemove' + num);
        var paste = $('pasteArea' + num);

        dz.addEventListener('click', function() { fi.click(); });
        dz.addEventListener('dragover', function(e) { e.preventDefault(); dz.classList.add('dragover'); });
        dz.addEventListener('dragleave', function() { dz.classList.remove('dragover'); });
        dz.addEventListener('drop', function(e) {
            e.preventDefault(); dz.classList.remove('dragover');
            if (e.dataTransfer.files.length) setCompareFile(num, e.dataTransfer.files[0]);
        });
        fi.addEventListener('change', function() {
            if (fi.files.length) setCompareFile(num, fi.files[0]);
        });
        remove.addEventListener('click', function(e) {
            e.preventDefault(); e.stopPropagation();
            if (num === 1) compareFile1 = null; else compareFile2 = null;
            fi.value = '';
            info.classList.add('hidden'); prompt.classList.remove('hidden');
            updateAnalyzeBtn();
        });
        paste.addEventListener('input', updateAnalyzeBtn);

        function setCompareFile(n, file) {
            if (n === 1) compareFile1 = file; else compareFile2 = file;
            name.textContent = file.name;
            prompt.classList.add('hidden'); info.classList.remove('hidden');
            paste.classList.add('hidden'); paste.value = '';
            updateAnalyzeBtn();
        }
    }
    setupCompareZone(1);
    setupCompareZone(2);

    // ── Depth selector ────────────────────────────────────────
    depthSelector.addEventListener('click', function(e) {
        var btn = e.target.closest('.depth-btn');
        if (!btn) return;
        depthSelector.querySelectorAll('.depth-btn').forEach(function(b) { b.classList.remove('active'); });
        btn.classList.add('active');
        analysisDepth = btn.getAttribute('data-depth');
    });

    // ── Demo grid tile clicks ───────────────────────────────────
    demoGridSection.addEventListener('click', function(e) {
        var tile = e.target.closest('.demo-tile');
        if (!tile) return;
        startSampleAnalysis(tile.getAttribute('data-sample') || 'lease');
    });

    function startSampleAnalysis(sampleType) {
        analyzeBtn.disabled = true;
        analyzeBtn.textContent = 'Loading...';

        fetch(BASE_URL + '/sample', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ depth: analysisDepth, type: sampleType || 'lease' })
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.error) { showError(data.error); analyzeBtn.disabled = false; analyzeBtn.textContent = 'Show me the dark side of small print'; return; }
            documentFullText = (data.full_text || '').replace(/\n*— Page \d+ —\n*/g, '\n\n');
            documentThumbnail = data.thumbnail || null;
            switchToAnalysis(data.doc_id, data.filename);
        })
        .catch(function(err) {
            showError('Failed to load sample: ' + err.message);
            analyzeBtn.disabled = false;
            analyzeBtn.textContent = 'Show me the dark side of small print';
        });
    }

    // ── Upload & analyze ──────────────────────────────────────
    analyzeBtn.addEventListener('click', function() {
        if (isCompareMode) {
            startCompareAnalysis();
        } else {
            startAnalysis();
        }
    });

    function startAnalysis() {
        var formData = new FormData();
        if (selectedFile) {
            formData.append('file', selectedFile);
        } else if (pasteArea.value.trim()) {
            formData.append('text', pasteArea.value.trim());
        } else {
            showError('Please select a file or paste text.');
            return;
        }
        formData.append('depth', analysisDepth);

        analyzeBtn.disabled = true;
        analyzeBtn.textContent = 'Uploading...';

        fetch(BASE_URL + '/upload', { method: 'POST', body: formData })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.error) { showError(data.error); analyzeBtn.disabled = false; analyzeBtn.textContent = 'Show me the dark side of small print'; return; }
                documentFullText = (data.full_text || '').replace(/\n*— Page \d+ —\n*/g, '\n\n');
                documentThumbnail = data.thumbnail || null;
                switchToAnalysis(data.doc_id, data.filename);
            })
            .catch(function(err) {
                showError('Upload failed: ' + err.message);
                analyzeBtn.disabled = false;
                analyzeBtn.textContent = 'Show me the dark side of small print';
            });
    }

    function startCompareAnalysis() {
        var formData = new FormData();
        if (compareFile1) formData.append('file1', compareFile1);
        else formData.append('text1', $('pasteArea1').value.trim());
        if (compareFile2) formData.append('file2', compareFile2);
        else formData.append('text2', $('pasteArea2').value.trim());
        formData.append('depth', analysisDepth);

        analyzeBtn.disabled = true;
        analyzeBtn.textContent = 'Uploading...';

        fetch(BASE_URL + '/compare', { method: 'POST', body: formData })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.error) { showError(data.error); analyzeBtn.disabled = false; analyzeBtn.textContent = 'Compare documents'; return; }
                documentFullText = (data.full_text || '').replace(/\n*— Page \d+ —\n*/g, '\n\n');
                switchToAnalysis(data.doc_id, data.filename);
            })
            .catch(function(err) {
                showError('Upload failed: ' + err.message);
                analyzeBtn.disabled = false;
                analyzeBtn.textContent = 'Compare documents';
            });
    }

    // ── Switch to analysis screen ─────────────────────────────
    function switchToAnalysis(docId, filename) {
        // Clean up timers from any previous analysis
        stopEditorialStatusRotation();
        // Reset state
        thinkingContent = '';
        responseContent = '';
        thinkingPhaseCount = 0;
        quickDone = false;
        isDoneRendering = false;
        deepTextComplete = false;
        _verdictScrolled = false;
        animatedCardTitles = new Set();
        activeFilters = new Set();
        flipCardsBuilt = false;
        parsedClauseCount = 0;
        currentCardIndex = 0;
        hasFlippedOnce = false;
        cardViewTransitioned = false;
        clauseHighlightData = [];
        _highlightsRenderedUpTo = -1;
        _maxCardReached = 0;
        documentNotApplicable = '';
        detectedDocLanguage = '';
        $('exportLangBtn').classList.add('hidden');
        userHasScrolled = false;
        lastAutoScrollY = 0;
        currentDocId = docId;
        thinkingCharCount = 0;
        outputCharCount = 0;
        stopCapTicker();
        capTicker.className = 'capability-ticker hidden';
        capTicker.innerHTML = '';

        // Verdict column: hidden until verdict is ready — cards are the focus
        resetVerdictCol();


        // Reset UI
        resultsContent.innerHTML = '';
        flipCardContainer.innerHTML = '';
        $('skeletonCard').classList.add('hidden');
        var ct = $('chapterTitle');
        if (ct) ct.classList.remove('visible');
        deepAnalysisEl.innerHTML = '';
        // Remove the deep analysis header (sibling) if it exists
        var oldHeader = deepAnalysisEl.previousElementSibling;
        if (oldHeader && oldHeader.classList.contains('deep-analysis-header')) {
            oldHeader.remove();
        }
        summaryContainer.innerHTML = '';
        filterChips.innerHTML = '';
        filterChips.classList.add('hidden');
        activeFilters.clear();
        activeTrickFilters.clear();
        followupSection.classList.add('hidden');
        followupAnswers.innerHTML = '';
        followupInput.value = '';
        counterDraftSection.classList.add('hidden');
        counterDraftContent.innerHTML = '';
        counterDraftBtn.disabled = false;
        counterDraftBtn.textContent = 'Generate Counter-Draft';
        timelineContent.innerHTML = '';
        timelineBtn.disabled = false;
        timelineBtn.textContent = 'Worst-Case Timeline';
        $('deepAnalysisSection').classList.add('hidden');
        metadataLine.classList.add('hidden');
        metadataLine.classList.remove('visible');
        metadataLine.innerHTML = '';
        statusPill.classList.remove('done');
        statusText.textContent = 'Starting analysis...';
        // Hide model badge during analysis to reduce visual noise
        var modelBadge = document.querySelector('.model-badge');
        if (modelBadge) modelBadge.classList.add('hidden');
        resultsArea.classList.add('hidden');
        $('cardViewport').classList.add('hidden');
        $('cardNavigation').classList.add('hidden');
        $('deepStatus').classList.add('hidden');
        $('copyAllBtn').classList.add('hidden');
        $('exportBtn').classList.add('hidden');
        $('emailLawyerBtn').classList.add('hidden');
        backBtn.classList.remove('hidden');

        // Show flip prompt + skeleton card in center while waiting for first clause
        var skeleton = $('skeletonCard');
        skeleton.classList.remove('hidden');
        $('cardViewport').classList.remove('hidden');
        resultsArea.classList.remove('hidden');

        // Sidebar: prepare content (collapsed — expands after screen switch)
        var sidebar = $('analysisSidebar');
        var thumbEl = $('docThumbnail');
        var thumbImg = $('docThumbnailImg');
        var layoutEl = document.querySelector('.analysis-layout');
        var hasSidebar = documentFullText && !isCompareMode;
        layoutEl.classList.remove('sidebar-visible');
        if (hasSidebar) {
            sidebar.classList.remove('hidden');
            if (documentThumbnail) {
                thumbImg.src = 'data:image/jpeg;base64,' + documentThumbnail;
                thumbEl.classList.remove('hidden');
                // Also set verdict column thumbnail
                var vThumb = $('verdictDocThumb');
                var vThumbImg = $('verdictDocThumbImg');
                if (vThumbImg) {
                    vThumbImg.src = thumbImg.src;
                    vThumb.classList.remove('hidden');
                }
            } else {
                thumbEl.classList.add('hidden');
            }
            // Text preview — show immediately so user sees the full layout
            var loadingEl = $('editorialLoading');
            var loadingText = $('editorialLoadingText');
            loadingText.innerHTML = escapeHtml(documentFullText);
            loadingEl.classList.remove('hidden');
            loadingEl.classList.remove('woosh-in-sidebar');
        } else {
            sidebar.classList.add('hidden');
            thumbEl.classList.add('hidden');
            $('editorialLoading').classList.add('hidden');
        }

        // ── Animated screen transition: fade out upload, then expand ──
        uploadScreen.classList.add('exiting');
        setTimeout(function() {
            uploadScreen.classList.add('hidden');
            uploadScreen.classList.remove('exiting');
            analysisScreen.classList.remove('hidden');
            window.scrollTo({ top: 0 });
            // Expand sidebar after a beat — content column stays centered first
            if (hasSidebar) {
                setTimeout(function() {
                    layoutEl.classList.add('sidebar-visible');
                    // Sync sidebar height to skeleton card
                    syncSidebarHeight(skeleton);
                }, 120);
            }
        }, 350);

        // Start elapsed timer
        analysisStartTime = Date.now();
        if (elapsedInterval) clearInterval(elapsedInterval);
        elapsedInterval = setInterval(function() {
            var secs = Math.floor((Date.now() - analysisStartTime) / 1000);
            var min = Math.floor(secs / 60);
            var sec = secs % 60;
            elapsedEl.textContent = (min > 0 ? min + 'm ' : '') + sec + 's';
        }, 1000);

        connectStream(docId);
    }

    // ── SSE streaming ─────────────────────────────────────────
    function connectStream(docId) {
        eventSource = new EventSource(BASE_URL + '/analyze/' + docId);

        eventSource.onmessage = function(e) {
            var msg;
            try { msg = JSON.parse(e.data); } catch(err) { return; }

            switch (msg.type) {
                case 'phase':
                    handlePhase(msg.content);
                    break;

                case 'thinking_start':
                    thinkingPhaseCount++;
                    if (!quickDone) {
                        startStatusRotation('thinking');
                        startCapTicker(HAIKU_MESSAGES);
                    }
                    break;

                case 'thinking':
                    thinkingContent += msg.content;
                    thinkingCharCount += msg.content.length;
                    break;

                case 'thinking_done':
                    break;

                case 'text_start':
                    resultsArea.classList.remove('hidden');
                    break;

                case 'text':
                    if (resultsArea.classList.contains('hidden')) {
                        resultsArea.classList.remove('hidden');
                    }
                    responseContent += msg.content;
                    outputCharCount += msg.content.length;
                    renderResults();
                    break;

                case 'text_done':
                    renderResultsFinal();
                    break;

                case 'tool_start':
                    break;

                case 'tool_result':
                    break;

                case 'handoff':
                    var hoData = {};
                    try { hoData = JSON.parse(msg.content); } catch(e) {}
                    if (hoData.not_applicable) {
                        statusText.textContent = 'Document scanned — no terms to analyze';
                        statusPill.classList.add('done');
                        stopStatusRotation();
                        stopEditorialStatusRotation();
                        stopCapTicker();
                        capTicker.classList.add('hidden');
                    } else {
                        statusText.textContent = 'Cards ready — Opus expert report building...';
                        startStatusRotation('deep');
                        startCapTicker(OPUS_MESSAGES);
                    }
                    break;

                case 'quick_done':
                    quickDone = true;
                    var qdData = {};
                    try { qdData = JSON.parse(msg.content); } catch(e) {}
                    var qdSec = qdData.seconds ? qdData.seconds.toFixed(1) + 's' : '';
                    statusText.textContent = 'Cards ready' + (qdSec ? ' (' + qdSec + ')' : '') + ' \u2014 Expert report building...';
                    startStatusRotation('deep');
                    stopEditorialStatusRotation();
                    $('deepStatus').classList.remove('hidden');
                    if (!isCompareMode) {
                        finalClauseSweep();
                        buildFilterChips();
                        buildPlaybookCard();
                    }
                    break;

                // ── Opus section text/done events (4 sources) ──
                case 'interactions_text':
                case 'asymmetry_text':
                case 'archaeology_text':
                case 'overall_text':
                    var opusSrc = msg.type.replace('_text', '');
                    opusSections[opusSrc].text += msg.content;
                    renderOpusSection(opusSrc);
                    break;

                case 'interactions_thinking':
                case 'asymmetry_thinking':
                case 'archaeology_thinking':
                case 'overall_thinking':
                    // Discard Opus thinking — we only show text output
                    thinkingCharCount += msg.content.length;
                    break;

                case 'interactions_done':
                case 'asymmetry_done':
                case 'archaeology_done':
                case 'overall_done':
                    var doneSrc = msg.type.replace('_done', '');
                    opusSections[doneSrc].done = true;
                    markOpusSectionDone(doneSrc);
                    // Check if all 4 Opus sections are done
                    var allOpusDone = Object.keys(opusSections).every(function(k) { return opusSections[k].done; });
                    if (allOpusDone) {
                        deepTextComplete = true;
                        stopVerdictCountdown();
                        var verdictStatusEl = $('verdictStatus');
                        if (verdictStatusEl) verdictStatusEl.classList.add('hidden');
                        verdictTitle.textContent = 'Your verdict is ready';
                        updateVerdictButton();
                        if (flipCardsBuilt) updateCardNavigation();
                    }
                    break;

                case 'done':
                    isDoneRendering = true;
                    stopVerdictCountdown();
                    statusPill.classList.add('done');
                    if (elapsedInterval) { clearInterval(elapsedInterval); elapsedInterval = null; }
                    stopStatusRotation();
                    stopEditorialStatusRotation();
                    if (thinkingCharCount > 0) showCapStats();
                    $('deepStatus').classList.add('hidden');
                    // Re-show model badge now that analysis is complete
                    var doneBadge = document.querySelector('.model-badge');
                    if (doneBadge) doneBadge.classList.remove('hidden');

                    var doneData = {};
                    try { doneData = JSON.parse(msg.content); } catch(e) {}
                    var quickSec = doneData.quick_seconds ? doneData.quick_seconds.toFixed(1) : null;
                    var deepSec = doneData.deep_seconds ? doneData.deep_seconds.toFixed(1) : null;
                    var timingStr = 'Analysis complete';
                    if (quickSec && deepSec) {
                        timingStr = 'Complete \u2014 Cards: ' + quickSec + 's \u00B7 Expert: ' + deepSec + 's';
                    }
                    statusText.textContent = timingStr;

                    var sidebarStatus = $('editorialLoadingStatus');
                    if (sidebarStatus) sidebarStatus.textContent = 'Analysis complete';
                    var dots = $('editorialLoading') && $('editorialLoading').querySelector('.pulsing-dots');
                    if (dots) dots.style.display = 'none';

                    $('copyAllBtn').classList.remove('hidden');
                    $('exportBtn').classList.remove('hidden');
                    $('emailLawyerBtn').classList.remove('hidden');
                    syncOverflowMenu();
                    // Show "Download in [language]" button if document is not in English
                    if (detectedDocLanguage && detectedDocLanguage.toLowerCase() !== 'english') {
                        var langBtn = $('exportLangBtn');
                        langBtn.textContent = 'Report in ' + detectedDocLanguage;
                        langBtn.classList.remove('hidden');
                    }

                    if (isCompareMode) {
                        renderResultsFinal();
                        buildSummaryCard();
                        buildPlaybookCard();
                    }

                    if (flipCardsBuilt) updateCardNavigation();

                    if (!isCompareMode) {
                        // Mark all Opus sections done (safety net)
                        Object.keys(opusSections).forEach(function(k) {
                            if (!opusSections[k].done) {
                                opusSections[k].done = true;
                                markOpusSectionDone(k);
                            }
                        });
                        deepTextComplete = true;
                        verdictTitle.textContent = 'Your verdict is ready';
                        updateVerdictButton();
                    }

                    if (!isCompareMode) followupSection.classList.remove('hidden');
                    if (eventSource) { eventSource.close(); eventSource = null; }
                    break;

                case 'error':
                    statusText.textContent = 'Error';
                    statusPill.classList.add('done');
                    if (elapsedInterval) { clearInterval(elapsedInterval); elapsedInterval = null; }
                    stopStatusRotation();
                    removeCursor();

                    resultsArea.classList.remove('hidden');
                    var errMsg = msg.content || 'Unknown error';
                    var advice = '';
                    if (errMsg.indexOf('API key') >= 0) advice = 'Check your .env file has a valid ANTHROPIC_API_KEY.';
                    else if (errMsg.indexOf('rate') >= 0 || errMsg.indexOf('429') >= 0) advice = 'Rate limit reached. Wait a minute and try again.';
                    else if (errMsg.indexOf('timeout') >= 0 || errMsg.indexOf('overloaded') >= 0) advice = 'The API is busy. Try again in a few minutes.';
                    else advice = 'Try again or use a different analysis depth.';
                    resultsContent.innerHTML = '<div class="error-msg">' + escapeHtml(errMsg) +
                        '<br><span style="font-size:0.82rem;color:var(--text-secondary);font-weight:400">' + advice + '</span>' +
                        '<br><button class="retry-btn" onclick="location.reload()">Try Again</button></div>';

                    if (eventSource) { eventSource.close(); eventSource = null; }
                    break;
            }
        };

        var _sseRetryCount = 0;
        var _sseMaxRetries = 2;
        eventSource.onerror = function() {
            if (eventSource) { eventSource.close(); eventSource = null; }
            if (statusPill.classList.contains('done')) return;
            // Retry on transient failures if analysis is still in progress
            if (_sseRetryCount < _sseMaxRetries && responseContent.length > 0) {
                _sseRetryCount++;
                statusText.textContent = 'Reconnecting (' + _sseRetryCount + '/' + _sseMaxRetries + ')...';
                setTimeout(function() {
                    if (statusPill.classList.contains('done')) return;
                    connectStream(docId);
                }, 2000 * _sseRetryCount);
                return;
            }
            statusText.textContent = 'Connection lost';
            statusPill.classList.add('done');
            removeCursor();
            stopStatusRotation();
            if (elapsedInterval) { clearInterval(elapsedInterval); elapsedInterval = null; }
            if (responseContent.length < 50) {
                resultsArea.classList.remove('hidden');
                resultsContent.innerHTML = '<div class="error-msg">Connection lost during analysis.' +
                    '<br><button class="retry-btn" onclick="location.reload()">Retry</button></div>';
            }
        };
    }

    // ── Phase handling ────────────────────────────────────────
    function handlePhase(phase) {
        var labels = {
            thinking: "Reading as the drafter's attorney...",
            profile: 'Identifying document structure...',
            clauses: 'Analyzing clauses...',
            interactions: 'Cross-clause interactions...',
            playbook: "Revealing the drafter's playbook...",
            summary: 'Generating risk assessment...'
        };
        if (labels[phase]) {
            statusText.textContent = labels[phase];
        }
        // Extract metadata from profile phase
        if (phase === 'profile') {
            setTimeout(extractMetadata, 2000);
        }
        // Start relevant status rotation
        if (phase === 'clauses' || phase === 'profile') startStatusRotation('clauses');
        else if (phase === 'interactions' || phase === 'playbook' || phase === 'summary') startStatusRotation('deep');
    }

    // ── Metadata extraction from streamed text ────────────────
    var documentNotApplicable = ''; // Set when Haiku determines doc has no terms to analyze
    var detectedDocLanguage = ''; // Detected from document text (e.g. "Dutch", "German")

    function extractMetadata() {
        var patterns = [
            { re: /\*\*Document Type\*\*[:\s]*([^\n*]+)/i, label: 'Type' },
            { re: /\*\*Drafted By\*\*[:\s]*([^\n*]+)/i, label: 'Drafted By' },
            { re: /\*\*Your Role\*\*[:\s]*([^\n*]+)/i, label: 'Your Role' },
            { re: /\*\*Jurisdiction\*\*[:\s]*([^\n*]+)/i, label: 'Jurisdiction' },
            { re: /\*\*Language\*\*[:\s]*([^\n*]+)/i, label: 'Language' },
        ];
        var parts = [];
        patterns.forEach(function(p) {
            var m = responseContent.match(p.re);
            if (m) {
                var val = m[1].trim();
                // Capture language but don't show as pill (used for download button)
                if (p.label === 'Language') {
                    detectedDocLanguage = val;
                    return;
                }
                parts.push(
                    '<span class="meta-pill">' +
                    '<span class="meta-pill-label">' + escapeHtml(p.label) + '</span> ' +
                    '<span class="meta-pill-value">' + escapeHtml(val) + '</span>' +
                    '</span>'
                );
            }
        });
        // Detect "Not Applicable" signal from Haiku
        var naMatch = responseContent.match(/\*\*Not Applicable\*\*[:\s]*([^\n*]+)/i);
        if (naMatch) {
            documentNotApplicable = naMatch[1].trim();
        }
        if (parts.length > 0) {
            metadataLine.innerHTML = parts.join('');
            metadataLine.classList.remove('hidden');
            // Trigger fly-in animation after a frame
            requestAnimationFrame(function() {
                requestAnimationFrame(function() {
                    metadataLine.classList.add('visible');
                });
            });
            // Also populate verdict column doc profile
            var vMeta = $('verdictDocMeta');
            var vProfile = $('verdictDocProfile');
            if (vMeta && vProfile) {
                // Detect document category icon from type
                var typeMatch = responseContent.match(/\*\*Document Type\*\*[:\s]*([^\n*]+)/i);
                var docCat = typeMatch ? detectDocIcon(typeMatch[1]) : null;
                var iconHtml = docCat
                    ? '<div class="verdict-doc-icon"><span class="verdict-doc-icon-svg">' + docCat.svg + '</span><span class="verdict-doc-icon-label">' + escapeHtml(docCat.label) + '</span></div>'
                    : '';
                vMeta.innerHTML = iconHtml + parts.join('');
                vProfile.classList.remove('hidden');
            }
            // Skeleton message intentionally kept empty — cards arrive fast enough
        }
    }

    // ── Status rotation ───────────────────────────────────────
    function startStatusRotation(group) {
        stopStatusRotation();
        currentStatusIdx = 0;
        var messages = STATUS_MESSAGES[group];
        if (!messages || messages.length === 0) return;
        statusRotateInterval = setInterval(function() {
            currentStatusIdx = (currentStatusIdx + 1) % messages.length;
            statusText.textContent = messages[currentStatusIdx];
            // Mirror deep status text
            if (group === 'deep') {
                var dst = $('deepStatusText');
                if (dst) dst.textContent = messages[currentStatusIdx];
            }
        }, 4000);
    }

    function stopStatusRotation() {
        if (statusRotateInterval) { clearInterval(statusRotateInterval); statusRotateInterval = null; }
    }

    function removeCursor() { /* no-op — thinking panel removed */ }

    // ── Results rendering ─────────────────────────────────────
    function renderResults() {
        if (renderTimeout) return;
        renderTimeout = setTimeout(function() {
            renderTimeout = null;
            doRenderResults();
        }, 300);
    }

    function renderResultsFinal() {
        if (renderTimeout) { clearTimeout(renderTimeout); renderTimeout = null; }
        doRenderResults();
    }

    function isNearBottom() {
        return (window.innerHeight + window.scrollY) >= (document.body.scrollHeight - 300);
    }

    // Track manual scroll
    window.addEventListener('scroll', function() {
        if (Math.abs(window.scrollY - lastAutoScrollY) > 100) {
            userHasScrolled = true;
        }
    }, { passive: true });

    function doRenderResults() {
        // ── Guard: once flip cards are built, DON'T render deep analysis during streaming ──
        // Deep analysis will be rendered on-demand when user clicks "Our Verdict" or "View assessment"
        if (flipCardsBuilt && !isCompareMode) {
            return;
        }

        // ── Compare mode: keep old markdown rendering path ──
        if (isCompareMode) {
            var safeMd = responseContent
                .replace(/\[READER\]\s*:/g, 'FLIPSIDE_READER:')
                .replace(/\[DRAFTER\]\s*:/g, 'FLIPSIDE_DRAFTER:')
                .replace(/^READER\s*:/gm, 'FLIPSIDE_READER:')
                .replace(/^DRAFTER\s*:/gm, 'FLIPSIDE_DRAFTER:');
            var html = safeMd2Html(safeMd);
            html = styleRiskBadges(html);
            html = styleWhyClauses(html);
            html = styleReaderBlocks(html);
            html = styleDrafterBlocks(html);
            html = styleSplitClauses(html);
            resultsContent.innerHTML = safeHtml(html);
            wrapClauseSections(resultsContent);
            resultsArea.classList.remove('hidden');
            return;
        }

        // ── Non-compare: incremental clause detection ──
        tryExtractNewClauses();
    }

    // ── Risk badge styling ────────────────────────────────────
    function styleRiskBadges(html) {
        // Match: LEVEL · Score: NN/100 · Trick: NAME (or Score: NN without /100)
        html = html.replace(
            /\[?(?:<strong>)?(GREEN|YELLOW|RED)(?:<\/strong>)?\]?\s*(?:·|&#xB7;|&middot;)\s*Score:\s*\d+(?:\/100)?\s*(?:·|&#xB7;|&middot;)\s*Trick:\s*([^<\n]+)/gi,
            function(_, level, trick) {
                return buildBadgeHtml(level.toLowerCase(), level.toUpperCase(), trick.trim());
            }
        );
        // Match: LEVEL · Trick: NAME (no score — cross-clause format)
        html = html.replace(
            /\[?(?:<strong>)?(GREEN|YELLOW|RED)(?:<\/strong>)?\]?\s*(?:·|&#xB7;|&middot;)\s*Trick:\s*([^<\n]+)/gi,
            function(_, level, trick) {
                return buildBadgeHtml(level.toLowerCase(), level.toUpperCase(), trick.trim());
            }
        );
        // Fallback: LEVEL · Score: NN/100 (no trick)
        html = html.replace(
            /\[?(?:<strong>)?(GREEN|YELLOW|RED)(?:<\/strong>)?\]?\s*(?:·|&#xB7;|&middot;)\s*Score:\s*\d+(?:\/100)?/gi,
            function(_, level) {
                return buildBadgeHtml(level.toLowerCase(), level.toUpperCase(), '');
            }
        );
        return html;
    }

    // styleRiskDistribution removed — risk distribution dots no longer shown

    function buildBadgeHtml(level, label, trick) {
        var h = '<span class="risk-badge risk-' + level + '">' + label + '</span>';
        if (trick) {
            var desc = TRICK_DESCRIPTIONS[trick] || '';
            var icon = TRICK_ICONS[trick] ? '<span class="verdict-trick-icon">' + TRICK_ICONS[trick] + '</span> ' : '';
            h += '<span class="trick-label" title="' + escapeHtml(desc) + '">' + icon + escapeHtml(trick) + '</span>';
        }
        return h;
    }

    // ── "Why this clause exists" — hidden from display ────────
    function styleWhyClauses(html) {
        return html.replace(
            /<p><strong>Why this clause exists:<\/strong>\s*([\s\S]*?)<\/p>/gi,
            ''
        );
    }

    // ── Split clause styling (juxtaposition) ──────────────────
    function styleSplitClauses(html) {
        // Card-level juxtapose (from Haiku quick scan)
        html = html.replace(
            /<p><strong>What the small print says:?<\/strong>:?\s*([\s\S]*?)<\/p>\s*<p><strong>What you should read:?<\/strong>:?\s*([\s\S]*?)<\/p>/gi,
            function(_, left, right) {
                return '<div class="clause-split-header">' +
                    '<div class="clause-split-label clause-split-label-left">What the small print says</div>' +
                    '<div class="clause-split-label clause-split-label-right">What you should read</div>' +
                    '</div>' +
                    '<div class="clause-split">' +
                    '<div class="clause-split-left">' + left.trim() + '</div>' +
                    '<div class="clause-split-right">' + right.trim() + '</div>' +
                    '</div>';
            }
        );
        // Cross-clause juxtapose (from Opus deep analysis — different labels)
        html = html.replace(
            /<p><strong>Read separately, you(?:&#x2019;|'|')d see:<\/strong>\s*([\s\S]*?)<\/p>\s*<p><strong>Read together, you(?:&#x2019;|'|')d realize:<\/strong>\s*([\s\S]*?)<\/p>/gi,
            function(_, left, right) {
                return '<div class="clause-split-header">' +
                    '<div class="clause-split-label clause-split-label-left">Read separately</div>' +
                    '<div class="clause-split-label clause-split-label-right">Read together</div>' +
                    '</div>' +
                    '<div class="clause-split">' +
                    '<div class="clause-split-left">' + left.trim() + '</div>' +
                    '<div class="clause-split-right">' + right.trim() + '</div>' +
                    '</div>';
            }
        );
        return html;
    }

    // ── [READER] block styling ────────────────────────────────
    function styleReaderBlocks(html) {
        // Match FLIPSIDE_READER: text (pre-processed from [READER]:)
        return html.replace(
            /<p>FLIPSIDE_READER:\s*([\s\S]*?)<\/p>/gi,
            function(_, text) {
                return '<div class="reader-voice" data-reader="true">' + text.trim() + '</div>';
            }
        );
    }

    // ── Drafter voice styling ───────────────────────────────
    function styleDrafterBlocks(html) {
        // Primary format: **If the drafter would have bad intentions:** text
        html = html.replace(
            /<p><strong>If the drafter (?:would have bad intentions|could speak as a villain):<\/strong>\s*([\s\S]*?)<\/p>/gi,
            function(_, text) {
                return '<div class="drafter-voice"><span class="drafter-voice-label">If the drafter would have bad intentions</span>' + text.trim() + '</div>';
            }
        );
        // Fallback: old "speak freely" format
        html = html.replace(
            /<p><strong>If the drafter could speak freely:<\/strong>\s*([\s\S]*?)<\/p>/gi,
            function(_, text) {
                return '<div class="drafter-voice"><span class="drafter-voice-label">If the drafter would have bad intentions</span>' + text.trim() + '</div>';
            }
        );
        // Legacy format: FLIPSIDE_DRAFTER: text (pre-processed from [DRAFTER]:)
        html = html.replace(
            /<p>FLIPSIDE_DRAFTER:\s*([\s\S]*?)<\/p>/gi,
            function(_, text) {
                return '<div class="drafter-voice"><span class="drafter-voice-label">If the drafter would have bad intentions</span>' + text.trim() + '</div>';
            }
        );
        // Style "→ YOUR MOVE:" action lines
        html = html.replace(
            /<p>→ YOUR MOVE:\s*([\s\S]*?)<\/p>/gi,
            function(_, text) {
                return '<div class="your-move"><span class="your-move-label">→ Your move</span>' + text.trim() + '</div>';
            }
        );
        return html;
    }

    // ── Incremental clause detection via --- separators ─────
    function tryExtractNewClauses() {
        // Split on --- separator (flexible: handles \n---\n, \n\n---\n, \n\n---\n\n)
        var segments = responseContent.split(/\n+---\n+/);
        if (segments.length > 1 && parsedClauseCount === 0) {
            console.log('[FlipSide] First segment (should be doc profile):', segments[0].substring(0, 200));
            console.log('[FlipSide] Total segments so far:', segments.length);
            console.log('[FlipSide] Second segment preview:', segments[1] ? segments[1].substring(0, 200) : '(empty)');
        }

        // All segments except the last are complete (last may be mid-stream)
        for (var i = parsedClauseCount; i < segments.length - 1; i++) {
            var clause = extractSingleClause(segments[i]);
            if (!clause && segments[i].trim().length > 50) {
                console.log('[FlipSide] Failed to parse segment ' + i + ' (' + segments[i].length + ' chars)');
            }
            if (clause) {
                buildSingleFlipCard(clause, flipCardContainer.querySelectorAll('.flip-card').length);
                trackTrick(clause.trick);
                if (!cardViewTransitioned) {
                    transitionToCardView();
                } else {
                    updateCardNavigation();
                }
                // Live clause counter
                var cardCount = flipCardContainer.querySelectorAll('.flip-card').length;
                statusText.textContent = cardCount + ' clause' + (cardCount !== 1 ? 's' : '') + ' found so far...';
                var sidebarStatus = $('editorialLoadingStatus');
                if (sidebarStatus) sidebarStatus.textContent = cardCount + ' clause' + (cardCount !== 1 ? 's' : '') + ' flagged';
            }
        }
        parsedClauseCount = Math.max(parsedClauseCount, segments.length - 1);

        // Extract metadata if not yet populated
        if (metadataLine.classList.contains('hidden') && responseContent.length > 200) {
            extractMetadata();
        }
    }

    // ── Final sweep on quick_done — parse last segment too ──
    function finalClauseSweep() {
        var segments = responseContent.split(/\n+---\n+/);
        console.log('[FlipSide] finalClauseSweep: ' + segments.length + ' segments, parsedClauseCount=' + parsedClauseCount);
        for (var i = parsedClauseCount; i < segments.length; i++) {
            var clause = extractSingleClause(segments[i]);
            if (clause) {
                buildSingleFlipCard(clause, flipCardContainer.querySelectorAll('.flip-card').length);
                trackTrick(clause.trick);
                if (!cardViewTransitioned) {
                    transitionToCardView();
                }
            }
        }
        parsedClauseCount = segments.length;
        flipCardsBuilt = true;
        updateCardNavigation();
        buildFilterChips();
        // buildPlaybookCard() called after quick_done — Haiku now provides trick data

        // If no cards were found, show an explanation
        var totalCards = flipCardContainer.querySelectorAll('.flip-card').length;
        if (totalCards === 0) {
            var skeleton = $('skeletonCard');
            var skMsg = $('skeletonMessage');
            skeleton.classList.remove('hidden');
            $('cardViewport').classList.remove('hidden');
            // Extract doc type for the message
            var typeMatch = responseContent.match(/\*\*Document Type\*\*[:\s]*([^\n*]+)/i);
            var docType = typeMatch ? typeMatch[1].trim() : 'document';
            if (documentNotApplicable) {
                skMsg.innerHTML = '<h2 style="margin-bottom:0.8rem">Not everything is a contract in life.</h2>' +
                    '<strong>Not a match for FlipSide</strong><br>' +
                    escapeHtml(documentNotApplicable) +
                    '<br><br>FlipSide analyzes documents where one party sets terms that bind another — contracts, leases, terms of service, insurance policies, coupons with conditions, and similar.';
            } else {
                skMsg.innerHTML = '<strong>No clauses flagged</strong><br>' +
                    'FlipSide scanned this ' + escapeHtml(docType).toLowerCase() +
                    ' but found no terms that need your attention. This is a good sign — the document appears straightforward.';
            }
            // Restyle skeleton as a static message (no pulse)
            skeleton.querySelectorAll('.skeleton-pulse').forEach(function(el) { el.style.display = 'none'; });
            var skWait = skeleton.querySelector('.skeleton-waiting');
            if (skWait) skWait.style.display = 'none';
            // Hide deep status and verdict column — no point showing Opus for unsuitable docs
            if (documentNotApplicable) {
                $('deepStatus').classList.add('hidden');
                hideVerdictCol();
                stopVerdictCountdown();
            }
        }
    }

    // ── Opus card backs: incremental parsing ──────────────────

    // ── Parse one clause from a raw markdown segment ─────────
    function extractSingleClause(segment) {
        if (!segment.match(/^### /m)) return null;

        // Risk flag: front-only has just [GREEN/YELLOW/RED], full has Score + Trick
        var riskMatch = segment.match(/\[?(GREEN|YELLOW|RED)\]?\s*(?:[·•\u00B7\u2022\-–—|,]\s*Score:\s*(\d+)(?:\/100)?(?:\s*[·•\u00B7\u2022\-–—|,]\s*Trick:\s*([^\n]+))?)?/i);
        if (!riskMatch) return null;

        var headerMatch = segment.match(/^### \s*(.+)\s+\(([^)]+)\)\s*$/m);
        var title, sectionRef;
        if (headerMatch) {
            title = headerMatch[1].trim();
            sectionRef = headerMatch[2].trim();
        } else {
            var simpleHeader = segment.match(/^### \s*(.+?)\s*$/m);
            if (!simpleHeader) return null;
            title = simpleHeader[1].trim();
            sectionRef = '';
        }

        var quoteLines = [];
        var lines = segment.split('\n');
        for (var j = 0; j < lines.length; j++) {
            if (lines[j].match(/^>\s*/)) {
                quoteLines.push(lines[j].replace(/^>\s*/, ''));
            } else if (quoteLines.length > 0) {
                break;
            }
        }
        var quote = quoteLines.join(' ').replace(/^["\u201C]|["\u201D]$/g, '').trim();

        var reassuranceMatch = segment.match(/\[REASSURANCE\]\s*:\s*(.+)/i);
        var reassurance = reassuranceMatch ? reassuranceMatch[1].trim().replace(/^["\u201C]|["\u201D]$/g, '') : '';

        var honeyMatch = segment.match(/\[HONEY\]\s*:\s*([\s\S]*?)(?=\n\n|\n\[|\n(?:GREEN|YELLOW|RED))/i);
        var honey = honeyMatch ? honeyMatch[1].trim() : '';

        var teaserMatch = segment.match(/\[TEASER\]\s*:\s*(.+)/i);
        var teaser = teaserMatch ? teaserMatch[1].trim().replace(/^["\u201C]|["\u201D]$/g, '') : '';

        var revealMatch = segment.match(/\[REVEAL\]\s*:\s*(.+)/i);
        var reveal = revealMatch ? revealMatch[1].trim().replace(/^["\u201C]|["\u201D]$/g, '') : '';

        var readerMatch = segment.match(/\[READER\]\s*:\s*([\s\S]*?)(?=\n\n|\n\[|\n(?:GREEN|YELLOW|RED))/i);
        var reader = readerMatch ? readerMatch[1].trim() : '';

        var risk = riskMatch[1].toLowerCase();
        var score = riskMatch[2] ? parseInt(riskMatch[2]) : 0;
        var trick = riskMatch[3] ? riskMatch[3].trim() : '';
        // Fallback: try standalone Trick: line if combined regex missed it
        if (!trick || trick.toLowerCase() === 'none') {
            var trickFallback = segment.match(/Trick:\s*([^\n]+)/i);
            if (trickFallback) {
                var fb = trickFallback[1].trim();
                if (fb && fb.toLowerCase() !== 'none') trick = fb;
            }
        }

        var confidenceMatch = segment.match(/Confidence:\s*(HIGH|MEDIUM|LOW)\s*[\u2014\-\u2013\u2015]\s*(.+)/i);
        var confidence = confidenceMatch ? confidenceMatch[1].toLowerCase() : '';
        var confidenceReason = confidenceMatch ? confidenceMatch[2].trim() : '';

        var bottomLineMatch = segment.match(/\*{1,2}Bottom line:?\*{0,2}:?\s*([\s\S]*?)(?=\n\n|\*{1,2}What the small print says)/i);
        var bottomLine = bottomLineMatch ? bottomLineMatch[1].trim() : '';

        var smallPrintMatch = segment.match(/\*{1,2}What the small print says:?\*{0,2}:?\s*([\s\S]*?)(?=\*{1,2}What you should read|\n\n###|\n\n##|$)/i);
        var shouldReadMatch = segment.match(/\*{1,2}What you should read:?\*{0,2}:?\s*([\s\S]*?)(?=\*{1,2}What does this mean|\n\n###|\n\n##|$)/i);
        var smallPrint = smallPrintMatch ? smallPrintMatch[1].trim() : '';
        var shouldRead = shouldReadMatch ? shouldReadMatch[1].trim() : '';
        if (!smallPrint && quote) smallPrint = quote;

        var figureMatch = segment.match(/\[FIGURE\]\s*:\s*(.+)/i);
        var figure = figureMatch ? figureMatch[1].trim() : '';
        var exampleNarrativeMatch = segment.match(/\[EXAMPLE\]\s*:\s*([\s\S]*?)(?=\n\[READER\]|\n\n###|\n\n##|\n\n---|\*{1,2}\[EN\]|\[EN-FIGURE\]|\[EN-EXAMPLE\]|$)/i);
        var exampleNarrative = exampleNarrativeMatch ? exampleNarrativeMatch[1].trim() : '';
        if (!figure && !exampleNarrative) {
            var exampleMatch = segment.match(/\*{1,2}What does this mean for you:?\*{0,2}:?\s*([\s\S]*?)(?=\n\[READER\]|\n\n###|\n\n##|\n\n---|\*{1,2}\[EN\]|$)/i);
            if (exampleMatch) exampleNarrative = exampleMatch[1].trim();
        }

        // Track whether back data has been filled
        var hasBack = !!(reveal || score > 0 || bottomLine || figure);

        return {
            title: title, section: sectionRef, reassurance: reassurance, honey: honey,
            teaser: teaser, quote: quote, reader: reader, reveal: reveal,
            risk: risk, score: score, trick: trick, hasBack: hasBack,
            confidence: confidence, confidenceReason: confidenceReason,
            bottomLine: bottomLine, smallPrint: smallPrint, shouldRead: shouldRead,
            figure: figure, exampleNarrative: exampleNarrative
        };
    }

    // ── Build and append one flip card ───────────────────────
    function buildSingleFlipCard(clause, index) {
        var risk = clause.risk;
        var trickDesc = TRICK_DESCRIPTIONS[clause.trick] || '';
        var borderColor = risk === 'red' ? 'var(--red)' : risk === 'yellow' ? 'var(--yellow)' : 'var(--green-border)';

        // ── Front: watermark number, reassurance headline, section ref, reader voice, teaser ──
        var displayNum = (index + 1 < 10 ? '0' : '') + (index + 1);
        var frontHtml = '<div class="flip-card-front">' +
            '<span class="card-watermark">' + displayNum + '</span>' +
            '<div class="risk-header risk-header-green">' +
            (clause.reassurance ? '<span class="risk-header-label" style="color:var(--green-text)">You think that</span><h3 class="clause-title" style="color:var(--green-text)">' + escapeHtml(clause.reassurance) + '</h3>' : '') +
            '</div>' +
            '<div class="front-content">' +
            (clause.section ? '<div class="clause-section-ref">' + escapeHtml(clause.section) + '</div>' : '') +
            (clause.quote ? '<div class="front-quote-pill" data-card-pill="' + index + '">' +
                '<span class="pill-num pill-num-' + risk + '">' + (index + 1) + '</span>' +
                '<span class="pill-text">\u201c' + escapeHtml(clause.quote.substring(0, 90)) + (clause.quote.length > 90 ? '\u2026' : '') + '\u201d</span>' +
                '</div>' : '') +
            '<div class="reader-voice">' +
            '<span class="reader-voice-label">At first glance</span>' +
            '<div class="reader-voice-text">' + escapeHtml(clause.reader) + '</div>' +
            '</div>' +
            '</div>' +
            (clause.teaser ? '<div class="card-teaser">' + escapeHtml(clause.teaser) + '</div>' : '') +
            '<button class="flip-trigger"><span>Now flip it</span><span class="flip-trigger-spin">\u27F3</span></button>' +
            '</div>';

        // ── Back body: full reveal — quote, figure, example, bottom line ──
        var backBodyHtml = '';

        // Source quote on card back — only for green cards (red/yellow use "Find in document" link instead)
        if (clause.quote) {
            if (risk === 'green') {
                backBodyHtml += '<div class="back-quote-label">From the document</div>' +
                    '<div class="clause-quote">' + escapeHtml(clause.quote) + '</div>';
            } else {
                backBodyHtml += '<span class="find-in-doc" data-card-index="' + index + '">Find in document \u2192</span>';
            }
        }

        var isGreenSummary = clause.title === 'Fair Clauses Summary' || (risk === 'green' && clause.title && clause.title.indexOf('Fair Clauses') >= 0);
        var backHtml;

        // Haiku delivers full card data — back is always ready
        if (isGreenSummary) {
            backBodyHtml = '<div class="green-verdict">' +
                '<div class="green-verdict-title">Confirmed: Fair as written</div>' +
                '<div class="green-verdict-text">' +
                escapeHtml(clause.bottomLine || 'These clauses do what they say.') +
                '</div></div>';
        } else if (clause.figure || clause.exampleNarrative) {
            backBodyHtml += '<div class="back-meaning-label">What does this mean for you</div>';
            if (clause.figure) {
                backBodyHtml += '<div class="back-figure back-figure-' + risk + '">' +
                    escapeHtml(clause.figure) + '</div>';
            }
            if (clause.exampleNarrative) {
                var exHtml = escapeHtml(clause.exampleNarrative).replace(
                    /(\$[\d,]+(?:\.\d{2})?|\d+%|\d+\s*(?:days?|months?|years?|hours?))/gi,
                    '<span class="hl-number">$1</span>'
                );
                backBodyHtml += '<div class="back-example back-example-' + risk + '">' + exHtml + '</div>';
            }
        }

        if (!isGreenSummary) {
            if (clause.honey) {
                backBodyHtml += '<div class="back-honey" style="margin:0.6rem 0;padding:0.5rem 0.7rem;' +
                    'background:rgba(196,75,40,0.06);border-left:2px solid var(--accent);' +
                    'font-size:0.78rem;color:var(--text-secondary);border-radius:0 var(--radius-sm) var(--radius-sm) 0">' +
                    '<span style="font-weight:600;color:var(--accent);font-family:\'JetBrains Mono\',monospace;font-size:0.68rem;' +
                    'letter-spacing:0.04em;text-transform:uppercase">Honey trap</span><br>' +
                    escapeHtml(clause.honey) + '</div>';
            }

            if (clause.bottomLine) {
                backBodyHtml += '<div class="back-bottom-line">' +
                    escapeHtml(clause.bottomLine) + '</div>';
            }
        }

        var backTitle = clause.reveal || clause.title;
        var backLabel = (risk === 'green') ? 'And that\u2019s correct' : 'But in reality';
        backHtml = '<div class="flip-card-back"><div class="back-content">' +
            '<div class="risk-header risk-header-' + risk + '">' +
            '<span class="risk-header-label">' + backLabel + '</span>' +
            '<h3 class="clause-title">' + escapeHtml(backTitle) + '</h3>' +
            '</div>' +
            '<div class="back-body">' + backBodyHtml + '</div>' +
            '<div class="back-footer">' +
            (clause.trick ? '<span class="trick-footnote" title="' + escapeHtml(trickDesc) + '">' + (TRICK_ICONS[clause.trick] ? '<span class="verdict-trick-icon">' + TRICK_ICONS[clause.trick] + '</span> ' : '') + escapeHtml(clause.trick) + '</span>' : '') +
            '<button class="flip-back-trigger"><span class="flip-back-arrow">&larr;</span><span>Flip back</span></button>' +
            '</div>' +
            '</div></div>';

        var cardEl = document.createElement('div');
        cardEl.className = 'flip-card hidden';
        cardEl.setAttribute('data-clause-index', index);
        cardEl.setAttribute('data-risk-level', risk);
        if (clause.trick) cardEl.setAttribute('data-trick', clause.trick);
        if (clause.score) cardEl.setAttribute('data-score', clause.score);
        cardEl.setAttribute('data-clause-title', clause.title);
        cardEl.setAttribute('data-section-ref', clause.section || '');
        if (clause.reassurance) cardEl.setAttribute('data-reassurance', clause.reassurance);
        if (clause.quote) cardEl.setAttribute('data-quote', clause.quote);
        if (clause.honey) cardEl.setAttribute('data-honey', clause.honey);
        if (clause.shouldRead) cardEl.setAttribute('data-should-read', clause.shouldRead);
        if (clause.figure) cardEl.setAttribute('data-figure', clause.figure);
        if (clause.exampleNarrative) cardEl.setAttribute('data-example', clause.exampleNarrative);
        cardEl.innerHTML = '<div class="flip-card-inner">' + frontHtml + backHtml + '</div>';
        flipCardContainer.appendChild(cardEl);

        // Highlight this clause's quote in the document preview
        highlightClauseInPreview(clause, index);
    }

    // ── Document preview: highlight clause quotes ─────────────
    // Stores all clause highlight data; rebuilds from clean source each time
    var clauseHighlightData = [];

    var _highlightsRenderedUpTo = -1;  // tracks which card index highlights are shown up to
    var _maxCardReached = 0;  // highest card index the user has navigated to

    function highlightClauseInPreview(clause, cardIndex) {
        if (!clause.quote || clause.quote.length < 10) return;
        clauseHighlightData.push({ quote: clause.quote, cardIndex: cardIndex, risk: clause.risk || 'green' });
        // Render all markers immediately as clauses arrive
        rebuildPreviewHighlights();
    }

    function rebuildPreviewHighlights() {
        var totalHighlights = clauseHighlightData.length;
        if (totalHighlights === _highlightsRenderedUpTo) return;  // no change needed
        _highlightsRenderedUpTo = totalHighlights;
        var previewEl = $('editorialLoadingText');
        if (!previewEl || !documentFullText) return;

        // Always start from the clean escaped source
        var text = escapeHtml(documentFullText);

        // Build normalized version with position map for fuzzy matching
        // posMap[i] = index in 'text' that normalized[i] originated from
        var normalized = '';
        var posMap = [];
        for (var c = 0; c < text.length; c++) {
            if (/\s/.test(text[c])) {
                if (normalized.length > 0 && normalized[normalized.length - 1] !== ' ') {
                    normalized += ' ';
                    posMap.push(c);
                }
            } else {
                normalized += text[c].toLowerCase();
                posMap.push(c);
            }
        }

        function normalizeStr(s) {
            return s.replace(/\s+/g, ' ').replace(/[\u201c\u201d\u201e]/g, '"').replace(/[\u2018\u2019\u201a]/g, "'").replace(/[\u2013\u2014]/g, '-').trim().toLowerCase();
        }

        // Map a range in normalized space back to original space
        function normRangeToOrig(normStart, normLen) {
            var origStart = posMap[normStart] || 0;
            var lastNorm = Math.min(normStart + normLen - 1, posMap.length - 1);
            var origEnd = (posMap[lastNorm] || 0) + 1;
            return { start: origStart, end: origEnd };
        }

        // Find match positions for all known clauses
        var matches = [];
        for (var i = 0; i < clauseHighlightData.length; i++) {
            var d = clauseHighlightData[i];
            var searchText = escapeHtml(d.quote.substring(0, 60).trim());
            var idx = -1;
            var end;

            // ── Start match: try exact, then case-insensitive, then normalized ──
            idx = text.indexOf(searchText);
            if (idx === -1) idx = text.toLowerCase().indexOf(searchText.toLowerCase());

            if (idx >= 0) {
                // Found via exact/case-insensitive — find end the original way
                var endSearch = d.quote.length > 80 ? escapeHtml(d.quote.substring(d.quote.length - 30)) : '';
                var endIdx = endSearch ? text.indexOf(endSearch, idx) : -1;
                if (endIdx === -1 && endSearch) endIdx = text.toLowerCase().indexOf(endSearch.toLowerCase(), idx);
                // Normalized fallback for end match
                if (endIdx === -1 && endSearch) {
                    var endNorm = normalizeStr(endSearch);
                    var startNormSearch = 0;
                    for (var si = 0; si < posMap.length; si++) {
                        if (posMap[si] >= idx) { startNormSearch = si; break; }
                    }
                    var endNormIdx = normalized.indexOf(endNorm, startNormSearch);
                    if (endNormIdx >= 0) {
                        var endRange = normRangeToOrig(endNormIdx, endNorm.length);
                        end = endRange.end;
                    } else {
                        end = idx + searchText.length;
                    }
                } else {
                    end = endIdx > idx ? endIdx + endSearch.length : idx + searchText.length;
                }
            } else {
                // Try normalized whitespace match
                var searchNorm = normalizeStr(searchText);
                var normIdx = normalized.indexOf(searchNorm);
                if (normIdx >= 0) {
                    var startRange = normRangeToOrig(normIdx, searchNorm.length);
                    idx = startRange.start;
                    end = startRange.end;
                    // Try to extend to full quote end
                    if (d.quote.length > 80) {
                        var endNorm2 = normalizeStr(escapeHtml(d.quote.substring(d.quote.length - 30)));
                        var endNormIdx2 = normalized.indexOf(endNorm2, normIdx);
                        if (endNormIdx2 >= 0) {
                            end = normRangeToOrig(endNormIdx2, endNorm2.length).end;
                        }
                    }
                }

                // Try first significant words as anchor
                if (idx === -1) {
                    var rawQuote = escapeHtml(d.quote.trim());
                    var words = rawQuote.replace(/\s+/g, ' ').trim().split(' ').filter(function(w) { return w.length > 3; });
                    if (words.length >= 3) {
                        var anchor = normalizeStr(words.slice(0, 4).join(' '));
                        var anchorIdx = normalized.indexOf(anchor);
                        if (anchorIdx >= 0) {
                            var anchorRange = normRangeToOrig(anchorIdx, anchor.length);
                            idx = anchorRange.start;
                            end = anchorRange.end;
                        }
                    }
                }
            }

            if (idx === -1) continue;
            matches.push({ start: idx, end: end, cardIndex: d.cardIndex, risk: d.risk });
        }

        // Sort by position, remove overlaps
        matches.sort(function(a, b) { return a.start - b.start; });
        var filtered = [];
        var lastEnd = -1;
        for (var i = 0; i < matches.length; i++) {
            if (matches[i].start >= lastEnd) {
                filtered.push(matches[i]);
                lastEnd = matches[i].end;
            }
        }

        // Build HTML in one pass
        var html = '';
        var pos = 0;
        for (var i = 0; i < filtered.length; i++) {
            var m = filtered[i];
            html += text.substring(pos, m.start);
            var num = m.cardIndex + 1;
            html += '<span class="doc-highlight doc-highlight-' + m.risk + '" data-card-index="' + m.cardIndex + '">' +
                '<span class="doc-clause-marker doc-clause-marker-' + m.risk + '">' + num + '</span>' +
                text.substring(m.start, m.end) + '</span>';
            pos = m.end;
        }
        html += text.substring(pos);

        previewEl.innerHTML = html;
    }

    function syncSidebarHeight(cardEl) {
        var editLoading = document.querySelector('.editorial-loading');
        if (!editLoading || window.innerWidth <= 900) return;
        requestAnimationFrame(function() {
            var cardH = cardEl.getBoundingClientRect().height;
            editLoading.style.height = Math.max(250, cardH) + 'px';
        });
    }

    function scrollPreviewToCard(cardIndex) {
        var previewEl = $('editorialLoadingText');
        if (!previewEl) return;

        // Remove active from all highlights
        var highlights = previewEl.querySelectorAll('.doc-highlight');
        for (var i = 0; i < highlights.length; i++) {
            highlights[i].classList.remove('active');
        }

        // Activate the matching highlight
        var target = previewEl.querySelector('.doc-highlight[data-card-index="' + cardIndex + '"]');
        if (target) {
            target.classList.add('active');
            // Scroll into view within the scrollable preview
            var containerTop = previewEl.scrollTop;
            var containerHeight = previewEl.clientHeight;
            var elTop = target.offsetTop - previewEl.offsetTop;
            if (elTop < containerTop || elTop > containerTop + containerHeight - 40) {
                previewEl.scrollTop = elTop - 40;
            }
        }
    }

    // ── Transition from editorial loading to card view ────────
    function transitionToCardView() {
        cardViewTransitioned = true;
        stopEditorialStatusRotation();
        var statusEl = $('editorialLoadingStatus');
        if (statusEl) statusEl.textContent = 'Analysis in progress...';

        var skeleton = $('skeletonCard');
        var viewport = $('cardViewport');

        // Skeleton fades out, real card fades in — sidebar already visible
        skeleton.classList.add('hidden');
        viewport.classList.remove('hidden');
        resultsArea.classList.remove('hidden');
        showCardAtIndex(0);

        // Pulse the first flip trigger to draw attention
        var firstTrigger = viewport.querySelector('.flip-trigger');
        if (firstTrigger) {
            firstTrigger.classList.add('hint-pulse');
            var tooltip = document.createElement('span');
            tooltip.className = 'flip-hint-tooltip';
            tooltip.textContent = 'Tap to see what they\u2019re not telling you';
            firstTrigger.appendChild(tooltip);
        }
    }

    // ── Verdict column helpers (4-section live report) ─────────────────
    function showVerdictCol() {
        verdictCol.classList.add('visible');
        verdictCol.classList.add('writing');
        // On mobile, auto-show bottom sheet in peek state
        if (window.innerWidth <= 900 && window._setSheetState) {
            window._setSheetState('peek');
        }
    }
    function hideVerdictCol() {
        verdictCol.classList.remove('visible');
        // On mobile, close bottom sheet
        if (window.innerWidth <= 900) {
            document.body.classList.remove('sheet-open');
        }
    }
    function renderOpusSection(source) {
        if (!_verdictRenderTimers[source]) {
            _verdictRenderTimers[source] = setTimeout(function() {
                _verdictRenderTimers[source] = null;
                // Show verdict column as soon as we get first text
                if (!verdictCol.classList.contains('visible') && !isCompareMode && !documentNotApplicable && hasFlippedOnce) {
                    showVerdictCol();
                }
                var bodyEl = $('opusBody_' + source);
                if (!bodyEl) return;
                var text = opusSections[source].text;
                if (!text.trim()) return;
                var html = safeMd2Html(text);
                html = styleRiskBadges(html);
                html = styleReaderBlocks(html);
                html = styleDrafterBlocks(html);
                bodyEl.innerHTML = safeHtml(html);
                // Append cursor while streaming
                if (!opusSections[source].done) {
                    var cur = document.createElement('span');
                    cur.className = 'verdict-cursor';
                    bodyEl.appendChild(cur);
                }
                // If user is viewing this section in focused mode, update live
                if (_focusedSource === source) {
                    var contentEl = $('focusedContent');
                    if (contentEl) {
                        var fHtml = safeMd2Html(text);
                        fHtml = styleRiskBadges(fHtml);
                        fHtml = styleReaderBlocks(fHtml);
                        fHtml = styleDrafterBlocks(fHtml);
                        contentEl.innerHTML = safeHtml(fHtml);
                        if (!opusSections[source].done) {
                            var fc = document.createElement('span');
                            fc.className = 'verdict-cursor';
                            contentEl.appendChild(fc);
                        }
                    }
                }
            }, 200);
        }
    }
    function markOpusSectionDone(source) {
        var sectionEl = $('opusSection_' + source);
        if (!sectionEl) return;
        // Gate: "overall" waits for the other 3 to finish first —
        // it's a summary and shouldn't appear done before its parts.
        if (source === 'overall') {
            var partsReady = opusSections.interactions.done
                          && opusSections.asymmetry.done
                          && opusSections.archaeology.done;
            if (!partsReady) {
                // Data is accumulated; we'll reveal when the last part finishes
                return;
            }
        }
        // When a non-overall section finishes, check if overall is waiting
        if (source !== 'overall' && opusSections.overall.done) {
            var allPartsNow = opusSections.interactions.done
                           && opusSections.asymmetry.done
                           && opusSections.archaeology.done;
            if (allPartsNow) {
                // Release the held-back overall section
                _revealOpusSection('overall');
            }
        }
        _revealOpusSection(source);
    }
    function _revealOpusSection(source) {
        var sectionEl = $('opusSection_' + source);
        if (!sectionEl) return;
        // Unlock section: remove locked, mark dot as done
        sectionEl.classList.remove('locked');
        var dot = sectionEl.querySelector('.opus-dot');
        if (dot) { dot.classList.remove('pulsing'); dot.classList.add('done'); }
        // Fade out invitation on first section reveal
        var invEl = $('verdictInvitation');
        if (invEl && !invEl.classList.contains('fading')) {
            invEl.classList.add('fading');
            setTimeout(function() { invEl.classList.add('hidden'); }, 600);
        }
        // Don't auto-expand — user clicks to enter focused mode instead
        // Just do final render into the hidden body (ready when user clicks)
        var bodyEl = $('opusBody_' + source);
        if (bodyEl) {
            var text = opusSections[source].text;
            if (text.trim()) {
                var html = safeMd2Html(text);
                html = styleRiskBadges(html);
                html = styleWhyClauses(html);
                html = styleReaderBlocks(html);
                html = styleDrafterBlocks(html);
                html = styleSplitClauses(html);
                bodyEl.innerHTML = safeHtml(html);
            }
        }
        // If user is in focused mode, update the counter (new section available)
        if (_focusedSource) renderFocusedSection();
        // Update "Read full verdict" button visibility
        updateVerdictButton();
    }

    function updateVerdictButton() {
        var allDone = getCompletedSections().length === 4;
        if (allDone) {
            verdictExpandBtn.innerHTML = 'Read full verdict <span class="verdict-expand-spin">\u27F3</span>';
            verdictExpandBtn.classList.add('ready');
            verdictExpandBtn.style.opacity = '1';
            verdictExpandBtn.style.pointerEvents = 'auto';
            buildVerdictSummary();
        } else {
            var count = getCompletedSections().length;
            verdictExpandBtn.textContent = count + ' of 4 ready';
            verdictExpandBtn.classList.remove('ready');
            verdictExpandBtn.style.opacity = '0.4';
            verdictExpandBtn.style.pointerEvents = 'none';
        }
    }

    function buildVerdictSummary() {
        var el = $('verdictSummary');
        if (!el || el.classList.contains('visible')) return;
        var overall = opusSections.overall.text || '';

        // Extract the first substantive prose sentence as a clean conclusion
        var lines = overall.split('\n');
        var conclusion = '';
        for (var i = 0; i < lines.length; i++) {
            var l = lines[i].trim().replace(/\*\*/g, '').replace(/\*/g, '');
            // Skip headings, scores, labels, numbered lists, empty lines
            if (!l || l.startsWith('#') || l.startsWith('---') || /^Overall Risk/i.test(l) || /^Power Imbalance/i.test(l) || /^Verdict:/i.test(l) || /^\d+\/100/.test(l) || /^SEVERITY/i.test(l) || /^\d+\.\s/.test(l) || /^\d+:\d+/.test(l) || l.length < 20) continue;
            conclusion = l;
            break;
        }

        if (!conclusion) return;
        if (conclusion.length > 200) conclusion = conclusion.substring(0, 198).replace(/\s+\S*$/, '') + '…';
        el.innerHTML = '<div style="font-size:0.72rem;color:var(--text-secondary);line-height:1.5">' + escapeHtml(conclusion) + '</div>';
        el.classList.add('visible');
    }
    function resetVerdictCol() {
        hideVerdictCol();
        exitFocusedMode();
        verdictCol.classList.remove('standby', 'thinking', 'writing', 'ready', 'collapsed');
        // Reset doc profile in verdict
        var vProfile = $('verdictDocProfile');
        if (vProfile) vProfile.classList.add('hidden');
        var vMeta = $('verdictDocMeta');
        if (vMeta) vMeta.innerHTML = '';
        var vThumb = $('verdictDocThumb');
        if (vThumb) vThumb.classList.add('hidden');
        verdictTitle.textContent = 'Expert report';
        verdictExpandBtn.textContent = '0 of 4 ready';
        verdictExpandBtn.classList.remove('ready');
        verdictExpandBtn.style.opacity = '0.4';
        verdictExpandBtn.style.pointerEvents = 'none';
        var summaryEl = $('verdictSummary');
        if (summaryEl) { summaryEl.innerHTML = ''; summaryEl.classList.remove('visible'); }
        _verdictAutoScroll = true;
        Object.keys(_verdictRenderTimers).forEach(function(k) { clearTimeout(_verdictRenderTimers[k]); });
        _verdictRenderTimers = {};
        // Reset accumulators and section UI — lock all sections
        Object.keys(opusSections).forEach(function(k) {
            opusSections[k] = { text: '', done: false };
            var bodyEl = $('opusBody_' + k);
            if (bodyEl) { bodyEl.innerHTML = ''; bodyEl.classList.add('collapsed'); }
            var sectionEl = $('opusSection_' + k);
            if (sectionEl) sectionEl.classList.add('locked');
            var dot = document.querySelector('#opusSection_' + k + ' .opus-dot');
            if (dot) { dot.classList.remove('done'); dot.classList.add('pulsing'); }
        });
        var verdictStatusEl = $('verdictStatus');
        if (verdictStatusEl) {
            verdictStatusEl.innerHTML = 'Our expert is reading the small print <span class="verdict-time-pill" id="verdictCountdown">2:00</span>';
            verdictStatusEl.classList.remove('hidden');
        }
        var invEl = $('verdictInvitation');
        if (invEl) { invEl.classList.remove('hidden', 'fading'); }
        // Reset live tricks panel
        _detectedTricks = {};
        var tricksPanel = $('verdictTricks');
        if (tricksPanel) tricksPanel.classList.add('hidden');
        var tricksList = $('verdictTricksList');
        if (tricksList) tricksList.innerHTML = '';
        startVerdictCountdown();
    }

    // ── Live tricks panel ──────────────────────────────────
    function trackTrick(trick) {
        if (!trick || trick.toLowerCase() === 'none') return;
        _detectedTricks[trick] = (_detectedTricks[trick] || 0) + 1;
        renderVerdictTricks();
    }

    function renderVerdictTricks() {
        var panel = $('verdictTricks');
        var list = $('verdictTricksList');
        if (!panel || !list) return;

        var sorted = Object.keys(_detectedTricks).sort(function(a, b) {
            return _detectedTricks[b] - _detectedTricks[a];
        });
        if (sorted.length === 0) { panel.classList.add('hidden'); return; }

        // Top 10
        var top = sorted.slice(0, 10);
        var html = '';
        top.forEach(function(trick) {
            var icon = TRICK_ICONS[trick] || '';
            var desc = TRICK_DESCRIPTIONS[trick] || '';
            var count = _detectedTricks[trick];
            html += '<span class="verdict-trick-item">';
            if (icon) html += '<span class="verdict-trick-icon">' + icon + '</span>';
            html += '<span class="verdict-trick-name">' + escapeHtml(trick) + '</span>';
            if (count > 1) html += '<span class="verdict-trick-count">\u00d7' + count + '</span>';
            if (desc) html += '<span class="verdict-trick-tooltip">' + escapeHtml(desc) + '</span>';
            html += '</span>';
        });
        list.innerHTML = html;
        panel.classList.remove('hidden');
    }

    // ── Focused reading mode state ──────────────────────────
    var _focusedSource = null; // currently focused section key or null
    var _sectionOrder = ['interactions', 'asymmetry', 'archaeology', 'overall'];
    var _sectionLabels = {
        interactions: 'Cross-Clause Interactions',
        asymmetry: 'Power Asymmetry & Fair Standard',
        archaeology: 'Document Archaeology & Drafter',
        overall: 'Overall Assessment'
    };

    function getCompletedSections() {
        return _sectionOrder.filter(function(k) {
            // For "overall", check if all parts are done too (gating logic)
            if (k === 'overall') {
                return opusSections.overall.done
                    && opusSections.interactions.done
                    && opusSections.asymmetry.done
                    && opusSections.archaeology.done;
            }
            return opusSections[k].done;
        });
    }

    function enterFocusedMode(source) {
        _focusedSource = source;
        verdictBody.classList.add('in-focus');
        var panel = $('verdictFocusedPanel');
        panel.classList.add('active');
        renderFocusedSection();
    }

    function exitFocusedMode() {
        _focusedSource = null;
        verdictBody.classList.remove('in-focus');
        var panel = $('verdictFocusedPanel');
        panel.classList.remove('active');
    }

    function renderFocusedSection() {
        if (!_focusedSource) return;
        var completed = getCompletedSections();
        var idx = completed.indexOf(_focusedSource);
        var total = completed.length;
        var allDone = total === 4;

        // Title
        $('focusedTitle').textContent = _sectionLabels[_focusedSource] || _focusedSource;

        // Content
        var contentEl = $('focusedContent');
        var text = opusSections[_focusedSource].text;
        if (text.trim()) {
            var html = safeMd2Html(text);
            html = styleRiskBadges(html);
            html = styleWhyClauses(html);
            html = styleReaderBlocks(html);
            html = styleDrafterBlocks(html);
            html = styleSplitClauses(html);
            contentEl.innerHTML = safeHtml(html);
        } else {
            contentEl.innerHTML = '<p style="color:var(--text-muted);font-style:italic;">Content loading...</p>';
        }
        contentEl.scrollTop = 0;

        // Nav arrows
        $('focusedPrev').disabled = (idx <= 0);
        $('focusedNext').disabled = (idx >= total - 1);

        // Counter: "Section 1 · 2 of 4 ready" or "Section 1 · Full report ready →"
        var counterEl = $('focusedCounter');
        if (allDone) {
            counterEl.innerHTML = 'Section ' + (idx + 1) + ' of ' + total + ' · <a class="ready-link" id="focusedReadAll">Full report ready \u2192</a>';
            var readAllLink = $('focusedReadAll');
            if (readAllLink) {
                readAllLink.addEventListener('click', function() {
                    exitFocusedMode();
                    revealDeepAnalysis();
                });
            }
        } else {
            counterEl.textContent = 'Section ' + (idx + 1) + ' \u00b7 ' + total + ' of 4 ready';
        }
    }

    function navigateFocused(dir) {
        if (!_focusedSource) return;
        var completed = getCompletedSections();
        var idx = completed.indexOf(_focusedSource);
        var next = idx + dir;
        if (next >= 0 && next < completed.length) {
            _focusedSource = completed[next];
            renderFocusedSection();
        }
    }

    // Click handler: open focused mode on completed sections, block pulsing ones
    verdictBody.addEventListener('click', function(e) {
        var header = e.target.closest('.opus-section-header');
        if (!header) return;
        var source = header.getAttribute('data-toggle');
        if (!source) return;
        // Block click on locked/pulsing sections
        var sectionEl = $('opusSection_' + source);
        if (sectionEl && sectionEl.classList.contains('locked')) return;
        if (!opusSections[source].done) return;
        // Enter focused reading mode
        enterFocusedMode(source);
    });

    // Focused panel navigation
    $('focusedClose').addEventListener('click', function() { exitFocusedMode(); });
    $('focusedPrev').addEventListener('click', function() { navigateFocused(-1); });
    $('focusedNext').addEventListener('click', function() { navigateFocused(1); });

    // Stop auto-scroll if user scrolls up in verdict column
    verdictBody.addEventListener('scroll', function() {
        var atBottom = verdictBody.scrollHeight - verdictBody.scrollTop - verdictBody.clientHeight < 40;
        _verdictAutoScroll = atBottom;
    });

    // ── Reveal full verdict (progressive — streams as it builds) ──────
    var _verdictPollTimer = null;
    var _verdictScrolled = false;

    function assembleDeepText() {
        // Assemble deep analysis from 4 Opus accumulators
        var parts = [];
        if (opusSections.interactions.text.trim()) parts.push(opusSections.interactions.text);
        if (opusSections.asymmetry.text.trim()) parts.push(opusSections.asymmetry.text);
        if (opusSections.archaeology.text.trim()) parts.push(opusSections.archaeology.text);
        if (opusSections.overall.text.trim()) parts.push(opusSections.overall.text);
        return parts.join('\n\n');
    }

    function revealDeepAnalysis() {
        var section = $('deepAnalysisSection');
        var deepText = assembleDeepText();
        var hasDeepContent = deepText.trim().length > 0;
        var isComplete = deepTextComplete || isDoneRendering;

        if (_verdictPollTimer) { clearTimeout(_verdictPollTimer); _verdictPollTimer = null; }

        section.classList.remove('hidden');
        $('cardViewport').classList.add('hidden');
        hideVerdictCol();

        if (isComplete && hasDeepContent) {
            renderDeepAnalysisContent();
            buildSummaryCard();
            buildPlaybookCard();
            if (!isCompareMode) counterDraftSection.classList.remove('hidden');
            if (!_verdictScrolled) {
                _verdictScrolled = true;
                setTimeout(function() { section.scrollIntoView({ behavior: 'smooth', block: 'start' }); }, 50);
            }
            return;
        }

        // Add header once
        if (!deepAnalysisEl.previousElementSibling || !deepAnalysisEl.previousElementSibling.classList.contains('deep-analysis-header')) {
            var header = document.createElement('div');
            header.className = 'deep-analysis-header';
            header.innerHTML = '<span class="section-label">Full Verdict</span>' +
                '<span class="opus-badge">Opus 4.6 Reasoning</span>';
            deepAnalysisEl.parentNode.insertBefore(header, deepAnalysisEl);
        }

        if (hasDeepContent) {
            var safeMd = deepText
                .replace(/^# .+$/gm, '')
                .replace(/\[READER\]\s*:/g, 'FLIPSIDE_READER:')
                .replace(/\[DRAFTER\]\s*:/g, 'FLIPSIDE_DRAFTER:')
                .replace(/^READER\s*:/gm, 'FLIPSIDE_READER:')
                .replace(/^DRAFTER\s*:/gm, 'FLIPSIDE_DRAFTER:');
            var html = safeMd2Html(safeMd);
            html = styleRiskBadges(html);
            html = styleReaderBlocks(html);
            html = styleDrafterBlocks(html);
            deepAnalysisEl.innerHTML = safeHtml(html);
        } else {
            deepAnalysisEl.innerHTML = '';
        }

        var indicator = document.createElement('div');
        indicator.className = 'verdict-streaming';
        indicator.innerHTML = '<div class="pulsing-dots"><span></span><span></span><span></span></div>' +
            '<div class="verdict-streaming-label">' +
            (hasDeepContent ? 'Building your Full Verdict — almost there...' : 'Our expert is reading and reasoning — this takes about a minute') + '</div>';
        deepAnalysisEl.appendChild(indicator);

        if (!_verdictScrolled) {
            _verdictScrolled = true;
            setTimeout(function() { section.scrollIntoView({ behavior: 'smooth', block: 'start' }); }, 50);
        }

        _verdictPollTimer = setTimeout(function() { revealDeepAnalysis(); }, 800);
    }

    // ── Show one card, hide rest, update nav ─────────────────
    // ── Insight column: "What you should read" + "What does this mean for you" ──
    // Highlight dollar amounts, percentages, and day counts in text
    function highlightNumbers(text) {
        return escapeHtml(text).replace(
            /(\$[\d,]+(?:\.\d{2})?|\d+%|\d+\s*(?:days?|months?|years?|hours?))/gi,
            '<span class="insight-num">$1</span>'
        );
    }

    // ── Clause whoosh: ghost pill flies from sidebar highlight → pill on card ──
    function whooshClauseToCard(cardIndex, cardEl) {
        if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
            // Still reveal the pill, just without animation
            var pillNoAnim = cardEl.querySelector('.front-quote-pill[data-card-pill="' + cardIndex + '"]');
            if (pillNoAnim) pillNoAnim.classList.add('revealed');
            return;
        }
        var previewEl = $('editorialLoadingText');
        if (!previewEl) return;
        var highlight = previewEl.querySelector('.doc-highlight[data-card-index="' + cardIndex + '"]');

        // Target: the quote pill on the card front
        var pill = cardEl.querySelector('.front-quote-pill[data-card-pill="' + cardIndex + '"]');
        if (!pill) return;

        // If no sidebar highlight found, just reveal the pill directly
        if (!highlight) {
            pill.classList.add('revealed');
            return;
        }

        // Flash the sidebar highlight
        highlight.classList.remove('whoosh-flash');
        void highlight.offsetWidth;
        highlight.classList.add('whoosh-flash');

        var risk = (cardEl.getAttribute('data-risk-level') || 'green');
        var sourceRect = highlight.getBoundingClientRect();
        var pillRect = pill.getBoundingClientRect();

        // Build ghost — matches pill styling
        var ghost = document.createElement('div');
        ghost.className = 'clause-whoosh-ghost clause-whoosh-ghost-' + risk;
        var num = cardIndex + 1;
        var quote = (cardEl.getAttribute('data-quote') || '').substring(0, 50);
        if (quote.length >= 49) quote += '\u2026';
        ghost.innerHTML = '<span class="ghost-num">' + num + '</span><span class="ghost-text">\u201c' + escapeHtml(quote) + '\u201d</span>';
        document.body.appendChild(ghost);

        // Position at sidebar highlight center
        var gw = ghost.offsetWidth;
        var gh = ghost.offsetHeight;
        var srcX = sourceRect.left + sourceRect.width / 2 - gw / 2;
        var srcY = sourceRect.top + sourceRect.height / 2 - gh / 2;
        ghost.style.left = srcX + 'px';
        ghost.style.top = srcY + 'px';

        // Fly to the pill
        var dx = pillRect.left + pillRect.width / 2 - gw / 2 - srcX;
        var dy = pillRect.top + pillRect.height / 2 - gh / 2 - srcY;
        var midX = dx * 0.5;
        var midY = Math.min(dy * 0.3, dy - 40);  // arc upward

        ghost.animate([
            { transform: 'translate(0, 0) scale(0.9)', opacity: 0.6 },
            { transform: 'translate(0, 0) scale(1.08)', opacity: 1, offset: 0.08 },
            { transform: 'translate(' + midX + 'px, ' + midY + 'px) scale(1.12)', opacity: 1, offset: 0.45 },
            { transform: 'translate(' + dx + 'px, ' + dy + 'px) scale(1)', opacity: 1, offset: 0.82 },
            { transform: 'translate(' + dx + 'px, ' + dy + 'px) scale(0.97)', opacity: 0 }
        ], { duration: 900, easing: 'ease-in-out', fill: 'forwards' })
        .onfinish = function() {
            ghost.remove();
            // Reveal the pill — ghost "deposited" the quote into the card
            pill.classList.add('revealed');
        };
    }

    function showCardAtIndex(index) {
        var cards = flipCardContainer.querySelectorAll('.flip-card');
        if (index < 0 || index >= cards.length) return;

        currentCardIndex = index;
        if (index > _maxCardReached) _maxCardReached = index;
        // Restore side columns when navigating (un-flips the card)
        var layout = flipCardContainer.closest('.analysis-layout');
        if (layout) layout.classList.remove('layout-flipped');
        var isFirstAppearance = false;
        for (var i = 0; i < cards.length; i++) {
            if (i === index) {
                cards[i].classList.remove('hidden');
                cards[i].classList.remove('flipped'); // un-flip on navigate
                if (!cards[i].classList.contains('woosh-done')) {
                    cards[i].classList.add('woosh-in', 'woosh-done');
                    isFirstAppearance = true;
                }
            } else {
                cards[i].classList.add('hidden');
            }
        }

        // Animate score bar on visible card
        var visibleCard = cards[index];
        var scoreBarFill = visibleCard.querySelector('.back-score-bar-fill');
        if (scoreBarFill && !scoreBarFill.style.width) {
            var targetWidth = scoreBarFill.getAttribute('data-width');
            setTimeout(function() { scoreBarFill.style.width = targetWidth + '%'; }, 100);
        }

        // Refresh highlights and scroll to current card
        rebuildPreviewHighlights();
        scrollPreviewToCard(index);

        // Whoosh ghost from sidebar to card on first appearance (desktop)
        if (isFirstAppearance && window.innerWidth > 900) {
            // Small delay so card is visible and positioned before we read rects
            setTimeout(function() { whooshClauseToCard(index, visibleCard); }, 150);
        } else {
            // Revisited card or mobile — just ensure pill is visible
            var pill = visibleCard.querySelector('.front-quote-pill');
            if (pill && !pill.classList.contains('revealed')) pill.classList.add('revealed');
        }

        // Update chapter title — persistent editorial voice
        updateChapterTitle(index, cards.length, visibleCard);

        updateCardNavigation();

        // Sync sidebar height to match the visible card
        syncSidebarHeight(visibleCard);
    }

    var chapterPhrases = [
        'Everything looks standard\u2026 until you flip it.',
        'The fine print gets finer.',
        'Another clause, another assumption.',
        'This one reads quickly. That\u2019s the point.',
        'Standard language. Unusual implications.',
        'The drafter wrote this one carefully.',
        'Almost done. The pattern is forming.',
        'One more look before the verdict.',
        'What you skip is what they keep.',
        'Familiar words. Unfamiliar consequences.',
        'They buried the important part.',
        'Read this one slowly.',
    ];

    function updateChapterTitle(index, total, cardEl) {
        var ct = $('chapterTitle');
        var counter = $('chapterCounter');
        var text = $('chapterText');
        if (!ct || !counter || !text) return;

        counter.textContent = '';

        // Pick phrase: first card gets the hook, last card gets the closer
        var phrase;
        if (index === 0) {
            phrase = chapterPhrases[0];
        } else if (flipCardsBuilt && index === total - 1) {
            phrase = chapterPhrases[7]; // "One more look before the verdict."
        } else {
            // Rotate through middle phrases based on card index
            phrase = chapterPhrases[((index - 1) % (chapterPhrases.length - 2)) + 1];
        }
        text.textContent = phrase;
        ct.classList.add('visible');
    }

    // ── Update card navigation state ─────────────────────────
    function updateCardNavigation() {
        var cards = flipCardContainer.querySelectorAll('.flip-card');
        var total = cards.length;
        var nav = $('cardNavigation');
        if (!nav) return;

        if (total === 0 || !hasFlippedOnce) { nav.classList.add('hidden'); return; }

        nav.classList.remove('hidden');
        var counter = nav.querySelector('.card-nav-counter');
        var prevBtn = nav.querySelector('.card-nav-prev');
        var nextBtn = nav.querySelector('.card-nav-next');
        var nextLabel = nextBtn.querySelector('.card-nav-next-label');

        counter.innerHTML = 'Clause <strong>' + (currentCardIndex + 1) + '</strong> of <strong>' + total + '</strong>';
        prevBtn.disabled = currentCardIndex === 0;

        if (currentCardIndex >= total - 1 && !quickDone) {
            nextLabel.innerHTML = 'Analyzing next<span class="pulsing-dot"></span>';
            nextBtn.disabled = true;
            nextBtn.removeAttribute('data-action');
        } else if (currentCardIndex >= total - 1 && flipCardsBuilt) {
            // Check if deep analysis text has fully streamed
            var opusDone = deepTextComplete || isDoneRendering;
            if (opusDone) {
                nextLabel.textContent = 'Full Verdict \u2192';
            } else {
                nextLabel.innerHTML = 'Full Verdict <span class="pulsing-dot" style="margin-left:0.3rem"></span>';
            }
            nextBtn.disabled = false;
            nextBtn.setAttribute('data-action', 'assessment');
        } else {
            nextLabel.textContent = 'Next clause \u2192';
            nextBtn.disabled = false;
            nextBtn.removeAttribute('data-action');
        }

        // Mobile dot indicator
        updateCardDots(cards, total);
    }

    function updateCardDots(cards, total) {
        var dotsEl = $('cardNavDots');
        if (!dotsEl) return;
        if (window.innerWidth > 900) { dotsEl.innerHTML = ''; return; }
        // Rebuild dots if count changed
        if (dotsEl.children.length !== total) {
            dotsEl.innerHTML = '';
            for (var d = 0; d < total; d++) {
                var dot = document.createElement('span');
                dot.className = 'card-nav-dot';
                dot.setAttribute('data-index', d);
                dot.addEventListener('click', (function(idx) {
                    return function() { showCardAtIndex(idx); };
                })(d));
                dotsEl.appendChild(dot);
            }
        }
        // Update active + risk colors
        for (var d = 0; d < dotsEl.children.length; d++) {
            var dot = dotsEl.children[d];
            dot.classList.remove('active', 'risk-red', 'risk-yellow', 'risk-green');
            if (d === currentCardIndex) dot.classList.add('active');
            // Color by risk level if card has been flipped
            if (cards[d]) {
                var risk = cards[d].getAttribute('data-risk-level');
                if (risk && cards[d].classList.contains('woosh-done')) {
                    dot.classList.add('risk-' + risk);
                }
            }
        }
    }

    // ── Phase 3: Render deep analysis into separate container ──
    function renderDeepAnalysisContent() {
        var deepText = assembleDeepText();
        if (!deepText.trim()) return;

        // Add Opus header once
        if (!deepAnalysisEl.previousElementSibling || !deepAnalysisEl.previousElementSibling.classList.contains('deep-analysis-header')) {
            var header = document.createElement('div');
            header.className = 'deep-analysis-header';
            header.innerHTML = '<span class="section-label">Full Verdict</span>' +
                '<span class="opus-badge">Opus 4.6 Reasoning</span>';
            deepAnalysisEl.parentNode.insertBefore(header, deepAnalysisEl);
        }

        var safeMd = deepText
            // Strip Opus-generated H1 titles (redundant with our H2 section labels)
            .replace(/^# .+$/gm, '')
            .replace(/\[READER\]\s*:/g, 'FLIPSIDE_READER:')
            .replace(/\[DRAFTER\]\s*:/g, 'FLIPSIDE_DRAFTER:')
            .replace(/^READER\s*:/gm, 'FLIPSIDE_READER:')
            .replace(/^DRAFTER\s*:/gm, 'FLIPSIDE_DRAFTER:');
        var html = safeMd2Html(safeMd);
        html = styleRiskBadges(html);
        html = styleWhyClauses(html);
        html = styleReaderBlocks(html);
        html = styleDrafterBlocks(html);
        html = styleSplitClauses(html);
        deepAnalysisEl.innerHTML = safeHtml(html);

        wrapClauseSections(deepAnalysisEl);

        // Promote "How Opus 4.6 Analyzed This" to a callout near the top
        promoteOpusMethodSection(deepAnalysisEl);

        // Animate new deep analysis cards
        deepAnalysisEl.querySelectorAll('.cross-clause-card, .playbook-card, .assessment-card').forEach(function(card) {
            var title = card.getAttribute('data-clause-title');
            if (title && !animatedCardTitles.has(title)) {
                animatedCardTitles.add(title);
                card.classList.add('new-card');
                setTimeout(function() { card.classList.remove('new-card'); }, 500);
            }
        });

        // Try to update drafter voice on flip cards from deep analysis [DRAFTER] blocks
        updateDrafterVoices(deepText);
    }

    // ── Update drafter voice text on flip cards from deep analysis ──
    function updateDrafterVoices(deepText) {
        var drafterParts = deepText.split(/(?=^### )/m);
        for (var i = 0; i < drafterParts.length; i++) {
            var part = drafterParts[i];
            var headerMatch = part.match(/^### \s*(.+?)\s*(?:\(|$)/m);
            if (!headerMatch) continue;

            var drafterMatch = part.match(/\[DRAFTER\]\s*:\s*([\s\S]*?)(?=\n\n|\n###|$)/i);
            if (!drafterMatch) continue;

            var clauseTitle = headerMatch[1].trim();
            var drafterText = drafterMatch[1].trim();
            if (!drafterText) continue;

            // Find matching flip card and update its drafter-voice-text
            var cards = flipCardContainer.querySelectorAll('.flip-card');
            for (var j = 0; j < cards.length; j++) {
                var cardTitle = cards[j].getAttribute('data-clause-title');
                if (cardTitle && (cardTitle === clauseTitle || cardTitle === escapeHtml(clauseTitle))) {
                    var voiceEl = cards[j].querySelector('.drafter-voice-text');
                    if (voiceEl && voiceEl.textContent.indexOf('Deep analysis in progress') >= 0) {
                        voiceEl.textContent = drafterText;
                    }
                    break;
                }
            }
        }
    }

    // ── Editorial status rotation ──────────────────────────
    var editorialStatusMessages = [
        'FlipSide is reading between the lines...',
        'Adopting the drafter\u2019s perspective...',
        'Looking for what\u2019s hidden in plain sight...',
        'Every clause exists for a reason...',
        'The boring parts are the dangerous parts...'
    ];

    function startEditorialStatusRotation() {
        stopEditorialStatusRotation();
        editorialStatusIdx = 0;
        editorialStatusInterval = setInterval(function() {
            editorialStatusIdx = (editorialStatusIdx + 1) % editorialStatusMessages.length;
            var el = $('editorialLoadingStatus');
            if (el) el.textContent = editorialStatusMessages[editorialStatusIdx];
        }, 4000);
    }

    function stopEditorialStatusRotation() {
        if (editorialStatusInterval) { clearInterval(editorialStatusInterval); editorialStatusInterval = null; }
    }

    // ── Clause card wrapping ──────────────────────────────────
    function wrapClauseSections(container) {
        container = container || resultsContent;

        // Remove any Opus-generated H1 titles (redundant with our section labels)
        container.querySelectorAll('h1').forEach(function(h1) { h1.remove(); });

        // Add editorial dividers before H2 section headings (Cross-Clause, Playbook, Assessment)
        container.querySelectorAll('h2').forEach(function(h2) {
            if (h2.previousElementSibling && !h2.previousElementSibling.classList.contains('editorial-divider')) {
                var divider = document.createElement('hr');
                divider.className = 'editorial-divider';
                h2.parentNode.insertBefore(divider, h2);
            }
            // Style H2 as section-label
            h2.classList.add('section-label');
            h2.style.fontSize = '0.75rem';
            h2.style.marginBottom = '1rem';
            h2.style.marginTop = '0.5rem';
        });

        var headings = container.querySelectorAll('h3');

        headings.forEach(function(h3) {
            if (h3.parentElement.classList.contains('clause-card') ||
                h3.parentElement.classList.contains('cross-clause-card') ||
                h3.parentElement.classList.contains('playbook-card') ||
                h3.parentElement.classList.contains('assessment-card')) return;

            var sectionType = getSectionType(h3);
            var cardClass = sectionType === 'cross' ? 'cross-clause-card' :
                            sectionType === 'playbook' ? 'playbook-card' :
                            sectionType === 'assessment' ? 'assessment-card' : 'clause-card';
            var card = document.createElement('div');
            card.className = cardClass;

            var siblings = [h3];
            var next = h3.nextElementSibling;
            while (next && next.tagName !== 'H3' && next.tagName !== 'H2' && next.tagName !== 'HR') {
                siblings.push(next);
                next = next.nextElementSibling;
            }

            // Detect risk level for clause cards
            if (sectionType === 'clause' || sectionType === 'cross') {
                var text = siblings.map(function(el) { return el.innerHTML || el.textContent; }).join(' ');
                var level = '';
                if (text.match(/risk-red|RED/)) level = 'red';
                else if (text.match(/risk-yellow|YELLOW/)) level = 'yellow';
                else if (text.match(/risk-green|GREEN/)) level = 'green';
                if (level) card.classList.add('level-' + level);
                card.setAttribute('data-risk-level', level);
            }

            card.setAttribute('data-clause-title', h3.textContent.trim());
            h3.parentNode.insertBefore(card, h3);
            siblings.forEach(function(el) { card.appendChild(el); });

            // Move split section to lead the card
            if (sectionType === 'clause') {
                var splitHeader = card.querySelector('.clause-split-header');
                var splitBody = card.querySelector('.clause-split');
                if (splitHeader && splitBody) {
                    var afterH3 = card.querySelector('h3').nextSibling;
                    card.insertBefore(splitHeader, afterH3);
                    card.insertBefore(splitBody, splitHeader.nextSibling);
                }
            }
        });
    }

    function getSectionType(el) {
        var prev = el.previousElementSibling;
        while (prev) {
            if (prev.tagName === 'H2') {
                var text = prev.textContent.toLowerCase();
                if (text.indexOf('cross-clause') >= 0) return 'cross';
                if (text.indexOf('playbook') >= 0 || text.indexOf('who drafted') >= 0) return 'playbook';
                if (text.indexOf('fair standard') >= 0 || text.indexOf('benchmark') >= 0) return 'cross';
                if (text.indexOf('how opus') >= 0 || text.indexOf('analyzed this') >= 0) return 'playbook';
                if (text.indexOf('quality check') >= 0 || text.indexOf('calibration') >= 0) return 'assessment';
                if (text.indexOf('assessment') >= 0) return 'assessment';
                return 'clause';
            }
            prev = prev.previousElementSibling;
        }
        return 'clause';
    }

    // ── Promote "How Opus 4.6 Analyzed This" to top callout ──
    function promoteOpusMethodSection(container) {
        var opusH2 = null;
        container.querySelectorAll('h2').forEach(function(h2) {
            var t = h2.textContent.toLowerCase();
            if (t.indexOf('how opus') >= 0 || t.indexOf('analyzed this') >= 0) opusH2 = h2;
        });
        if (!opusH2) return;

        // Gather content between this H2 and the next H2/HR
        var content = [];
        var sibling = opusH2.nextElementSibling;
        while (sibling && sibling.tagName !== 'H2' && !(sibling.tagName === 'HR' && sibling.classList.contains('editorial-divider'))) {
            content.push(sibling);
            sibling = sibling.nextElementSibling;
        }
        if (content.length === 0) return;

        // Build callout
        var callout = document.createElement('div');
        callout.className = 'opus-method-callout';
        callout.innerHTML = '<div class="callout-label">How Opus 4.6 Analyzed This Document</div>';
        content.forEach(function(el) { callout.appendChild(el.cloneNode(true)); });

        // Remove original section (H2 + content + preceding divider)
        var prevDivider = opusH2.previousElementSibling;
        if (prevDivider && prevDivider.classList && prevDivider.classList.contains('editorial-divider')) {
            prevDivider.remove();
        }
        content.forEach(function(el) { el.remove(); });
        opusH2.remove();

        // Insert at top of deep analysis
        container.insertBefore(callout, container.firstChild);
    }

    // ── Clause data extraction ────────────────────────────────
    function extractClausesFromResponse() {
        // DOM-based: reads from card elements (works for both front-only and full data)
        var cards = flipCardContainer.querySelectorAll('.flip-card');
        var clauses = [];
        cards.forEach(function(card) {
            clauses.push({
                title: card.getAttribute('data-clause-title') || '',
                section: card.getAttribute('data-section-ref') || '',
                level: card.getAttribute('data-risk-level') || '',
                score: parseInt(card.getAttribute('data-score') || '0'),
                trick: card.getAttribute('data-trick') || ''
            });
        });
        return clauses;
    }

    // ── Filter chips ──────────────────────────────────────────
    function buildFilterChips() {
        var clauses = extractClausesFromResponse();
        if (clauses.length === 0) return;

        var counts = { red: 0, yellow: 0, green: 0 };
        clauses.forEach(function(c) { if (counts[c.level] !== undefined) counts[c.level]++; });

        var html = '';
        if (counts.red > 0)    html += '<button class="filter-chip chip-red" data-filter="red">' + counts.red + ' Red</button>';
        if (counts.yellow > 0) html += '<button class="filter-chip chip-yellow" data-filter="yellow">' + counts.yellow + ' Yellow</button>';
        if (counts.green > 0)  html += '<button class="filter-chip chip-green" data-filter="green">' + counts.green + ' Green</button>';

        // Trick type chips (only for tricks appearing 2+ times)
        var trickCounts = {};
        clauses.forEach(function(c) {
            if (c.trick) trickCounts[c.trick] = (trickCounts[c.trick] || 0) + 1;
        });

        var trickHtml = '';
        var sortedTricks = Object.keys(trickCounts)
            .filter(function(t) { return trickCounts[t] >= 2; })
            .sort(function(a, b) { return trickCounts[b] - trickCounts[a]; });

        sortedTricks.forEach(function(trick) {
            var icon = TRICK_ICONS[trick] ? '<span class="verdict-trick-icon">' + TRICK_ICONS[trick] + '</span> ' : '';
            trickHtml += '<button class="filter-chip chip-trick" data-filter-trick="' +
                escapeHtml(trick) + '">' + icon + escapeHtml(trick) +
                ' <span class="chip-count">' + trickCounts[trick] + '</span></button>';
        });

        if (trickHtml) {
            html += '<div class="trick-chip-row">' + trickHtml + '</div>';
        }

        if (html) {
            filterChips.innerHTML = html;
            filterChips.classList.remove('hidden');

            // Risk level chip handlers
            filterChips.querySelectorAll('.filter-chip[data-filter]').forEach(function(chip) {
                chip.addEventListener('click', function() {
                    var level = chip.getAttribute('data-filter');
                    if (activeFilters.has(level)) {
                        activeFilters.delete(level);
                        chip.classList.remove('active');
                    } else {
                        activeFilters.add(level);
                        chip.classList.add('active');
                    }
                    applyFilters();
                });
            });

            // Trick type chip handlers
            filterChips.querySelectorAll('.chip-trick').forEach(function(chip) {
                chip.addEventListener('click', function() {
                    var trick = chip.getAttribute('data-filter-trick');
                    if (activeTrickFilters.has(trick)) {
                        activeTrickFilters.delete(trick);
                        chip.classList.remove('active');
                    } else {
                        activeTrickFilters.add(trick);
                        chip.classList.add('active');
                    }
                    applyFilters();
                });
            });
        }
    }

    function activateTrickFilter(trickName) {
        // Activate a trick filter from playbook click
        var chip = filterChips.querySelector('.chip-trick[data-filter-trick="' + CSS.escape(trickName) + '"]');
        if (chip && !activeTrickFilters.has(trickName)) {
            activeTrickFilters.add(trickName);
            chip.classList.add('active');
        }
        applyFilters();
        // Scroll to cards
        var viewport = $('cardViewport');
        if (viewport && !viewport.classList.contains('hidden')) {
            viewport.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    }

    function applyFilters() {
        var container = flipCardsBuilt && !isCompareMode ? flipCardContainer : resultsContent;
        var selector = '.clause-card, .flip-card';
        var noFilters = activeFilters.size === 0 && activeTrickFilters.size === 0;

        if (noFilters) {
            container.querySelectorAll(selector).forEach(function(card) {
                card.style.display = '';
            });
            if (flipCardsBuilt && !isCompareMode) showCardAtIndex(0);
            return;
        }

        var visibleCards = [];
        container.querySelectorAll(selector).forEach(function(card) {
            var level = card.getAttribute('data-risk-level');
            var trick = card.getAttribute('data-trick') || '';

            var riskMatch = activeFilters.size === 0 || (level && activeFilters.has(level));
            var trickMatch = activeTrickFilters.size === 0 || activeTrickFilters.has(trick);

            if (riskMatch && trickMatch) {
                card.style.display = '';
                visibleCards.push(card);
            } else {
                card.style.display = 'none';
            }
        });

        // Show first visible card in card viewport mode
        if (flipCardsBuilt && !isCompareMode && visibleCards.length > 0) {
            var idx = parseInt(visibleCards[0].getAttribute('data-clause-index')) || 0;
            showCardAtIndex(idx);
        }
    }

    // ── Summary card builder ──────────────────────────────────
    function buildSummaryCard() {
        var text = assembleDeepText() || responseContent;

        // ── Parse verdict tier from Opus output ──
        var VERDICT_TIERS = {
            'SIGN WITH CONFIDENCE':      { tier: 'sign',      label: 'Sign with Confidence' },
            'READ THE FLAGGED CLAUSES':   { tier: 'read',      label: 'Read the Flagged Clauses' },
            'NEGOTIATE BEFORE SIGNING':   { tier: 'negotiate', label: 'Negotiate Before Signing' },
            'SEEK LEGAL REVIEW':          { tier: 'legal',     label: 'Seek Legal Review' },
            'DO NOT SIGN':                { tier: 'dontsign',  label: 'Do Not Sign' }
        };

        var verdictMatch = text.match(/Verdict:\s*([A-Z][A-Z\s]+)/i);
        var verdictRaw = verdictMatch ? verdictMatch[1].trim().toUpperCase() : '';
        var verdict = null;

        // Try exact match first, then prefix match
        Object.keys(VERDICT_TIERS).forEach(function(key) {
            if (!verdict && verdictRaw.indexOf(key) === 0) verdict = VERDICT_TIERS[key];
        });

        // ── Fallback: derive from clause distribution ──
        var clauses = extractClausesFromResponse();
        var counts = { red: 0, yellow: 0, green: 0 };
        clauses.forEach(function(c) { if (counts[c.level] !== undefined) counts[c.level]++; });
        var total = counts.red + counts.yellow + counts.green;

        if (!verdict && total > 0) {
            var redPct = counts.red / total;
            var yellowPct = counts.yellow / total;
            if (redPct >= 0.5) verdict = VERDICT_TIERS['SEEK LEGAL REVIEW'];
            else if (redPct >= 0.3 || yellowPct >= 0.5) verdict = VERDICT_TIERS['NEGOTIATE BEFORE SIGNING'];
            else if (counts.red > 0) verdict = VERDICT_TIERS['READ THE FLAGGED CLAUSES'];
            else verdict = VERDICT_TIERS['SIGN WITH CONFIDENCE'];
        }

        if (!verdict) return;

        // ── Parse top concerns ──
        var concerns = [];
        var assessmentStart = text.indexOf('Overall Assessment');
        var assessmentText = assessmentStart >= 0 ? text.substring(assessmentStart) : text;
        var concernLines = assessmentText.match(/\d+\.\s*\*\*.+?\*\*\s*(?:—|[-–]).+/g);
        if (concernLines) {
            concernLines.slice(0, 3).forEach(function(line) {
                var m = line.match(/\d+\.\s*\*\*(.+?)\*\*\s*(?:—|[-–])\s*(.+)/);
                if (m) concerns.push({ title: m[1], desc: m[2].trim() });
            });
        }

        // ── Render verdict card ──
        var h = '<div class="summary-card"><div class="summary-top">';
        h += '<div class="verdict-tier" data-tier="' + verdict.tier + '">' + escapeHtml(verdict.label) + '</div>';

        // Clause dot strip — sorted: red first, then yellow, then green
        if (total > 0) {
            var sortedClauses = clauses.slice().sort(function(a, b) {
                var order = { red: 0, yellow: 1, green: 2 };
                return (order[a.level] || 2) - (order[b.level] || 2);
            });
            h += '<div class="clause-strip">';
            sortedClauses.forEach(function(c, i) {
                var dotClass = 'dot-' + (c.level || 'green');
                var title = c.title || ('Clause ' + (i + 1));
                h += '<button class="clause-dot ' + dotClass + '" data-clause-index="' + i + '" title="' + escapeHtml(title) + '"></button>';
            });
            h += '</div>';
            // Counts label
            var parts = [];
            if (counts.red > 0)    parts.push(counts.red + ' concern' + (counts.red > 1 ? 's' : ''));
            if (counts.yellow > 0) parts.push(counts.yellow + ' watch');
            if (counts.green > 0)  parts.push(counts.green + ' fair');
            h += '<div class="clause-strip-counts">' + parts.join(' · ') + '</div>';
        }

        // Top concerns
        if (concerns.length) {
            h += '<div class="summary-meta"><ul class="summary-concerns">';
            concerns.forEach(function(c, i) {
                h += '<li><strong>' + (i + 1) + '. ' + escapeHtml(c.title) + '</strong> — ' + escapeHtml(c.desc) + '</li>';
            });
            h += '</ul></div>';
        }
        h += '</div></div>';

        summaryContainer.innerHTML = h;

        // Clause dot click → navigate to that card
        summaryContainer.querySelectorAll('.clause-dot').forEach(function(dot) {
            dot.addEventListener('click', function() {
                var idx = parseInt(dot.getAttribute('data-clause-index'));
                // Dots are sorted red→yellow→green, map back to original card order
                var sorted = clauses.slice().sort(function(a, b) {
                    var order = { red: 0, yellow: 1, green: 2 };
                    return (order[a.level] || 2) - (order[b.level] || 2);
                });
                var targetTitle = sorted[idx] ? sorted[idx].title : '';
                // Find the original card index by title match
                var allCards = flipCardContainer.querySelectorAll('.flip-card');
                for (var ci = 0; ci < allCards.length; ci++) {
                    if (allCards[ci].getAttribute('data-clause-title') === targetTitle) {
                        showCardAtIndex(ci);
                        return;
                    }
                }
                // Fallback: navigate to the nth card
                if (idx < allCards.length) showCardAtIndex(idx);
            });
        });

        // "Message the Company" button — between summary and playbook
        var drafterMatch = responseContent.match(/\*\*Drafted By\*\*[:\s]*([^\n*]+)/i);
        var companyName = drafterMatch ? drafterMatch[1].trim() : null;
        if (companyName) {
            var msgBtn = '<div class="message-company-section">';
            msgBtn += '<button class="message-company-btn" id="messageCompanyBtn">';
            msgBtn += '<span class="message-company-icon">\u2709</span> ';
            msgBtn += 'Draft a message to ' + escapeHtml(companyName);
            msgBtn += '</button>';
            msgBtn += '<div class="message-company-output hidden" id="messageCompanyOutput"></div>';
            msgBtn += '</div>';
            summaryContainer.insertAdjacentHTML('beforeend', msgBtn);

            $('messageCompanyBtn').addEventListener('click', function() {
                var btn = this;
                if (btn.classList.contains('generating')) return;
                btn.classList.add('generating');
                btn.innerHTML = '<span class="pulsing-dots"><span></span><span></span><span></span></span> Drafting your message...';

                var msgClauses = extractClausesFromResponse();
                var topConcerns = msgClauses
                    .filter(function(c) { return c.level === 'red' || c.level === 'yellow'; })
                    .sort(function(a, b) { var o = { red: 0, yellow: 1 }; return (o[a.level] || 2) - (o[b.level] || 2); })
                    .slice(0, 5);

                var concernsList = topConcerns.map(function(c) {
                    return '- ' + c.title + ' (Trick: ' + (c.trick || 'unknown') + '): ' + (c.bottomLine || c.reveal || '');
                }).join('\n');

                var roleMatch = responseContent.match(/\*\*Your Role\*\*[:\s]*([^\n*]+)/i);
                var typeMatch = responseContent.match(/\*\*Document Type\*\*[:\s]*([^\n*]+)/i);
                var userRole = roleMatch ? roleMatch[1].trim() : 'the other party';
                var docType = typeMatch ? typeMatch[1].trim() : 'document';

                var prompt = 'Write a professional, firm but polite message from ' + userRole +
                    ' to ' + companyName + ' about their ' + docType + '.\n\n' +
                    'Verdict: ' + verdict.label + '. Clause breakdown: ' + counts.red + ' concerns, ' + counts.yellow + ' watch, ' + counts.green + ' fair.\n\n' +
                    'Top concerns found by analysis:\n' + concernsList + '\n\n' +
                    'The message should:\n' +
                    '1. State that the sender has had the ' + docType + ' independently analyzed\n' +
                    '2. Name the specific clauses of concern (use the real section titles/numbers)\n' +
                    '3. Ask for written clarification or revision on each point\n' +
                    '4. Be professional — not threatening, not apologetic\n' +
                    '5. End with a clear request for a response within a reasonable timeframe\n' +
                    '6. Be 200-300 words, ready to send as-is\n\n' +
                    'Write ONLY the message body. No subject line, no explanation.';

                var outputEl = $('messageCompanyOutput');
                outputEl.classList.remove('hidden');
                outputEl.innerHTML = '<span class="pulsing-dots"><span></span><span></span><span></span></span>';

                // Use the follow-up /ask endpoint with the complaint prompt
                var url = BASE_URL + '/ask/' + currentDocId;
                fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question: prompt })
                }).then(function(resp) {
                    if (!resp.ok) throw new Error('Request failed');
                    var reader = resp.body.getReader();
                    var decoder = new TextDecoder();
                    var fullText = '';
                    var buffer = '';

                    function readChunk() {
                        return reader.read().then(function(result) {
                            if (result.done) {
                                btn.classList.remove('generating');
                                btn.innerHTML = '<span class="message-company-icon">\u2709</span> Regenerate message';
                                // Add copy + mailto buttons
                                var actions = '<div class="message-actions">';
                                actions += '<button class="message-action-btn" id="copyMessageBtn">Copy to clipboard</button>';
                                actions += '<button class="message-action-btn" id="mailtoMessageBtn">Open in email</button>';
                                actions += '</div>';
                                outputEl.insertAdjacentHTML('beforeend', actions);
                                $('copyMessageBtn').addEventListener('click', function() {
                                    navigator.clipboard.writeText(fullText).then(function() {
                                        $('copyMessageBtn').textContent = 'Copied!';
                                        setTimeout(function() { $('copyMessageBtn').textContent = 'Copy to clipboard'; }, 2000);
                                    });
                                });
                                $('mailtoMessageBtn').addEventListener('click', function() {
                                    var subj = 'Regarding your ' + docType + ' — Request for Clarification';
                                    window.location.href = 'mailto:?subject=' + encodeURIComponent(subj) + '&body=' + encodeURIComponent(fullText);
                                });
                                return;
                            }
                            buffer += decoder.decode(result.value, { stream: true });
                            var lines = buffer.split('\n');
                            buffer = lines.pop();
                            lines.forEach(function(line) {
                                if (line.startsWith('data: ')) {
                                    try {
                                        var evt = JSON.parse(line.substring(6));
                                        if (evt.type === 'text' || evt.type === 'answer_text') {
                                            fullText += evt.content;
                                            outputEl.innerHTML = safeMd2Html(fullText);
                                        }
                                    } catch(e) {}
                                }
                            });
                            return readChunk();
                        });
                    }
                    return readChunk();
                }).catch(function(err) {
                    btn.classList.remove('generating');
                    btn.innerHTML = '<span class="message-company-icon">\u2709</span> Draft a message to ' + escapeHtml(companyName);
                    outputEl.innerHTML = '<p style="color:var(--red)">Failed to generate message. Please try again.</p>';
                });
            });
        }
    }

    // ── Drafter's Playbook — trick frequency visualization ───
    function buildPlaybookCard() {
        var clauses = extractClausesFromResponse();
        var trickCounts = {};
        var totalClauses = 0;
        var classifiedCount = 0;
        var greenCount = 0;
        clauses.forEach(function(c) {
            if (c.level === 'green') { greenCount++; return; }
            totalClauses++;
            if (c.trick && c.trick.toLowerCase() !== 'none') {
                trickCounts[c.trick] = (trickCounts[c.trick] || 0) + 1;
                classifiedCount++;
            }
        });

        var sorted = Object.keys(trickCounts).sort(function(a, b) {
            return trickCounts[b] - trickCounts[a];
        });

        if (sorted.length === 0) return;

        var maxCount = trickCounts[sorted[0]];
        var uniqueCount = sorted.length;

        var h = '<div class="playbook-card">';
        h += '<div class="playbook-header">';
        h += '<span class="playbook-title">The Drafter\'s Playbook</span>';
        h += '<span class="playbook-subtitle">' + classifiedCount + ' of ' + totalClauses + ' clauses categorized \u00B7 ' + uniqueCount + ' trick types</span>';
        h += '</div>';

        h += '<div class="playbook-bars">';
        sorted.forEach(function(trick) {
            var count = trickCounts[trick];
            var pct = Math.round((count / maxCount) * 100);
            var icon = TRICK_ICONS[trick] ? '<span class="verdict-trick-icon">' + TRICK_ICONS[trick] + '</span> ' : '';
            var desc = TRICK_DESCRIPTIONS[trick] || '';
            h += '<div class="playbook-row" data-trick="' + escapeHtml(trick) + '" title="' + escapeHtml(desc) + '">';
            h += '<span class="playbook-trick-name">' + icon + escapeHtml(trick) + '</span>';
            h += '<div class="playbook-bar-track"><div class="playbook-bar-fill" style="width:' + pct + '%"></div></div>';
            h += '<span class="playbook-count">' + count + '\u00d7</span>';
            h += '</div>';
        });
        // Green clauses row at the bottom — shows what's fair
        if (greenCount > 0) {
            h += '<div class="playbook-row playbook-row-green" title="Clauses that are straightforward and fair as written">';
            h += '<span class="playbook-trick-name">\u2705 Fair Clauses</span>';
            var greenPct = Math.round((greenCount / maxCount) * 100);
            h += '<div class="playbook-bar-track"><div class="playbook-bar-fill" style="width:' + Math.min(greenPct, 100) + '%;background:var(--green)"></div></div>';
            h += '<span class="playbook-count">' + greenCount + '\u00d7</span>';
            h += '</div>';
        }

        h += '</div></div>';

        // Remove existing playbook before inserting (prevents duplicates on re-render)
        summaryContainer.querySelectorAll('.playbook-card').forEach(function(el) { el.remove(); });
        summaryContainer.insertAdjacentHTML('beforeend', h);

        // Click handler: playbook row → activate trick filter
        summaryContainer.querySelectorAll('.playbook-row').forEach(function(row) {
            row.addEventListener('click', function() {
                var trick = row.getAttribute('data-trick');
                if (trick) activateTrickFilter(trick);
            });
        });
    }

    // ── Verdict column expand button ─────────────────────────
    verdictExpandBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        // Only open full verdict when all 4 sections are done
        if (getCompletedSections().length < 4 && !deepTextComplete && !isDoneRendering) return;
        exitFocusedMode();
        revealDeepAnalysis();
    });

    // ── Back to cards button (from verdict view) ──────────────
    $('backToCardsBtn').addEventListener('click', function() {
        if (_verdictPollTimer) { clearTimeout(_verdictPollTimer); _verdictPollTimer = null; }
        $('deepAnalysisSection').classList.add('hidden');
        $('cardViewport').classList.remove('hidden');
        exitFocusedMode();
        // Re-show verdict column if there's any Opus content
        var hasAnyOpus = Object.keys(opusSections).some(function(k) { return opusSections[k].text.length > 0; });
        if (hasAnyOpus || isDoneRendering || deepTextComplete) verdictCol.classList.add('visible');
        setTimeout(function() {
            $('cardViewport').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 50);
    });

    // ── Back button ───────────────────────────────────────────
    backBtn.addEventListener('click', function() {
        if (!isDoneRendering && eventSource) {
            if (!confirm('Analysis is still running. Going back will discard all results.')) return;
        }
        if (eventSource) { eventSource.close(); eventSource = null; }
        if (elapsedInterval) { clearInterval(elapsedInterval); elapsedInterval = null; }
        if (_verdictPollTimer) { clearTimeout(_verdictPollTimer); _verdictPollTimer = null; }
        stopStatusRotation();
        stopEditorialStatusRotation();
        resetVerdictCol();

        analysisScreen.classList.add('hidden');
        uploadScreen.classList.remove('hidden');
        // Reset layout expand state
        var layoutEl = document.querySelector('.analysis-layout');
        layoutEl.classList.remove('sidebar-visible');

        // Reset upload UI
        analyzeBtn.textContent = isCompareMode ? 'Compare documents' : 'Show me the dark side of small print';
        updateAnalyzeBtn();
    });

    // ── Header brand = back ───────────────────────────────────
    $('headerBrand').addEventListener('click', function() { backBtn.click(); });

    // ── Copy all ──────────────────────────────────────────────
    $('copyAllBtn').addEventListener('click', function() {
        var text = flipCardsBuilt && !isCompareMode
            ? (flipCardContainer.innerText + '\n\n' + deepAnalysisEl.innerText)
            : resultsContent.innerText;
        navigator.clipboard.writeText(text).then(function() {
            var btn = $('copyAllBtn');
            btn.textContent = 'Copied!';
            setTimeout(function() { btn.textContent = 'Copy all'; }, 2000);
        });
    });

    // ── Export HTML ───────────────────────────────────────────
    $('exportBtn').addEventListener('click', function() {
        var docName = 'FlipSide Analysis';
        var meta = metadataLine.textContent;
        if (meta) docName = meta.split('Type:')[1] ? meta.split('Type:')[1].split('Drafted')[0].trim() : docName;

        // Build clean export from structured data
        var clauses = extractClausesFromResponse();
        var cards = flipCardContainer.querySelectorAll('.flip-card');
        var body = '';

        // Metadata
        var metaPills = metadataLine.querySelectorAll('.meta-pill');
        if (metaPills.length) {
            body += '<div class="meta">';
            metaPills.forEach(function(p) {
                var label = p.querySelector('.meta-pill-label');
                var value = p.querySelector('.meta-pill-value');
                if (label && value) body += '<span class="meta-item"><strong>' + label.textContent + '</strong> ' + escapeHtml(value.textContent) + '</span>';
            });
            body += '</div>';
        }

        // Verdict tier from summary
        var verdictMatch = responseContent.match(/Verdict:\s*([A-Z][A-Z\s]+)/i);
        if (verdictMatch) {
            var tier = verdictMatch[1].trim();
            var tColor = /DO NOT SIGN/i.test(tier) ? '#7a1a1a' : /SEEK LEGAL/i.test(tier) ? '#a83d20' : /NEGOTIATE/i.test(tier) ? '#9a6c00' : /READ THE/i.test(tier) ? '#8a7200' : '#1e6b38';
            body += '<div class="score-summary"><span class="score-number" style="color:' + tColor + '">' + escapeHtml(tier) + '</span></div>';
        }

        // Clauses from flip cards
        if (cards.length) {
            body += '<h2>Clause Analysis</h2>';
            cards.forEach(function(card, i) {
                var title = card.getAttribute('data-clause-title') || 'Clause ' + (i + 1);
                var risk = card.getAttribute('data-risk-level') || '';
                var score = card.getAttribute('data-score') || '';
                var trick = card.getAttribute('data-trick') || '';
                var section = card.getAttribute('data-section-ref') || '';

                var riskClass = 'risk-' + risk;
                body += '<div class="clause"><div class="clause-header">';
                body += '<span class="risk-badge ' + riskClass + '">' + risk.toUpperCase() + '</span>';
                if (score) body += ' <span class="clause-score">' + score + '/100</span>';
                if (trick) body += ' <span class="clause-trick">' + escapeHtml(trick) + '</span>';
                body += '</div>';
                body += '<h3>' + escapeHtml(title) + '</h3>';
                if (section) body += '<div class="clause-ref">' + escapeHtml(section) + '</div>';

                // Front: reader voice
                var readerEl = card.querySelector('.reader-voice-text');
                if (readerEl && readerEl.textContent.trim()) {
                    body += '<blockquote class="reader"><strong>What a trusting reader sees:</strong> ' + escapeHtml(readerEl.textContent.trim()) + '</blockquote>';
                }

                // Back: reveal, figure, example, bottom line
                var backBody = card.querySelector('.back-body');
                if (backBody) {
                    var figure = card.querySelector('.back-figure');
                    var example = card.querySelector('.back-example');
                    var bottomLine = card.querySelector('.back-bottom-line');
                    if (figure) body += '<div class="figure">' + escapeHtml(figure.textContent.trim()) + '</div>';
                    if (example) body += '<p class="example">' + escapeHtml(example.textContent.trim()) + '</p>';
                    if (bottomLine) body += '<p class="bottom-line"><strong>Bottom line:</strong> ' + escapeHtml(bottomLine.textContent.trim()) + '</p>';
                }
                body += '</div>';
            });
        }

        // Deep analysis (Opus verdict)
        var deepText = assembleDeepText();
        if (deepText.trim()) {
            body += '<hr><h2>Expert Verdict</h2>';
            body += '<div class="verdict">' + safeMd2Html(deepText) + '</div>';
        }

        // Counter-draft
        if (counterDraftContent.innerHTML && counterDraftContent.textContent.trim()) {
            body += '<hr><h2>Counter-Draft Suggestions</h2>';
            body += '<div class="verdict">' + counterDraftContent.innerHTML + '</div>';
        }

        var exportHtml = '<!DOCTYPE html><html><head><meta charset="UTF-8">' +
            '<title>' + escapeHtml(docName) + ' \u2014 FlipSide Analysis</title>' +
            '<style>' +
            'body{font-family:"DM Sans",system-ui,sans-serif;max-width:800px;margin:2rem auto;padding:0 1.5rem;color:#1a1a18;line-height:1.65}' +
            'h1{font-size:1.4rem;border-bottom:2px solid #c44b28;padding-bottom:0.5rem;margin-bottom:0.5rem}' +
            'h2{margin-top:2.5rem;font-size:1.15rem;color:#3d3b36;border-bottom:1px solid #e2ddd4;padding-bottom:0.3rem}' +
            'h3{margin-top:0.5rem;margin-bottom:0.3rem;font-size:1rem}' +
            '.meta{margin-bottom:1.5rem;font-size:0.85rem;color:#6b6860}' +
            '.meta-item{display:inline-block;margin-right:1.5rem}' +
            '.score-summary{font-size:1.1rem;margin:1rem 0 1.5rem;padding:0.8rem 1rem;background:#faf8f4;border-radius:6px;border-left:3px solid #c44b28}' +
            '.score-number{font-size:1.4rem;font-weight:700}.score-desc{color:#6b6860}' +
            '.clause{margin:1.5rem 0;padding:1rem;background:#faf8f4;border-radius:6px;border:1px solid #e2ddd4}' +
            '.clause-header{margin-bottom:0.3rem;font-size:0.82rem}' +
            '.clause-score{font-weight:700}.clause-trick{color:#6b6860;font-style:italic}' +
            '.clause-ref{font-size:0.78rem;color:#9c9789;margin-bottom:0.5rem}' +
            '.risk-badge{display:inline-block;padding:2px 8px;border-radius:3px;font-size:0.72rem;font-weight:700;text-transform:uppercase}' +
            '.risk-red{background:#fce4ec;color:#a83d20}.risk-yellow{background:#fff8e1;color:#8a6508}.risk-green{background:#e8f5e9;color:#1e6b38}' +
            'blockquote{border-left:3px solid #c44b28;padding:0.5rem 1rem;margin:0.8rem 0;background:#fff;font-style:italic;border-radius:0 4px 4px 0}' +
            '.figure{font-size:1.1rem;font-weight:700;color:#a83d20;margin:0.5rem 0}' +
            '.example{color:#3d3b36;margin:0.3rem 0}.bottom-line{margin:0.5rem 0}' +
            '.verdict{margin-top:0.5rem}' +
            '.verdict h3{margin-top:1.2rem}.verdict blockquote{border-left-color:#9c9789}' +
            'hr{border:none;border-top:1px solid #e2ddd4;margin:2rem 0}' +
            '.footer{margin-top:3rem;padding-top:1rem;border-top:1px solid #e2ddd4;font-size:0.78rem;color:#9c9789}' +
            '</style></head><body>' +
            '<h1>FlipSide Analysis</h1>' +
            '<p style="font-size:1.05rem;color:#3d3b36;margin-top:-0.3rem">' + escapeHtml(docName) + '</p>' +
            body +
            '<div class="footer">Generated by FlipSide \u2014 The dark side of small print.<br>Powered by Claude Opus 4.6 extended thinking. \u2022 flipside.digitaldigging.org</div>' +
            '</body></html>';
        var blob = new Blob([exportHtml], { type: 'text/html' });
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url;
        a.download = docName.replace(/[^a-z0-9]/gi, '_') + '_FlipSide.html';
        a.click();
        URL.revokeObjectURL(url);
    });

    // ── Email to Lawyer ─────────────────────────────────────────
    $('emailLawyerBtn').addEventListener('click', function() {
        var docName = 'FlipSide Analysis';
        var meta = metadataLine.textContent;
        if (meta) docName = meta.split('Type:')[1] ? meta.split('Type:')[1].split('Drafted')[0].trim() : docName;

        // Extract verdict tier
        var verdictMatch = responseContent.match(/Verdict:\s*([A-Z][A-Z\s]+)/i);
        var verdictTier = verdictMatch ? verdictMatch[1].trim() : 'Analysis Complete';

        // Extract top 3 concerns from summary card data
        var concerns = [];
        var assessmentStart = responseContent.indexOf('Overall Assessment');
        var assessmentText = assessmentStart >= 0 ? responseContent.substring(assessmentStart) : responseContent;
        var concernLines = assessmentText.match(/\d+\.\s*\*\*.+?\*\*\s*(?:—|[-–]).+/g);
        if (concernLines) {
            concernLines.slice(0, 3).forEach(function(line) {
                var m = line.match(/\d+\.\s*\*\*(.+?)\*\*\s*(?:—|[-–])\s*(.+)/);
                if (m) concerns.push(m[1] + ' — ' + m[2].trim());
            });
        }

        var subject = 'FlipSide Analysis — ' + docName + ' (' + verdictTier + ')';
        var body = 'Hi,\n\n' +
            'I ran an AI analysis on a document I received and wanted to share the key findings with you.\n\n' +
            'Document: ' + docName + '\n' +
            'Verdict: ' + verdictTier + '\n\n';
        if (concerns.length) {
            body += 'Top concerns:\n';
            concerns.forEach(function(c, i) { body += (i + 1) + '. ' + c + '\n'; });
            body += '\n';
        }
        body += 'I have the full analysis saved as an HTML report (use "Save Report" in FlipSide to download).\n\n' +
            'Could you review this and let me know which clauses I should push back on?\n\n' +
            'Generated by FlipSide — The dark side of small print.\n' +
            'Powered by Claude Opus 4.6 extended thinking.';

        window.location.href = 'mailto:?subject=' + encodeURIComponent(subject) + '&body=' + encodeURIComponent(body);
    });

    // ── Download report in document language ────────────────────
    $('exportLangBtn').addEventListener('click', function() {
        var btn = this;
        if (btn.classList.contains('generating')) return;
        btn.classList.add('generating');
        var origText = btn.textContent;
        btn.textContent = 'Translating...';

        // Build the full English report text
        var reportParts = [];
        // Summary from cards
        var clauses = extractClausesFromResponse();
        clauses.forEach(function(c) {
            reportParts.push('### ' + c.title + (c.section ? ' (' + c.section + ')' : ''));
            if (c.reveal) reportParts.push(c.reveal);
            if (c.bottomLine) reportParts.push('**Bottom line:** ' + c.bottomLine);
            if (c.shouldRead) reportParts.push('**What you should read:** ' + c.shouldRead);
            if (c.figure) reportParts.push('**Figure:** ' + c.figure);
            reportParts.push('');
        });
        // Opus verdict sections
        var deepText = assembleDeepText();
        if (deepText) reportParts.push(deepText);

        var fullReport = reportParts.join('\n');

        var prompt = 'Translate this ENTIRE analysis report into ' + detectedDocLanguage + '. ' +
            'Keep all formatting (markdown headers, bold, bullet points). ' +
            'Keep quoted document text in the original ' + detectedDocLanguage + ' — do NOT back-translate quotes. ' +
            'Translate all analysis, explanations, labels, and headings into ' + detectedDocLanguage + '.\n\n' +
            '---\n\n' + fullReport;

        var url = BASE_URL + '/ask/' + currentDocId;
        var translatedText = '';

        fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ question: prompt })
        }).then(function(resp) {
            if (!resp.ok) throw new Error('Translation request failed');
            var reader = resp.body.getReader();
            var decoder = new TextDecoder();
            var buffer = '';

            function readChunk() {
                return reader.read().then(function(result) {
                    if (result.done) {
                        // Download as HTML
                        var docName = 'FlipSide Analysis';
                        var meta = metadataLine.textContent;
                        if (meta) docName = meta.split('Type:')[1] ? meta.split('Type:')[1].split('Drafted')[0].trim() : docName;

                        var exportHtml = '<!DOCTYPE html><html><head><meta charset="UTF-8">' +
                            '<title>' + escapeHtml(docName) + ' — FlipSide (' + detectedDocLanguage + ')</title>' +
                            '<style>body{font-family:system-ui,sans-serif;max-width:800px;margin:2rem auto;padding:0 1rem;color:#1a1a18;line-height:1.6}' +
                            'h1{font-size:1.5rem;border-bottom:2px solid #c44b28;padding-bottom:0.5rem}' +
                            'h2{margin-top:2rem;color:#3d3b36}h3{margin-top:1.5rem}' +
                            'blockquote{border-left:3px solid #c44b28;padding:0.5rem 1rem;margin:0.5rem 0;background:#faf8f4;font-style:italic}' +
                            'hr{border:none;border-top:1px solid #e2ddd4;margin:1.5rem 0}' +
                            '.footer{margin-top:3rem;padding-top:1rem;border-top:1px solid #e2ddd4;font-size:0.8rem;color:#9c9789}' +
                            '</style></head><body>' +
                            '<h1>' + escapeHtml(docName) + '</h1>' +
                            safeMd2Html(translatedText) +
                            '<div class="footer">Generated by FlipSide — The dark side of small print.<br>Powered by Claude Opus 4.6.</div>' +
                            '</body></html>';
                        var blob = new Blob([exportHtml], { type: 'text/html' });
                        var blobUrl = URL.createObjectURL(blob);
                        var a = document.createElement('a');
                        a.href = blobUrl;
                        a.download = docName.replace(/[^a-z0-9]/gi, '_') + '_' + detectedDocLanguage + '_FlipSide.html';
                        a.click();
                        URL.revokeObjectURL(blobUrl);
                        btn.classList.remove('generating');
                        btn.textContent = origText;
                        return;
                    }
                    buffer += decoder.decode(result.value, { stream: true });
                    var lines = buffer.split('\n');
                    buffer = lines.pop();
                    lines.forEach(function(line) {
                        if (line.startsWith('data: ')) {
                            try {
                                var evt = JSON.parse(line.substring(6));
                                if (evt.type === 'text' || evt.type === 'answer_text') {
                                    translatedText += evt.content;
                                }
                            } catch(e) {}
                        }
                    });
                    return readChunk();
                });
            }
            return readChunk();
        }).catch(function(err) {
            btn.classList.remove('generating');
            btn.textContent = origText;
            console.error('Translation failed:', err);
        });
    });

    // ── Dark mode ─────────────────────────────────────────────
    $('darkModeBtn').addEventListener('click', function() {
        document.body.classList.toggle('dark-mode');
        var isDark = document.body.classList.contains('dark-mode');
        this.innerHTML = isDark ? '&#9788;' : '&#9790;';
        this.title = isDark ? 'Switch to light mode' : 'Switch to dark mode';
        try { localStorage.setItem('flipside-dark', isDark ? '1' : '0'); } catch(e) {}
    });

    // Restore dark mode preference
    try {
        var savedDark = localStorage.getItem('flipside-dark');
        if (savedDark === '1') {
            document.body.classList.add('dark-mode');
            $('darkModeBtn').innerHTML = '&#9788;';
        } else if (savedDark === null && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            // Auto-detect system preference on first visit
            document.body.classList.add('dark-mode');
            $('darkModeBtn').innerHTML = '&#9788;';
        }
    } catch(e) {}

    // ── Follow-up questions ──────────────────────────────────
    function sendFollowup() {
        var question = followupInput.value.trim();
        if (!question || !currentDocId) return;

        // Immediate visual feedback
        followupInput.value = '';
        followupInput.style.height = 'auto';
        followupSend.disabled = true;
        followupSend.textContent = 'Thinking...';
        followupInput.disabled = true;
        followupInput.placeholder = 'Opus 4.6 is thinking...';

        var answerDiv = document.createElement('div');
        answerDiv.className = 'followup-answer';
        answerDiv.innerHTML = '<div class="followup-q">' + escapeHtml(question) + '</div>' +
            '<div class="followup-a" style="color:var(--text-muted)">' +
            '<span class="pulsing-dots" style="display:inline-flex;vertical-align:middle;margin-right:0.4rem"><span></span><span></span><span></span></span>' +
            'Opus 4.6 is reasoning about your question...</div>';
        followupAnswers.appendChild(answerDiv);
        var answerContent = answerDiv.querySelector('.followup-a');

        setTimeout(function() { answerDiv.scrollIntoView({ behavior: 'smooth', block: 'start' }); }, 50);

        var responseText = '';
        fetch(BASE_URL + '/ask/' + currentDocId, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ question: question }),
        }).then(function(response) {
            if (!response.ok) return response.json().then(function(err) { throw new Error(err.error || 'Request failed'); });
            var reader = response.body.getReader();
            var decoder = new TextDecoder();
            var buffer = '';
            var thinkingDone = false;

            function processChunk(result) {
                if (result.done) { resetFollowupUI(); return; }
                buffer += decoder.decode(result.value, { stream: true });
                var lines = buffer.split('\n');
                buffer = lines.pop();
                for (var i = 0; i < lines.length; i++) {
                    var line = lines[i].trim();
                    if (!line.startsWith('data: ')) continue;
                    var msg;
                    try { msg = JSON.parse(line.substring(6)); } catch(e) { continue; }
                    if (msg.type === 'text') {
                        if (!thinkingDone) { thinkingDone = true; answerContent.innerHTML = ''; }
                        responseText += msg.content;
                        answerContent.innerHTML = safeMd2Html(responseText);
                    } else if (msg.type === 'done') {
                        if (responseText) answerContent.innerHTML = safeMd2Html(responseText);
                        resetFollowupUI();
                        return;
                    } else if (msg.type === 'error') {
                        answerContent.innerHTML = '<span style="color:var(--red)">' + escapeHtml(msg.content) + '</span>';
                        resetFollowupUI();
                        return;
                    }
                }
                return reader.read().then(processChunk);
            }
            return reader.read().then(processChunk);
        }).catch(function(err) {
            answerContent.innerHTML = '<span style="color:var(--red)">' + escapeHtml(err.message) + '</span>';
            resetFollowupUI();
        });
    }

    function resetFollowupUI() {
        followupSend.disabled = false;
        followupSend.textContent = 'Ask';
        followupInput.disabled = false;
        followupInput.placeholder = 'Ask another question...';
        followupInput.focus();
    }

    followupSend.addEventListener('click', sendFollowup);
    followupInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendFollowup(); }
    });
    followupInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    });

    // ── Worst-Case Timeline ──────────────────────────────────
    timelineBtn.addEventListener('click', function() {
        if (!currentDocId || timelineBtn.disabled) return;
        timelineBtn.disabled = true;
        timelineBtn.textContent = 'Building timeline…';
        timelineContent.innerHTML = '<div style="text-align:center;padding:2rem;color:var(--text-muted)">' +
            '<div class="pulsing-dots"><span></span><span></span><span></span></div>' +
            '<div style="margin-top:0.8rem;font-size:0.85rem">Our expert is simulating what could go wrong — about 30 seconds</div></div>';

        var responseText = '';
        fetch(BASE_URL + '/timeline/' + currentDocId, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text: documentFullText })
        }).then(function(response) {
            if (!response.ok) return response.json().then(function(err) { throw new Error(err.error || 'Request failed'); });
            var reader = response.body.getReader();
            var decoder = new TextDecoder();
            var buffer = '';
            var thinkingDone = false;

            function processChunk(result) {
                if (result.done) { timelineBtn.textContent = 'Timeline generated'; return; }
                buffer += decoder.decode(result.value, { stream: true });
                var lines = buffer.split('\n');
                buffer = lines.pop();
                for (var i = 0; i < lines.length; i++) {
                    var line = lines[i].trim();
                    if (!line.startsWith('data: ')) continue;
                    var msg;
                    try { msg = JSON.parse(line.substring(6)); } catch(e) { continue; }
                    if (msg.type === 'text') {
                        if (!thinkingDone) { thinkingDone = true; timelineContent.innerHTML = ''; }
                        responseText += msg.content;
                        timelineContent.innerHTML = '<div class="counter-draft-content">' + safeMd2Html(responseText) + '</div>';
                    } else if (msg.type === 'done') {
                        if (responseText) timelineContent.innerHTML = '<div class="counter-draft-content">' + safeMd2Html(responseText) + '</div>';
                        timelineBtn.textContent = 'Timeline generated';
                        return;
                    } else if (msg.type === 'error') {
                        timelineContent.innerHTML = '<span style="color:var(--red)">' + escapeHtml(msg.content) + '</span>';
                        timelineBtn.textContent = 'Worst-Case Timeline';
                        timelineBtn.disabled = false;
                        return;
                    }
                }
                return reader.read().then(processChunk);
            }
            return reader.read().then(processChunk);
        }).catch(function(err) {
            timelineContent.innerHTML = '<span style="color:var(--red)">' + escapeHtml(err.message) + '</span>';
            timelineBtn.textContent = 'Worst-Case Timeline';
            timelineBtn.disabled = false;
        });
    });

    // ── Counter-Draft ─────────────────────────────────────────
    counterDraftBtn.addEventListener('click', function() {
        if (!currentDocId || counterDraftBtn.disabled) return;
        counterDraftBtn.disabled = true;
        counterDraftBtn.textContent = 'Generating counter-draft…';
        counterDraftContent.innerHTML = '<div style="text-align:center;padding:2rem;color:var(--text-muted)">' +
            '<div class="pulsing-dots"><span></span><span></span><span></span></div>' +
            '<div style="margin-top:0.8rem;font-size:0.85rem">Our expert is drafting fair alternatives — about 30 seconds</div></div>';

        var responseText = '';
        fetch(BASE_URL + '/counter-draft/' + currentDocId, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text: documentFullText })
        }).then(function(response) {
            if (!response.ok) return response.json().then(function(err) { throw new Error(err.error || 'Request failed'); });
            var reader = response.body.getReader();
            var decoder = new TextDecoder();
            var buffer = '';
            var thinkingDone = false;

            function processChunk(result) {
                if (result.done) { finishCounterDraft(); return; }
                buffer += decoder.decode(result.value, { stream: true });
                var lines = buffer.split('\n');
                buffer = lines.pop();
                for (var i = 0; i < lines.length; i++) {
                    var line = lines[i].trim();
                    if (!line.startsWith('data: ')) continue;
                    var msg;
                    try { msg = JSON.parse(line.substring(6)); } catch(e) { continue; }
                    if (msg.type === 'text') {
                        if (!thinkingDone) { thinkingDone = true; counterDraftContent.innerHTML = ''; }
                        responseText += msg.content;
                        counterDraftContent.innerHTML = '<div class="counter-draft-content">' + safeMd2Html(responseText) + '</div>';
                    } else if (msg.type === 'done') {
                        if (responseText) counterDraftContent.innerHTML = '<div class="counter-draft-content">' + safeMd2Html(responseText) + '</div>';
                        finishCounterDraft();
                        return;
                    } else if (msg.type === 'error') {
                        counterDraftContent.innerHTML = '<span style="color:var(--red)">' + escapeHtml(msg.content) + '</span>';
                        finishCounterDraft();
                        return;
                    }
                }
                return reader.read().then(processChunk);
            }
            return reader.read().then(processChunk);
        }).catch(function(err) {
            counterDraftContent.innerHTML = '<span style="color:var(--red)">' + escapeHtml(err.message) + '</span>';
            finishCounterDraft();
        });

        function finishCounterDraft() {
            counterDraftBtn.textContent = 'Counter-draft generated';
        }
    });

    // ── FAQ Navigation ─────────────────────────────────────
    var uploadNav = $('uploadNav');
    var uploadMain = $('uploadMain');
    var faqWrapper = $('faqWrapper');
    if (uploadNav) {
        uploadNav.addEventListener('click', function(e) {
            var link = e.target.closest('a');
            if (!link) return;
            e.preventDefault();
            var href = link.getAttribute('href');
            if (href === '#' && link.dataset.nav === 'top') {
                // Scroll to top / hide FAQ
                faqWrapper.classList.add('hidden');
                uploadMain.classList.remove('has-faq');
                uploadNav.querySelectorAll('a').forEach(function(a) { a.classList.remove('active'); });
                link.classList.add('active');
                uploadMain.scrollTo({ top: 0, behavior: 'smooth' });
                return;
            }
            // Show FAQ and scroll to section
            faqWrapper.classList.remove('hidden');
            uploadMain.classList.add('has-faq');
            uploadNav.querySelectorAll('a').forEach(function(a) { a.classList.remove('active'); });
            link.classList.add('active');
            var target = document.querySelector(href);
            if (target) {
                setTimeout(function() {
                    target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 50);
            }
        });

        // Highlight active nav link on scroll
        var faqSections = document.querySelectorAll('.faq-section[id]');
        var navLinks = uploadNav.querySelectorAll('a[href^="#faq-"]');
        if (faqSections.length && navLinks.length) {
            var scrollContainer = uploadMain;
            var onScroll = function() {
                if (faqWrapper.classList.contains('hidden')) return;
                var scrollTop = scrollContainer.scrollTop || window.scrollY;
                var current = '';
                faqSections.forEach(function(section) {
                    var rect = section.getBoundingClientRect();
                    if (rect.top < 200) current = section.id;
                });
                if (current) {
                    navLinks.forEach(function(a) {
                        a.classList.toggle('active', a.getAttribute('href') === '#' + current);
                    });
                }
            };
            window.addEventListener('scroll', onScroll, { passive: true });
        }
    }

})();
</script>
</body>
</html>
