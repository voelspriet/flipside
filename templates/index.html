<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlipSide — The Other Side of Small Print</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;0,9..40,800;1,9..40,400&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* ══════════════════════════════════════════════════════
           RESET & DESIGN SYSTEM
           ══════════════════════════════════════════════════════ */
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0; }
        .hidden { display: none !important; }

        :root {
            --bg-cream: #f7f5f0;
            --bg-warm: #f0ede6;
            --bg-card: #ffffff;
            --bg-surface: #faf8f4;
            --bg-thinking: #1e1d1a;
            --border: #e2ddd4;
            --border-light: #ece8e0;
            --border-focus: #c44b28;
            --text-primary: #1a1a18;
            --text-body: #3d3b36;
            --text-secondary: #6b6860;
            --text-muted: #9c9789;
            --text-dim: #bfb9ad;
            --accent: #c44b28;
            --accent-hover: #a83d20;
            --accent-light: rgba(196, 75, 40, 0.08);
            --accent-medium: rgba(196, 75, 40, 0.15);
            --green: #2d8a4e;
            --green-bg: rgba(45, 138, 78, 0.07);
            --green-border: rgba(45, 138, 78, 0.22);
            --green-text: #1e6b38;
            --yellow: #b8860b;
            --yellow-bg: rgba(184, 134, 11, 0.07);
            --yellow-border: rgba(184, 134, 11, 0.22);
            --yellow-text: #8a6508;
            --red: #c44b28;
            --red-bg: rgba(196, 75, 40, 0.07);
            --red-border: rgba(196, 75, 40, 0.22);
            --red-text: #a83d20;
            --radius: 12px;
            --radius-md: 8px;
            --radius-sm: 6px;
            --transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.04), 0 1px 2px rgba(0,0,0,0.03);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.06);
            --shadow-lg: 0 8px 32px rgba(0,0,0,0.08);
            --col-width: 720px;
            --ease-out-expo: cubic-bezier(0.22, 1, 0.36, 1);
            --ink: #1a1a18;
            --cream: #f7f5f0;
            --smoke: #6b6860;
            --ash: #9c9789;
        }

        /* ── Dark mode ──────────────────────────────── */
        @media (prefers-color-scheme: dark) {
            :root:not(.light-override) {
                --bg-cream: #1a1917;
                --bg-warm: #222120;
                --bg-card: #2a2927;
                --bg-surface: #252422;
                --bg-thinking: #131210;
                --border: #3d3a35;
                --border-light: #333128;
                --text-primary: #e8e4dc;
                --text-body: #c8c3b8;
                --text-secondary: #a09a8e;
                --text-muted: #78736a;
                --text-dim: #585450;
                --shadow-sm: 0 1px 3px rgba(0,0,0,0.2);
                --shadow-md: 0 4px 12px rgba(0,0,0,0.3);
                --shadow-lg: 0 8px 32px rgba(0,0,0,0.4);
            }
        }
        .dark-mode {
            --bg-cream: #1a1917;
            --bg-warm: #222120;
            --bg-card: #2a2927;
            --bg-surface: #252422;
            --bg-thinking: #131210;
            --border: #3d3a35;
            --border-light: #333128;
            --text-primary: #e8e4dc;
            --text-body: #c8c3b8;
            --text-secondary: #a09a8e;
            --text-muted: #78736a;
            --text-dim: #585450;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.2);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.3);
            --shadow-lg: 0 8px 32px rgba(0,0,0,0.4);
        }

        body {
            font-family: 'DM Sans', system-ui, -apple-system, sans-serif;
            background: var(--bg-cream);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* ── Grain overlay ──────────────────────────── */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            z-index: 9999;
            pointer-events: none;
            opacity: 0.025;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
            background-repeat: repeat;
            background-size: 256px 256px;
        }
        @media print { body::before { display: none; } }

        ::selection { background: rgba(196, 75, 40, 0.25); }

        /* ══════════════════════════════════════════════════════
           ANIMATIONS
           ══════════════════════════════════════════════════════ */
        .fade-up {
            opacity: 0; transform: translateY(16px);
            animation: fadeUp 0.7s cubic-bezier(0.22, 1, 0.36, 1) forwards;
        }
        @keyframes fadeUp { to { opacity: 1; transform: translateY(0); } }
        .fade-up-d1 { animation-delay: 0.1s; }
        .fade-up-d2 { animation-delay: 0.2s; }
        .fade-up-d3 { animation-delay: 0.3s; }

        @keyframes clauseDropIn {
            0% { transform: translateY(20px); opacity: 0; }
            70% { transform: translateY(-3px); }
            100% { transform: translateY(0); opacity: 1; }
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }
        @keyframes scoreBarFill {
            from { width: 0; }
        }

        /* ══════════════════════════════════════════════════════
           SCREEN 1: UPLOAD
           ══════════════════════════════════════════════════════ */
        #upload-screen {
            min-height: 100vh;
            display: flex; align-items: center; justify-content: center;
            padding: 2rem;
        }
        .upload-container { max-width: 520px; width: 100%; }

        .brand { text-align: center; margin-bottom: 2.5rem; }
        .brand h1 {
            font-size: 3.2rem; font-weight: 800;
            letter-spacing: -0.04em; color: var(--text-primary); line-height: 1.1;
        }
        .brand .tagline {
            font-size: 1.05rem; color: var(--text-secondary);
            margin-top: 0.5rem; font-weight: 400; font-style: italic;
        }

        .upload-card {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius); padding: 2rem; box-shadow: var(--shadow-md);
        }

        .drop-zone {
            border: 2px dashed var(--border); border-radius: var(--radius-md);
            padding: 2.5rem 2rem; text-align: center; cursor: pointer;
            transition: all var(--transition); background: var(--bg-surface);
        }
        .drop-zone:hover, .drop-zone.dragover {
            border-color: var(--accent); background: var(--accent-light);
            transform: scale(1.01); box-shadow: 0 0 0 4px rgba(196, 75, 40, 0.1);
        }
        .drop-zone .icon { font-size: 2.2rem; margin-bottom: 0.6rem; display: block; opacity: 0.6; }
        .drop-zone .dz-title { font-size: 0.95rem; font-weight: 600; color: var(--text-primary); }
        .drop-zone .hint { font-size: 0.85rem; color: var(--text-muted); margin-top: 0.15rem; }
        .drop-zone .filetypes {
            font-size: 0.72rem; color: var(--text-dim); margin-top: 0.6rem;
            letter-spacing: 0.12em; text-transform: uppercase;
        }

        .file-selected {
            display: flex; align-items: center; justify-content: center;
            gap: 0.6rem; padding: 0.4rem 0;
        }
        .file-selected .file-name { font-weight: 600; font-size: 0.92rem; color: var(--text-primary); }
        .file-selected .file-size { font-size: 0.78rem; color: var(--text-muted); }
        .file-remove {
            color: var(--text-muted); font-size: 0.78rem; text-decoration: none;
            margin-left: 0.5rem; cursor: pointer; transition: color var(--transition);
        }
        .file-remove:hover { color: var(--red); }

        .paste-area {
            width: 100%; min-height: 120px; background: var(--bg-surface);
            border: 1px solid var(--border); border-radius: var(--radius-sm);
            color: var(--text-primary); font-family: 'JetBrains Mono', monospace;
            font-size: 0.82rem; padding: 1rem; resize: vertical; margin-top: 1rem;
            outline: none; transition: border-color var(--transition);
        }
        .paste-area:focus { border-color: var(--accent); }
        .paste-area::placeholder { color: var(--text-dim); }

        /* Depth selector */
        .depth-selector {
            display: flex; border-radius: var(--radius-sm);
            overflow: hidden; border: 1px solid var(--border); margin-top: 1.2rem;
        }
        .depth-btn {
            flex: 1; padding: 0.5rem 0.4rem; background: var(--bg-surface);
            color: var(--text-muted); border: none; font-family: inherit;
            font-size: 0.78rem; font-weight: 500; cursor: pointer;
            transition: all var(--transition); text-align: center;
        }
        .depth-btn + .depth-btn { border-left: 1px solid var(--border); }
        .depth-btn.active { background: var(--text-primary); color: var(--bg-cream); }
        .depth-btn:hover:not(.active) { background: var(--bg-warm); color: var(--text-secondary); }

        .analyze-btn {
            width: 100%; margin-top: 1.5rem; padding: 0.85rem; font-size: 0.95rem;
            font-weight: 600; font-family: inherit; background: var(--accent);
            color: white; border: none; border-radius: var(--radius-md); cursor: pointer;
            transition: all var(--transition); letter-spacing: -0.01em;
        }
        .analyze-btn:hover:not(:disabled) {
            background: var(--accent-hover); transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(196, 75, 40, 0.2);
        }
        .analyze-btn:disabled { opacity: 0.35; cursor: not-allowed; }

        .upload-links {
            text-align: center; margin-top: 1rem;
            display: flex; flex-wrap: wrap; justify-content: center; gap: 0.5rem 1.2rem;
            font-size: 0.82rem;
        }
        .upload-links a {
            color: var(--text-muted); text-decoration: none; cursor: pointer;
            border-bottom: 1px dotted var(--text-dim); transition: color var(--transition);
        }
        .upload-links a:hover { color: var(--accent); border-bottom-color: var(--accent); }

        .upload-error {
            margin-top: 0.8rem; padding: 0.6rem 0.8rem; background: var(--red-bg);
            border: 1px solid var(--red-border); border-radius: var(--radius-sm);
            color: var(--red-text); font-size: 0.82rem;
        }

        /* Compare mode */
        .compare-row { display: flex; gap: 0.75rem; }
        .compare-col { flex: 1; }
        @media (max-width: 500px) { .compare-row { flex-direction: column; } }

        .disclaimer {
            text-align: center; margin-top: 1.25rem; font-size: 0.7rem;
            color: var(--text-dim); line-height: 1.7;
        }

        /* ══════════════════════════════════════════════════════
           SCREEN 2/3: ANALYSIS
           ══════════════════════════════════════════════════════ */
        #analysis-screen { min-height: 100vh; display: flex; flex-direction: column; }

        /* ── Sticky header ───────────────────────────── */
        .analysis-header {
            padding: 0.5rem 1.5rem; border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
            background: var(--bg-cream); position: sticky; top: 0; z-index: 100;
            gap: 0.75rem; flex-wrap: wrap;
        }
        .header-left { display: flex; align-items: center; gap: 0.75rem; min-width: 0; }
        .header-brand {
            font-size: 1rem; font-weight: 700; letter-spacing: -0.02em;
            white-space: nowrap; cursor: pointer;
        }
        .status-pill {
            display: inline-flex; align-items: center; gap: 0.4rem;
            font-size: 0.76rem; color: var(--text-secondary); background: var(--bg-card);
            padding: 0.2rem 0.65rem; border-radius: 20px; border: 1px solid var(--border);
            white-space: nowrap;
        }
        .status-dot {
            width: 6px; height: 6px; border-radius: 50%;
            background: var(--accent); animation: pulse 1.5s infinite; flex-shrink: 0;
        }
        .status-pill.done .status-dot { background: var(--green); animation: none; }
        .elapsed-time { font-variant-numeric: tabular-nums; }

        .header-right { display: flex; align-items: center; gap: 0.5rem; }
        .header-btn {
            background: none; border: 1px solid var(--border); color: var(--text-secondary);
            padding: 0.25rem 0.7rem; border-radius: var(--radius-sm); font-family: inherit;
            font-size: 0.76rem; cursor: pointer; transition: all var(--transition);
            white-space: nowrap;
        }
        .header-btn:hover {
            border-color: var(--text-secondary); color: var(--text-primary);
            background: var(--bg-warm);
        }

        /* ── Analysis two-column layout ─────────────── */
        .analysis-layout {
            display: flex;
            gap: 2rem;
            padding: 0 2rem;
            align-items: flex-start;
        }
        .analysis-sidebar {
            width: 320px;
            flex-shrink: 0;
            position: sticky;
            top: 70px;
            padding-top: 0.5rem;
        }

        /* ── Sidebar profile row: thumbnail + pills ─── */
        .sidebar-profile {
            display: flex;
            gap: 0.6rem;
            align-items: flex-start;
        }
        .metadata-line {
            flex: 1; min-width: 0;
            display: flex; flex-wrap: wrap; gap: 0.25rem;
            align-content: flex-start;
            opacity: 0; transform: translateY(8px);
            transition: opacity 0.6s var(--ease-out-expo), transform 0.6s var(--ease-out-expo);
        }
        .metadata-line.visible {
            opacity: 1; transform: translateY(0);
        }
        .meta-pill {
            display: inline-flex; align-items: center; gap: 0.25rem;
            padding: 0.2rem 0.5rem;
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 100px; font-size: 0.65rem;
            color: var(--text-body); line-height: 1.2;
            max-width: 100%; white-space: nowrap;
            overflow: hidden; text-overflow: ellipsis;
        }
        .meta-pill .meta-pill-label {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.45rem; font-weight: 600;
            text-transform: uppercase; letter-spacing: 0.08em;
            color: var(--text-muted); white-space: nowrap;
        }

        /* ── Content column (center) ──────────────── */
        .content-col {
            flex: 1;
            max-width: var(--col-width);
            padding: 0 0 4rem;
        }

        /* ── Insight column (right — "What you should read") */
        .insight-column {
            width: 280px;
            flex-shrink: 0;
            position: sticky;
            top: 70px;
            padding-top: 0.5rem;
        }
        .insight-label {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.6rem; font-weight: 600;
            text-transform: uppercase; letter-spacing: 0.15em;
            color: var(--text-dim); margin-bottom: 0.75rem;
        }
        .insight-card {
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow-md);
            transform: translateY(-20px);
            opacity: 0;
            transition: transform 0.5s var(--ease-out-expo), opacity 0.4s var(--ease-out-expo);
        }
        .insight-card.visible {
            transform: translateY(0);
            opacity: 1;
        }
        .insight-card-inner {
            padding: 1.25rem 1.25rem;
            font-size: 0.88rem; line-height: 1.65;
            color: var(--text-primary); font-weight: 500;
        }
        .insight-card-red {
            background: linear-gradient(135deg, rgba(196,75,40,0.06), rgba(196,75,40,0.12));
            border: 1px solid var(--red-border);
            border-left: 4px solid var(--red);
        }
        .insight-card-yellow {
            background: linear-gradient(135deg, rgba(196,155,40,0.06), rgba(196,155,40,0.12));
            border: 1px solid var(--yellow-border);
            border-left: 4px solid var(--yellow);
        }
        .insight-card-green {
            background: linear-gradient(135deg, rgba(45,138,78,0.04), rgba(45,138,78,0.08));
            border: 1px solid var(--green-border);
            border-left: 4px solid var(--green);
        }
        .insight-card .insight-en {
            font-size: 0.78rem; color: var(--text-muted);
            font-style: italic; margin-top: 0.6rem;
            padding-top: 0.6rem; border-top: 1px dashed var(--border-light);
        }
        .insight-card .insight-en::before {
            content: 'EN'; display: inline-block;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.5rem; font-weight: 700; font-style: normal;
            background: var(--bg-surface); border: 1px solid var(--border);
            border-radius: 3px; padding: 0.1rem 0.3rem;
            margin-right: 0.4rem; vertical-align: middle;
        }
        .insight-should-read {
            margin-bottom: 0.5rem;
        }
        .insight-example {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px dashed var(--border-light);
        }
        .insight-example-label {
            display: block;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.6rem; font-weight: 600;
            text-transform: uppercase; letter-spacing: 0.12em;
            color: var(--text-dim);
            margin-bottom: 0.5rem;
        }
        .insight-figure {
            font-size: 1.35rem;
            font-weight: 700;
            line-height: 1.3;
            margin-bottom: 0.6rem;
            letter-spacing: -0.01em;
        }
        .insight-figure-red { color: var(--red); }
        .insight-figure-yellow { color: var(--yellow); }
        .insight-figure-green { color: var(--green); }
        .insight-narrative {
            font-size: 0.82rem;
            line-height: 1.6;
            color: var(--text-secondary);
        }
        .insight-figure-en {
            font-weight: 600;
            margin-bottom: 0.3rem;
        }
        .insight-num {
            font-weight: 700;
            color: var(--text-primary);
        }
        .insight-card-red .insight-num { color: var(--red); }
        .insight-card-yellow .insight-num { color: var(--yellow); }
        .insight-card-green .insight-num { color: var(--green); }

        /* ── Document thumbnail (upper-left of profile) */
        .doc-thumbnail {
            width: 72px; height: 96px;
            flex-shrink: 0;
            border-radius: var(--radius-sm);
            overflow: hidden;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
            line-height: 0;
        }
        .doc-thumbnail img {
            width: 100%; height: 100%;
            display: block;
            object-fit: contain;
            object-position: top left;
            background: #fff;
            opacity: 0.85;
            transition: opacity 0.3s;
        }
        .doc-thumbnail img:hover { opacity: 1; }

        /* ── Editorial loading state ────────────────── */
        .editorial-loading {
            margin: 1rem 0 0; padding: 0;
            width: 100%;
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius); box-shadow: var(--shadow-md);
            transition: opacity 0.5s var(--ease-out-expo), transform 0.5s var(--ease-out-expo);
            overflow: hidden;
        }

        @media (max-width: 1200px) {
            .insight-column { width: 220px; }
        }
        @media (max-width: 900px) {
            .analysis-layout { flex-direction: column; padding: 0 1rem; gap: 1rem; }
            .analysis-sidebar { width: 100%; position: static; }
            .insight-column { width: 100%; position: static; order: 2; }
            .content-col { order: 1; }
        }
        .editorial-loading-label {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.6rem; font-weight: 600;
            text-transform: uppercase; letter-spacing: 0.15em;
            color: var(--text-muted);
            padding: 1rem 1.5rem 0.4rem;
        }
        .editorial-loading-text {
            font-size: 0.78rem; line-height: 1.65;
            color: var(--text-secondary);
            padding: 0 1.5rem;
            max-height: 50vh; overflow-y: auto;
            border-left: 3px solid var(--border);
            margin-left: 1.5rem; margin-right: 1.5rem;
            padding-left: 1rem;
            scroll-behavior: smooth;
        }
        .editorial-loading-text::-webkit-scrollbar { width: 3px; }
        .editorial-loading-text::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        .editorial-loading-text .doc-highlight {
            position: relative;
            border-radius: 2px;
            transition: background 0.4s var(--ease-out-expo);
        }
        .editorial-loading-text .doc-highlight-green { background: rgba(45, 138, 78, 0.06); }
        .editorial-loading-text .doc-highlight-yellow { background: rgba(184, 134, 11, 0.06); }
        .editorial-loading-text .doc-highlight-red { background: rgba(196, 75, 40, 0.06); }
        .editorial-loading-text .doc-highlight.active.doc-highlight-green { background: rgba(45, 138, 78, 0.15); }
        .editorial-loading-text .doc-highlight.active.doc-highlight-yellow { background: rgba(184, 134, 11, 0.15); }
        .editorial-loading-text .doc-highlight.active.doc-highlight-red { background: rgba(196, 75, 40, 0.18); }
        .doc-clause-marker {
            display: inline-block; font-family: 'JetBrains Mono', monospace;
            font-size: 0.55rem; font-weight: 700; line-height: 1;
            width: 15px; height: 15px; text-align: center; line-height: 15px;
            border-radius: 50%; margin-right: 3px;
            vertical-align: middle; color: #fff; cursor: pointer;
        }
        .doc-highlight { cursor: pointer; }
        .doc-clause-marker-green { background: var(--green); }
        .doc-clause-marker-yellow { background: var(--yellow); }
        .doc-clause-marker-red { background: var(--red); }
        .editorial-loading-indicator {
            display: flex; align-items: center; gap: 0.75rem;
            margin: 0 1.5rem; padding: 1rem 0 1.2rem;
            border-top: 1px solid transparent;
            border-image: linear-gradient(90deg, transparent, var(--border), transparent) 1;
        }
        .editorial-loading-status {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem; font-weight: 500;
            text-transform: uppercase; letter-spacing: 0.15em;
            color: var(--text-muted);
        }
        .pulsing-dots { display: inline-flex; gap: 3px; }
        .pulsing-dots span {
            width: 4px; height: 4px; border-radius: 50%;
            background: var(--accent); animation: pulse 1.5s infinite;
        }
        .pulsing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .pulsing-dots span:nth-child(3) { animation-delay: 0.4s; }
        .pulsing-dot {
            display: inline-block; width: 6px; height: 6px;
            border-radius: 50%; background: var(--accent);
            margin-left: 0.4rem; animation: pulse 1.5s infinite;
            vertical-align: middle;
        }

        /* ── Card viewport ──────────────────────────── */
        .card-viewport { margin: 1.5rem 0; }
        .card-navigation {
            display: flex; align-items: center; justify-content: center;
            gap: 1.5rem; padding: 1.5rem 0;
        }
        .card-nav-btn {
            display: inline-flex; align-items: center; gap: 0.35rem;
            background: none; border: 1px solid var(--border);
            padding: 0.55rem 1.2rem; border-radius: var(--radius-sm);
            font-family: inherit; font-size: 0.82rem; font-weight: 500;
            color: var(--text-secondary); cursor: pointer;
            transition: all var(--transition);
        }
        .card-nav-btn:hover:not(:disabled) {
            border-color: var(--text-muted); color: var(--text-primary);
            background: var(--bg-card);
        }
        .card-nav-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        .card-nav-counter {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.78rem; color: var(--text-muted); font-weight: 500;
            font-variant-numeric: tabular-nums;
        }
        .card-nav-counter strong { color: var(--text-primary); font-weight: 700; }

        /* ── Section label ──────────────────────────── */
        .section-label {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem; font-weight: 500;
            text-transform: uppercase; letter-spacing: 0.15em;
            color: var(--text-muted);
        }
        .editorial-divider {
            border: none; height: 1px;
            background: linear-gradient(90deg, transparent, var(--border), transparent);
            margin: 1.5rem 0;
        }

        /* ── Thinking panel ──────────────────────────── */
        .thinking-panel {
            background: var(--bg-thinking); color: #a8a29e;
            border-radius: var(--radius); margin: 1rem 0; overflow: hidden;
            transition: max-height 0.5s ease, opacity 0.3s ease;
            max-height: 2000px; opacity: 1;
        }
        .thinking-panel.collapsed { max-height: 40px; opacity: 0.7; }
        .thinking-panel.collapsed .thinking-text { display: none; }
        .thinking-panel.collapsed .thinking-header { border-bottom: none; }
        .thinking-header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 0.65rem 1rem; cursor: pointer;
            border-bottom: 1px solid rgba(255,255,255,0.06);
        }
        .thinking-label {
            font-size: 0.78rem; font-weight: 600; color: #d4d0c8;
            display: flex; align-items: center; gap: 0.5rem;
        }
        .thinking-label .phase-icon { font-size: 0.65rem; opacity: 0.6; }
        .thinking-toggle {
            font-size: 0.72rem; color: #78736a; background: none; border: none;
            cursor: pointer; font-family: inherit; padding: 0.2rem 0.5rem;
            border-radius: var(--radius-sm); transition: color var(--transition);
        }
        .thinking-toggle:hover { color: #a8a29e; }
        .thinking-text {
            padding: 0.8rem 1rem; font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem; line-height: 1.7; max-height: 400px;
            overflow-y: auto; white-space: pre-wrap; word-break: break-word;
        }
        .thinking-text .kw {
            color: var(--accent); font-weight: 500;
            background: rgba(196, 75, 40, 0.12); padding: 0 2px; border-radius: 2px;
        }
        .thinking-text .cursor {
            display: inline-block; width: 7px; height: 14px;
            background: var(--accent); margin-left: 2px; vertical-align: text-bottom;
            animation: blink 0.8s step-end infinite;
        }
        .thinking-text .phase-sep {
            display: block; margin: 1rem 0 0.5rem;
            padding-top: 0.8rem; border-top: 1px solid rgba(255,255,255,0.08);
            color: #78736a; font-weight: 600; font-size: 0.72rem;
            text-transform: uppercase; letter-spacing: 0.08em;
        }

        /* ── Results area ────────────────────────────── */
        .results-area { margin-top: 1.5rem; }

        /* Summary card — shown after done */
        .summary-card {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius); padding: 1.5rem; margin-bottom: 1.5rem;
            box-shadow: var(--shadow-md); animation: fadeUp 0.5s ease forwards;
        }
        .summary-top { display: flex; gap: 1.5rem; align-items: flex-start; }
        .score-ring-container { flex-shrink: 0; }
        .score-ring { width: 110px; height: 110px; overflow: visible; }
        .score-ring .ring-bg { fill: none; stroke: var(--border); stroke-width: 6; }
        .score-ring .ring-fill {
            fill: none; stroke-width: 6; stroke-linecap: round;
            transform: rotate(-90deg); transform-origin: center;
            transition: stroke-dashoffset 1s ease;
        }
        .score-ring .score-value {
            font-size: 24px; font-weight: 800; fill: var(--text-primary);
            font-family: 'DM Sans', sans-serif;
        }
        .score-ring .score-label {
            font-size: 9px; fill: var(--text-secondary); font-weight: 500;
            font-family: 'DM Sans', sans-serif;
        }
        .summary-meta { flex: 1; min-width: 0; }
        .summary-title {
            font-size: 1rem; font-weight: 700; margin-bottom: 0.5rem;
            color: var(--text-primary);
        }
        .score-bars { display: flex; flex-direction: column; gap: 0.35rem; }
        .score-bar-row {
            display: flex; align-items: center; gap: 0.5rem; font-size: 0.78rem;
        }
        .score-bar-label { width: 38px; color: var(--text-secondary); font-weight: 500; }
        .score-bar-track {
            flex: 1; height: 6px; background: var(--border-light);
            border-radius: 3px; overflow: hidden;
        }
        .score-bar-fill {
            height: 100%; border-radius: 3px;
            transition: width 1s ease;
        }
        .score-bar-value { width: 24px; text-align: right; font-weight: 600; font-size: 0.75rem; }
        .risk-distribution { display: none; }
        .summary-concerns {
            list-style: none; margin-top: 0.8rem; padding: 0;
            font-size: 0.82rem; color: var(--text-body);
        }
        .summary-concerns li {
            padding: 0.3rem 0; border-bottom: 1px solid var(--border-light);
        }
        .summary-concerns li:last-child { border-bottom: none; }

        /* ── Filter chips (removed) ──────────────────── */
        .filter-chips { display: none; }

        /* ── Clause cards ────────────────────────────── */
        .clause-card, .cross-clause-card, .playbook-card, .assessment-card {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius); padding: 1.25rem 1.5rem;
            margin-bottom: 1rem; box-shadow: var(--shadow-sm);
            position: relative; opacity: 1;
        }
        .clause-card.new-card, .cross-clause-card.new-card,
        .playbook-card.new-card, .assessment-card.new-card,
        .flip-card.new-card {
            animation: clauseDropIn 0.4s var(--ease-out-expo) forwards; opacity: 0;
        }
        .clause-card h3, .cross-clause-card h3, .playbook-card h3 {
            font-size: 0.95rem; font-weight: 700; margin-bottom: 0.6rem;
            color: var(--text-primary); line-height: 1.3;
        }
        .clause-card p, .cross-clause-card p, .playbook-card p, .assessment-card p {
            font-size: 0.88rem; color: var(--text-body); margin-bottom: 0.5rem;
        }
        .clause-card blockquote {
            border-left: 3px solid var(--accent); padding: 0.5rem 1rem;
            margin: 0.6rem 0; background: var(--accent-light);
            font-style: italic; font-size: 0.85rem; color: var(--text-body);
            border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
        }
        .clause-card hr { border: none; border-top: 1px solid var(--border-light); margin: 1rem 0; }

        /* Risk level card borders */
        .level-red { border-left: 3px solid var(--red); }
        .level-yellow { border-left: 3px solid var(--yellow); }
        .level-green { border-left: 3px solid var(--green); }

        /* Risk badges */
        .risk-badge {
            display: inline-block; padding: 2px 8px; border-radius: 4px;
            font-size: 0.7rem; font-weight: 700; letter-spacing: 0.04em;
            vertical-align: middle;
        }
        .risk-green { background: var(--green-bg); color: var(--green-text); border: 1px solid var(--green-border); }
        .risk-yellow { background: var(--yellow-bg); color: var(--yellow-text); border: 1px solid var(--yellow-border); }
        .risk-red { background: var(--red-bg); color: var(--red-text); border: 1px solid var(--red-border); }

        .risk-score {
            font-size: 0.78rem; color: var(--text-secondary); margin-left: 0.5rem;
            display: inline-flex; align-items: center; gap: 0.4rem;
        }
        .score-bar { display: inline-block; width: 60px; height: 4px; background: var(--border-light); border-radius: 2px; vertical-align: middle; }
        .score-fill { display: block; height: 100%; border-radius: 2px; transition: width 0.6s ease; }
        .trick-label {
            display: inline-block; margin-left: 0.5rem; padding: 1px 6px;
            background: var(--bg-warm); border: 1px solid var(--border);
            border-radius: var(--radius-sm); font-size: 0.72rem; color: var(--text-secondary);
        }

        /* "What the small print says" / "What you should read" juxtaposition */
        .clause-split-header {
            display: flex; gap: 1rem; margin-top: 0.8rem;
        }
        .clause-split-label {
            flex: 1; font-family: 'JetBrains Mono', monospace;
            font-size: 0.62rem; font-weight: 500; text-transform: uppercase;
            letter-spacing: 0.12em; padding-bottom: 0.3rem;
        }
        .clause-split-label-left { color: var(--text-muted); }
        .clause-split-label-right { color: var(--accent); }
        .clause-split {
            display: flex; gap: 1rem; margin-bottom: 0.8rem;
        }
        .clause-split > div {
            flex: 1; padding: 0.8rem; border-radius: var(--radius-sm);
            font-size: 0.85rem; line-height: 1.6;
        }
        .clause-split-left {
            background: var(--bg-surface); color: var(--text-body);
            border: 1px solid var(--border-light);
        }
        .clause-split-right {
            background: var(--accent-light); color: var(--text-primary);
            border: 1px solid var(--accent-medium);
            font-weight: 500;
        }
        @media (max-width: 600px) {
            .clause-split-header, .clause-split { flex-direction: column; gap: 0.25rem; }
        }

        /* Cross-clause cards */
        .cross-clause-card { border-left: 3px solid var(--accent); }
        .playbook-card { border-left: 3px solid var(--yellow); }
        .assessment-card {
            border-left: 3px solid var(--red);
            background: linear-gradient(135deg, var(--bg-card), rgba(196, 75, 40, 0.03));
        }
        .assessment-card h3 {
            font-size: 1rem;
        }

        /* ── Flip cards (3D) ─────────────────────────── */
        @keyframes cardWoosh {
            0% { transform: translateY(80px) scale(0.96); opacity: 0; filter: blur(6px); }
            55% { transform: translateY(-6px) scale(1.005); opacity: 1; filter: blur(0); }
            75% { transform: translateY(2px) scale(0.999); }
            100% { transform: translateY(0) scale(1); }
        }
        .flip-card {
            perspective: 1200px;
            margin-bottom: 1.5rem;
        }
        .flip-card.woosh-in {
            animation: cardWoosh 0.65s cubic-bezier(0.22, 1, 0.36, 1) both;
        }
        .flip-card-inner {
            position: relative;
            transition: transform 0.7s var(--ease-out-expo);
            transform-style: preserve-3d;
        }
        .flip-card.flipped .flip-card-inner {
            transform: rotateY(180deg);
        }
        .flip-card-front, .flip-card-back {
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            border-radius: var(--radius);
        }
        .flip-card-front {
            background: var(--bg-card);
            border: 1px solid var(--border);
            box-shadow: var(--shadow-md);
        }
        .flip-card-back {
            transform: rotateY(180deg);
            position: absolute;
            top: 0; left: 0; width: 100%;
            background: var(--bg-card);
            border: 1px solid var(--border);
            box-shadow: var(--shadow-md);
        }
        .flip-card.flipped .flip-card-front {
            visibility: hidden;
            position: absolute;
            top: 0; left: 0; width: 100%;
        }
        .flip-card.flipped .flip-card-back {
            position: relative;
        }

        /* Front content */
        .front-content { padding: 2rem 2rem 0; }
        .clause-reassurance {
            font-size: 1.3rem; font-weight: 700; color: var(--green-text);
            line-height: 1.25; margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-light);
        }
        .clause-section-ref {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem; font-weight: 500; color: var(--text-dim);
            text-transform: uppercase; letter-spacing: 0.15em; margin-bottom: 0.35rem;
        }
        .flip-card .clause-title {
            font-size: 1.15rem; font-weight: 700; color: var(--text-primary);
            line-height: 1.3; margin-bottom: 1rem;
        }
        .flip-card .clause-quote {
            position: relative; padding: 0.9rem 1.1rem; margin-bottom: 1.25rem;
            background: var(--bg-surface); border-radius: var(--radius-sm);
            border-left: 3px solid var(--border); font-size: 0.84rem;
            line-height: 1.65; color: var(--text-secondary); font-style: italic;
        }
        .find-in-doc {
            display: inline-block;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.6rem; font-weight: 500;
            text-transform: uppercase; letter-spacing: 0.1em;
            color: var(--text-dim); cursor: pointer;
            margin-bottom: 1rem; padding: 0.2rem 0;
            transition: color var(--transition);
            text-decoration: none;
        }
        .find-in-doc:hover { color: var(--accent); }
        .reader-voice {
            padding: 1rem 1.1rem; border-radius: var(--radius-sm);
            background: linear-gradient(135deg, rgba(45, 138, 78, 0.04), rgba(45, 138, 78, 0.08));
            border-left: 3px solid var(--green);
        }
        .reader-voice-label {
            display: block; font-family: 'JetBrains Mono', monospace;
            font-size: 0.65rem; font-weight: 500;
            text-transform: uppercase; letter-spacing: 0.12em;
            color: var(--green-text); margin-bottom: 0.4rem;
        }
        .reader-voice-text {
            font-size: 0.92rem; line-height: 1.6; color: var(--text-body); font-style: italic;
        }
        .reader-voice-en {
            font-size: 0.78rem; line-height: 1.5; color: var(--text-muted);
            font-style: italic; margin-top: 0.4rem;
            padding-top: 0.4rem; border-top: 1px dashed var(--border-light);
        }
        .reader-voice-en::before {
            content: 'EN'; display: inline-block;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.5rem; font-weight: 700; font-style: normal;
            text-transform: uppercase; letter-spacing: 0.08em;
            background: var(--bg-surface); border: 1px solid var(--border);
            border-radius: 3px; padding: 0.1rem 0.3rem;
            margin-right: 0.4rem; vertical-align: middle;
            color: var(--text-muted);
        }

        /* Flip trigger — the invitation */
        .flip-trigger {
            display: flex; align-items: center; justify-content: center; gap: 0.6rem;
            width: calc(100% - 2.5rem); margin: 1.25rem auto 0; padding: 0.9rem 2rem;
            background: var(--accent); border: none; border-radius: var(--radius);
            cursor: pointer; font-family: inherit; font-size: 0.85rem;
            font-weight: 700; color: #fff; letter-spacing: 0.02em;
            transition: background 0.25s var(--ease-out-expo), transform 0.25s var(--ease-out-expo), box-shadow 0.25s;
            position: relative; overflow: hidden;
            box-shadow: 0 2px 8px rgba(196,75,40,0.18);
        }
        .flip-trigger::before {
            content: ''; position: absolute; inset: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.12), transparent);
            opacity: 0; transition: opacity var(--transition);
        }
        .flip-trigger:hover::before { opacity: 1; }
        .flip-trigger:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
            box-shadow: 0 4px 14px rgba(196,75,40,0.25);
        }
        .flip-trigger-arrow {
            display: inline-block; font-size: 1rem;
            transition: transform 0.4s var(--ease-out-expo);
        }
        .flip-trigger:hover .flip-trigger-arrow {
            transform: translateX(4px);
        }

        /* Back content */
        .back-content { padding: 0; }
        .risk-header {
            padding: 1.25rem 2rem; display: flex; align-items: center;
            justify-content: space-between; gap: 0.75rem; flex-wrap: wrap;
        }
        .risk-header-red {
            background: linear-gradient(135deg, rgba(196,75,40,0.08), rgba(196,75,40,0.14));
            border-bottom: 2px solid var(--red);
        }
        .risk-header-yellow {
            background: linear-gradient(135deg, rgba(184,134,11,0.06), rgba(184,134,11,0.12));
            border-bottom: 2px solid var(--yellow);
        }
        .risk-header-green {
            background: linear-gradient(135deg, rgba(45,138,78,0.06), rgba(45,138,78,0.10));
            border-bottom: 2px solid var(--green);
        }
        .risk-header .clause-title { margin-bottom: 0; font-size: 1.05rem; }
        .risk-badge-group {
            display: flex; align-items: center; gap: 0.5rem; flex-shrink: 0;
        }
        .risk-badge {
            display: inline-flex; align-items: center; gap: 0.3rem;
            padding: 0.2rem 0.6rem; border-radius: 4px;
            font-size: 0.72rem; font-weight: 700; letter-spacing: 0.04em;
        }
        .risk-badge-red { background: var(--red-bg); color: var(--red-text); border: 1px solid var(--red-border); }
        .risk-badge-yellow { background: var(--yellow-bg); color: var(--yellow-text); border: 1px solid var(--yellow-border); }
        .risk-badge-green { background: var(--green-bg); color: var(--green-text); border: 1px solid var(--green-border); }
        .risk-score-val { font-size: 0.82rem; font-weight: 700; font-variant-numeric: tabular-nums; }
        .risk-score-red { color: var(--red-text); }
        .risk-score-yellow { color: var(--yellow-text); }
        .risk-score-green { color: var(--green-text); }
        .trick-label {
            padding: 0.15rem 0.5rem; background: var(--bg-warm);
            border: 1px solid var(--border); border-radius: var(--radius-sm);
            font-size: 0.7rem; font-weight: 500; color: var(--text-secondary);
        }
        .confidence-badge {
            display: inline-flex; align-items: center; gap: 0.25rem;
            padding: 0.15rem 0.5rem; border-radius: var(--radius-sm);
            font-size: 0.62rem; font-weight: 600; letter-spacing: 0.03em;
            text-transform: uppercase; cursor: default;
        }
        .confidence-high { background: var(--green-bg); color: var(--green-text); border: 1px solid var(--green-border); }
        .confidence-medium { background: var(--yellow-bg); color: var(--yellow-text); border: 1px solid var(--yellow-border); }
        .confidence-low { background: var(--red-bg); color: var(--red-text); border: 1px solid var(--red-border); font-style: italic; }
        .confidence-reason {
            font-weight: 400; font-style: italic; font-size: 0.58rem;
            text-transform: none; letter-spacing: 0; max-width: 0;
            overflow: hidden; white-space: nowrap;
            transition: max-width 0.3s var(--ease-out-expo), padding-left 0.3s ease;
        }
        .confidence-badge:hover .confidence-reason { max-width: 220px; padding-left: 0.3rem; }

        .back-body { padding: 1.5rem 2rem 0; }

        /* Drafter's voice — risk-colored */
        .drafter-voice {
            padding: 1rem 1.1rem; border-radius: var(--radius-sm); margin-bottom: 1.25rem;
            background: var(--bg-warm);
            border-left: 3px solid var(--text-muted);
            font-style: italic;
            color: var(--text-body);
            font-size: 0.9rem;
            line-height: 1.65;
        }
        .drafter-voice-red {
            background: linear-gradient(135deg, rgba(196,75,40,0.06), rgba(196,75,40,0.10));
            border-left: 3px solid var(--red);
        }
        .drafter-voice-yellow {
            background: linear-gradient(135deg, rgba(184,134,11,0.05), rgba(184,134,11,0.09));
            border-left: 3px solid var(--yellow);
        }
        .drafter-voice-green {
            background: linear-gradient(135deg, rgba(45,138,78,0.04), rgba(45,138,78,0.08));
            border-left: 3px solid var(--green);
        }
        .drafter-voice-label {
            display: block; font-family: 'JetBrains Mono', monospace;
            font-size: 0.65rem; font-weight: 500;
            text-transform: uppercase; letter-spacing: 0.12em; margin-bottom: 0.4rem;
            color: var(--ash);
        }
        .drafter-voice-label-red { color: var(--red-text); }
        .drafter-voice-label-yellow { color: var(--yellow-text); }
        .drafter-voice-label-green { color: var(--green-text); }
        .drafter-voice-text {
            font-size: 0.9rem; line-height: 1.65; color: var(--text-body); font-style: italic;
        }

        /* ── Your Move action block ── */
        .your-move {
            padding: 0.8rem 1.1rem; border-radius: var(--radius-sm); margin-bottom: 1.25rem;
            background: linear-gradient(135deg, rgba(45, 138, 78, 0.05), rgba(45, 138, 78, 0.10));
            border-left: 3px solid var(--green);
            font-size: 0.88rem; line-height: 1.6; color: var(--text-primary);
            font-weight: 500;
        }
        .your-move-label {
            display: block; font-family: 'JetBrains Mono', monospace;
            font-size: 0.65rem; font-weight: 700;
            text-transform: uppercase; letter-spacing: 0.12em;
            color: var(--green-text); margin-bottom: 0.3rem;
        }

        /* Green verdict — no hidden intent */
        .green-verdict {
            padding: 1.25rem 1.1rem; border-radius: var(--radius-sm);
            background: linear-gradient(135deg, rgba(45,138,78,0.06), rgba(45,138,78,0.10));
            border: 1px solid var(--green-border); margin-bottom: 1.25rem; text-align: center;
        }
        .green-verdict-title {
            font-size: 0.88rem; font-weight: 700; color: var(--green-text); margin-bottom: 0.25rem;
        }
        .green-verdict-text {
            font-size: 0.84rem; color: var(--text-secondary); line-height: 1.5;
        }

        /* Juxtaposition columns */
        .clause-juxtapose {
            display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 1.25rem;
        }
        @media (max-width: 560px) { .clause-juxtapose { grid-template-columns: 1fr; } }
        .juxtapose-col {
            padding: 0.9rem 1rem; border-radius: var(--radius-sm);
            font-size: 0.84rem; line-height: 1.6;
        }
        .juxtapose-label {
            display: block; font-family: 'JetBrains Mono', monospace;
            font-size: 0.62rem; font-weight: 500;
            text-transform: uppercase; letter-spacing: 0.12em; margin-bottom: 0.4rem;
        }
        .juxtapose-says {
            background: var(--bg-surface); border: 1px solid var(--border-light); color: var(--text-body);
        }
        .juxtapose-says .juxtapose-label { color: var(--text-muted); }
        .juxtapose-read {
            background: var(--accent-light); border: 1px solid var(--accent-medium);
            color: var(--text-primary); font-weight: 500;
        }
        .juxtapose-read .juxtapose-label { color: var(--accent); }

        /* Small print block (card back, full-width) */
        .smallprint-block {
            padding: 0.9rem 1rem; border-radius: var(--radius-sm);
            background: var(--bg-surface); border: 1px solid var(--border-light);
            font-size: 0.84rem; line-height: 1.6; color: var(--text-body);
            margin-bottom: 1rem;
        }

        /* English translation toggle (bilingual cards) */
        .en-translation {
            margin-top: 1rem; border-top: 1px dashed var(--border-light);
            padding-top: 0.5rem;
        }
        .en-translation-toggle {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.65rem; font-weight: 600;
            text-transform: uppercase; letter-spacing: 0.1em;
            color: var(--text-muted); cursor: pointer;
            padding: 0.4rem 0; list-style: none;
            transition: color var(--transition);
        }
        .en-translation-toggle:hover { color: var(--accent); }
        .en-translation-toggle::-webkit-details-marker { display: none; }
        .en-translation-toggle::before {
            content: '▸ '; font-size: 0.7rem;
            transition: transform 0.2s ease;
            display: inline-block;
        }
        .en-translation[open] > .en-translation-toggle::before {
            content: '▾ ';
        }
        .en-juxtapose {
            margin-top: 0.6rem; opacity: 0.85;
        }
        .en-juxtapose .juxtapose-col {
            font-size: 0.78rem;
        }
        .en-juxtapose .juxtapose-label::after {
            content: ' (EN)'; font-weight: 400;
        }

        /* English report summary (bilingual deep analysis) */
        .en-report-summary {
            margin-top: 2rem; border: 1px dashed var(--border);
            border-radius: var(--radius); padding: 0;
            background: var(--bg-surface);
        }
        .en-report-toggle {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.72rem; font-weight: 600;
            text-transform: uppercase; letter-spacing: 0.1em;
            color: var(--text-muted); cursor: pointer;
            padding: 1rem 1.5rem; list-style: none;
            transition: color var(--transition);
        }
        .en-report-toggle:hover { color: var(--accent); }
        .en-report-toggle::-webkit-details-marker { display: none; }
        .en-report-toggle::before {
            content: '▸ '; font-size: 0.75rem;
            display: inline-block;
        }
        .en-report-summary[open] > .en-report-toggle::before {
            content: '▾ ';
        }
        .en-report-toggle::after {
            content: 'EN'; display: inline-block;
            font-size: 0.5rem; font-weight: 700;
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 3px; padding: 0.1rem 0.35rem;
            margin-left: 0.5rem; vertical-align: middle;
        }
        .en-report-content {
            padding: 0 1.5rem 1.5rem;
        }
        .en-report-content h3 {
            font-size: 0.95rem; margin-top: 1.25rem;
        }

        /* Flip-back trigger */
        .flip-back-trigger {
            display: flex; align-items: center; justify-content: center; gap: 0.5rem;
            width: 100%; padding: 0.9rem 2rem; background: none; border: none;
            border-top: 1px solid var(--border-light); cursor: pointer;
            font-family: inherit; font-size: 0.8rem; font-weight: 600;
            color: var(--text-muted); transition: all var(--transition);
            position: relative; overflow: hidden;
        }
        .flip-back-trigger::before {
            content: ''; position: absolute; inset: 0;
            background: var(--bg-surface); opacity: 0; transition: opacity var(--transition);
        }
        .flip-back-trigger:hover::before { opacity: 1; }
        .flip-back-trigger:hover { color: var(--text-secondary); }
        .flip-back-arrow {
            display: inline-block; font-size: 0.9rem;
            transition: transform 0.4s var(--ease-out-expo);
        }
        .flip-back-trigger:hover .flip-back-arrow { transform: translateX(-4px); }

        /* (clause-nav removed — replaced by .card-navigation) */

        /* ── Back score bar ─────────────────────────── */
        .back-score-bar {
            display: flex; align-items: center; gap: 0.75rem;
            padding: 0 0 1.25rem;
        }
        .back-score-bar-track {
            flex: 1; height: 6px; background: var(--border-light);
            border-radius: 3px; overflow: hidden;
        }
        .back-score-bar-fill {
            height: 100%; border-radius: 3px; width: 0;
            transition: width 0.8s var(--ease-out-expo);
        }
        .back-score-bar-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.72rem; font-weight: 600;
            color: var(--text-secondary); white-space: nowrap;
        }

        /* ── Bottom line (risk-tinted summary on card front) ── */
        .bottom-line {
            margin: 0.75rem 0 0;
            padding: 0.5rem 0.75rem;
            font-size: 0.82rem;
            font-weight: 500;
            line-height: 1.4;
            color: var(--text-body);
            border-left: 3px solid var(--border);
            border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
        }
        .bottom-line-red {
            border-left-color: var(--red);
            background: var(--red-bg);
            color: var(--red-text);
        }
        .bottom-line-yellow {
            border-left-color: var(--yellow);
            background: var(--yellow-bg);
            color: var(--yellow-text);
        }
        .bottom-line-green {
            border-left-color: var(--green);
            background: var(--green-bg);
            color: var(--green-text);
        }

        /* ── Verdict link (CTA on card back → deep analysis) ── */
        .verdict-link {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            width: 100%;
            padding: 0.65rem 0.85rem;
            margin-top: 0.25rem;
            background: var(--accent-light);
            border: 1px solid var(--accent-medium);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-family: 'DM Sans', sans-serif;
            transition: all 0.2s var(--ease-out-expo);
        }
        .verdict-link:hover {
            background: var(--accent-medium);
            border-color: var(--accent);
        }
        .verdict-link-label {
            font-size: 0.82rem;
            font-weight: 600;
            color: var(--accent);
        }
        .verdict-link-meta {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-muted);
            flex: 1;
        }
        .verdict-link .flip-trigger-arrow {
            color: var(--accent);
            font-size: 0.9rem;
        }
        .verdict-link.verdict-loading {
            border-color: var(--yellow-border);
            background: var(--yellow-bg);
        }
        .verdict-link.verdict-loading .verdict-link-meta {
            color: var(--yellow-text);
        }

        /* ── Back to cards button ── */
        .back-to-cards-btn {
            display: inline-flex; align-items: center; gap: 0.4rem;
            padding: 0.5rem 1rem; margin-bottom: 1rem;
            background: var(--bg-surface); border: 1px solid var(--border);
            border-radius: var(--radius-sm); cursor: pointer;
            font-family: 'DM Sans', sans-serif; font-size: 0.82rem;
            font-weight: 500; color: var(--text-secondary);
            transition: all 0.2s var(--ease-out-expo);
        }
        .back-to-cards-btn:hover {
            background: var(--bg-warm); color: var(--text-primary);
            border-color: var(--border-focus);
        }

        /* ── Opus branding on deep analysis ── */
        .deep-analysis-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem 0;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }
        .deep-analysis-header .section-label {
            flex: 1;
        }
        .opus-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.25rem 0.6rem;
            background: var(--bg-thinking);
            color: #e8e4dc;
            border-radius: var(--radius-sm);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.62rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }
        .opus-badge::before {
            content: '';
            width: 6px; height: 6px;
            border-radius: 50%;
            background: #c44b28;
            animation: opusPulse 2s ease-in-out infinite;
        }
        @keyframes opusPulse {
            0%, 100% { opacity: 0.4; }
            50% { opacity: 1; }
        }

        /* ── Follow-up question UI ── */
        .followup-section { margin-top: 2.5rem; }
        .followup-input-row { display: flex; gap: 0.5rem; align-items: flex-start; }
        .followup-input {
            flex: 1; padding: 0.7rem 1rem;
            font-family: 'DM Sans', sans-serif; font-size: 0.88rem;
            color: var(--text-primary); background: var(--bg-surface);
            border: 1px solid var(--border); border-radius: var(--radius-md);
            outline: none; resize: none; min-height: 44px; max-height: 120px;
            transition: border-color var(--transition);
        }
        .followup-input:focus { border-color: var(--accent); }
        .followup-input::placeholder { color: var(--text-dim); }
        .followup-send {
            padding: 0.7rem 1.2rem; font-family: 'DM Sans', sans-serif;
            font-size: 0.85rem; font-weight: 600; color: white;
            background: var(--text-primary); border: none;
            border-radius: var(--radius-md); cursor: pointer;
            transition: all var(--transition); white-space: nowrap;
        }
        .followup-send:hover:not(:disabled) { background: var(--accent); }
        .followup-send:disabled { opacity: 0.35; cursor: not-allowed; }
        .followup-answer {
            margin-top: 1.5rem; padding: 1.2rem 1.5rem;
            background: var(--bg-surface); border-radius: var(--radius);
            border: 1px solid var(--border-light);
        }
        .followup-q { font-size: 0.82rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 0.75rem; }
        .followup-a { font-size: 0.9rem; color: var(--text-body); line-height: 1.65; }
        .followup-a p { margin-bottom: 0.6rem; }

        /* Reduced motion */
        @media (prefers-reduced-motion: reduce) {
            .flip-card.woosh-in { animation: none; }
            .flip-card-inner { transition: none; }
            .flip-card.flipped .flip-card-back { position: static; transform: none; }
            .flip-card.flipped .flip-card-front { display: none; }
        }

        /* Section headers (H2 in results) */
        .results-area h2 {
            font-size: 1.1rem; font-weight: 700; color: var(--text-primary);
            margin: 2rem 0 1rem; padding-bottom: 0.4rem;
            border-bottom: 2px solid var(--accent);
        }

        /* ── Error display ───────────────────────────── */
        .error-msg {
            background: var(--red-bg); border: 1px solid var(--red-border);
            border-radius: var(--radius); padding: 1.5rem; text-align: center;
            color: var(--red-text); font-weight: 600;
        }
        .retry-btn {
            margin-top: 0.8rem; padding: 0.5rem 1.5rem; background: var(--accent);
            color: white; border: none; border-radius: var(--radius-sm);
            cursor: pointer; font-family: inherit; font-weight: 600;
        }

        /* ══════════════════════════════════════════════════════
           RESPONSIVE
           ══════════════════════════════════════════════════════ */

        /* Tablet: sidebar stacks above content (handled at 900px above) */

        @media (max-width: 600px) {
            /* Upload screen */
            .brand h1 { font-size: 2.4rem; }
            .upload-card { padding: 1.25rem; }

            /* Layout */
            .analysis-layout { padding: 0 0.5rem; }
            .content-col { padding: 0 0 3rem; }
            .analysis-header { padding: 0.5rem 0.75rem; }

            /* Sidebar profile: stack thumbnail above pills on small screens */
            .sidebar-profile { flex-direction: column; gap: 0.4rem; }
            .doc-thumbnail { width: 100%; height: 80px; }
            .doc-thumbnail img { height: 80px; object-fit: cover; object-position: top center; }
            .metadata-line { gap: 0.2rem; }
            .meta-pill { font-size: 0.6rem; padding: 0.15rem 0.4rem; }
            .meta-pill .meta-pill-label { font-size: 0.4rem; }

            /* Editorial loading / document preview */
            .editorial-loading-text {
                max-height: 30vh; font-size: 0.72rem;
                margin-left: 0.75rem; margin-right: 0.75rem;
                padding-left: 0.75rem;
            }

            /* Flip cards */
            .flip-card { margin-bottom: 1rem; }
            .front-content { padding: 1.25rem 1.25rem 0; }
            .clause-reassurance { font-size: 1.05rem; }
            .flip-card .clause-title { font-size: 1rem; }
            .flip-card .clause-quote { padding: 0.7rem 0.9rem; font-size: 0.78rem; }
            .reader-voice { padding: 0.75rem 0.9rem; }
            .reader-voice-text { font-size: 0.84rem; }
            .flip-trigger { padding: 0.75rem 1.25rem; font-size: 0.78rem; width: calc(100% - 2rem); }

            /* Card back */
            .risk-header { padding: 1rem 1.25rem; flex-direction: column; align-items: flex-start; gap: 0.5rem; }
            .back-body { padding: 1.25rem; }
            .clause-juxtapose { grid-template-columns: 1fr; gap: 0.5rem; }
            .juxtapose-col { padding: 0.7rem 0.85rem; font-size: 0.78rem; }
            .drafter-voice { padding: 0.75rem 0.9rem; font-size: 0.82rem; }
            .bottom-line { padding: 0.7rem 0.9rem; font-size: 0.78rem; }
            .flip-back-trigger { padding: 0.7rem 1.25rem; font-size: 0.75rem; }

            /* Card navigation */
            .card-navigation { gap: 0.75rem; padding: 1rem 0; }
            .card-nav-btn { padding: 0.45rem 0.8rem; font-size: 0.75rem; }
            .card-nav-counter { font-size: 0.7rem; }

            /* Deep analysis cards */
            .clause-card, .cross-clause-card, .playbook-card, .assessment-card {
                padding: 1rem 1.1rem;
            }

            /* Summary */
            .summary-top { flex-direction: column; align-items: center; text-align: center; gap: 1rem; }
            .score-ring { width: 90px; height: 90px; }

            /* Follow-up */
            .followup-input { font-size: 0.85rem; }

            /* Bilingual */
            .en-translation-toggle { font-size: 0.6rem; padding: 0.3rem 0; }
            .en-juxtapose .juxtapose-col { font-size: 0.72rem; }
            .en-report-toggle { font-size: 0.65rem; padding: 0.75rem 1rem; }
            .en-report-content { padding: 0 1rem 1rem; }

            /* Deep analysis header */
            .deep-analysis-header { padding: 0 0.5rem; }

            /* Insight column on mobile */
            .insight-column { width: 100%; margin-top: 0.5rem; }
            .insight-card-inner { padding: 1rem; font-size: 0.84rem; }
            .insight-figure { font-size: 1.15rem; }
            .insight-narrative { font-size: 0.78rem; }
            .insight-example-label { font-size: 0.55rem; }
            .insight-label { font-size: 0.55rem; margin-bottom: 0.5rem; }
        }

        /* Very small screens (iPhone SE, etc.) */
        @media (max-width: 380px) {
            .brand h1 { font-size: 2rem; }
            .front-content { padding: 1rem 1rem 0; }
            .risk-header { padding: 0.75rem 1rem; }
            .card-navigation { gap: 0.5rem; flex-wrap: wrap; justify-content: center; }
            .card-nav-btn { padding: 0.4rem 0.6rem; font-size: 0.7rem; }
            .clause-reassurance { font-size: 0.95rem; }
        }
    </style>
</head>
<body>

<!-- ═══════════════════════════════════════════════════════
     SCREEN 1: UPLOAD
     ═══════════════════════════════════════════════════════ -->
<section id="upload-screen">
    <div class="upload-container">
        <div class="brand fade-up">
            <h1>FlipSide</h1>
            <div class="tagline">The dark side of small print</div>
        </div>

        <div class="upload-card fade-up fade-up-d1">
            <!-- Single document upload -->
            <div id="singleUpload">
                <div class="drop-zone" id="dropZone">
                    <input type="file" id="fileInput" accept=".pdf,.docx,.txt,.text,.md" class="sr-only">
                    <div id="uploadPrompt">
                        <span class="icon" aria-hidden="true">&#128196;</span>
                        <div class="dz-title">Drop a document here</div>
                        <div class="hint">or click to browse</div>
                        <div class="filetypes">PDF &middot; DOCX &middot; TXT</div>
                    </div>
                    <div id="fileInfo" class="file-selected hidden">
                        <span class="file-name" id="fileName"></span>
                        <span class="file-size" id="fileSize"></span>
                        <a class="file-remove" id="fileRemove">remove</a>
                    </div>
                </div>
                <textarea id="pasteArea" class="paste-area hidden" placeholder="Paste contract text here..."></textarea>
            </div>

            <!-- Compare mode (two documents) -->
            <div id="compareUpload" class="hidden">
                <div class="compare-row">
                    <div class="compare-col">
                        <div class="drop-zone compare-drop" id="dropZone1">
                            <input type="file" id="fileInput1" accept=".pdf,.docx,.txt,.text,.md" class="sr-only">
                            <div id="uploadPrompt1">
                                <span class="icon" aria-hidden="true">&#65313;</span>
                                <div class="dz-title">Document A</div>
                                <div class="hint">drop or click</div>
                            </div>
                            <div id="fileInfo1" class="file-selected hidden">
                                <span class="file-name" id="fileName1"></span>
                                <a class="file-remove" id="fileRemove1">remove</a>
                            </div>
                        </div>
                        <textarea id="pasteArea1" class="paste-area hidden" placeholder="Paste Document A text..." style="min-height:80px;margin-top:0.5rem"></textarea>
                    </div>
                    <div class="compare-col">
                        <div class="drop-zone compare-drop" id="dropZone2">
                            <input type="file" id="fileInput2" accept=".pdf,.docx,.txt,.text,.md" class="sr-only">
                            <div id="uploadPrompt2">
                                <span class="icon" aria-hidden="true">&#65314;</span>
                                <div class="dz-title">Document B</div>
                                <div class="hint">drop or click</div>
                            </div>
                            <div id="fileInfo2" class="file-selected hidden">
                                <span class="file-name" id="fileName2"></span>
                                <a class="file-remove" id="fileRemove2">remove</a>
                            </div>
                        </div>
                        <textarea id="pasteArea2" class="paste-area hidden" placeholder="Paste Document B text..." style="min-height:80px;margin-top:0.5rem"></textarea>
                    </div>
                </div>
            </div>

            <div class="depth-selector" id="depthSelector">
                <button class="depth-btn" data-depth="quick">Quick</button>
                <button class="depth-btn active" data-depth="standard">Standard</button>
                <button class="depth-btn" data-depth="deep">Deep</button>
            </div>

            <button class="analyze-btn" id="analyzeBtn" disabled>Show me the other side</button>
            <div id="uploadError" class="upload-error hidden"></div>
        </div>

        <div class="upload-links fade-up fade-up-d2">
            <a id="pasteToggle">Paste text instead</a>
            <a id="compareToggle">Compare two documents</a>
            <a id="sampleBtn">Try sample lease</a>
        </div>

        <div class="disclaimer fade-up fade-up-d3">
            AI analysis — not legal advice. Always consult an attorney for important decisions.
        </div>
    </div>
</section>

<!-- ═══════════════════════════════════════════════════════
     SCREEN 2/3: ANALYSIS
     ═══════════════════════════════════════════════════════ -->
<section id="analysis-screen" class="hidden">
    <header class="analysis-header">
        <div class="header-left">
            <span class="header-brand" id="headerBrand">FlipSide</span>
            <div class="status-pill" id="statusPill">
                <span class="status-dot"></span>
                <span id="statusText">Starting analysis...</span>
                <span class="elapsed-time" id="elapsedTime"></span>
            </div>
        </div>
        <div class="header-right">
            <button class="header-btn hidden" id="copyAllBtn">Copy all</button>
            <button class="header-btn hidden" id="exportBtn">Export</button>
            <button class="header-btn" id="darkModeBtn" title="Toggle dark mode">&#9790;</button>
            <button class="header-btn" id="backBtn">Back</button>
        </div>
    </header>

    <div class="analysis-layout">
    <!-- Left sidebar: document profile + preview (stays on screen) -->
    <aside class="analysis-sidebar hidden" id="analysisSidebar">
        <div class="sidebar-profile" id="sidebarProfile">
            <div class="doc-thumbnail hidden" id="docThumbnail">
                <img id="docThumbnailImg" alt="Document page 1">
            </div>
            <div class="metadata-line hidden" id="metadataLine"></div>
        </div>
        <div class="editorial-loading hidden" id="editorialLoading">
            <div class="editorial-loading-label">What the small print says</div>
            <div class="editorial-loading-text" id="editorialLoadingText"></div>
            <div class="editorial-loading-indicator">
                <span class="pulsing-dots"><span></span><span></span><span></span></span>
                <span class="editorial-loading-status" id="editorialLoadingStatus">FlipSide is reading between the lines...</span>
            </div>
        </div>
    </aside>

    <!-- Main content: cards + analysis -->
    <div class="content-col">
        <!-- Thinking panel (starts collapsed as status line) -->
        <div class="thinking-panel hidden" id="thinkingPanel">
            <div class="thinking-header" id="thinkingHeader">
                <div class="thinking-label" id="thinkingLabel">
                    <span class="phase-icon">&#9679;</span>
                    Quick Scan: Reasoning...
                </div>
                <button class="thinking-toggle" id="thinkingToggle">Show reasoning</button>
                <button class="thinking-toggle hidden" id="reportToggle" style="margin-left:0.5rem">Show the full report</button>
            </div>
            <div class="thinking-text" id="thinkingText"></div>
        </div>

        <!-- Card viewport: one card at a time -->
        <div class="card-viewport hidden" id="cardViewport">
            <div id="flipCardContainer"></div>
            <nav class="card-navigation hidden" id="cardNavigation">
                <button class="card-nav-btn card-nav-prev" disabled>
                    <span>&larr;</span> <span>Previous</span>
                </button>
                <span class="card-nav-counter">Clause <strong>1</strong> of <strong>1</strong></span>
                <button class="card-nav-btn card-nav-next">
                    <span class="card-nav-next-label">Next clause &rarr;</span>
                </button>
            </nav>
        </div>

        <!-- Results: summary + deep analysis (compare mode uses resultsContent) -->
        <div class="results-area hidden" id="resultsArea">
            <div id="resultsContent"></div>
            <div id="deepAnalysisSection" class="hidden">
                <button class="back-to-cards-btn" id="backToCardsBtn">&larr; Back to clauses</button>
                <div id="summaryContainer"></div>
                <div id="filterChips" class="filter-chips hidden"></div>
                <div id="deepAnalysisContent"></div>
                <div class="followup-section hidden" id="followupSection">
                    <hr class="editorial-divider">
                    <div class="section-label" style="margin-bottom:1rem">Ask about this document</div>
                    <div class="followup-input-row">
                        <textarea class="followup-input" id="followupInput" placeholder="What happens if I'm 3 days late on rent?" rows="1"></textarea>
                        <button class="followup-send" id="followupSend">Ask</button>
                    </div>
                    <div id="followupAnswers"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Right column: "What you should read" (animated on flip) -->
    <aside class="insight-column hidden" id="insightColumn">
        <div class="insight-label">Your reality check</div>
        <div class="insight-card hidden" id="insightCard">
            <div class="insight-card-inner" id="insightCardInner"></div>
        </div>
    </aside>
    </div><!-- /analysis-layout -->
</section>

<script>
// ═══════════════════════════════════════════════════════════════
// FlipSide Frontend — Thinking is the product
// ═══════════════════════════════════════════════════════════════

(function () {
    'use strict';

    // ── Constants ──────────────────────────────────────────────
    var TRICK_MAP = {
        'Silent Waiver': '\uD83E\uDD10', 'Burden Shift': '\u2696\uFE0F',
        'Time Trap': '\u23F0', 'Escape Hatch': '\uD83D\uDEAA',
        'Moving Target': '\uD83C\uDFAF', 'Forced Arena': '\uD83C\uDFDB\uFE0F',
        'Phantom Protection': '\uD83D\uDC7B', 'Cascade Clause': '\uD83D\uDCA5',
        'Sole Discretion': '\uD83D\uDC51', 'Liability Cap': '\uD83D\uDEE1\uFE0F',
        'Reverse Shield': '\uD83D\uDCB8', 'Auto-Lock': '\uD83D\uDD12',
        'Content Grab': '\uD83D\uDD8A\uFE0F', 'Data Drain': '\uD83D\uDC41\uFE0F',
        'Penalty Disguise': '\uD83C\uDFAD', 'Gag Clause': '\uD83D\uDD07',
        'Scope Creep': '\uD83D\uDD78\uFE0F', 'Ghost Standard': '\uD83D\uDCC4'
    };

    var TRICK_DESCRIPTIONS = {
        'Silent Waiver': 'Quietly surrenders your legal rights',
        'Burden Shift': 'Moves proof/action duty onto you',
        'Time Trap': 'Tight deadlines that forfeit your rights',
        'Escape Hatch': 'Drafter can exit, you cannot',
        'Moving Target': 'Terms can change after you agree',
        'Forced Arena': 'Disputes in drafter\'s chosen forum',
        'Phantom Protection': 'Broad coverage eaten by exceptions',
        'Cascade Clause': 'One trigger activates multiple penalties',
        'Sole Discretion': 'Drafter decides everything, no appeal',
        'Liability Cap': 'Limits payout regardless of harm',
        'Reverse Shield': 'You cover their costs, not vice versa',
        'Auto-Lock': 'Auto-renewal with hard cancellation',
        'Content Grab': 'Claims rights over your content/work',
        'Data Drain': 'Expansive hidden data permissions',
        'Penalty Disguise': 'Punitive charges disguised as fees',
        'Gag Clause': 'Prohibits negative reviews or discussion',
        'Scope Creep': 'Vague terms stretch beyond expectations',
        'Ghost Standard': 'References external docs not included'
    };

    var STATUS_MESSAGES = {
        thinking: [
            "Adopting the drafter's perspective...",
            "Reading between the lines...",
            "Tracing cross-references...",
            "Mapping strategic architecture...",
            "Identifying asymmetric language..."
        ],
        clauses: [
            "Analyzing clause by clause...",
            "Flagging strategic language...",
            "Scoring risk levels..."
        ],
        deep: [
            "Analyzing cross-clause interactions...",
            "Revealing the drafter's playbook...",
            "Measuring power imbalance..."
        ]
    };

    var thinkingKeywords = /\b(asymmetric|one-sided|hidden|buried|disguised|waiver|penalty|forfeit|exclusion|loophole|unilateral|discretion|cascade|strategic|deliberately|advantage|obligation|burden|ambiguous|vague|trap|lock-in|irreversible)\b/gi;

    // ── Base URL (supports reverse proxy prefix like /flipside) ──
    var BASE_URL = {{ request.script_root | tojson }};

    // ── State ─────────────────────────────────────────────────
    var selectedFile = null;
    var compareFile1 = null, compareFile2 = null;
    var analysisDepth = 'standard';
    var isCompareMode = false;
    var eventSource = null;
    var thinkingContent = '';
    var responseContent = '';
    var renderTimeout = null;
    var thinkingPhaseCount = 0;
    var quickDone = false;
    var opusReasoningDone = false;
    var analysisStartTime = 0;
    var elapsedInterval = null;
    var statusRotateInterval = null;
    var currentStatusIdx = 0;
    var isDoneRendering = false;
    var deepTextComplete = false;  // Set when deep analysis text block finishes (text_done)
    var animatedCardTitles = new Set();
    var activeFilters = new Set(); // 'red', 'yellow', 'green'
    var toolResults = [];
    var documentFullText = '';
    var documentThumbnail = null;
    var currentDocId = '';
    var userHasScrolled = false;
    var lastAutoScrollY = 0;
    var flipCardsBuilt = false;
    var quickDoneContentLength = 0;
    var parsedClauseCount = 0;   // How many --- segments we've already parsed
    var currentCardIndex = 0;    // Which card is currently shown
    var cardViewTransitioned = false; // Whether we've transitioned from loading to cards
    var editorialStatusInterval = null;
    var editorialStatusIdx = 0;

    // ── Elements ──────────────────────────────────────────────
    var $ = function(id) { return document.getElementById(id); };

    // Screens
    var uploadScreen   = $('upload-screen');
    var analysisScreen = $('analysis-screen');

    // Upload elements
    var dropZone       = $('dropZone');
    var fileInput      = $('fileInput');
    var uploadPrompt   = $('uploadPrompt');
    var fileInfo       = $('fileInfo');
    var fileNameEl     = $('fileName');
    var fileSizeEl     = $('fileSize');
    var fileRemove     = $('fileRemove');
    var pasteArea      = $('pasteArea');
    var pasteToggle    = $('pasteToggle');
    var analyzeBtn     = $('analyzeBtn');
    var uploadError    = $('uploadError');
    var sampleBtn      = $('sampleBtn');
    var compareToggle  = $('compareToggle');
    var depthSelector  = $('depthSelector');

    // Analysis elements
    var statusPill     = $('statusPill');
    var statusText     = $('statusText');
    var elapsedEl      = $('elapsedTime');
    var backBtn        = $('backBtn');
    var metadataLine   = $('metadataLine');
    var editorialLoading = $('editorialLoading');
    var thinkingPanel  = $('thinkingPanel');
    var thinkingLabel  = $('thinkingLabel');
    var thinkingText   = $('thinkingText');
    var thinkingToggle = $('thinkingToggle');
    var resultsArea    = $('resultsArea');
    var summaryContainer = $('summaryContainer');
    var filterChips    = $('filterChips');
    var resultsContent = $('resultsContent');
    var flipCardContainer = $('flipCardContainer');
    var deepAnalysisEl = $('deepAnalysisContent');
    var followupSection = $('followupSection');
    var followupInput = $('followupInput');
    var followupSend = $('followupSend');
    var followupAnswers = $('followupAnswers');

    // Configure marked
    marked.setOptions({ breaks: true, gfm: true });

    // ── Event delegation for flip cards + card navigation ──
    document.querySelector('.content-col').addEventListener('click', function(e) {
        var flipTrigger = e.target.closest('.flip-trigger');
        if (flipTrigger) {
            var card = flipTrigger.closest('.flip-card');
            if (card) {
                card.classList.add('flipped');
                // Animate score bar fill on flip
                var fill = card.querySelector('.back-score-bar-fill');
                if (fill && !fill.style.width) {
                    var w = fill.getAttribute('data-width');
                    setTimeout(function() { fill.style.width = w + '%'; }, 300);
                }
                showInsightForCard(card);
            }
            return;
        }
        var flipBack = e.target.closest('.flip-back-trigger');
        if (flipBack) {
            var card = flipBack.closest('.flip-card');
            if (card) card.classList.remove('flipped');
            hideInsightColumn();
            return;
        }
        var findInDoc = e.target.closest('.find-in-doc');
        if (findInDoc) {
            var cardIdx = parseInt(findInDoc.getAttribute('data-card-index'));
            if (!isNaN(cardIdx)) {
                scrollPreviewToCard(cardIdx);
                // On mobile (sidebar stacked above), scroll page to the preview
                var previewEl = $('editorialLoadingText');
                if (previewEl && window.innerWidth <= 900) {
                    previewEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
            return;
        }
        var navPrev = e.target.closest('.card-nav-prev');
        if (navPrev && !navPrev.disabled) {
            showCardAtIndex(currentCardIndex - 1);
            return;
        }
        var navNext = e.target.closest('.card-nav-next');
        if (navNext && !navNext.disabled) {
            if (navNext.getAttribute('data-action') === 'assessment') {
                revealDeepAnalysis();
            } else {
                showCardAtIndex(currentCardIndex + 1);
            }
            return;
        }
        // verdict-link buttons removed — verdict now triggered via card navigation only
    });

    // ── Click clause marker in preview → navigate to that card ──
    $('editorialLoadingText').addEventListener('click', function(e) {
        var highlight = e.target.closest('.doc-highlight');
        if (highlight) {
            var idx = parseInt(highlight.getAttribute('data-card-index'));
            if (!isNaN(idx) && flipCardContainer.querySelectorAll('.flip-card').length > idx) {
                showCardAtIndex(idx);
            }
        }
    });

    // ── Keyboard navigation ──
    document.addEventListener('keydown', function(e) {
        if (analysisScreen.classList.contains('hidden')) return;
        var viewport = $('cardViewport');
        if (!viewport || viewport.classList.contains('hidden')) return;
        var cards = flipCardContainer.querySelectorAll('.flip-card');
        if (cards.length === 0) return;

        switch(e.key) {
            case 'ArrowLeft':
                if (currentCardIndex > 0) {
                    e.preventDefault();
                    showCardAtIndex(currentCardIndex - 1);
                }
                break;
            case 'ArrowRight':
                if (currentCardIndex < cards.length - 1) {
                    e.preventDefault();
                    showCardAtIndex(currentCardIndex + 1);
                }
                break;
            case ' ':
            case 'Enter':
                e.preventDefault();
                if (cards[currentCardIndex]) {
                    cards[currentCardIndex].classList.toggle('flipped');
                    if (cards[currentCardIndex].classList.contains('flipped')) {
                        // Animate score bar on flip
                        var fill = cards[currentCardIndex].querySelector('.back-score-bar-fill');
                        if (fill && !fill.style.width) {
                            var w = fill.getAttribute('data-width');
                            setTimeout(function() { fill.style.width = w + '%'; }, 300);
                        }
                        showInsightForCard(cards[currentCardIndex]);
                    } else {
                        hideInsightColumn();
                    }
                }
                break;
            default:
                // Number keys 1-9 → jump to that card
                var num = parseInt(e.key);
                if (num >= 1 && num <= 9 && num <= cards.length) {
                    e.preventDefault();
                    showCardAtIndex(num - 1);
                }
                break;
        }
    });

    // ── Helpers ───────────────────────────────────────────────
    function formatSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    function escapeHtml(str) {
        var div = document.createElement('div');
        div.appendChild(document.createTextNode(str));
        return div.innerHTML;
    }

    function showError(msg) {
        uploadError.textContent = msg;
        uploadError.classList.remove('hidden');
        setTimeout(function() { uploadError.classList.add('hidden'); }, 8000);
    }

    function updateAnalyzeBtn() {
        if (isCompareMode) {
            var hasA = compareFile1 !== null || $('pasteArea1').value.trim().length > 0;
            var hasB = compareFile2 !== null || $('pasteArea2').value.trim().length > 0;
            analyzeBtn.disabled = !(hasA && hasB);
        } else {
            var hasFile = selectedFile !== null;
            var hasText = pasteArea.value.trim().length > 0;
            analyzeBtn.disabled = !(hasFile || hasText);
        }
    }

    // ── Drag-and-drop (single) ────────────────────────────────
    dropZone.addEventListener('click', function() { fileInput.click(); });
    dropZone.addEventListener('dragover', function(e) { e.preventDefault(); dropZone.classList.add('dragover'); });
    dropZone.addEventListener('dragleave', function() { dropZone.classList.remove('dragover'); });
    dropZone.addEventListener('drop', function(e) {
        e.preventDefault(); dropZone.classList.remove('dragover');
        if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
    });
    fileInput.addEventListener('change', function() {
        if (fileInput.files.length) handleFile(fileInput.files[0]);
    });

    function handleFile(file) {
        var ext = file.name.split('.').pop().toLowerCase();
        if (['pdf', 'docx', 'txt', 'text', 'md'].indexOf(ext) === -1) {
            showError('Unsupported file type. Please use PDF, DOCX, or TXT.');
            return;
        }
        selectedFile = file;
        fileNameEl.textContent = file.name;
        fileSizeEl.textContent = formatSize(file.size);
        uploadPrompt.classList.add('hidden');
        fileInfo.classList.remove('hidden');
        pasteArea.classList.add('hidden');
        pasteArea.value = '';
        updateAnalyzeBtn();
    }

    fileRemove.addEventListener('click', function(e) {
        e.preventDefault(); e.stopPropagation();
        selectedFile = null; fileInput.value = '';
        fileInfo.classList.add('hidden');
        uploadPrompt.classList.remove('hidden');
        updateAnalyzeBtn();
    });

    // ── Paste text toggle ─────────────────────────────────────
    pasteToggle.addEventListener('click', function(e) {
        e.preventDefault();
        if (isCompareMode) return;
        var isHidden = pasteArea.classList.contains('hidden');
        if (isHidden) {
            pasteArea.classList.remove('hidden');
            pasteArea.focus();
            pasteToggle.textContent = 'Upload file instead';
            // Clear file if selected
            if (selectedFile) { selectedFile = null; fileInput.value = ''; fileInfo.classList.add('hidden'); uploadPrompt.classList.remove('hidden'); }
        } else {
            pasteArea.classList.add('hidden');
            pasteArea.value = '';
            pasteToggle.textContent = 'Paste text instead';
        }
        updateAnalyzeBtn();
    });
    pasteArea.addEventListener('input', updateAnalyzeBtn);

    // ── Compare mode toggle ───────────────────────────────────
    compareToggle.addEventListener('click', function(e) {
        e.preventDefault();
        isCompareMode = !isCompareMode;
        $('singleUpload').classList.toggle('hidden', isCompareMode);
        $('compareUpload').classList.toggle('hidden', !isCompareMode);
        compareToggle.textContent = isCompareMode ? 'Single document analysis' : 'Compare two documents';
        analyzeBtn.textContent = isCompareMode ? 'Compare documents' : 'Show me the other side';
        // Reset state
        selectedFile = null; compareFile1 = null; compareFile2 = null;
        updateAnalyzeBtn();
    });

    // ── Compare drop zones ────────────────────────────────────
    function setupCompareZone(num) {
        var dz = $('dropZone' + num);
        var fi = $('fileInput' + num);
        var prompt = $('uploadPrompt' + num);
        var info = $('fileInfo' + num);
        var name = $('fileName' + num);
        var remove = $('fileRemove' + num);
        var paste = $('pasteArea' + num);

        dz.addEventListener('click', function() { fi.click(); });
        dz.addEventListener('dragover', function(e) { e.preventDefault(); dz.classList.add('dragover'); });
        dz.addEventListener('dragleave', function() { dz.classList.remove('dragover'); });
        dz.addEventListener('drop', function(e) {
            e.preventDefault(); dz.classList.remove('dragover');
            if (e.dataTransfer.files.length) setCompareFile(num, e.dataTransfer.files[0]);
        });
        fi.addEventListener('change', function() {
            if (fi.files.length) setCompareFile(num, fi.files[0]);
        });
        remove.addEventListener('click', function(e) {
            e.preventDefault(); e.stopPropagation();
            if (num === 1) compareFile1 = null; else compareFile2 = null;
            fi.value = '';
            info.classList.add('hidden'); prompt.classList.remove('hidden');
            updateAnalyzeBtn();
        });
        paste.addEventListener('input', updateAnalyzeBtn);

        function setCompareFile(n, file) {
            if (n === 1) compareFile1 = file; else compareFile2 = file;
            name.textContent = file.name;
            prompt.classList.add('hidden'); info.classList.remove('hidden');
            paste.classList.add('hidden'); paste.value = '';
            updateAnalyzeBtn();
        }
    }
    setupCompareZone(1);
    setupCompareZone(2);

    // ── Depth selector ────────────────────────────────────────
    depthSelector.addEventListener('click', function(e) {
        var btn = e.target.closest('.depth-btn');
        if (!btn) return;
        depthSelector.querySelectorAll('.depth-btn').forEach(function(b) { b.classList.remove('active'); });
        btn.classList.add('active');
        analysisDepth = btn.getAttribute('data-depth');
    });

    // ── Sample document ───────────────────────────────────────
    sampleBtn.addEventListener('click', function(e) {
        e.preventDefault();
        startSampleAnalysis();
    });

    function startSampleAnalysis() {
        analyzeBtn.disabled = true;
        analyzeBtn.textContent = 'Loading...';

        fetch(BASE_URL + '/sample', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ depth: analysisDepth })
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.error) { showError(data.error); analyzeBtn.disabled = false; analyzeBtn.textContent = 'Show me the other side'; return; }
            documentFullText = data.full_text || '';
            documentThumbnail = data.thumbnail || null;
            switchToAnalysis(data.doc_id, data.filename);
        })
        .catch(function(err) {
            showError('Failed to load sample: ' + err.message);
            analyzeBtn.disabled = false;
            analyzeBtn.textContent = 'Show me the other side';
        });
    }

    // ── Upload & analyze ──────────────────────────────────────
    analyzeBtn.addEventListener('click', function() {
        if (isCompareMode) {
            startCompareAnalysis();
        } else {
            startAnalysis();
        }
    });

    function startAnalysis() {
        var formData = new FormData();
        if (selectedFile) {
            formData.append('file', selectedFile);
        } else if (pasteArea.value.trim()) {
            formData.append('text', pasteArea.value.trim());
        } else {
            showError('Please select a file or paste text.');
            return;
        }
        formData.append('depth', analysisDepth);

        analyzeBtn.disabled = true;
        analyzeBtn.textContent = 'Uploading...';

        fetch(BASE_URL + '/upload', { method: 'POST', body: formData })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.error) { showError(data.error); analyzeBtn.disabled = false; analyzeBtn.textContent = 'Show me the other side'; return; }
                documentFullText = data.full_text || '';
                documentThumbnail = data.thumbnail || null;
                switchToAnalysis(data.doc_id, data.filename);
            })
            .catch(function(err) {
                showError('Upload failed: ' + err.message);
                analyzeBtn.disabled = false;
                analyzeBtn.textContent = 'Show me the other side';
            });
    }

    function startCompareAnalysis() {
        var formData = new FormData();
        if (compareFile1) formData.append('file1', compareFile1);
        else formData.append('text1', $('pasteArea1').value.trim());
        if (compareFile2) formData.append('file2', compareFile2);
        else formData.append('text2', $('pasteArea2').value.trim());
        formData.append('depth', analysisDepth);

        analyzeBtn.disabled = true;
        analyzeBtn.textContent = 'Uploading...';

        fetch(BASE_URL + '/compare', { method: 'POST', body: formData })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.error) { showError(data.error); analyzeBtn.disabled = false; analyzeBtn.textContent = 'Compare documents'; return; }
                documentFullText = data.full_text || '';
                switchToAnalysis(data.doc_id, data.filename);
            })
            .catch(function(err) {
                showError('Upload failed: ' + err.message);
                analyzeBtn.disabled = false;
                analyzeBtn.textContent = 'Compare documents';
            });
    }

    // ── Switch to analysis screen ─────────────────────────────
    function switchToAnalysis(docId, filename) {
        // Reset state
        thinkingContent = '';
        responseContent = '';
        thinkingPhaseCount = 0;
        quickDone = false;
        opusReasoningDone = false;
        $('reportToggle').classList.add('hidden');
        isDoneRendering = false;
        deepTextComplete = false;
        animatedCardTitles = new Set();
        activeFilters = new Set();
        flipCardsBuilt = false;
        quickDoneContentLength = 0;
        parsedClauseCount = 0;
        currentCardIndex = 0;
        cardViewTransitioned = false;
        clauseHighlightData = [];
        userHasScrolled = false;
        lastAutoScrollY = 0;
        currentDocId = docId;

        // Reset UI
        thinkingText.innerHTML = '';
        resultsContent.innerHTML = '';
        flipCardContainer.innerHTML = '';
        deepAnalysisEl.innerHTML = '';
        // Remove the deep analysis header (sibling) if it exists
        var oldHeader = deepAnalysisEl.previousElementSibling;
        if (oldHeader && oldHeader.classList.contains('deep-analysis-header')) {
            oldHeader.remove();
        }
        summaryContainer.innerHTML = '';
        filterChips.innerHTML = '';
        filterChips.classList.add('hidden');
        followupSection.classList.add('hidden');
        followupAnswers.innerHTML = '';
        followupInput.value = '';
        toolResults = [];
        $('deepAnalysisSection').classList.add('hidden');
        metadataLine.classList.add('hidden');
        metadataLine.classList.remove('visible');
        metadataLine.innerHTML = '';
        statusPill.classList.remove('done');
        statusText.textContent = 'Starting analysis...';
        thinkingPanel.classList.add('hidden');
        thinkingPanel.classList.remove('collapsed');
        resultsArea.classList.add('hidden');
        $('cardViewport').classList.add('hidden');
        $('cardNavigation').classList.add('hidden');
        $('insightColumn').classList.add('hidden');
        hideInsightColumn();
        $('copyAllBtn').classList.add('hidden');
        $('exportBtn').classList.add('hidden');
        backBtn.classList.remove('hidden');

        // Sidebar: show thumbnail + document preview + metadata area
        var sidebar = $('analysisSidebar');
        var thumbEl = $('docThumbnail');
        var thumbImg = $('docThumbnailImg');
        if (documentFullText && !isCompareMode) {
            sidebar.classList.remove('hidden');
            // Thumbnail
            if (documentThumbnail) {
                thumbImg.src = 'data:image/jpeg;base64,' + documentThumbnail;
                thumbEl.classList.remove('hidden');
            } else {
                thumbEl.classList.add('hidden');
            }
            // Text preview
            var loadingEl = $('editorialLoading');
            var loadingText = $('editorialLoadingText');
            loadingText.innerHTML = escapeHtml(documentFullText);
            loadingEl.classList.remove('hidden');
            loadingEl.style.opacity = '1';
            loadingEl.style.transform = '';
            startEditorialStatusRotation();
        } else {
            sidebar.classList.add('hidden');
            thumbEl.classList.add('hidden');
            $('editorialLoading').classList.add('hidden');
        }

        // Switch screens
        uploadScreen.classList.add('hidden');
        analysisScreen.classList.remove('hidden');

        // Start elapsed timer
        analysisStartTime = Date.now();
        if (elapsedInterval) clearInterval(elapsedInterval);
        elapsedInterval = setInterval(function() {
            var secs = Math.floor((Date.now() - analysisStartTime) / 1000);
            var min = Math.floor(secs / 60);
            var sec = secs % 60;
            elapsedEl.textContent = (min > 0 ? min + 'm ' : '') + sec + 's';
        }, 1000);

        window.scrollTo({ top: 0 });
        connectStream(docId);
    }

    // ── SSE streaming ─────────────────────────────────────────
    function connectStream(docId) {
        eventSource = new EventSource(BASE_URL + '/analyze/' + docId);

        eventSource.onmessage = function(e) {
            var msg;
            try { msg = JSON.parse(e.data); } catch(err) { return; }

            switch (msg.type) {
                case 'phase':
                    handlePhase(msg.content);
                    break;

                case 'thinking_start':
                    thinkingPhaseCount++;
                    thinkingPanel.classList.remove('hidden');

                    if (quickDone) {
                        // Opus deep analysis — collapsed status bar, user can expand to watch reasoning
                        thinkingPanel.classList.add('collapsed');
                        thinkingToggle.textContent = 'Show reasoning';
                        thinkingLabel.innerHTML = '<span class="phase-icon">&#9679;</span> Opus 4.6: Deep reasoning...';
                        thinkingText.innerHTML += '<span class="phase-sep">Opus 4.6 Extended Thinking</span>';
                        startStatusRotation('deep');
                    } else {
                        // Quick scan (Haiku) — collapsed status line
                        thinkingPanel.classList.add('collapsed');
                        thinkingToggle.textContent = 'Show reasoning';
                        thinkingLabel.innerHTML = '<span class="phase-icon">&#9679;</span> Quick Scan: Reasoning...';
                        startStatusRotation('thinking');
                    }
                    break;

                case 'thinking':
                    thinkingContent += msg.content;
                    renderThinking();
                    break;

                case 'thinking_done':
                    removeCursor();
                    if (quickDone) {
                        // Opus done thinking — text still streaming, don't show report button yet
                        opusReasoningDone = true;
                        thinkingLabel.innerHTML = '<span class="phase-icon">&#9679;</span> Opus 4.6: Writing report...';
                        thinkingPanel.classList.add('collapsed');
                        thinkingToggle.textContent = 'Show reasoning';
                    } else {
                        thinkingLabel.innerHTML = '<span class="phase-icon">&#10003;</span> Quick Scan complete';
                        thinkingPanel.classList.add('collapsed');
                        thinkingToggle.textContent = 'Show reasoning';
                    }
                    break;

                case 'text_start':
                    resultsArea.classList.remove('hidden');
                    // Don't hide editorial loading — card transition handles it
                    break;

                case 'text':
                    if (resultsArea.classList.contains('hidden')) {
                        resultsArea.classList.remove('hidden');
                    }
                    responseContent += msg.content;
                    renderResults();
                    break;

                case 'text_done':
                    renderResultsFinal();
                    // If Opus reasoning was done and quick scan was done,
                    // this text_done is from the deep analysis — report is ready
                    if (opusReasoningDone && quickDone) {
                        deepTextComplete = true;
                        thinkingLabel.innerHTML = '<span class="phase-icon">&#10003;</span> Opus 4.6: Reasoning complete';
                        $('reportToggle').classList.remove('hidden');
                        // Update card nav in case user is on last card
                        if (flipCardsBuilt) updateCardNavigation();
                    }
                    break;

                case 'tool_start':
                    // Opus is calling a structured tool
                    var toolInfo = {};
                    try { toolInfo = JSON.parse(msg.content); } catch(e) {}
                    if (toolInfo.name === 'flag_interaction') statusText.textContent = 'Flagging cross-clause interaction...';
                    break;

                case 'tool_result':
                    // Structured data from Opus tool call
                    var toolData = {};
                    try { toolData = JSON.parse(msg.content); } catch(e) {}
                    toolResults.push(toolData);
                    break;

                case 'quick_done':
                    quickDone = true;
                    quickDoneContentLength = responseContent.length;
                    // Parse quick_done timing
                    var qdData = {};
                    try { qdData = JSON.parse(msg.content); } catch(e) {}
                    var qdSec = qdData.seconds ? qdData.seconds.toFixed(1) + 's' : '';
                    statusText.textContent = 'Cards ready' + (qdSec ? ' (' + qdSec + ')' : '') + ' \u2014 Deep analysis starting...';
                    startStatusRotation('deep');
                    stopEditorialStatusRotation();
                    // Final clause sweep — last clause may lack trailing ---
                    if (!isCompareMode) {
                        finalClauseSweep();
                    }
                    break;

                case 'done':
                    isDoneRendering = true;
                    statusPill.classList.add('done');
                    if (elapsedInterval) { clearInterval(elapsedInterval); elapsedInterval = null; }
                    stopStatusRotation();
                    stopEditorialStatusRotation();
                    removeCursor();

                    // Parse timing data from SSE
                    var doneData = {};
                    try { doneData = JSON.parse(msg.content); } catch(e) {}
                    var quickSec = doneData.quick_seconds ? doneData.quick_seconds.toFixed(1) : null;
                    var deepSec = doneData.deep_seconds ? doneData.deep_seconds.toFixed(1) : null;
                    var timingStr = 'Analysis complete';
                    if (quickSec && deepSec) {
                        timingStr = 'Complete \u2014 Cards: ' + quickSec + 's \u00B7 Deep: ' + deepSec + 's';
                    }
                    statusText.textContent = timingStr;

                    // Update sidebar status
                    var sidebarStatus = $('editorialLoadingStatus');
                    if (sidebarStatus) sidebarStatus.textContent = 'Analysis complete';
                    var dots = $('editorialLoading') && $('editorialLoading').querySelector('.pulsing-dots');
                    if (dots) dots.style.display = 'none';

                    // Show action buttons
                    $('copyAllBtn').classList.remove('hidden');
                    $('exportBtn').classList.remove('hidden');

                    // Final render — for compare mode, render now
                    // For card mode, deep analysis renders on-demand via revealDeepAnalysis()
                    if (isCompareMode) {
                        renderResultsFinal();
                        buildSummaryCard();
                    }
                    // Update card nav to show "View assessment →"
                    if (flipCardsBuilt) updateCardNavigation();

                    // Now that everything is done, show "Show the full report" button
                    if (opusReasoningDone) {
                        thinkingLabel.innerHTML = '<span class="phase-icon">&#10003;</span> Opus 4.6: Reasoning complete';
                        $('reportToggle').classList.remove('hidden');
                    }

                    // Show follow-up input for non-compare mode
                    if (!isCompareMode) followupSection.classList.remove('hidden');

                    if (eventSource) { eventSource.close(); eventSource = null; }
                    break;

                case 'error':
                    statusText.textContent = 'Error';
                    statusPill.classList.add('done');
                    if (elapsedInterval) { clearInterval(elapsedInterval); elapsedInterval = null; }
                    stopStatusRotation();
                    removeCursor();

                    resultsArea.classList.remove('hidden');
                    var errMsg = msg.content || 'Unknown error';
                    var advice = '';
                    if (errMsg.indexOf('API key') >= 0) advice = 'Check your .env file has a valid ANTHROPIC_API_KEY.';
                    else if (errMsg.indexOf('rate') >= 0 || errMsg.indexOf('429') >= 0) advice = 'Rate limit reached. Wait a minute and try again.';
                    else if (errMsg.indexOf('timeout') >= 0 || errMsg.indexOf('overloaded') >= 0) advice = 'The API is busy. Try again in a few minutes.';
                    else advice = 'Try again or use a different analysis depth.';
                    resultsContent.innerHTML = '<div class="error-msg">' + escapeHtml(errMsg) +
                        '<br><span style="font-size:0.82rem;color:var(--text-secondary);font-weight:400">' + advice + '</span>' +
                        '<br><button class="retry-btn" onclick="location.reload()">Try Again</button></div>';

                    if (eventSource) { eventSource.close(); eventSource = null; }
                    break;
            }
        };

        eventSource.onerror = function() {
            if (eventSource) { eventSource.close(); eventSource = null; }
            if (!statusPill.classList.contains('done')) {
                statusText.textContent = 'Connection lost';
                statusPill.classList.add('done');
                removeCursor();
                stopStatusRotation();
                if (elapsedInterval) { clearInterval(elapsedInterval); elapsedInterval = null; }
                if (responseContent.length < 50) {
                    resultsArea.classList.remove('hidden');
                    resultsContent.innerHTML = '<div class="error-msg">Connection lost during analysis.' +
                        '<br><button class="retry-btn" onclick="location.reload()">Retry</button></div>';
                }
            }
        };
    }

    // ── Phase handling ────────────────────────────────────────
    function handlePhase(phase) {
        var labels = {
            thinking: "Reading as the drafter's attorney...",
            profile: 'Identifying document structure...',
            clauses: 'Analyzing clauses...',
            interactions: 'Cross-clause interactions...',
            playbook: "Revealing the drafter's playbook...",
            summary: 'Generating risk assessment...'
        };
        if (labels[phase]) {
            statusText.textContent = labels[phase];
        }
        // Extract metadata from profile phase
        if (phase === 'profile') {
            setTimeout(extractMetadata, 2000);
        }
        // Start relevant status rotation
        if (phase === 'clauses' || phase === 'profile') startStatusRotation('clauses');
        else if (phase === 'interactions' || phase === 'playbook' || phase === 'summary') startStatusRotation('deep');
    }

    // ── Metadata extraction from streamed text ────────────────
    function extractMetadata() {
        var patterns = [
            { re: /\*\*Document Type\*\*[:\s]*([^\n*]+)/i, label: 'Type' },
            { re: /\*\*Drafted By\*\*[:\s]*([^\n*]+)/i, label: 'Drafted By' },
            { re: /\*\*Your Role\*\*[:\s]*([^\n*]+)/i, label: 'Your Role' },
            { re: /\*\*Jurisdiction\*\*[:\s]*([^\n*]+)/i, label: 'Jurisdiction' },
        ];
        var parts = [];
        patterns.forEach(function(p) {
            var m = responseContent.match(p.re);
            if (m) {
                var val = m[1].trim();
                // Truncate long values for pill format
                if (val.length > 28) val = val.substring(0, 26) + '\u2026';
                parts.push(
                    '<span class="meta-pill" title="' + escapeHtml(m[1].trim()) + '">' +
                    '<span class="meta-pill-label">' + escapeHtml(p.label) + '</span> ' +
                    escapeHtml(val) +
                    '</span>'
                );
            }
        });
        if (parts.length > 0) {
            metadataLine.innerHTML = parts.join('');
            metadataLine.classList.remove('hidden');
            // Trigger fly-in animation after a frame
            requestAnimationFrame(function() {
                requestAnimationFrame(function() {
                    metadataLine.classList.add('visible');
                });
            });
        }
    }

    // ── Status rotation ───────────────────────────────────────
    function startStatusRotation(group) {
        stopStatusRotation();
        currentStatusIdx = 0;
        var messages = STATUS_MESSAGES[group];
        if (!messages || messages.length === 0) return;
        statusRotateInterval = setInterval(function() {
            currentStatusIdx = (currentStatusIdx + 1) % messages.length;
            statusText.textContent = messages[currentStatusIdx];
        }, 4000);
    }

    function stopStatusRotation() {
        if (statusRotateInterval) { clearInterval(statusRotateInterval); statusRotateInterval = null; }
    }

    // ── Thinking rendering ────────────────────────────────────
    function highlightThinking(text) {
        var escaped = escapeHtml(text);
        return escaped.replace(thinkingKeywords, '<span class="kw">$&</span>');
    }

    function renderThinking() {
        thinkingText.innerHTML = highlightThinking(thinkingContent) + '<span class="cursor"></span>';
        thinkingText.scrollTop = thinkingText.scrollHeight;
    }

    function removeCursor() {
        var cursor = thinkingText.querySelector('.cursor');
        if (cursor) cursor.remove();
    }

    // ── Results rendering ─────────────────────────────────────
    function renderResults() {
        if (renderTimeout) return;
        renderTimeout = setTimeout(function() {
            renderTimeout = null;
            doRenderResults();
        }, 300);
    }

    function renderResultsFinal() {
        if (renderTimeout) { clearTimeout(renderTimeout); renderTimeout = null; }
        doRenderResults();
    }

    function isNearBottom() {
        return (window.innerHeight + window.scrollY) >= (document.body.scrollHeight - 300);
    }

    // Track manual scroll
    window.addEventListener('scroll', function() {
        if (Math.abs(window.scrollY - lastAutoScrollY) > 100) {
            userHasScrolled = true;
        }
    }, { passive: true });

    function doRenderResults() {
        // ── Guard: once flip cards are built, DON'T render deep analysis during streaming ──
        // Deep analysis will be rendered on-demand when user clicks "Our Verdict" or "View assessment"
        if (flipCardsBuilt && !isCompareMode) {
            return;
        }

        // ── Compare mode: keep old markdown rendering path ──
        if (isCompareMode) {
            var safeMd = responseContent
                .replace(/\[READER\]\s*:/g, 'FLIPSIDE_READER:')
                .replace(/\[DRAFTER\]\s*:/g, 'FLIPSIDE_DRAFTER:')
                .replace(/^READER\s*:/gm, 'FLIPSIDE_READER:')
                .replace(/^DRAFTER\s*:/gm, 'FLIPSIDE_DRAFTER:');
            var html = marked.parse(safeMd);
            html = styleRiskBadges(html);
            html = styleWhyClauses(html);
            html = styleReaderBlocks(html);
            html = styleDrafterBlocks(html);
            html = styleSplitClauses(html);
            resultsContent.innerHTML = html;
            wrapClauseSections(resultsContent);
            resultsArea.classList.remove('hidden');
            return;
        }

        // ── Non-compare: incremental clause detection ──
        tryExtractNewClauses();
    }

    // ── Risk badge styling ────────────────────────────────────
    function styleRiskBadges(html) {
        // Match: LEVEL · Score: NN/100 · Trick: NAME (or Score: NN without /100)
        html = html.replace(
            /\[?(?:<strong>)?(GREEN|YELLOW|RED)(?:<\/strong>)?\]?\s*(?:·|&#xB7;|&middot;)\s*Score:\s*\d+(?:\/100)?\s*(?:·|&#xB7;|&middot;)\s*Trick:\s*([^<\n]+)/gi,
            function(_, level, trick) {
                return buildBadgeHtml(level.toLowerCase(), level.toUpperCase(), trick.trim());
            }
        );
        // Match: LEVEL · Trick: NAME (no score — cross-clause format)
        html = html.replace(
            /\[?(?:<strong>)?(GREEN|YELLOW|RED)(?:<\/strong>)?\]?\s*(?:·|&#xB7;|&middot;)\s*Trick:\s*([^<\n]+)/gi,
            function(_, level, trick) {
                return buildBadgeHtml(level.toLowerCase(), level.toUpperCase(), trick.trim());
            }
        );
        // Fallback: LEVEL · Score: NN/100 (no trick)
        html = html.replace(
            /\[?(?:<strong>)?(GREEN|YELLOW|RED)(?:<\/strong>)?\]?\s*(?:·|&#xB7;|&middot;)\s*Score:\s*\d+(?:\/100)?/gi,
            function(_, level) {
                return buildBadgeHtml(level.toLowerCase(), level.toUpperCase(), '');
            }
        );
        return html;
    }

    // styleRiskDistribution removed — risk distribution dots no longer shown

    function buildBadgeHtml(level, label, trick) {
        var h = '<span class="risk-badge risk-' + level + '">' + label + '</span>';
        if (trick) {
            var desc = TRICK_DESCRIPTIONS[trick] || '';
            h += '<span class="trick-label" title="' + escapeHtml(desc) + '">' + escapeHtml(trick) + '</span>';
        }
        return h;
    }

    // ── "Why this clause exists" — hidden from display ────────
    function styleWhyClauses(html) {
        return html.replace(
            /<p><strong>Why this clause exists:<\/strong>\s*([\s\S]*?)<\/p>/gi,
            ''
        );
    }

    // ── Split clause styling (juxtaposition) ──────────────────
    function styleSplitClauses(html) {
        // Card-level juxtapose (from Haiku quick scan)
        html = html.replace(
            /<p><strong>What the small print says:?<\/strong>:?\s*([\s\S]*?)<\/p>\s*<p><strong>What you should read:?<\/strong>:?\s*([\s\S]*?)<\/p>/gi,
            function(_, left, right) {
                return '<div class="clause-split-header">' +
                    '<div class="clause-split-label clause-split-label-left">What the small print says</div>' +
                    '<div class="clause-split-label clause-split-label-right">What you should read</div>' +
                    '</div>' +
                    '<div class="clause-split">' +
                    '<div class="clause-split-left">' + left.trim() + '</div>' +
                    '<div class="clause-split-right">' + right.trim() + '</div>' +
                    '</div>';
            }
        );
        // Cross-clause juxtapose (from Opus deep analysis — different labels)
        html = html.replace(
            /<p><strong>Read separately, you(?:&#x2019;|'|')d see:<\/strong>\s*([\s\S]*?)<\/p>\s*<p><strong>Read together, you(?:&#x2019;|'|')d realize:<\/strong>\s*([\s\S]*?)<\/p>/gi,
            function(_, left, right) {
                return '<div class="clause-split-header">' +
                    '<div class="clause-split-label clause-split-label-left">Read separately</div>' +
                    '<div class="clause-split-label clause-split-label-right">Read together</div>' +
                    '</div>' +
                    '<div class="clause-split">' +
                    '<div class="clause-split-left">' + left.trim() + '</div>' +
                    '<div class="clause-split-right">' + right.trim() + '</div>' +
                    '</div>';
            }
        );
        return html;
    }

    // ── [READER] block styling ────────────────────────────────
    function styleReaderBlocks(html) {
        // Match FLIPSIDE_READER: text (pre-processed from [READER]:)
        return html.replace(
            /<p>FLIPSIDE_READER:\s*([\s\S]*?)<\/p>/gi,
            function(_, text) {
                return '<div class="reader-voice" data-reader="true">' + text.trim() + '</div>';
            }
        );
    }

    // ── Drafter voice styling ───────────────────────────────
    function styleDrafterBlocks(html) {
        // Villain format: **If the drafter could speak as a villain:** text
        html = html.replace(
            /<p><strong>If the drafter could speak as a villain:<\/strong>\s*([\s\S]*?)<\/p>/gi,
            function(_, text) {
                return '<div class="drafter-voice"><span class="drafter-voice-label">If the drafter could speak as a villain</span>' + text.trim() + '</div>';
            }
        );
        // Fallback: old "speak freely" format
        html = html.replace(
            /<p><strong>If the drafter could speak freely:<\/strong>\s*([\s\S]*?)<\/p>/gi,
            function(_, text) {
                return '<div class="drafter-voice"><span class="drafter-voice-label">If the drafter could speak as a villain</span>' + text.trim() + '</div>';
            }
        );
        // Legacy format: FLIPSIDE_DRAFTER: text (pre-processed from [DRAFTER]:)
        html = html.replace(
            /<p>FLIPSIDE_DRAFTER:\s*([\s\S]*?)<\/p>/gi,
            function(_, text) {
                return '<div class="drafter-voice"><span class="drafter-voice-label">If the drafter could speak as a villain</span>' + text.trim() + '</div>';
            }
        );
        // Style "→ YOUR MOVE:" action lines
        html = html.replace(
            /<p>→ YOUR MOVE:\s*([\s\S]*?)<\/p>/gi,
            function(_, text) {
                return '<div class="your-move"><span class="your-move-label">→ Your move</span>' + text.trim() + '</div>';
            }
        );
        return html;
    }

    // ── Incremental clause detection via --- separators ─────
    function tryExtractNewClauses() {
        // Split on --- separator (flexible: handles \n---\n, \n\n---\n, \n\n---\n\n)
        var segments = responseContent.split(/\n+---\n+/);
        if (segments.length > 1 && parsedClauseCount === 0) {
            console.log('[FlipSide] First segment (should be doc profile):', segments[0].substring(0, 200));
            console.log('[FlipSide] Total segments so far:', segments.length);
            console.log('[FlipSide] Second segment preview:', segments[1] ? segments[1].substring(0, 200) : '(empty)');
        }

        // All segments except the last are complete (last may be mid-stream)
        for (var i = parsedClauseCount; i < segments.length - 1; i++) {
            var clause = extractSingleClause(segments[i]);
            if (!clause && segments[i].trim().length > 50) {
                console.log('[FlipSide] Failed to parse segment ' + i + ':', segments[i].substring(0, 300));
            }
            if (clause) {
                buildSingleFlipCard(clause, flipCardContainer.querySelectorAll('.flip-card').length);
                if (!cardViewTransitioned) {
                    transitionToCardView();
                } else {
                    updateCardNavigation();
                }
            }
        }
        parsedClauseCount = Math.max(parsedClauseCount, segments.length - 1);

        // Extract metadata if not yet populated
        if (metadataLine.classList.contains('hidden') && responseContent.length > 200) {
            extractMetadata();
        }
    }

    // ── Final sweep on quick_done — parse last segment too ──
    function finalClauseSweep() {
        var segments = responseContent.split(/\n+---\n+/);
        console.log('[FlipSide] finalClauseSweep: ' + segments.length + ' segments, parsedClauseCount=' + parsedClauseCount);
        console.log('[FlipSide] quickDoneContentLength:', responseContent.length, 'full content preview:', responseContent.substring(0, 500));
        for (var i = parsedClauseCount; i < segments.length; i++) {
            var clause = extractSingleClause(segments[i]);
            if (clause) {
                buildSingleFlipCard(clause, flipCardContainer.querySelectorAll('.flip-card').length);
                if (!cardViewTransitioned) {
                    transitionToCardView();
                }
            }
        }
        parsedClauseCount = segments.length;
        flipCardsBuilt = true;
        updateCardNavigation();
    }

    // ── Parse one clause from a raw markdown segment ─────────
    function extractSingleClause(segment) {
        if (!segment.match(/^### /m)) return null;

        var riskMatch = segment.match(/\[?(GREEN|YELLOW|RED)\]?\s*[·•\u00B7\u2022\-–—|,]\s*Score:\s*(\d+)(?:\/100)?(?:\s*[·•\u00B7\u2022\-–—|,]\s*Trick:\s*([^\n]+))?/i);
        if (!riskMatch) return null;

        var headerMatch = segment.match(/^### \s*(.+)\s+\(([^)]+)\)\s*$/m);
        var title, sectionRef;
        if (headerMatch) {
            title = headerMatch[1].trim();
            sectionRef = headerMatch[2].trim();
        } else {
            var simpleHeader = segment.match(/^### \s*(.+?)\s*$/m);
            if (!simpleHeader) return null;
            title = simpleHeader[1].trim();
            sectionRef = '';
        }

        var quoteLines = [];
        var lines = segment.split('\n');
        for (var j = 0; j < lines.length; j++) {
            if (lines[j].match(/^>\s*/)) {
                quoteLines.push(lines[j].replace(/^>\s*/, ''));
            } else if (quoteLines.length > 0) {
                break;
            }
        }
        var quote = quoteLines.join(' ').replace(/^["\u201C]|["\u201D]$/g, '').trim();

        var reassuranceMatch = segment.match(/\[REASSURANCE\]\s*:\s*(.+)/i);
        var reassurance = reassuranceMatch ? reassuranceMatch[1].trim().replace(/^["\u201C]|["\u201D]$/g, '') : '';

        var readerMatch = segment.match(/\[READER\]\s*:\s*([\s\S]*?)(?=\n\n|\n(?:GREEN|YELLOW|RED))/i);
        var reader = readerMatch ? readerMatch[1].trim() : '';

        var risk = riskMatch[1].toLowerCase();
        var score = parseInt(riskMatch[2]);
        var trick = riskMatch[3] ? riskMatch[3].trim() : '';

        var confidenceMatch = segment.match(/Confidence:\s*(HIGH|MEDIUM|LOW)\s*[\u2014\-\u2013\u2015]\s*(.+)/i);
        var confidence = confidenceMatch ? confidenceMatch[1].toLowerCase() : '';
        var confidenceReason = confidenceMatch ? confidenceMatch[2].trim() : '';

        var bottomLineMatch = segment.match(/\*{1,2}Bottom line:?\*{0,2}:?\s*([\s\S]*?)(?=\n\n|\*{1,2}What the small print says)/i);
        var bottomLine = bottomLineMatch ? bottomLineMatch[1].trim() : '';

        var smallPrintMatch = segment.match(/\*{1,2}What the small print says:?\*{0,2}:?\s*([\s\S]*?)(?=\*{1,2}What you should read|\n\n###|\n\n##|$)/i);
        var shouldReadMatch = segment.match(/\*{1,2}What you should read:?\*{0,2}:?\s*([\s\S]*?)(?=\*{1,2}What does this mean|\n\n###|\n\n##|$)/i);
        var smallPrint = smallPrintMatch ? smallPrintMatch[1].trim() : '';
        var shouldRead = shouldReadMatch ? shouldReadMatch[1].trim() : '';
        // Fallback: if smallPrint is empty, use the quote (the actual contract text)
        if (!smallPrint && quote) smallPrint = quote;

        // "What does this mean for you" — structured: [FIGURE] + [EXAMPLE]
        var figureMatch = segment.match(/\[FIGURE\]\s*:\s*(.+)/i);
        var figure = figureMatch ? figureMatch[1].trim() : '';
        var exampleNarrativeMatch = segment.match(/\[EXAMPLE\]\s*:\s*([\s\S]*?)(?=\n\n###|\n\n##|\n\n---|\*{1,2}\[EN\]|$)/i);
        var exampleNarrative = exampleNarrativeMatch ? exampleNarrativeMatch[1].trim() : '';
        // Fallback: if no [FIGURE]/[EXAMPLE] tags, try old free-text format
        if (!figure && !exampleNarrative) {
            var exampleMatch = segment.match(/\*{1,2}What does this mean for you:?\*{0,2}:?\s*([\s\S]*?)(?=\n\n###|\n\n##|\n\n---|\*{1,2}\[EN\]|$)/i);
            if (exampleMatch) exampleNarrative = exampleMatch[1].trim();
        }

        // English translations (for non-English documents)
        var enSmallPrintMatch = segment.match(/\*{1,2}\[EN\]\s*What the small print says:?\*{0,2}:?\s*([\s\S]*?)(?=\*{1,2}\[EN\]\s*What you should read|\n\n###|\n\n##|$)/i);
        var enShouldReadMatch = segment.match(/\*{1,2}\[EN\]\s*What you should read:?\*{0,2}:?\s*([\s\S]*?)(?=\*{1,2}\[EN\]\s*What does this mean|\n\n###|\n\n##|\n\n---|\[EN-READER\]|\[EN-FIGURE\]|$)/i);
        var enFigureMatch = segment.match(/\[EN-FIGURE\]\s*:\s*(.+)/i);
        var enExampleNarrativeMatch = segment.match(/\[EN-EXAMPLE\]\s*:\s*([\s\S]*?)(?=\n\n###|\n\n##|\n\n---|\[EN-READER\]|$)/i);
        var enReaderMatch = segment.match(/\[EN-READER\]\s*:\s*([\s\S]*?)(?=\n\n|\n(?:GREEN|YELLOW|RED)|\n---|\n###|$)/i);
        var enSmallPrint = enSmallPrintMatch ? enSmallPrintMatch[1].trim() : '';
        var enShouldRead = enShouldReadMatch ? enShouldReadMatch[1].trim() : '';
        var enFigure = enFigureMatch ? enFigureMatch[1].trim() : '';
        var enExampleNarrative = enExampleNarrativeMatch ? enExampleNarrativeMatch[1].trim() : '';
        var enReader = enReaderMatch ? enReaderMatch[1].trim() : '';

        return {
            title: title, section: sectionRef, reassurance: reassurance,
            quote: quote, reader: reader,
            risk: risk, score: score, trick: trick,
            confidence: confidence, confidenceReason: confidenceReason,
            bottomLine: bottomLine, smallPrint: smallPrint, shouldRead: shouldRead,
            figure: figure, exampleNarrative: exampleNarrative,
            enSmallPrint: enSmallPrint, enShouldRead: enShouldRead,
            enFigure: enFigure, enExampleNarrative: enExampleNarrative, enReader: enReader
        };
    }

    // ── Build and append one flip card ───────────────────────
    function buildSingleFlipCard(clause, index) {
        var risk = clause.risk;
        var trickDesc = TRICK_DESCRIPTIONS[clause.trick] || '';
        var borderColor = risk === 'red' ? 'var(--red)' : risk === 'yellow' ? 'var(--yellow)' : 'var(--green-border)';

        // ── Front: reassurance headline, section, title, quote, reader voice ──
        var frontHtml = '<div class="flip-card-front">' +
            '<div class="front-content">' +
            (clause.reassurance ? '<div class="clause-reassurance">' + escapeHtml(clause.reassurance) + '</div>' : '') +
            (clause.section ? '<div class="clause-section-ref">' + escapeHtml(clause.section) + '</div>' : '') +
            '<h3 class="clause-title">' + escapeHtml(clause.title) + '</h3>' +
            (clause.quote ? '<div class="clause-quote">' + escapeHtml(clause.quote) + '</div>' : '') +
            (documentFullText && !isCompareMode ? '<a class="find-in-doc" data-card-index="' + index + '">Find in document &uarr;</a>' : '') +
            '<div class="reader-voice">' +
            '<span class="reader-voice-label">You\u2019d think</span>' +
            '<div class="reader-voice-text">' + escapeHtml(clause.reader) + '</div>' +
            (clause.enReader ? '<div class="reader-voice-en">' + escapeHtml(clause.enReader) + '</div>' : '') +
            '</div>' +
            '</div>' +
            '<button class="flip-trigger"><span>Now flip it</span><span class="flip-trigger-arrow">&rarr;</span></button>' +
            '</div>';

        // ── Back body: verdict for green, juxtaposition + verdict link for others ──
        var backBodyHtml = '';
        if (risk === 'green') {
            backBodyHtml = '<div class="green-verdict">' +
                '<div class="green-verdict-title">No hidden intent</div>' +
                '<div class="green-verdict-text">This clause is genuinely balanced and fair to both parties.</div>' +
                '</div>';
        }

        // "What the small print says" stays on the card
        if (clause.smallPrint) {
            backBodyHtml += '<div class="smallprint-block"><span class="juxtapose-label">What the small print says</span>' +
                escapeHtml(clause.smallPrint) + '</div>';
        }
        // EN small print (collapsible)
        if (clause.enSmallPrint) {
            backBodyHtml += '<details class="en-translation"><summary class="en-translation-toggle">Show in English</summary>' +
                '<div class="smallprint-block" style="margin-top:0.5rem">' +
                '<span class="juxtapose-label">What the small print says</span>' + escapeHtml(clause.enSmallPrint) +
                '</div></details>';
        }

        // Bottom line — the reveal after flipping
        if (clause.bottomLine) {
            backBodyHtml += '<div class="bottom-line bottom-line-' + risk + '">' +
                escapeHtml(clause.bottomLine) + '</div>';
        }

        // Verdict link removed — full verdict shown after all cards via navigation

        // ── Confidence badge ──
        var confidenceBadgeHtml = '';
        if (clause.confidence) {
            confidenceBadgeHtml = '<span class="confidence-badge confidence-' + clause.confidence + '" title="' + escapeHtml(clause.confidenceReason) + '">' +
                clause.confidence.toUpperCase() +
                (clause.confidenceReason ? '<span class="confidence-reason">' + escapeHtml(clause.confidenceReason) + '</span>' : '') +
                '</span>';
        }

        // ── Back wrapper ──
        var backHtml = '<div class="flip-card-back"><div class="back-content">' +
            '<div class="risk-header risk-header-' + risk + '">' +
            '<h3 class="clause-title">' + escapeHtml(clause.title) + '</h3>' +
            '<div class="risk-badge-group">' +
            '<span class="risk-badge risk-badge-' + risk + '">' + risk.toUpperCase() + '</span>' +
            (clause.trick ? '<span class="trick-label" title="' + escapeHtml(trickDesc) + '">' + escapeHtml(clause.trick) + '</span>' : '') +
            confidenceBadgeHtml +
            '</div></div>' +
            '<div class="back-body">' + backBodyHtml + '</div>' +
            '<button class="flip-back-trigger"><span class="flip-back-arrow">&larr;</span><span>Flip back</span></button>' +
            '</div></div>';

        var cardEl = document.createElement('div');
        cardEl.className = 'flip-card hidden';
        cardEl.setAttribute('data-clause-index', index);
        cardEl.setAttribute('data-risk-level', risk);
        cardEl.setAttribute('data-clause-title', escapeHtml(clause.title));
        cardEl.setAttribute('data-section-ref', clause.section || '');
        if (clause.shouldRead) cardEl.setAttribute('data-should-read', clause.shouldRead);
        if (clause.figure) cardEl.setAttribute('data-figure', clause.figure);
        if (clause.exampleNarrative) cardEl.setAttribute('data-example', clause.exampleNarrative);
        if (clause.enShouldRead) cardEl.setAttribute('data-en-should-read', clause.enShouldRead);
        if (clause.enFigure) cardEl.setAttribute('data-en-figure', clause.enFigure);
        if (clause.enExampleNarrative) cardEl.setAttribute('data-en-example', clause.enExampleNarrative);
        cardEl.innerHTML = '<div class="flip-card-inner">' + frontHtml + backHtml + '</div>';
        flipCardContainer.appendChild(cardEl);

        // Highlight this clause's quote in the document preview
        highlightClauseInPreview(clause, index);
    }

    // ── Document preview: highlight clause quotes ─────────────
    // Stores all clause highlight data; rebuilds from clean source each time
    var clauseHighlightData = [];

    function highlightClauseInPreview(clause, cardIndex) {
        if (!clause.quote || clause.quote.length < 10) return;
        clauseHighlightData.push({ quote: clause.quote, cardIndex: cardIndex, risk: clause.risk || 'green' });
        rebuildPreviewHighlights();
    }

    function rebuildPreviewHighlights() {
        var previewEl = $('editorialLoadingText');
        if (!previewEl || !documentFullText) return;

        // Always start from the clean escaped source
        var text = escapeHtml(documentFullText);

        // Find all match positions
        var matches = [];
        for (var i = 0; i < clauseHighlightData.length; i++) {
            var d = clauseHighlightData[i];
            var searchText = escapeHtml(d.quote.substring(0, 60).trim());
            var idx = text.indexOf(searchText);
            if (idx === -1) idx = text.toLowerCase().indexOf(searchText.toLowerCase());
            if (idx === -1) continue;

            var endSearch = d.quote.length > 80 ? escapeHtml(d.quote.substring(d.quote.length - 30)) : '';
            var endIdx = endSearch ? text.indexOf(endSearch, idx) : -1;
            var end = endIdx > idx ? endIdx + endSearch.length : idx + searchText.length;
            matches.push({ start: idx, end: end, cardIndex: d.cardIndex, risk: d.risk });
        }

        // Sort by position, remove overlaps
        matches.sort(function(a, b) { return a.start - b.start; });
        var filtered = [];
        var lastEnd = -1;
        for (var i = 0; i < matches.length; i++) {
            if (matches[i].start >= lastEnd) {
                filtered.push(matches[i]);
                lastEnd = matches[i].end;
            }
        }

        // Build HTML in one pass
        var html = '';
        var pos = 0;
        for (var i = 0; i < filtered.length; i++) {
            var m = filtered[i];
            html += text.substring(pos, m.start);
            var num = m.cardIndex + 1;
            html += '<span class="doc-highlight doc-highlight-' + m.risk + '" data-card-index="' + m.cardIndex + '">' +
                '<span class="doc-clause-marker doc-clause-marker-' + m.risk + '">' + num + '</span>' +
                text.substring(m.start, m.end) + '</span>';
            pos = m.end;
        }
        html += text.substring(pos);
        previewEl.innerHTML = html;
    }

    function scrollPreviewToCard(cardIndex) {
        var previewEl = $('editorialLoadingText');
        if (!previewEl) return;

        // Remove active from all highlights
        var highlights = previewEl.querySelectorAll('.doc-highlight');
        for (var i = 0; i < highlights.length; i++) {
            highlights[i].classList.remove('active');
        }

        // Activate the matching highlight
        var target = previewEl.querySelector('.doc-highlight[data-card-index="' + cardIndex + '"]');
        if (target) {
            target.classList.add('active');
            // Scroll into view within the scrollable preview
            var containerTop = previewEl.scrollTop;
            var containerHeight = previewEl.clientHeight;
            var elTop = target.offsetTop - previewEl.offsetTop;
            if (elTop < containerTop || elTop > containerTop + containerHeight - 40) {
                previewEl.scrollTop = elTop - 40;
            }
        }
    }

    // ── Transition from editorial loading to card view ────────
    function transitionToCardView() {
        cardViewTransitioned = true;
        stopEditorialStatusRotation();
        // Sidebar stays visible — just update status text
        var statusEl = $('editorialLoadingStatus');
        if (statusEl) statusEl.textContent = 'Analysis in progress...';
        var viewport = $('cardViewport');
        viewport.classList.remove('hidden');
        resultsArea.classList.remove('hidden');
        // Show insight column (card inside starts hidden, shown on flip)
        if (!isCompareMode) $('insightColumn').classList.remove('hidden');
        showCardAtIndex(0);
    }

    // ── Reveal full verdict (on demand only) ──────
    function revealDeepAnalysis() {
        // Check if deep analysis text has fully streamed
        var deepDataReady = deepTextComplete || isDoneRendering;
        if (!deepDataReady) {
            // Show waiting state in the section
            var section = $('deepAnalysisSection');
            section.classList.remove('hidden');
            deepAnalysisEl.innerHTML = '<div style="text-align:center;padding:3rem 1rem;color:var(--text-muted)">' +
                '<div style="font-size:1.1rem;margin-bottom:0.5rem">Opus 4.6 is still reasoning</div>' +
                '<div style="font-size:0.85rem">The full verdict will appear here when ready...</div>' +
                '<div class="pulsing-dots" style="margin-top:1rem"><span></span><span></span><span></span></div></div>';
            // Collapse cards
            $('cardViewport').classList.add('hidden');
            // Show thinking panel so user can see Opus working
            thinkingPanel.classList.remove('hidden');
            thinkingPanel.classList.remove('collapsed');
            thinkingToggle.textContent = 'Hide reasoning';
            // Poll for completion
            var pollInterval = setInterval(function() {
                var ready = deepTextComplete || isDoneRendering;
                if (ready) {
                    clearInterval(pollInterval);
                    revealDeepAnalysis(); // Call again now that data is ready
                }
            }, 500);
            setTimeout(function() { clearInterval(pollInterval); }, 180000);
            // Scroll to section
            setTimeout(function() {
                section.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 50);
            return;
        }

        // Render content now (was deferred during streaming)
        renderDeepAnalysisContent();
        buildSummaryCard();

        // Collapse card viewport
        $('cardViewport').classList.add('hidden');
        // Collapse thinking panel
        thinkingPanel.classList.add('collapsed');
        thinkingToggle.textContent = 'Show reasoning';

        var section = $('deepAnalysisSection');
        section.classList.remove('hidden');
        // Scroll to it
        setTimeout(function() {
            section.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 50);
    }

    // ── Show one card, hide rest, update nav ─────────────────
    // ── Insight column: "What you should read" + "What does this mean for you" ──
    // Highlight dollar amounts, percentages, and day counts in text
    function highlightNumbers(text) {
        return escapeHtml(text).replace(
            /(\$[\d,]+(?:\.\d{2})?|\d+%|\d+\s*(?:days?|months?|years?|hours?))/gi,
            '<span class="insight-num">$1</span>'
        );
    }

    function showInsightForCard(cardEl) {
        var col = $('insightColumn');
        var card = $('insightCard');
        var inner = $('insightCardInner');
        if (!col || !card || !inner) return;

        var shouldRead = cardEl.getAttribute('data-should-read');
        if (!shouldRead) { hideInsightColumn(); return; }

        var risk = cardEl.getAttribute('data-risk-level') || 'green';
        var enShouldRead = cardEl.getAttribute('data-en-should-read');
        var figure = cardEl.getAttribute('data-figure');
        var example = cardEl.getAttribute('data-example');
        var enFigure = cardEl.getAttribute('data-en-figure');
        var enExample = cardEl.getAttribute('data-en-example');

        // "What you should read" section
        var html = '<div class="insight-should-read">' + highlightNumbers(shouldRead) + '</div>';
        if (enShouldRead) {
            html += '<div class="insight-en">' + highlightNumbers(enShouldRead) + '</div>';
        }

        // "What does this mean for you" — headline figure + narrative
        if (figure || example) {
            html += '<div class="insight-example">' +
                '<span class="insight-example-label">What does this mean for you</span>';
            if (figure) {
                html += '<div class="insight-figure insight-figure-' + risk + '">' + highlightNumbers(figure) + '</div>';
            }
            if (example) {
                html += '<div class="insight-narrative">' + highlightNumbers(example) + '</div>';
            }
            html += '</div>';
            // EN translations for example section
            if (enFigure || enExample) {
                html += '<div class="insight-en">';
                if (enFigure) html += '<div class="insight-figure-en">' + highlightNumbers(enFigure) + '</div>';
                if (enExample) html += '<div>' + highlightNumbers(enExample) + '</div>';
                html += '</div>';
            }
        }
        inner.innerHTML = html;

        // Set risk color
        card.className = 'insight-card insight-card-' + risk;
        col.classList.remove('hidden');

        // Trigger drop-in animation
        requestAnimationFrame(function() {
            card.classList.add('visible');
        });
    }

    function hideInsightColumn() {
        var card = $('insightCard');
        if (card) {
            card.classList.remove('visible');
        }
    }

    function showCardAtIndex(index) {
        var cards = flipCardContainer.querySelectorAll('.flip-card');
        if (index < 0 || index >= cards.length) return;

        currentCardIndex = index;
        for (var i = 0; i < cards.length; i++) {
            if (i === index) {
                cards[i].classList.remove('hidden');
                cards[i].classList.remove('flipped'); // un-flip on navigate
                if (!cards[i].classList.contains('woosh-done')) {
                    cards[i].classList.add('woosh-in', 'woosh-done');
                }
            } else {
                cards[i].classList.add('hidden');
            }
        }

        // Hide insight column when navigating (card is un-flipped)
        hideInsightColumn();

        // Animate score bar on visible card
        var visibleCard = cards[index];
        var scoreBarFill = visibleCard.querySelector('.back-score-bar-fill');
        if (scoreBarFill && !scoreBarFill.style.width) {
            var targetWidth = scoreBarFill.getAttribute('data-width');
            setTimeout(function() { scoreBarFill.style.width = targetWidth + '%'; }, 100);
        }

        // Scroll document preview to matching clause
        scrollPreviewToCard(index);

        updateCardNavigation();
    }

    // ── Update card navigation state ─────────────────────────
    function updateCardNavigation() {
        var cards = flipCardContainer.querySelectorAll('.flip-card');
        var total = cards.length;
        var nav = $('cardNavigation');
        if (!nav) return;

        if (total === 0) { nav.classList.add('hidden'); return; }

        nav.classList.remove('hidden');
        var counter = nav.querySelector('.card-nav-counter');
        var prevBtn = nav.querySelector('.card-nav-prev');
        var nextBtn = nav.querySelector('.card-nav-next');
        var nextLabel = nextBtn.querySelector('.card-nav-next-label');

        counter.innerHTML = 'Clause <strong>' + (currentCardIndex + 1) + '</strong> of <strong>' + total + '</strong>';
        prevBtn.disabled = currentCardIndex === 0;

        if (currentCardIndex >= total - 1 && !quickDone) {
            nextLabel.innerHTML = 'Analyzing next<span class="pulsing-dot"></span>';
            nextBtn.disabled = true;
            nextBtn.removeAttribute('data-action');
        } else if (currentCardIndex >= total - 1 && flipCardsBuilt) {
            // Check if deep analysis text has fully streamed
            var opusDone = deepTextComplete || isDoneRendering;
            if (opusDone) {
                nextLabel.textContent = 'Full Verdict \u2192';
            } else {
                nextLabel.innerHTML = 'Full Verdict <span class="pulsing-dot" style="margin-left:0.3rem"></span>';
            }
            nextBtn.disabled = false;
            nextBtn.setAttribute('data-action', 'assessment');
        } else {
            nextLabel.textContent = 'Next clause \u2192';
            nextBtn.disabled = false;
            nextBtn.removeAttribute('data-action');
        }
    }

    // ── Phase 3: Render deep analysis into separate container ──
    function renderDeepAnalysisContent() {
        var deepText = responseContent.substring(quickDoneContentLength);
        if (!deepText.trim()) return;

        // Add Opus header once
        if (!deepAnalysisEl.previousElementSibling || !deepAnalysisEl.previousElementSibling.classList.contains('deep-analysis-header')) {
            var header = document.createElement('div');
            header.className = 'deep-analysis-header';
            header.innerHTML = '<span class="section-label">Full Verdict</span>' +
                '<span class="opus-badge">Opus 4.6 Reasoning</span>';
            deepAnalysisEl.parentNode.insertBefore(header, deepAnalysisEl);
        }

        var safeMd = deepText
            .replace(/\[READER\]\s*:/g, 'FLIPSIDE_READER:')
            .replace(/\[DRAFTER\]\s*:/g, 'FLIPSIDE_DRAFTER:')
            .replace(/^READER\s*:/gm, 'FLIPSIDE_READER:')
            .replace(/^DRAFTER\s*:/gm, 'FLIPSIDE_DRAFTER:');
        var html = marked.parse(safeMd);
        html = styleRiskBadges(html);
        html = styleWhyClauses(html);
        html = styleReaderBlocks(html);
        html = styleDrafterBlocks(html);
        html = styleSplitClauses(html);
        deepAnalysisEl.innerHTML = html;

        // Wrap English Summary in collapsible details (bilingual reports)
        var enSummaryH2 = null;
        deepAnalysisEl.querySelectorAll('h2').forEach(function(h2) {
            if (h2.textContent.trim().toLowerCase().indexOf('english summary') >= 0) enSummaryH2 = h2;
        });
        if (enSummaryH2) {
            var details = document.createElement('details');
            details.className = 'en-report-summary';
            var summary = document.createElement('summary');
            summary.className = 'en-report-toggle';
            summary.textContent = 'Show full report in English';
            details.appendChild(summary);
            var wrapper = document.createElement('div');
            wrapper.className = 'en-report-content';
            // Collect all siblings from enSummaryH2 onward
            var sibling = enSummaryH2.nextElementSibling;
            while (sibling) {
                var next = sibling.nextElementSibling;
                wrapper.appendChild(sibling);
                sibling = next;
            }
            enSummaryH2.replaceWith(details);
            details.appendChild(wrapper);
        }

        wrapClauseSections(deepAnalysisEl);

        // Animate new deep analysis cards
        deepAnalysisEl.querySelectorAll('.cross-clause-card, .playbook-card, .assessment-card').forEach(function(card) {
            var title = card.getAttribute('data-clause-title');
            if (title && !animatedCardTitles.has(title)) {
                animatedCardTitles.add(title);
                card.classList.add('new-card');
                setTimeout(function() { card.classList.remove('new-card'); }, 500);
            }
        });

        // Try to update drafter voice on flip cards from deep analysis [DRAFTER] blocks
        updateDrafterVoices(deepText);
    }

    // ── Update drafter voice text on flip cards from deep analysis ──
    function updateDrafterVoices(deepText) {
        var drafterParts = deepText.split(/(?=^### )/m);
        for (var i = 0; i < drafterParts.length; i++) {
            var part = drafterParts[i];
            var headerMatch = part.match(/^### \s*(.+?)\s*(?:\(|$)/m);
            if (!headerMatch) continue;

            var drafterMatch = part.match(/\[DRAFTER\]\s*:\s*([\s\S]*?)(?=\n\n|\n###|$)/i);
            if (!drafterMatch) continue;

            var clauseTitle = headerMatch[1].trim();
            var drafterText = drafterMatch[1].trim();
            if (!drafterText) continue;

            // Find matching flip card and update its drafter-voice-text
            var cards = flipCardContainer.querySelectorAll('.flip-card');
            for (var j = 0; j < cards.length; j++) {
                var cardTitle = cards[j].getAttribute('data-clause-title');
                if (cardTitle && (cardTitle === clauseTitle || cardTitle === escapeHtml(clauseTitle))) {
                    var voiceEl = cards[j].querySelector('.drafter-voice-text');
                    if (voiceEl && voiceEl.textContent.indexOf('Deep analysis in progress') >= 0) {
                        voiceEl.textContent = drafterText;
                    }
                    break;
                }
            }
        }
    }

    // ── Editorial status rotation ──────────────────────────
    var editorialStatusMessages = [
        'FlipSide is reading between the lines...',
        'Adopting the drafter\u2019s perspective...',
        'Looking for what\u2019s hidden in plain sight...',
        'Every clause exists for a reason...',
        'The boring parts are the dangerous parts...'
    ];

    function startEditorialStatusRotation() {
        stopEditorialStatusRotation();
        editorialStatusIdx = 0;
        editorialStatusInterval = setInterval(function() {
            editorialStatusIdx = (editorialStatusIdx + 1) % editorialStatusMessages.length;
            var el = $('editorialLoadingStatus');
            if (el) el.textContent = editorialStatusMessages[editorialStatusIdx];
        }, 4000);
    }

    function stopEditorialStatusRotation() {
        if (editorialStatusInterval) { clearInterval(editorialStatusInterval); editorialStatusInterval = null; }
    }

    // ── Clause card wrapping ──────────────────────────────────
    function wrapClauseSections(container) {
        container = container || resultsContent;

        // Add editorial dividers before H2 section headings (Cross-Clause, Playbook, Assessment)
        container.querySelectorAll('h2').forEach(function(h2) {
            if (h2.previousElementSibling && !h2.previousElementSibling.classList.contains('editorial-divider')) {
                var divider = document.createElement('hr');
                divider.className = 'editorial-divider';
                h2.parentNode.insertBefore(divider, h2);
            }
            // Style H2 as section-label
            h2.classList.add('section-label');
            h2.style.fontSize = '0.75rem';
            h2.style.marginBottom = '1rem';
            h2.style.marginTop = '0.5rem';
        });

        var headings = container.querySelectorAll('h3');

        headings.forEach(function(h3) {
            if (h3.parentElement.classList.contains('clause-card') ||
                h3.parentElement.classList.contains('cross-clause-card') ||
                h3.parentElement.classList.contains('playbook-card') ||
                h3.parentElement.classList.contains('assessment-card')) return;

            var sectionType = getSectionType(h3);
            var cardClass = sectionType === 'cross' ? 'cross-clause-card' :
                            sectionType === 'playbook' ? 'playbook-card' :
                            sectionType === 'assessment' ? 'assessment-card' : 'clause-card';
            var card = document.createElement('div');
            card.className = cardClass;

            var siblings = [h3];
            var next = h3.nextElementSibling;
            while (next && next.tagName !== 'H3' && next.tagName !== 'H2' && next.tagName !== 'HR') {
                siblings.push(next);
                next = next.nextElementSibling;
            }

            // Detect risk level for clause cards
            if (sectionType === 'clause' || sectionType === 'cross') {
                var text = siblings.map(function(el) { return el.innerHTML || el.textContent; }).join(' ');
                var level = '';
                if (text.match(/risk-red|RED/)) level = 'red';
                else if (text.match(/risk-yellow|YELLOW/)) level = 'yellow';
                else if (text.match(/risk-green|GREEN/)) level = 'green';
                if (level) card.classList.add('level-' + level);
                card.setAttribute('data-risk-level', level);
            }

            card.setAttribute('data-clause-title', h3.textContent.trim());
            h3.parentNode.insertBefore(card, h3);
            siblings.forEach(function(el) { card.appendChild(el); });

            // Move split section to lead the card
            if (sectionType === 'clause') {
                var splitHeader = card.querySelector('.clause-split-header');
                var splitBody = card.querySelector('.clause-split');
                if (splitHeader && splitBody) {
                    var afterH3 = card.querySelector('h3').nextSibling;
                    card.insertBefore(splitHeader, afterH3);
                    card.insertBefore(splitBody, splitHeader.nextSibling);
                }
            }
        });
    }

    function getSectionType(el) {
        var prev = el.previousElementSibling;
        while (prev) {
            if (prev.tagName === 'H2') {
                var text = prev.textContent.toLowerCase();
                if (text.indexOf('cross-clause') >= 0) return 'cross';
                if (text.indexOf('playbook') >= 0 || text.indexOf('who drafted') >= 0) return 'playbook';
                if (text.indexOf('fair standard') >= 0 || text.indexOf('benchmark') >= 0) return 'cross';
                if (text.indexOf('how opus') >= 0 || text.indexOf('analyzed this') >= 0) return 'playbook';
                if (text.indexOf('quality check') >= 0 || text.indexOf('calibration') >= 0) return 'assessment';
                if (text.indexOf('assessment') >= 0) return 'assessment';
                return 'clause';
            }
            prev = prev.previousElementSibling;
        }
        return 'clause';
    }

    // ── Clause data extraction ────────────────────────────────
    function extractClausesFromResponse() {
        var clauses = [];
        var clauseRe = /###\s+(.+?)\s*\(([^)]+)\)[\s\S]*?\[?(GREEN|YELLOW|RED)\]?\s*(?:·|·)\s*Score:\s*(\d+)(?:\/100)?(?:\s*(?:·|·)\s*Trick:\s*(.+?))?$/gm;
        var match;
        while ((match = clauseRe.exec(responseContent)) !== null) {
            clauses.push({
                title: match[1].trim(),
                section: match[2].trim(),
                level: match[3].toLowerCase(),
                score: parseInt(match[4]),
                trick: match[5] ? match[5].trim() : ''
            });
        }
        return clauses;
    }

    // ── Filter chips ──────────────────────────────────────────
    function buildFilterChips() {
        var clauses = extractClausesFromResponse();
        if (clauses.length === 0) return;

        var counts = { red: 0, yellow: 0, green: 0 };
        clauses.forEach(function(c) { if (counts[c.level] !== undefined) counts[c.level]++; });

        var html = '';
        if (counts.red > 0)    html += '<button class="filter-chip chip-red" data-filter="red">' + counts.red + ' Red</button>';
        if (counts.yellow > 0) html += '<button class="filter-chip chip-yellow" data-filter="yellow">' + counts.yellow + ' Yellow</button>';
        if (counts.green > 0)  html += '<button class="filter-chip chip-green" data-filter="green">' + counts.green + ' Green</button>';

        if (html) {
            filterChips.innerHTML = html;
            filterChips.classList.remove('hidden');

            filterChips.querySelectorAll('.filter-chip').forEach(function(chip) {
                chip.addEventListener('click', function() {
                    var level = chip.getAttribute('data-filter');
                    if (activeFilters.has(level)) {
                        activeFilters.delete(level);
                        chip.classList.remove('active');
                    } else {
                        activeFilters.add(level);
                        chip.classList.add('active');
                    }
                    applyFilters();
                });
            });
        }
    }

    function applyFilters() {
        var container = flipCardsBuilt && !isCompareMode ? flipCardContainer : resultsContent;
        var selector = '.clause-card, .flip-card';
        if (activeFilters.size === 0) {
            container.querySelectorAll(selector).forEach(function(card) {
                card.style.display = '';
            });
            // If using card viewport, re-show current card
            if (flipCardsBuilt && !isCompareMode) showCardAtIndex(0);
            return;
        }
        container.querySelectorAll(selector).forEach(function(card) {
            var level = card.getAttribute('data-risk-level');
            if (level && activeFilters.has(level)) {
                card.style.display = '';
            } else if (level) {
                card.style.display = 'none';
            }
        });
    }

    // ── Summary card builder ──────────────────────────────────
    function buildSummaryCard() {
        var text = responseContent;
        var scoreMatch = text.match(/Overall Risk Score[:\s]*(\d+)\/100/i);
        if (!scoreMatch) return;
        var score = parseInt(scoreMatch[1]);

        var piiMatch = text.match(/Power Imbalance Index[:\s]*(\d+)\/100/i);
        var piiScore = piiMatch ? parseInt(piiMatch[1]) : null;

        // Liberal parsing: accepts "0 Green · 2 Yellow · 8 Red" or "[0] Green · [2] Yellow · [8] Red"
        var distMatch = text.match(/\[?(\d+)\]?\s*Green\s*[·•\u00B7\u2022\-–—|,]\s*\[?(\d+)\]?\s*Yellow\s*[·•\u00B7\u2022\-–—|,]\s*\[?(\d+)\]?\s*Red/i);
        var greenCount = 0, yellowCount = 0, redCount = 0;
        if (distMatch) {
            greenCount = parseInt(distMatch[1]);
            yellowCount = parseInt(distMatch[2]);
            redCount = parseInt(distMatch[3]);
        }

        var concerns = [];
        var assessmentStart = text.indexOf('Overall Assessment');
        var assessmentText = assessmentStart >= 0 ? text.substring(assessmentStart) : text;
        var concernLines = assessmentText.match(/\d+\.\s*\*\*.+?\*\*\s*(?:—|[-–]).+/g);
        if (concernLines) {
            concernLines.slice(0, 3).forEach(function(line) {
                var m = line.match(/\d+\.\s*\*\*(.+?)\*\*\s*(?:—|[-–])\s*(.+)/);
                if (m) concerns.push({ title: m[1], desc: m[2].trim() });
            });
        }

        var scoreColor = score > 65 ? 'var(--red)' : score > 35 ? 'var(--yellow)' : 'var(--green)';
        // Extract context-aware severity label from model output (after the score)
        // Format: "Overall Risk Score: 74/100 — Serious risk — seek professional legal review"
        var severityMatch = text.match(/Overall Risk Score[:\s]*\d+\/100[^—\-\n]*(?:—|[-–])\s*([^\n]+)/i);
        var scoreLabel = severityMatch ? severityMatch[1].trim().replace(/\*+/g, '') : (
            score > 80 ? 'seek legal review' : score > 65 ? 'high risk' : score > 40 ? 'moderate risk' : 'low risk'
        );
        // Truncate to fit inside the circle
        if (scoreLabel.length > 20) scoreLabel = scoreLabel.substring(0, 18) + '\u2026';
        var piiColor = piiScore > 65 ? 'var(--red)' : piiScore > 35 ? 'var(--yellow)' : 'var(--green)';
        var circumference = 2 * Math.PI * 42;
        var offset = circumference * (1 - score / 100);

        var h = '<div class="summary-card"><div class="summary-top">';
        h += '<div class="score-ring-container"><svg class="score-ring" viewBox="0 0 100 100">';
        h += '<circle class="ring-bg" cx="50" cy="50" r="42"/>';
        h += '<circle class="ring-fill" cx="50" cy="50" r="42" stroke="' + scoreColor + '" stroke-dasharray="' + circumference.toFixed(1) + '" stroke-dashoffset="' + offset.toFixed(1) + '"/>';
        h += '<text class="score-value" x="50" y="47" text-anchor="middle" dy="0.35em">' + score + '</text>';
        h += '<text class="score-label" x="50" y="64" text-anchor="middle">' + scoreLabel + '</text>';
        h += '</svg></div>';

        h += '<div class="summary-meta"><div class="summary-title">Document Risk Assessment</div>';
        h += '<div class="score-bars">';
        h += '<div class="score-bar-row"><span class="score-bar-label" title="How much this document can hurt you">Risk</span>';
        h += '<div class="score-bar-track"><div class="score-bar-fill" style="width:' + score + '%;background:' + scoreColor + '"></div></div>';
        h += '<span class="score-bar-value">' + score + '</span></div>';
        if (piiScore !== null) {
            h += '<div class="score-bar-row"><span class="score-bar-label" title="How little you can do about it">Power</span>';
            h += '<div class="score-bar-track"><div class="score-bar-fill" style="width:' + piiScore + '%;background:' + piiColor + '"></div></div>';
            h += '<span class="score-bar-value">' + piiScore + '</span></div>';
        }
        h += '</div>';
        h += '<div style="display:flex;gap:1rem;font-size:0.7rem;color:var(--text-muted);margin-top:0.25rem">';
        h += '<span>Risk = how much it can hurt you</span>';
        if (piiScore !== null) h += '<span>Power = how little you can do about it</span>';
        h += '</div>';

        // Risk distribution dots removed

        if (concerns.length) {
            h += '<ul class="summary-concerns">';
            concerns.forEach(function(c) {
                h += '<li><strong>' + escapeHtml(c.title) + '</strong> — ' + escapeHtml(c.desc) + '</li>';
            });
            h += '</ul>';
        }
        h += '</div></div></div>';

        summaryContainer.innerHTML = h;
    }

    // ── Thinking toggle (show/hide raw reasoning) ──────────────
    $('thinkingToggle').addEventListener('click', function(e) {
        e.stopPropagation();
        var isCollapsed = thinkingPanel.classList.contains('collapsed');
        if (isCollapsed) {
            thinkingPanel.classList.remove('collapsed');
            thinkingToggle.textContent = 'Hide reasoning';
        } else {
            thinkingPanel.classList.add('collapsed');
            thinkingToggle.textContent = 'Show reasoning';
        }
    });

    // ── Report button (show full verdict) ────────────────────
    $('reportToggle').addEventListener('click', function(e) {
        e.stopPropagation();
        revealDeepAnalysis();
    });

    // ── Back to cards button (from verdict view) ──────────────
    $('backToCardsBtn').addEventListener('click', function() {
        $('deepAnalysisSection').classList.add('hidden');
        $('cardViewport').classList.remove('hidden');
        thinkingPanel.classList.add('hidden');
        // Scroll to card viewport
        setTimeout(function() {
            $('cardViewport').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 50);
    });

    // ── Back button ───────────────────────────────────────────
    backBtn.addEventListener('click', function() {
        if (eventSource) { eventSource.close(); eventSource = null; }
        if (elapsedInterval) { clearInterval(elapsedInterval); elapsedInterval = null; }
        stopStatusRotation();
        stopEditorialStatusRotation();

        analysisScreen.classList.add('hidden');
        uploadScreen.classList.remove('hidden');

        // Reset upload UI
        analyzeBtn.disabled = false;
        analyzeBtn.textContent = isCompareMode ? 'Compare documents' : 'Show me the other side';
    });

    // ── Header brand = back ───────────────────────────────────
    $('headerBrand').addEventListener('click', function() { backBtn.click(); });

    // ── Copy all ──────────────────────────────────────────────
    $('copyAllBtn').addEventListener('click', function() {
        var text = flipCardsBuilt && !isCompareMode
            ? (flipCardContainer.innerText + '\n\n' + deepAnalysisEl.innerText)
            : resultsContent.innerText;
        navigator.clipboard.writeText(text).then(function() {
            var btn = $('copyAllBtn');
            btn.textContent = 'Copied!';
            setTimeout(function() { btn.textContent = 'Copy all'; }, 2000);
        });
    });

    // ── Export HTML ───────────────────────────────────────────
    $('exportBtn').addEventListener('click', function() {
        var docName = 'FlipSide Analysis';
        var meta = metadataLine.textContent;
        if (meta) docName = meta.split('Type:')[1] ? meta.split('Type:')[1].split('Drafted')[0].trim() : docName;

        var exportHtml = '<!DOCTYPE html><html><head><meta charset="UTF-8">' +
            '<title>' + escapeHtml(docName) + ' — FlipSide Analysis</title>' +
            '<style>body{font-family:system-ui,sans-serif;max-width:800px;margin:2rem auto;padding:0 1rem;color:#1a1a18;line-height:1.6}' +
            'h1{font-size:1.5rem;border-bottom:2px solid #c44b28;padding-bottom:0.5rem}' +
            'h2{margin-top:2rem;color:#3d3b36}h3{margin-top:1.5rem}' +
            'blockquote{border-left:3px solid #c44b28;padding:0.5rem 1rem;margin:0.5rem 0;background:#faf8f4;font-style:italic}' +
            '.risk-badge{display:inline-block;padding:2px 8px;border-radius:3px;font-size:0.75rem;font-weight:700}' +
            '.risk-green{background:#e8f5e9;color:#1e6b38}.risk-yellow{background:#fff8e1;color:#8a6508}.risk-red{background:#fce4ec;color:#a83d20}' +
            'hr{border:none;border-top:1px solid #e2ddd4;margin:1.5rem 0}' +
            '.footer{margin-top:3rem;padding-top:1rem;border-top:1px solid #e2ddd4;font-size:0.8rem;color:#9c9789}' +
            '</style></head><body>' +
            '<h1>' + escapeHtml(docName) + '</h1>' +
            (summaryContainer.innerHTML || '') +
            (flipCardsBuilt && !isCompareMode ? (flipCardContainer.innerHTML + deepAnalysisEl.innerHTML) : resultsContent.innerHTML) +
            '<div class="footer">Generated by FlipSide — The dark side of small print.<br>Powered by Claude Opus 4.6 extended thinking.</div>' +
            '</body></html>';
        var blob = new Blob([exportHtml], { type: 'text/html' });
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url;
        a.download = docName.replace(/[^a-z0-9]/gi, '_') + '_FlipSide.html';
        a.click();
        URL.revokeObjectURL(url);
    });

    // ── Dark mode ─────────────────────────────────────────────
    $('darkModeBtn').addEventListener('click', function() {
        document.body.classList.toggle('dark-mode');
        var isDark = document.body.classList.contains('dark-mode');
        this.innerHTML = isDark ? '&#9788;' : '&#9790;';
        this.title = isDark ? 'Switch to light mode' : 'Switch to dark mode';
        try { localStorage.setItem('flipside-dark', isDark ? '1' : '0'); } catch(e) {}
    });

    // Restore dark mode preference
    try {
        var savedDark = localStorage.getItem('flipside-dark');
        if (savedDark === '1') {
            document.body.classList.add('dark-mode');
            $('darkModeBtn').innerHTML = '&#9788;';
        } else if (savedDark === null && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            // Auto-detect system preference on first visit
            document.body.classList.add('dark-mode');
            $('darkModeBtn').innerHTML = '&#9788;';
        }
    } catch(e) {}

    // ── Follow-up questions ──────────────────────────────────
    function sendFollowup() {
        var question = followupInput.value.trim();
        if (!question || !currentDocId) return;

        // Immediate visual feedback
        followupInput.value = '';
        followupInput.style.height = 'auto';
        followupSend.disabled = true;
        followupSend.textContent = 'Thinking...';
        followupInput.disabled = true;
        followupInput.placeholder = 'Opus 4.6 is thinking...';

        var answerDiv = document.createElement('div');
        answerDiv.className = 'followup-answer';
        answerDiv.innerHTML = '<div class="followup-q">' + escapeHtml(question) + '</div>' +
            '<div class="followup-a" style="color:var(--text-muted)">' +
            '<span class="pulsing-dots" style="display:inline-flex;vertical-align:middle;margin-right:0.4rem"><span></span><span></span><span></span></span>' +
            'Opus 4.6 is reasoning about your question...</div>';
        followupAnswers.appendChild(answerDiv);
        var answerContent = answerDiv.querySelector('.followup-a');

        setTimeout(function() { answerDiv.scrollIntoView({ behavior: 'smooth', block: 'start' }); }, 50);

        var responseText = '';
        fetch(BASE_URL + '/ask/' + currentDocId, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ question: question }),
        }).then(function(response) {
            if (!response.ok) return response.json().then(function(err) { throw new Error(err.error || 'Request failed'); });
            var reader = response.body.getReader();
            var decoder = new TextDecoder();
            var buffer = '';
            var thinkingDone = false;

            function processChunk(result) {
                if (result.done) { resetFollowupUI(); return; }
                buffer += decoder.decode(result.value, { stream: true });
                var lines = buffer.split('\n');
                buffer = lines.pop();
                for (var i = 0; i < lines.length; i++) {
                    var line = lines[i].trim();
                    if (!line.startsWith('data: ')) continue;
                    var msg;
                    try { msg = JSON.parse(line.substring(6)); } catch(e) { continue; }
                    if (msg.type === 'text') {
                        if (!thinkingDone) { thinkingDone = true; answerContent.innerHTML = ''; }
                        responseText += msg.content;
                        answerContent.innerHTML = marked.parse(responseText);
                    } else if (msg.type === 'done') {
                        if (responseText) answerContent.innerHTML = marked.parse(responseText);
                        resetFollowupUI();
                        return;
                    } else if (msg.type === 'error') {
                        answerContent.innerHTML = '<span style="color:var(--red)">' + escapeHtml(msg.content) + '</span>';
                        resetFollowupUI();
                        return;
                    }
                }
                return reader.read().then(processChunk);
            }
            return reader.read().then(processChunk);
        }).catch(function(err) {
            answerContent.innerHTML = '<span style="color:var(--red)">' + escapeHtml(err.message) + '</span>';
            resetFollowupUI();
        });
    }

    function resetFollowupUI() {
        followupSend.disabled = false;
        followupSend.textContent = 'Ask';
        followupInput.disabled = false;
        followupInput.placeholder = 'Ask another question...';
        followupInput.focus();
    }

    followupSend.addEventListener('click', sendFollowup);
    followupInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendFollowup(); }
    });
    followupInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    });

})();
</script>
</body>
</html>
